<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArchiMate 3.2 Editor</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.5;
        }
        h1 {
            margin-top: 0;
            color: #333;
        }
        h2 {
            color: #444;
            border-bottom: 2px solid #ddd;
            padding-bottom: 8px;
            margin-top: 30px;
        }
        h3 {
            color: #555;
            margin-top: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .panels {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 400px;
        }
        .full-width {
            flex-basis: 100%;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            outline: 2px solid #0066cc;
            outline-offset: 1px;
            border-color: #0066cc;
        }
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        button:focus {
            outline: 2px solid #0066cc;
            outline-offset: 2px;
        }
        .btn-primary {
            background: #0066cc;
            color: white;
        }
        .btn-primary:hover {
            background: #0052a3;
        }
        .btn-secondary {
            background: #666;
            color: white;
        }
        .btn-secondary:hover {
            background: #555;
        }
        .btn-danger {
            background: #cc3333;
            color: white;
        }
        .btn-danger:hover {
            background: #aa2222;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #218838;
        }
        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        /* ADR Styles */
        .adr-status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .adr-status-draft { background: #e0e0e0; color: #555; }
        .adr-status-proposed { background: #2196F3; color: white; }
        .adr-status-discussion { background: #03A9F4; color: white; }
        .adr-status-returned { background: #FF5722; color: white; }
        .adr-status-accepted { background: #4CAF50; color: white; }
        .adr-status-rejected { background: #f44336; color: white; }
        .adr-status-updated { background: #00BCD4; color: white; }
        .adr-status-implemented { background: #9C27B0; color: white; }
        .adr-status-monitored { background: #3F51B5; color: white; }
        .adr-status-deprecated { background: #FF9800; color: white; }
        .adr-status-superseded { background: #607D8B; color: white; }
        .adr-status-closed { background: #795548; color: white; }
        
        /* Task status badges */
        .task-status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .task-status-new { background: #9E9E9E; color: white; }
        .task-status-in_progress { background: #2196F3; color: white; }
        .task-status-blocked { background: #f44336; color: white; }
        .task-status-review { background: #FFC107; color: #333; }
        .task-status-done { background: #4CAF50; color: white; }
        .task-status-cancelled { background: #607D8B; color: white; }
        
        /* Task priority badges */
        .task-priority-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: bold;
        }
        .task-priority-low { background: #8BC34A; color: white; }
        .task-priority-medium { background: #FFC107; color: #333; }
        .task-priority-high { background: #FF9800; color: white; }
        .task-priority-critical { background: #f44336; color: white; }
        
        .adr-list-container {
            min-height: 60px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            margin-bottom: 5px;
            background: #fafafa;
        }
        .adr-list-item {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            margin: 2px 0;
            background: white;
            border-radius: 3px;
            border: 1px solid #eee;
        }
        .adr-list-item input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 2px;
        }
        .adr-list-item button {
            padding: 2px 6px;
            font-size: 12px;
            margin-left: 5px;
        }
        .adr-alternative-card {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            background: #fafafa;
        }
        .adr-alternative-card .form-group {
            margin-bottom: 8px;
        }
        .adr-link-row {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }
        .adr-link-row input {
            flex: 1;
        }
        .adr-history-item {
            display: flex;
            gap: 15px;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .adr-history-item:last-child {
            border-bottom: none;
        }
        
        /* Markdown content styles */
        .markdown-content h1 { font-size: 1.8em; margin: 1em 0 0.5em 0; border-bottom: 2px solid #eee; padding-bottom: 0.3em; }
        .markdown-content h2 { font-size: 1.5em; margin: 1em 0 0.5em 0; border-bottom: 1px solid #eee; padding-bottom: 0.2em; }
        .markdown-content h3 { font-size: 1.3em; margin: 1em 0 0.5em 0; }
        .markdown-content h4 { font-size: 1.1em; margin: 1em 0 0.5em 0; }
        .markdown-content p { margin: 0.5em 0; }
        .markdown-content ul, .markdown-content ol { margin: 0.5em 0; padding-left: 2em; }
        .markdown-content li { margin: 0.3em 0; }
        .markdown-content code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
        .markdown-content pre { background: #f4f4f4; padding: 12px; border-radius: 4px; overflow-x: auto; margin: 0.5em 0; }
        .markdown-content pre code { background: none; padding: 0; }
        .markdown-content blockquote { border-left: 4px solid #ddd; margin: 0.5em 0; padding-left: 1em; color: #666; }
        .markdown-content a { color: #0066cc; }
        .markdown-content table { border-collapse: collapse; margin: 0.5em 0; }
        .markdown-content th, .markdown-content td { border: 1px solid #ddd; padding: 8px; }
        .markdown-content th { background: #f5f5f5; }
        .markdown-content hr { border: none; border-top: 1px solid #ddd; margin: 1em 0; }
        .markdown-content img { max-width: 100%; }
        
        /* Note version list */
        .note-version-item {
            padding: 10px;
            margin-bottom: 8px;
            background: #fafafa;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .note-version-item:hover {
            background: #f0f0f0;
        }
        .note-version-item.active {
            background: #e3f2fd;
            border-color: #2196F3;
        }
        .note-version-item.current {
            border-left: 3px solid #4CAF50;
        }
        .note-version-date {
            font-weight: bold;
            font-size: 13px;
        }
        .note-version-time {
            font-size: 12px;
            color: #666;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }
        th {
            background: #f0f0f0;
            font-weight: 600;
        }
        tr:nth-child(even) {
            background: #f9f9f9;
        }
        tr:hover {
            background: #e8f4fc;
        }
        .layer-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }
        .layer-strategy { background: #F5DEAA; color: #333; }
        .layer-business { background: #FFFFB5; color: #333; }
        .layer-application { background: #B5FFFF; color: #333; }
        .layer-technology { background: #C9E7B7; color: #333; }
        .layer-physical { background: #C9E7B7; color: #333; }
        .layer-implementation { background: #FFE0E0; color: #333; }
        .layer-motivation { background: #CCCCFF; color: #333; }
        .layer-composite { background: #FFDAB5; color: #333; }
        .fieldset {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .fieldset legend {
            font-weight: 600;
            padding: 0 10px;
            color: #444;
        }
        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .actions button {
            margin: 0;
        }
        .element-type-info {
            background: #f0f8ff;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid #0066cc;
        }
        .relationship-info {
            background: #fff8e8;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid #DAA520;
        }
        .code-preview {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
            flex-wrap: wrap;
        }
        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            font-size: 15px;
            border-radius: 4px 4px 0 0;
            margin-bottom: -2px;
            border: 2px solid transparent;
            border-bottom: none;
        }
        .tab-btn:hover {
            background: #e0e0e0;
        }
        .tab-btn.active {
            background: white;
            border: 2px solid #ddd;
            border-bottom: 2px solid white;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .no-data {
            color: #666;
            font-style: italic;
            padding: 20px;
            text-align: center;
        }
        .model-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .model-info h2 {
            color: white;
            border-bottom-color: rgba(255,255,255,0.3);
            margin-top: 0;
        }
        .model-info .model-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .model-info .model-version {
            opacity: 0.9;
            font-size: 14px;
        }
        .model-stats {
            display: flex;
            gap: 30px;
            margin-top: 15px;
        }
        .model-stat {
            text-align: center;
        }
        .model-stat-value {
            font-size: 28px;
            font-weight: bold;
        }
        .model-stat-label {
            font-size: 12px;
            opacity: 0.9;
        }
        .property-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .property-row input {
            margin-bottom: 0;
        }
        .property-row .prop-key {
            flex: 1;
        }
        .property-row .prop-value {
            flex: 2;
        }
        .property-row button {
            margin: 0;
            padding: 8px 12px;
        }
        .metadata-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .metadata-grid label {
            margin-bottom: 3px;
        }
        .metadata-grid input,
        .metadata-grid textarea {
            margin-bottom: 0;
        }
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        .import-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        .import-area:hover {
            border-color: #0066cc;
            background: #f0f8ff;
        }
        .import-area.dragover {
            border-color: #28a745;
            background: #e8f5e9;
        }
        .filter-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .filter-row .filter-item {
            flex: 1;
        }
        .filter-row .filter-item label {
            margin-bottom: 3px;
        }
        .filter-row .filter-item select {
            margin-bottom: 0;
        }
        .filter-count {
            color: #666;
            font-size: 13px;
            margin-bottom: 10px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-grid .form-group label {
            margin-bottom: 3px;
        }
        .form-grid .form-group input,
        .form-grid .form-group select {
            margin-bottom: 0;
        }
        .cascade-select {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr;
            gap: 10px;
            align-items: end;
        }
        .cascade-select label {
            margin-bottom: 3px;
        }
        .cascade-select select {
            margin-bottom: 0;
        }
        .statement-preview {
            background: #e8f5e9;
            padding: 12px 15px;
            border-radius: 4px;
            border-left: 4px solid #28a745;
            margin: 15px 0;
            font-size: 15px;
        }
        .statement-preview strong {
            color: #1b5e20;
        }
        .filter-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .active-filter-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 13px;
            display: none;
        }
        .active-filter-info.visible {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .active-filter-info button {
            margin: 0;
            padding: 4px 10px;
            font-size: 12px;
        }
        .sortable-header {
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        .sortable-header:hover {
            background: #e0e0e0;
        }
        .sortable-header::after {
            content: ' ‚áÖ';
            opacity: 0.3;
            font-size: 12px;
        }
        .sortable-header.sort-asc::after {
            content: ' ‚Üë';
            opacity: 1;
        }
        .sortable-header.sort-desc::after {
            content: ' ‚Üì';
            opacity: 1;
        }
        a.element-link {
            color: #0066cc;
            text-decoration: underline;
        }
        a.element-link:hover {
            color: #004499;
        }
        a.element-link:focus {
            outline: 2px solid #0066cc;
            outline-offset: 2px;
        }
        
        /* Diagram styles */
        .diagram-editor {
            display: none;
        }
        .diagram-editor.active {
            display: block;
        }
        .diagram-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ddd;
        }
        .diagram-header h2 {
            margin: 0;
            border: none;
            padding: 0;
        }
        .diagram-subtabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
            padding-bottom: 0;
        }
        .diagram-subtab {
            padding: 10px 20px;
            background: #e9e9e9;
            border: none;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            margin-bottom: -2px;
        }
        .diagram-subtab:hover {
            background: #ddd;
        }
        .diagram-subtab.active {
            background: white;
            border: 2px solid #ddd;
            border-bottom: 2px solid white;
        }
        .diagram-subtab-content {
            display: none;
        }
        .diagram-subtab-content.active {
            display: block;
        }
        .svg-container {
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            overflow: auto;
            max-height: 600px;
        }
        .svg-container svg {
            display: block;
        }
        .layout-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
        }
        .layout-controls label {
            margin: 0;
            display: inline;
        }
        .layout-controls select {
            width: auto;
            margin: 0;
        }
        /* Bulk operations panel */
        .bulk-panel {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 4px;
            padding: 12px 15px;
            margin-bottom: 10px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
        }
        .bulk-panel .bulk-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .bulk-panel .bulk-actions {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        .bulk-panel .bulk-fields {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
        }
        .bulk-panel select, .bulk-panel input, .bulk-panel textarea {
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
        }
        .bulk-panel .btn-link {
            background: none;
            border: none;
            color: #1976d2;
            cursor: pointer;
            text-decoration: underline;
            font-size: 13px;
        }
        .bulk-panel .btn-link:hover {
            color: #0d47a1;
        }
        /* Column visibility toggles */
        .column-toggles {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 0 0 4px 4px;
            border-top: 1px dashed #ddd;
            font-size: 13px;
        }
        .column-toggles summary {
            cursor: pointer;
            color: #666;
            font-size: 12px;
            user-select: none;
        }
        .column-toggles summary:hover {
            color: #333;
        }
        .column-toggles .toggle-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 8px;
        }
        .column-toggles label {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-weight: normal;
            cursor: pointer;
            white-space: nowrap;
        }
        .column-toggles input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }
        /* Column hiding via table class */
        table.hide-col-0 th:nth-child(1), table.hide-col-0 td:nth-child(1) { display: none; }
        table.hide-col-1 th:nth-child(2), table.hide-col-1 td:nth-child(2) { display: none; }
        table.hide-col-2 th:nth-child(3), table.hide-col-2 td:nth-child(3) { display: none; }
        table.hide-col-3 th:nth-child(4), table.hide-col-3 td:nth-child(4) { display: none; }
        table.hide-col-4 th:nth-child(5), table.hide-col-4 td:nth-child(5) { display: none; }
        table.hide-col-5 th:nth-child(6), table.hide-col-5 td:nth-child(6) { display: none; }
        table.hide-col-6 th:nth-child(7), table.hide-col-6 td:nth-child(7) { display: none; }
        table.hide-col-7 th:nth-child(8), table.hide-col-7 td:nth-child(8) { display: none; }
        
        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 18px;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            line-height: 1;
        }
        .modal-close:hover {
            color: #333;
        }
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/docx@9.0.0/build/index.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h1 data-i18n="appTitle">ArchiMate 3.2 Editor</h1>
            <select id="language-select" onchange="changeLanguage(this.value)" style="padding: 5px 10px; border-radius: 4px; border: 1px solid #ccc;">
                <option value="cs">üá®üáø ƒåe≈°tina</option>
                <option value="en">üá¨üáß English</option>
            </select>
        </div>
        
        <!-- Model Info Header -->
        <div class="model-info" id="model-header">
            <div class="model-title" id="display-model-name" data-i18n="newModel">Nov√Ω ArchiMate Model</div>
            <div class="model-version" id="display-model-version"><span data-i18n="version">Verze</span>: -</div>
            <div class="model-stats">
                <div class="model-stat">
                    <div class="model-stat-value" id="stat-elements">0</div>
                    <div class="model-stat-label" data-i18n="elementsCount">Prvk≈Ø</div>
                </div>
                <div class="model-stat">
                    <div class="model-stat-value" id="stat-relationships">0</div>
                    <div class="model-stat-label" data-i18n="relationshipsCount">Vazeb</div>
                </div>
                <div class="model-stat">
                    <div class="model-stat-value" id="stat-diagrams">0</div>
                    <div class="model-stat-label" data-i18n="diagramsCount">Diagram≈Ø</div>
                </div>
                <div class="model-stat">
                    <div class="model-stat-value" id="stat-layers">0</div>
                    <div class="model-stat-label" data-i18n="layersCount">Vrstev</div>
                </div>
            </div>
        </div>
        
        <nav class="tabs" role="tablist" aria-label="Hlavn√≠ navigace">
            <button class="tab-btn active" role="tab" aria-selected="true" aria-controls="tab-model" id="btn-model" onclick="switchTab('model')" data-i18n="tabModel">
                Model
            </button>
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-elements" id="btn-elements" onclick="switchTab('elements')" accesskey="e" data-i18n="tabElements">
                Prvky
            </button>
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-relationships" id="btn-relationships" onclick="switchTab('relationships')" accesskey="r" data-i18n="tabRelationships">
                Vazby
            </button>
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-diagrams" id="btn-diagrams" onclick="switchTab('diagrams')" accesskey="d" data-i18n="tabDiagrams">
                Diagramy
            </button>
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-tasks" id="btn-tasks" onclick="switchTab('tasks')" data-i18n="tasksTab">
                √ökoly
            </button>
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-notes" id="btn-notes" onclick="switchTab('notes')" accesskey="m" data-i18n="notesTab">
                Pozn√°mky
            </button>
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-adr" id="btn-adr" onclick="switchTab('adr')" data-i18n="adrTab">
                ADR
            </button>
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-tools" id="btn-tools" onclick="switchTab('tools')" accesskey="t" data-i18n="tabTools">
                N√°stroje
            </button>
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-export" id="btn-export" onclick="switchTab('export')" data-i18n="tabExport">
                Export / Import
            </button>
            <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-reference" id="btn-reference" onclick="switchTab('reference')" data-i18n="tabReference">
                Reference
            </button>
        </nav>

        <!-- TAB: Model -->
        <div id="tab-model" class="tab-content active" role="tabpanel" aria-labelledby="btn-model">
            <div class="panels">
                <div class="panel">
                    <h2 data-i18n="modelMetadata">Metadata modelu</h2>
                    
                    <fieldset class="fieldset">
                        <legend data-i18n="basicInfo">Z√°kladn√≠ informace</legend>
                        
                        <label for="model-id" data-i18n="modelId">ID modelu:</label>
                        <input type="text" id="model-id" placeholder="id-model-001" value="id-model-001">
                        
                        <label for="model-name" data-i18n="modelName">N√°zev modelu:</label>
                        <input type="text" id="model-name" data-i18n-placeholder="modelNamePlaceholder" placeholder="N√°zev va≈°eho ArchiMate modelu" oninput="updateModelHeader()">
                        
                        <label for="model-version" data-i18n="modelVersion">Verze:</label>
                        <input type="text" id="model-version" placeholder="1.0.0" oninput="updateModelHeader()">
                        
                        <label for="model-documentation" data-i18n="documentation">Dokumentace / Purpose:</label>
                        <textarea id="model-documentation" data-i18n-placeholder="documentationPlaceholder" placeholder="√öƒçel a popis modelu..." rows="4"></textarea>
                    </fieldset>
                    
                    <fieldset class="fieldset">
                        <legend>Dublin Core Metadata</legend>
                        <p style="color: #666; font-size: 13px; margin-top: 0;" data-i18n="dcDescription">
                            Standardn√≠ metadata pro popis a vyhled√°v√°n√≠ modelu.
                        </p>
                        
                        <div class="metadata-grid">
                            <div>
                                <label for="dc-creator" data-i18n="dcCreator">Autor (dc:creator):</label>
                                <input type="text" id="dc-creator" data-i18n-placeholder="authorPlaceholder" placeholder="Jm√©no autora">
                            </div>
                            <div>
                                <label for="dc-publisher" data-i18n="dcPublisher">Vydavatel (dc:publisher):</label>
                                <input type="text" id="dc-publisher" data-i18n-placeholder="organizationPlaceholder" placeholder="Organizace">
                            </div>
                            <div>
                                <label for="dc-date" data-i18n="dcDate">Datum (dc:date):</label>
                                <input type="text" id="dc-date" placeholder="YYYY-MM-DD">
                            </div>
                            <div>
                                <label for="dc-language" data-i18n="dcLanguage">Jazyk (dc:language):</label>
                                <input type="text" id="dc-language" placeholder="cs" value="cs">
                            </div>
                            <div>
                                <label for="dc-rights" data-i18n="dcRights">Pr√°va (dc:rights):</label>
                                <input type="text" id="dc-rights" data-i18n-placeholder="rightsPlaceholder" placeholder="¬© 2025 Va≈°e organizace">
                            </div>
                            <div>
                                <label for="dc-subject" data-i18n="dcSubject">P≈ôedmƒõt (dc:subject):</label>
                                <input type="text" id="dc-subject" data-i18n-placeholder="keywordsPlaceholder" placeholder="Kl√≠ƒçov√° slova">
                            </div>
                        </div>
                        
                        <label for="dc-description" style="margin-top: 15px;" data-i18n="dcDescriptionLabel">Popis (dc:description):</label>
                        <textarea id="dc-description" data-i18n-placeholder="dcDescriptionPlaceholder" placeholder="Podrobn√Ω popis modelu pro katalogizaci..." rows="3"></textarea>
                    </fieldset>
                </div>
                
                <div class="panel">
                    <h2 data-i18n="modelProperties">Vlastn√≠ vlastnosti modelu</h2>
                    
                    <fieldset class="fieldset">
                        <legend data-i18n="customProperties">Custom Properties</legend>
                        <p style="color: #666; font-size: 13px; margin-top: 0;" data-i18n="customPropertiesDesc">
                            P≈ôidejte vlastn√≠ kl√≠ƒç-hodnota vlastnosti modelu.
                        </p>
                        
                        <div id="model-properties-container">
                            <!-- Properties will be rendered here -->
                        </div>
                        
                        <div class="property-row">
                            <input type="text" class="prop-key" id="new-prop-key" data-i18n-placeholder="keyPlaceholder" placeholder="Kl√≠ƒç">
                            <input type="text" class="prop-value" id="new-prop-value" data-i18n-placeholder="valuePlaceholder" placeholder="Hodnota">
                            <button type="button" class="btn-primary" onclick="addModelProperty()" data-i18n="add">P≈ôidat</button>
                        </div>
                    </fieldset>
                    
                    <div class="actions" style="margin-top: 20px;">
                        <button type="button" class="btn-primary" onclick="saveModelMetadata()" data-i18n="saveMetadata">Ulo≈æit metadata</button>
                        <button type="button" class="btn-secondary" onclick="resetModelMetadata()" data-i18n="reset">Resetovat</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Prvky -->
        <div id="tab-elements" class="tab-content" role="tabpanel" aria-labelledby="btn-elements">
            <div class="panel full-width">
                <h2 data-i18n="elementsList">Seznam prvk≈Ø</h2>
                
                <div class="filter-row">
                    <div class="filter-item">
                        <label for="filter-layer" data-i18n="layer">Vrstva:</label>
                        <select id="filter-layer" onchange="updateTypeFilter(); filterElements()">
                            <option value="" data-i18n="allLayers">V≈°echny vrstvy</option>
                            <option value="strategy">Strategy Layer</option>
                            <option value="business">Business Layer</option>
                            <option value="application">Application Layer</option>
                            <option value="technology">Technology Layer</option>
                            <option value="physical">Physical Layer</option>
                            <option value="implementation">Implementation &amp; Migration</option>
                            <option value="motivation">Motivation Layer</option>
                            <option value="composite">Composite Elements</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="filter-type" data-i18n="elementType">Typ prvku:</label>
                        <select id="filter-type" onchange="filterElements()">
                            <option value="" data-i18n="allTypes">V≈°echny typy</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="filter-stereotype" data-i18n="stereotype">Stereotyp:</label>
                        <select id="filter-stereotype" onchange="filterElements()">
                            <option value="" data-i18n="allStereotypes">V≈°echny stereotypy</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="filter-p≈ô√≠znaky" data-i18n="tag">P≈ô√≠znak:</label>
                        <select id="filter-p≈ô√≠znaky" onchange="filterElements()">
                            <option value="" data-i18n="allTags">V≈°echny p≈ô√≠znaky</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="filter-diagram" data-i18n="diagram">Diagram:</label>
                        <select id="filter-diagram" onchange="filterElements()">
                            <option value="" data-i18n="allDiagrams">V≈°echny diagramy</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="filter-search" data-i18n="search">Hledat:</label>
                        <input type="text" id="filter-search" data-i18n-placeholder="searchPlaceholder" placeholder="ID, n√°zev, stereotyp, p≈ô√≠znaky..." oninput="filterElements()" style="margin-bottom:0;">
                    </div>
                    <div class="filter-item" style="flex:0; align-self:end;">
                        <button type="button" class="btn-secondary" onclick="clearElementFilters()" data-i18n-title="clearFilters" title="Zru≈°it v≈°echny filtry">‚úï</button>
                    </div>
                </div>
                
                <div id="element-filter-info" class="active-filter-info">
                    <span id="element-filter-text"></span>
                    <button type="button" class="btn-secondary" onclick="clearElementFilters()">Zru≈°it</button>
                </div>
                
                <div id="elements-table-container">
                    <!-- Bulk Operations Panel -->
                    <div id="elements-bulk-panel" class="bulk-panel" style="display: none;">
                        <div class="bulk-info">
                            <span data-i18n="selected">Vybr√°no:</span> <strong id="elements-selected-count">0</strong>
                            <button type="button" class="btn-link" onclick="clearElementSelection()" data-i18n="clearSelection">Zru≈°it v√Ωbƒõr</button>
                        </div>
                        <div class="bulk-actions">
                            <select id="elements-bulk-action" onchange="showElementsBulkFields()">
                                <option value="" data-i18n="selectAction">-- Vyberte akci --</option>
                                <option value="type" data-i18n="changeType">Zmƒõnit typ</option>
                                <option value="stereotype" data-i18n="changeStereotype">Zmƒõnit stereotyp</option>
                                <option value="determines" data-i18n="changeDetermines">Zmƒõnit urƒçuje</option>
                                <option value="description" data-i18n="changeDescription">Zmƒõnit popis</option>
                                <option value="addTags" data-i18n="addTags">P≈ôidat p≈ô√≠znaky</option>
                                <option value="delete" data-i18n="deleteSelected">Smazat vybran√©</option>
                            </select>
                            <div id="elements-bulk-fields" class="bulk-fields"></div>
                            <button type="button" class="btn-primary" onclick="executeElementsBulkAction()" data-i18n="execute">Prov√©st</button>
                        </div>
                    </div>
                    <table id="elements-table" aria-label="Seznam prvk≈Ø">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 30px;"><input type="checkbox" id="elements-select-all" onchange="toggleAllElements(this.checked)" title="Vybrat v≈°e"></th>
                                <th scope="col" class="sortable-header sort-asc" onclick="sortElements('id')" data-column="id" data-i18n="id">ID</th>
                                <th scope="col" class="sortable-header" onclick="sortElements('layer')" data-column="layer" data-i18n="layer">Vrstva</th>
                                <th scope="col" class="sortable-header" onclick="sortElements('type')" data-column="type" data-i18n="type">Typ</th>
                                <th scope="col" class="sortable-header" onclick="sortElements('name')" data-column="name" data-i18n="name">N√°zev</th>
                                <th scope="col" class="sortable-header" onclick="sortElements('urƒçuje')" data-column="urƒçuje" data-i18n="determines">Urƒçuje</th>
                                <th scope="col" class="sortable-header" onclick="sortElements('p≈ô√≠znaky')" data-column="p≈ô√≠znaky" data-i18n="tags">P≈ô√≠znaky</th>
                                <th scope="col" data-i18n="diagrams">Diagramy</th>
                                <th scope="col" data-i18n="actions">Akce</th>
                            </tr>
                        </thead>
                        <tbody id="elements-tbody">
                            <tr><td colspan="9" class="no-data" data-i18n="noElements">Zat√≠m nejsou ≈æ√°dn√© prvky</td></tr>
                        </tbody>
                    </table>
                    <details class="column-toggles">
                        <summary data-i18n="columns">Zobrazen√© sloupce</summary>
                        <div class="toggle-list">
                            <label><input type="checkbox" checked onchange="toggleColumn('elements-table', 1, this.checked)"> ID</label>
                            <label><input type="checkbox" checked onchange="toggleColumn('elements-table', 2, this.checked)"> Vrstva</label>
                            <label><input type="checkbox" checked onchange="toggleColumn('elements-table', 3, this.checked)"> Typ</label>
                            <label><input type="checkbox" checked onchange="toggleColumn('elements-table', 4, this.checked)"> N√°zev</label>
                            <label><input type="checkbox" checked onchange="toggleColumn('elements-table', 5, this.checked)"> Urƒçuje</label>
                            <label><input type="checkbox" checked onchange="toggleColumn('elements-table', 6, this.checked)"> P≈ô√≠znaky</label>
                            <label><input type="checkbox" checked onchange="toggleColumn('elements-table', 7, this.checked)"> Diagramy</label>
                            <label><input type="checkbox" checked onchange="toggleColumn('elements-table', 8, this.checked)"> Akce</label>
                        </div>
                    </details>
                </div>
            </div>
            
            <div class="panel full-width">
                <h2 id="element-form-title" data-i18n="newElement">Nov√Ω prvek</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="element-id" data-i18n="elementId">ID prvku:</label>
                        <input type="text" id="element-id" placeholder="nap≈ô. app-001">
                    </div>
                    
                    <div class="form-group">
                        <label for="element-layer" data-i18n="layer">Vrstva:</label>
                        <select id="element-layer" onchange="updateElementTypes()">
                            <option value="" data-i18n="selectLayer">-- Vyberte vrstvu --</option>
                            <option value="strategy">Strategy Layer</option>
                            <option value="business">Business Layer</option>
                            <option value="application">Application Layer</option>
                            <option value="technology">Technology Layer</option>
                            <option value="physical">Physical Layer</option>
                            <option value="implementation">Implementation &amp; Migration Layer</option>
                            <option value="motivation">Motivation Layer</option>
                            <option value="composite">Composite Elements</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="element-type" data-i18n="elementType">Typ prvku:</label>
                        <select id="element-type" onchange="showTypeDescription()">
                            <option value="" data-i18n="selectTypeFirst">-- Nejd≈ô√≠ve vyberte vrstvu --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="element-stereotype" data-i18n="stereotype">Stereotype:</label>
                        <input type="text" id="element-stereotype" list="stereotype-suggestions" placeholder="nap≈ô. Webov√° aplikace">
                        <datalist id="stereotype-suggestions"></datalist>
                    </div>
                    
                    <div class="form-group">
                        <label for="element-name" data-i18n="name">N√°zev:</label>
                        <input type="text" id="element-name" placeholder="N√°zev prvku">
                    </div>
                    
                    <div class="form-group">
                        <label for="element-urƒçuje" data-i18n="determines">Urƒçuje:</label>
                        <input type="text" id="element-urƒçuje" placeholder="nap≈ô. obchodn√≠ pravidlo">
                    </div>
                    
                    <div class="form-group">
                        <label for="element-p≈ô√≠znaky" data-i18n="tags">P≈ô√≠znaky:</label>
                        <input type="text" id="element-p≈ô√≠znaky" placeholder="nap≈ô. ‚úÖ schv√°leno, üöß rozpracov√°no" list="p≈ô√≠znaky-suggestions">
                        <datalist id="p≈ô√≠znaky-suggestions"></datalist>
                    </div>
                </div>
                
                <div id="type-description" class="element-type-info" style="display:none;"></div>
                
                <label for="element-description" data-i18n="description">Popis:</label>
                <textarea id="element-description" placeholder="Popis prvku (voliteln√©)"></textarea>
                
                <div class="actions">
                    <button type="button" class="btn-primary" onclick="saveElement()" data-i18n="save">Ulo≈æit prvek</button>
                    <button type="button" class="btn-secondary" onclick="clearElementForm()" data-i18n="clearForm">Zru≈°it</button>
                </div>
            </div>
        </div>

        <!-- TAB: Vazby -->
        <div id="tab-relationships" class="tab-content" role="tabpanel" aria-labelledby="btn-relationships">
            <div class="panel full-width">
                <h2 data-i18n="relationshipsList">Seznam vazeb</h2>
                
                <div class="filter-row">
                    <div class="filter-item">
                        <label for="filter-rel-type" data-i18n="relationshipType">Typ vazby:</label>
                        <select id="filter-rel-type" onchange="filterRelationships()">
                            <option value="" data-i18n="allTypes">V≈°echny typy</option>
                            <option value="Composition">Composition</option>
                            <option value="Aggregation">Aggregation</option>
                            <option value="Assignment">Assignment</option>
                            <option value="Realization">Realization</option>
                            <option value="Serving">Serving</option>
                            <option value="Access">Access</option>
                            <option value="Influence">Influence</option>
                            <option value="Triggering">Triggering</option>
                            <option value="Flow">Flow</option>
                            <option value="Specialization">Specialization</option>
                            <option value="Association">Association</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="filter-rel-name" data-i18n="relationshipName">N√°zev vazby:</label>
                        <select id="filter-rel-name" onchange="filterRelationships()">
                            <option value="" data-i18n="allNames">V≈°echny n√°zvy</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="filter-rel-source" data-i18n="source">Zdroj:</label>
                        <select id="filter-rel-source" onchange="filterRelationships()">
                            <option value="" data-i18n="allSources">V≈°echny zdroje</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="filter-rel-target" data-i18n="target">C√≠l:</label>
                        <select id="filter-rel-target" onchange="filterRelationships()">
                            <option value="" data-i18n="allTargets">V≈°echny c√≠le</option>
                        </select>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-item">
                        <label for="filter-rel-p≈ô√≠znaky" data-i18n="tag">P≈ô√≠znak:</label>
                        <select id="filter-rel-p≈ô√≠znaky" onchange="filterRelationships()">
                            <option value="" data-i18n="allTags">V≈°echny p≈ô√≠znaky</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="filter-rel-diagram" data-i18n="diagram">Diagram:</label>
                        <select id="filter-rel-diagram" onchange="filterRelationships()">
                            <option value="" data-i18n="allDiagrams">V≈°echny diagramy</option>
                        </select>
                    </div>
                    <div class="filter-item" style="flex:2;">
                        <label for="filter-rel-search" data-i18n="search">Hledat:</label>
                        <input type="text" id="filter-rel-search" data-i18n-placeholder="searchRelPlaceholder" placeholder="Zdroj, c√≠l, p≈ô√≠znaky, statement..." oninput="filterRelationships()" style="margin-bottom:0;">
                    </div>
                    <div class="filter-item" style="flex:0; align-self:end;">
                        <button type="button" class="btn-secondary" onclick="clearRelationshipFilters()" data-i18n-title="clearFilters" title="Zru≈°it v≈°echny filtry">‚úï</button>
                    </div>
                </div>
                
                <div id="rel-filter-info" class="active-filter-info">
                    <span id="rel-filter-text"></span>
                    <button type="button" class="btn-secondary" onclick="clearRelationshipFilters()" data-i18n="clear">Zru≈°it</button>
                </div>
                
                <div id="relationships-table-container">
                    <!-- Bulk Operations Panel -->
                    <div id="relationships-bulk-panel" class="bulk-panel" style="display: none;">
                        <div class="bulk-info">
                            <span data-i18n="selected">Vybr√°no:</span> <strong id="relationships-selected-count">0</strong>
                            <button type="button" class="btn-link" onclick="clearRelationshipSelection()" data-i18n="clearSelection">Zru≈°it v√Ωbƒõr</button>
                        </div>
                        <div class="bulk-actions">
                            <select id="relationships-bulk-action" onchange="showRelationshipsBulkFields()">
                                <option value="" data-i18n="selectAction">-- Vyberte akci --</option>
                                <option value="type" data-i18n="changeRelType">Zmƒõnit typ vazby</option>
                                <option value="source" data-i18n="changeSource">Zmƒõnit zdroj</option>
                                <option value="target" data-i18n="changeTarget">Zmƒõnit c√≠l</option>
                                <option value="name" data-i18n="changeName">Zmƒõnit n√°zev</option>
                                <option value="description" data-i18n="changeDescription">Zmƒõnit popis</option>
                                <option value="addTags" data-i18n="addTags">P≈ôidat p≈ô√≠znaky</option>
                                <option value="delete" data-i18n="deleteSelected">Smazat vybran√©</option>
                            </select>
                            <div id="relationships-bulk-fields" class="bulk-fields"></div>
                            <button type="button" class="btn-primary" onclick="executeRelationshipsBulkAction()" data-i18n="execute">Prov√©st</button>
                        </div>
                    </div>
                    <table id="relationships-table" aria-label="Seznam vazeb">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 30px;"><input type="checkbox" id="relationships-select-all" onchange="toggleAllRelationships(this.checked)" title="Vybrat v≈°e"></th>
                                <th scope="col" class="sortable-header sort-asc" onclick="sortRelationships('source')" data-column="source" data-i18n="source">Zdroj</th>
                                <th scope="col" class="sortable-header" onclick="sortRelationships('type')" data-column="type" data-i18n="relationshipType">Typ vazby</th>
                                <th scope="col" class="sortable-header" onclick="sortRelationships('name')" data-column="name" data-i18n="name">N√°zev</th>
                                <th scope="col" class="sortable-header" onclick="sortRelationships('target')" data-column="target" data-i18n="target">C√≠l</th>
                                <th scope="col" data-i18n="statement">Statement</th>
                                <th scope="col" class="sortable-header" onclick="sortRelationships('p≈ô√≠znaky')" data-column="p≈ô√≠znaky" data-i18n="tags">P≈ô√≠znaky</th>
                                <th scope="col" data-i18n="diagrams">Diagramy</th>
                                <th scope="col" data-i18n="actions">Akce</th>
                            </tr>
                        </thead>
                        <tbody id="relationships-tbody">
                            <tr><td colspan="9" class="no-data" data-i18n="noRelationships">Zat√≠m nejsou ≈æ√°dn√© vazby</td></tr>
                        </tbody>
                    </table>
                    <details class="column-toggles">
                        <summary data-i18n="columns">Zobrazen√© sloupce</summary>
                        <div class="toggle-list">
                            <label><input type="checkbox" checked onchange="toggleColumn('relationships-table', 1, this.checked)"> <span data-i18n="source">Zdroj</span></label>
                            <label><input type="checkbox" checked onchange="toggleColumn('relationships-table', 2, this.checked)"> <span data-i18n="relationshipType">Typ vazby</span></label>
                            <label><input type="checkbox" checked onchange="toggleColumn('relationships-table', 3, this.checked)"> <span data-i18n="name">N√°zev</span></label>
                            <label><input type="checkbox" checked onchange="toggleColumn('relationships-table', 4, this.checked)"> <span data-i18n="target">C√≠l</span></label>
                            <label><input type="checkbox" checked onchange="toggleColumn('relationships-table', 5, this.checked)"> <span data-i18n="statement">Statement</span></label>
                            <label><input type="checkbox" checked onchange="toggleColumn('relationships-table', 6, this.checked)"> <span data-i18n="tags">P≈ô√≠znaky</span></label>
                            <label><input type="checkbox" checked onchange="toggleColumn('relationships-table', 7, this.checked)"> <span data-i18n="diagrams">Diagramy</span></label>
                            <label><input type="checkbox" checked onchange="toggleColumn('relationships-table', 8, this.checked)"> <span data-i18n="actions">Akce</span></label>
                        </div>
                    </details>
                </div>
            </div>
            
            <div class="panel full-width">
                <h2 id="relationship-form-title" data-i18n="newRelationship">Nov√° vazba</h2>
                
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div>
                        <h3 style="margin-top:0;" data-i18n="sourceElement">Zdrojov√Ω prvek (Z)</h3>
                        <div class="cascade-select">
                            <div>
                                <label for="rel-source-layer" data-i18n="layer">Vrstva:</label>
                                <select id="rel-source-layer" onchange="updateSourceTypes()">
                                    <option value="">-- Vrstva --</option>
                                    <option value="strategy">Strategy</option>
                                    <option value="business">Business</option>
                                    <option value="application">Application</option>
                                    <option value="technology">Technology</option>
                                    <option value="physical">Physical</option>
                                    <option value="implementation">Implementation</option>
                                    <option value="motivation">Motivation</option>
                                    <option value="composite">Composite</option>
                                </select>
                            </div>
                            <div>
                                <label for="rel-source-type" data-i18n="type">Typ:</label>
                                <select id="rel-source-type" onchange="updateSourceElements()">
                                    <option value="">-- Typ --</option>
                                </select>
                            </div>
                            <div>
                                <label for="rel-source" data-i18n="element">Prvek:</label>
                                <input type="text" id="rel-source-filter" placeholder="Filtrovat..." oninput="filterSelectOptions('rel-source', this.value)" style="margin-bottom: 4px; padding: 4px 8px; font-size: 12px;">
                                <select id="rel-source" onchange="updateAllowedRelationships(); updateRelationshipId(); updateTargetElements()">
                                    <option value="">-- Prvek --</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="margin-top:0;" data-i18n="targetElement">C√≠lov√Ω prvek (DO)</h3>
                        <div class="cascade-select">
                            <div>
                                <label for="rel-target-layer" data-i18n="layer">Vrstva:</label>
                                <select id="rel-target-layer" onchange="updateTargetTypes()">
                                    <option value="">-- Vrstva --</option>
                                    <option value="strategy">Strategy</option>
                                    <option value="business">Business</option>
                                    <option value="application">Application</option>
                                    <option value="technology">Technology</option>
                                    <option value="physical">Physical</option>
                                    <option value="implementation">Implementation</option>
                                    <option value="motivation">Motivation</option>
                                    <option value="composite">Composite</option>
                                </select>
                            </div>
                            <div>
                                <label for="rel-target-type" data-i18n="type">Typ:</label>
                                <select id="rel-target-type" onchange="updateTargetElements()">
                                    <option value="">-- Typ --</option>
                                </select>
                            </div>
                            <div>
                                <label for="rel-target" data-i18n="element">Prvek:</label>
                                <input type="text" id="rel-target-filter" placeholder="Filtrovat..." oninput="filterSelectOptions('rel-target', this.value)" style="margin-bottom: 4px; padding: 4px 8px; font-size: 12px;">
                                <select id="rel-target" onchange="updateAllowedRelationships(); updateRelationshipId()">
                                    <option value="">-- Prvek --</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <input type="hidden" id="rel-id">
                
                <div id="relationship-info" class="relationship-info" style="display:none;"></div>
                
                <div class="form-grid" style="grid-template-columns: 1fr 2fr;">
                    <div class="form-group">
                        <label for="rel-type" data-i18n="relationshipType">Typ vazby:</label>
                        <select id="rel-type" onchange="updateStatementPreview()">
                            <option value="" data-i18n="selectElements">-- Vyberte prvky --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="rel-name" data-i18n="relationshipNameOptional">N√°zev vazby (voliteln√©):</label>
                        <input type="text" id="rel-name" list="rel-name-suggestions" data-i18n-placeholder="relNamePlaceholder" placeholder="nap≈ô. p≈ôen√°≈°√≠ data" oninput="updateStatementPreview()">
                        <datalist id="rel-name-suggestions"></datalist>
                    </div>
                </div>
                
                <div id="statement-preview" class="statement-preview" style="display:none;">
                    <strong data-i18n="statement">Statement:</strong> <span id="statement-text">-</span>
                </div>
                
                <label for="rel-description" data-i18n="relDescriptionOptional">Popis vazby (voliteln√©):</label>
                <textarea id="rel-description" data-i18n-placeholder="relDescriptionPlaceholder" placeholder="Popis vazby"></textarea>
                
                <label for="rel-p≈ô√≠znaky" data-i18n="tags">P≈ô√≠znaky:</label>
                <input type="text" id="rel-p≈ô√≠znaky" data-i18n-placeholder="tagsPlaceholder" placeholder="nap≈ô. ‚úÖ schv√°leno, üöß rozpracov√°no" list="p≈ô√≠znaky-suggestions">
                
                <div class="actions">
                    <button type="button" class="btn-primary" onclick="saveRelationship()" accesskey="u" data-i18n="saveRelationship">Ulo≈æit vazbu</button>
                    <button type="button" class="btn-secondary" onclick="clearRelationshipForm()" data-i18n="clearForm">Zru≈°it</button>
                </div>
            </div>
        </div>

        <!-- TAB: Diagramy -->
        <div id="tab-diagrams" class="tab-content" role="tabpanel" aria-labelledby="btn-diagrams">
            
            <!-- Seznam diagram≈Ø -->
            <div id="diagrams-list">
                <div class="panel full-width">
                    <h2 data-i18n="diagramsList">Seznam diagram≈Ø</h2>
                    
                    <div id="diagrams-table-container">
                        <table id="diagrams-table" aria-label="Seznam diagram≈Ø">
                            <thead>
                                <tr>
                                    <th scope="col" data-i18n="name">N√°zev</th>
                                    <th scope="col" data-i18n="elementsInDiagram">Poƒçet prvk≈Ø</th>
                                    <th scope="col" data-i18n="relationshipsInDiagram">Poƒçet vazeb</th>
                                    <th scope="col" data-i18n="actions">Akce</th>
                                </tr>
                            </thead>
                            <tbody id="diagrams-tbody">
                                <tr><td colspan="4" class="no-data" data-i18n="noDiagrams">Zat√≠m nejsou ≈æ√°dn√© diagramy</td></tr>
                            </tbody>
                        </table>
                        <details class="column-toggles">
                            <summary data-i18n="columns">Zobrazen√© sloupce</summary>
                            <div class="toggle-list">
                                <label><input type="checkbox" checked onchange="toggleColumn('diagrams-table', 0, this.checked)"> <span data-i18n="name">N√°zev</span></label>
                                <label><input type="checkbox" checked onchange="toggleColumn('diagrams-table', 1, this.checked)"> <span data-i18n="elementsInDiagram">Poƒçet prvk≈Ø</span></label>
                                <label><input type="checkbox" checked onchange="toggleColumn('diagrams-table', 2, this.checked)"> <span data-i18n="relationshipsInDiagram">Poƒçet vazeb</span></label>
                                <label><input type="checkbox" checked onchange="toggleColumn('diagrams-table', 3, this.checked)"> <span data-i18n="actions">Akce</span></label>
                            </div>
                        </details>
                    </div>
                </div>
                
                <div class="panel full-width">
                    <h2 data-i18n="newDiagram">Nov√Ω diagram</h2>
                    
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr auto;">
                        <div class="form-group">
                            <label for="new-diagram-name" data-i18n="diagramName">N√°zev diagramu:</label>
                            <input type="text" id="new-diagram-name" data-i18n-placeholder="diagramNamePlaceholder" placeholder="nap≈ô. Application Architecture" style="margin-bottom:0;">
                        </div>
                        <div class="form-group">
                            <label for="new-diagram-description" data-i18n="description">Popis:</label>
                            <input type="text" id="new-diagram-description" data-i18n-placeholder="optionalDescription" placeholder="Voliteln√Ω popis diagramu" style="margin-bottom:0;">
                        </div>
                        <div class="form-group" style="align-self: end;">
                            <button type="button" class="btn-primary" onclick="createDiagram()" data-i18n="createDiagram">Vytvo≈ôit diagram</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Editor diagramu -->
            <div id="diagram-editor" class="diagram-editor">
                <div class="panel full-width">
                    <div class="diagram-header">
                        <h2 id="diagram-editor-title" data-i18n="editDiagram">Editace diagramu</h2>
                        <button type="button" class="btn-secondary" onclick="closeDiagramEditor()" data-i18n="backToList">‚Üê Zpƒõt na seznam</button>
                    </div>
                    
                    <nav class="diagram-subtabs" role="tablist" aria-label="ƒå√°sti diagramu">
                        <button class="diagram-subtab active" role="tab" aria-selected="true" onclick="switchDiagramSubtab('settings')" id="diagram-subtab-settings" data-i18n="settings">
                            Nastaven√≠
                        </button>
                        <button class="diagram-subtab" role="tab" aria-selected="false" onclick="switchDiagramSubtab('elements')" id="diagram-subtab-elements" data-i18n="tabElements">
                            Prvky
                        </button>
                        <button class="diagram-subtab" role="tab" aria-selected="false" onclick="switchDiagramSubtab('relationships')" id="diagram-subtab-relationships" data-i18n="tabRelationships">
                            Vazby
                        </button>
                        <button class="diagram-subtab" role="tab" aria-selected="false" onclick="switchDiagramSubtab('preview')" id="diagram-subtab-preview" data-i18n="preview">
                            N√°hled
                        </button>
                    </nav>
                    
                    <!-- Subtab: Nastaven√≠ diagramu -->
                    <div id="diagram-content-settings" class="diagram-subtab-content active">
                        <h3 data-i18n="basicInfo">Z√°kladn√≠ √∫daje</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="diagram-name-edit" data-i18n="diagramName">N√°zev diagramu:</label>
                                <input type="text" id="diagram-name-edit" data-i18n-placeholder="diagramNamePlaceholder2" placeholder="N√°zev diagramu" onchange="saveDiagramName()">
                            </div>
                            <div class="form-group">
                                <label for="diagram-layout" data-i18n="elementLayout">Rozlo≈æen√≠ prvk≈Ø:</label>
                                <select id="diagram-layout" onchange="saveDiagramLayout()">
                                    <option value="layered" data-i18n="byLayers">Po vrstv√°ch</option>
                                    <option value="grid" data-i18n="grid">M≈ô√≠≈æka</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="diagram-description" data-i18n="diagramDescription">Popis diagramu:</label>
                            <textarea id="diagram-description" rows="3" data-i18n-placeholder="optionalDescription" placeholder="Voliteln√Ω popis diagramu" onchange="saveDiagramDescription()"></textarea>
                        </div>
                    </div>
                    
                    <!-- Subtab: Prvky na diagramu -->
                    <div id="diagram-content-elements" class="diagram-subtab-content">
                        <h3 data-i18n="elementsOnDiagram">Prvky na diagramu</h3>
                        <div id="diagram-elements-table-container">
                            <table id="diagram-elements-table" aria-label="Prvky na diagramu">
                                <thead>
                                    <tr>
                                        <th scope="col" data-i18n="layer">Vrstva</th>
                                        <th scope="col">Typ</th>
                                        <th scope="col">N√°zev</th>
                                        <th scope="col">Akce</th>
                                    </tr>
                                </thead>
                                <tbody id="diagram-elements-tbody">
                                    <tr><td colspan="4" class="no-data" data-i18n="diagramNoElements">Diagram neobsahuje ≈æ√°dn√© prvky</td></tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <h3 data-i18n="addElementToDiagram">P≈ôidat prvek na diagram</h3>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr 2fr auto;">
                            <div class="form-group">
                                <label for="diagram-add-layer" data-i18n="layer">Vrstva:</label>
                                <select id="diagram-add-layer" onchange="updateDiagramAddTypes()" style="margin-bottom:0;">
                                    <option value="">-- Vrstva --</option>
                                    <option value="strategy">Strategy</option>
                                    <option value="business">Business</option>
                                    <option value="application">Application</option>
                                    <option value="technology">Technology</option>
                                    <option value="physical">Physical</option>
                                    <option value="implementation">Implementation</option>
                                    <option value="motivation">Motivation</option>
                                    <option value="composite">Composite</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="diagram-add-type" data-i18n="type">Typ:</label>
                                <select id="diagram-add-type" onchange="updateDiagramAddElements()" style="margin-bottom:0;">
                                    <option value="">-- Typ --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="diagram-add-element" data-i18n="element">Prvek:</label>
                                <input type="text" id="diagram-add-element-filter" placeholder="Filtrovat..." oninput="filterSelectOptions('diagram-add-element', this.value)" style="margin-bottom: 4px; padding: 4px 8px; font-size: 12px;">
                                <select id="diagram-add-element" style="margin-bottom:0;">
                                    <option value="">-- Prvek --</option>
                                </select>
                            </div>
                            <div class="form-group" style="align-self: end;">
                                <button type="button" class="btn-primary" onclick="addElementToDiagram()" data-i18n="add">P≈ôidat</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Subtab: Vazby na diagramu -->
                    <div id="diagram-content-relationships" class="diagram-subtab-content">
                        <h3 data-i18n="relationshipsOnDiagram">Vazby na diagramu</h3>
                        <p data-i18n="relationshipsOnDiagramDesc">Zobrazuj√≠ se pouze vazby mezi prvky, kter√© jsou oba p≈ô√≠tomny na diagramu.</p>
                        <div id="diagram-relationships-table-container">
                            <table id="diagram-relationships-table" aria-label="Vazby na diagramu">
                                <thead>
                                    <tr>
                                        <th scope="col" data-i18n="source">Zdroj</th>
                                        <th scope="col" data-i18n="relationshipType">Typ vazby</th>
                                        <th scope="col" data-i18n="name">N√°zev</th>
                                        <th scope="col" data-i18n="target">C√≠l</th>
                                        <th scope="col" data-i18n="statement">Statement</th>
                                    </tr>
                                </thead>
                                <tbody id="diagram-relationships-tbody">
                                    <tr><td colspan="5" class="no-data" data-i18n="diagramNoRelationships">Na diagramu nejsou ≈æ√°dn√© vazby</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Subtab: N√°hled diagramu -->
                    <div id="diagram-content-preview" class="diagram-subtab-content">
                        <div class="layout-controls">
                            <button type="button" class="btn-secondary" onclick="renderDiagramPreview()" data-i18n="redraw">P≈ôekreslit</button>
                            <button type="button" class="btn-secondary" onclick="downloadDiagramSVG()" data-i18n="downloadSvg">St√°hnout SVG</button>
                        </div>
                        <div class="svg-container" id="diagram-svg-container" role="img" aria-label="N√°hled diagramu">
                            <p style="padding: 20px; color: #666;" data-i18n="addElementsForPreview">P≈ôidejte prvky na diagram pro zobrazen√≠ n√°hledu.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Reference -->
        <div id="tab-reference" class="tab-content" role="tabpanel" aria-labelledby="btn-reference">
            <div class="panels">
                <div class="panel full-width">
                    <h2 data-i18n="archimateReference">ArchiMate 3.2 Reference</h2>
                    
                    <h3 data-i18n="layersAndTypes">Vrstvy a typy prvk≈Ø</h3>
                    <div id="layers-reference"></div>
                    
                    <h3 data-i18n="relationshipTypes">Typy vazeb</h3>
                    <table aria-label="Typy vazeb ArchiMate">
                        <thead>
                            <tr>
                                <th data-i18n="category">Kategorie</th>
                                <th data-i18n="relationship">Vazba</th>
                                <th data-i18n="description">Popis</th>
                                <th data-i18n="notation">Notace</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td rowspan="4"><strong>Struktur√°ln√≠</strong></td>
                                <td>Composition</td>
                                <td>Prvek se skl√°d√° z jin√Ωch prvk≈Ø</td>
                                <td>‚óÜ‚îÄ‚îÄ‚îÄ</td>
                            </tr>
                            <tr>
                                <td>Aggregation</td>
                                <td>Prvek sdru≈æuje jin√© prvky</td>
                                <td>‚óá‚îÄ‚îÄ‚îÄ</td>
                            </tr>
                            <tr>
                                <td>Assignment</td>
                                <td>P≈ôi≈ôazen√≠ aktivn√≠ho prvku k chov√°n√≠</td>
                                <td>‚óè‚îÄ‚îÄ‚îÄ</td>
                            </tr>
                            <tr>
                                <td>Realization</td>
                                <td>Prvek realizuje/implementuje jin√Ω prvek</td>
                                <td>---‚ñ∑</td>
                            </tr>
                            <tr>
                                <td rowspan="3"><strong>Z√°vislostn√≠</strong></td>
                                <td>Serving</td>
                                <td>Prvek poskytuje funkcionalitu jin√©mu</td>
                                <td>‚îÄ‚îÄ‚îÄ‚ñ∑</td>
                            </tr>
                            <tr>
                                <td>Access</td>
                                <td>Chov√°n√≠ p≈ôistupuje k pasivn√≠mu prvku</td>
                                <td>- - -‚ñ∑</td>
                            </tr>
                            <tr>
                                <td>Influence</td>
                                <td>Prvek ovliv≈àuje jin√Ω prvek</td>
                                <td>- - -‚ñ∑</td>
                            </tr>
                            <tr>
                                <td rowspan="2"><strong>Dynamick√©</strong></td>
                                <td>Triggering</td>
                                <td>Prvek spou≈°t√≠ jin√Ω prvek</td>
                                <td>‚îÄ‚îÄ‚îÄ‚ñ∂</td>
                            </tr>
                            <tr>
                                <td>Flow</td>
                                <td>P≈ôenos informace nebo materi√°lu</td>
                                <td>- - -‚ñ∂</td>
                            </tr>
                            <tr>
                                <td rowspan="2"><strong>Ostatn√≠</strong></td>
                                <td>Specialization</td>
                                <td>Prvek je specializac√≠ jin√©ho prvku</td>
                                <td>‚îÄ‚îÄ‚îÄ‚ñ∑</td>
                            </tr>
                            <tr>
                                <td>Association</td>
                                <td>Nespecifikovan√Ω vztah</td>
                                <td>‚îÄ‚îÄ‚îÄ</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: Export/Import -->
        <div id="tab-export" class="tab-content" role="tabpanel" aria-labelledby="btn-export">
            <div class="panels">
                <div class="panel">
                    <h2 data-i18n="export">Export</h2>
                    
                    <div class="actions">
                        <button type="button" class="btn-success" onclick="exportJSON()" accesskey="s" data-i18n="exportJson">Export AJX</button>
                        <button type="button" class="btn-secondary" onclick="copyJSONToClipboard()" data-i18n="copyJsonClipboard">üìã Zkop√≠rovat AJX</button>
                        <button type="button" class="btn-success" onclick="exportCSV()" data-i18n="exportCsv">Export CSV</button>
                        <button type="button" class="btn-success" onclick="exportArchiMateXML()" data-i18n="exportXml">Export ArchiMate XML</button>
                    </div>
                    
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <h3 data-i18n="exportByTag">Export podle p≈ô√≠znaku</h3>
                        <p style="color: #666; font-size: 13px; margin-bottom: 10px;" data-i18n="exportByTagDesc">Exportuje pouze prvky a vazby s vybran√Ωm p≈ô√≠znakem.</p>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <select id="export-tag-select" style="min-width: 200px; padding: 8px;">
                                <option value="" data-i18n="selectTagPlaceholder">-- Vyberte p≈ô√≠znak --</option>
                            </select>
                            <button type="button" class="btn-success" onclick="exportByTagAJX()" data-i18n="exportAjxByTag">Export AJX</button>
                            <button type="button" class="btn-success" onclick="exportByTagXML()" data-i18n="exportXmlByTag">Export XML</button>
                        </div>
                        <div id="export-tag-stats" style="margin-top: 10px; font-size: 13px; color: #666;"></div>
                    </div>
                    
                    <h3 data-i18n="dataPreview">N√°hled dat</h3>
                    <div id="export-preview" class="code-preview" data-i18n="selectExportPreview">Vyberte export pro n√°hled...</div>
                </div>
                
                <div class="panel">
                    <h2 data-i18n="import">Import</h2>
                    
                    <div class="import-area" id="import-drop-area" 
                         ondrop="handleFileDrop(event)" 
                         ondragover="handleDragOver(event)" 
                         ondragleave="handleDragLeave(event)">
                        <p><strong data-i18n="dragFileHere">P≈ôet√°hnƒõte soubor sem</strong></p>
                        <p data-i18n="or">nebo</p>
                        <div class="file-input-wrapper">
                            <button type="button" class="btn-primary" data-i18n="selectFile">Vyberte soubor</button>
                            <input type="file" id="import-file" accept=".ajx,.xml" onchange="handleFileSelect(event)">
                        </div>
                        <p style="margin-top: 10px; color: #666; font-size: 13px;" data-i18n="supportedFormats">Podporovan√© form√°ty: AJX, ArchiMate XML</p>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <label for="import-data" data-i18n="pasteDataManually">Nebo vlo≈æte data ruƒçnƒõ:</label>
                        <button type="button" class="btn-secondary" onclick="pasteFromClipboard()" style="font-size: 12px; padding: 4px 8px;" data-i18n="pasteFromClipboard">üìã Vlo≈æit ze schr√°nky</button>
                    </div>
                    <textarea id="import-data" placeholder='AJX nebo ArchiMate XML...' rows="8"></textarea>
                    
                    <div class="actions">
                        <button type="button" class="btn-primary" onclick="importData()" data-i18n="import">Importovat</button>
                        <button type="button" class="btn-danger" onclick="clearAllData()" data-i18n="deleteAll">Smazat v≈°e</button>
                    </div>
                </div>
                
                <div class="panel">
                    <h2 data-i18n="mergeModels">Slouƒçit s jin√Ωm modelem</h2>
                    <p style="color: #666; margin-bottom: 15px;" data-i18n="mergeDescription">Importuje prvky, vazby a diagramy z jin√©ho modelu do aktu√°ln√≠ho. K novƒõ p≈ôidan√Ωm polo≈æk√°m se p≈ôid√° p≈ô√≠znak s n√°zvem zdrojov√©ho modelu.</p>
                    
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr; margin-bottom: 15px;">
                        <div class="form-group">
                            <label for="merge-strategy" data-i18n="onIdCollision">P≈ôi kolizi ID:</label>
                            <select id="merge-strategy" onchange="updateMergeUI()">
                                <option value="skip" data-i18n="keepExisting">Ponechat st√°vaj√≠c√≠</option>
                                <option value="overwrite" data-i18n="overwriteNew">P≈ôepsat nov√Ωmi</option>
                                <option value="manual" data-i18n="manualSelect">Ruƒçnƒõ vybrat</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="merge-file" data-i18n="fileToMerge">Soubor ke slouƒçen√≠:</label>
                            <input type="file" id="merge-file" accept=".ajx,.xml" style="padding: 6px;" onchange="loadMergePreview()">
                        </div>
                    </div>
                    
                    <div id="merge-manual-selection" style="display:none; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <button type="button" class="btn-secondary merge-tab-btn active" onclick="switchMergeTab('elements')" id="merge-tab-btn-elements" data-i18n="elements">Prvky</button>
                                <button type="button" class="btn-secondary merge-tab-btn" onclick="switchMergeTab('relationships')" id="merge-tab-btn-relationships" data-i18n="relationships">Vazby</button>
                                <button type="button" class="btn-secondary merge-tab-btn" onclick="switchMergeTab('diagrams')" id="merge-tab-btn-diagrams" data-i18n="diagrams">Diagramy</button>
                            </div>
                            <div>
                                <button type="button" class="btn-secondary" onclick="mergeSelectAll(true)" style="margin-right: 5px;" data-i18n="selectAll">‚òë Vybrat v≈°e</button>
                                <button type="button" class="btn-secondary" onclick="mergeSelectAll(false)" data-i18n="deselectAll">‚òê Odebrat v≈°e</button>
                            </div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <input type="text" id="merge-search-input" placeholder="Hledat..." oninput="filterMergeList()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" data-i18n-placeholder="searchPlaceholder">
                            <div id="merge-search-stats" style="font-size: 12px; color: #666; margin-top: 5px;"></div>
                        </div>
                        <div id="merge-elements-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background: #fafafa;">
                            <p style="color: #666;" data-i18n="selectFileFirst">Nejprve vyberte soubor...</p>
                        </div>
                        <div id="merge-relationships-list" style="display:none; max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background: #fafafa;">
                            <p style="color: #666;" data-i18n="selectFileFirst">Nejprve vyberte soubor...</p>
                        </div>
                        <div id="merge-diagrams-list" style="display:none; max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background: #fafafa;">
                            <p style="color: #666;" data-i18n="selectFileFirst">Nejprve vyberte soubor...</p>
                        </div>
                        <div id="merge-selection-stats" style="margin-top: 10px; color: #666;"></div>
                    </div>
                    
                    <div class="actions">
                        <button type="button" class="btn-primary" onclick="mergeModel()" data-i18n="merge">Slouƒçit modely</button>
                    </div>
                    
                    <div id="merge-result" style="display:none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
                </div>
            </div>
        </div>

        <!-- TAB: N√°stroje -->
        <div id="tab-tools" class="tab-content" role="tabpanel" aria-labelledby="btn-tools">
            <div class="panels">
                <!-- Spr√°va p≈ô√≠znak≈Ø -->
                <div class="panel">
                    <h2 data-i18n="tagManagement">Spr√°va p≈ô√≠znak≈Ø</h2>
                    
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <label for="tool-tag-select" data-i18n="selectTag">Vyberte p≈ô√≠znak:</label>
                            <select id="tool-tag-select" style="width: 100%;">
                                <option value="" data-i18n="selectTagPlaceholder">-- Vyberte p≈ô√≠znak --</option>
                            </select>
                            
                            <div style="margin-top: 15px;">
                                <strong data-i18n="removeFrom">Odstranit z:</strong>
                                <div style="margin-top: 8px;">
                                    <button type="button" class="btn-secondary" onclick="removeTagFrom('elements')" style="margin-right: 5px;" data-i18n="removeFromElements">Odstranit z prvk≈Ø</button>
                                    <button type="button" class="btn-secondary" onclick="removeTagFrom('relationships')" style="margin-right: 5px;" data-i18n="removeFromRelationships">Odstranit z vazeb</button>
                                    <button type="button" class="btn-danger" onclick="removeTagFrom('all')" data-i18n="deleteEverywhere">Smazat odev≈°ud</button>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label for="tool-tag-replace" data-i18n="replaceWithTag">Nahradit p≈ô√≠znakem:</label>
                            <input type="text" id="tool-tag-replace" data-i18n-placeholder="newTagPlaceholder" placeholder="Nov√Ω p≈ô√≠znak..." list="p≈ô√≠znaky-suggestions">
                            
                            <div style="margin-top: 15px;">
                                <strong data-i18n="replaceIn">Nahradit ve:</strong>
                                <div style="margin-top: 8px;">
                                    <button type="button" class="btn-primary" onclick="replaceTagIn('elements')" style="margin-right: 5px;" data-i18n="replaceInElements">Nahradit v prvc√≠ch</button>
                                    <button type="button" class="btn-primary" onclick="replaceTagIn('relationships')" style="margin-right: 5px;" data-i18n="replaceInRelationships">Nahradit ve vazb√°ch</button>
                                    <button type="button" class="btn-primary" onclick="replaceTagIn('all')" data-i18n="replaceEverywhere">Nahradit v≈°ude</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tool-tag-result" style="display:none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
                </div>
                
                <!-- Hromadn√° spr√°va p≈ô√≠znak≈Ø -->
                <div class="panel">
                    <h2 data-i18n="bulkTagManagement">Hromadn√° spr√°va p≈ô√≠znak≈Ø</h2>
                    <p style="color: #666; margin-bottom: 15px;" data-i18n="bulkTagDesc">P≈ôid√°n√≠ nebo odebr√°n√≠ p≈ô√≠znaku z vybran√Ωch prvk≈Ø nebo vazeb.</p>
                    <button type="button" class="btn-primary" onclick="openBulkTagModal()" data-i18n="openBulkManagement">Otev≈ô√≠t hromadnou spr√°vu</button>
                </div>
                
                <!-- Gener√°tor textu -->
                <div class="panel full-width">
                    <h2 data-i18n="textGenerator">Gener√°tor textu</h2>
                    <p style="color: #666; margin-bottom: 15px;" data-i18n="textGeneratorDesc">Generuje text z aktu√°lnƒõ zobrazen√Ωch (filtrovan√Ωch) prvk≈Ø nebo vazeb podle zadan√© ≈°ablony.</p>
                    
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <label for="generator-source" data-i18n="sourceData">Zdroj dat:</label>
                            <select id="generator-source" onchange="updateGeneratorPlaceholders()">
                                <option value="elements" data-i18n="currentElements">Aktu√°ln√≠ seznam prvk≈Ø</option>
                                <option value="relationships" data-i18n="currentRelationships">Aktu√°ln√≠ seznam vazeb</option>
                                <option value="tasks" data-i18n="currentTasks">Aktu√°ln√≠ seznam √∫kol≈Ø</option>
                                <option value="notes" data-i18n="currentNotes">Aktu√°ln√≠ seznam pozn√°mek</option>
                                <option value="adr" data-i18n="currentAdr">Aktu√°ln√≠ seznam ADR</option>
                            </select>
                            
                            <div style="margin-top: 15px;">
                                <strong data-i18n="availablePlaceholders">Dostupn√© placeholdery:</strong>
                                <div id="generator-placeholders" style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 5px;">
                                    <!-- Placeholdery se vlo≈æ√≠ dynamicky -->
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label for="generator-template" data-i18n="templateLabel">≈†ablona (pro ka≈æd√Ω ≈ô√°dek):</label>
                            <textarea id="generator-template" rows="5" data-i18n-placeholder="templatePlaceholder" placeholder="Nap≈ô.: {Stereotyp} {N√°zev} je typu {Typ}&#10;&#10;Kliknut√≠m na placeholder ho vlo≈æ√≠te na pozici kurzoru."></textarea>
                            
                            <div style="margin-top: 10px;">
                                <label><input type="checkbox" id="generator-skip-empty"> <span data-i18n="skipEmpty">P≈ôeskoƒçit polo≈æky kde jsou pr√°zdn√© pou≈æit√© placeholdery</span></label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="actions" style="margin-top: 15px;">
                        <button type="button" class="btn-primary" onclick="generateText()" data-i18n="generate">Generovat</button>
                        <button type="button" class="btn-secondary" onclick="copyGeneratedText()" data-i18n="copyResult">üìã Zkop√≠rovat v√Ωsledek</button>
                        <button type="button" class="btn-secondary" onclick="clearGeneratedText()" data-i18n="clear">Vymazat</button>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <label for="generator-output"><span data-i18n="result">V√Ωsledek</span> (<span id="generator-count">0</span> <span data-i18n="items">polo≈æek</span>):</label>
                        <textarea id="generator-output" rows="12" readonly style="font-family: monospace; background: #f8f9fa;"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Tasks -->
        <div id="tab-tasks" class="tab-content" role="tabpanel" aria-labelledby="btn-tasks">
            <div class="panels">
                <div class="panel full-width">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 data-i18n="tasksTitle">√ökoly</h2>
                        <div>
                            <button type="button" class="btn-secondary" onclick="exportAllTasksMarkdown()" style="margin-right: 10px;" data-i18n="tasksExportAll">üì¶ Exportovat v≈°echny √∫koly</button>
                            <button type="button" class="btn-primary" onclick="openTaskEditor()" data-i18n="tasksNew">+ Nov√Ω √∫kol</button>
                        </div>
                    </div>
                    
                    <!-- Filtry -->
                    <div style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                        <div style="flex: 0 0 150px;">
                            <select id="task-filter-status" onchange="renderTasksTable()" style="width: 100%;">
                                <option value="" data-i18n="taskFilterAllStatuses">V≈°echny stavy</option>
                                <option value="new" data-i18n="taskStatusNew">Nov√Ω</option>
                                <option value="in_progress" data-i18n="taskStatusInProgress">Prob√≠h√°</option>
                                <option value="blocked" data-i18n="taskStatusBlocked">Blokov√°no</option>
                                <option value="review" data-i18n="taskStatusReview">Ke kontrole</option>
                                <option value="done" data-i18n="taskStatusDone">Hotovo</option>
                                <option value="cancelled" data-i18n="taskStatusCancelled">Zru≈°eno</option>
                            </select>
                        </div>
                        <div style="flex: 0 0 150px;">
                            <select id="task-filter-priority" onchange="renderTasksTable()" style="width: 100%;">
                                <option value="" data-i18n="taskFilterAllPriorities">V≈°echny priority</option>
                                <option value="critical" data-i18n="taskPriorityCritical">Kritick√°</option>
                                <option value="high" data-i18n="taskPriorityHigh">Vysok√°</option>
                                <option value="medium" data-i18n="taskPriorityMedium">St≈ôedn√≠</option>
                                <option value="low" data-i18n="taskPriorityLow">N√≠zk√°</option>
                            </select>
                        </div>
                        <div style="flex: 0 0 150px;">
                            <select id="task-filter-assignee" onchange="renderTasksTable()" style="width: 100%;">
                                <option value="" data-i18n="taskFilterAllAssignees">V≈°ichni ≈ôe≈°itel√©</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <input type="text" id="task-search" placeholder="Hledat v √∫kolech..." oninput="renderTasksTable()" style="width: 100%;" data-i18n-placeholder="searchPlaceholder">
                        </div>
                    </div>
                    
                    <!-- Tabulka √∫kol≈Ø -->
                    <div class="table-container">
                        <table id="tasks-table">
                            <thead>
                                <tr>
                                    <th style="width: 50px;" data-i18n="taskNumber">#</th>
                                    <th data-i18n="taskTitleLabel">N√°zev</th>
                                    <th style="width: 100px;" data-i18n="taskStatus">Stav</th>
                                    <th style="width: 90px;" data-i18n="taskPriority">Priorita</th>
                                    <th style="width: 120px;" data-i18n="taskAssignee">≈òe≈°itel</th>
                                    <th style="width: 100px;" data-i18n="taskDueDate">Term√≠n</th>
                                    <th style="width: 130px;" data-i18n="actions">Akce</th>
                                </tr>
                            </thead>
                            <tbody id="tasks-table-body">
                                <tr><td colspan="7" style="text-align: center; color: #666;" data-i18n="taskNoRecords">Zat√≠m nejsou vytvo≈ôeny ≈æ√°dn√© √∫koly.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Notes -->
        <div id="tab-notes" class="tab-content" role="tabpanel" aria-labelledby="btn-notes">
            <div class="panels">
                <div class="panel full-width">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 data-i18n="notesTitle">Pozn√°mky</h2>
                        <button type="button" class="btn-primary" onclick="openNoteEditor()" data-i18n="notesNew">+ Nov√° pozn√°mka</button>
                    </div>
                    
                    <!-- Vyhled√°v√°n√≠ -->
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="notes-search" placeholder="Hledat v pozn√°mk√°ch..." oninput="renderNotesTable()" style="width: 100%; max-width: 400px;" data-i18n-placeholder="searchPlaceholder">
                    </div>
                    
                    <!-- Tabulka pozn√°mek -->
                    <div class="table-container">
                        <table id="notes-table">
                            <thead>
                                <tr>
                                    <th data-i18n="noteName">N√°zev</th>
                                    <th style="width: 120px;" data-i18n="noteAuthor">Autor</th>
                                    <th style="width: 150px;" data-i18n="tags">P≈ô√≠znaky</th>
                                    <th style="width: 150px;" data-i18n="noteUpdated">Posledn√≠ √∫prava</th>
                                    <th style="width: 60px;" data-i18n="noteVersions">Verze</th>
                                    <th style="width: 130px;" data-i18n="actions">Akce</th>
                                </tr>
                            </thead>
                            <tbody id="notes-table-body">
                                <tr><td colspan="6" style="text-align: center; color: #666;" data-i18n="noteNoRecords">Zat√≠m nejsou vytvo≈ôeny ≈æ√°dn√© pozn√°mky.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: ADR -->
        <div id="tab-adr" class="tab-content" role="tabpanel" aria-labelledby="btn-adr">
            <div class="panels">
                <div class="panel full-width">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 data-i18n="adrTitle">Architektonick√° rozhodnut√≠ (ADR)</h2>
                        <div>
                            <button type="button" class="btn-secondary" onclick="exportAllAdrMarkdown()" style="margin-right: 10px;" data-i18n="adrExportAll">üì¶ Exportovat v≈°echny ADR</button>
                            <button type="button" class="btn-primary" onclick="openAdrEditor()" data-i18n="adrNew">+ Nov√© ADR</button>
                        </div>
                    </div>
                    
                    <!-- Filtry -->
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <div style="flex: 0 0 200px;">
                            <select id="adr-filter-status" onchange="renderAdrTable()" style="width: 100%;">
                                <option value="" data-i18n="adrFilterAll">V≈°echny stavy</option>
                                <option value="draft" data-i18n="adrStatusDraft">Rozpracov√°no</option>
                                <option value="proposed" data-i18n="adrStatusProposed">Navr≈æeno</option>
                                <option value="under_discussion" data-i18n="adrStatusUnderDiscussion">Projedn√°v√°no</option>
                                <option value="returned" data-i18n="adrStatusReturned">Vr√°ceno</option>
                                <option value="accepted" data-i18n="adrStatusAccepted">Schv√°leno</option>
                                <option value="rejected" data-i18n="adrStatusRejected">Zam√≠tnuto</option>
                                <option value="updated" data-i18n="adrStatusUpdated">Aktualizov√°no</option>
                                <option value="implemented" data-i18n="adrStatusImplemented">Implementov√°no</option>
                                <option value="monitored" data-i18n="adrStatusMonitored">Sledov√°no</option>
                                <option value="deprecated" data-i18n="adrStatusDeprecated">Zastaral√©</option>
                                <option value="superseded" data-i18n="adrStatusSuperseded">Nahrazeno</option>
                                <option value="closed" data-i18n="adrStatusClosed">Uzav≈ôeno</option>
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <input type="text" id="adr-search" placeholder="Hledat v ADR..." oninput="renderAdrTable()" style="width: 100%;" data-i18n-placeholder="searchPlaceholder">
                        </div>
                    </div>
                    
                    <!-- Tabulka ADR -->
                    <div class="table-container">
                        <table id="adr-table">
                            <thead>
                                <tr>
                                    <th style="width: 50px;" data-i18n="adrNumber">#</th>
                                    <th data-i18n="adrTitleLabel">N√°zev</th>
                                    <th style="width: 120px;" data-i18n="adrStatus">Stav</th>
                                    <th style="width: 150px;" data-i18n="adrAuthor">Autor</th>
                                    <th style="width: 100px;" data-i18n="adrUpdated">Aktualizov√°no</th>
                                    <th style="width: 150px;" data-i18n="actions">Akce</th>
                                </tr>
                            </thead>
                            <tbody id="adr-table-body">
                                <tr><td colspan="6" style="text-align: center; color: #666;" data-i18n="adrNoRecords">Zat√≠m nejsou vytvo≈ôena ≈æ√°dn√° ADR.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: ADR Editor -->
    <div id="adr-editor-modal" class="modal-overlay" onclick="closeAdrEditorOnOverlay(event)">
        <div class="modal" style="max-width: 900px; width: 95%;">
            <div class="modal-header">
                <h2 id="adr-editor-title" data-i18n="adrNew">Nov√© ADR</h2>
                <button type="button" class="modal-close" onclick="closeAdrEditor()">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <input type="hidden" id="adr-edit-id">
                
                <!-- Z√°kladn√≠ informace -->
                <fieldset class="fieldset">
                    <legend data-i18n="adrBasicInfo">Z√°kladn√≠ informace</legend>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label for="adr-number" data-i18n="adrNumber">#</label>
                            <input type="text" id="adr-number" style="width: 100px;" placeholder="1, E1, A-01...">
                        </div>
                        <div class="form-group">
                            <label for="adr-status" data-i18n="adrStatus">Stav</label>
                            <select id="adr-status" onchange="handleAdrStatusChange()">
                                <option value="draft" data-i18n="adrStatusDraft">Rozpracov√°no</option>
                                <option value="proposed" data-i18n="adrStatusProposed">Navr≈æeno</option>
                                <option value="under_discussion" data-i18n="adrStatusUnderDiscussion">Projedn√°v√°no</option>
                                <option value="returned" data-i18n="adrStatusReturned">Vr√°ceno</option>
                                <option value="accepted" data-i18n="adrStatusAccepted">Schv√°leno</option>
                                <option value="rejected" data-i18n="adrStatusRejected">Zam√≠tnuto</option>
                                <option value="updated" data-i18n="adrStatusUpdated">Aktualizov√°no</option>
                                <option value="implemented" data-i18n="adrStatusImplemented">Implementov√°no</option>
                                <option value="monitored" data-i18n="adrStatusMonitored">Sledov√°no</option>
                                <option value="deprecated" data-i18n="adrStatusDeprecated">Zastaral√©</option>
                                <option value="superseded" data-i18n="adrStatusSuperseded">Nahrazeno</option>
                                <option value="closed" data-i18n="adrStatusClosed">Uzav≈ôeno</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="adr-title-input" data-i18n="adrTitleLabel">N√°zev</label>
                        <input type="text" id="adr-title-input" style="width: 100%;">
                    </div>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label for="adr-author" data-i18n="adrAuthor">Autor</label>
                            <input type="text" id="adr-author">
                        </div>
                        <div class="form-group">
                            <label for="adr-approver" data-i18n="adrApprover">Schvalovatel</label>
                            <input type="text" id="adr-approver">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="adr-deciders" data-i18n="adrDeciders">Rozhodovatel√©</label>
                        <input type="text" id="adr-deciders" placeholder="Oddƒõlte ƒç√°rkou..." data-i18n-placeholder="separateByComma">
                    </div>
                    <div class="form-group">
                        <label for="adr-tags" data-i18n="adrTags">Tagy</label>
                        <input type="text" id="adr-tags" placeholder="Oddƒõlte ƒç√°rkou..." data-i18n-placeholder="separateByComma">
                    </div>
                </fieldset>
                
                <!-- Kontext -->
                <fieldset class="fieldset">
                    <legend data-i18n="adrContext">Kontext</legend>
                    <div class="form-group">
                        <textarea id="adr-context" rows="4" style="width: 100%;" placeholder="Popi≈°te kontext a d≈Øvody pro toto rozhodnut√≠..." data-i18n-placeholder="adrContextPlaceholder"></textarea>
                    </div>
                </fieldset>
                
                <!-- Rozhodnut√≠ -->
                <fieldset class="fieldset">
                    <legend data-i18n="adrDecision">Rozhodnut√≠</legend>
                    <div class="form-group">
                        <textarea id="adr-decision" rows="4" style="width: 100%;" placeholder="Popi≈°te rozhodnut√≠, kter√© bylo uƒçinƒõno..." data-i18n-placeholder="adrDecisionPlaceholder"></textarea>
                    </div>
                </fieldset>
                
                <!-- D≈Øsledky -->
                <fieldset class="fieldset">
                    <legend data-i18n="adrConsequences">D≈Øsledky</legend>
                    <div class="form-group">
                        <textarea id="adr-consequences" rows="4" style="width: 100%;" placeholder="Popi≈°te d≈Øsledky tohoto rozhodnut√≠..." data-i18n-placeholder="adrConsequencesPlaceholder"></textarea>
                    </div>
                </fieldset>
                
                <!-- Alternativy -->
                <fieldset class="fieldset">
                    <legend data-i18n="adrAlternatives">Zva≈æovan√© alternativy</legend>
                    <div id="adr-alternatives-container"></div>
                    <button type="button" class="btn-secondary" onclick="addAdrAlternative()" data-i18n="adrAddAlternative">+ P≈ôidat alternativu</button>
                    
                    <div style="margin-top: 15px; padding: 15px; background: #e8f5e9; border-radius: 4px; border: 1px solid #c8e6c9;">
                        <div class="form-group">
                            <label for="adr-selected-alternative" style="font-weight: bold; color: #2e7d32;" data-i18n="adrSelectedAlternative">Vybran√° varianta</label>
                            <select id="adr-selected-alternative" style="width: 100%;">
                                <option value="">-- Vyberte --</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="adr-selection-reason" data-i18n="adrSelectionReason">Od≈Øvodnƒõn√≠ v√Ωbƒõru</label>
                            <textarea id="adr-selection-reason" rows="3" style="width: 100%;" placeholder="Proƒç byla tato varianta vybr√°na..." data-i18n-placeholder="adrSelectionReasonPlaceholder"></textarea>
                        </div>
                    </div>
                </fieldset>
                
                <!-- Implementace -->
                <fieldset class="fieldset">
                    <legend data-i18n="adrImplementation">Implementace</legend>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                        <div class="form-group">
                            <label for="adr-impl-status" data-i18n="adrImplStatus">Stav implementace</label>
                            <select id="adr-impl-status">
                                <option value="not_started" data-i18n="adrImplNotStarted">Nezah√°jeno</option>
                                <option value="in_progress" data-i18n="adrImplInProgress">Prob√≠h√°</option>
                                <option value="completed" data-i18n="adrImplCompleted">Dokonƒçeno</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="adr-impl-start" data-i18n="adrImplStartDate">Datum zah√°jen√≠</label>
                            <input type="date" id="adr-impl-start">
                        </div>
                        <div class="form-group">
                            <label for="adr-impl-target" data-i18n="adrImplTargetDate">C√≠lov√© datum</label>
                            <input type="date" id="adr-impl-target">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="adr-impl-notes" data-i18n="adrImplNotes">Pozn√°mky k implementaci</label>
                        <textarea id="adr-impl-notes" rows="2" style="width: 100%;"></textarea>
                    </div>
                </fieldset>
                
                <!-- Souvisej√≠c√≠ ADR -->
                <fieldset class="fieldset">
                    <legend data-i18n="adrRelatedAdr">Souvisej√≠c√≠ ADR</legend>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                        <div class="form-group">
                            <label for="adr-supersedes" data-i18n="adrSupersedes">Nahrazuje</label>
                            <select id="adr-supersedes" multiple size="3" style="width: 100%;"></select>
                        </div>
                        <div class="form-group">
                            <label for="adr-superseded-by" data-i18n="adrSupersededBy">Nahrazeno</label>
                            <select id="adr-superseded-by" multiple size="3" style="width: 100%;"></select>
                        </div>
                        <div class="form-group">
                            <label for="adr-related-to" data-i18n="adrRelatedTo">Souvis√≠ s</label>
                            <select id="adr-related-to" multiple size="3" style="width: 100%;"></select>
                        </div>
                    </div>
                </fieldset>
                
                <!-- Odkazy -->
                <fieldset class="fieldset">
                    <legend data-i18n="adrLinks">Odkazy</legend>
                    <div id="adr-links-container"></div>
                    <button type="button" class="btn-secondary" onclick="addAdrLink()" data-i18n="adrAddLink">+ P≈ôidat odkaz</button>
                </fieldset>
                
                <!-- Propojen√© polo≈æky -->
                <fieldset class="fieldset">
                    <legend data-i18n="linkedItems">Propojen√© polo≈æky</legend>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label for="adr-linked-elements" data-i18n="linkedElements">Propojen√© prvky</label>
                            <input type="text" id="adr-linked-elements-filter" placeholder="Filtrovat..." oninput="filterSelectOptions('adr-linked-elements', this.value)" style="margin-bottom: 4px; padding: 4px 8px; font-size: 12px;">
                            <select id="adr-linked-elements" multiple size="4" style="width: 100%;"></select>
                        </div>
                        <div class="form-group">
                            <label for="adr-linked-relationships" data-i18n="linkedRelationships">Propojen√© vazby</label>
                            <input type="text" id="adr-linked-relationships-filter" placeholder="Filtrovat..." oninput="filterSelectOptions('adr-linked-relationships', this.value)" style="margin-bottom: 4px; padding: 4px 8px; font-size: 12px;">
                            <select id="adr-linked-relationships" multiple size="4" style="width: 100%;"></select>
                        </div>
                    </div>
                    <small style="color: #666;" data-i18n="linkedItemsHelp">Dr≈æte Ctrl/Cmd pro v√Ωbƒõr v√≠ce polo≈æek</small>
                </fieldset>
                
                <!-- Historie stav≈Ø -->
                <fieldset class="fieldset" id="adr-status-history-fieldset" style="display: none;">
                    <legend data-i18n="adrStatusHistory">Historie stav≈Ø</legend>
                    <div id="adr-status-history"></div>
                </fieldset>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between;">
                <div>
                    <button type="button" class="btn-secondary" onclick="saveAdrAsMarkdown()" style="margin-right: 5px;" data-i18n="adrSaveMarkdown">üìÑ Ulo≈æit jako Markdown</button>
                    <button type="button" class="btn-secondary" onclick="saveAdrAsDocx()" style="margin-right: 5px;" data-i18n="adrSaveDocx">üìù Ulo≈æit jako DOCX</button>
                    <button type="button" class="btn-secondary" onclick="copyAdrAsMarkdown()" data-i18n="adrCopyMarkdown">üìã Kop√≠rovat Markdown</button>
                </div>
                <div>
                    <button type="button" class="btn-secondary" onclick="closeAdrEditor()" data-i18n="cancel">Zru≈°it</button>
                    <button type="button" class="btn-primary" onclick="saveAdr()" data-i18n="save">Ulo≈æit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: ADR Preview -->
    <div id="adr-preview-modal" class="modal-overlay" onclick="closeAdrPreviewOnOverlay(event)">
        <div class="modal" style="max-width: 800px; width: 95%;">
            <div class="modal-header">
                <h2 id="adr-preview-title" data-i18n="adrPreview">N√°hled ADR</h2>
                <button type="button" class="modal-close" onclick="closeAdrPreview()">&times;</button>
            </div>
            <div class="modal-body" id="adr-preview-content" style="max-height: 70vh; overflow-y: auto;">
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between;">
                <div>
                    <button type="button" class="btn-secondary" onclick="previewAdrSaveMarkdown()" style="margin-right: 5px;" data-i18n="adrSaveMarkdown">üìÑ Ulo≈æit jako Markdown</button>
                    <button type="button" class="btn-secondary" onclick="previewAdrSaveDocx()" style="margin-right: 5px;" data-i18n="adrSaveDocx">üìù Ulo≈æit jako DOCX</button>
                    <button type="button" class="btn-secondary" onclick="previewAdrCopyMarkdown()" data-i18n="adrCopyMarkdown">üìã Kop√≠rovat Markdown</button>
                </div>
                <div>
                    <button type="button" class="btn-secondary" onclick="closeAdrPreview()" style="margin-right: 5px;" data-i18n="close">Zav≈ô√≠t</button>
                    <button type="button" class="btn-primary" onclick="previewAdrEdit()" data-i18n="edit">Upravit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Task Editor -->
    <div id="task-editor-modal" class="modal-overlay" onclick="closeTaskEditorOnOverlay(event)">
        <div class="modal" style="max-width: 900px; width: 95%;">
            <div class="modal-header">
                <h2 id="task-editor-title" data-i18n="tasksNew">Nov√Ω √∫kol</h2>
                <button type="button" class="modal-close" onclick="closeTaskEditor()">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <input type="hidden" id="task-edit-id">
                
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="form-group">
                        <label for="task-number" data-i18n="taskNumber">ƒå√≠slo</label>
                        <input type="text" id="task-number" style="width: 100%;">
                    </div>
                    <div class="form-group">
                        <label for="task-status" data-i18n="taskStatus">Stav</label>
                        <select id="task-status" onchange="handleTaskStatusChange()">
                            <option value="new" data-i18n="taskStatusNew">Nov√Ω</option>
                            <option value="in_progress" data-i18n="taskStatusInProgress">Prob√≠h√°</option>
                            <option value="blocked" data-i18n="taskStatusBlocked">Blokov√°no</option>
                            <option value="review" data-i18n="taskStatusReview">Ke kontrole</option>
                            <option value="done" data-i18n="taskStatusDone">Hotovo</option>
                            <option value="cancelled" data-i18n="taskStatusCancelled">Zru≈°eno</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="task-priority" data-i18n="taskPriority">Priorita</label>
                        <select id="task-priority">
                            <option value="low" data-i18n="taskPriorityLow">N√≠zk√°</option>
                            <option value="medium" data-i18n="taskPriorityMedium" selected>St≈ôedn√≠</option>
                            <option value="high" data-i18n="taskPriorityHigh">Vysok√°</option>
                            <option value="critical" data-i18n="taskPriorityCritical">Kritick√°</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="task-title-input" data-i18n="taskTitleLabel">N√°zev</label>
                    <input type="text" id="task-title-input" style="width: 100%;">
                </div>
                
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="form-group">
                        <label for="task-assignee" data-i18n="taskAssignee">≈òe≈°itel</label>
                        <input type="text" id="task-assignee">
                    </div>
                    <div class="form-group">
                        <label for="task-reporter" data-i18n="taskReporter">Zadavatel</label>
                        <input type="text" id="task-reporter">
                    </div>
                    <div class="form-group">
                        <label for="task-due-date" data-i18n="taskDueDate">Term√≠n</label>
                        <input type="date" id="task-due-date">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="task-tags" data-i18n="tags">P≈ô√≠znaky (oddƒõlen√© ƒç√°rkou)</label>
                    <input type="text" id="task-tags" style="width: 100%;" placeholder="tag1, tag2, tag3...">
                </div>
                
                <div class="form-group">
                    <label for="task-description" data-i18n="taskDescription">Popis √∫kolu</label>
                    <textarea id="task-description" rows="6" style="width: 100%; font-family: monospace;" placeholder="Detailn√≠ popis √∫kolu (podporuje Markdown)..." data-i18n-placeholder="taskDescriptionPlaceholder"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="task-current-state" data-i18n="taskCurrentState">Aktu√°ln√≠ stav / Pozn√°mky k ≈ôe≈°en√≠</label>
                    <textarea id="task-current-state" rows="4" style="width: 100%; font-family: monospace;" placeholder="Popis aktu√°ln√≠ho stavu ≈ôe≈°en√≠..." data-i18n-placeholder="taskCurrentStatePlaceholder"></textarea>
                </div>
                
                <fieldset style="margin-top: 15px; border: 1px solid #ddd; border-radius: 4px; padding: 15px;">
                    <legend style="font-weight: bold;" data-i18n="linkedItems">Propojen√© polo≈æky</legend>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label for="task-linked-elements" data-i18n="linkedElements">Propojen√© prvky</label>
                            <input type="text" id="task-linked-elements-filter" placeholder="Filtrovat..." oninput="filterSelectOptions('task-linked-elements', this.value)" style="margin-bottom: 4px; padding: 4px 8px; font-size: 12px;">
                            <select id="task-linked-elements" multiple size="4" style="width: 100%;"></select>
                        </div>
                        <div class="form-group">
                            <label for="task-linked-relationships" data-i18n="linkedRelationships">Propojen√© vazby</label>
                            <input type="text" id="task-linked-relationships-filter" placeholder="Filtrovat..." oninput="filterSelectOptions('task-linked-relationships', this.value)" style="margin-bottom: 4px; padding: 4px 8px; font-size: 12px;">
                            <select id="task-linked-relationships" multiple size="4" style="width: 100%;"></select>
                        </div>
                    </div>
                    <small style="color: #666;" data-i18n="linkedItemsHelp">Dr≈æte Ctrl/Cmd pro v√Ωbƒõr v√≠ce polo≈æek</small>
                </fieldset>
                
                <!-- Historie stav≈Ø -->
                <fieldset class="fieldset" id="task-status-history-fieldset" style="display: none; margin-top: 15px;">
                    <legend data-i18n="taskStatusHistory">Historie stav≈Ø</legend>
                    <div id="task-status-history" style="max-height: 200px; overflow-y: auto;"></div>
                </fieldset>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between;">
                <div>
                    <button type="button" class="btn-secondary" onclick="saveTaskAsMarkdown()" style="margin-right: 5px;" data-i18n="taskSaveMarkdown">üìÑ Ulo≈æit jako Markdown</button>
                    <button type="button" class="btn-secondary" onclick="saveTaskAsDocx()" style="margin-right: 5px;" data-i18n="taskSaveDocx">üìù Ulo≈æit jako DOCX</button>
                    <button type="button" class="btn-secondary" onclick="copyTaskAsMarkdown()" data-i18n="taskCopyMarkdown">üìã Kop√≠rovat Markdown</button>
                </div>
                <div>
                    <button type="button" class="btn-secondary" onclick="closeTaskEditor()" data-i18n="cancel">Zru≈°it</button>
                    <button type="button" class="btn-primary" onclick="saveTask()" data-i18n="save">Ulo≈æit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Task Preview -->
    <div id="task-preview-modal" class="modal-overlay" onclick="closeTaskPreviewOnOverlay(event)">
        <div class="modal" style="max-width: 800px; width: 95%;">
            <div class="modal-header">
                <h2 id="task-preview-title" data-i18n="taskPreview">N√°hled √∫kolu</h2>
                <button type="button" class="modal-close" onclick="closeTaskPreview()">&times;</button>
            </div>
            <div class="modal-body" id="task-preview-content" style="max-height: 70vh; overflow-y: auto;">
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between;">
                <div>
                    <button type="button" class="btn-secondary" onclick="previewTaskSaveMarkdown()" style="margin-right: 5px;" data-i18n="taskSaveMarkdown">üìÑ Ulo≈æit jako Markdown</button>
                    <button type="button" class="btn-secondary" onclick="previewTaskSaveDocx()" style="margin-right: 5px;" data-i18n="taskSaveDocx">üìù Ulo≈æit jako DOCX</button>
                    <button type="button" class="btn-secondary" onclick="previewTaskCopyMarkdown()" data-i18n="taskCopyMarkdown">üìã Kop√≠rovat Markdown</button>
                </div>
                <div>
                    <button type="button" class="btn-secondary" onclick="closeTaskPreview()" style="margin-right: 5px;" data-i18n="close">Zav≈ô√≠t</button>
                    <button type="button" class="btn-primary" onclick="previewTaskEdit()" data-i18n="edit">Upravit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Note Editor -->
    <div id="note-editor-modal" class="modal-overlay" onclick="closeNoteEditorOnOverlay(event)">
        <div class="modal" style="max-width: 800px; width: 95%;">
            <div class="modal-header">
                <h2 id="note-editor-title" data-i18n="notesNew">Nov√° pozn√°mka</h2>
                <button type="button" class="modal-close" onclick="closeNoteEditor()">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <input type="hidden" id="note-edit-id">
                
                <div class="form-grid" style="grid-template-columns: 2fr 1fr;">
                    <div class="form-group">
                        <label for="note-name" data-i18n="noteName">N√°zev</label>
                        <input type="text" id="note-name" style="width: 100%;">
                    </div>
                    <div class="form-group">
                        <label for="note-author" data-i18n="noteAuthor">Autor</label>
                        <input type="text" id="note-author">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="note-tags" data-i18n="tags">P≈ô√≠znaky (oddƒõlen√© ƒç√°rkou)</label>
                    <input type="text" id="note-tags" style="width: 100%;" placeholder="tag1, tag2, tag3...">
                </div>
                
                <div class="form-group">
                    <label for="note-content" data-i18n="noteContent">Obsah</label>
                    <textarea id="note-content" rows="12" style="width: 100%; font-family: monospace;" placeholder="Obsah pozn√°mky (podporuje Markdown)..." data-i18n-placeholder="noteContentPlaceholder"></textarea>
                </div>
                
                <fieldset style="margin-top: 15px; border: 1px solid #ddd; border-radius: 4px; padding: 15px;">
                    <legend style="font-weight: bold;" data-i18n="linkedItems">Propojen√© polo≈æky</legend>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label for="note-linked-elements" data-i18n="linkedElements">Propojen√© prvky</label>
                            <input type="text" id="note-linked-elements-filter" placeholder="Filtrovat..." oninput="filterSelectOptions('note-linked-elements', this.value)" style="margin-bottom: 4px; padding: 4px 8px; font-size: 12px;">
                            <select id="note-linked-elements" multiple size="5" style="width: 100%;"></select>
                        </div>
                        <div class="form-group">
                            <label for="note-linked-relationships" data-i18n="linkedRelationships">Propojen√© vazby</label>
                            <input type="text" id="note-linked-relationships-filter" placeholder="Filtrovat..." oninput="filterSelectOptions('note-linked-relationships', this.value)" style="margin-bottom: 4px; padding: 4px 8px; font-size: 12px;">
                            <select id="note-linked-relationships" multiple size="5" style="width: 100%;"></select>
                        </div>
                    </div>
                    <small style="color: #666;" data-i18n="linkedItemsHelp">Dr≈æte Ctrl/Cmd pro v√Ωbƒõr v√≠ce polo≈æek</small>
                </fieldset>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeNoteEditor()" data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn-primary" onclick="saveNote()" data-i18n="save">Ulo≈æit</button>
            </div>
        </div>
    </div>

    <!-- Modal: Note Preview -->
    <div id="note-preview-modal" class="modal-overlay" onclick="closeNotePreviewOnOverlay(event)">
        <div class="modal" style="max-width: 800px; width: 95%;">
            <div class="modal-header">
                <h2 id="note-preview-title" data-i18n="notePreview">N√°hled pozn√°mky</h2>
                <button type="button" class="modal-close" onclick="closeNotePreview()">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div id="note-preview-meta" style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 4px;"></div>
                <div id="note-preview-linked" style="margin-bottom: 15px; display: none;"></div>
                <div id="note-preview-content" class="markdown-content" style="line-height: 1.6;"></div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between;">
                <div>
                    <button type="button" class="btn-secondary" onclick="openNoteVersions()" data-i18n="noteShowVersions">üìú Historie verz√≠</button>
                    <button type="button" class="btn-secondary" onclick="copyNoteContent()" style="margin-left: 5px;" data-i18n="copyContent">üìã Kop√≠rovat</button>
                </div>
                <div>
                    <button type="button" class="btn-secondary" onclick="closeNotePreview()" style="margin-right: 5px;" data-i18n="close">Zav≈ô√≠t</button>
                    <button type="button" class="btn-primary" onclick="previewNoteEdit()" data-i18n="edit">Upravit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Note Versions -->
    <div id="note-versions-modal" class="modal-overlay" onclick="closeNoteVersionsOnOverlay(event)">
        <div class="modal" style="max-width: 900px; width: 95%;">
            <div class="modal-header">
                <h2 id="note-versions-title" data-i18n="noteVersions">Historie verz√≠</h2>
                <button type="button" class="modal-close" onclick="closeNoteVersions()">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div style="display: flex; gap: 20px;">
                    <div id="note-versions-list" style="flex: 0 0 250px; border-right: 1px solid #ddd; padding-right: 15px; max-height: 60vh; overflow-y: auto;"></div>
                    <div id="note-version-preview" style="flex: 1; overflow-y: auto;">
                        <div id="note-version-meta" style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 4px;"></div>
                        <div id="note-version-content" class="markdown-content" style="line-height: 1.6;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeNoteVersions()" data-i18n="close">Zav≈ô√≠t</button>
                <button type="button" class="btn-primary" id="note-restore-btn" onclick="restoreNoteVersion()" style="display: none;" data-i18n="noteRestoreVersion">Obnovit tuto verzi</button>
            </div>
        </div>
    </div>
    <div id="bulk-tag-modal" class="modal-overlay" onclick="closeBulkTagModalOnOverlay(event)">
        <div class="modal">
            <div class="modal-header">
                <h2 data-i18n="bulkTagManagement">Hromadn√° spr√°va p≈ô√≠znak≈Ø</h2>
                <button type="button" class="modal-close" onclick="closeBulkTagModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label for="bulk-tag-source" data-i18n="sourceData">Zdroj:</label>
                        <select id="bulk-tag-source" onchange="renderBulkTagList()">
                            <option value="elements" data-i18n="elements">Prvky</option>
                            <option value="relationships" data-i18n="relationships">Vazby</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bulk-tag-action" data-i18n="action">Akce:</label>
                        <select id="bulk-tag-action" onchange="renderBulkTagList()">
                            <option value="add" data-i18n="addTag">P≈ôidat p≈ô√≠znak</option>
                            <option value="remove" data-i18n="removeTag">Odebrat p≈ô√≠znak</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bulk-tag-value" data-i18n="tag">P≈ô√≠znak:</label>
                        <input type="text" id="bulk-tag-value" data-i18n-placeholder="enterTag" placeholder="Zadejte p≈ô√≠znak..." list="p≈ô√≠znaky-suggestions" oninput="renderBulkTagList()">
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong><span data-i18n="selectItems">Vyberte polo≈æky</span> (<span id="bulk-tag-selected-count">0</span> <span data-i18n="selected">vybr√°no</span>):</strong>
                    <div>
                        <button type="button" class="btn-secondary" onclick="bulkTagSelectAll(true)" style="margin-right: 5px;" data-i18n="selectAll">‚òë Vybrat v≈°e</button>
                        <button type="button" class="btn-secondary" onclick="bulkTagSelectAll(false)" style="margin-right: 5px;" data-i18n="deselectAll">‚òê Odebrat v≈°e</button>
                        <button type="button" class="btn-secondary" onclick="bulkTagSelectFiltered()" data-i18n-title="selectFilteredTitle" title="Vybrat pouze polo≈æky odpov√≠daj√≠c√≠ aktu√°ln√≠m filtr≈Øm" data-i18n="selectFiltered">üîç Vybrat filtrovan√©</button>
                    </div>
                </div>
                
                <div id="bulk-tag-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background: #fafafa;">
                    <p style="color: #666;" data-i18n="enterTagFirst">Nejprve zadejte p≈ô√≠znak...</p>
                </div>
                
                <div id="bulk-tag-result" style="display:none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeBulkTagModal()" data-i18n="close">Zav≈ô√≠t</button>
                <button type="button" class="btn-primary" onclick="executeBulkTagAction()" data-i18n="executeAction">Prov√©st akci</button>
            </div>
        </div>
    </div>

    <script>
    // ============================================
    // Internationalization (i18n)
    // ============================================
    
    let currentLanguage = 'cs';
    
    const TRANSLATIONS = {
        cs: {
            // App
            appTitle: 'ArchiMate 3.2 Editor',
            newModel: 'Nov√Ω ArchiMate Model',
            version: 'Verze',
            
            // Stats
            elementsCount: 'Prvk≈Ø',
            relationshipsCount: 'Vazeb',
            diagramsCount: 'Diagram≈Ø',
            layersCount: 'Vrstev',
            
            // Tabs
            tabModel: 'Model',
            tabElements: 'Prvky',
            tabRelationships: 'Vazby',
            tabDiagrams: 'Diagramy',
            tabReference: 'Reference',
            tabExport: 'Export / Import',
            tabTools: 'N√°stroje',
            
            // Model tab
            modelMetadata: 'Metadata modelu',
            basicInfo: 'Z√°kladn√≠ informace',
            modelId: 'ID modelu',
            modelName: 'N√°zev modelu',
            modelVersion: 'Verze',
            documentation: 'Dokumentace',
            modelDescription: 'Popis modelu',
            modelProperties: 'Vlastnosti modelu',
            addProperty: 'P≈ôidat vlastnost',
            propertyName: 'N√°zev vlastnosti',
            propertyValue: 'Hodnota',
            actions: 'Akce',
            delete: 'Smazat',
            
            // Elements tab
            newElement: 'Nov√Ω prvek',
            editElement: 'Editace prvku',
            elementId: 'ID prvku',
            layer: 'Vrstva',
            selectLayer: '-- Vyberte vrstvu --',
            elementType: 'Typ prvku',
            selectTypeFirst: '-- Nejd≈ô√≠ve vyberte vrstvu --',
            selectType: '-- Vyberte typ prvku --',
            stereotype: 'Stereotyp',
            elementName: 'N√°zev prvku',
            determines: 'Urƒçuje',
            tags: 'P≈ô√≠znaky',
            description: 'Popis',
            save: 'Ulo≈æit',
            clearForm: 'Vyƒçistit formul√°≈ô',
            
            // Elements table
            elementsList: 'Seznam prvk≈Ø',
            filterByLayer: 'Filtr podle vrstvy',
            allLayers: 'V≈°echny vrstvy',
            filterByType: 'Filtr podle typu',
            allTypes: 'V≈°echny typy',
            filterByStereotype: 'Filtr podle stereotypu',
            allStereotypes: 'V≈°echny stereotypy',
            noStereotype: '(bez stereotypu)',
            filterByTag: 'Filtr podle p≈ô√≠znaku',
            allTags: 'V≈°echny p≈ô√≠znaky',
            allDiagrams: 'V≈°echny diagramy',
            noTags: '(bez p≈ô√≠znaku)',
            search: 'Hledat',
            searchPlaceholder: 'ID, n√°zev, stereotyp, p≈ô√≠znaky...',
            clearFilters: 'Zru≈°it filtry',
            columns: 'Sloupce',
            id: 'ID',
            name: 'N√°zev',
            type: 'Typ',
            diagrams: 'Diagramy',
            edit: 'Upravit',
            duplicate: 'Duplikovat',
            noElements: '≈Ω√°dn√© prvky. P≈ôidejte prvn√≠ prvek pomoc√≠ formul√°≈ôe v√Ω≈°e.',
            elementCopy: 'Nov√Ω prvek (kopie)',
            
            // Filter info
            filterActive: 'Filtr aktivn√≠',
            showingOf: 'Zobrazeno {0} z {1}',
            
            // Relationships tab
            newRelationship: 'Nov√° vazba',
            editRelationship: 'Editace vazby',
            relationshipId: 'ID vazby',
            generateId: 'Generovat ID vazby',
            sourceElement: 'Zdrojov√Ω prvek',
            targetElement: 'C√≠lov√Ω prvek',
            selectElement: '-- Prvek --',
            relationshipType: 'Typ vazby',
            selectElements: '-- Vyberte prvky --',
            selectRelType: '-- Vyberte typ --',
            relationshipName: 'N√°zev vazby',
            statementPreview: 'N√°hled statement',
            
            // Relationships table
            relationshipsList: 'Seznam vazeb',
            source: 'Zdroj',
            target: 'C√≠l',
            statement: 'Statement',
            searchRelPlaceholder: 'Zdroj, c√≠l, p≈ô√≠znaky, statement...',
            allNames: 'V≈°echny n√°zvy',
            unnamed: '(bez n√°zvu)',
            allSources: 'V≈°echny zdroje',
            allTargets: 'V≈°echny c√≠le',
            noRelationships: '≈Ω√°dn√© vazby. P≈ôidejte prvn√≠ vazbu pomoc√≠ formul√°≈ôe v√Ω≈°e.',
            relationshipCopy: 'Nov√° vazba (kopie)',
            
            // Diagrams tab
            newDiagram: 'Nov√Ω diagram',
            editDiagram: 'Editace diagramu',
            diagramId: 'ID diagramu',
            diagramName: 'N√°zev diagramu',
            diagramElements: 'Prvky v diagramu',
            selectAll: 'Vybrat v≈°e',
            deselectAll: 'Odebrat v≈°e',
            selectedElements: 'Vybran√Ωch prvk≈Ø',
            diagramSettings: 'Nastaven√≠',
            diagramDescription: 'Popis diagramu',
            
            // Diagrams table
            diagramsList: 'Seznam diagram≈Ø',
            elementsInDiagram: 'Prvk≈Ø',
            noDiagrams: '≈Ω√°dn√© diagramy. P≈ôidejte prvn√≠ diagram pomoc√≠ formul√°≈ôe v√Ω≈°e.',
            
            // Diagram preview
            diagramPreview: 'N√°hled diagramu',
            downloadSvg: 'St√°hnout SVG',
            selectDiagram: 'Vyberte diagram',
            
            // Reference tab
            archimateLayers: 'ArchiMate vrstvy a typy prvk≈Ø',
            relationshipTypes: 'Typy vazeb',
            
            // Export/Import tab
            exportJson: 'Export AJX',
            downloadJson: 'St√°hnout AJX',
            copyJsonClipboard: 'üìã Zkop√≠rovat AJX',
            exportXml: 'Export XML (ArchiMate Open Exchange)',
            downloadXml: 'St√°hnout XML',
            exportByTag: 'Export podle p≈ô√≠znaku',
            exportByTagDesc: 'Exportuje pouze prvky a vazby s vybran√Ωm p≈ô√≠znakem.',
            exportAjxByTag: 'Export AJX',
            exportXmlByTag: 'Export XML',
            exportTagStats: 'Vybran√Ω p≈ô√≠znak: {0} prvk≈Ø, {1} vazeb',
            noTagSelected: 'Vyberte p≈ô√≠znak pro export.',
            noItemsWithTag: '≈Ω√°dn√© polo≈æky s t√≠mto p≈ô√≠znakem.',
            importJson: 'Import AJX',
            importXml: 'Import XML (ArchiMate Open Exchange)',
            selectFile: 'Vyberte soubor',
            import: 'Importovat',
            mergeModels: 'Slouƒçit s jin√Ωm modelem',
            mergeStrategy: 'Strategie slouƒçen√≠',
            keepExisting: 'Ponechat st√°vaj√≠c√≠',
            overwriteNew: 'P≈ôepsat nov√Ωmi',
            manualSelect: 'Ruƒçnƒõ vybrat',
            mergeSelectFile: 'Vyberte soubor ke slouƒçen√≠ (AJX nebo XML)',
            merge: 'Slouƒçit modely',
            selectElementsToImport: 'Vyberte prvky k importu',
            selectRelationshipsToImport: 'Vyberte vazby k importu',
            relImportNote: 'P≈ôi v√Ωbƒõru vazby se automaticky vyberou i jej√≠ zdrojov√Ω a c√≠lov√Ω prvek.',
            selectDiagramsToImport: 'Vyberte diagramy k importu',
            diagImportNote: 'P≈ôi v√Ωbƒõru diagramu se automaticky vyberou i jeho prvky a jejich vazby.',
            diagSelectedCount: 'diagram≈Ø vybr√°no',
            diagToImport: 'diagram≈Ø k importu',
            
            // Notes translations
            tasksTab: '√ökoly',
            notesTab: 'Pozn√°mky',
            notesTitle: 'Pozn√°mky',
            notesNew: '+ Nov√° pozn√°mka',
            noteName: 'N√°zev',
            noteAuthor: 'Autor',
            noteContent: 'Obsah',
            noteUpdated: 'Posledn√≠ √∫prava',
            noteNoRecords: 'Zat√≠m nejsou vytvo≈ôeny ≈æ√°dn√© pozn√°mky.',
            
            // Tasks
            tasksTitle: '√ökoly',
            tasksNew: '+ Nov√Ω √∫kol',
            tasksExportAll: 'üì¶ Exportovat v≈°echny √∫koly',
            taskNumber: '#',
            taskTitleLabel: 'N√°zev',
            taskStatus: 'Stav',
            taskPriority: 'Priorita',
            taskAssignee: '≈òe≈°itel',
            taskReporter: 'Zadavatel',
            taskDueDate: 'Term√≠n',
            taskDescription: 'Popis √∫kolu',
            taskDescriptionPlaceholder: 'Detailn√≠ popis √∫kolu (podporuje Markdown)...',
            taskCurrentState: 'Aktu√°ln√≠ stav / Pozn√°mky k ≈ôe≈°en√≠',
            taskCurrentStatePlaceholder: 'Popis aktu√°ln√≠ho stavu ≈ôe≈°en√≠...',
            taskStatusHistory: 'Historie stav≈Ø',
            taskPreview: 'N√°hled √∫kolu',
            taskSaveMarkdown: 'üìÑ Ulo≈æit jako Markdown',
            taskCopyMarkdown: 'üìã Kop√≠rovat Markdown',
            taskSaveDocx: 'üìù Ulo≈æit jako DOCX',
            taskNoRecords: 'Zat√≠m nejsou vytvo≈ôeny ≈æ√°dn√© √∫koly.',
            taskFilterAllStatuses: 'V≈°echny stavy',
            taskFilterAllPriorities: 'V≈°echny priority',
            taskFilterAllAssignees: 'V≈°ichni ≈ôe≈°itel√©',
            taskStatusNew: 'Nov√Ω',
            taskStatusInProgress: 'Prob√≠h√°',
            taskStatusBlocked: 'Blokov√°no',
            taskStatusReview: 'Ke kontrole',
            taskStatusDone: 'Hotovo',
            taskStatusCancelled: 'Zru≈°eno',
            taskPriorityLow: 'N√≠zk√°',
            taskPriorityMedium: 'St≈ôedn√≠',
            taskPriorityHigh: 'Vysok√°',
            taskPriorityCritical: 'Kritick√°',
            taskCreated: 'Vytvo≈ôeno',
            taskUpdated: 'Aktualizov√°no',
            taskConfirmDelete: 'Opravdu chcete smazat tento √∫kol?',
            taskOverdue: 'Po term√≠nu',
            noteConfirmDelete: 'Opravdu chcete smazat tuto pozn√°mku vƒçetnƒõ v≈°ech jej√≠ch verz√≠?',
            notePreview: 'N√°hled pozn√°mky',
            noteVersions: 'Historie verz√≠',
            noteVersion: 'Verze',
            noteCurrentVersion: 'Aktu√°ln√≠ verze',
            noteRestoreVersion: 'Obnovit tuto verzi',
            noteVersionRestored: 'Verze byla obnovena',
            noteContentPlaceholder: 'Obsah pozn√°mky (podporuje Markdown)...',
            noteShowVersions: 'üìú Historie verz√≠',
            linkedItems: 'Propojen√© polo≈æky',
            linkedElements: 'Propojen√© prvky',
            linkedRelationships: 'Propojen√© vazby',
            linkedItemsHelp: 'Dr≈æte Ctrl/Cmd pro v√Ωbƒõr v√≠ce polo≈æek',
            copyContent: 'üìã Kop√≠rovat',
            contentCopied: 'Obsah zkop√≠rov√°n do schr√°nky',
            
            // ADR translations
            adrTab: 'ADR',
            adrTitle: 'Architektonick√° rozhodnut√≠ (ADR)',
            adrNew: '+ Nov√© ADR',
            adrNumber: '#',
            adrTitleLabel: 'N√°zev',
            adrStatus: 'Stav',
            adrAuthor: 'Autor',
            adrCreated: 'Vytvo≈ôeno',
            adrUpdated: 'Aktualizov√°no',
            adrApprover: 'Schvalovatel',
            adrDeciders: 'Rozhodovatel√©',
            adrContext: 'Kontext',
            adrDecision: 'Rozhodnut√≠',
            adrConsequences: 'D≈Øsledky',
            adrConsequencesPlaceholder: 'Popi≈°te d≈Øsledky tohoto rozhodnut√≠...',
            adrPositive: 'Pozitivn√≠',
            adrNegative: 'Negativn√≠',
            adrNeutral: 'Neutr√°ln√≠',
            adrSelectedAlternative: 'Vybran√° varianta',
            adrSelectionReason: 'Od≈Øvodnƒõn√≠ v√Ωbƒõru',
            adrSelectionReasonPlaceholder: 'Proƒç byla tato varianta vybr√°na...',
            adrMarkAsSelected: 'Oznaƒçit jako vybranou',
            adrSelected: 'VYBRAN√Å',
            adrPreview: 'N√°hled ADR',
            adrAlternatives: 'Zva≈æovan√© alternativy',
            adrAlternative: 'Varianta',
            adrAlternativeTitle: 'N√°zev alternativy',
            adrAlternativeDesc: 'Popis',
            adrRejectedReason: 'D≈Øvod zam√≠tnut√≠',
            adrImplementation: 'Implementace',
            adrImplStatus: 'Stav implementace',
            adrImplStartDate: 'Datum zah√°jen√≠',
            adrImplTargetDate: 'C√≠lov√© datum',
            adrImplNotes: 'Pozn√°mky k implementaci',
            adrRelatedAdr: 'Souvisej√≠c√≠ ADR',
            adrSupersedes: 'Nahrazuje',
            adrSupersededBy: 'Nahrazeno',
            adrRelatedTo: 'Souvis√≠ s',
            adrTags: 'Tagy',
            adrLinks: 'Odkazy',
            adrLinkTitle: 'N√°zev odkazu',
            adrLinkUrl: 'URL',
            adrStatusHistory: 'Historie stav≈Ø',
            adrAddAlternative: '+ P≈ôidat alternativu',
            adrAddLink: '+ P≈ôidat odkaz',
            adrAddConsequence: '+ P≈ôidat',
            adrSaveMarkdown: 'üìÑ Ulo≈æit jako Markdown',
            adrCopyMarkdown: 'üìã Kop√≠rovat Markdown',
            adrSaveDocx: 'üìù Ulo≈æit jako DOCX',
            
            // Bulk operations
            selected: 'Vybr√°no',
            clearSelection: 'Zru≈°it v√Ωbƒõr',
            selectAction: '-- Vyberte akci --',
            changeType: 'Zmƒõnit typ',
            changeStereotype: 'Zmƒõnit stereotyp',
            changeDetermines: 'Zmƒõnit urƒçuje',
            changeDescription: 'Zmƒõnit popis',
            addTags: 'P≈ôidat p≈ô√≠znaky',
            deleteSelected: 'Smazat vybran√©',
            changeRelType: 'Zmƒõnit typ vazby',
            changeSource: 'Zmƒõnit zdroj',
            changeTarget: 'Zmƒõnit c√≠l',
            changeName: 'Zmƒõnit n√°zev',
            execute: 'Prov√©st',
            bulkSelectType: 'Vyberte nov√Ω typ:',
            bulkEnterValue: 'Zadejte hodnotu:',
            bulkEnterTags: 'Zadejte p≈ô√≠znaky (oddƒõlen√© ƒç√°rkou):',
            bulkSelectElement: 'Vyberte prvek:',
            confirmBulkDelete: 'Opravdu chcete smazat {0} vybran√Ωch polo≈æek?',
            bulkDeleteWarning: 'U prvk≈Ø budou smaz√°ny i v≈°echny souvisej√≠c√≠ vazby.',
            bulkUpdated: 'Aktualizov√°no {0} polo≈æek.',
            bulkDeleted: 'Smaz√°no {0} polo≈æek.',
            bulkDuplicateWarning: 'Nƒõkter√© vazby by vytvo≈ôily duplicity a budou p≈ôeskoƒçeny.',
            noDuplicatesAllowed: 'Zmƒõna by vytvo≈ôila duplicitn√≠ vazby. Operace zru≈°ena.',
            adrExportAll: 'üì¶ Exportovat v≈°echny ADR',
            adrNoRecords: 'Zat√≠m nejsou vytvo≈ôena ≈æ√°dn√° ADR.',
            adrConfirmDelete: 'Opravdu chcete smazat toto ADR?',
            adrMarkdownCopied: 'Markdown zkop√≠rov√°n do schr√°nky',
            adrBasicInfo: 'Z√°kladn√≠ informace',
            adrFilterAll: 'V≈°echny stavy',
            
            // ADR statuses
            adrStatusDraft: 'Rozpracov√°no',
            adrStatusProposed: 'Navr≈æeno',
            adrStatusAccepted: 'Schv√°leno',
            adrStatusRejected: 'Zam√≠tnuto',
            adrStatusImplemented: 'Implementov√°no',
            adrStatusDeprecated: 'Zastaral√©',
            adrStatusSuperseded: 'Nahrazeno',
            adrStatusUnderDiscussion: 'Projedn√°v√°no',
            adrStatusReturned: 'Vr√°ceno',
            adrStatusUpdated: 'Aktualizov√°no',
            adrStatusMonitored: 'Sledov√°no',
            adrStatusClosed: 'Uzav≈ôeno',
            
            // ADR implementation statuses
            adrImplNotStarted: 'Nezah√°jeno',
            adrImplInProgress: 'Prob√≠h√°',
            adrImplCompleted: 'Dokonƒçeno',
            generatedFrom: 'Vygenerov√°no z',
            statistics: 'Statistiky',
            total: 'Celkem',
            date: 'Datum',
            separateByComma: 'Oddƒõlte ƒç√°rkou...',
            adrContextPlaceholder: 'Popi≈°te kontext a d≈Øvody pro toto rozhodnut√≠...',
            adrDecisionPlaceholder: 'Popi≈°te rozhodnut√≠, kter√© bylo uƒçinƒõno...',
            existsWarning: 'existuje',
            newItem: 'nov√Ω',
            selectedToImport: 'Vybr√°no k importu',
            relWillImport: 'vazeb se importuje',
            diagWillImport: 'diagram≈Ø se importuje',
            relSelectedCount: 'vazeb vybr√°no',
            searchPlaceholder: 'Hledat...',
            searchResults: 'Nalezeno',
            itemsVisible: 'polo≈æek viditeln√Ωch',
            
            // Tools tab
            tagManagement: 'Spr√°va p≈ô√≠znak≈Ø',
            selectTag: 'Vyberte p≈ô√≠znak',
            selectTagPlaceholder: '-- Vyberte p≈ô√≠znak --',
            removeFrom: 'Odstranit z',
            removeFromElements: 'Odstranit z prvk≈Ø',
            removeFromRelationships: 'Odstranit z vazeb',
            deleteEverywhere: 'Smazat odev≈°ud',
            replaceWithTag: 'Nahradit p≈ô√≠znakem',
            newTagPlaceholder: 'Nov√Ω p≈ô√≠znak...',
            replaceIn: 'Nahradit ve',
            replaceInElements: 'Nahradit v prvc√≠ch',
            replaceInRelationships: 'Nahradit ve vazb√°ch',
            replaceEverywhere: 'Nahradit v≈°ude',
            
            bulkTagManagement: 'Hromadn√° spr√°va p≈ô√≠znak≈Ø',
            bulkTagDesc: 'P≈ôid√°n√≠ nebo odebr√°n√≠ p≈ô√≠znaku z vybran√Ωch prvk≈Ø nebo vazeb.',
            openBulkManagement: 'Otev≈ô√≠t hromadnou spr√°vu',
            sourceData: 'Zdroj',
            elements: 'Prvky',
            relationships: 'Vazby',
            action: 'Akce',
            addTag: 'P≈ôidat p≈ô√≠znak',
            removeTag: 'Odebrat p≈ô√≠znak',
            tag: 'P≈ô√≠znak',
            enterTag: 'Zadejte p≈ô√≠znak...',
            selectItems: 'Vyberte polo≈æky',
            selected: 'vybr√°no',
            selectFiltered: 'üîç Vybrat filtrovan√©',
            enterTagFirst: 'Nejprve zadejte p≈ô√≠znak...',
            allHaveTag: 'V≈°echny {0} u≈æ maj√≠ p≈ô√≠znak "{1}".',
            noneHaveTag: '≈Ω√°dn√Ω {0} nem√° p≈ô√≠znak "{1}".',
            executeAction: 'Prov√©st akci',
            close: 'Zav≈ô√≠t',
            
            textGenerator: 'Gener√°tor textu',
            textGeneratorDesc: 'Generuje text z aktu√°lnƒõ zobrazen√Ωch (filtrovan√Ωch) prvk≈Ø nebo vazeb podle zadan√© ≈°ablony.',
            currentElements: 'Aktu√°ln√≠ seznam prvk≈Ø',
            currentRelationships: 'Aktu√°ln√≠ seznam vazeb',
            currentTasks: 'Aktu√°ln√≠ seznam √∫kol≈Ø',
            currentNotes: 'Aktu√°ln√≠ seznam pozn√°mek',
            currentAdr: 'Aktu√°ln√≠ seznam ADR',
            availablePlaceholders: 'Dostupn√© placeholdery',
            templateLabel: '≈†ablona (pro ka≈æd√Ω ≈ô√°dek)',
            templatePlaceholder: 'Nap≈ô.: {Stereotyp} {N√°zev} je typu {Typ}\n\nKliknut√≠m na placeholder ho vlo≈æ√≠te na pozici kurzoru.',
            skipEmpty: 'P≈ôeskoƒçit polo≈æky kde jsou pr√°zdn√© pou≈æit√© placeholdery',
            generate: 'Generovat',
            copyResult: 'üìã Zkop√≠rovat v√Ωsledek',
            clear: 'Vymazat',
            result: 'V√Ωsledek',
            items: 'polo≈æek',
            
            // Confirmations and alerts
            confirmDelete: 'Opravdu chcete smazat',
            confirmDeleteElement: 'Opravdu chcete smazat prvek "{0}"?\n\nToto tak√© sma≈æe v≈°echny vazby obsahuj√≠c√≠ tento prvek a odebere ho ze v≈°ech diagram≈Ø.',
            confirmDeleteRelationship: 'Opravdu chcete smazat tuto vazbu?',
            confirmDeleteDiagram: 'Opravdu chcete smazat diagram "{0}"?',
            confirmClearModel: 'Opravdu chcete vymazat cel√Ω model? Tato akce je nevratn√°.',
            alertFillRequired: 'Vypl≈àte pros√≠m',
            alertIdExists: 'ji≈æ existuje. Pou≈æijte jin√© ID.',
            alertSelectElements: 'Vyberte alespo≈à jednu polo≈æku.',
            alertEnterTag: 'Zadejte p≈ô√≠znak.',
            alertCopied: 'Zkop√≠rov√°no do schr√°nky!',
            alertNothingToCopy: 'Nen√≠ co kop√≠rovat.',
            alertEnterTemplate: 'Zadejte ≈°ablonu pro generov√°n√≠.',
            alertSelectTag: 'Vyberte p≈ô√≠znak.',
            alertEnterNewTag: 'Zadejte nov√Ω p≈ô√≠znak.',
            
            // Success messages
            successTagRemoved: '‚úÖ P≈ô√≠znak "{0}" odstranƒõn {1}',
            successTagReplaced: '‚úÖ P≈ô√≠znak "{0}" nahrazen "{1}" {2}',
            successTagAdded: '‚úÖ P≈ô√≠znak "{0}" p≈ôid√°n k {1} {2}',
            successTagRemovedFrom: '‚úÖ P≈ô√≠znak "{0}" odebr√°n z {1} {2}',
            fromElements: 'z prvk≈Ø',
            fromRelationships: 'z vazeb',
            fromEverywhere: 'odev≈°ud',
            inElements: 'v prvc√≠ch',
            inRelationships: 've vazb√°ch',
            everywhere: 'v≈°ude',
            modifiedElements: 'Upraveno prvk≈Ø',
            modifiedRelationships: 'vazeb',
            
            // Relationship group
            relGroupVazba: 'Vazba',
            relGroupZdroj: 'Zdroj',
            relGroupCil: 'C√≠l',
            
            // Misc
            enterNewId: 'Zadejte nov√© ID...',
            element: 'prvek',
            relationship: 'vazba',
            and: 'a',
            
            // Additional Model tab
            dcDescription: 'Standardn√≠ metadata pro popis a vyhled√°v√°n√≠ modelu.',
            dcCreator: 'Autor (dc:creator)',
            dcPublisher: 'Vydavatel (dc:publisher)',
            dcDate: 'Datum (dc:date)',
            dcLanguage: 'Jazyk (dc:language)',
            dcRights: 'Pr√°va (dc:rights)',
            dcSubject: 'P≈ôedmƒõt (dc:subject)',
            dcDescriptionLabel: 'Popis (dc:description)',
            customProperties: 'Custom Properties',
            customPropertiesDesc: 'P≈ôidejte vlastn√≠ kl√≠ƒç-hodnota vlastnosti modelu.',
            keyPlaceholder: 'Kl√≠ƒç',
            valuePlaceholder: 'Hodnota',
            add: 'P≈ôidat',
            saveMetadata: 'Ulo≈æit metadata',
            reset: 'Resetovat',
            modelNamePlaceholder: 'N√°zev va≈°eho ArchiMate modelu',
            documentationPlaceholder: '√öƒçel a popis modelu...',
            authorPlaceholder: 'Jm√©no autora',
            organizationPlaceholder: 'Organizace',
            rightsPlaceholder: '¬© 2025 Va≈°e organizace',
            keywordsPlaceholder: 'Kl√≠ƒçov√° slova',
            dcDescriptionPlaceholder: 'Podrobn√Ω popis modelu pro katalogizaci...',
            
            // Additional Relationships
            relationshipNameOptional: 'N√°zev vazby (voliteln√©)',
            relNamePlaceholder: 'nap≈ô. p≈ôen√°≈°√≠ data',
            relDescriptionOptional: 'Popis vazby (voliteln√©)',
            relDescriptionPlaceholder: 'Popis vazby',
            tagsPlaceholder: 'nap≈ô. ‚úÖ schv√°leno, üöß rozpracov√°no',
            saveRelationship: 'Ulo≈æit vazbu',
            
            // Additional Diagrams
            relationshipsInDiagram: 'Poƒçet vazeb',
            diagramNamePlaceholder: 'nap≈ô. Application Architecture',
            optionalDescription: 'Voliteln√Ω popis diagramu',
            createDiagram: 'Vytvo≈ôit diagram',
            backToList: '‚Üê Zpƒõt na seznam',
            settings: 'Nastaven√≠',
            preview: 'N√°hled',
            diagramNamePlaceholder2: 'N√°zev diagramu',
            elementLayout: 'Rozlo≈æen√≠ prvk≈Ø',
            byLayers: 'Po vrstv√°ch',
            grid: 'M≈ô√≠≈æka',
            elementsOnDiagram: 'Prvky na diagramu',
            addElementToDiagram: 'P≈ôidat prvek na diagram',
            relationshipsOnDiagram: 'Vazby na diagramu',
            relationshipsOnDiagramDesc: 'Zobrazuj√≠ se pouze vazby mezi prvky, kter√© jsou oba p≈ô√≠tomny na diagramu.',
            diagramNoElements: 'Diagram neobsahuje ≈æ√°dn√© prvky',
            diagramNoRelationships: 'Na diagramu nejsou ≈æ√°dn√© vazby',
            redraw: 'P≈ôekreslit',
            addElementsForPreview: 'P≈ôidejte prvky na diagram pro zobrazen√≠ n√°hledu.',
            
            // Additional Reference
            archimateReference: 'ArchiMate 3.2 Reference',
            layersAndTypes: 'Vrstvy a typy prvk≈Ø',
            category: 'Kategorie',
            notation: 'Notace',
            
            // Additional Export/Import
            export: 'Export',
            exportCsv: 'Export CSV',
            dataPreview: 'N√°hled dat',
            selectExportPreview: 'Vyberte export pro n√°hled...',
            dragFileHere: 'P≈ôet√°hnƒõte soubor sem',
            or: 'nebo',
            supportedFormats: 'Podporovan√© form√°ty: AJX, ArchiMate XML',
            pasteDataManually: 'Nebo vlo≈æte data ruƒçnƒõ:',
            deleteAll: 'Smazat v≈°e',
            mergeDescription: 'Importuje prvky, vazby a diagramy z jin√©ho modelu do aktu√°ln√≠ho. K novƒõ p≈ôidan√Ωm polo≈æk√°m se p≈ôid√° p≈ô√≠znak s n√°zvem zdrojov√©ho modelu.',
            onIdCollision: 'P≈ôi kolizi ID',
            fileToMerge: 'Soubor ke slouƒçen√≠',
            selectFileFirst: 'Nejprve vyberte soubor...',
            
            // Additional bulk tag
            selectFilteredTitle: 'Vybrat pouze polo≈æky odpov√≠daj√≠c√≠ aktu√°ln√≠m filtr≈Øm',
            
            // Additional alerts
            metadataSaved: 'Metadata modelu byla ulo≈æena.',
            enterPropertyKey: 'Zadejte kl√≠ƒç vlastnosti.',
            fillElementRequired: 'Vypl≈àte pros√≠m ID, vrstvu, typ a n√°zev prvku.',
            elementIdExists: 'Prvek s ID "{0}" ji≈æ existuje. Pou≈æijte jin√© ID.',
            fillRelationshipRequired: 'Vypl≈àte pros√≠m zdrojov√Ω prvek, c√≠lov√Ω prvek a typ vazby.',
            relationshipExists: 'Vazba mezi tƒõmito prvky ji≈æ existuje (ID: "{0}").',
            copyFailed: 'Nepoda≈ôilo se zkop√≠rovat do schr√°nky. Pou≈æijte Ctrl+C z n√°hledu.',
            pasteDataToImport: 'Vlo≈æte pros√≠m data k importu.',
            pasteFromClipboard: 'üìã Vlo≈æit ze schr√°nky',
            pasteManuallyTitle: 'Vlo≈æit ze schr√°nky',
            pasteManuallyDesc: 'Automatick√© vlo≈æen√≠ nen√≠ na tomto za≈ô√≠zen√≠ k dispozici. Vlo≈æte obsah ruƒçnƒõ (Ctrl+V nebo dlouh√Ω stisk):',
            pasteAndLoad: 'Vlo≈æit a naƒç√≠st',
            unrecognizedFormat: 'Nerozpoznan√Ω form√°t. Podporovan√© form√°ty: AJX, ArchiMate XML',
            alertSelectFile: 'Vyberte pros√≠m soubor ke slouƒçen√≠.',
            alertWaitForFile: 'Poƒçkejte na naƒçten√≠ souboru.',
            alertSelectAtLeastOne: 'Vyberte alespo≈à jeden prvek k importu.',
            alertEnterDiagramName: 'Zadejte pros√≠m n√°zev diagramu.',
            alertSelectElementToAdd: 'Vyberte prvek k p≈ôid√°n√≠.',
            alertDiagramEmpty: 'Nen√≠ co st√°hnout - diagram je pr√°zdn√Ω.',
            unsupportedFormat: 'Nepodporovan√Ω form√°t souboru',
            errorMerge: 'Chyba p≈ôi slouƒçen√≠',
            importedFrom: 'Importov√°no z',
            mergeSuccess: 'Slouƒçen√≠ dokonƒçeno',
            importedElements: 'Importov√°no prvk≈Ø',
            importedRelationships: 'vazeb',
            importedDiagrams: 'diagram≈Ø',
            errorImport: 'Chyba p≈ôi importu',
            modelLoaded: 'Model √∫spƒõ≈°nƒõ naƒçten',
            removed: 'Odebr√°no',
            
            // Merge statistics
            sourceModel: 'Zdroj',
            strategy: 'Strategie',
            elementsLabel: 'Prvky',
            relationshipsLabel: 'Vazby',
            diagramsLabel: 'Diagramy',
            newCount: 'nov√Ωch',
            overwrittenCount: 'p≈ôepsan√Ωch',
            skippedCount: 'p≈ôeskoƒçen√Ωch',
            manuallySelected: 'ruƒçnƒõ vybran√© prvky',
            
            // Import messages
            importSuccess: 'Import √∫spƒõ≈°n√Ω!',
            jsonParseError: 'Chyba p≈ôi parsov√°n√≠ AJX',
            xmlImportSuccess: 'Import ArchiMate XML √∫spƒõ≈°n√Ω!',
            xmlImportError: 'Chyba p≈ôi importu XML',
            modelLabel: 'Model',
            
            // Relationship info
            allowedRelationships: 'Povolen√© vazby',
            foundAllowedTypes: 'Nalezeno {0} povolen√Ωch typ≈Ø vazeb.',
            selectRelationshipType: '-- Vyberte typ vazby --',
            
            // Merge preview
            error: 'Chyba',
            totalElements: 'Celkem prvk≈Ø',
            of: 'z',
            toImport: 'k importu',
            selectedCount: 'Vybr√°no',
            elementsSmall: 'prvk≈Ø',
            relToImport: 'Vazeb k importu',
            
            // Dynamic UI texts
            noCustomProperties: '≈Ω√°dn√© vlastn√≠ vlastnosti',
            relContainingElement: 'Vazby obsahuj√≠c√≠ prvek: "{0}"',
            relWithSource: 'Vazby se zdrojem: "{0}"',
            relWithTarget: 'Vazby s c√≠lem: "{0}"',
            selectBothElements: '-- Vyberte oba prvky --',
            elementsNotFound: '-- Prvky nenalezeny --',
            selectTypeShort: '-- Typ --',
            selectElementShort: '-- Prvek --'
        },
        en: {
            // App
            appTitle: 'ArchiMate 3.2 Editor',
            newModel: 'New ArchiMate Model',
            version: 'Version',
            
            // Stats
            elementsCount: 'Elements',
            relationshipsCount: 'Relationships',
            diagramsCount: 'Diagrams',
            layersCount: 'Layers',
            
            // Tabs
            tabModel: 'Model',
            tabElements: 'Elements',
            tabRelationships: 'Relationships',
            tabDiagrams: 'Diagrams',
            tabReference: 'Reference',
            tabExport: 'Export / Import',
            tabTools: 'Tools',
            
            // Model tab
            modelMetadata: 'Model Metadata',
            basicInfo: 'Basic Information',
            modelId: 'Model ID',
            modelName: 'Model Name',
            modelVersion: 'Version',
            documentation: 'Documentation',
            modelDescription: 'Model Description',
            modelProperties: 'Model Properties',
            addProperty: 'Add Property',
            propertyName: 'Property Name',
            propertyValue: 'Value',
            actions: 'Actions',
            delete: 'Delete',
            
            // Elements tab
            newElement: 'New Element',
            editElement: 'Edit Element',
            elementId: 'Element ID',
            layer: 'Layer',
            selectLayer: '-- Select layer --',
            elementType: 'Element Type',
            selectTypeFirst: '-- Select layer first --',
            selectType: '-- Select element type --',
            stereotype: 'Stereotype',
            elementName: 'Element Name',
            determines: 'Determines',
            tags: 'Tags',
            description: 'Description',
            save: 'Save',
            clearForm: 'Clear Form',
            
            // Elements table
            elementsList: 'Elements List',
            filterByLayer: 'Filter by layer',
            allLayers: 'All layers',
            filterByType: 'Filter by type',
            allTypes: 'All types',
            filterByStereotype: 'Filter by stereotype',
            allStereotypes: 'All stereotypes',
            noStereotype: '(no stereotype)',
            filterByTag: 'Filter by tag',
            allTags: 'All tags',
            allDiagrams: 'All diagrams',
            noTags: '(no tags)',
            search: 'Search',
            searchPlaceholder: 'ID, name, stereotype, tags...',
            clearFilters: 'Clear filters',
            columns: 'Columns',
            id: 'ID',
            name: 'Name',
            type: 'Type',
            diagrams: 'Diagrams',
            edit: 'Edit',
            duplicate: 'Duplicate',
            noElements: 'No elements. Add your first element using the form above.',
            elementCopy: 'New Element (copy)',
            
            // Filter info
            filterActive: 'Filter active',
            showingOf: 'Showing {0} of {1}',
            
            // Relationships tab
            newRelationship: 'New Relationship',
            editRelationship: 'Edit Relationship',
            relationshipId: 'Relationship ID',
            generateId: 'Generate ID',
            sourceElement: 'Source Element',
            targetElement: 'Target Element',
            selectElement: '-- Element --',
            relationshipType: 'Relationship Type',
            selectElements: '-- Select elements --',
            selectRelType: '-- Select type --',
            relationshipName: 'Relationship Name',
            statementPreview: 'Statement Preview',
            
            // Relationships table
            relationshipsList: 'Relationships List',
            source: 'Source',
            target: 'Target',
            statement: 'Statement',
            searchRelPlaceholder: 'Source, target, tags, statement...',
            allNames: 'All names',
            unnamed: '(unnamed)',
            allSources: 'All sources',
            allTargets: 'All targets',
            noRelationships: 'No relationships. Add your first relationship using the form above.',
            relationshipCopy: 'New Relationship (copy)',
            
            // Diagrams tab
            newDiagram: 'New Diagram',
            editDiagram: 'Edit Diagram',
            diagramId: 'Diagram ID',
            diagramName: 'Diagram Name',
            diagramElements: 'Elements in Diagram',
            selectAll: 'Select all',
            deselectAll: 'Deselect all',
            selectedElements: 'Selected elements',
            diagramSettings: 'Settings',
            diagramDescription: 'Diagram Description',
            
            // Diagrams table
            diagramsList: 'Diagrams List',
            elementsInDiagram: 'Elements',
            noDiagrams: 'No diagrams. Add your first diagram using the form above.',
            
            // Diagram preview
            diagramPreview: 'Diagram Preview',
            downloadSvg: 'Download SVG',
            selectDiagram: 'Select diagram',
            
            // Reference tab
            archimateLayers: 'ArchiMate Layers and Element Types',
            relationshipTypes: 'Relationship Types',
            
            // Export/Import tab
            exportJson: 'Export AJX',
            downloadJson: 'Download AJX',
            copyJsonClipboard: 'üìã Copy AJX',
            exportXml: 'Export XML (ArchiMate Open Exchange)',
            downloadXml: 'Download XML',
            exportByTag: 'Export by tag',
            exportByTagDesc: 'Exports only elements and relationships with the selected tag.',
            exportAjxByTag: 'Export AJX',
            exportXmlByTag: 'Export XML',
            exportTagStats: 'Selected tag: {0} elements, {1} relationships',
            noTagSelected: 'Select a tag for export.',
            noItemsWithTag: 'No items with this tag.',
            importJson: 'Import AJX',
            importXml: 'Import XML (ArchiMate Open Exchange)',
            selectFile: 'Select file',
            import: 'Import',
            mergeModels: 'Merge with another model',
            mergeStrategy: 'Merge strategy',
            keepExisting: 'Keep existing',
            overwriteNew: 'Overwrite with new',
            manualSelect: 'Manual selection',
            mergeSelectFile: 'Select file to merge (AJX or XML)',
            merge: 'Merge Models',
            selectElementsToImport: 'Select elements to import',
            selectRelationshipsToImport: 'Select relationships to import',
            relImportNote: 'Selecting a relationship will automatically select its source and target elements.',
            selectDiagramsToImport: 'Select diagrams to import',
            diagImportNote: 'Selecting a diagram will automatically select its elements and their relationships.',
            diagSelectedCount: 'diagrams selected',
            diagToImport: 'diagrams to import',
            
            // Notes translations
            tasksTab: 'Tasks',
            notesTab: 'Notes',
            notesTitle: 'Notes',
            notesNew: '+ New Note',
            noteName: 'Name',
            noteAuthor: 'Author',
            noteContent: 'Content',
            noteUpdated: 'Last updated',
            noteNoRecords: 'No notes created yet.',
            
            // Tasks
            tasksTitle: 'Tasks',
            tasksNew: '+ New Task',
            tasksExportAll: 'üì¶ Export All Tasks',
            taskNumber: '#',
            taskTitleLabel: 'Title',
            taskStatus: 'Status',
            taskPriority: 'Priority',
            taskAssignee: 'Assignee',
            taskReporter: 'Reporter',
            taskDueDate: 'Due Date',
            taskDescription: 'Task Description',
            taskDescriptionPlaceholder: 'Detailed task description (supports Markdown)...',
            taskCurrentState: 'Current State / Resolution Notes',
            taskCurrentStatePlaceholder: 'Description of current resolution state...',
            taskStatusHistory: 'Status History',
            taskPreview: 'Task Preview',
            taskSaveMarkdown: 'üìÑ Save as Markdown',
            taskCopyMarkdown: 'üìã Copy Markdown',
            taskSaveDocx: 'üìù Save as DOCX',
            taskNoRecords: 'No tasks created yet.',
            taskFilterAllStatuses: 'All statuses',
            taskFilterAllPriorities: 'All priorities',
            taskFilterAllAssignees: 'All assignees',
            taskStatusNew: 'New',
            taskStatusInProgress: 'In Progress',
            taskStatusBlocked: 'Blocked',
            taskStatusReview: 'In Review',
            taskStatusDone: 'Done',
            taskStatusCancelled: 'Cancelled',
            taskPriorityLow: 'Low',
            taskPriorityMedium: 'Medium',
            taskPriorityHigh: 'High',
            taskPriorityCritical: 'Critical',
            taskCreated: 'Created',
            taskUpdated: 'Updated',
            taskConfirmDelete: 'Are you sure you want to delete this task?',
            taskOverdue: 'Overdue',
            noteConfirmDelete: 'Are you sure you want to delete this note including all its versions?',
            notePreview: 'Note Preview',
            noteVersions: 'Version History',
            noteVersion: 'Version',
            noteCurrentVersion: 'Current version',
            noteRestoreVersion: 'Restore this version',
            noteVersionRestored: 'Version restored',
            noteContentPlaceholder: 'Note content (supports Markdown)...',
            noteShowVersions: 'üìú Version History',
            linkedItems: 'Linked items',
            linkedElements: 'Linked elements',
            linkedRelationships: 'Linked relationships',
            linkedItemsHelp: 'Hold Ctrl/Cmd to select multiple items',
            copyContent: 'üìã Copy',
            contentCopied: 'Content copied to clipboard',
            
            // ADR translations
            adrTab: 'ADR',
            adrTitle: 'Architecture Decision Records (ADR)',
            adrNew: '+ New ADR',
            adrNumber: '#',
            adrTitleLabel: 'Title',
            adrStatus: 'Status',
            adrAuthor: 'Author',
            adrCreated: 'Created',
            adrUpdated: 'Updated',
            adrApprover: 'Approver',
            adrDeciders: 'Deciders',
            adrContext: 'Context',
            adrDecision: 'Decision',
            adrConsequences: 'Consequences',
            adrConsequencesPlaceholder: 'Describe the consequences of this decision...',
            adrPositive: 'Positive',
            adrNegative: 'Negative',
            adrNeutral: 'Neutral',
            adrSelectedAlternative: 'Selected alternative',
            adrSelectionReason: 'Selection rationale',
            adrSelectionReasonPlaceholder: 'Why was this alternative selected...',
            adrMarkAsSelected: 'Mark as selected',
            adrSelected: 'SELECTED',
            adrPreview: 'ADR Preview',
            adrAlternatives: 'Considered Alternatives',
            adrAlternative: 'Alternative',
            adrAlternativeTitle: 'Alternative title',
            adrAlternativeDesc: 'Description',
            adrRejectedReason: 'Reason for rejection',
            adrImplementation: 'Implementation',
            adrImplStatus: 'Implementation status',
            adrImplStartDate: 'Start date',
            adrImplTargetDate: 'Target date',
            adrImplNotes: 'Implementation notes',
            adrRelatedAdr: 'Related ADR',
            adrSupersedes: 'Supersedes',
            adrSupersededBy: 'Superseded by',
            adrRelatedTo: 'Related to',
            adrTags: 'Tags',
            adrLinks: 'Links',
            adrLinkTitle: 'Link title',
            adrLinkUrl: 'URL',
            adrStatusHistory: 'Status History',
            adrAddAlternative: '+ Add alternative',
            adrAddLink: '+ Add link',
            adrAddConsequence: '+ Add',
            adrSaveMarkdown: 'üìÑ Save as Markdown',
            adrCopyMarkdown: 'üìã Copy Markdown',
            adrSaveDocx: 'üìù Save as DOCX',
            
            // Bulk operations
            selected: 'Selected',
            clearSelection: 'Clear selection',
            selectAction: '-- Select action --',
            changeType: 'Change type',
            changeStereotype: 'Change stereotype',
            changeDetermines: 'Change determines',
            changeDescription: 'Change description',
            addTags: 'Add tags',
            deleteSelected: 'Delete selected',
            changeRelType: 'Change relationship type',
            changeSource: 'Change source',
            changeTarget: 'Change target',
            changeName: 'Change name',
            execute: 'Execute',
            bulkSelectType: 'Select new type:',
            bulkEnterValue: 'Enter value:',
            bulkEnterTags: 'Enter tags (comma separated):',
            bulkSelectElement: 'Select element:',
            confirmBulkDelete: 'Are you sure you want to delete {0} selected items?',
            bulkDeleteWarning: 'For elements, all related relationships will also be deleted.',
            bulkUpdated: 'Updated {0} items.',
            bulkDeleted: 'Deleted {0} items.',
            bulkDuplicateWarning: 'Some relationships would create duplicates and will be skipped.',
            noDuplicatesAllowed: 'Change would create duplicate relationships. Operation cancelled.',
            adrExportAll: 'üì¶ Export all ADR',
            adrNoRecords: 'No ADR records created yet.',
            adrConfirmDelete: 'Are you sure you want to delete this ADR?',
            adrMarkdownCopied: 'Markdown copied to clipboard',
            adrBasicInfo: 'Basic Information',
            adrFilterAll: 'All statuses',
            
            // ADR statuses
            adrStatusDraft: 'Draft',
            adrStatusProposed: 'Proposed',
            adrStatusAccepted: 'Accepted',
            adrStatusRejected: 'Rejected',
            adrStatusImplemented: 'Implemented',
            adrStatusDeprecated: 'Deprecated',
            adrStatusSuperseded: 'Superseded',
            adrStatusUnderDiscussion: 'Under Discussion',
            adrStatusReturned: 'Returned',
            adrStatusUpdated: 'Updated',
            adrStatusMonitored: 'Monitored',
            adrStatusClosed: 'Closed',
            
            // ADR implementation statuses
            adrImplNotStarted: 'Not started',
            adrImplInProgress: 'In progress',
            adrImplCompleted: 'Completed',
            generatedFrom: 'Generated from',
            statistics: 'Statistics',
            total: 'Total',
            date: 'Date',
            separateByComma: 'Separate by comma...',
            adrContextPlaceholder: 'Describe the context and reasons for this decision...',
            adrDecisionPlaceholder: 'Describe the decision that was made...',
            existsWarning: 'exists',
            newItem: 'new',
            selectedToImport: 'Selected to import',
            relWillImport: 'relationships will import',
            diagWillImport: 'diagrams will import',
            relSelectedCount: 'relationships selected',
            searchPlaceholder: 'Search...',
            searchResults: 'Found',
            itemsVisible: 'items visible',
            
            // Tools tab
            tagManagement: 'Tag Management',
            selectTag: 'Select tag',
            selectTagPlaceholder: '-- Select tag --',
            removeFrom: 'Remove from',
            removeFromElements: 'Remove from elements',
            removeFromRelationships: 'Remove from relationships',
            deleteEverywhere: 'Delete everywhere',
            replaceWithTag: 'Replace with tag',
            newTagPlaceholder: 'New tag...',
            replaceIn: 'Replace in',
            replaceInElements: 'Replace in elements',
            replaceInRelationships: 'Replace in relationships',
            replaceEverywhere: 'Replace everywhere',
            
            bulkTagManagement: 'Bulk Tag Management',
            bulkTagDesc: 'Add or remove tags from selected elements or relationships.',
            openBulkManagement: 'Open Bulk Management',
            sourceData: 'Source',
            elements: 'Elements',
            relationships: 'Relationships',
            action: 'Action',
            addTag: 'Add tag',
            removeTag: 'Remove tag',
            tag: 'Tag',
            enterTag: 'Enter tag...',
            selectItems: 'Select items',
            selected: 'selected',
            selectFiltered: 'üîç Select filtered',
            enterTagFirst: 'Enter a tag first...',
            allHaveTag: 'All {0} already have tag "{1}".',
            noneHaveTag: 'No {0} has tag "{1}".',
            executeAction: 'Execute Action',
            close: 'Close',
            
            textGenerator: 'Text Generator',
            textGeneratorDesc: 'Generates text from currently displayed (filtered) elements or relationships using a template.',
            currentElements: 'Current elements list',
            currentRelationships: 'Current relationships list',
            currentTasks: 'Current tasks list',
            currentNotes: 'Current notes list',
            currentAdr: 'Current ADR list',
            availablePlaceholders: 'Available placeholders',
            templateLabel: 'Template (for each row)',
            templatePlaceholder: 'E.g.: {Stereotype} {Name} is of type {Type}\n\nClick a placeholder to insert it at cursor position.',
            skipEmpty: 'Skip items with empty used placeholders',
            generate: 'Generate',
            copyResult: 'üìã Copy Result',
            clear: 'Clear',
            result: 'Result',
            items: 'items',
            
            // Confirmations and alerts
            confirmDelete: 'Are you sure you want to delete',
            confirmDeleteElement: 'Are you sure you want to delete element "{0}"?\n\nThis will also delete all relationships containing this element and remove it from all diagrams.',
            confirmDeleteRelationship: 'Are you sure you want to delete this relationship?',
            confirmDeleteDiagram: 'Are you sure you want to delete diagram "{0}"?',
            confirmClearModel: 'Are you sure you want to clear the entire model? This action cannot be undone.',
            alertFillRequired: 'Please fill in',
            alertIdExists: 'already exists. Use a different ID.',
            alertSelectElements: 'Select at least one item.',
            alertEnterTag: 'Enter a tag.',
            alertCopied: 'Copied to clipboard!',
            alertNothingToCopy: 'Nothing to copy.',
            alertEnterTemplate: 'Enter a template for generation.',
            alertSelectTag: 'Select a tag.',
            alertEnterNewTag: 'Enter a new tag.',
            
            // Success messages
            successTagRemoved: '‚úÖ Tag "{0}" removed {1}',
            successTagReplaced: '‚úÖ Tag "{0}" replaced with "{1}" {2}',
            successTagAdded: '‚úÖ Tag "{0}" added to {1} {2}',
            successTagRemovedFrom: '‚úÖ Tag "{0}" removed from {1} {2}',
            fromElements: 'from elements',
            fromRelationships: 'from relationships',
            fromEverywhere: 'everywhere',
            inElements: 'in elements',
            inRelationships: 'in relationships',
            everywhere: 'everywhere',
            modifiedElements: 'Modified elements',
            modifiedRelationships: 'relationships',
            
            // Relationship group
            relGroupVazba: 'Relationship',
            relGroupZdroj: 'Source',
            relGroupCil: 'Target',
            
            // Misc
            enterNewId: 'Enter new ID...',
            element: 'element',
            relationship: 'relationship',
            and: 'and',
            
            // Additional Model tab
            dcDescription: 'Standard metadata for model description and discovery.',
            dcCreator: 'Author (dc:creator)',
            dcPublisher: 'Publisher (dc:publisher)',
            dcDate: 'Date (dc:date)',
            dcLanguage: 'Language (dc:language)',
            dcRights: 'Rights (dc:rights)',
            dcSubject: 'Subject (dc:subject)',
            dcDescriptionLabel: 'Description (dc:description)',
            customProperties: 'Custom Properties',
            customPropertiesDesc: 'Add custom key-value properties to the model.',
            keyPlaceholder: 'Key',
            valuePlaceholder: 'Value',
            add: 'Add',
            saveMetadata: 'Save Metadata',
            reset: 'Reset',
            modelNamePlaceholder: 'Name of your ArchiMate model',
            documentationPlaceholder: 'Purpose and description of the model...',
            authorPlaceholder: 'Author name',
            organizationPlaceholder: 'Organization',
            rightsPlaceholder: '¬© 2025 Your organization',
            keywordsPlaceholder: 'Keywords',
            dcDescriptionPlaceholder: 'Detailed description for cataloging...',
            
            // Additional Relationships
            relationshipNameOptional: 'Relationship Name (optional)',
            relNamePlaceholder: 'e.g. transfers data',
            relDescriptionOptional: 'Relationship Description (optional)',
            relDescriptionPlaceholder: 'Relationship description',
            tagsPlaceholder: 'e.g. ‚úÖ approved, üöß in progress',
            saveRelationship: 'Save Relationship',
            
            // Additional Diagrams
            relationshipsInDiagram: 'Relationships',
            diagramNamePlaceholder: 'e.g. Application Architecture',
            optionalDescription: 'Optional diagram description',
            createDiagram: 'Create Diagram',
            backToList: '‚Üê Back to list',
            settings: 'Settings',
            preview: 'Preview',
            diagramNamePlaceholder2: 'Diagram name',
            elementLayout: 'Element Layout',
            byLayers: 'By layers',
            grid: 'Grid',
            elementsOnDiagram: 'Elements on Diagram',
            addElementToDiagram: 'Add Element to Diagram',
            relationshipsOnDiagram: 'Relationships on Diagram',
            relationshipsOnDiagramDesc: 'Only relationships where both elements are present on the diagram are shown.',
            diagramNoElements: 'Diagram contains no elements',
            diagramNoRelationships: 'No relationships on diagram',
            redraw: 'Redraw',
            addElementsForPreview: 'Add elements to the diagram to see preview.',
            
            // Additional Reference
            archimateReference: 'ArchiMate 3.2 Reference',
            layersAndTypes: 'Layers and Element Types',
            category: 'Category',
            notation: 'Notation',
            
            // Additional Export/Import
            export: 'Export',
            exportCsv: 'Export CSV',
            dataPreview: 'Data Preview',
            selectExportPreview: 'Select export for preview...',
            dragFileHere: 'Drag file here',
            or: 'or',
            supportedFormats: 'Supported formats: AJX, ArchiMate XML',
            pasteDataManually: 'Or paste data manually:',
            deleteAll: 'Delete All',
            mergeDescription: 'Imports elements, relationships and diagrams from another model. A tag with source model name will be added to imported items.',
            onIdCollision: 'On ID collision',
            fileToMerge: 'File to merge',
            selectFileFirst: 'Select a file first...',
            
            // Additional bulk tag
            selectFilteredTitle: 'Select only items matching current filters',
            
            // Additional alerts
            metadataSaved: 'Model metadata saved.',
            enterPropertyKey: 'Enter property key.',
            fillElementRequired: 'Please fill in ID, layer, type and element name.',
            elementIdExists: 'Element with ID "{0}" already exists. Use a different ID.',
            fillRelationshipRequired: 'Please fill in source element, target element and relationship type.',
            relationshipExists: 'Relationship between these elements already exists (ID: "{0}").',
            copyFailed: 'Failed to copy to clipboard. Use Ctrl+C from preview.',
            pasteDataToImport: 'Please paste data to import.',
            pasteFromClipboard: 'üìã Paste from clipboard',
            pasteManuallyTitle: 'Paste from clipboard',
            pasteManuallyDesc: 'Automatic paste is not available on this device. Paste content manually (Ctrl+V or long press):',
            pasteAndLoad: 'Paste and load',
            unrecognizedFormat: 'Unrecognized format. Supported formats: AJX, ArchiMate XML',
            alertSelectFile: 'Please select a file to merge.',
            alertWaitForFile: 'Wait for file to load.',
            alertSelectAtLeastOne: 'Select at least one element to import.',
            alertEnterDiagramName: 'Please enter diagram name.',
            alertSelectElementToAdd: 'Select an element to add.',
            alertDiagramEmpty: 'Nothing to download - diagram is empty.',
            unsupportedFormat: 'Unsupported file format',
            errorMerge: 'Merge error',
            importedFrom: 'Imported from',
            mergeSuccess: 'Merge completed',
            importedElements: 'Imported elements',
            importedRelationships: 'relationships',
            importedDiagrams: 'diagrams',
            errorImport: 'Import error',
            modelLoaded: 'Model loaded successfully',
            removed: 'Removed',
            
            // Merge statistics
            sourceModel: 'Source',
            strategy: 'Strategy',
            elementsLabel: 'Elements',
            relationshipsLabel: 'Relationships',
            diagramsLabel: 'Diagrams',
            newCount: 'new',
            overwrittenCount: 'overwritten',
            skippedCount: 'skipped',
            manuallySelected: 'manually selected elements',
            
            // Import messages
            importSuccess: 'Import successful!',
            jsonParseError: 'AJX parse error',
            xmlImportSuccess: 'ArchiMate XML import successful!',
            xmlImportError: 'XML import error',
            modelLabel: 'Model',
            
            // Relationship info
            allowedRelationships: 'Allowed relationships',
            foundAllowedTypes: 'Found {0} allowed relationship types.',
            selectRelationshipType: '-- Select relationship type --',
            
            // Merge preview
            error: 'Error',
            totalElements: 'Total elements',
            of: 'of',
            toImport: 'to import',
            selectedCount: 'Selected',
            elementsSmall: 'elements',
            relToImport: 'Relationships to import',
            
            // Dynamic UI texts
            noCustomProperties: 'No custom properties',
            relContainingElement: 'Relationships containing element: "{0}"',
            relWithSource: 'Relationships with source: "{0}"',
            relWithTarget: 'Relationships with target: "{0}"',
            selectBothElements: '-- Select both elements --',
            elementsNotFound: '-- Elements not found --',
            selectTypeShort: '-- Type --',
            selectElementShort: '-- Element --'
        }
    };
    
    // Element type descriptions in both languages
    const ELEMENT_DESCRIPTIONS = {
        cs: {
            "Resource": "Aktivum vlastnƒõn√© nebo kontrolovan√© organizac√≠",
            "Capability": "Schopnost, kterou m√° organizace, ƒçlovƒõk nebo syst√©m",
            "ValueStream": "Sekvence aktivit vytv√°≈ôej√≠c√≠ch celkov√Ω v√Ωsledek pro z√°kazn√≠ka",
            "CourseOfAction": "P≈ô√≠stup nebo pl√°n ke konfiguraci schopnost√≠ a zdroj≈Ø",
            "BusinessActor": "Organizaƒçn√≠ jednotka schopn√° prov√°dƒõt chov√°n√≠",
            "BusinessRole": "Odpovƒõdnost za specifick√© chov√°n√≠",
            "BusinessCollaboration": "Agregace dvou nebo v√≠ce rol√≠ spolupracuj√≠c√≠ch na chov√°n√≠",
            "BusinessInterface": "P≈ô√≠stupov√Ω bod, kde business slu≈æba je dostupn√°",
            "BusinessProcess": "Sekvence chov√°n√≠ dosahuj√≠c√≠ specifick√©ho v√Ωsledku",
            "BusinessFunction": "Kolekce business chov√°n√≠ zalo≈æen√° na vybran√Ωch krit√©ri√≠ch",
            "BusinessInteraction": "Jednotka kolektivn√≠ho business chov√°n√≠",
            "BusinessEvent": "Nƒõco, co se stane a ovliv≈àuje chov√°n√≠",
            "BusinessService": "Slu≈æba spl≈àuj√≠c√≠ business pot≈ôebu z√°kazn√≠ka",
            "BusinessObject": "Koncept relevantn√≠ z business perspektivy",
            "Contract": "Form√°ln√≠ nebo neform√°ln√≠ specifikace dohody",
            "Representation": "Vn√≠mateln√° forma informace",
            "Product": "Koherentn√≠ kolekce slu≈æeb a/nebo pasivn√≠ch prvk≈Ø",
            "ApplicationComponent": "Zapouzd≈ôen√≠ aplikaƒçn√≠ funkcionality",
            "ApplicationCollaboration": "Agregace komponent spolupracuj√≠c√≠ch na chov√°n√≠",
            "ApplicationInterface": "P≈ô√≠stupov√Ω bod, kde aplikaƒçn√≠ slu≈æba je dostupn√°",
            "ApplicationFunction": "Automatizovan√© chov√°n√≠ provediteln√© komponentou",
            "ApplicationProcess": "Sekvence aplikaƒçn√≠ho chov√°n√≠",
            "ApplicationInteraction": "Jednotka kolektivn√≠ho aplikaƒçn√≠ho chov√°n√≠",
            "ApplicationEvent": "Aplikaƒçn√≠ stav, kter√Ω ovliv≈àuje chov√°n√≠",
            "ApplicationService": "Slu≈æba poskytuj√≠c√≠ automatizovan√© chov√°n√≠",
            "DataObject": "Data strukturovan√° pro automatizovan√© zpracov√°n√≠",
            "Node": "V√Ωpoƒçetn√≠ nebo fyzick√Ω zdroj hostuj√≠c√≠ artefakty",
            "Device": "Fyzick√Ω IT zdroj pro zpracov√°n√≠",
            "SystemSoftware": "Software poskytuj√≠c√≠ prost≈ôed√≠ pro komponenty",
            "TechnologyCollaboration": "Agregace uzl≈Ø spolupracuj√≠c√≠ch na funkci",
            "TechnologyInterface": "P≈ô√≠stupov√Ω bod kde technologick√° slu≈æba je dostupn√°",
            "Path": "Spojen√≠ mezi dvƒõma nebo v√≠ce uzly",
            "CommunicationNetwork": "Sada struktur propojuj√≠c√≠ uzly",
            "TechnologyFunction": "Kolekce technologick√©ho chov√°n√≠",
            "TechnologyProcess": "Sekvence technologick√©ho chov√°n√≠",
            "TechnologyInteraction": "Jednotka kolektivn√≠ho technologick√©ho chov√°n√≠",
            "TechnologyEvent": "Technologick√Ω stav ovliv≈àuj√≠c√≠ chov√°n√≠",
            "TechnologyService": "Slu≈æba poskytuj√≠c√≠ technologickou funkcionalitu",
            "Artifact": "ƒå√°st dat pou≈æ√≠van√° nebo produkovan√° softwarem",
            "Equipment": "Fyzick√Ω stroj, n√°stroj nebo p≈ô√≠stroj",
            "Facility": "Fyzick√° struktura nebo prost≈ôed√≠",
            "DistributionNetwork": "Fyzick√° s√≠≈• pro p≈ôenos materi√°l≈Ø",
            "Material": "Hmotn√Ω fyzick√Ω prvek",
            "WorkPackage": "S√©rie akc√≠ k dosa≈æen√≠ c√≠le v ƒçasov√©m r√°mci",
            "Deliverable": "P≈ôesnƒõ definovan√Ω v√Ωsledek work package",
            "ImplementationEvent": "Stav ovliv≈àuj√≠c√≠ implementaƒçn√≠ chov√°n√≠",
            "Plateau": "Relativnƒõ stabiln√≠ stav architektury",
            "Gap": "V√Ωsledek anal√Ωzy mezi dvƒõma platy",
            "Stakeholder": "Role jednotlivce, t√Ωmu nebo organizace",
            "Driver": "Extern√≠ nebo intern√≠ podm√≠nka motivuj√≠c√≠ zmƒõnu",
            "Assessment": "V√Ωsledek anal√Ωzy driveru",
            "Goal": "Koncov√Ω stav, kter√©ho chce stakeholder dos√°hnout",
            "Outcome": "Koncov√Ω v√Ωsledek odpov√≠daj√≠c√≠ efekt≈Øm",
            "Principle": "Kvalitativn√≠ pravidlo, kter√© mus√≠ b√Ωt splnƒõno",
            "Requirement": "Prohl√°≈°en√≠ o pot≈ôebƒõ, kter√° mus√≠ b√Ωt realizov√°na",
            "Constraint": "Omezen√≠ designu nebo implementace syst√©mu",
            "Meaning": "Znalost nebo expert√≠za v urƒçit√©m kontextu",
            "Value": "Relativn√≠ hodnota, u≈æitek nebo d≈Øle≈æitost",
            "Grouping": "Agregace prvk≈Ø pro √∫ƒçely modelov√°n√≠",
            "Location": "Koncepƒçn√≠ nebo fyzick√© m√≠sto",
            "Junction": "Spojen√≠ v√≠ce vazeb"
        },
        en: {
            "Resource": "An asset owned or controlled by an organization",
            "Capability": "An ability that an organization, person, or system possesses",
            "ValueStream": "A sequence of activities creating an overall result for a customer",
            "CourseOfAction": "An approach or plan for configuring capabilities and resources",
            "BusinessActor": "An organizational entity capable of performing behavior",
            "BusinessRole": "Responsibility for specific behavior",
            "BusinessCollaboration": "Aggregation of two or more roles collaborating on behavior",
            "BusinessInterface": "Access point where business service is available",
            "BusinessProcess": "Sequence of behavior achieving a specific result",
            "BusinessFunction": "Collection of business behavior based on selected criteria",
            "BusinessInteraction": "Unit of collective business behavior",
            "BusinessEvent": "Something that happens and affects behavior",
            "BusinessService": "Service fulfilling a business need of a customer",
            "BusinessObject": "Concept relevant from a business perspective",
            "Contract": "Formal or informal specification of an agreement",
            "Representation": "Perceptible form of information",
            "Product": "Coherent collection of services and/or passive elements",
            "ApplicationComponent": "Encapsulation of application functionality",
            "ApplicationCollaboration": "Aggregation of components collaborating on behavior",
            "ApplicationInterface": "Access point where application service is available",
            "ApplicationFunction": "Automated behavior performable by a component",
            "ApplicationProcess": "Sequence of application behavior",
            "ApplicationInteraction": "Unit of collective application behavior",
            "ApplicationEvent": "Application state affecting behavior",
            "ApplicationService": "Service providing automated behavior",
            "DataObject": "Data structured for automated processing",
            "Node": "Computational or physical resource hosting artifacts",
            "Device": "Physical IT resource for processing",
            "SystemSoftware": "Software providing environment for components",
            "TechnologyCollaboration": "Aggregation of nodes collaborating on a function",
            "TechnologyInterface": "Access point where technology service is available",
            "Path": "Connection between two or more nodes",
            "CommunicationNetwork": "Set of structures connecting nodes",
            "TechnologyFunction": "Collection of technology behavior",
            "TechnologyProcess": "Sequence of technology behavior",
            "TechnologyInteraction": "Unit of collective technology behavior",
            "TechnologyEvent": "Technology state affecting behavior",
            "TechnologyService": "Service providing technology functionality",
            "Artifact": "Piece of data used or produced by software",
            "Equipment": "Physical machine, tool, or instrument",
            "Facility": "Physical structure or environment",
            "DistributionNetwork": "Physical network for material transport",
            "Material": "Tangible physical element",
            "WorkPackage": "Series of actions to achieve a goal in a time frame",
            "Deliverable": "Precisely defined result of a work package",
            "ImplementationEvent": "State affecting implementation behavior",
            "Plateau": "Relatively stable state of architecture",
            "Gap": "Result of analysis between two plateaus",
            "Stakeholder": "Role of an individual, team, or organization",
            "Driver": "External or internal condition motivating change",
            "Assessment": "Result of driver analysis",
            "Goal": "End state a stakeholder wants to achieve",
            "Outcome": "End result corresponding to effects",
            "Principle": "Qualitative rule that must be met",
            "Requirement": "Statement of need that must be realized",
            "Constraint": "Limitation on design or implementation",
            "Meaning": "Knowledge or expertise in a certain context",
            "Value": "Relative worth, utility, or importance",
            "Grouping": "Aggregation of elements for modeling purposes",
            "Location": "Conceptual or physical place",
            "Junction": "Connection of multiple relationships"
        }
    };
    
    function t(key, ...args) {
        let text = TRANSLATIONS[currentLanguage][key] || TRANSLATIONS['en'][key] || key;
        // Replace {0}, {1}, etc. with arguments
        args.forEach((arg, i) => {
            text = text.replace(new RegExp('\\{' + i + '\\}', 'g'), arg);
        });
        return text;
    }
    
    function getElementDescription(type) {
        return ELEMENT_DESCRIPTIONS[currentLanguage][type] || ELEMENT_DESCRIPTIONS['en'][type] || '';
    }
    
    function detectLanguage() {
        // Check localStorage first
        const saved = localStorage.getItem('archimate-editor-language');
        if (saved && (saved === 'cs' || saved === 'en')) {
            return saved;
        }
        // Detect from browser
        const browserLang = navigator.language || navigator.userLanguage;
        return browserLang.startsWith('cs') ? 'cs' : 'en';
    }
    
    function changeLanguage(lang) {
        currentLanguage = lang;
        localStorage.setItem('archimate-editor-language', lang);
        document.getElementById('language-select').value = lang;
        document.documentElement.lang = lang;
        applyTranslations();
        // Re-render dynamic content
        renderElementsTable();
        renderRelationshipsTable();
        renderDiagramsTable();
        renderLayersReference();
        updateGeneratorPlaceholders();
    }
    
    function applyTranslations() {
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (TRANSLATIONS[currentLanguage][key]) {
                el.textContent = TRANSLATIONS[currentLanguage][key];
            }
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            const key = el.getAttribute('data-i18n-placeholder');
            if (TRANSLATIONS[currentLanguage][key]) {
                el.placeholder = TRANSLATIONS[currentLanguage][key];
            }
        });
        document.querySelectorAll('[data-i18n-title]').forEach(el => {
            const key = el.getAttribute('data-i18n-title');
            if (TRANSLATIONS[currentLanguage][key]) {
                el.title = TRANSLATIONS[currentLanguage][key];
            }
        });
    }
    
    // ============================================
    // ArchiMate 3.2 Data Definitions
    // ============================================
    
    const ARCHIMATE_LAYERS = {
        strategy: {
            name: "Strategy Layer",
            color: "#F5DEAA",
            elements: {
                "Resource": "Aktivum vlastnƒõn√© nebo kontrolovan√© organizac√≠",
                "Capability": "Schopnost, kterou m√° organizace, ƒçlovƒõk nebo syst√©m",
                "ValueStream": "Sekvence aktivit vytv√°≈ôej√≠c√≠ch celkov√Ω v√Ωsledek pro z√°kazn√≠ka",
                "CourseOfAction": "P≈ô√≠stup nebo pl√°n ke konfiguraci schopnost√≠ a zdroj≈Ø"
            }
        },
        business: {
            name: "Business Layer",
            color: "#FFFFB5",
            elements: {
                "BusinessActor": "Organizaƒçn√≠ jednotka schopn√° prov√°dƒõt chov√°n√≠",
                "BusinessRole": "Odpovƒõdnost za specifick√© chov√°n√≠",
                "BusinessCollaboration": "Agregace dvou nebo v√≠ce rol√≠ spolupracuj√≠c√≠ch na chov√°n√≠",
                "BusinessInterface": "P≈ô√≠stupov√Ω bod, kde business slu≈æba je dostupn√°",
                "BusinessProcess": "Sekvence chov√°n√≠ dosahuj√≠c√≠ specifick√©ho v√Ωsledku",
                "BusinessFunction": "Kolekce business chov√°n√≠ zalo≈æen√° na vybran√Ωch krit√©ri√≠ch",
                "BusinessInteraction": "Jednotka kolektivn√≠ho business chov√°n√≠",
                "BusinessEvent": "Nƒõco, co se stane a ovliv≈àuje chov√°n√≠",
                "BusinessService": "Slu≈æba spl≈àuj√≠c√≠ business pot≈ôebu z√°kazn√≠ka",
                "BusinessObject": "Koncept relevantn√≠ z business perspektivy",
                "Contract": "Form√°ln√≠ nebo neform√°ln√≠ specifikace dohody",
                "Representation": "Vn√≠mateln√° forma informace",
                "Product": "Koherentn√≠ kolekce slu≈æeb a/nebo pasivn√≠ch prvk≈Ø"
            }
        },
        application: {
            name: "Application Layer",
            color: "#B5FFFF",
            elements: {
                "ApplicationComponent": "Zapouzd≈ôen√≠ aplikaƒçn√≠ funkcionality",
                "ApplicationCollaboration": "Agregace komponent spolupracuj√≠c√≠ch na chov√°n√≠",
                "ApplicationInterface": "P≈ô√≠stupov√Ω bod, kde aplikaƒçn√≠ slu≈æba je dostupn√°",
                "ApplicationFunction": "Automatizovan√© chov√°n√≠ provediteln√© komponentou",
                "ApplicationProcess": "Sekvence aplikaƒçn√≠ho chov√°n√≠",
                "ApplicationInteraction": "Jednotka kolektivn√≠ho aplikaƒçn√≠ho chov√°n√≠",
                "ApplicationEvent": "Aplikaƒçn√≠ stav, kter√Ω ovliv≈àuje chov√°n√≠",
                "ApplicationService": "Slu≈æba poskytuj√≠c√≠ automatizovan√© chov√°n√≠",
                "DataObject": "Data strukturovan√° pro automatizovan√© zpracov√°n√≠"
            }
        },
        technology: {
            name: "Technology Layer",
            color: "#C9E7B7",
            elements: {
                "Node": "V√Ωpoƒçetn√≠ nebo fyzick√Ω zdroj hostuj√≠c√≠ artefakty",
                "Device": "Fyzick√Ω IT zdroj pro zpracov√°n√≠",
                "SystemSoftware": "Software poskytuj√≠c√≠ prost≈ôed√≠ pro komponenty",
                "TechnologyCollaboration": "Agregace uzl≈Ø spolupracuj√≠c√≠ch na funkci",
                "TechnologyInterface": "P≈ô√≠stupov√Ω bod kde technologick√° slu≈æba je dostupn√°",
                "Path": "Spojen√≠ mezi dvƒõma nebo v√≠ce uzly",
                "CommunicationNetwork": "Sada struktur propojuj√≠c√≠ uzly",
                "TechnologyFunction": "Kolekce technologick√©ho chov√°n√≠",
                "TechnologyProcess": "Sekvence technologick√©ho chov√°n√≠",
                "TechnologyInteraction": "Jednotka kolektivn√≠ho technologick√©ho chov√°n√≠",
                "TechnologyEvent": "Technologick√Ω stav ovliv≈àuj√≠c√≠ chov√°n√≠",
                "TechnologyService": "Slu≈æba poskytuj√≠c√≠ technologickou funkcionalitu",
                "Artifact": "ƒå√°st dat pou≈æ√≠van√° nebo produkovan√° softwarem"
            }
        },
        physical: {
            name: "Physical Layer",
            color: "#C9E7B7",
            elements: {
                "Equipment": "Fyzick√© stroje, n√°stroje nebo p≈ô√≠stroje",
                "Facility": "Fyzick√° struktura nebo prost≈ôed√≠",
                "DistributionNetwork": "Fyzick√° s√≠≈• pro p≈ôepravu materi√°l≈Ø",
                "Material": "Hmotn√Ω fyzick√Ω prvek"
            }
        },
        implementation: {
            name: "Implementation & Migration Layer",
            color: "#FFE0E0",
            elements: {
                "WorkPackage": "S√©rie akc√≠ urƒçen√Ωch k dosa≈æen√≠ c√≠le",
                "Deliverable": "V√Ωsledek pracovn√≠ho bal√≠ƒçku",
                "ImplementationEvent": "Stav ovliv≈àuj√≠c√≠ implementaƒçn√≠ aktivity",
                "Plateau": "Relativnƒõ stabiln√≠ stav architektury v ƒçase",
                "Gap": "V√Ωsledek anal√Ωzy mezi dvƒõma stavy"
            }
        },
        motivation: {
            name: "Motivation Layer",
            color: "#CCCCFF",
            elements: {
                "Stakeholder": "Role jednotlivce, t√Ωmu nebo organizace se z√°jmem",
                "Driver": "Extern√≠ nebo intern√≠ podm√≠nka motivuj√≠c√≠ zmƒõnu",
                "Assessment": "V√Ωsledek anal√Ωzy driveru",
                "Goal": "Koncov√Ω stav, kter√©ho chce stakeholder dos√°hnout",
                "Outcome": "Koncov√Ω stav jako v√Ωsledek dopad≈Ø c√≠le",
                "Principle": "Vlastnost v≈°ech syst√©m≈Ø v kontextu",
                "Requirement": "V√Ωrok pot≈ôeby, kter√° mus√≠ b√Ωt realizov√°na",
                "Constraint": "Omezen√≠ na zp≈Øsob realizace syst√©mu",
                "Meaning": "Znalost nebo expert√≠za v konkr√©tn√≠ oblasti",
                "Value": "Relativn√≠ hodnota, u≈æitek nebo d≈Øle≈æitost"
            }
        },
        composite: {
            name: "Composite Elements",
            color: "#FFDAB5",
            elements: {
                "Location": "M√≠sto v prostoru kde jsou koncepty situov√°ny",
                "Grouping": "Seskupen√≠ koncept≈Ø bez p≈ôi≈ôazen√≠ konkr√©tn√≠ho v√Ωznamu"
            }
        }
    };

    const RELATIONSHIP_TYPES = {
        "Composition": { category: "structural", description: "Prvek se skl√°d√° z jin√Ωch prvk≈Ø stejn√©ho typu", notation: "‚óÜ‚îÄ‚îÄ‚îÄ", verb: "se skl√°d√° z" },
        "Aggregation": { category: "structural", description: "Prvek sdru≈æuje jin√© prvky", notation: "‚óá‚îÄ‚îÄ‚îÄ", verb: "sdru≈æuje" },
        "Assignment": { category: "structural", description: "P≈ôi≈ôazen√≠ aktivn√≠ho prvku k chov√°n√≠ nebo role k akt√©rovi", notation: "‚óè‚îÄ‚îÄ‚îÄ", verb: "je p≈ôi≈ôazen k" },
        "Realization": { category: "structural", description: "Prvek realizuje/implementuje jin√Ω prvek", notation: "---‚ñ∑", verb: "realizuje" },
        "Serving": { category: "dependency", description: "Prvek poskytuje funkcionalitu jin√©mu prvku", notation: "‚îÄ‚îÄ‚îÄ‚ñ∑", verb: "poskytuje" },
        "Access": { category: "dependency", description: "Procesn√≠ prvek p≈ôistupuje k business/data objektu", notation: "- - -‚ñ∑", verb: "p≈ôistupuje k" },
        "Influence": { category: "dependency", description: "Prvek ovliv≈àuje implementaci nebo dosa≈æen√≠ jin√©ho prvku", notation: "- - -‚ñ∑", verb: "ovliv≈àuje" },
        "Triggering": { category: "dynamic", description: "Prvek ƒçasovƒõ spou≈°t√≠ jin√Ω prvek", notation: "‚îÄ‚îÄ‚îÄ‚ñ∂", verb: "spou≈°t√≠" },
        "Flow": { category: "dynamic", description: "P≈ôenos informace, materi√°lu nebo jin√©ho objektu", notation: "- - -‚ñ∂", verb: "tok do" },
        "Specialization": { category: "other", description: "Prvek je konkr√©tnƒõj≈°√≠ formou jin√©ho prvku stejn√©ho typu", notation: "‚îÄ‚îÄ‚îÄ‚ñ∑", verb: "je specializac√≠" },
        "Association": { category: "other", description: "Nespecifikovan√Ω vztah mezi prvky", notation: "‚îÄ‚îÄ‚îÄ", verb: "souvis√≠ s" }
    };

    // Relationship rules (simplified)
    const RELATIONSHIP_RULES = {
        // Strategy Layer
        "Resource": { "Resource": ["Composition", "Aggregation", "Specialization", "Association"], "Capability": ["Assignment", "Realization", "Association"], "default": ["Association"] },
        "Capability": { "Capability": ["Composition", "Aggregation", "Specialization", "Association"], "Resource": ["Serving", "Association"], "CourseOfAction": ["Realization", "Association"], "default": ["Association", "Serving"] },
        "ValueStream": { "ValueStream": ["Composition", "Aggregation", "Specialization", "Triggering", "Flow", "Association"], "Capability": ["Realization", "Association"], "default": ["Association"] },
        "CourseOfAction": { "CourseOfAction": ["Composition", "Aggregation", "Specialization", "Association"], "Capability": ["Realization", "Association"], "default": ["Association"] },
        
        // Business Layer - Active Structure
        "BusinessActor": { 
            "BusinessActor": ["Composition", "Aggregation", "Specialization", "Association"], 
            "BusinessRole": ["Assignment", "Association"], 
            "BusinessCollaboration": ["Assignment", "Association"], 
            "BusinessInterface": ["Composition", "Aggregation", "Assignment", "Association"], 
            "BusinessProcess": ["Assignment", "Association"],
            "BusinessFunction": ["Assignment", "Association"],
            "BusinessService": ["Assignment", "Realization", "Association"],
            "Location": ["Assignment", "Association"],
            // Cross-layer (derived) - business actor can use application services/components
            "ApplicationComponent": ["Serving", "Association"],
            "ApplicationService": ["Serving", "Association"],
            "default": ["Association"] 
        },
        "BusinessRole": { 
            "BusinessRole": ["Composition", "Aggregation", "Specialization", "Association"], 
            "BusinessProcess": ["Assignment", "Association"], 
            "BusinessFunction": ["Assignment", "Association"], 
            "BusinessInteraction": ["Assignment", "Association"], 
            "BusinessInterface": ["Composition", "Assignment", "Association"], 
            "BusinessEvent": ["Assignment", "Association"], 
            "BusinessService": ["Assignment", "Realization", "Association"],
            // Cross-layer - business role can use application interface
            "ApplicationInterface": ["Serving", "Association"],
            "ApplicationService": ["Serving", "Association"],
            "default": ["Association"] 
        },
        "BusinessCollaboration": { 
            "BusinessCollaboration": ["Composition", "Aggregation", "Specialization", "Association"], 
            "BusinessRole": ["Aggregation", "Association"], 
            "BusinessInteraction": ["Assignment", "Association"], 
            "BusinessService": ["Assignment", "Realization", "Association"],
            "default": ["Association"] 
        },
        "BusinessInterface": { 
            "BusinessInterface": ["Composition", "Aggregation", "Specialization", "Association"], 
            "BusinessService": ["Assignment", "Association"],
            "BusinessActor": ["Serving", "Association"],
            "BusinessRole": ["Serving", "Association"],
            // Cross-layer - business interface can serve application component (Figure 104)
            "ApplicationComponent": ["Serving", "Association"],
            "default": ["Association", "Serving"] 
        },
        
        // Business Layer - Behavior
        "BusinessProcess": { 
            "BusinessProcess": ["Composition", "Aggregation", "Specialization", "Triggering", "Flow", "Association"], 
            "BusinessFunction": ["Composition", "Aggregation", "Triggering", "Flow", "Association"], 
            "BusinessEvent": ["Triggering", "Association"], 
            "BusinessService": ["Realization", "Association"], 
            "BusinessObject": ["Access", "Association"], 
            "Contract": ["Access", "Association"], 
            "Representation": ["Access", "Association"], 
            // Cross-layer - business process can use application services
            "ApplicationService": ["Serving", "Association"], 
            "DataObject": ["Access", "Association"], 
            "default": ["Association"] 
        },
        "BusinessFunction": { 
            "BusinessFunction": ["Composition", "Aggregation", "Specialization", "Triggering", "Flow", "Association"], 
            "BusinessProcess": ["Composition", "Aggregation", "Triggering", "Flow", "Association"], 
            "BusinessService": ["Realization", "Association"], 
            "BusinessObject": ["Access", "Association"],
            // Cross-layer
            "ApplicationService": ["Serving", "Association"],
            "DataObject": ["Access", "Association"],
            "default": ["Association"] 
        },
        "BusinessInteraction": { 
            "BusinessInteraction": ["Composition", "Aggregation", "Specialization", "Triggering", "Flow", "Association"], 
            "BusinessService": ["Realization", "Association"], 
            "BusinessObject": ["Access", "Association"],
            // Cross-layer
            "ApplicationService": ["Serving", "Association"],
            "default": ["Association"] 
        },
        "BusinessEvent": { 
            "BusinessEvent": ["Composition", "Aggregation", "Specialization", "Association"], 
            "BusinessProcess": ["Triggering", "Association"], 
            "BusinessFunction": ["Triggering", "Association"],
            "BusinessInteraction": ["Triggering", "Association"],
            "default": ["Association"] 
        },
        "BusinessService": { 
            "BusinessService": ["Composition", "Aggregation", "Specialization", "Association"], 
            "BusinessProcess": ["Serving", "Association"], 
            "BusinessFunction": ["Serving", "Association"], 
            "BusinessInteraction": ["Serving", "Association"],
            "BusinessRole": ["Serving", "Association"], 
            "BusinessActor": ["Serving", "Association"],
            // Cross-layer - business service can serve application behavior (Figure 104)
            "ApplicationComponent": ["Serving", "Association"],
            "ApplicationProcess": ["Serving", "Association"],
            "ApplicationFunction": ["Serving", "Association"],
            "default": ["Association", "Serving"] 
        },
        
        // Business Layer - Passive Structure
        "BusinessObject": { "BusinessObject": ["Composition", "Aggregation", "Specialization", "Association"], "Representation": ["Realization", "Association"], "default": ["Association"] },
        "Contract": { "Contract": ["Composition", "Aggregation", "Specialization", "Association"], "BusinessObject": ["Specialization", "Association"], "default": ["Association"] },
        "Representation": { "Representation": ["Composition", "Aggregation", "Specialization", "Association"], "BusinessObject": ["Realization", "Association"], "default": ["Association"] },
        "Product": { "Product": ["Composition", "Aggregation", "Specialization", "Association"], "BusinessService": ["Composition", "Aggregation", "Association"], "ApplicationService": ["Composition", "Aggregation", "Association"], "TechnologyService": ["Composition", "Aggregation", "Association"], "Contract": ["Composition", "Aggregation", "Association"], "default": ["Association"] },
        
        // Application Layer - Active Structure
        "ApplicationComponent": { 
            "ApplicationComponent": ["Composition", "Aggregation", "Specialization", "Association"], 
            "ApplicationInterface": ["Composition", "Assignment", "Association"], 
            "ApplicationFunction": ["Assignment", "Association"], 
            "ApplicationProcess": ["Assignment", "Association"], 
            "ApplicationInteraction": ["Assignment", "Association"],
            "ApplicationService": ["Assignment", "Realization", "Association"], 
            "DataObject": ["Access", "Association"],
            // Cross-layer - application component can serve business (derived)
            "BusinessActor": ["Serving", "Association"],
            "BusinessRole": ["Serving", "Association"],
            "BusinessProcess": ["Serving", "Association"],
            "BusinessFunction": ["Serving", "Association"],
            "default": ["Association"] 
        },
        "ApplicationCollaboration": { 
            "ApplicationCollaboration": ["Composition", "Aggregation", "Specialization", "Association"], 
            "ApplicationComponent": ["Aggregation", "Association"], 
            "ApplicationInteraction": ["Assignment", "Association"], 
            "ApplicationService": ["Assignment", "Realization", "Association"],
            "default": ["Association"] 
        },
        "ApplicationInterface": { 
            "ApplicationInterface": ["Composition", "Aggregation", "Specialization", "Association"], 
            "ApplicationService": ["Assignment", "Association"], 
            "ApplicationComponent": ["Serving", "Association"],
            "DataObject": ["Association"],
            // Cross-layer (Figure 104, 105)
            "BusinessRole": ["Serving", "Association"],
            "BusinessActor": ["Serving", "Association"],
            "Node": ["Serving", "Association"],
            "default": ["Association", "Serving"] 
        },
        
        // Application Layer - Behavior
        "ApplicationFunction": { 
            "ApplicationFunction": ["Composition", "Aggregation", "Specialization", "Triggering", "Flow", "Association"], 
            "ApplicationProcess": ["Composition", "Aggregation", "Triggering", "Flow", "Association"], 
            "ApplicationService": ["Realization", "Association"], 
            "DataObject": ["Access", "Association"], 
            // Cross-layer
            "TechnologyService": ["Serving", "Association"], 
            "default": ["Association"] 
        },
        "ApplicationProcess": { 
            "ApplicationProcess": ["Composition", "Aggregation", "Specialization", "Triggering", "Flow", "Association"], 
            "ApplicationFunction": ["Composition", "Aggregation", "Triggering", "Flow", "Association"], 
            "ApplicationService": ["Realization", "Association"], 
            "DataObject": ["Access", "Association"],
            // Cross-layer
            "TechnologyService": ["Serving", "Association"],
            "default": ["Association"] 
        },
        "ApplicationInteraction": { 
            "ApplicationInteraction": ["Composition", "Aggregation", "Specialization", "Triggering", "Flow", "Association"], 
            "ApplicationService": ["Realization", "Association"], 
            "DataObject": ["Access", "Association"],
            // Cross-layer
            "TechnologyService": ["Serving", "Association"],
            "default": ["Association"] 
        },
        "ApplicationEvent": { 
            "ApplicationEvent": ["Composition", "Aggregation", "Specialization", "Association"], 
            "ApplicationFunction": ["Triggering", "Association"], 
            "ApplicationProcess": ["Triggering", "Association"],
            "ApplicationInteraction": ["Triggering", "Association"],
            "default": ["Association"] 
        },
        "ApplicationService": { 
            "ApplicationService": ["Composition", "Aggregation", "Specialization", "Association"], 
            // Same layer
            "ApplicationProcess": ["Serving", "Association"], 
            "ApplicationFunction": ["Serving", "Association"], 
            "ApplicationInteraction": ["Serving", "Association"],
            "ApplicationComponent": ["Serving", "Association"],
            // Cross-layer up (Figure 104) - application service serves business
            "BusinessProcess": ["Serving", "Association"], 
            "BusinessFunction": ["Serving", "Association"],
            "BusinessInteraction": ["Serving", "Association"],
            "BusinessEvent": ["Serving", "Association"],
            "BusinessRole": ["Serving", "Association"],
            "BusinessActor": ["Serving", "Association"],
            // Cross-layer down (Figure 105) - application service serves technology
            "TechnologyProcess": ["Serving", "Association"],
            "TechnologyFunction": ["Serving", "Association"],
            "default": ["Association", "Serving"] 
        },
        "DataObject": { "DataObject": ["Composition", "Aggregation", "Specialization", "Association"], "BusinessObject": ["Realization", "Association"], "default": ["Association"] },
        
        // Technology Layer - Active Structure
        "Node": { 
            "Node": ["Composition", "Aggregation", "Specialization", "Association"], 
            "Device": ["Composition", "Aggregation", "Association"], 
            "SystemSoftware": ["Composition", "Aggregation", "Association"], 
            "TechnologyInterface": ["Composition", "Assignment", "Association"], 
            "TechnologyFunction": ["Assignment", "Association"], 
            "TechnologyProcess": ["Assignment", "Association"], 
            "TechnologyService": ["Assignment", "Realization", "Association"], 
            "Artifact": ["Assignment", "Association"],
            // Cross-layer
            "ApplicationComponent": ["Assignment", "Realization", "Association"],
            "default": ["Association"] 
        },
        "Device": { 
            "Device": ["Composition", "Aggregation", "Specialization", "Association"], 
            "SystemSoftware": ["Assignment", "Association"], 
            "TechnologyFunction": ["Assignment", "Association"], 
            "TechnologyProcess": ["Assignment", "Association"],
            "TechnologyService": ["Assignment", "Realization", "Association"],
            "TechnologyInterface": ["Composition", "Assignment", "Association"],
            "Artifact": ["Assignment", "Association"],
            // Cross-layer
            "ApplicationComponent": ["Assignment", "Realization", "Association"],
            "default": ["Association"] 
        },
        "SystemSoftware": { 
            "SystemSoftware": ["Composition", "Aggregation", "Specialization", "Association"], 
            "TechnologyFunction": ["Assignment", "Association"], 
            "TechnologyProcess": ["Assignment", "Association"],
            "TechnologyService": ["Assignment", "Realization", "Association"], 
            "TechnologyInterface": ["Composition", "Assignment", "Association"],
            "Artifact": ["Assignment", "Association"],
            // Cross-layer
            "ApplicationComponent": ["Realization", "Association"],
            "default": ["Association"] 
        },
        "TechnologyCollaboration": { 
            "TechnologyCollaboration": ["Composition", "Aggregation", "Specialization", "Association"], 
            "Node": ["Aggregation", "Association"], 
            "TechnologyInteraction": ["Assignment", "Association"], 
            "TechnologyService": ["Assignment", "Realization", "Association"],
            "default": ["Association"] 
        },
        "TechnologyInterface": { 
            "TechnologyInterface": ["Composition", "Aggregation", "Specialization", "Association"], 
            "TechnologyService": ["Assignment", "Association"],
            // Cross-layer (Figure 105)
            "ApplicationComponent": ["Serving", "Association"],
            "ApplicationInterface": ["Serving", "Association"],
            "Node": ["Serving", "Association"],
            "Device": ["Serving", "Association"],
            "SystemSoftware": ["Serving", "Association"],
            "default": ["Association", "Serving"] 
        },
        "Path": { "Path": ["Composition", "Aggregation", "Specialization", "Association"], "CommunicationNetwork": ["Realization", "Association"], "default": ["Association"] },
        "CommunicationNetwork": { "CommunicationNetwork": ["Composition", "Aggregation", "Specialization", "Association"], "Node": ["Serving", "Association"], "default": ["Association"] },
        
        // Technology Layer - Behavior
        "TechnologyFunction": { 
            "TechnologyFunction": ["Composition", "Aggregation", "Specialization", "Triggering", "Flow", "Association"], 
            "TechnologyProcess": ["Composition", "Aggregation", "Triggering", "Flow", "Association"], 
            "TechnologyService": ["Realization", "Association"], 
            "Artifact": ["Access", "Association"], 
            "default": ["Association"] 
        },
        "TechnologyProcess": { 
            "TechnologyProcess": ["Composition", "Aggregation", "Specialization", "Triggering", "Flow", "Association"], 
            "TechnologyFunction": ["Composition", "Aggregation", "Triggering", "Flow", "Association"], 
            "TechnologyService": ["Realization", "Association"], 
            "Artifact": ["Access", "Association"], 
            // Cross-layer
            "ApplicationProcess": ["Realization", "Association"], 
            "ApplicationFunction": ["Realization", "Association"], 
            "default": ["Association"] 
        },
        "TechnologyInteraction": { "TechnologyInteraction": ["Composition", "Aggregation", "Specialization", "Triggering", "Flow", "Association"], "TechnologyService": ["Realization", "Association"], "default": ["Association"] },
        "TechnologyEvent": { 
            "TechnologyEvent": ["Composition", "Aggregation", "Specialization", "Association"], 
            "TechnologyFunction": ["Triggering", "Association"], 
            "TechnologyProcess": ["Triggering", "Association"],
            "TechnologyInteraction": ["Triggering", "Association"],
            "default": ["Association"] 
        },
        "TechnologyService": { 
            "TechnologyService": ["Composition", "Aggregation", "Specialization", "Association"], 
            // Same layer
            "TechnologyProcess": ["Serving", "Association"],
            "TechnologyFunction": ["Serving", "Association"],
            "Node": ["Serving", "Association"],
            // Cross-layer (Figure 105) - technology service serves application
            "ApplicationComponent": ["Serving", "Association"], 
            "ApplicationFunction": ["Serving", "Association"], 
            "ApplicationProcess": ["Serving", "Association"],
            "ApplicationInteraction": ["Serving", "Association"],
            "ApplicationEvent": ["Serving", "Association"],
            "default": ["Association", "Serving"] 
        },
        "Artifact": { 
            "Artifact": ["Composition", "Aggregation", "Specialization", "Association"], 
            "DataObject": ["Realization", "Association"], 
            "ApplicationComponent": ["Realization", "Association"], 
            "default": ["Association"] 
        },
        
        // Physical Layer
        "Equipment": { "Equipment": ["Composition", "Aggregation", "Specialization", "Association"], "Facility": ["Assignment", "Association"], "Material": ["Access", "Association"], "default": ["Association"] },
        "Facility": { "Facility": ["Composition", "Aggregation", "Specialization", "Association"], "Node": ["Assignment", "Association"], "Equipment": ["Composition", "Aggregation", "Association"], "default": ["Association"] },
        "DistributionNetwork": { "DistributionNetwork": ["Composition", "Aggregation", "Specialization", "Association"], "Facility": ["Serving", "Association"], "Material": ["Flow", "Association"], "default": ["Association"] },
        "Material": { "Material": ["Composition", "Aggregation", "Specialization", "Association"], "default": ["Association"] },
        
        // Implementation & Migration Layer
        "WorkPackage": { "WorkPackage": ["Composition", "Aggregation", "Specialization", "Triggering", "Flow", "Association"], "Deliverable": ["Realization", "Association"], "Plateau": ["Realization", "Association"], "default": ["Association", "Realization"] },
        "Deliverable": { "Deliverable": ["Composition", "Aggregation", "Specialization", "Association"], "default": ["Association"] },
        "ImplementationEvent": { "ImplementationEvent": ["Composition", "Aggregation", "Specialization", "Association"], "WorkPackage": ["Triggering", "Association"], "default": ["Association"] },
        "Plateau": { "Plateau": ["Composition", "Aggregation", "Specialization", "Triggering", "Association"], "default": ["Association"] },
        "Gap": { "Gap": ["Composition", "Aggregation", "Specialization", "Association"], "Plateau": ["Association"], "default": ["Association"] },
        
        // Motivation Layer
        "Stakeholder": { "Stakeholder": ["Composition", "Aggregation", "Specialization", "Association"], "Driver": ["Association"], "Assessment": ["Association"], "Goal": ["Association"], "Outcome": ["Association"], "Principle": ["Association"], "Requirement": ["Association"], "Constraint": ["Association"], "default": ["Association"] },
        "Driver": { "Driver": ["Composition", "Aggregation", "Specialization", "Association"], "Assessment": ["Association"], "Goal": ["Influence", "Association"], "default": ["Association", "Influence"] },
        "Assessment": { "Assessment": ["Composition", "Aggregation", "Specialization", "Association"], "Goal": ["Influence", "Association"], "Driver": ["Association"], "default": ["Association", "Influence"] },
        "Goal": { "Goal": ["Composition", "Aggregation", "Specialization", "Association"], "Outcome": ["Association"], "Principle": ["Realization", "Association"], "Requirement": ["Realization", "Association"], "Constraint": ["Realization", "Association"], "default": ["Association"] },
        "Outcome": { "Outcome": ["Composition", "Aggregation", "Specialization", "Association"], "Value": ["Realization", "Association"], "default": ["Association"] },
        "Principle": { "Principle": ["Composition", "Aggregation", "Specialization", "Association"], "Requirement": ["Realization", "Association"], "Constraint": ["Realization", "Association"], "Goal": ["Realization", "Association"], "default": ["Association"] },
        "Requirement": { "Requirement": ["Composition", "Aggregation", "Specialization", "Association"], "Constraint": ["Influence", "Association"], "default": ["Association", "Realization"] },
        "Constraint": { "Constraint": ["Composition", "Aggregation", "Specialization", "Association"], "Requirement": ["Influence", "Association"], "default": ["Association"] },
        "Meaning": { "Meaning": ["Composition", "Aggregation", "Specialization", "Association"], "Value": ["Association"], "default": ["Association"] },
        "Value": { "Value": ["Composition", "Aggregation", "Specialization", "Association"], "Stakeholder": ["Association"], "default": ["Association"] },
        
        // Other
        "Location": { "Location": ["Composition", "Aggregation", "Specialization", "Association"], "default": ["Assignment", "Association"] },
        "Grouping": { "default": ["Composition", "Aggregation", "Association"] }
    };

    // ============================================
    // Application State
    // ============================================
    
    let modelMetadata = {
        id: 'id-model-001',
        name: '',
        version: '',
        documentation: '',
        dublinCore: {
            creator: '',
            publisher: '',
            date: '',
            language: 'cs',
            rights: '',
            subject: '',
            description: ''
        },
        properties: []
    };
    
    let elements = [];
    let relationships = [];
    let diagrams = [];
    let adrRecords = [];
    let notes = [];
    let tasks = [];
    let editingElementId = null;
    let editingRelationshipId = null;
    let currentDiagramId = null;
    
    // Sorting state
    let elementSortColumn = 'id';
    let elementSortDirection = 'asc';
    let relationshipSortColumn = 'source';
    let relationshipSortDirection = 'asc';
    
    // ArchiMate element shapes and colors
    const ELEMENT_VISUALS = {
        // Strategy Layer - Yellow/Gold
        "Resource": { shape: "rect", color: "#F5DEAA" },
        "Capability": { shape: "rounded", color: "#F5DEAA" },
        "ValueStream": { shape: "rounded", color: "#F5DEAA" },
        "CourseOfAction": { shape: "rounded", color: "#F5DEAA" },
        
        // Business Layer - Light Yellow
        "BusinessActor": { shape: "rect", color: "#FFFFB5" },
        "BusinessRole": { shape: "rect", color: "#FFFFB5" },
        "BusinessCollaboration": { shape: "rect", color: "#FFFFB5" },
        "BusinessInterface": { shape: "rect", color: "#FFFFB5" },
        "BusinessProcess": { shape: "rounded", color: "#FFFFB5" },
        "BusinessFunction": { shape: "rounded", color: "#FFFFB5" },
        "BusinessInteraction": { shape: "rounded", color: "#FFFFB5" },
        "BusinessEvent": { shape: "rounded", color: "#FFFFB5" },
        "BusinessService": { shape: "rounded", color: "#FFFFB5" },
        "BusinessObject": { shape: "rect", color: "#FFFFB5" },
        "Contract": { shape: "rect", color: "#FFFFB5" },
        "Representation": { shape: "rect", color: "#FFFFB5" },
        "Product": { shape: "rect", color: "#FFFFB5" },
        
        // Application Layer - Cyan/Turquoise
        "ApplicationComponent": { shape: "rect", color: "#B5FFFF" },
        "ApplicationCollaboration": { shape: "rect", color: "#B5FFFF" },
        "ApplicationInterface": { shape: "rect", color: "#B5FFFF" },
        "ApplicationFunction": { shape: "rounded", color: "#B5FFFF" },
        "ApplicationProcess": { shape: "rounded", color: "#B5FFFF" },
        "ApplicationInteraction": { shape: "rounded", color: "#B5FFFF" },
        "ApplicationEvent": { shape: "rounded", color: "#B5FFFF" },
        "ApplicationService": { shape: "rounded", color: "#B5FFFF" },
        "DataObject": { shape: "rect", color: "#B5FFFF" },
        
        // Technology Layer - Green
        "Node": { shape: "rect", color: "#C9E7B7" },
        "Device": { shape: "rect", color: "#C9E7B7" },
        "SystemSoftware": { shape: "rect", color: "#C9E7B7" },
        "TechnologyCollaboration": { shape: "rect", color: "#C9E7B7" },
        "TechnologyInterface": { shape: "rect", color: "#C9E7B7" },
        "Path": { shape: "rect", color: "#C9E7B7" },
        "CommunicationNetwork": { shape: "rect", color: "#C9E7B7" },
        "TechnologyFunction": { shape: "rounded", color: "#C9E7B7" },
        "TechnologyProcess": { shape: "rounded", color: "#C9E7B7" },
        "TechnologyInteraction": { shape: "rounded", color: "#C9E7B7" },
        "TechnologyEvent": { shape: "rounded", color: "#C9E7B7" },
        "TechnologyService": { shape: "rounded", color: "#C9E7B7" },
        "Artifact": { shape: "rect", color: "#C9E7B7" },
        
        // Physical Layer - Green
        "Equipment": { shape: "rect", color: "#C9E7B7" },
        "Facility": { shape: "rect", color: "#C9E7B7" },
        "DistributionNetwork": { shape: "rect", color: "#C9E7B7" },
        "Material": { shape: "rect", color: "#C9E7B7" },
        
        // Implementation & Migration - Pink
        "WorkPackage": { shape: "rounded", color: "#FFE0E0" },
        "Deliverable": { shape: "rect", color: "#FFE0E0" },
        "ImplementationEvent": { shape: "rounded", color: "#FFE0E0" },
        "Plateau": { shape: "rect", color: "#FFE0E0" },
        "Gap": { shape: "rect", color: "#FFE0E0" },
        
        // Motivation Layer - Purple/Violet
        "Stakeholder": { shape: "rect", color: "#CCCCFF" },
        "Driver": { shape: "rect", color: "#CCCCFF" },
        "Assessment": { shape: "rect", color: "#CCCCFF" },
        "Goal": { shape: "rect", color: "#CCCCFF" },
        "Outcome": { shape: "rect", color: "#CCCCFF" },
        "Principle": { shape: "rect", color: "#CCCCFF" },
        "Requirement": { shape: "rect", color: "#CCCCFF" },
        "Constraint": { shape: "rect", color: "#CCCCFF" },
        "Meaning": { shape: "rect", color: "#CCCCFF" },
        "Value": { shape: "rect", color: "#CCCCFF" },
        
        // Composite Elements - Orange
        "Location": { shape: "rect", color: "#FFDAB5" },
        "Grouping": { shape: "rect", color: "#FFDAB5" }
    };
    
    // Layer Y positions for layered layout
    const LAYER_Y_POSITIONS = {
        "motivation": 0,
        "strategy": 150,
        "business": 300,
        "application": 450,
        "technology": 600,
        "physical": 750,
        "implementation": 900,
        "composite": 1050
    };

    // ============================================
    // Model Metadata Functions
    // ============================================
    
    function updateModelHeader() {
        const name = document.getElementById('model-name').value || 'Nov√Ω ArchiMate Model';
        const version = document.getElementById('model-version').value;
        
        document.getElementById('display-model-name').textContent = name;
        document.getElementById('display-model-version').textContent = version ? `Verze: ${version}` : 'Verze: -';
    }
    
    function updateModelStats() {
        document.getElementById('stat-elements').textContent = elements.length;
        document.getElementById('stat-relationships').textContent = relationships.length;
        document.getElementById('stat-diagrams').textContent = diagrams.length;
        
        const usedLayers = new Set(elements.map(e => e.layer));
        document.getElementById('stat-layers').textContent = usedLayers.size;
    }
    
    function saveModelMetadata() {
        modelMetadata.id = document.getElementById('model-id').value.trim() || 'id-model-001';
        modelMetadata.name = document.getElementById('model-name').value.trim();
        modelMetadata.version = document.getElementById('model-version').value.trim();
        modelMetadata.documentation = document.getElementById('model-documentation').value.trim();
        
        modelMetadata.dublinCore = {
            creator: document.getElementById('dc-creator').value.trim(),
            publisher: document.getElementById('dc-publisher').value.trim(),
            date: document.getElementById('dc-date').value.trim(),
            language: document.getElementById('dc-language').value.trim(),
            rights: document.getElementById('dc-rights').value.trim(),
            subject: document.getElementById('dc-subject').value.trim(),
            description: document.getElementById('dc-description').value.trim()
        };
        
        saveToLocalStorage();
        alert(t('metadataSaved'));
    }
    
    function resetModelMetadata() {
        if (!confirm('Opravdu chcete resetovat metadata modelu?')) return;
        
        modelMetadata = {
            id: 'id-model-001',
            name: '',
            version: '',
            documentation: '',
            dublinCore: { creator: '', publisher: '', date: '', language: 'cs', rights: '', subject: '', description: '' },
            properties: []
        };
        
        loadModelMetadataToForm();
        renderModelProperties();
        updateModelHeader();
        saveToLocalStorage();
    }
    
    function loadModelMetadataToForm() {
        document.getElementById('model-id').value = modelMetadata.id || 'id-model-001';
        document.getElementById('model-name').value = modelMetadata.name || '';
        document.getElementById('model-version').value = modelMetadata.version || '';
        document.getElementById('model-documentation').value = modelMetadata.documentation || '';
        
        const dc = modelMetadata.dublinCore || {};
        document.getElementById('dc-creator').value = dc.creator || '';
        document.getElementById('dc-publisher').value = dc.publisher || '';
        document.getElementById('dc-date').value = dc.date || '';
        document.getElementById('dc-language').value = dc.language || 'cs';
        document.getElementById('dc-rights').value = dc.rights || '';
        document.getElementById('dc-subject').value = dc.subject || '';
        document.getElementById('dc-description').value = dc.description || '';
        
        updateModelHeader();
    }
    
    function addModelProperty() {
        const key = document.getElementById('new-prop-key').value.trim();
        const value = document.getElementById('new-prop-value').value.trim();
        
        if (!key) {
            alert(t('enterPropertyKey'));
            return;
        }
        
        modelMetadata.properties.push({ key, value });
        document.getElementById('new-prop-key').value = '';
        document.getElementById('new-prop-value').value = '';
        
        renderModelProperties();
        saveToLocalStorage();
    }
    
    function removeModelProperty(index) {
        modelMetadata.properties.splice(index, 1);
        renderModelProperties();
        saveToLocalStorage();
    }
    
    function renderModelProperties() {
        const container = document.getElementById('model-properties-container');
        
        if (!modelMetadata.properties || modelMetadata.properties.length === 0) {
            container.innerHTML = `<p style="color: #666; font-style: italic;">${t('noCustomProperties')}</p>`;
            return;
        }
        
        container.innerHTML = modelMetadata.properties.map((prop, index) => `
            <div class="property-row">
                <input type="text" class="prop-key" value="${escapeHtml(prop.key)}" readonly>
                <input type="text" class="prop-value" value="${escapeHtml(prop.value)}" readonly>
                <button type="button" class="btn-danger" onclick="removeModelProperty(${index})">√ó</button>
            </div>
        `).join('');
    }

    // ============================================
    // Tab Navigation
    // ============================================
    
    function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            btn.setAttribute('aria-selected', 'false');
        });
        document.getElementById(`btn-${tabName}`).classList.add('active');
        document.getElementById(`btn-${tabName}`).setAttribute('aria-selected', 'true');
        
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`tab-${tabName}`).classList.add('active');
        
        if (tabName === 'relationships') {
            populateElementSelects();
        }
        
    }

    // ============================================
    // Element Type Management
    // ============================================
    
    function updateElementTypes() {
        const layerSelect = document.getElementById('element-layer');
        const typeSelect = document.getElementById('element-type');
        const selectedLayer = layerSelect.value;
        
        typeSelect.innerHTML = `<option value="">${t('selectType')}</option>`;
        
        if (selectedLayer && ARCHIMATE_LAYERS[selectedLayer]) {
            const layer = ARCHIMATE_LAYERS[selectedLayer];
            for (const [type, description] of Object.entries(layer.elements)) {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeSelect.appendChild(option);
            }
        }
        
        document.getElementById('type-description').style.display = 'none';
    }
    
    function showTypeDescription() {
        const layerSelect = document.getElementById('element-layer');
        const typeSelect = document.getElementById('element-type');
        const descDiv = document.getElementById('type-description');
        
        const layer = layerSelect.value;
        const type = typeSelect.value;
        
        if (layer && type && ARCHIMATE_LAYERS[layer]) {
            const description = ARCHIMATE_LAYERS[layer].elements[type];
            if (description) {
                descDiv.innerHTML = `<strong>${type}:</strong> ${description}`;
                descDiv.style.display = 'block';
                return;
            }
        }
        
        descDiv.style.display = 'none';
    }

    // ============================================
    // Element CRUD Operations
    // ============================================
    
    function saveElement() {
        const id = document.getElementById('element-id').value.trim();
        const layer = document.getElementById('element-layer').value;
        const type = document.getElementById('element-type').value;
        const stereotype = document.getElementById('element-stereotype').value.trim();
        const name = document.getElementById('element-name').value.trim();
        const urƒçuje = document.getElementById('element-urƒçuje').value.trim();
        const p≈ô√≠znaky = document.getElementById('element-p≈ô√≠znaky').value.trim();
        const description = document.getElementById('element-description').value.trim();
        
        if (!id || !layer || !type || !name) {
            alert(t('fillElementRequired'));
            return;
        }
        
        const existingIndex = elements.findIndex(e => e.id === id);
        if (existingIndex !== -1 && elements[existingIndex].id !== editingElementId) {
            alert(t('elementIdExists', id));
            return;
        }
        
        const element = { id, layer, type, stereotype, name, urƒçuje, p≈ô√≠znaky, description };
        
        if (editingElementId) {
            const index = elements.findIndex(e => e.id === editingElementId);
            if (index !== -1) {
                // Check if ID changed
                const oldId = editingElementId;
                const newId = id;
                
                if (oldId !== newId) {
                    // Update all relationships referencing this element
                    relationships.forEach(r => {
                        if (r.sourceId === oldId) {
                            r.sourceId = newId;
                        }
                        if (r.targetId === oldId) {
                            r.targetId = newId;
                        }
                    });
                    
                    // Update all diagrams containing this element
                    diagrams.forEach(d => {
                        const idx = d.elementIds.indexOf(oldId);
                        if (idx !== -1) {
                            d.elementIds[idx] = newId;
                        }
                    });
                }
                
                elements[index] = element;
            }
            editingElementId = null;
            document.getElementById('element-form-title').textContent = t('newElement');
        } else {
            elements.push(element);
        }
        
        // Ponechat v≈°echny hodnoty pro snadn√© vytvo≈ôen√≠ podobn√©ho prvku
        editingElementId = null;
        document.getElementById('element-form-title').textContent = t('newElement');
        document.getElementById('element-id').focus();
        
        renderElementsTable();
        renderRelationshipsTable(); // Refresh in case IDs changed
        renderDiagramsTable(); // Refresh in case IDs changed
        updateStereotypeSuggestions();
        updateP≈ô√≠znakySuggestions();
        updateStereotypeFilter();
        updateP≈ô√≠znakyFilters();
        updateRelSourceTargetFilters();
        updateModelStats();
        saveToLocalStorage();
    }
    
    function editElement(id) {
        const element = elements.find(e => e.id === id);
        if (!element) return;
        
        editingElementId = id;
        document.getElementById('element-form-title').textContent = t('editElement');
        
        document.getElementById('element-id').value = element.id;
        document.getElementById('element-layer').value = element.layer;
        updateElementTypes();
        document.getElementById('element-type').value = element.type;
        showTypeDescription();
        document.getElementById('element-stereotype').value = element.stereotype || '';
        document.getElementById('element-name').value = element.name;
        document.getElementById('element-urƒçuje').value = element.urƒçuje || '';
        document.getElementById('element-p≈ô√≠znaky').value = element.p≈ô√≠znaky || '';
        document.getElementById('element-description').value = element.description || '';
        
        switchTab('elements');
        
        // Scroll to form
        document.getElementById('element-form-title').scrollIntoView({ behavior: 'smooth' });
    }
    
    function duplicateElement(id) {
        const original = elements.find(e => e.id === id);
        if (!original) return;
        
        // Clear form and set as new element (not editing)
        editingElementId = null;
        document.getElementById('element-form-title').textContent = t('elementCopy');
        
        // Fill form with original data but empty ID
        document.getElementById('element-id').value = '';
        document.getElementById('element-id').placeholder = 'Zadejte nov√© ID...';
        document.getElementById('element-layer').value = original.layer;
        updateElementTypes();
        document.getElementById('element-type').value = original.type;
        document.getElementById('element-stereotype').value = original.stereotype || '';
        document.getElementById('element-name').value = original.name;
        document.getElementById('element-urƒçuje').value = original.urƒçuje || '';
        document.getElementById('element-p≈ô√≠znaky').value = original.p≈ô√≠znaky || '';
        document.getElementById('element-description').value = original.description || '';
        updateTypeDescription();
        
        switchTab('elements');
        document.getElementById('element-form-title').scrollIntoView({ behavior: 'smooth' });
    }
    
    function deleteElement(id) {
        const element = elements.find(e => e.id === id);
        if (!element) return;
        
        if (!confirm(t('confirmDeleteElement', element.name || id))) {
            return;
        }
        
        deleteElementById(id, true);
        
        renderElementsTable();
        renderRelationshipsTable();
        renderDiagramsTable();
        updateRelSourceTargetFilters();
        updateRelNameSuggestions();
        updateModelStats();
        saveToLocalStorage();
        
    }
    
    function clearElementForm() {
        editingElementId = null;
        document.getElementById('element-form-title').textContent = t('newElement');
        document.getElementById('element-id').value = '';
        document.getElementById('element-layer').value = '';
        document.getElementById('element-type').innerHTML = `<option value="">${t('selectTypeFirst')}</option>`;
        document.getElementById('element-stereotype').value = '';
        document.getElementById('element-name').value = '';
        document.getElementById('element-urƒçuje').value = '';
        document.getElementById('element-p≈ô√≠znaky').value = '';
        document.getElementById('element-description').value = '';
        document.getElementById('type-description').style.display = 'none';
    }
    
    function updateStereotypeSuggestions() {
        const datalist = document.getElementById('stereotype-suggestions');
        const existingSpecs = [...new Set(elements.map(e => e.stereotype).filter(s => s && s.trim()))];
        
        datalist.innerHTML = existingSpecs.map(spec => 
            `<option value="${escapeHtml(spec)}">`
        ).join('');
    }
    
    function updateP≈ô√≠znakySuggestions() {
        const datalist = document.getElementById('p≈ô√≠znaky-suggestions');
        
        // Gather all individual tags from elements and relationships
        const allTags = new Set();
        
        elements.forEach(e => {
            if (e.p≈ô√≠znaky) {
                e.p≈ô√≠znaky.split(',').forEach(tag => {
                    const trimmed = tag.trim();
                    if (trimmed) allTags.add(trimmed);
                });
            }
        });
        
        relationships.forEach(r => {
            if (r.p≈ô√≠znaky) {
                r.p≈ô√≠znaky.split(',').forEach(tag => {
                    const trimmed = tag.trim();
                    if (trimmed) allTags.add(trimmed);
                });
            }
        });
        
        datalist.innerHTML = [...allTags].sort().map(tag => 
            `<option value="${escapeHtml(tag)}">`
        ).join('');
        
        // Also update export tag select
        updateExportTagSelect();
    }
    
    function updateStereotypeFilter() {
        const select = document.getElementById('filter-stereotype');
        const currentValue = select.value;
        
        // Get unique stereotypes
        const stereotypes = [...new Set(elements.map(e => e.stereotype).filter(s => s && s.trim()))].sort();
        
        select.innerHTML = `<option value="">${t('allStereotypes')}</option>`;
        select.innerHTML += `<option value="__empty__">${t('noStereotype')}</option>`;
        stereotypes.forEach(s => {
            const option = document.createElement('option');
            option.value = s;
            option.textContent = `¬´${s}¬ª`;
            select.appendChild(option);
        });
        
        // Restore selection if still valid
        if (currentValue && (currentValue === '__empty__' || stereotypes.includes(currentValue))) {
            select.value = currentValue;
        }
    }
    
    function updateP≈ô√≠znakyFilters() {
        // Gather all unique tags from elements, relationships, notes and ADR
        const allTags = new Set();
        
        elements.forEach(e => {
            if (e.p≈ô√≠znaky) {
                e.p≈ô√≠znaky.split(',').forEach(tag => {
                    const trimmed = tag.trim();
                    if (trimmed) allTags.add(trimmed);
                });
            }
        });
        
        relationships.forEach(r => {
            if (r.p≈ô√≠znaky) {
                r.p≈ô√≠znaky.split(',').forEach(tag => {
                    const trimmed = tag.trim();
                    if (trimmed) allTags.add(trimmed);
                });
            }
        });
        
        // Also gather tags from notes
        notes.forEach(n => {
            if (n.tags && Array.isArray(n.tags)) {
                n.tags.forEach(tag => {
                    const trimmed = tag.trim();
                    if (trimmed) allTags.add(trimmed);
                });
            }
        });
        
        // Also gather tags from ADR
        adrRecords.forEach(a => {
            if (a.tags && Array.isArray(a.tags)) {
                a.tags.forEach(tag => {
                    const trimmed = tag.trim();
                    if (trimmed) allTags.add(trimmed);
                });
            }
        });
        
        // Also gather tags from tasks
        tasks.forEach(task => {
            if (task.tags && Array.isArray(task.tags)) {
                task.tags.forEach(tag => {
                    const trimmed = tag.trim();
                    if (trimmed) allTags.add(trimmed);
                });
            }
        });
        
        const sortedTags = [...allTags].sort();
        
        // Update element p≈ô√≠znaky filter
        const elementSelect = document.getElementById('filter-p≈ô√≠znaky');
        const elementCurrentValue = elementSelect.value;
        elementSelect.innerHTML = `<option value="">${t('allTags')}</option>`;
        elementSelect.innerHTML += `<option value="__empty__">${t('noTags')}</option>`;
        sortedTags.forEach(tag => {
            const option = document.createElement('option');
            option.value = tag;
            option.textContent = tag;
            elementSelect.appendChild(option);
        });
        if (elementCurrentValue && (elementCurrentValue === '__empty__' || allTags.has(elementCurrentValue))) {
            elementSelect.value = elementCurrentValue;
        }
        
        // Update relationship p≈ô√≠znaky filter (same list)
        const relSelect = document.getElementById('filter-rel-p≈ô√≠znaky');
        const relCurrentValue = relSelect.value;
        relSelect.innerHTML = `<option value="">${t('allTags')}</option>`;
        relSelect.innerHTML += `<option value="__empty__">${t('noTags')}</option>`;
        sortedTags.forEach(tag => {
            const option = document.createElement('option');
            option.value = tag;
            option.textContent = tag;
            relSelect.appendChild(option);
        });
        if (relCurrentValue && (relCurrentValue === '__empty__' || allTags.has(relCurrentValue))) {
            relSelect.value = relCurrentValue;
        }
        
        // Update tool tag select
        const toolSelect = document.getElementById('tool-tag-select');
        if (toolSelect) {
            const toolCurrentValue = toolSelect.value;
            toolSelect.innerHTML = `<option value="">${t('selectTagPlaceholder')}</option>`;
            sortedTags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = tag;
                toolSelect.appendChild(option);
            });
            if (toolCurrentValue && allTags.has(toolCurrentValue)) {
                toolSelect.value = toolCurrentValue;
            }
        }
    }
    
    function updateDiagramFilters() {
        const elementSelect = document.getElementById('filter-diagram');
        const relSelect = document.getElementById('filter-rel-diagram');
        
        const elementCurrentValue = elementSelect.value;
        const relCurrentValue = relSelect.value;
        
        const options = diagrams.map(d => `<option value="${escapeHtml(d.id)}">${escapeHtml(d.name || d.id)}</option>`).join('');
        
        elementSelect.innerHTML = `<option value="">${t('allDiagrams')}</option>` + options;
        relSelect.innerHTML = `<option value="">${t('allDiagrams')}</option>` + options;
        
        // Restore values
        if (elementCurrentValue && diagrams.some(d => d.id === elementCurrentValue)) {
            elementSelect.value = elementCurrentValue;
        }
        if (relCurrentValue && diagrams.some(d => d.id === relCurrentValue)) {
            relSelect.value = relCurrentValue;
        }
    }
    
    // ============================================
    // Tools - Tag Management
    // ============================================
    
    function removeTagFrom(scope) {
        const tagSelect = document.getElementById('tool-tag-select');
        const tag = tagSelect.value;
        const resultDiv = document.getElementById('tool-tag-result');
        
        if (!tag) {
            alert(t('alertSelectTag'));
            return;
        }
        
        let elementsAffected = 0;
        let relationshipsAffected = 0;
        
        // Remove from elements
        if (scope === 'elements' || scope === 'all') {
            elements.forEach(e => {
                if (e.p≈ô√≠znaky) {
                    const tags = e.p≈ô√≠znaky.split(',').map(t => t.trim()).filter(t => t && t !== tag);
                    const newP≈ô√≠znaky = tags.join(', ');
                    if (newP≈ô√≠znaky !== e.p≈ô√≠znaky) {
                        e.p≈ô√≠znaky = newP≈ô√≠znaky;
                        elementsAffected++;
                    }
                }
            });
        }
        
        // Remove from relationships
        if (scope === 'relationships' || scope === 'all') {
            relationships.forEach(r => {
                if (r.p≈ô√≠znaky) {
                    const tags = r.p≈ô√≠znaky.split(',').map(t => t.trim()).filter(t => t && t !== tag);
                    const newP≈ô√≠znaky = tags.join(', ');
                    if (newP≈ô√≠znaky !== r.p≈ô√≠znaky) {
                        r.p≈ô√≠znaky = newP≈ô√≠znaky;
                        relationshipsAffected++;
                    }
                }
            });
        }
        
        // Update UI
        renderElementsTable();
        renderRelationshipsTable();
        updateP≈ô√≠znakySuggestions();
        updateP≈ô√≠znakyFilters();
        saveToLocalStorage();
        
        // Show result
        resultDiv.style.display = 'block';
        resultDiv.style.background = '#d4edda';
        resultDiv.style.border = '1px solid #c3e6cb';
        
        let scopeText = scope === 'all' ? t('fromEverywhere') : (scope === 'elements' ? t('fromElements') : t('fromRelationships'));
        resultDiv.innerHTML = `<strong>${t('successTagRemoved', tag, scopeText)}</strong><br>
            ${t('modifiedElements')}: ${elementsAffected}, ${t('modifiedRelationships')}: ${relationshipsAffected}`;
    }
    
    function replaceTagIn(scope) {
        const tagSelect = document.getElementById('tool-tag-select');
        const oldTag = tagSelect.value;
        const newTag = document.getElementById('tool-tag-replace').value.trim();
        const resultDiv = document.getElementById('tool-tag-result');
        
        if (!oldTag) {
            alert(t('alertSelectTag'));
            return;
        }
        
        if (!newTag) {
            alert(t('alertEnterNewTag'));
            return;
        }
        
        let elementsAffected = 0;
        let relationshipsAffected = 0;
        
        // Replace in elements
        if (scope === 'elements' || scope === 'all') {
            elements.forEach(e => {
                if (e.p≈ô√≠znaky) {
                    const tags = e.p≈ô√≠znaky.split(',').map(t => t.trim());
                    const idx = tags.indexOf(oldTag);
                    if (idx !== -1) {
                        tags[idx] = newTag;
                        // Remove duplicates
                        e.p≈ô√≠znaky = [...new Set(tags)].join(', ');
                        elementsAffected++;
                    }
                }
            });
        }
        
        // Replace in relationships
        if (scope === 'relationships' || scope === 'all') {
            relationships.forEach(r => {
                if (r.p≈ô√≠znaky) {
                    const tags = r.p≈ô√≠znaky.split(',').map(t => t.trim());
                    const idx = tags.indexOf(oldTag);
                    if (idx !== -1) {
                        tags[idx] = newTag;
                        // Remove duplicates
                        r.p≈ô√≠znaky = [...new Set(tags)].join(', ');
                        relationshipsAffected++;
                    }
                }
            });
        }
        
        // Update UI
        renderElementsTable();
        renderRelationshipsTable();
        updateP≈ô√≠znakySuggestions();
        updateP≈ô√≠znakyFilters();
        saveToLocalStorage();
        
        // Show result
        resultDiv.style.display = 'block';
        resultDiv.style.background = '#d4edda';
        resultDiv.style.border = '1px solid #c3e6cb';
        
        let scopeText = scope === 'all' ? t('everywhere') : (scope === 'elements' ? t('inElements') : t('inRelationships'));
        resultDiv.innerHTML = `<strong>${t('successTagReplaced', oldTag, newTag, scopeText)}</strong><br>
            ${t('modifiedElements')}: ${elementsAffected}, ${t('modifiedRelationships')}: ${relationshipsAffected}`;
    }
    
    // ============================================
    // Tools - Bulk Tag Management
    // ============================================
    
    function openBulkTagModal() {
        document.getElementById('bulk-tag-modal').classList.add('active');
        document.getElementById('bulk-tag-value').value = '';
        document.getElementById('bulk-tag-result').style.display = 'none';
        renderBulkTagList();
    }
    
    function closeBulkTagModal() {
        document.getElementById('bulk-tag-modal').classList.remove('active');
    }
    
    function closeBulkTagModalOnOverlay(event) {
        if (event.target === document.getElementById('bulk-tag-modal')) {
            closeBulkTagModal();
        }
    }
    
    function renderBulkTagList() {
        const source = document.getElementById('bulk-tag-source').value;
        const action = document.getElementById('bulk-tag-action').value;
        const tag = document.getElementById('bulk-tag-value').value.trim();
        const listDiv = document.getElementById('bulk-tag-list');
        
        if (!tag) {
            listDiv.innerHTML = `<p style="color: #666;">${t('enterTagFirst')}</p>`;
            updateBulkTagSelectedCount();
            return;
        }
        
        // Helper function to check if item has the tag
        function hasTag(p≈ô√≠znaky) {
            if (!p≈ô√≠znaky) return false;
            const tags = p≈ô√≠znaky.split(',').map(t => t.trim());
            return tags.includes(tag);
        }
        
        let html = '';
        let totalCount = 0;
        
        if (source === 'elements') {
            // Filter elements based on action
            const filteredElements = elements.filter(el => {
                if (action === 'add') {
                    return !hasTag(el.p≈ô√≠znaky); // Show only those WITHOUT the tag
                } else {
                    return hasTag(el.p≈ô√≠znaky); // Show only those WITH the tag
                }
            });
            
            if (filteredElements.length === 0) {
                if (action === 'add') {
                    html = `<p style="color: #666;">${t('allHaveTag', t('elements').toLowerCase(), tag)}</p>`;
                } else {
                    html = `<p style="color: #666;">${t('noneHaveTag', t('element'), tag)}</p>`;
                }
            } else {
                // Group elements by layer
                const byLayer = {};
                filteredElements.forEach(el => {
                    if (!byLayer[el.layer]) byLayer[el.layer] = [];
                    byLayer[el.layer].push(el);
                });
                
                const layerOrder = ['strategy', 'business', 'application', 'technology', 'physical', 'implementation', 'motivation', 'composite'];
                const sortedLayers = Object.keys(byLayer).sort((a, b) => layerOrder.indexOf(a) - layerOrder.indexOf(b));
                
                sortedLayers.forEach(layer => {
                    const layerInfo = ARCHIMATE_LAYERS[layer];
                    const layerName = layerInfo ? layerInfo.name : layer;
                    const layerElements = byLayer[layer];
                    
                    html += `<div style="margin-bottom: 15px;">`;
                    html += `<div style="font-weight: bold; margin-bottom: 5px; color: ${layerInfo?.color || '#333'};">${escapeHtml(layerName)} (${layerElements.length})</div>`;
                    
                    layerElements.forEach(el => {
                        totalCount++;
                        const stereotypePart = el.stereotype ? `<span style="color: #666;">¬´${escapeHtml(el.stereotype)}¬ª</span> ` : '';
                        const tagsPart = el.p≈ô√≠znaky ? `<span style="color: #888; font-size: 11px;"> [${escapeHtml(el.p≈ô√≠znaky)}]</span>` : '';
                        
                        html += `
                            <label style="display: flex; align-items: center; padding: 4px 8px; margin: 2px 0; background: #fff; border-radius: 3px; cursor: pointer;">
                                <input type="checkbox" class="bulk-tag-checkbox" data-id="${escapeHtml(el.id)}" data-type="element" style="margin-right: 8px;" onchange="updateBulkTagSelectedCount()">
                                <span style="flex: 1;">
                                    ${stereotypePart}<strong>${escapeHtml(el.name)}</strong>
                                    <span style="color: #888; font-size: 12px;"> ‚Äî ${escapeHtml(el.type)}</span>
                                    ${tagsPart}
                                </span>
                            </label>
                        `;
                    });
                    
                    html += `</div>`;
                });
            }
        } else {
            // Filter relationships based on action
            const filteredRelationships = relationships.filter(r => {
                if (action === 'add') {
                    return !hasTag(r.p≈ô√≠znaky); // Show only those WITHOUT the tag
                } else {
                    return hasTag(r.p≈ô√≠znaky); // Show only those WITH the tag
                }
            });
            
            if (filteredRelationships.length === 0) {
                if (action === 'add') {
                    html = `<p style="color: #666;">${t('allHaveTag', t('relationships').toLowerCase(), tag)}</p>`;
                } else {
                    html = `<p style="color: #666;">${t('noneHaveTag', t('relationship'), tag)}</p>`;
                }
            } else {
                filteredRelationships.forEach(r => {
                    totalCount++;
                    const sourceEl = elements.find(e => e.id === r.sourceId);
                    const targetEl = elements.find(e => e.id === r.targetId);
                    const sourceName = sourceEl ? sourceEl.name : r.sourceId;
                    const targetName = targetEl ? targetEl.name : r.targetId;
                    const tagsPart = r.p≈ô√≠znaky ? `<span style="color: #888; font-size: 11px;"> [${escapeHtml(r.p≈ô√≠znaky)}]</span>` : '';
                    
                    html += `
                        <label style="display: flex; align-items: center; padding: 4px 8px; margin: 2px 0; background: #fff; border-radius: 3px; cursor: pointer;">
                            <input type="checkbox" class="bulk-tag-checkbox" data-id="${escapeHtml(r.id)}" data-type="relationship" style="margin-right: 8px;" onchange="updateBulkTagSelectedCount()">
                            <span style="flex: 1;">
                                <strong>${escapeHtml(sourceName)}</strong>
                                <span style="color: #666;"> ‚Üí </span>
                                <strong>${escapeHtml(targetName)}</strong>
                                <span style="color: #888; font-size: 12px;"> (${escapeHtml(r.type)}${r.name ? ': ' + escapeHtml(r.name) : ''})</span>
                                ${tagsPart}
                            </span>
                        </label>
                    `;
                });
            }
        }
        
        listDiv.innerHTML = html;
        updateBulkTagSelectedCount();
    }
    
    function bulkTagSelectAll(select) {
        document.querySelectorAll('.bulk-tag-checkbox').forEach(cb => {
            cb.checked = select;
        });
        updateBulkTagSelectedCount();
    }
    
    function bulkTagSelectFiltered() {
        const source = document.getElementById('bulk-tag-source').value;
        
        // First uncheck all
        document.querySelectorAll('.bulk-tag-checkbox').forEach(cb => {
            cb.checked = false;
        });
        
        // Get filtered IDs
        let filteredIds;
        if (source === 'elements') {
            filteredIds = new Set(getFilteredElements().map(e => e.id));
        } else {
            filteredIds = new Set(getFilteredRelationships().map(r => r.id));
        }
        
        // Check matching items
        document.querySelectorAll('.bulk-tag-checkbox').forEach(cb => {
            if (filteredIds.has(cb.dataset.id)) {
                cb.checked = true;
            }
        });
        
        updateBulkTagSelectedCount();
    }
    
    function updateBulkTagSelectedCount() {
        const count = document.querySelectorAll('.bulk-tag-checkbox:checked').length;
        document.getElementById('bulk-tag-selected-count').textContent = count;
    }
    
    function executeBulkTagAction() {
        const action = document.getElementById('bulk-tag-action').value;
        const tag = document.getElementById('bulk-tag-value').value.trim();
        const resultDiv = document.getElementById('bulk-tag-result');
        const source = document.getElementById('bulk-tag-source').value;
        
        if (!tag) {
            alert(t('alertEnterTag'));
            return;
        }
        
        const selectedCheckboxes = document.querySelectorAll('.bulk-tag-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            alert(t('alertSelectElements'));
            return;
        }
        
        const selectedIds = new Set([...selectedCheckboxes].map(cb => cb.dataset.id));
        let affected = 0;
        
        if (source === 'elements') {
            elements.forEach(e => {
                if (!selectedIds.has(e.id)) return;
                
                if (action === 'add') {
                    // Add tag
                    if (!e.p≈ô√≠znaky || !e.p≈ô√≠znaky.trim()) {
                        e.p≈ô√≠znaky = tag;
                        affected++;
                    } else {
                        const tags = e.p≈ô√≠znaky.split(',').map(t => t.trim());
                        if (!tags.includes(tag)) {
                            tags.push(tag);
                            e.p≈ô√≠znaky = tags.join(', ');
                            affected++;
                        }
                    }
                } else {
                    // Remove tag
                    if (e.p≈ô√≠znaky) {
                        const tags = e.p≈ô√≠znaky.split(',').map(t => t.trim()).filter(t => t && t !== tag);
                        const newP≈ô√≠znaky = tags.join(', ');
                        if (newP≈ô√≠znaky !== e.p≈ô√≠znaky) {
                            e.p≈ô√≠znaky = newP≈ô√≠znaky;
                            affected++;
                        }
                    }
                }
            });
        } else {
            relationships.forEach(r => {
                if (!selectedIds.has(r.id)) return;
                
                if (action === 'add') {
                    // Add tag
                    if (!r.p≈ô√≠znaky || !r.p≈ô√≠znaky.trim()) {
                        r.p≈ô√≠znaky = tag;
                        affected++;
                    } else {
                        const tags = r.p≈ô√≠znaky.split(',').map(t => t.trim());
                        if (!tags.includes(tag)) {
                            tags.push(tag);
                            r.p≈ô√≠znaky = tags.join(', ');
                            affected++;
                        }
                    }
                } else {
                    // Remove tag
                    if (r.p≈ô√≠znaky) {
                        const tags = r.p≈ô√≠znaky.split(',').map(t => t.trim()).filter(t => t && t !== tag);
                        const newP≈ô√≠znaky = tags.join(', ');
                        if (newP≈ô√≠znaky !== r.p≈ô√≠znaky) {
                            r.p≈ô√≠znaky = newP≈ô√≠znaky;
                            affected++;
                        }
                    }
                }
            });
        }
        
        // Update UI
        renderElementsTable();
        renderRelationshipsTable();
        updateP≈ô√≠znakySuggestions();
        updateP≈ô√≠znakyFilters();
        saveToLocalStorage();
        renderBulkTagList(); // Refresh list to show updated tags
        
        // Show result
        resultDiv.style.display = 'block';
        resultDiv.style.background = '#d4edda';
        resultDiv.style.border = '1px solid #c3e6cb';
        
        const sourceText = source === 'elements' ? t('elements').toLowerCase() : t('relationships').toLowerCase();
        if (action === 'add') {
            resultDiv.innerHTML = `<strong>${t('successTagAdded', tag, affected, sourceText)}</strong>`;
        } else {
            resultDiv.innerHTML = `<strong>${t('successTagRemovedFrom', tag, affected, sourceText)}</strong>`;
        }
    }
    
    // ============================================
    // Tools - Text Generator
    // ============================================
    
    const ELEMENT_PLACEHOLDERS = [
        { key: '{ID}', desc: 'ID prvku' },
        { key: '{Vrstva}', desc: 'N√°zev vrstvy' },
        { key: '{Typ}', desc: 'Typ prvku' },
        { key: '{Stereotyp}', desc: 'Stereotyp' },
        { key: '{N√°zev}', desc: 'N√°zev prvku' },
        { key: '{Urƒçuje}', desc: 'Urƒçuje' },
        { key: '{P≈ô√≠znaky}', desc: 'P≈ô√≠znaky' },
        { key: '{Popis}', desc: 'Popis' }
    ];
    
    const RELATIONSHIP_PLACEHOLDERS = [
        // Vazba
        { key: '{ID}', desc: 'ID vazby', group: 'Vazba' },
        { key: '{Typ}', desc: 'Typ vazby', group: 'Vazba' },
        { key: '{N√°zev}', desc: 'N√°zev vazby', group: 'Vazba' },
        { key: '{Popis}', desc: 'Popis vazby', group: 'Vazba' },
        { key: '{P≈ô√≠znaky}', desc: 'P≈ô√≠znaky vazby', group: 'Vazba' },
        { key: '{Statement}', desc: 'Statement vƒõta', group: 'Vazba' },
        // Zdroj
        { key: '{Zdroj}', desc: 'N√°zev zdrojov√©ho prvku', group: 'Zdroj' },
        { key: '{ZdrojID}', desc: 'ID zdroje', group: 'Zdroj' },
        { key: '{ZdrojVrstva}', desc: 'Vrstva zdroje', group: 'Zdroj' },
        { key: '{ZdrojTyp}', desc: 'Typ zdroje', group: 'Zdroj' },
        { key: '{ZdrojStereotyp}', desc: 'Stereotyp zdroje', group: 'Zdroj' },
        { key: '{ZdrojUrƒçuje}', desc: 'Urƒçuje zdroje', group: 'Zdroj' },
        { key: '{ZdrojP≈ô√≠znaky}', desc: 'P≈ô√≠znaky zdroje', group: 'Zdroj' },
        { key: '{ZdrojPopis}', desc: 'Popis zdroje', group: 'Zdroj' },
        // C√≠l
        { key: '{C√≠l}', desc: 'N√°zev c√≠lov√©ho prvku', group: 'C√≠l' },
        { key: '{C√≠lID}', desc: 'ID c√≠le', group: 'C√≠l' },
        { key: '{C√≠lVrstva}', desc: 'Vrstva c√≠le', group: 'C√≠l' },
        { key: '{C√≠lTyp}', desc: 'Typ c√≠le', group: 'C√≠l' },
        { key: '{C√≠lStereotyp}', desc: 'Stereotyp c√≠le', group: 'C√≠l' },
        { key: '{C√≠lUrƒçuje}', desc: 'Urƒçuje c√≠le', group: 'C√≠l' },
        { key: '{C√≠lP≈ô√≠znaky}', desc: 'P≈ô√≠znaky c√≠le', group: 'C√≠l' },
        { key: '{C√≠lPopis}', desc: 'Popis c√≠le', group: 'C√≠l' }
    ];
    
    const TASK_PLACEHOLDERS = [
        { key: '{ID}', desc: 'ID √∫kolu' },
        { key: '{ƒå√≠slo}', desc: 'ƒå√≠slo √∫kolu' },
        { key: '{N√°zev}', desc: 'N√°zev √∫kolu' },
        { key: '{Stav}', desc: 'Stav √∫kolu' },
        { key: '{Priorita}', desc: 'Priorita √∫kolu' },
        { key: '{≈òe≈°itel}', desc: '≈òe≈°itel' },
        { key: '{Zadavatel}', desc: 'Zadavatel' },
        { key: '{Term√≠n}', desc: 'Term√≠n' },
        { key: '{P≈ô√≠znaky}', desc: 'P≈ô√≠znaky' },
        { key: '{Popis}', desc: 'Popis √∫kolu' },
        { key: '{Aktu√°ln√≠Stav}', desc: 'Aktu√°ln√≠ stav/pozn√°mky' },
        { key: '{Vytvo≈ôeno}', desc: 'Datum vytvo≈ôen√≠' },
        { key: '{Aktualizov√°no}', desc: 'Datum aktualizace' }
    ];
    
    const NOTE_PLACEHOLDERS = [
        { key: '{ID}', desc: 'ID pozn√°mky' },
        { key: '{N√°zev}', desc: 'N√°zev pozn√°mky' },
        { key: '{Autor}', desc: 'Autor' },
        { key: '{P≈ô√≠znaky}', desc: 'P≈ô√≠znaky' },
        { key: '{Obsah}', desc: 'Obsah pozn√°mky' },
        { key: '{Vytvo≈ôeno}', desc: 'Datum vytvo≈ôen√≠' },
        { key: '{Aktualizov√°no}', desc: 'Datum aktualizace' },
        { key: '{PoƒçetVerz√≠}', desc: 'Poƒçet verz√≠' }
    ];
    
    const ADR_PLACEHOLDERS = [
        { key: '{ID}', desc: 'ID ADR' },
        { key: '{ƒå√≠slo}', desc: 'ƒå√≠slo ADR' },
        { key: '{N√°zev}', desc: 'N√°zev ADR' },
        { key: '{Stav}', desc: 'Stav ADR' },
        { key: '{Autor}', desc: 'Autor' },
        { key: '{Schvalovatel}', desc: 'Schvalovatel' },
        { key: '{Datum}', desc: 'Datum rozhodnut√≠' },
        { key: '{P≈ô√≠znaky}', desc: 'P≈ô√≠znaky' },
        { key: '{Kontext}', desc: 'Kontext' },
        { key: '{Rozhodnut√≠}', desc: 'Rozhodnut√≠' },
        { key: '{D≈Øsledky}', desc: 'D≈Øsledky' },
        { key: '{PoƒçetAlternativ}', desc: 'Poƒçet alternativ' },
        { key: '{Vybran√°Alternativa}', desc: 'Vybran√° alternativa' }
    ];
    
    function updateGeneratorPlaceholders() {
        const source = document.getElementById('generator-source').value;
        const container = document.getElementById('generator-placeholders');
        
        let placeholders;
        if (source === 'elements') {
            placeholders = ELEMENT_PLACEHOLDERS;
        } else if (source === 'tasks') {
            placeholders = TASK_PLACEHOLDERS;
        } else if (source === 'notes') {
            placeholders = NOTE_PLACEHOLDERS;
        } else if (source === 'adr') {
            placeholders = ADR_PLACEHOLDERS;
        } else if (source === 'relationships') {
            // Group relationship placeholders
            let html = '';
            let currentGroup = '';
            RELATIONSHIP_PLACEHOLDERS.forEach(p => {
                if (p.group !== currentGroup) {
                    if (currentGroup) html += '</div>';
                    html += `<div style="width: 100%; margin-top: ${currentGroup ? '8px' : '0'}; margin-bottom: 4px;"><strong style="font-size: 11px; color: #666;">${p.group}:</strong></div><div style="display: flex; flex-wrap: wrap; gap: 5px;">`;
                    currentGroup = p.group;
                }
                html += `<button type="button" class="btn-secondary" style="font-size: 12px; padding: 3px 8px;" 
                         onclick="insertPlaceholder('${p.key}')" title="${escapeHtml(p.desc)}">${escapeHtml(p.key)}</button>`;
            });
            html += '</div>';
            container.innerHTML = html;
            return;
        }
        
        // Simple placeholders (elements, tasks, notes, adr)
        container.innerHTML = placeholders.map(p => 
            `<button type="button" class="btn-secondary" style="font-size: 12px; padding: 3px 8px;" 
                     onclick="insertPlaceholder('${p.key}')" title="${escapeHtml(p.desc)}">${escapeHtml(p.key)}</button>`
        ).join('');
    }
    
    function insertPlaceholder(placeholder) {
        const textarea = document.getElementById('generator-template');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const text = textarea.value;
        
        textarea.value = text.substring(0, start) + placeholder + text.substring(end);
        textarea.focus();
        textarea.selectionStart = textarea.selectionEnd = start + placeholder.length;
    }
    
    function generateText() {
        const source = document.getElementById('generator-source').value;
        const template = document.getElementById('generator-template').value;
        const skipEmpty = document.getElementById('generator-skip-empty').checked;
        const outputArea = document.getElementById('generator-output');
        const countSpan = document.getElementById('generator-count');
        
        if (!template.trim()) {
            alert(t('alertEnterTemplate'));
            return;
        }
        
        let items = [];
        let lines = [];
        
        if (source === 'elements') {
            // Get currently filtered elements
            items = getFilteredElements();
            
            items.forEach(e => {
                const layerInfo = ARCHIMATE_LAYERS[e.layer];
                const layerName = layerInfo ? layerInfo.name : e.layer;
                
                let line = template
                    .replace(/\{ID\}/g, e.id || '')
                    .replace(/\{Vrstva\}/g, layerName || '')
                    .replace(/\{Typ\}/g, e.type || '')
                    .replace(/\{Stereotyp\}/g, e.stereotype || '')
                    .replace(/\{N√°zev\}/g, e.name || '')
                    .replace(/\{Urƒçuje\}/g, e.urƒçuje || '')
                    .replace(/\{P≈ô√≠znaky\}/g, e.p≈ô√≠znaky || '')
                    .replace(/\{Popis\}/g, e.description || '');
                
                // Skip if has empty placeholders and option is checked
                if (skipEmpty) {
                    const usedPlaceholders = template.match(/\{[^}]+\}/g) || [];
                    let hasEmpty = false;
                    usedPlaceholders.forEach(ph => {
                        const value = line.includes(ph) ? '' : getPlaceholderValue(e, ph, 'element');
                        if (!getPlaceholderValue(e, ph, 'element')) {
                            hasEmpty = true;
                        }
                    });
                    // Check if any placeholder resulted in empty
                    if (hasEmptyPlaceholder(template, e, 'element')) {
                        return;
                    }
                }
                
                lines.push(line);
            });
        } else if (source === 'relationships') {
            // Get currently filtered relationships
            items = getFilteredRelationships();
            
            items.forEach(r => {
                const sourceEl = elements.find(e => e.id === r.sourceId);
                const targetEl = elements.find(e => e.id === r.targetId);
                const statement = generateStatement(r);
                
                // Get layer names for source and target
                const sourceLayerInfo = sourceEl ? ARCHIMATE_LAYERS[sourceEl.layer] : null;
                const sourceLayerName = sourceLayerInfo ? sourceLayerInfo.name : (sourceEl ? sourceEl.layer : '');
                const targetLayerInfo = targetEl ? ARCHIMATE_LAYERS[targetEl.layer] : null;
                const targetLayerName = targetLayerInfo ? targetLayerInfo.name : (targetEl ? targetEl.layer : '');
                
                let line = template
                    // Vazba
                    .replace(/\{ID\}/g, r.id || '')
                    .replace(/\{Typ\}/g, r.type || '')
                    .replace(/\{N√°zev\}/g, r.name || '')
                    .replace(/\{Popis\}/g, r.description || '')
                    .replace(/\{P≈ô√≠znaky\}/g, r.p≈ô√≠znaky || '')
                    .replace(/\{Statement\}/g, statement || '')
                    // Zdroj
                    .replace(/\{Zdroj\}/g, sourceEl ? sourceEl.name : r.sourceId)
                    .replace(/\{ZdrojID\}/g, r.sourceId || '')
                    .replace(/\{ZdrojVrstva\}/g, sourceLayerName)
                    .replace(/\{ZdrojTyp\}/g, sourceEl ? sourceEl.type : '')
                    .replace(/\{ZdrojStereotyp\}/g, sourceEl ? (sourceEl.stereotype || '') : '')
                    .replace(/\{ZdrojUrƒçuje\}/g, sourceEl ? (sourceEl.urƒçuje || '') : '')
                    .replace(/\{ZdrojP≈ô√≠znaky\}/g, sourceEl ? (sourceEl.p≈ô√≠znaky || '') : '')
                    .replace(/\{ZdrojPopis\}/g, sourceEl ? (sourceEl.description || '') : '')
                    // C√≠l
                    .replace(/\{C√≠l\}/g, targetEl ? targetEl.name : r.targetId)
                    .replace(/\{C√≠lID\}/g, r.targetId || '')
                    .replace(/\{C√≠lVrstva\}/g, targetLayerName)
                    .replace(/\{C√≠lTyp\}/g, targetEl ? targetEl.type : '')
                    .replace(/\{C√≠lStereotyp\}/g, targetEl ? (targetEl.stereotype || '') : '')
                    .replace(/\{C√≠lUrƒçuje\}/g, targetEl ? (targetEl.urƒçuje || '') : '')
                    .replace(/\{C√≠lP≈ô√≠znaky\}/g, targetEl ? (targetEl.p≈ô√≠znaky || '') : '')
                    .replace(/\{C√≠lPopis\}/g, targetEl ? (targetEl.description || '') : '');
                
                if (skipEmpty && hasEmptyPlaceholder(template, r, 'relationship')) {
                    return;
                }
                
                lines.push(line);
            });
        } else if (source === 'tasks') {
            // Use all tasks (no filtering for now)
            items = tasks;
            
            items.forEach(t => {
                let line = template
                    .replace(/\{ID\}/g, t.id || '')
                    .replace(/\{ƒå√≠slo\}/g, t.number || '')
                    .replace(/\{N√°zev\}/g, t.title || '')
                    .replace(/\{Stav\}/g, getTaskStatusLabel(t.status) || '')
                    .replace(/\{Priorita\}/g, getTaskPriorityLabel(t.priority) || '')
                    .replace(/\{≈òe≈°itel\}/g, t.assignee || '')
                    .replace(/\{Zadavatel\}/g, t.reporter || '')
                    .replace(/\{Term√≠n\}/g, t.dueDate || '')
                    .replace(/\{P≈ô√≠znaky\}/g, (t.tags || []).join(', ') || '')
                    .replace(/\{Popis\}/g, t.description || '')
                    .replace(/\{Aktu√°ln√≠Stav\}/g, t.currentState || '')
                    .replace(/\{Vytvo≈ôeno\}/g, t.created ? new Date(t.created).toLocaleDateString() : '')
                    .replace(/\{Aktualizov√°no\}/g, t.updated ? new Date(t.updated).toLocaleDateString() : '');
                
                if (skipEmpty && hasEmptyPlaceholder(template, t, 'task')) {
                    return;
                }
                
                lines.push(line);
            });
        } else if (source === 'notes') {
            // Use all notes
            items = notes;
            
            items.forEach(n => {
                let line = template
                    .replace(/\{ID\}/g, n.id || '')
                    .replace(/\{N√°zev\}/g, n.name || '')
                    .replace(/\{Autor\}/g, n.author || '')
                    .replace(/\{P≈ô√≠znaky\}/g, (n.tags || []).join(', ') || '')
                    .replace(/\{Obsah\}/g, n.content || '')
                    .replace(/\{Vytvo≈ôeno\}/g, n.created ? new Date(n.created).toLocaleDateString() : '')
                    .replace(/\{Aktualizov√°no\}/g, n.updated ? new Date(n.updated).toLocaleDateString() : '')
                    .replace(/\{PoƒçetVerz√≠\}/g, (n.versions || []).length.toString());
                
                if (skipEmpty && hasEmptyPlaceholder(template, n, 'note')) {
                    return;
                }
                
                lines.push(line);
            });
        } else if (source === 'adr') {
            // Use all ADR records
            items = adrRecords;
            
            items.forEach(a => {
                const selectedAlt = a.alternatives && a.selectedAlternative !== undefined && a.selectedAlternative !== '' 
                    ? (a.alternatives[parseInt(a.selectedAlternative)] || {}).title || '' 
                    : '';
                
                let line = template
                    .replace(/\{ID\}/g, a.id || '')
                    .replace(/\{ƒå√≠slo\}/g, a.number || '')
                    .replace(/\{N√°zev\}/g, a.title || '')
                    .replace(/\{Stav\}/g, getAdrStatusLabel(a.status) || '')
                    .replace(/\{Autor\}/g, a.author || '')
                    .replace(/\{Schvalovatel\}/g, a.approver || '')
                    .replace(/\{Datum\}/g, a.decisionDate || '')
                    .replace(/\{P≈ô√≠znaky\}/g, (a.tags || []).join(', ') || '')
                    .replace(/\{Kontext\}/g, a.context || '')
                    .replace(/\{Rozhodnut√≠\}/g, a.decision || '')
                    .replace(/\{D≈Øsledky\}/g, a.consequences || '')
                    .replace(/\{PoƒçetAlternativ\}/g, (a.alternatives || []).length.toString())
                    .replace(/\{Vybran√°Alternativa\}/g, selectedAlt);
                
                if (skipEmpty && hasEmptyPlaceholder(template, a, 'adr')) {
                    return;
                }
                
                lines.push(line);
            });
        }
        
        outputArea.value = lines.join('\n');
        countSpan.textContent = lines.length;
    }
    
    function hasEmptyPlaceholder(template, item, type) {
        const placeholders = template.match(/\{[^}]+\}/g) || [];
        
        for (const ph of placeholders) {
            const value = getPlaceholderValue(item, ph, type);
            if (!value || !value.trim()) {
                return true;
            }
        }
        return false;
    }
    
    function getPlaceholderValue(item, placeholder, type) {
        if (type === 'element') {
            const layerInfo = ARCHIMATE_LAYERS[item.layer];
            const layerName = layerInfo ? layerInfo.name : item.layer;
            
            switch (placeholder) {
                case '{ID}': return item.id;
                case '{Vrstva}': return layerName;
                case '{Typ}': return item.type;
                case '{Stereotyp}': return item.stereotype;
                case '{N√°zev}': return item.name;
                case '{Urƒçuje}': return item.urƒçuje;
                case '{P≈ô√≠znaky}': return item.p≈ô√≠znaky;
                case '{Popis}': return item.description;
                default: return '';
            }
        } else if (type === 'relationship') {
            const sourceEl = elements.find(e => e.id === item.sourceId);
            const targetEl = elements.find(e => e.id === item.targetId);
            const sourceLayerInfo = sourceEl ? ARCHIMATE_LAYERS[sourceEl.layer] : null;
            const sourceLayerName = sourceLayerInfo ? sourceLayerInfo.name : (sourceEl ? sourceEl.layer : '');
            const targetLayerInfo = targetEl ? ARCHIMATE_LAYERS[targetEl.layer] : null;
            const targetLayerName = targetLayerInfo ? targetLayerInfo.name : (targetEl ? targetEl.layer : '');
            
            switch (placeholder) {
                // Vazba
                case '{ID}': return item.id;
                case '{Typ}': return item.type;
                case '{N√°zev}': return item.name;
                case '{Popis}': return item.description;
                case '{P≈ô√≠znaky}': return item.p≈ô√≠znaky;
                case '{Statement}': return generateStatement(item);
                // Zdroj
                case '{Zdroj}': return sourceEl ? sourceEl.name : item.sourceId;
                case '{ZdrojID}': return item.sourceId;
                case '{ZdrojVrstva}': return sourceLayerName;
                case '{ZdrojTyp}': return sourceEl ? sourceEl.type : '';
                case '{ZdrojStereotyp}': return sourceEl ? sourceEl.stereotype : '';
                case '{ZdrojUrƒçuje}': return sourceEl ? sourceEl.urƒçuje : '';
                case '{ZdrojP≈ô√≠znaky}': return sourceEl ? sourceEl.p≈ô√≠znaky : '';
                case '{ZdrojPopis}': return sourceEl ? sourceEl.description : '';
                // C√≠l
                case '{C√≠l}': return targetEl ? targetEl.name : item.targetId;
                case '{C√≠lID}': return item.targetId;
                case '{C√≠lVrstva}': return targetLayerName;
                case '{C√≠lTyp}': return targetEl ? targetEl.type : '';
                case '{C√≠lStereotyp}': return targetEl ? targetEl.stereotype : '';
                case '{C√≠lUrƒçuje}': return targetEl ? targetEl.urƒçuje : '';
                case '{C√≠lP≈ô√≠znaky}': return targetEl ? targetEl.p≈ô√≠znaky : '';
                case '{C√≠lPopis}': return targetEl ? targetEl.description : '';
                default: return '';
            }
        } else if (type === 'task') {
            switch (placeholder) {
                case '{ID}': return item.id;
                case '{ƒå√≠slo}': return item.number;
                case '{N√°zev}': return item.title;
                case '{Stav}': return getTaskStatusLabel(item.status);
                case '{Priorita}': return getTaskPriorityLabel(item.priority);
                case '{≈òe≈°itel}': return item.assignee;
                case '{Zadavatel}': return item.reporter;
                case '{Term√≠n}': return item.dueDate;
                case '{P≈ô√≠znaky}': return (item.tags || []).join(', ');
                case '{Popis}': return item.description;
                case '{Aktu√°ln√≠Stav}': return item.currentState;
                case '{Vytvo≈ôeno}': return item.created ? new Date(item.created).toLocaleDateString() : '';
                case '{Aktualizov√°no}': return item.updated ? new Date(item.updated).toLocaleDateString() : '';
                default: return '';
            }
        } else if (type === 'note') {
            switch (placeholder) {
                case '{ID}': return item.id;
                case '{N√°zev}': return item.name;
                case '{Autor}': return item.author;
                case '{P≈ô√≠znaky}': return (item.tags || []).join(', ');
                case '{Obsah}': return item.content;
                case '{Vytvo≈ôeno}': return item.created ? new Date(item.created).toLocaleDateString() : '';
                case '{Aktualizov√°no}': return item.updated ? new Date(item.updated).toLocaleDateString() : '';
                case '{PoƒçetVerz√≠}': return (item.versions || []).length.toString();
                default: return '';
            }
        } else if (type === 'adr') {
            const selectedAlt = item.alternatives && item.selectedAlternative !== undefined && item.selectedAlternative !== '' 
                ? (item.alternatives[parseInt(item.selectedAlternative)] || {}).title || '' 
                : '';
            
            switch (placeholder) {
                case '{ID}': return item.id;
                case '{ƒå√≠slo}': return item.number;
                case '{N√°zev}': return item.title;
                case '{Stav}': return getAdrStatusLabel(item.status);
                case '{Autor}': return item.author;
                case '{Schvalovatel}': return item.approver;
                case '{Datum}': return item.decisionDate;
                case '{P≈ô√≠znaky}': return (item.tags || []).join(', ');
                case '{Kontext}': return item.context;
                case '{Rozhodnut√≠}': return item.decision;
                case '{D≈Øsledky}': return item.consequences;
                case '{PoƒçetAlternativ}': return (item.alternatives || []).length.toString();
                case '{Vybran√°Alternativa}': return selectedAlt;
                default: return '';
            }
        }
        return '';
    }
    
    function getFilteredElements() {
        const filterLayer = document.getElementById('filter-layer').value;
        const filterType = document.getElementById('filter-type').value;
        const filterStereotype = document.getElementById('filter-stereotype').value;
        const filterP≈ô√≠znaky = document.getElementById('filter-p≈ô√≠znaky').value;
        const searchText = document.getElementById('filter-search').value.toLowerCase().trim();
        
        let filtered = elements;
        
        if (filterLayer) {
            filtered = filtered.filter(e => e.layer === filterLayer);
        }
        if (filterType) {
            filtered = filtered.filter(e => e.type === filterType);
        }
        if (filterStereotype) {
            if (filterStereotype === '__empty__') {
                filtered = filtered.filter(e => !e.stereotype || !e.stereotype.trim());
            } else {
                filtered = filtered.filter(e => e.stereotype === filterStereotype);
            }
        }
        if (filterP≈ô√≠znaky) {
            if (filterP≈ô√≠znaky === '__empty__') {
                filtered = filtered.filter(e => !e.p≈ô√≠znaky || !e.p≈ô√≠znaky.trim());
            } else {
                filtered = filtered.filter(e => {
                    if (!e.p≈ô√≠znaky) return false;
                    const tags = e.p≈ô√≠znaky.split(',').map(t => t.trim());
                    return tags.includes(filterP≈ô√≠znaky);
                });
            }
        }
        if (searchText) {
            filtered = filtered.filter(e => 
                (e.id && e.id.toLowerCase().includes(searchText)) ||
                (e.name && e.name.toLowerCase().includes(searchText)) ||
                (e.description && e.description.toLowerCase().includes(searchText)) ||
                (e.stereotype && e.stereotype.toLowerCase().includes(searchText)) ||
                (e.urƒçuje && e.urƒçuje.toLowerCase().includes(searchText)) ||
                (e.p≈ô√≠znaky && e.p≈ô√≠znaky.toLowerCase().includes(searchText))
            );
        }
        
        return filtered;
    }
    
    function getFilteredRelationships() {
        const filterType = document.getElementById('filter-rel-type').value;
        const filterName = document.getElementById('filter-rel-name').value;
        const filterSource = document.getElementById('filter-rel-source').value;
        const filterTarget = document.getElementById('filter-rel-target').value;
        const filterP≈ô√≠znaky = document.getElementById('filter-rel-p≈ô√≠znaky').value;
        const searchText = document.getElementById('filter-rel-search').value.toLowerCase().trim();
        
        let filtered = relationships;
        
        if (filterType) {
            filtered = filtered.filter(r => r.type === filterType);
        }
        if (filterName) {
            if (filterName === '__empty__') {
                filtered = filtered.filter(r => !r.name || !r.name.trim());
            } else {
                filtered = filtered.filter(r => r.name === filterName);
            }
        }
        if (filterSource) {
            filtered = filtered.filter(r => r.sourceId === filterSource);
        }
        if (filterTarget) {
            filtered = filtered.filter(r => r.targetId === filterTarget);
        }
        if (filterP≈ô√≠znaky) {
            if (filterP≈ô√≠znaky === '__empty__') {
                filtered = filtered.filter(r => !r.p≈ô√≠znaky || !r.p≈ô√≠znaky.trim());
            } else {
                filtered = filtered.filter(r => {
                    if (!r.p≈ô√≠znaky) return false;
                    const tags = r.p≈ô√≠znaky.split(',').map(t => t.trim());
                    return tags.includes(filterP≈ô√≠znaky);
                });
            }
        }
        if (searchText) {
            filtered = filtered.filter(r => {
                const source = elements.find(e => e.id === r.sourceId);
                const target = elements.find(e => e.id === r.targetId);
                const sourceName = source ? source.name : r.sourceId;
                const targetName = target ? target.name : r.targetId;
                const statement = generateStatement(r);
                
                return (r.name && r.name.toLowerCase().includes(searchText)) ||
                       (sourceName && sourceName.toLowerCase().includes(searchText)) ||
                       (targetName && targetName.toLowerCase().includes(searchText)) ||
                       (statement && statement.toLowerCase().includes(searchText)) ||
                       (r.description && r.description.toLowerCase().includes(searchText)) ||
                       (r.p≈ô√≠znaky && r.p≈ô√≠znaky.toLowerCase().includes(searchText));
            });
        }
        
        return filtered;
    }
    
    function copyGeneratedText() {
        const output = document.getElementById('generator-output').value;
        
        if (!output.trim()) {
            alert(t('alertNothingToCopy'));
            return;
        }
        
        navigator.clipboard.writeText(output).then(() => {
            alert(t('alertCopied'));
        }).catch(err => {
            // Fallback
            const textarea = document.getElementById('generator-output');
            textarea.select();
            document.execCommand('copy');
            alert(t('alertCopied'));
        });
    }
    
    function clearGeneratedText() {
        document.getElementById('generator-output').value = '';
        document.getElementById('generator-count').textContent = '0';
    }
    
    function filterElements() {
        renderElementsTable();
    }
    
    function clearElementFilters() {
        document.getElementById('filter-layer').value = '';
        document.getElementById('filter-type').innerHTML = `<option value="">${t('allTypes')}</option>`;
        document.getElementById('filter-stereotype').value = '';
        document.getElementById('filter-p≈ô√≠znaky').value = '';
        document.getElementById('filter-diagram').value = '';
        document.getElementById('filter-search').value = '';
        document.getElementById('element-filter-info').classList.remove('visible');
        updateTypeFilter();
        renderElementsTable();
    }
    
    function sortElements(column) {
        if (elementSortColumn === column) {
            // Toggle direction
            elementSortDirection = elementSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            elementSortColumn = column;
            elementSortDirection = 'asc';
        }
        
        // Update header classes
        document.querySelectorAll('#elements-table .sortable-header').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
            if (th.dataset.column === column) {
                th.classList.add(elementSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
            }
        });
        
        renderElementsTable();
    }
    
    function sortRelationships(column) {
        if (relationshipSortColumn === column) {
            // Toggle direction
            relationshipSortDirection = relationshipSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            relationshipSortColumn = column;
            relationshipSortDirection = 'asc';
        }
        
        // Update header classes
        document.querySelectorAll('#relationships-table .sortable-header').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
            if (th.dataset.column === column) {
                th.classList.add(relationshipSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
            }
        });
        
        renderRelationshipsTable();
    }
    
    function clearRelationshipFilters() {
        document.getElementById('filter-rel-type').value = '';
        document.getElementById('filter-rel-name').value = '';
        document.getElementById('filter-rel-source').value = '';
        document.getElementById('filter-rel-target').value = '';
        document.getElementById('filter-rel-p≈ô√≠znaky').value = '';
        document.getElementById('filter-rel-diagram').value = '';
        document.getElementById('filter-rel-search').value = '';
        document.getElementById('rel-filter-info').classList.remove('visible');
        renderRelationshipsTable();
    }
    
    function filterByElement(elementId) {
        // Switch to relationships tab
        switchTab('relationships');
        
        // Clear other filters first
        document.getElementById('filter-rel-type').value = '';
        document.getElementById('filter-rel-name').value = '';
        document.getElementById('filter-rel-source').value = '';
        document.getElementById('filter-rel-target').value = '';
        document.getElementById('filter-rel-p≈ô√≠znaky').value = '';
        
        // Set search to element name for finding all relationships
        const element = elements.find(e => e.id === elementId);
        const elementName = element ? element.name : elementId;
        
        document.getElementById('filter-rel-search').value = elementName;
        
        // Show info
        const infoDiv = document.getElementById('rel-filter-info');
        document.getElementById('rel-filter-text').textContent = t('relContainingElement', elementName);
        infoDiv.classList.add('visible');
        
        renderRelationshipsTable();
    }
    
    function filterBySource(sourceId) {
        // Clear other filters
        document.getElementById('filter-rel-type').value = '';
        document.getElementById('filter-rel-name').value = '';
        document.getElementById('filter-rel-target').value = '';
        document.getElementById('filter-rel-p≈ô√≠znaky').value = '';
        document.getElementById('filter-rel-search').value = '';
        
        // Set source filter
        updateRelSourceTargetFilters();
        document.getElementById('filter-rel-source').value = sourceId;
        
        // Show info
        const element = elements.find(e => e.id === sourceId);
        const elementName = element ? element.name : sourceId;
        const infoDiv = document.getElementById('rel-filter-info');
        document.getElementById('rel-filter-text').textContent = t('relWithSource', elementName);
        infoDiv.classList.add('visible');
        
        renderRelationshipsTable();
    }
    
    function filterByTarget(targetId) {
        // Clear other filters
        document.getElementById('filter-rel-type').value = '';
        document.getElementById('filter-rel-name').value = '';
        document.getElementById('filter-rel-source').value = '';
        document.getElementById('filter-rel-p≈ô√≠znaky').value = '';
        document.getElementById('filter-rel-search').value = '';
        
        // Set target filter
        updateRelSourceTargetFilters();
        document.getElementById('filter-rel-target').value = targetId;
        
        // Show info
        const element = elements.find(e => e.id === targetId);
        const elementName = element ? element.name : targetId;
        const infoDiv = document.getElementById('rel-filter-info');
        document.getElementById('rel-filter-text').textContent = t('relWithTarget', elementName);
        infoDiv.classList.add('visible');
        
        renderRelationshipsTable();
    }
    
    function updateRelSourceTargetFilters() {
        const sourceFilter = document.getElementById('filter-rel-source');
        const targetFilter = document.getElementById('filter-rel-target');
        
        // Get unique sources and targets from relationships
        const sources = [...new Set(relationships.map(r => r.sourceId))];
        const targets = [...new Set(relationships.map(r => r.targetId))];
        
        // Current values
        const currentSource = sourceFilter.value;
        const currentTarget = targetFilter.value;
        
        // Update source filter
        sourceFilter.innerHTML = `<option value="">${t('allSources')}</option>` +
            sources.map(id => {
                const el = elements.find(e => e.id === id);
                const name = el ? el.name : id;
                return `<option value="${escapeHtml(id)}">${escapeHtml(name)}</option>`;
            }).join('');
        
        // Update target filter
        targetFilter.innerHTML = `<option value="">${t('allTargets')}</option>` +
            targets.map(id => {
                const el = elements.find(e => e.id === id);
                const name = el ? el.name : id;
                return `<option value="${escapeHtml(id)}">${escapeHtml(name)}</option>`;
            }).join('');
        
        // Restore values
        if (currentSource && sources.includes(currentSource)) {
            sourceFilter.value = currentSource;
        }
        if (currentTarget && targets.includes(currentTarget)) {
            targetFilter.value = currentTarget;
        }
    }
    
    function updateTypeFilter() {
        const layerFilter = document.getElementById('filter-layer').value;
        const typeSelect = document.getElementById('filter-type');
        
        typeSelect.innerHTML = `<option value="">${t('allTypes')}</option>`;
        
        if (layerFilter && ARCHIMATE_LAYERS[layerFilter]) {
            const layer = ARCHIMATE_LAYERS[layerFilter];
            for (const type of Object.keys(layer.elements)) {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeSelect.appendChild(option);
            }
        } else {
            // All types from all layers
            const allTypes = new Set();
            for (const layer of Object.values(ARCHIMATE_LAYERS)) {
                for (const type of Object.keys(layer.elements)) {
                    allTypes.add(type);
                }
            }
            Array.from(allTypes).sort().forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeSelect.appendChild(option);
            });
        }
    }
    
    function renderElementsTable() {
        const tbody = document.getElementById('elements-tbody');
        const filterLayer = document.getElementById('filter-layer').value;
        const filterType = document.getElementById('filter-type').value;
        const filterStereotype = document.getElementById('filter-stereotype').value;
        const filterP≈ô√≠znaky = document.getElementById('filter-p≈ô√≠znaky').value;
        const filterDiagram = document.getElementById('filter-diagram').value;
        const searchText = document.getElementById('filter-search').value.toLowerCase().trim();
        
        let filteredElements = elements;
        
        // Filter by layer
        if (filterLayer) {
            filteredElements = filteredElements.filter(e => e.layer === filterLayer);
        }
        
        // Filter by type
        if (filterType) {
            filteredElements = filteredElements.filter(e => e.type === filterType);
        }
        
        // Filter by stereotype
        if (filterStereotype) {
            if (filterStereotype === '__empty__') {
                filteredElements = filteredElements.filter(e => !e.stereotype || !e.stereotype.trim());
            } else {
                filteredElements = filteredElements.filter(e => e.stereotype === filterStereotype);
            }
        }
        
        // Filter by p≈ô√≠znaky (check if element has this tag)
        if (filterP≈ô√≠znaky) {
            if (filterP≈ô√≠znaky === '__empty__') {
                filteredElements = filteredElements.filter(e => !e.p≈ô√≠znaky || !e.p≈ô√≠znaky.trim());
            } else {
                filteredElements = filteredElements.filter(e => {
                    if (!e.p≈ô√≠znaky) return false;
                    const tags = e.p≈ô√≠znaky.split(',').map(t => t.trim());
                    return tags.includes(filterP≈ô√≠znaky);
                });
            }
        }
        
        // Filter by diagram
        if (filterDiagram) {
            const diagram = diagrams.find(d => d.id === filterDiagram);
            if (diagram && diagram.elementIds) {
                filteredElements = filteredElements.filter(e => diagram.elementIds.includes(e.id));
            } else {
                filteredElements = [];
            }
        }
        
        // Search in ID, name, description, stereotype, urƒçuje, p≈ô√≠znaky
        if (searchText) {
            filteredElements = filteredElements.filter(e => 
                (e.id && e.id.toLowerCase().includes(searchText)) ||
                (e.name && e.name.toLowerCase().includes(searchText)) ||
                (e.description && e.description.toLowerCase().includes(searchText)) ||
                (e.stereotype && e.stereotype.toLowerCase().includes(searchText)) ||
                (e.urƒçuje && e.urƒçuje.toLowerCase().includes(searchText)) ||
                (e.p≈ô√≠znaky && e.p≈ô√≠znaky.toLowerCase().includes(searchText))
            );
        }
        
        // Sort
        filteredElements = [...filteredElements].sort((a, b) => {
            let valA, valB;
            
            switch (elementSortColumn) {
                case 'id':
                    valA = a.id || '';
                    valB = b.id || '';
                    break;
                case 'layer':
                    valA = ARCHIMATE_LAYERS[a.layer] ? ARCHIMATE_LAYERS[a.layer].name : a.layer;
                    valB = ARCHIMATE_LAYERS[b.layer] ? ARCHIMATE_LAYERS[b.layer].name : b.layer;
                    break;
                case 'type':
                    valA = a.type || '';
                    valB = b.type || '';
                    break;
                case 'stereotype':
                    valA = a.stereotype || '';
                    valB = b.stereotype || '';
                    break;
                case 'name':
                    valA = a.name || '';
                    valB = b.name || '';
                    break;
                case 'urƒçuje':
                    valA = a.urƒçuje || '';
                    valB = b.urƒçuje || '';
                    break;
                case 'p≈ô√≠znaky':
                    valA = a.p≈ô√≠znaky || '';
                    valB = b.p≈ô√≠znaky || '';
                    break;
                default:
                    valA = a.id || '';
                    valB = b.id || '';
            }
            
            const comparison = valA.localeCompare(valB, 'cs');
            return elementSortDirection === 'asc' ? comparison : -comparison;
        });
        
        // Show count
        const countInfo = document.createElement('div');
        countInfo.className = 'filter-count';
        countInfo.textContent = t('showingOf', filteredElements.length, elements.length) + ' ' + t('elementsCount').toLowerCase();
        
        const container = document.getElementById('elements-table-container');
        const existingCount = container.querySelector('.filter-count');
        if (existingCount) existingCount.remove();
        container.insertBefore(countInfo, container.firstChild);
        
        if (filteredElements.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="no-data">' + t('noElements') + '</td></tr>';
            updateElementsBulkPanel();
            return;
        }
        
        tbody.innerHTML = filteredElements.map(e => {
            const layerInfo = ARCHIMATE_LAYERS[e.layer];
            const layerName = layerInfo ? layerInfo.name : e.layer;
            // Count relationships for this element
            const relCount = relationships.filter(r => r.sourceId === e.id || r.targetId === e.id).length;
            const nameTitle = relCount > 0 ? (currentLanguage === 'cs' ? `Zobrazit ${relCount} vazeb tohoto prvku` : `Show ${relCount} relationships of this element`) : (currentLanguage === 'cs' ? 'Tento prvek nem√° ≈æ√°dn√© vazby' : 'This element has no relationships');
            
            // Description on second line
            const descriptionHtml = e.description ? `<br><small style="color:#666;">${escapeHtml(e.description)}</small>` : '';
            const stereotypePrefix = e.stereotype ? `<span style="color:#666;">¬´${escapeHtml(e.stereotype)}¬ª</span> ` : '';
            
            // Find diagrams containing this element
            const elementDiagrams = diagrams.filter(d => d.elementIds.includes(e.id));
            const diagramsHtml = elementDiagrams.length > 0 
                ? elementDiagrams.map(d => `<a href="#" class="element-link" onclick="openDiagramEditor('${escapeHtml(d.id)}'); return false;">${escapeHtml(d.name)}</a>`).join(', ')
                : '-';
            
            return `
                <tr>
                    <td><input type="checkbox" class="element-checkbox" value="${escapeHtml(e.id)}" onchange="updateElementsBulkPanel()"></td>
                    <td><code>${escapeHtml(e.id)}</code></td>
                    <td><span class="layer-badge layer-${e.layer}">${escapeHtml(layerName)}</span></td>
                    <td>${escapeHtml(e.type)}</td>
                    <td>${stereotypePrefix}<a href="#tab-relationships" class="element-link" onclick="filterByElement('${escapeHtml(e.id)}'); return false;" title="${escapeHtml(nameTitle)}">${escapeHtml(e.name)}</a>${relCount > 0 ? ` <small>(${relCount})</small>` : ''}${descriptionHtml}</td>
                    <td>${escapeHtml(e.urƒçuje || '-')}</td>
                    <td>${escapeHtml(e.p≈ô√≠znaky || '-')}</td>
                    <td>${diagramsHtml}</td>
                    <td class="actions">
                        <button type="button" class="btn-secondary" onclick="editElement('${escapeHtml(e.id)}')">${t('edit')}</button>
                        <button type="button" class="btn-secondary" onclick="duplicateElement('${escapeHtml(e.id)}')" title="${t('duplicate')}">üìã</button>
                        <button type="button" class="btn-danger" onclick="deleteElement('${escapeHtml(e.id)}')">${t('delete')}</button>
                    </td>
                </tr>
            `;
        }).join('');
        
        updateElementsBulkPanel();
    }

    // ============================================
    // Relationship Management
    // ============================================
    
    function populateElementSelects() {
        // This function is now replaced by cascade selects
        updateRelNameSuggestions();
    }
    
    function updateSourceTypes() {
        const layer = document.getElementById('rel-source-layer').value;
        const typeSelect = document.getElementById('rel-source-type');
        const elementSelect = document.getElementById('rel-source');
        
        typeSelect.innerHTML = `<option value="">${t('selectTypeShort')}</option>`;
        elementSelect.innerHTML = `<option value="">${t('selectElementShort')}</option>`;
        
        if (layer && ARCHIMATE_LAYERS[layer]) {
            // Get types that have elements in this layer
            const typesWithElements = new Set(
                elements.filter(e => e.layer === layer).map(e => e.type)
            );
            
            for (const type of Object.keys(ARCHIMATE_LAYERS[layer].elements)) {
                if (typesWithElements.has(type)) {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    typeSelect.appendChild(option);
                }
            }
        }
        
        updateAllowedRelationships();
        updateRelationshipId();
    }
    
    function updateSourceElements() {
        const layer = document.getElementById('rel-source-layer').value;
        const type = document.getElementById('rel-source-type').value;
        const elementSelect = document.getElementById('rel-source');
        
        elementSelect.innerHTML = `<option value="">${t('selectElementShort')}</option>`;
        
        const filtered = elements.filter(e => 
            (!layer || e.layer === layer) && 
            (!type || e.type === type)
        );
        
        filtered.forEach(e => {
            const option = document.createElement('option');
            option.value = e.id;
            const stereotypePart = e.stereotype ? `, ¬´${e.stereotype}¬ª` : '';
            option.textContent = `${e.name}${stereotypePart} [${e.id}]`;
            elementSelect.appendChild(option);
        });
        
        updateSelectOriginalOptions('rel-source');
        updateAllowedRelationships();
        updateRelationshipId();
    }
    
    function updateTargetTypes() {
        const layer = document.getElementById('rel-target-layer').value;
        const typeSelect = document.getElementById('rel-target-type');
        const elementSelect = document.getElementById('rel-target');
        
        typeSelect.innerHTML = `<option value="">${t('selectTypeShort')}</option>`;
        elementSelect.innerHTML = `<option value="">${t('selectElementShort')}</option>`;
        
        if (layer && ARCHIMATE_LAYERS[layer]) {
            const typesWithElements = new Set(
                elements.filter(e => e.layer === layer).map(e => e.type)
            );
            
            for (const type of Object.keys(ARCHIMATE_LAYERS[layer].elements)) {
                if (typesWithElements.has(type)) {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    typeSelect.appendChild(option);
                }
            }
        }
        
        updateAllowedRelationships();
        updateRelationshipId();
    }
    
    function updateTargetElements() {
        const layer = document.getElementById('rel-target-layer').value;
        const type = document.getElementById('rel-target-type').value;
        const elementSelect = document.getElementById('rel-target');
        const sourceId = document.getElementById('rel-source').value;
        
        elementSelect.innerHTML = `<option value="">${t('selectElementShort')}</option>`;
        
        // Get IDs of elements that already have a relationship from selected source
        const existingTargetIds = new Set();
        if (sourceId && !editingRelationshipId) {
            // Only filter when creating new relationship, not when editing
            relationships.forEach(r => {
                if (r.sourceId === sourceId) {
                    existingTargetIds.add(r.targetId);
                }
            });
        }
        
        const filtered = elements.filter(e => 
            (!layer || e.layer === layer) && 
            (!type || e.type === type) &&
            !existingTargetIds.has(e.id)
        );
        
        filtered.forEach(e => {
            const option = document.createElement('option');
            option.value = e.id;
            const stereotypePart = e.stereotype ? `, ¬´${e.stereotype}¬ª` : '';
            option.textContent = `${e.name}${stereotypePart} [${e.id}]`;
            elementSelect.appendChild(option);
        });
        
        updateSelectOriginalOptions('rel-target');
        updateAllowedRelationships();
        updateRelationshipId();
    }
    
    function updateRelNameSuggestions() {
        const datalist = document.getElementById('rel-name-suggestions');
        const existingNames = [...new Set(relationships.map(r => r.name).filter(n => n && n.trim()))];
        
        datalist.innerHTML = existingNames.map(name => 
            `<option value="${escapeHtml(name)}">`
        ).join('');
        
        // Also update filter dropdown
        updateRelNameFilter();
    }
    
    function updateRelNameFilter() {
        const filterSelect = document.getElementById('filter-rel-name');
        const currentValue = filterSelect.value;
        const existingNames = [...new Set(relationships.map(r => r.name).filter(n => n && n.trim()))].sort();
        
        filterSelect.innerHTML = `<option value="">${t('allNames')}</option>` +
            `<option value="__empty__">${t('unnamed')}</option>` +
            existingNames.map(name => 
                `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`
            ).join('');
        
        // Restore selection if still valid
        if (currentValue && (currentValue === '__empty__' || existingNames.includes(currentValue))) {
            filterSelect.value = currentValue;
        }
    }
    
    function updateStatementPreview() {
        const sourceId = document.getElementById('rel-source').value;
        const targetId = document.getElementById('rel-target').value;
        const relType = document.getElementById('rel-type').value;
        const relName = document.getElementById('rel-name').value.trim();
        
        const previewDiv = document.getElementById('statement-preview');
        const statementText = document.getElementById('statement-text');
        
        if (sourceId && targetId && relType) {
            const source = elements.find(e => e.id === sourceId);
            const target = elements.find(e => e.id === targetId);
            const relInfo = RELATIONSHIP_TYPES[relType];
            
            if (source && target) {
                const verb = relName || (relInfo ? relInfo.verb : relType);
                statementText.textContent = `${source.name} ${verb} ${target.name}`;
                previewDiv.style.display = 'block';
                return;
            }
        }
        
        previewDiv.style.display = 'none';
    }
    
    function generateStatement(rel) {
        const source = elements.find(e => e.id === rel.sourceId);
        const target = elements.find(e => e.id === rel.targetId);
        const relInfo = RELATIONSHIP_TYPES[rel.type];
        
        if (source && target) {
            const verb = rel.name || (relInfo ? relInfo.verb : rel.type);
            const sourcePrefix = source.stereotype ? `¬´${source.stereotype}¬ª ` : '';
            const targetPrefix = target.stereotype ? `¬´${target.stereotype}¬ª ` : '';
            return `${sourcePrefix}${source.name} ${verb} ${targetPrefix}${target.name}`;
        }
        return '-';
    }
    
    function updateAllowedRelationships() {
        const sourceId = document.getElementById('rel-source').value;
        const targetId = document.getElementById('rel-target').value;
        const typeSelect = document.getElementById('rel-type');
        const infoDiv = document.getElementById('relationship-info');
        
        if (!sourceId || !targetId) {
            typeSelect.innerHTML = `<option value="">${t('selectBothElements')}</option>`;
            infoDiv.style.display = 'none';
            updateStatementPreview();
            return;
        }
        
        const sourceElement = elements.find(e => e.id === sourceId);
        const targetElement = elements.find(e => e.id === targetId);
        
        if (!sourceElement || !targetElement) {
            typeSelect.innerHTML = `<option value="">${t('elementsNotFound')}</option>`;
            return;
        }
        
        const sourceType = sourceElement.type;
        const targetType = targetElement.type;
        
        let allowedRels = [];
        
        if (RELATIONSHIP_RULES[sourceType]) {
            if (RELATIONSHIP_RULES[sourceType][targetType]) {
                allowedRels = RELATIONSHIP_RULES[sourceType][targetType];
            } else if (RELATIONSHIP_RULES[sourceType]["default"]) {
                allowedRels = RELATIONSHIP_RULES[sourceType]["default"];
            }
        }
        
        if (!allowedRels.includes("Association")) {
            allowedRels.push("Association");
        }
        
        allowedRels = [...new Set(allowedRels)].sort();
        
        typeSelect.innerHTML = `<option value="">${t('selectRelationshipType')}</option>` + 
            allowedRels.map(rel => {
                const relInfo = RELATIONSHIP_TYPES[rel];
                return `<option value="${rel}">${rel} (${relInfo ? relInfo.notation : ''})</option>`;
            }).join('');
        
        infoDiv.innerHTML = `<strong>${t('allowedRelationships')}:</strong> ${sourceType} ‚Üí ${targetType}<br>
            ${t('foundAllowedTypes', allowedRels.length)}`;
        infoDiv.style.display = 'block';
        
        updateStatementPreview();
    }
    
    function updateRelationshipId() {
        const sourceId = document.getElementById('rel-source').value;
        const targetId = document.getElementById('rel-target').value;
        const idInput = document.getElementById('rel-id');
        
        if (sourceId && targetId) {
            idInput.value = sourceId + targetId;
        } else {
            idInput.value = '';
        }
        
        updateStatementPreview();
    }
    
    function saveRelationship() {
        const sourceId = document.getElementById('rel-source').value;
        const targetId = document.getElementById('rel-target').value;
        const type = document.getElementById('rel-type').value;
        const name = document.getElementById('rel-name').value.trim();
        const description = document.getElementById('rel-description').value.trim();
        const p≈ô√≠znaky = document.getElementById('rel-p≈ô√≠znaky').value.trim();
        
        if (!sourceId || !targetId || !type) {
            alert(t('fillRelationshipRequired'));
            return;
        }
        
        // Generate ID automatically
        const id = sourceId + targetId;
        
        // Check for duplicate ID (except when editing same relationship)
        const existingIndex = relationships.findIndex(r => r.id === id);
        if (existingIndex !== -1 && relationships[existingIndex].id !== editingRelationshipId) {
            alert(t('relationshipExists', id));
            return;
        }
        
        const relationship = { id, sourceId, targetId, type, name, description, p≈ô√≠znaky };
        
        if (editingRelationshipId) {
            const index = relationships.findIndex(r => r.id === editingRelationshipId);
            if (index !== -1) {
                relationships[index] = relationship;
            }
            editingRelationshipId = null;
            document.getElementById('relationship-form-title').textContent = t('newRelationship');
        } else {
            relationships.push(relationship);
        }
        
        // Ponechat zdroj, typ vazby a dal≈°√≠, jen resetovat c√≠l
        editingRelationshipId = null;
        document.getElementById('relationship-form-title').textContent = t('newRelationship');
        document.getElementById('rel-id').value = '';
        // Resetovat jen c√≠l, nechat zdroj
        document.getElementById('rel-target-layer').value = '';
        document.getElementById('rel-target-type').innerHTML = `<option value="">${t('selectTypeShort')}</option>`;
        document.getElementById('rel-target').innerHTML = `<option value="">${t('selectElementShort')}</option>`;
        document.getElementById('rel-type').innerHTML = `<option value="">${t('selectElements')}</option>`;
        document.getElementById('relationship-info').style.display = 'none';
        document.getElementById('statement-preview').style.display = 'none';
        
        // Aktualizovat seznamy prvk≈Ø v dropdownech
        updateTargetElements();
        updateRelNameSuggestions();
        updateP≈ô√≠znakySuggestions();
        updateP≈ô√≠znakyFilters();
        updateRelSourceTargetFilters();
        
        renderRelationshipsTable();
        renderElementsTable(); // Update element counts
        updateModelStats();
        saveToLocalStorage();
    }
    
    function editRelationship(id) {
        const rel = relationships.find(r => r.id === id);
        if (!rel) return;
        
        editingRelationshipId = id;
        document.getElementById('relationship-form-title').textContent = 'Editace vazby';
        
        // Find source element and set cascade
        const sourceEl = elements.find(e => e.id === rel.sourceId);
        if (sourceEl) {
            document.getElementById('rel-source-layer').value = sourceEl.layer;
            updateSourceTypes();
            document.getElementById('rel-source-type').value = sourceEl.type;
            updateSourceElements();
            document.getElementById('rel-source').value = rel.sourceId;
        }
        
        // Find target element and set cascade
        const targetEl = elements.find(e => e.id === rel.targetId);
        if (targetEl) {
            document.getElementById('rel-target-layer').value = targetEl.layer;
            updateTargetTypes();
            document.getElementById('rel-target-type').value = targetEl.type;
            updateTargetElements();
            document.getElementById('rel-target').value = rel.targetId;
        }
        
        updateAllowedRelationships();
        document.getElementById('rel-type').value = rel.type;
        document.getElementById('rel-name').value = rel.name || '';
        document.getElementById('rel-description').value = rel.description || '';
        document.getElementById('rel-p≈ô√≠znaky').value = rel.p≈ô√≠znaky || '';
        updateStatementPreview();
        
        
        // Scroll to form
        document.getElementById('relationship-form-title').scrollIntoView({ behavior: 'smooth' });
    }
    
    function duplicateRelationship(id) {
        const original = relationships.find(r => r.id === id);
        if (!original) return;
        
        // Clear form and set as new relationship (not editing)
        editingRelationshipId = null;
        document.getElementById('relationship-form-title').textContent = t('relationshipCopy');
        document.getElementById('rel-id').value = ''; // Will be generated on save
        
        // Find source element and set cascade
        const sourceEl = elements.find(e => e.id === original.sourceId);
        if (sourceEl) {
            document.getElementById('rel-source-layer').value = sourceEl.layer;
            updateSourceTypes();
            document.getElementById('rel-source-type').value = sourceEl.type;
            updateSourceElements();
            document.getElementById('rel-source').value = original.sourceId;
        }
        
        // Find target element and set cascade
        const targetEl = elements.find(e => e.id === original.targetId);
        if (targetEl) {
            document.getElementById('rel-target-layer').value = targetEl.layer;
            updateTargetTypes();
            document.getElementById('rel-target-type').value = targetEl.type;
            updateTargetElements();
            document.getElementById('rel-target').value = original.targetId;
        }
        
        updateAllowedRelationships();
        document.getElementById('rel-type').value = original.type;
        document.getElementById('rel-name').value = original.name || '';
        document.getElementById('rel-description').value = original.description || '';
        document.getElementById('rel-p≈ô√≠znaky').value = original.p≈ô√≠znaky || '';
        updateStatementPreview();
        
        switchTab('relationships');
        document.getElementById('relationship-form-title').scrollIntoView({ behavior: 'smooth' });
    }
    
    function deleteRelationship(id) {
        if (!confirm(t('confirmDeleteRelationship'))) {
            return;
        }
        
        relationships = relationships.filter(r => r.id !== id);
        renderRelationshipsTable();
        renderElementsTable(); // Update element counts
        updateRelSourceTargetFilters();
        updateRelNameSuggestions();
        updateModelStats();
        saveToLocalStorage();
        
    }
    
    function clearRelationshipForm() {
        editingRelationshipId = null;
        document.getElementById('relationship-form-title').textContent = t('newRelationship');
        document.getElementById('rel-id').value = '';
        document.getElementById('rel-source-layer').value = '';
        document.getElementById('rel-source-type').innerHTML = `<option value="">${t('selectTypeShort')}</option>`;
        document.getElementById('rel-source').innerHTML = `<option value="">${t('selectElementShort')}</option>`;
        document.getElementById('rel-target-layer').value = '';
        document.getElementById('rel-target-type').innerHTML = `<option value="">${t('selectTypeShort')}</option>`;
        document.getElementById('rel-target').innerHTML = `<option value="">${t('selectElementShort')}</option>`;
        document.getElementById('rel-type').innerHTML = `<option value="">${t('selectElements')}</option>`;
        document.getElementById('rel-name').value = '';
        document.getElementById('rel-description').value = '';
        document.getElementById('rel-p≈ô√≠znaky').value = '';
        document.getElementById('relationship-info').style.display = 'none';
        document.getElementById('statement-preview').style.display = 'none';
        updateRelNameSuggestions();
        updateRelSourceTargetFilters();
    }
    
    function filterRelationships() {
        renderRelationshipsTable();
    }
    
    function renderRelationshipsTable() {
        const tbody = document.getElementById('relationships-tbody');
        const filterType = document.getElementById('filter-rel-type').value;
        const filterName = document.getElementById('filter-rel-name').value;
        const filterSource = document.getElementById('filter-rel-source').value;
        const filterTarget = document.getElementById('filter-rel-target').value;
        const filterP≈ô√≠znaky = document.getElementById('filter-rel-p≈ô√≠znaky').value;
        const filterDiagram = document.getElementById('filter-rel-diagram').value;
        const searchText = document.getElementById('filter-rel-search').value.toLowerCase().trim();
        
        let filteredRelationships = relationships;
        
        // Filter by type
        if (filterType) {
            filteredRelationships = filteredRelationships.filter(r => r.type === filterType);
        }
        
        // Filter by name
        if (filterName) {
            if (filterName === '__empty__') {
                filteredRelationships = filteredRelationships.filter(r => !r.name || !r.name.trim());
            } else {
                filteredRelationships = filteredRelationships.filter(r => r.name === filterName);
            }
        }
        
        // Filter by source
        if (filterSource) {
            filteredRelationships = filteredRelationships.filter(r => r.sourceId === filterSource);
        }
        
        // Filter by target
        if (filterTarget) {
            filteredRelationships = filteredRelationships.filter(r => r.targetId === filterTarget);
        }
        
        // Filter by p≈ô√≠znaky (check if relationship has this tag)
        if (filterP≈ô√≠znaky) {
            if (filterP≈ô√≠znaky === '__empty__') {
                filteredRelationships = filteredRelationships.filter(r => !r.p≈ô√≠znaky || !r.p≈ô√≠znaky.trim());
            } else {
                filteredRelationships = filteredRelationships.filter(r => {
                    if (!r.p≈ô√≠znaky) return false;
                    const tags = r.p≈ô√≠znaky.split(',').map(t => t.trim());
                    return tags.includes(filterP≈ô√≠znaky);
                });
            }
        }
        
        // Filter by diagram (show relationships where both source and target are in diagram)
        if (filterDiagram) {
            const diagram = diagrams.find(d => d.id === filterDiagram);
            if (diagram && diagram.elementIds) {
                filteredRelationships = filteredRelationships.filter(r => 
                    diagram.elementIds.includes(r.sourceId) && diagram.elementIds.includes(r.targetId)
                );
            } else {
                filteredRelationships = [];
            }
        }
        
        // Search in name, source, target, statement, description, p≈ô√≠znaky
        if (searchText) {
            filteredRelationships = filteredRelationships.filter(r => {
                const source = elements.find(e => e.id === r.sourceId);
                const target = elements.find(e => e.id === r.targetId);
                const sourceName = source ? source.name : r.sourceId;
                const targetName = target ? target.name : r.targetId;
                const statement = generateStatement(r);
                
                return (r.name && r.name.toLowerCase().includes(searchText)) ||
                       (sourceName && sourceName.toLowerCase().includes(searchText)) ||
                       (targetName && targetName.toLowerCase().includes(searchText)) ||
                       (statement && statement.toLowerCase().includes(searchText)) ||
                       (r.description && r.description.toLowerCase().includes(searchText)) ||
                       (r.p≈ô√≠znaky && r.p≈ô√≠znaky.toLowerCase().includes(searchText));
            });
        }
        
        // Sort
        filteredRelationships = [...filteredRelationships].sort((a, b) => {
            let valA, valB;
            
            switch (relationshipSortColumn) {
                case 'id':
                    valA = a.id || '';
                    valB = b.id || '';
                    break;
                case 'source':
                    const srcA = elements.find(e => e.id === a.sourceId);
                    const srcB = elements.find(e => e.id === b.sourceId);
                    valA = srcA ? srcA.name : a.sourceId;
                    valB = srcB ? srcB.name : b.sourceId;
                    break;
                case 'target':
                    const tgtA = elements.find(e => e.id === a.targetId);
                    const tgtB = elements.find(e => e.id === b.targetId);
                    valA = tgtA ? tgtA.name : a.targetId;
                    valB = tgtB ? tgtB.name : b.targetId;
                    break;
                case 'type':
                    valA = a.type || '';
                    valB = b.type || '';
                    break;
                case 'name':
                    valA = a.name || '';
                    valB = b.name || '';
                    break;
                case 'p≈ô√≠znaky':
                    valA = a.p≈ô√≠znaky || '';
                    valB = b.p≈ô√≠znaky || '';
                    break;
                default:
                    valA = a.id || '';
                    valB = b.id || '';
            }
            
            const comparison = valA.localeCompare(valB, 'cs');
            return relationshipSortDirection === 'asc' ? comparison : -comparison;
        });
        
        // Show count
        const countInfo = document.createElement('div');
        countInfo.className = 'filter-count';
        countInfo.textContent = t('showingOf', filteredRelationships.length, relationships.length) + ' ' + t('relationshipsCount').toLowerCase();
        
        const container = document.getElementById('relationships-table-container');
        const existingCount = container.querySelector('.filter-count');
        if (existingCount) existingCount.remove();
        container.insertBefore(countInfo, container.firstChild);
        
        if (filteredRelationships.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="no-data">' + t('noRelationships') + '</td></tr>';
            updateRelationshipsBulkPanel();
            return;
        }
        
        tbody.innerHTML = filteredRelationships.map(r => {
            const source = elements.find(e => e.id === r.sourceId);
            const target = elements.find(e => e.id === r.targetId);
            const relInfo = RELATIONSHIP_TYPES[r.type];
            const statement = generateStatement(r);
            
            const sourceStereotype = source && source.stereotype ? `<span style="color:#666;">¬´${escapeHtml(source.stereotype)}¬ª</span> ` : '';
            const targetStereotype = target && target.stereotype ? `<span style="color:#666;">¬´${escapeHtml(target.stereotype)}¬ª</span> ` : '';
            const sourceName = source ? source.name : r.sourceId;
            const targetName = target ? target.name : r.targetId;
            
            // Description on second line in statement cell
            const descriptionHtml = r.description ? `<br><small style="color:#666;">${escapeHtml(r.description)}</small>` : '';
            
            // Find diagrams containing this relationship (both source and target must be on diagram)
            const relDiagrams = diagrams.filter(d => 
                d.elementIds.includes(r.sourceId) && d.elementIds.includes(r.targetId)
            );
            const diagramsHtml = relDiagrams.length > 0 
                ? relDiagrams.map(d => `<a href="#" class="element-link" onclick="openDiagramEditor('${escapeHtml(d.id)}'); return false;">${escapeHtml(d.name)}</a>`).join(', ')
                : '-';
            
            return `
                <tr>
                    <td><input type="checkbox" class="relationship-checkbox" value="${escapeHtml(r.id)}" onchange="updateRelationshipsBulkPanel()"></td>
                    <td>${sourceStereotype}<a href="#" class="element-link" onclick="filterBySource('${escapeHtml(r.sourceId)}'); return false;" title="${currentLanguage === 'cs' ? 'Zobrazit vazby s t√≠mto zdrojem' : 'Show relationships with this source'}">${escapeHtml(sourceName)}</a></td>
                    <td><strong>${escapeHtml(r.type)}</strong> ${relInfo ? `(${relInfo.notation})` : ''}</td>
                    <td>${escapeHtml(r.name || '-')}</td>
                    <td>${targetStereotype}<a href="#" class="element-link" onclick="filterByTarget('${escapeHtml(r.targetId)}'); return false;" title="${currentLanguage === 'cs' ? 'Zobrazit vazby s t√≠mto c√≠lem' : 'Show relationships with this target'}">${escapeHtml(targetName)}</a></td>
                    <td><em>${escapeHtml(statement)}</em>${descriptionHtml}</td>
                    <td>${escapeHtml(r.p≈ô√≠znaky || '-')}</td>
                    <td>${diagramsHtml}</td>
                    <td class="actions">
                        <button type="button" class="btn-secondary" onclick="editRelationship('${escapeHtml(r.id)}')">${t('edit')}</button>
                        <button type="button" class="btn-secondary" onclick="duplicateRelationship('${escapeHtml(r.id)}')" title="${t('duplicate')}">üìã</button>
                        <button type="button" class="btn-danger" onclick="deleteRelationship('${escapeHtml(r.id)}')">${t('delete')}</button>
                    </td>
                </tr>
            `;
        }).join('');
        
        updateRelationshipsBulkPanel();
    }

    // ============================================
    // Export Functions
    // ============================================
    
    function exportJSON() {
        const data = {
            exportDate: new Date().toISOString(),
            archimateVersion: "3.2",
            model: modelMetadata,
            elements: elements,
            relationships: relationships,
            diagrams: diagrams,
            adr: adrRecords,
            notes: notes,
            tasks: tasks
        };
        
        const json = JSON.stringify(data, null, 2);
        document.getElementById('export-preview').textContent = json;
        
        downloadFile(json, `${modelMetadata.name || 'archimate-model'}.ajx`, 'application/json');
    }
    
    function copyJSONToClipboard() {
        const data = {
            exportDate: new Date().toISOString(),
            archimateVersion: "3.2",
            model: modelMetadata,
            elements: elements,
            relationships: relationships,
            diagrams: diagrams,
            adr: adrRecords,
            notes: notes,
            tasks: tasks
        };
        
        const json = JSON.stringify(data, null, 2);
        document.getElementById('export-preview').textContent = json;
        
        navigator.clipboard.writeText(json).then(() => {
            alert(t('alertCopied'));
        }).catch(err => {
            // Fallback for older browsers
            const textarea = document.createElement('textarea');
            textarea.value = json;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                alert(t('alertCopied'));
            } catch (e) {
                alert(t('copyFailed'));
            }
            document.body.removeChild(textarea);
        });
    }
    
    function pasteFromClipboard() {
        // Try modern clipboard API first
        if (navigator.clipboard && navigator.clipboard.readText) {
            navigator.clipboard.readText().then(text => {
                if (text && text.trim()) {
                    document.getElementById('import-data').value = text;
                } else {
                    // Empty clipboard, show modal
                    showClipboardModal();
                }
            }).catch(err => {
                // Clipboard API failed (permissions denied, mobile, etc.)
                showClipboardModal();
            });
        } else {
            // Clipboard API not available
            showClipboardModal();
        }
    }
    
    function showClipboardModal() {
        const modal = document.getElementById('clipboard-paste-modal');
        const textarea = document.getElementById('clipboard-paste-textarea');
        textarea.value = '';
        modal.style.display = 'flex';
        
        // Focus textarea for immediate paste
        setTimeout(() => textarea.focus(), 100);
        
        // Update translations
        applyTranslations();
    }
    
    function closeClipboardModal() {
        document.getElementById('clipboard-paste-modal').style.display = 'none';
    }
    
    function confirmClipboardPaste() {
        const textarea = document.getElementById('clipboard-paste-textarea');
        const content = textarea.value.trim();
        
        if (content) {
            document.getElementById('import-data').value = content;
            closeClipboardModal();
        } else {
            alert(t('pasteDataToImport'));
        }
    }
    
    // Close modal on backdrop click
    document.getElementById('clipboard-paste-modal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeClipboardModal();
        }
    });
    
    function exportCSV() {
        let csv = `# Model: ${modelMetadata.name || 'ArchiMate Model'}\n`;
        csv += `# Version: ${modelMetadata.version || '-'}\n\n`;
        
        csv += 'Elements:\nID,Layer,Type,Name,Description\n';
        elements.forEach(e => {
            csv += `"${e.id}","${e.layer}","${e.type}","${e.name}","${e.description || ''}"\n`;
        });
        
        csv += '\nRelationships:\nID,SourceID,TargetID,Type,Name\n';
        relationships.forEach(r => {
            csv += `"${r.id}","${r.sourceId}","${r.targetId}","${r.type}","${r.name || ''}"\n`;
        });
        
        document.getElementById('export-preview').textContent = csv;
        
        downloadFile(csv, `${modelMetadata.name || 'archimate-model'}.csv`, 'text/csv');
    }
    
    function exportArchiMateXML() {
        const xml = generateArchiMateXML();
        document.getElementById('export-preview').textContent = xml;
        
        downloadFile(xml, `${modelMetadata.name || 'archimate-model'}.xml`, 'application/xml');
    }
    
    function generateArchiMateXML() {
        const dc = modelMetadata.dublinCore || {};
        const hasDublinCore = dc.creator || dc.publisher || dc.date || dc.rights || dc.subject || dc.description;
        
        // Determine property definition IDs
        // Use imported IDs if available, otherwise use propid-1, propid-2, propid-3
        let stereotypePropId = 'propid-1';
        let urƒçujePropId = 'propid-2';
        let p≈ô√≠znakyPropId = 'propid-3';
        
        if (modelMetadata.importedPropertyDefs) {
            // Find imported IDs by property name
            for (const [id, def] of Object.entries(modelMetadata.importedPropertyDefs)) {
                if (def.name.toLowerCase() === 'stereotype') {
                    stereotypePropId = id;
                } else if (def.name === 'Urƒçuje' || def.name.toLowerCase() === 'urƒçuje') {
                    urƒçujePropId = id;
                } else if (def.name === 'P≈ô√≠znaky' || def.name.toLowerCase() === 'p≈ô√≠znaky') {
                    p≈ô√≠znakyPropId = id;
                }
            }
        }
        
        let xml = `<?xml version="1.0" encoding="UTF-8"?>
<model xmlns="http://www.opengroup.org/xsd/archimate/3.0/"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"${hasDublinCore ? '\n       xmlns:dc="http://purl.org/dc/elements/1.1/"' : ''}
       xsi:schemaLocation="http://www.opengroup.org/xsd/archimate/3.0/ http://www.opengroup.org/xsd/archimate/3.1/archimate3_Diagram.xsd"
       identifier="${escapeXml(modelMetadata.id || 'id-model-001')}"${modelMetadata.version ? ` version="${escapeXml(modelMetadata.version)}"` : ''}>
    
    <name xml:lang="${escapeXml(dc.language || 'cs')}">${escapeXml(modelMetadata.name || 'ArchiMate Model')}</name>
`;

        if (modelMetadata.documentation) {
            xml += `    <documentation xml:lang="${escapeXml(dc.language || 'cs')}">${escapeXml(modelMetadata.documentation)}</documentation>\n`;
        }

        // Properties
        if (modelMetadata.properties && modelMetadata.properties.length > 0) {
            xml += `    <properties>\n`;
            modelMetadata.properties.forEach((prop, idx) => {
                xml += `        <property propertyDefinitionRef="prop-def-${idx}">
            <value xml:lang="${escapeXml(dc.language || 'cs')}">${escapeXml(prop.value)}</value>
        </property>\n`;
            });
            xml += `    </properties>\n`;
        }

        // Dublin Core Metadata
        if (hasDublinCore) {
            xml += `    <metadata>
        <schema>http://purl.org/dc/elements/1.1/</schema>
        <schemaversion>1.1</schemaversion>
`;
            if (dc.creator) xml += `        <dc:creator>${escapeXml(dc.creator)}</dc:creator>\n`;
            if (dc.publisher) xml += `        <dc:publisher>${escapeXml(dc.publisher)}</dc:publisher>\n`;
            if (dc.date) xml += `        <dc:date>${escapeXml(dc.date)}</dc:date>\n`;
            if (dc.language) xml += `        <dc:language>${escapeXml(dc.language)}</dc:language>\n`;
            if (dc.rights) xml += `        <dc:rights>${escapeXml(dc.rights)}</dc:rights>\n`;
            if (dc.subject) xml += `        <dc:subject>${escapeXml(dc.subject)}</dc:subject>\n`;
            if (dc.description) xml += `        <dc:description>${escapeXml(dc.description)}</dc:description>\n`;
            xml += `    </metadata>\n`;
        }

        // Elements
        if (elements.length > 0) {
            xml += `    <elements>\n`;
            elements.forEach(e => {
                xml += `        <element xsi:type="${escapeXml(e.type)}" identifier="${escapeXml(e.id)}">\n`;
                xml += `            <name xml:lang="${escapeXml(dc.language || 'cs')}">${escapeXml(e.name)}</name>\n`;
                if (e.description) {
                    xml += `            <documentation xml:lang="${escapeXml(dc.language || 'cs')}">${escapeXml(e.description)}</documentation>\n`;
                }
                // Properties (stereotype, urƒçuje, p≈ô√≠znaky)
                if (e.stereotype || e.urƒçuje || e.p≈ô√≠znaky) {
                    xml += `            <properties>\n`;
                    if (e.stereotype) {
                        xml += `                <property propertyDefinitionRef="${stereotypePropId}">\n`;
                        xml += `                    <value xml:lang="${escapeXml(dc.language || 'cs')}">${escapeXml(e.stereotype)}</value>\n`;
                        xml += `                </property>\n`;
                    }
                    if (e.urƒçuje) {
                        xml += `                <property propertyDefinitionRef="${urƒçujePropId}">\n`;
                        xml += `                    <value xml:lang="${escapeXml(dc.language || 'cs')}">${escapeXml(e.urƒçuje)}</value>\n`;
                        xml += `                </property>\n`;
                    }
                    if (e.p≈ô√≠znaky) {
                        xml += `                <property propertyDefinitionRef="${p≈ô√≠znakyPropId}">\n`;
                        xml += `                    <value xml:lang="${escapeXml(dc.language || 'cs')}">${escapeXml(e.p≈ô√≠znaky)}</value>\n`;
                        xml += `                </property>\n`;
                    }
                    xml += `            </properties>\n`;
                }
                xml += `        </element>\n`;
            });
            xml += `    </elements>\n`;
        }

        // Relationships
        if (relationships.length > 0) {
            xml += `    <relationships>\n`;
            relationships.forEach(r => {
                xml += `        <relationship xsi:type="${escapeXml(r.type)}" identifier="${escapeXml(r.id)}" source="${escapeXml(r.sourceId)}" target="${escapeXml(r.targetId)}"`;
                if (r.name || r.description || r.p≈ô√≠znaky) {
                    xml += `>\n`;
                    if (r.name) {
                        xml += `            <name xml:lang="${escapeXml(dc.language || 'cs')}">${escapeXml(r.name)}</name>\n`;
                    }
                    if (r.description) {
                        xml += `            <documentation xml:lang="${escapeXml(dc.language || 'cs')}">${escapeXml(r.description)}</documentation>\n`;
                    if (r.p≈ô√≠znaky) {
                        xml += `            <properties>\n`;
                        xml += `                <property propertyDefinitionRef="${p≈ô√≠znakyPropId}">\n`;
                        xml += `                    <value xml:lang="${escapeXml(dc.language || 'cs')}">${escapeXml(r.p≈ô√≠znaky)}</value>\n`;
                        xml += `                </property>\n`;
                        xml += `            </properties>\n`;
                    }
                    }
                    xml += `        </relationship>\n`;
                } else {
                    xml += `/>\n`;
                }
            });
            xml += `    </relationships>\n`;
        }

        // Property Definitions
        const hasStereotype = elements.some(e => e.stereotype);
        const hasUrƒçuje = elements.some(e => e.urƒçuje);
        const hasP≈ô√≠znaky = elements.some(e => e.p≈ô√≠znaky) || relationships.some(r => r.p≈ô√≠znaky);
        const hasModelProps = modelMetadata.properties && modelMetadata.properties.length > 0;
        
        if (hasStereotype || hasUrƒçuje || hasP≈ô√≠znaky || hasModelProps) {
            xml += `    <propertyDefinitions>\n`;
            
            // Element property definitions - use determined IDs (from import or default propid-1, propid-2)
            if (hasStereotype) {
                xml += `        <propertyDefinition identifier="${stereotypePropId}" type="string">\n`;
                xml += `            <name>Stereotype</name>\n`;
                xml += `        </propertyDefinition>\n`;
            }
            if (hasUrƒçuje) {
                xml += `        <propertyDefinition identifier="${urƒçujePropId}" type="string">\n`;
                xml += `            <name>Urƒçuje</name>\n`;
                xml += `        </propertyDefinition>\n`;
            }
            
            if (hasP≈ô√≠znaky) {
                xml += `        <propertyDefinition identifier="${p≈ô√≠znakyPropId}" type="string">\n`;
                xml += `            <name>P≈ô√≠znaky</name>\n`;
                xml += `        </propertyDefinition>\n`;
            }
            // Model property definitions
            if (hasModelProps) {
                modelMetadata.properties.forEach((prop, idx) => {
                    xml += `        <propertyDefinition identifier="prop-def-${idx}" type="string">\n`;
                    xml += `            <name>${escapeXml(prop.key)}</name>\n`;
                    xml += `        </propertyDefinition>\n`;
                });
            }
            
            xml += `    </propertyDefinitions>\n`;
        }


        // Diagrams (Views)
        if (diagrams.length > 0) {
            xml += `    <views>\n`;
            xml += `        <diagrams>\n`;
            
            diagrams.forEach(diagram => {
                xml += `            <view identifier="${escapeXml(diagram.id)}" xsi:type="Diagram">\n`;
                xml += `                <name xml:lang="${escapeXml(dc.language || 'cs')}">${escapeXml(diagram.name)}</name>\n`;
                if (diagram.description) {
                    xml += `                <documentation xml:lang="${escapeXml(dc.language || 'cs')}">${escapeXml(diagram.description)}</documentation>\n`;
                }
                
                // Get elements on this diagram
                const diagramElements = diagram.elementIds
                    .map(id => elements.find(e => e.id === id))
                    .filter(e => e);
                
                // Calculate positions
                const positions = calculateLayout(diagramElements, diagram.layoutType || 'layered');
                
                // Generate nodes
                diagramElements.forEach(el => {
                    const pos = positions[el.id];
                    if (pos) {
                        xml += `                <node identifier="node-${escapeXml(el.id)}" xsi:type="Element" elementRef="${escapeXml(el.id)}" x="${pos.x}" y="${pos.y}" w="${pos.w}" h="${pos.h}"/>\n`;
                    }
                });
                
                // Generate connections
                const diagramRels = relationships.filter(r => 
                    diagram.elementIds.includes(r.sourceId) && 
                    diagram.elementIds.includes(r.targetId)
                );
                
                diagramRels.forEach(r => {
                    xml += `                <connection identifier="conn-${escapeXml(r.id)}" xsi:type="Relationship" relationshipRef="${escapeXml(r.id)}" source="node-${escapeXml(r.sourceId)}" target="node-${escapeXml(r.targetId)}"/>\n`;
                });
                
                xml += `            </view>\n`;
            });
            
            xml += `        </diagrams>\n`;
            xml += `    </views>\n`;
        }

        xml += `</model>`;
        
        return xml;
    }
    
    async function saveFileWithDialog(content, filename, mimeType, extensions) {
        // Handle both string/ArrayBuffer content and existing Blob
        const blob = content instanceof Blob ? content : new Blob([content], { type: mimeType });
        
        if ('showSaveFilePicker' in window) {
            try {
                const handle = await window.showSaveFilePicker({
                    suggestedName: filename,
                    types: [{
                        description: filename.split('.').pop().toUpperCase() + ' file',
                        accept: { [mimeType]: extensions }
                    }]
                });
                const writable = await handle.createWritable();
                await writable.write(blob);
                await writable.close();
                return true;
            } catch (e) {
                if (e.name === 'AbortError') return false;
                // Fall through to legacy download
            }
        }
        // Fallback for browsers without File System Access API
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        return true;
    }
    
    async function downloadFile(content, filename, mimeType) {
        // Determine extensions from mimeType
        const extMap = {
            'application/json': ['.json', '.ajx'],
            'application/xml': ['.xml'],
            'text/xml': ['.xml'],
            'text/csv': ['.csv'],
            'text/markdown': ['.md'],
            'text/markdown;charset=utf-8': ['.md'],
            'image/svg+xml': ['.svg'],
            'text/html': ['.html']
        };
        const extensions = extMap[mimeType] || ['.' + filename.split('.').pop()];
        await saveFileWithDialog(content, filename, mimeType, extensions);
    }
    
    // ============================================
    // Export by Tag Functions
    // ============================================
    
    function updateExportTagSelect() {
        const select = document.getElementById('export-tag-select');
        if (!select) return;
        
        // Gather all tags from elements and relationships
        const allTags = new Set();
        elements.forEach(e => {
            if (e.p≈ô√≠znaky) {
                e.p≈ô√≠znaky.split(',').forEach(tag => {
                    const trimmed = tag.trim();
                    if (trimmed) allTags.add(trimmed);
                });
            }
        });
        relationships.forEach(r => {
            if (r.p≈ô√≠znaky) {
                r.p≈ô√≠znaky.split(',').forEach(tag => {
                    const trimmed = tag.trim();
                    if (trimmed) allTags.add(trimmed);
                });
            }
        });
        
        const sortedTags = [...allTags].sort((a, b) => a.localeCompare(b, 'cs'));
        
        select.innerHTML = `<option value="">${t('selectTagPlaceholder')}</option>`;
        sortedTags.forEach(tag => {
            select.innerHTML += `<option value="${escapeHtml(tag)}">${escapeHtml(tag)}</option>`;
        });
        
        // Add change listener for stats update
        select.onchange = updateExportTagStats;
    }
    
    function updateExportTagStats() {
        const select = document.getElementById('export-tag-select');
        const statsDiv = document.getElementById('export-tag-stats');
        if (!select || !statsDiv) return;
        
        const selectedTag = select.value;
        if (!selectedTag) {
            statsDiv.innerHTML = '';
            return;
        }
        
        const filteredElements = elements.filter(e => {
            if (!e.p≈ô√≠znaky) return false;
            return e.p≈ô√≠znaky.split(',').map(t => t.trim()).includes(selectedTag);
        });
        
        const filteredRelationships = relationships.filter(r => {
            if (!r.p≈ô√≠znaky) return false;
            return r.p≈ô√≠znaky.split(',').map(t => t.trim()).includes(selectedTag);
        });
        
        statsDiv.innerHTML = t('exportTagStats', filteredElements.length, filteredRelationships.length);
    }
    
    function getItemsByTag(tag) {
        const filteredElements = elements.filter(e => {
            if (!e.p≈ô√≠znaky) return false;
            return e.p≈ô√≠znaky.split(',').map(t => t.trim()).includes(tag);
        });
        
        // Get element IDs for relationship filtering
        const elementIds = new Set(filteredElements.map(e => e.id));
        
        // Include relationships that have the tag OR connect filtered elements
        const filteredRelationships = relationships.filter(r => {
            // Include if relationship has the tag
            if (r.p≈ô√≠znaky) {
                const tags = r.p≈ô√≠znaky.split(',').map(t => t.trim());
                if (tags.includes(tag)) return true;
            }
            // Include if both source and target are in filtered elements
            if (elementIds.has(r.sourceId) && elementIds.has(r.targetId)) return true;
            return false;
        });
        
        return { elements: filteredElements, relationships: filteredRelationships };
    }
    
    function exportByTagAJX() {
        const select = document.getElementById('export-tag-select');
        const selectedTag = select ? select.value : '';
        
        if (!selectedTag) {
            alert(t('noTagSelected'));
            return;
        }
        
        const { elements: filteredElements, relationships: filteredRelationships } = getItemsByTag(selectedTag);
        
        if (filteredElements.length === 0 && filteredRelationships.length === 0) {
            alert(t('noItemsWithTag'));
            return;
        }
        
        const data = {
            exportDate: new Date().toISOString(),
            archimateVersion: "3.2",
            exportedByTag: selectedTag,
            model: { ...modelMetadata, name: `${modelMetadata.name || 'Model'} [${selectedTag}]` },
            elements: filteredElements,
            relationships: filteredRelationships,
            diagrams: [],
            adr: [],
            notes: [],
            tasks: []
        };
        
        const json = JSON.stringify(data, null, 2);
        document.getElementById('export-preview').textContent = json;
        
        const safeTag = selectedTag.replace(/[^a-zA-Z0-9√°ƒçƒè√©ƒõ√≠≈à√≥≈ô≈°≈•√∫≈Ø√Ω≈æ√Åƒåƒé√âƒö√ç≈á√ì≈ò≈†≈§√ö≈Æ√ù≈Ω]/g, '-');
        downloadFile(json, `${modelMetadata.name || 'archimate-model'}-${safeTag}.ajx`, 'application/json');
    }
    
    function exportByTagXML() {
        const select = document.getElementById('export-tag-select');
        const selectedTag = select ? select.value : '';
        
        if (!selectedTag) {
            alert(t('noTagSelected'));
            return;
        }
        
        const { elements: filteredElements, relationships: filteredRelationships } = getItemsByTag(selectedTag);
        
        if (filteredElements.length === 0 && filteredRelationships.length === 0) {
            alert(t('noItemsWithTag'));
            return;
        }
        
        const xml = generateArchiMateXMLFiltered(filteredElements, filteredRelationships, selectedTag);
        document.getElementById('export-preview').textContent = xml;
        
        const safeTag = selectedTag.replace(/[^a-zA-Z0-9√°ƒçƒè√©ƒõ√≠≈à√≥≈ô≈°≈•√∫≈Ø√Ω≈æ√Åƒåƒé√âƒö√ç≈á√ì≈ò≈†≈§√ö≈Æ√ù≈Ω]/g, '-');
        downloadFile(xml, `${modelMetadata.name || 'archimate-model'}-${safeTag}.xml`, 'application/xml');
    }
    
    function generateArchiMateXMLFiltered(filteredElements, filteredRelationships, tag) {
        const dc = modelMetadata.dublinCore || {};
        const hasDublinCore = dc.creator || dc.publisher || dc.date || dc.rights || dc.subject || dc.description;
        
        let stereotypePropId = 'propid-1';
        let urƒçujePropId = 'propid-2';
        let p≈ô√≠znakyPropId = 'propid-3';
        
        if (modelMetadata.importedPropertyDefs) {
            for (const [id, def] of Object.entries(modelMetadata.importedPropertyDefs)) {
                if (def.name.toLowerCase() === 'stereotype') stereotypePropId = id;
                else if (def.name === 'Urƒçuje' || def.name.toLowerCase() === 'urƒçuje') urƒçujePropId = id;
                else if (def.name === 'P≈ô√≠znaky' || def.name.toLowerCase() === 'p≈ô√≠znaky') p≈ô√≠znakyPropId = id;
            }
        }
        
        const modelName = `${modelMetadata.name || 'ArchiMate Model'} [${tag}]`;
        
        let xml = `<?xml version="1.0" encoding="UTF-8"?>
<model xmlns="http://www.opengroup.org/xsd/archimate/3.0/"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"${hasDublinCore ? '\n       xmlns:dc="http://purl.org/dc/elements/1.1/"' : ''}
       xsi:schemaLocation="http://www.opengroup.org/xsd/archimate/3.0/ http://www.opengroup.org/xsd/archimate/3.1/archimate3_Diagram.xsd"
       identifier="${escapeXml(modelMetadata.id || 'id-model-001')}-export"${modelMetadata.version ? ` version="${escapeXml(modelMetadata.version)}"` : ''}>
    
    <name xml:lang="${escapeXml(dc.language || 'cs')}">${escapeXml(modelName)}</name>
`;

        if (modelMetadata.documentation) {
            xml += `    <documentation xml:lang="${escapeXml(dc.language || 'cs')}">${escapeXml(modelMetadata.documentation)}</documentation>\n`;
        }

        if (hasDublinCore) {
            xml += `    <metadata>
        <schema>http://purl.org/dc/elements/1.1/</schema>
        <schemaversion>1.1</schemaversion>
`;
            if (dc.creator) xml += `        <dc:creator>${escapeXml(dc.creator)}</dc:creator>\n`;
            if (dc.publisher) xml += `        <dc:publisher>${escapeXml(dc.publisher)}</dc:publisher>\n`;
            if (dc.date) xml += `        <dc:date>${escapeXml(dc.date)}</dc:date>\n`;
            if (dc.language) xml += `        <dc:language>${escapeXml(dc.language)}</dc:language>\n`;
            if (dc.rights) xml += `        <dc:rights>${escapeXml(dc.rights)}</dc:rights>\n`;
            if (dc.subject) xml += `        <dc:subject>${escapeXml(dc.subject)}</dc:subject>\n`;
            if (dc.description) xml += `        <dc:description>${escapeXml(dc.description)}</dc:description>\n`;
            xml += `    </metadata>\n`;
        }

        if (filteredElements.length > 0) {
            xml += `    <elements>\n`;
            filteredElements.forEach(e => {
                xml += `        <element xsi:type="${escapeXml(e.type)}" identifier="${escapeXml(e.id)}">\n`;
                xml += `            <name xml:lang="${escapeXml(dc.language || 'cs')}">${escapeXml(e.name)}</name>\n`;
                if (e.description) {
                    xml += `            <documentation xml:lang="${escapeXml(dc.language || 'cs')}">${escapeXml(e.description)}</documentation>\n`;
                }
                if (e.stereotype || e.urƒçuje || e.p≈ô√≠znaky) {
                    xml += `            <properties>\n`;
                    if (e.stereotype) {
                        xml += `                <property propertyDefinitionRef="${stereotypePropId}">\n`;
                        xml += `                    <value xml:lang="${escapeXml(dc.language || 'cs')}">${escapeXml(e.stereotype)}</value>\n`;
                        xml += `                </property>\n`;
                    }
                    if (e.urƒçuje) {
                        xml += `                <property propertyDefinitionRef="${urƒçujePropId}">\n`;
                        xml += `                    <value xml:lang="${escapeXml(dc.language || 'cs')}">${escapeXml(e.urƒçuje)}</value>\n`;
                        xml += `                </property>\n`;
                    }
                    if (e.p≈ô√≠znaky) {
                        xml += `                <property propertyDefinitionRef="${p≈ô√≠znakyPropId}">\n`;
                        xml += `                    <value xml:lang="${escapeXml(dc.language || 'cs')}">${escapeXml(e.p≈ô√≠znaky)}</value>\n`;
                        xml += `                </property>\n`;
                    }
                    xml += `            </properties>\n`;
                }
                xml += `        </element>\n`;
            });
            xml += `    </elements>\n`;
        }

        if (filteredRelationships.length > 0) {
            xml += `    <relationships>\n`;
            filteredRelationships.forEach(r => {
                xml += `        <relationship xsi:type="${escapeXml(r.type)}" identifier="${escapeXml(r.id)}" source="${escapeXml(r.sourceId)}" target="${escapeXml(r.targetId)}"`;
                if (r.name || r.description || r.p≈ô√≠znaky) {
                    xml += `>\n`;
                    if (r.name) {
                        xml += `            <name xml:lang="${escapeXml(dc.language || 'cs')}">${escapeXml(r.name)}</name>\n`;
                    }
                    if (r.description) {
                        xml += `            <documentation xml:lang="${escapeXml(dc.language || 'cs')}">${escapeXml(r.description)}</documentation>\n`;
                    }
                    if (r.p≈ô√≠znaky) {
                        xml += `            <properties>\n`;
                        xml += `                <property propertyDefinitionRef="${p≈ô√≠znakyPropId}">\n`;
                        xml += `                    <value xml:lang="${escapeXml(dc.language || 'cs')}">${escapeXml(r.p≈ô√≠znaky)}</value>\n`;
                        xml += `                </property>\n`;
                        xml += `            </properties>\n`;
                    }
                    xml += `        </relationship>\n`;
                } else {
                    xml += `/>\n`;
                }
            });
            xml += `    </relationships>\n`;
        }

        const hasStereotype = filteredElements.some(e => e.stereotype);
        const hasUrƒçuje = filteredElements.some(e => e.urƒçuje);
        const hasP≈ô√≠znaky = filteredElements.some(e => e.p≈ô√≠znaky) || filteredRelationships.some(r => r.p≈ô√≠znaky);
        
        if (hasStereotype || hasUrƒçuje || hasP≈ô√≠znaky) {
            xml += `    <propertyDefinitions>\n`;
            if (hasStereotype) {
                xml += `        <propertyDefinition identifier="${stereotypePropId}" type="string">\n`;
                xml += `            <name>Stereotype</name>\n`;
                xml += `        </propertyDefinition>\n`;
            }
            if (hasUrƒçuje) {
                xml += `        <propertyDefinition identifier="${urƒçujePropId}" type="string">\n`;
                xml += `            <name>Urƒçuje</name>\n`;
                xml += `        </propertyDefinition>\n`;
            }
            if (hasP≈ô√≠znaky) {
                xml += `        <propertyDefinition identifier="${p≈ô√≠znakyPropId}" type="string">\n`;
                xml += `            <name>P≈ô√≠znaky</name>\n`;
                xml += `        </propertyDefinition>\n`;
            }
            xml += `    </propertyDefinitions>\n`;
        }

        xml += `</model>`;
        return xml;
    }
    
    // ============================================
    // DOCX Export Functions
    // ============================================
    
    async function generateDocxFromTask(task) {
        if (typeof window.docx === 'undefined') {
            throw new Error('DOCX library not loaded');
        }
        const { Document, Paragraph, TextRun, HeadingLevel, Table, TableRow, TableCell, WidthType, BorderStyle, AlignmentType, Packer } = window.docx;
        
        const children = [];
        
        // Title
        children.push(new Paragraph({
            heading: HeadingLevel.HEADING_1,
            children: [new TextRun({ text: `√ökol #${task.number}: ${task.title}`, bold: true })]
        }));
        
        // Metadata
        const metaItems = [
            ['Stav', getTaskStatusLabel(task.status)],
            ['Priorita', getTaskPriorityLabel(task.priority)],
            ['≈òe≈°itel', task.assignee || '-'],
            ['Zadavatel', task.reporter || '-'],
            ['Term√≠n', task.dueDate || '-'],
            ['Vytvo≈ôeno', task.created ? new Date(task.created).toLocaleDateString() : '-'],
            ['Aktualizov√°no', task.updated ? new Date(task.updated).toLocaleDateString() : '-']
        ];
        if (task.tags && task.tags.length > 0) {
            metaItems.push(['P≈ô√≠znaky', task.tags.join(', ')]);
        }
        
        metaItems.forEach(([label, value]) => {
            children.push(new Paragraph({
                children: [
                    new TextRun({ text: `${label}: `, bold: true }),
                    new TextRun({ text: value })
                ],
                spacing: { after: 100 }
            }));
        });
        
        children.push(new Paragraph({ text: '' }));
        
        // Popis
        if (task.description) {
            children.push(new Paragraph({
                heading: HeadingLevel.HEADING_2,
                children: [new TextRun({ text: 'Popis', bold: true })]
            }));
            task.description.split('\n').forEach(line => {
                children.push(new Paragraph({ text: line }));
            });
            children.push(new Paragraph({ text: '' }));
        }
        
        // Aktu√°ln√≠ stav
        if (task.currentState) {
            children.push(new Paragraph({
                heading: HeadingLevel.HEADING_2,
                children: [new TextRun({ text: 'Aktu√°ln√≠ stav', bold: true })]
            }));
            task.currentState.split('\n').forEach(line => {
                children.push(new Paragraph({ text: line }));
            });
            children.push(new Paragraph({ text: '' }));
        }
        
        // Propojen√© polo≈æky
        const hasLinked = (task.linkedElements && task.linkedElements.length > 0) || 
                         (task.linkedRelationships && task.linkedRelationships.length > 0);
        if (hasLinked) {
            children.push(new Paragraph({
                heading: HeadingLevel.HEADING_2,
                children: [new TextRun({ text: 'Propojen√© polo≈æky', bold: true })]
            }));
            
            if (task.linkedElements && task.linkedElements.length > 0) {
                children.push(new Paragraph({
                    children: [new TextRun({ text: 'Prvky:', bold: true })]
                }));
                task.linkedElements.forEach(id => {
                    const el = elements.find(e => e.id === id);
                    children.push(new Paragraph({
                        text: `‚Ä¢ ${el ? el.name || el.id : id}`,
                        indent: { left: 360 }
                    }));
                });
            }
            
            if (task.linkedRelationships && task.linkedRelationships.length > 0) {
                children.push(new Paragraph({
                    children: [new TextRun({ text: 'Vazby:', bold: true })]
                }));
                task.linkedRelationships.forEach(id => {
                    const rel = relationships.find(r => r.id === id);
                    if (rel) {
                        const source = elements.find(e => e.id === rel.sourceId);
                        const target = elements.find(e => e.id === rel.targetId);
                        children.push(new Paragraph({
                            text: `‚Ä¢ ${source?.name || rel.sourceId} ‚Üí ${target?.name || rel.targetId}`,
                            indent: { left: 360 }
                        }));
                    }
                });
            }
            children.push(new Paragraph({ text: '' }));
        }
        
        // Historie stav≈Ø
        if (task.statusHistory && task.statusHistory.length > 0) {
            children.push(new Paragraph({
                heading: HeadingLevel.HEADING_2,
                children: [new TextRun({ text: 'Historie stav≈Ø', bold: true })]
            }));
            
            const headerRow = new TableRow({
                children: ['Stav', 'Datum', '≈òe≈°itel', 'Pozn√°mka'].map(text => 
                    new TableCell({
                        children: [new Paragraph({ children: [new TextRun({ text, bold: true })] })],
                        shading: { fill: 'E0E0E0' }
                    })
                )
            });
            
            const rows = task.statusHistory.map(h => new TableRow({
                children: [
                    getTaskStatusLabel(h.status),
                    new Date(h.date).toLocaleString(),
                    h.author || '-',
                    h.stateDescription || '-'
                ].map(text => new TableCell({
                    children: [new Paragraph({ text: String(text) })]
                }))
            }));
            
            children.push(new Table({
                rows: [headerRow, ...rows],
                width: { size: 100, type: WidthType.PERCENTAGE }
            }));
        }
        
        const doc = new Document({
            sections: [{ children }]
        });
        
        return await window.docx.Packer.toBlob(doc);
    }
    
    async function generateDocxFromAdr(adr) {
        if (typeof window.docx === 'undefined') {
            throw new Error('DOCX library not loaded');
        }
        const { Document, Paragraph, TextRun, HeadingLevel, Table, TableRow, TableCell, WidthType, BorderStyle } = window.docx;
        
        const statusInfo = ADR_STATUSES[adr.status] || ADR_STATUSES.draft;
        const children = [];
        
        // Title
        children.push(new Paragraph({
            heading: HeadingLevel.HEADING_1,
            children: [new TextRun({ text: `ADR-${formatAdrNumber(adr.number)}: ${adr.title || 'Bez n√°zvu'}`, bold: true })]
        }));
        
        // Metadata table
        const metaRows = [
            [t('adrStatus'), `${statusInfo.icon} ${getAdrStatusLabel(adr.status)}`],
            [t('adrCreated'), adr.created ? new Date(adr.created).toLocaleDateString() : '-'],
            [t('adrUpdated'), adr.updated ? new Date(adr.updated).toLocaleDateString() : '-'],
            [t('adrAuthor'), adr.author || '-']
        ];
        if (adr.approver) metaRows.push([t('adrApprover'), adr.approver]);
        if (adr.deciders && adr.deciders.length > 0) metaRows.push([t('adrDeciders'), adr.deciders.join(', ')]);
        if (adr.tags && adr.tags.length > 0) metaRows.push([t('adrTags'), adr.tags.join(', ')]);
        
        children.push(new Table({
            rows: metaRows.map(([label, value]) => new TableRow({
                children: [
                    new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: label, bold: true })] })], width: { size: 25, type: WidthType.PERCENTAGE } }),
                    new TableCell({ children: [new Paragraph({ text: value })] })
                ]
            })),
            width: { size: 100, type: WidthType.PERCENTAGE }
        }));
        
        children.push(new Paragraph({ text: '' }));
        
        // Context
        if (adr.context) {
            children.push(new Paragraph({
                heading: HeadingLevel.HEADING_2,
                children: [new TextRun({ text: t('adrContext'), bold: true })]
            }));
            adr.context.split('\n').forEach(line => {
                children.push(new Paragraph({ text: line }));
            });
            children.push(new Paragraph({ text: '' }));
        }
        
        // Decision
        if (adr.decision) {
            children.push(new Paragraph({
                heading: HeadingLevel.HEADING_2,
                children: [new TextRun({ text: t('adrDecision'), bold: true })]
            }));
            adr.decision.split('\n').forEach(line => {
                children.push(new Paragraph({ text: line }));
            });
            children.push(new Paragraph({ text: '' }));
        }
        
        // Consequences
        if (adr.consequences) {
            children.push(new Paragraph({
                heading: HeadingLevel.HEADING_2,
                children: [new TextRun({ text: t('adrConsequences'), bold: true })]
            }));
            adr.consequences.split('\n').forEach(line => {
                children.push(new Paragraph({ text: line }));
            });
            children.push(new Paragraph({ text: '' }));
        }
        
        // Alternatives
        if (adr.alternatives && adr.alternatives.length > 0) {
            children.push(new Paragraph({
                heading: HeadingLevel.HEADING_2,
                children: [new TextRun({ text: t('adrAlternatives'), bold: true })]
            }));
            
            const selectedIdx = adr.selectedAlternative ? parseInt(adr.selectedAlternative) : -1;
            
            adr.alternatives.forEach((alt, idx) => {
                const isSelected = idx === selectedIdx;
                const title = isSelected ? `${alt.title} ‚úÖ ${t('adrSelected')}` : alt.title;
                children.push(new Paragraph({
                    heading: HeadingLevel.HEADING_3,
                    children: [new TextRun({ text: title, bold: isSelected })]
                }));
                if (alt.description) {
                    alt.description.split('\n').forEach(line => {
                        children.push(new Paragraph({ text: line }));
                    });
                }
            });
            
            if (adr.selectionReason && selectedIdx >= 0) {
                children.push(new Paragraph({
                    heading: HeadingLevel.HEADING_3,
                    children: [new TextRun({ text: t('adrSelectionReason'), bold: true })]
                }));
                adr.selectionReason.split('\n').forEach(line => {
                    children.push(new Paragraph({ text: line }));
                });
            }
            children.push(new Paragraph({ text: '' }));
        }
        
        // Implementation
        if (adr.implementation && (adr.implementation.status !== 'not_started' || adr.implementation.notes)) {
            children.push(new Paragraph({
                heading: HeadingLevel.HEADING_2,
                children: [new TextRun({ text: t('adrImplementation'), bold: true })]
            }));
            
            const implTable = new Table({
                rows: [
                    new TableRow({
                        children: [t('adrImplStatus'), t('adrImplStartDate'), t('adrImplTargetDate')].map(text =>
                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text, bold: true })] })], shading: { fill: 'E0E0E0' } })
                        )
                    }),
                    new TableRow({
                        children: [
                            getAdrImplStatusLabel(adr.implementation.status),
                            adr.implementation.startDate || '-',
                            adr.implementation.targetDate || '-'
                        ].map(text => new TableCell({ children: [new Paragraph({ text })] }))
                    })
                ],
                width: { size: 100, type: WidthType.PERCENTAGE }
            });
            children.push(implTable);
            
            if (adr.implementation.notes) {
                children.push(new Paragraph({ text: '' }));
                adr.implementation.notes.split('\n').forEach(line => {
                    children.push(new Paragraph({ text: line }));
                });
            }
            children.push(new Paragraph({ text: '' }));
        }
        
        // Links
        if (adr.links && adr.links.length > 0) {
            children.push(new Paragraph({
                heading: HeadingLevel.HEADING_2,
                children: [new TextRun({ text: t('adrLinks'), bold: true })]
            }));
            adr.links.forEach(link => {
                children.push(new Paragraph({
                    text: `‚Ä¢ ${link.title || link.url}: ${link.url}`,
                    indent: { left: 360 }
                }));
            });
            children.push(new Paragraph({ text: '' }));
        }
        
        // Related ADR
        if (adr.relatedAdr) {
            const hasRelated = (adr.relatedAdr.supersedes?.length || 0) + 
                              (adr.relatedAdr.supersededBy?.length || 0) + 
                              (adr.relatedAdr.relatedTo?.length || 0) > 0;
            if (hasRelated) {
                children.push(new Paragraph({
                    heading: HeadingLevel.HEADING_2,
                    children: [new TextRun({ text: t('adrRelatedAdr'), bold: true })]
                }));
                
                const getAdrRef = (id) => {
                    const related = adrRecords.find(a => a.id === id);
                    return related ? `ADR-${formatAdrNumber(related.number)}: ${related.title}` : id;
                };
                
                if (adr.relatedAdr.supersedes?.length > 0) {
                    children.push(new Paragraph({ children: [new TextRun({ text: t('adrSupersedes') + ':', bold: true })] }));
                    adr.relatedAdr.supersedes.forEach(id => {
                        children.push(new Paragraph({ text: `‚Ä¢ ${getAdrRef(id)}`, indent: { left: 360 } }));
                    });
                }
                if (adr.relatedAdr.supersededBy?.length > 0) {
                    children.push(new Paragraph({ children: [new TextRun({ text: t('adrSupersededBy') + ':', bold: true })] }));
                    adr.relatedAdr.supersededBy.forEach(id => {
                        children.push(new Paragraph({ text: `‚Ä¢ ${getAdrRef(id)}`, indent: { left: 360 } }));
                    });
                }
                if (adr.relatedAdr.relatedTo?.length > 0) {
                    children.push(new Paragraph({ children: [new TextRun({ text: t('adrRelatedTo') + ':', bold: true })] }));
                    adr.relatedAdr.relatedTo.forEach(id => {
                        children.push(new Paragraph({ text: `‚Ä¢ ${getAdrRef(id)}`, indent: { left: 360 } }));
                    });
                }
            }
        }
        
        // Linked elements/relationships
        const hasLinkedItems = (adr.linkedElements && adr.linkedElements.length > 0) || 
                              (adr.linkedRelationships && adr.linkedRelationships.length > 0);
        if (hasLinkedItems) {
            children.push(new Paragraph({
                heading: HeadingLevel.HEADING_2,
                children: [new TextRun({ text: t('adrLinkedItems'), bold: true })]
            }));
            
            if (adr.linkedElements && adr.linkedElements.length > 0) {
                children.push(new Paragraph({ children: [new TextRun({ text: t('elementsTab') + ':', bold: true })] }));
                adr.linkedElements.forEach(id => {
                    const el = elements.find(e => e.id === id);
                    children.push(new Paragraph({ text: `‚Ä¢ ${el ? el.name || el.id : id}`, indent: { left: 360 } }));
                });
            }
            if (adr.linkedRelationships && adr.linkedRelationships.length > 0) {
                children.push(new Paragraph({ children: [new TextRun({ text: t('relationshipsTab') + ':', bold: true })] }));
                adr.linkedRelationships.forEach(id => {
                    const rel = relationships.find(r => r.id === id);
                    if (rel) {
                        const source = elements.find(e => e.id === rel.sourceId);
                        const target = elements.find(e => e.id === rel.targetId);
                        children.push(new Paragraph({ text: `‚Ä¢ ${source?.name || rel.sourceId} ‚Üí ${target?.name || rel.targetId}`, indent: { left: 360 } }));
                    }
                });
            }
        }
        
        // Status history
        if (adr.statusHistory && adr.statusHistory.length > 0) {
            children.push(new Paragraph({
                heading: HeadingLevel.HEADING_2,
                children: [new TextRun({ text: t('adrStatusHistory'), bold: true })]
            }));
            
            const historyTable = new Table({
                rows: [
                    new TableRow({
                        children: [t('adrStatus'), t('adrDate'), t('adrAuthor'), t('adrComment')].map(text =>
                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text, bold: true })] })], shading: { fill: 'E0E0E0' } })
                        )
                    }),
                    ...adr.statusHistory.map(h => new TableRow({
                        children: [
                            getAdrStatusLabel(h.status),
                            new Date(h.date).toLocaleString(),
                            h.author || '-',
                            h.comment || '-'
                        ].map(text => new TableCell({ children: [new Paragraph({ text: String(text) })] }))
                    }))
                ],
                width: { size: 100, type: WidthType.PERCENTAGE }
            });
            children.push(historyTable);
        }
        
        const doc = new Document({
            sections: [{ children }]
        });
        
        return await window.docx.Packer.toBlob(doc);
    }

    // ============================================
    // Import Functions
    // ============================================
    
    function handleDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        document.getElementById('import-drop-area').classList.add('dragover');
    }
    
    function handleDragLeave(e) {
        e.preventDefault();
        e.stopPropagation();
        document.getElementById('import-drop-area').classList.remove('dragover');
    }
    
    function handleFileDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        document.getElementById('import-drop-area').classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            processImportFile(files[0]);
        }
    }
    
    function handleFileSelect(e) {
        const files = e.target.files;
        if (files.length > 0) {
            processImportFile(files[0]);
        }
    }
    
    function processImportFile(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            document.getElementById('import-data').value = content;
        };
        reader.readAsText(file);
    }
    
    function importData() {
        const input = document.getElementById('import-data').value.trim();
        
        if (!input) {
            alert(t('pasteDataToImport'));
            return;
        }
        
        // Detect format
        if (input.startsWith('{')) {
            importJSON(input);
        } else if (input.startsWith('<?xml') || input.startsWith('<model')) {
            importXML(input);
        } else {
            alert(t('unrecognizedFormat'));
        }
    }
    
    function importJSON(input) {
        try {
            const data = JSON.parse(input);
            
            if (data.model) {
                modelMetadata = data.model;
            }
            
            if (data.elements && Array.isArray(data.elements)) {
                elements = data.elements;
            }
            
            if (data.relationships && Array.isArray(data.relationships)) {
                relationships = data.relationships;
            }
            
            if (data.diagrams && Array.isArray(data.diagrams)) {
                diagrams = data.diagrams;
            }
            
            if (data.adr && Array.isArray(data.adr)) {
                adrRecords = data.adr;
            }
            
            if (data.notes && Array.isArray(data.notes)) {
                notes = data.notes;
            }
            
            if (data.tasks && Array.isArray(data.tasks)) {
                tasks = data.tasks;
            }
            
            loadModelMetadataToForm();
            renderModelProperties();
            renderElementsTable();
            renderRelationshipsTable();
            renderDiagramsTable();
            renderAdrTable();
            renderNotesTable();
            renderTasksTable();
            populateElementSelects();
            updateTypeFilter();
            updateStereotypeSuggestions();
            updateP≈ô√≠znakySuggestions();
            updateStereotypeFilter();
            updateP≈ô√≠znakyFilters();
            updateRelNameSuggestions();
            updateRelSourceTargetFilters();
            updateDiagramFilters();
            updateTaskAssigneeFilter();
            updateModelStats();
            saveToLocalStorage();
            
            alert(`${t('importSuccess')}\n\n${t('elementsLabel')}: ${elements.length}\n${t('relationshipsLabel')}: ${relationships.length}\n${t('diagramsLabel')}: ${diagrams.length}\nADR: ${adrRecords.length}\n${t('notesTab')}: ${notes.length}\n${t('tasksTab')}: ${tasks.length}`);
            
            document.getElementById('import-data').value = '';
            
        } catch (e) {
            alert(`${t('jsonParseError')}: ${e.message}`);
        }
    }
    
    function importXML(input) {
        try {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(input, "text/xml");
            
            // Check for parsing errors
            const parseError = xmlDoc.querySelector('parsererror');
            if (parseError) {
                throw new Error('Neplatn√Ω XML form√°t');
            }
            
            const model = xmlDoc.querySelector('model');
            if (!model) {
                throw new Error('Element <model> nebyl nalezen');
            }
            
            // Parse model metadata
            modelMetadata.id = model.getAttribute('identifier') || 'id-model-001';
            modelMetadata.version = model.getAttribute('version') || '';
            
            const nameEl = model.querySelector(':scope > name');
            modelMetadata.name = nameEl ? nameEl.textContent : '';
            
            const docEl = model.querySelector(':scope > documentation');
            modelMetadata.documentation = docEl ? docEl.textContent : '';
            
            // Parse Dublin Core metadata
            const dcCreator = model.querySelector('dc\\:creator, creator');
            const dcPublisher = model.querySelector('dc\\:publisher, publisher');
            const dcDate = model.querySelector('dc\\:date, date');
            const dcLanguage = model.querySelector('dc\\:language, language');
            const dcRights = model.querySelector('dc\\:rights, rights');
            const dcSubject = model.querySelector('dc\\:subject, subject');
            const dcDescription = model.querySelector('dc\\:description, description');
            
            modelMetadata.dublinCore = {
                creator: dcCreator ? dcCreator.textContent : '',
                publisher: dcPublisher ? dcPublisher.textContent : '',
                date: dcDate ? dcDate.textContent : '',
                language: dcLanguage ? dcLanguage.textContent : 'cs',
                rights: dcRights ? dcRights.textContent : '',
                subject: dcSubject ? dcSubject.textContent : '',
                description: dcDescription ? dcDescription.textContent : ''
            };
            
            // Parse propertyDefinitions - create map ID -> name
            const propDefMap = {}; // id -> name
            const propDefById = {}; // id -> { identifier, name }
            const propDefNodes = model.querySelectorAll('propertyDefinitions > propertyDefinition');
            propDefNodes.forEach(propDef => {
                const id = propDef.getAttribute('identifier') || '';
                const nameNode = propDef.querySelector('name');
                const name = nameNode ? nameNode.textContent.trim() : '';
                if (id && name) {
                    propDefMap[id] = name;
                    propDefById[id] = { identifier: id, name: name };
                }
            });
            
            // Store imported propertyDefinitions for later export
            modelMetadata.importedPropertyDefs = propDefById;
            
            // Parse elements
            elements = [];
            const elementNodes = model.querySelectorAll('elements > element');
            elementNodes.forEach(el => {
                const type = el.getAttribute('xsi:type') || el.getAttribute('type') || '';
                const id = el.getAttribute('identifier') || '';
                const nameNode = el.querySelector('name');
                const name = nameNode ? nameNode.textContent : '';
                const docNode = el.querySelector('documentation');
                const description = docNode ? docNode.textContent : '';
                
                // Parse element properties
                let stereotype = '';
                let urƒçuje = '';
                let p≈ô√≠znaky = '';
                const propNodes = el.querySelectorAll('properties > property');
                propNodes.forEach(prop => {
                    const propDefRef = prop.getAttribute('propertyDefinitionRef') || '';
                    const valueNode = prop.querySelector('value');
                    const value = valueNode ? valueNode.textContent : '';
                    
                    // Map property by definition name
                    const propName = propDefMap[propDefRef] || '';
                    if (propName.toLowerCase() === 'stereotype') {
                        stereotype = value;
                    } else if (propName === 'Urƒçuje' || propName.toLowerCase() === 'urƒçuje') {
                        urƒçuje = value;
                    } else if (propName === 'P≈ô√≠znaky' || propName.toLowerCase() === 'p≈ô√≠znaky') {
                        p≈ô√≠znaky = value;
                    }
                });
                
                // Determine layer from type
                let layer = 'composite';
                for (const [layerKey, layerData] of Object.entries(ARCHIMATE_LAYERS)) {
                    if (layerData.elements[type]) {
                        layer = layerKey;
                        break;
                    }
                }
                
                if (id && type) {
                    elements.push({ id, layer, type, stereotype, name, urƒçuje, p≈ô√≠znaky, description });
                }
            });
            
            // Parse relationships
            relationships = [];
            const relNodes = model.querySelectorAll('relationships > relationship');
            relNodes.forEach(rel => {
                const type = rel.getAttribute('xsi:type') || rel.getAttribute('type') || '';
                const id = rel.getAttribute('identifier') || '';
                const sourceId = rel.getAttribute('source') || '';
                const targetId = rel.getAttribute('target') || '';
                const nameNode = rel.querySelector('name');
                const name = nameNode ? nameNode.textContent : '';
                const docNode = rel.querySelector('documentation');
                const description = docNode ? docNode.textContent : '';
                
                // Parse p≈ô√≠znaky from relationship properties
                let p≈ô√≠znaky = '';
                const propNodes = rel.querySelectorAll('properties > property');
                propNodes.forEach(prop => {
                    const propDefRef = prop.getAttribute('propertyDefinitionRef') || '';
                    const valueNode = prop.querySelector('value');
                    const value = valueNode ? valueNode.textContent : '';
                    const propName = propDefMap[propDefRef] || '';
                    if (propName === 'P≈ô√≠znaky' || propName.toLowerCase() === 'p≈ô√≠znaky') {
                        p≈ô√≠znaky = value;
                    }
                });
                
                if (id && sourceId && targetId && type) {
                    relationships.push({ id, sourceId, targetId, type, name, description, p≈ô√≠znaky });
                }
            });
            
            // Parse diagrams (views)
            diagrams = [];
            const viewNodes = model.querySelectorAll('views > diagrams > view');
            viewNodes.forEach(view => {
                const id = view.getAttribute('identifier') || 'diagram-' + Date.now();
                const nameNode = view.querySelector('name');
                const name = nameNode ? nameNode.textContent : 'Importovan√Ω diagram';
                const docNode = view.querySelector('documentation');
                const description = docNode ? docNode.textContent : '';
                
                // Get element IDs from nodes
                const elementIds = [];
                const nodeNodes = view.querySelectorAll('node');
                nodeNodes.forEach(node => {
                    const elementRef = node.getAttribute('elementRef');
                    if (elementRef && !elementIds.includes(elementRef)) {
                        elementIds.push(elementRef);
                    }
                });
                
                if (elementIds.length > 0 || name) {
                    diagrams.push({
                        id: id,
                        name: name,
                        description: description,
                        layoutType: 'layered',
                        elementIds: elementIds
                    });
                }
            });
            
            loadModelMetadataToForm();
            renderModelProperties();
            renderElementsTable();
            renderRelationshipsTable();
            renderDiagramsTable();
            populateElementSelects();
            updateTypeFilter();
            updateStereotypeSuggestions();
            updateP≈ô√≠znakySuggestions();
            updateStereotypeFilter();
            updateP≈ô√≠znakyFilters();
            updateRelNameSuggestions();
            updateRelSourceTargetFilters();
            updateDiagramFilters();
            updateModelStats();
            saveToLocalStorage();
            
            alert(`${t('xmlImportSuccess')}\n\n${t('modelLabel')}: ${modelMetadata.name}\n${t('elementsLabel')}: ${elements.length}\n${t('relationshipsLabel')}: ${relationships.length}\n${t('diagramsLabel')}: ${diagrams.length}`);
            
            document.getElementById('import-data').value = '';
            
        } catch (e) {
            alert(`${t('xmlImportError')}: ${e.message}`);
        }
    }
    
    // Global variable for merge preview data
    let mergePreviewData = null;
    let mergeSourceModelName = '';
    let currentMergeTab = 'elements';
    
    function updateMergeUI() {
        const strategy = document.getElementById('merge-strategy').value;
        const manualSection = document.getElementById('merge-manual-selection');
        
        if (strategy === 'manual') {
            manualSection.style.display = 'block';
            // If file already loaded, refresh preview
            if (mergePreviewData) {
                renderMergeElementsList();
                renderMergeRelationshipsList();
            }
        } else {
            manualSection.style.display = 'none';
        }
    }
    
    function switchMergeTab(tab) {
        currentMergeTab = tab;
        
        // Update tab buttons
        document.querySelectorAll('.merge-tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(`merge-tab-btn-${tab}`).classList.add('active');
        
        // Show/hide lists
        document.getElementById('merge-elements-list').style.display = tab === 'elements' ? 'block' : 'none';
        document.getElementById('merge-relationships-list').style.display = tab === 'relationships' ? 'block' : 'none';
        document.getElementById('merge-diagrams-list').style.display = tab === 'diagrams' ? 'block' : 'none';
        
        // When switching to relationships tab, uncheck all elements so user can select via relationships
        if (tab === 'relationships') {
            document.querySelectorAll('.merge-element-checkbox').forEach(cb => {
                cb.checked = false;
            });
            document.querySelectorAll('.merge-relationship-checkbox').forEach(cb => {
                cb.checked = false;
            });
        }
        
        // When switching to diagrams tab, uncheck all elements and relationships so user can select via diagrams
        if (tab === 'diagrams') {
            document.querySelectorAll('.merge-element-checkbox').forEach(cb => {
                cb.checked = false;
            });
            document.querySelectorAll('.merge-relationship-checkbox').forEach(cb => {
                cb.checked = false;
            });
            document.querySelectorAll('.merge-diagram-checkbox').forEach(cb => {
                cb.checked = false;
            });
        }
        
        // Clear search and show all items
        document.getElementById('merge-search-input').value = '';
        filterMergeList();
        
        updateMergeSelectionStats();
    }
    
    function filterMergeList() {
        const searchInput = document.getElementById('merge-search-input');
        const searchStatsDiv = document.getElementById('merge-search-stats');
        const searchTerm = searchInput.value.toLowerCase().trim();
        
        if (currentMergeTab === 'elements') {
            const labels = document.querySelectorAll('#merge-elements-list label');
            let visibleCount = 0;
            let totalCount = labels.length;
            
            labels.forEach(label => {
                // Use data-search attribute if available, otherwise fallback to textContent
                const searchText = label.dataset.search || label.textContent.toLowerCase();
                const matches = searchTerm === '' || searchText.includes(searchTerm);
                label.style.display = matches ? 'flex' : 'none';
                if (matches) visibleCount++;
            });
            
            // Also show/hide layer headers based on visible items
            const layerDivs = document.querySelectorAll('#merge-elements-list > div');
            layerDivs.forEach(div => {
                const visibleLabels = div.querySelectorAll('label[style*="display: flex"], label:not([style*="display"])');
                const hasVisible = [...div.querySelectorAll('label')].some(l => l.style.display !== 'none');
                div.style.display = hasVisible ? 'block' : 'none';
            });
            
            if (searchTerm) {
                searchStatsDiv.innerHTML = `${t('searchResults')}: ${visibleCount} ${t('of')} ${totalCount} ${t('elementsSmall')}`;
            } else {
                searchStatsDiv.innerHTML = '';
            }
        } else if (currentMergeTab === 'relationships') {
            const labels = document.querySelectorAll('#merge-relationships-list label');
            let visibleCount = 0;
            let totalCount = labels.length;
            
            labels.forEach(label => {
                // Use data-search attribute if available, otherwise fallback to textContent
                const searchText = label.dataset.search || label.textContent.toLowerCase();
                const matches = searchTerm === '' || searchText.includes(searchTerm);
                label.style.display = matches ? 'flex' : 'none';
                if (matches) visibleCount++;
            });
            
            // Also show/hide type headers based on visible items
            const typeDivs = document.querySelectorAll('#merge-relationships-list > div:not(:first-child)');
            typeDivs.forEach(div => {
                const hasVisible = [...div.querySelectorAll('label')].some(l => l.style.display !== 'none');
                div.style.display = hasVisible ? 'block' : 'none';
            });
            
            if (searchTerm) {
                searchStatsDiv.innerHTML = `${t('searchResults')}: ${visibleCount} ${t('of')} ${totalCount} ${t('relationshipsLabel').toLowerCase()}`;
            } else {
                searchStatsDiv.innerHTML = '';
            }
        } else if (currentMergeTab === 'diagrams') {
            const labels = document.querySelectorAll('#merge-diagrams-list label');
            let visibleCount = 0;
            let totalCount = labels.length;
            
            labels.forEach(label => {
                const text = label.textContent.toLowerCase();
                const matches = searchTerm === '' || text.includes(searchTerm);
                label.style.display = matches ? 'flex' : 'none';
                if (matches) visibleCount++;
            });
            
            if (searchTerm) {
                searchStatsDiv.innerHTML = `${t('searchResults')}: ${visibleCount} ${t('of')} ${totalCount} ${t('diagramsLabel').toLowerCase()}`;
            } else {
                searchStatsDiv.innerHTML = '';
            }
        }
    }
    
    function loadMergePreview() {
        const fileInput = document.getElementById('merge-file');
        const listDiv = document.getElementById('merge-elements-list');
        const relListDiv = document.getElementById('merge-relationships-list');
        const diagListDiv = document.getElementById('merge-diagrams-list');
        const statsDiv = document.getElementById('merge-selection-stats');
        const resultDiv = document.getElementById('merge-result');
        const searchInput = document.getElementById('merge-search-input');
        const searchStatsDiv = document.getElementById('merge-search-stats');
        
        resultDiv.style.display = 'none';
        
        // Clear search
        if (searchInput) searchInput.value = '';
        if (searchStatsDiv) searchStatsDiv.innerHTML = '';
        
        if (!fileInput.files || fileInput.files.length === 0) {
            mergePreviewData = null;
            listDiv.innerHTML = `<p style="color: #666;">${t('selectFileFirst')}</p>`;
            relListDiv.innerHTML = `<p style="color: #666;">${t('selectFileFirst')}</p>`;
            diagListDiv.innerHTML = `<p style="color: #666;">${t('selectFileFirst')}</p>`;
            statsDiv.innerHTML = '';
            return;
        }
        
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const content = e.target.result;
                
                // Detect format and parse
                if (content.trim().startsWith('{')) {
                    // JSON format
                    const json = JSON.parse(content);
                    mergeSourceModelName = json.model?.name || json.name || file.name.replace(/\.[^/.]+$/, '');
                    mergePreviewData = {
                        elements: json.elements || [],
                        relationships: json.relationships || [],
                        diagrams: json.diagrams || []
                    };
                } else if (content.trim().startsWith('<')) {
                    // XML format
                    mergePreviewData = parseArchiMateXMLForMerge(content);
                    mergeSourceModelName = mergePreviewData.modelName || file.name.replace(/\.[^/.]+$/, '');
                } else {
                    throw new Error(t('unsupportedFormat'));
                }
                
                renderMergeElementsList();
                renderMergeRelationshipsList();
                renderMergeDiagramsList();
                
            } catch (err) {
                listDiv.innerHTML = `<p style="color: #c00;">${t('error')}: ${escapeHtml(err.message)}</p>`;
                relListDiv.innerHTML = `<p style="color: #c00;">${t('error')}: ${escapeHtml(err.message)}</p>`;
                diagListDiv.innerHTML = `<p style="color: #c00;">${t('error')}: ${escapeHtml(err.message)}</p>`;
                statsDiv.innerHTML = '';
                mergePreviewData = null;
            }
        };
        
        reader.readAsText(file);
    }
    
    function renderMergeElementsList() {
        const listDiv = document.getElementById('merge-elements-list');
        const statsDiv = document.getElementById('merge-selection-stats');
        const strategy = document.getElementById('merge-strategy').value;
        
        if (!mergePreviewData) {
            listDiv.innerHTML = `<p style="color: #666;">${t('selectFileFirst')}</p>`;
            statsDiv.innerHTML = '';
            return;
        }
        
        const importedElements = mergePreviewData.elements;
        
        if (importedElements.length === 0) {
            listDiv.innerHTML = '<p style="color: #666;">Soubor neobsahuje ≈æ√°dn√© prvky.</p>';
            statsDiv.innerHTML = '';
            return;
        }
        
        // Group elements by layer
        const byLayer = {};
        importedElements.forEach(el => {
            if (!byLayer[el.layer]) byLayer[el.layer] = [];
            byLayer[el.layer].push(el);
        });
        
        let html = '';
        
        // Sort layers
        const layerOrder = ['strategy', 'business', 'application', 'technology', 'physical', 'implementation', 'motivation', 'composite'];
        const sortedLayers = Object.keys(byLayer).sort((a, b) => {
            return layerOrder.indexOf(a) - layerOrder.indexOf(b);
        });
        
        sortedLayers.forEach(layer => {
            const layerInfo = ARCHIMATE_LAYERS[layer];
            const layerName = layerInfo ? layerInfo.name : layer;
            const layerElements = byLayer[layer];
            
            html += `<div style="margin-bottom: 15px;">`;
            html += `<div style="font-weight: bold; margin-bottom: 5px; color: ${layerInfo?.color || '#333'};">${escapeHtml(layerName)} (${layerElements.length})</div>`;
            
            layerElements.forEach(el => {
                const existsInModel = elements.some(e => e.id === el.id);
                const existsLabel = existsInModel ? '<span style="color: #c90; font-size: 11px;" title="Prvek s t√≠mto ID ji≈æ existuje v modelu">‚ö†Ô∏è existuje</span>' : '<span style="color: #090; font-size: 11px;">nov√Ω</span>';
                const stereotypePart = el.stereotype ? `<span style="color: #666;">¬´${escapeHtml(el.stereotype)}¬ª</span> ` : '';
                const tagsHtml = el.p≈ô√≠znaky ? `<span style="color: #1976d2; font-size: 11px; margin-left: 6px;">üè∑Ô∏è ${escapeHtml(el.p≈ô√≠znaky)}</span>` : '';
                
                // Store searchable text in data attribute for filtering
                const searchableText = [el.name || '', el.id, el.type, el.stereotype || '', el.p≈ô√≠znaky || '', el.description || ''].join(' ').toLowerCase();
                
                html += `
                    <label style="display: flex; align-items: center; padding: 4px 8px; margin: 2px 0; background: ${existsInModel ? '#fff8e6' : '#fff'}; border-radius: 3px; cursor: pointer;" data-search="${escapeHtml(searchableText)}">
                        <input type="checkbox" class="merge-element-checkbox" value="${escapeHtml(el.id)}" style="margin-right: 8px;">
                        <span style="flex: 1;">
                            ${stereotypePart}<strong>${escapeHtml(el.name || el.id)}</strong>
                            <span style="color: #888; font-size: 12px;"> ‚Äî ${escapeHtml(el.type)}</span>${tagsHtml}
                        </span>
                        ${existsLabel}
                    </label>
                `;
            });
            
            html += `</div>`;
        });
        
        listDiv.innerHTML = html;
        
        // Add change listeners for stats update
        listDiv.querySelectorAll('.merge-element-checkbox').forEach(cb => {
            cb.addEventListener('change', updateMergeSelectionStats);
        });
        
        updateMergeSelectionStats();
        
        // Show info
        statsDiv.innerHTML = `<strong>${t('modelLabel')}:</strong> ${escapeHtml(mergeSourceModelName)} | <strong>${t('totalElements')}:</strong> ${importedElements.length} | <strong>${t('relationshipsLabel')}:</strong> ${mergePreviewData.relationships.length} | <strong>${t('diagramsLabel')}:</strong> ${mergePreviewData.diagrams.length}`;
    }
    
    function renderMergeRelationshipsList() {
        const listDiv = document.getElementById('merge-relationships-list');
        
        if (!mergePreviewData) {
            listDiv.innerHTML = `<p style="color: #666;">${t('selectFileFirst')}</p>`;
            return;
        }
        
        const importedRelationships = mergePreviewData.relationships;
        const importedElements = mergePreviewData.elements;
        
        // Create element lookup map
        const elementMap = {};
        importedElements.forEach(el => {
            elementMap[el.id] = el;
        });
        
        if (importedRelationships.length === 0) {
            listDiv.innerHTML = '<p style="color: #666;">Soubor neobsahuje ≈æ√°dn√© vazby.</p>';
            return;
        }
        
        let html = `<p style="color: #666; font-size: 12px; margin-bottom: 10px;">${t('relImportNote')}</p>`;
        
        // Group by type
        const byType = {};
        importedRelationships.forEach(rel => {
            if (!byType[rel.type]) byType[rel.type] = [];
            byType[rel.type].push(rel);
        });
        
        const sortedTypes = Object.keys(byType).sort();
        
        sortedTypes.forEach(type => {
            const rels = byType[type];
            
            html += `<div style="margin-bottom: 15px;">`;
            html += `<div style="font-weight: bold; margin-bottom: 5px;">${escapeHtml(type)} (${rels.length})</div>`;
            
            rels.forEach(rel => {
                const existsInModel = relationships.some(r => r.id === rel.id);
                const existsLabel = existsInModel ? '<span style="color: #c90; font-size: 11px;">‚ö†Ô∏è existuje</span>' : '<span style="color: #090; font-size: 11px;">nov√Ω</span>';
                
                const sourceEl = elementMap[rel.sourceId];
                const targetEl = elementMap[rel.targetId];
                const sourceName = sourceEl ? (sourceEl.name || sourceEl.id) : rel.sourceId;
                const targetName = targetEl ? (targetEl.name || targetEl.id) : rel.targetId;
                
                const namePart = rel.name ? `<strong>"${escapeHtml(rel.name)}"</strong>: ` : '';
                const tagsHtml = rel.p≈ô√≠znaky ? `<span style="color: #1976d2; font-size: 11px; margin-left: 6px;">üè∑Ô∏è ${escapeHtml(rel.p≈ô√≠znaky)}</span>` : '';
                
                // Store searchable text in data attribute for filtering
                const searchableText = [rel.name || '', rel.type, sourceName, targetName, rel.p≈ô√≠znaky || '', rel.description || ''].join(' ').toLowerCase();
                
                html += `
                    <label style="display: flex; align-items: center; padding: 4px 8px; margin: 2px 0; background: ${existsInModel ? '#fff8e6' : '#fff'}; border-radius: 3px; cursor: pointer;" data-search="${escapeHtml(searchableText)}">
                        <input type="checkbox" class="merge-relationship-checkbox" value="${escapeHtml(rel.id)}" data-source="${escapeHtml(rel.sourceId)}" data-target="${escapeHtml(rel.targetId)}" style="margin-right: 8px;">
                        <span style="flex: 1; font-size: 13px;">
                            ${namePart}${escapeHtml(sourceName)} ‚Üí ${escapeHtml(targetName)}${tagsHtml}
                        </span>
                        ${existsLabel}
                    </label>
                `;
            });
            
            html += `</div>`;
        });
        
        listDiv.innerHTML = html;
        
        // Add change listeners - when relationship is selected, select its source and target elements too
        listDiv.querySelectorAll('.merge-relationship-checkbox').forEach(cb => {
            cb.addEventListener('change', function() {
                if (this.checked) {
                    // Select source and target elements
                    const sourceId = this.dataset.source;
                    const targetId = this.dataset.target;
                    
                    const sourceCheckbox = document.querySelector(`.merge-element-checkbox[value="${sourceId}"]`);
                    const targetCheckbox = document.querySelector(`.merge-element-checkbox[value="${targetId}"]`);
                    
                    if (sourceCheckbox && !sourceCheckbox.checked) {
                        sourceCheckbox.checked = true;
                    }
                    if (targetCheckbox && !targetCheckbox.checked) {
                        targetCheckbox.checked = true;
                    }
                }
                updateMergeSelectionStats();
            });
        });
    }
    
    function renderMergeDiagramsList() {
        const listDiv = document.getElementById('merge-diagrams-list');
        
        if (!mergePreviewData) {
            listDiv.innerHTML = `<p style="color: #666;">${t('selectFileFirst')}</p>`;
            return;
        }
        
        const importedDiagrams = mergePreviewData.diagrams;
        const importedElements = mergePreviewData.elements;
        
        // Create element lookup map
        const elementMap = {};
        importedElements.forEach(el => {
            elementMap[el.id] = el;
        });
        
        if (importedDiagrams.length === 0) {
            listDiv.innerHTML = '<p style="color: #666;">Soubor neobsahuje ≈æ√°dn√© diagramy.</p>';
            return;
        }
        
        let html = `<p style="color: #666; font-size: 12px; margin-bottom: 10px;">${t('diagImportNote')}</p>`;
        
        importedDiagrams.forEach(diag => {
            const existsInModel = diagrams.some(d => d.id === diag.id);
            const existsLabel = existsInModel ? '<span style="color: #c90; font-size: 11px;">‚ö†Ô∏è existuje</span>' : '<span style="color: #090; font-size: 11px;">nov√Ω</span>';
            
            const elementCount = diag.elementIds ? diag.elementIds.length : 0;
            const elementNames = diag.elementIds ? diag.elementIds.slice(0, 3).map(id => {
                const el = elementMap[id];
                return el ? (el.name || el.id) : id;
            }).join(', ') + (elementCount > 3 ? '...' : '') : '';
            
            html += `
                <label style="display: flex; align-items: center; padding: 8px 10px; margin: 4px 0; background: ${existsInModel ? '#fff8e6' : '#fff'}; border-radius: 3px; cursor: pointer; border: 1px solid #eee;">
                    <input type="checkbox" class="merge-diagram-checkbox" value="${escapeHtml(diag.id)}" data-elements="${escapeHtml(JSON.stringify(diag.elementIds || []))}" style="margin-right: 10px;">
                    <span style="flex: 1;">
                        <strong style="font-size: 14px;">${escapeHtml(diag.name || diag.id)}</strong>
                        <br>
                        <span style="font-size: 12px; color: #666;">${elementCount} ${t('elementsSmall')}${elementNames ? ': ' + escapeHtml(elementNames) : ''}</span>
                    </span>
                    ${existsLabel}
                </label>
            `;
        });
        
        listDiv.innerHTML = html;
        
        // Add change listeners - when diagram is selected, select its elements and their relationships too
        listDiv.querySelectorAll('.merge-diagram-checkbox').forEach(cb => {
            cb.addEventListener('change', function() {
                if (this.checked) {
                    // Select all elements in the diagram
                    const elementIds = JSON.parse(this.dataset.elements || '[]');
                    elementIds.forEach(id => {
                        const elementCheckbox = document.querySelector(`.merge-element-checkbox[value="${id}"]`);
                        if (elementCheckbox && !elementCheckbox.checked) {
                            elementCheckbox.checked = true;
                        }
                    });
                    
                    // Also select relationships where both source and target are in this diagram
                    const elementIdSet = new Set(elementIds);
                    document.querySelectorAll('.merge-relationship-checkbox').forEach(relCb => {
                        const sourceId = relCb.dataset.source;
                        const targetId = relCb.dataset.target;
                        if (elementIdSet.has(sourceId) && elementIdSet.has(targetId)) {
                            relCb.checked = true;
                        }
                    });
                }
                updateMergeSelectionStats();
            });
        });
    }
    
    function updateMergeSelectionStats() {
        const elementCheckboxes = document.querySelectorAll('.merge-element-checkbox');
        const elementChecked = document.querySelectorAll('.merge-element-checkbox:checked');
        const relCheckboxes = document.querySelectorAll('.merge-relationship-checkbox');
        const relChecked = document.querySelectorAll('.merge-relationship-checkbox:checked');
        const diagCheckboxes = document.querySelectorAll('.merge-diagram-checkbox');
        const diagChecked = document.querySelectorAll('.merge-diagram-checkbox:checked');
        const statsDiv = document.getElementById('merge-selection-stats');
        
        if (mergePreviewData) {
            const selectedElementIds = new Set([...elementChecked].map(cb => cb.value));
            const selectedRelIds = new Set([...relChecked].map(cb => cb.value));
            const selectedDiagIds = new Set([...diagChecked].map(cb => cb.value));
            
            // Count relationships that would be imported:
            // - explicitly selected in relationships tab
            // - OR both source and target are selected in elements tab
            let relCount = 0;
            mergePreviewData.relationships.forEach(r => {
                if (selectedRelIds.has(r.id) || (selectedElementIds.has(r.sourceId) && selectedElementIds.has(r.targetId))) {
                    relCount++;
                }
            });
            
            // Count diagrams that will be imported:
            // - explicitly selected in diagrams tab
            // - OR have at least one selected element
            let diagCount = 0;
            mergePreviewData.diagrams.forEach(d => {
                if (selectedDiagIds.has(d.id) || d.elementIds.some(id => selectedElementIds.has(id))) {
                    diagCount++;
                }
            });
            
            statsDiv.innerHTML = `<strong>${t('modelLabel')}:</strong> ${escapeHtml(mergeSourceModelName)} | <strong>${t('selectedCount')}:</strong> ${elementChecked.length} ${t('of')} ${elementCheckboxes.length} ${t('elementsSmall')} | <strong>${t('relSelectedCount')}:</strong> ${relChecked.length} | <strong>${t('diagSelectedCount')}:</strong> ${diagChecked.length} | <strong>${t('relToImport')}:</strong> ${relCount} | <strong>${t('diagToImport')}:</strong> ${diagCount}`;
        }
    }
    
    function mergeSelectAll(select) {
        if (currentMergeTab === 'elements') {
            // Only affect visible checkboxes (not hidden by search filter)
            document.querySelectorAll('#merge-elements-list label').forEach(label => {
                if (label.style.display !== 'none') {
                    const cb = label.querySelector('.merge-element-checkbox');
                    if (cb) cb.checked = select;
                }
            });
        } else if (currentMergeTab === 'relationships') {
            // Only affect visible checkboxes (not hidden by search filter)
            document.querySelectorAll('#merge-relationships-list label').forEach(label => {
                if (label.style.display !== 'none') {
                    const cb = label.querySelector('.merge-relationship-checkbox');
                    if (cb) {
                        cb.checked = select;
                        // When selecting relationships, also select their elements
                        if (select) {
                            const sourceId = cb.dataset.source;
                            const targetId = cb.dataset.target;
                            const sourceCheckbox = document.querySelector(`.merge-element-checkbox[value="${sourceId}"]`);
                            const targetCheckbox = document.querySelector(`.merge-element-checkbox[value="${targetId}"]`);
                            if (sourceCheckbox) sourceCheckbox.checked = true;
                            if (targetCheckbox) targetCheckbox.checked = true;
                        }
                    }
                }
            });
        } else if (currentMergeTab === 'diagrams') {
            // Only affect visible checkboxes (not hidden by search filter)
            document.querySelectorAll('#merge-diagrams-list label').forEach(label => {
                if (label.style.display !== 'none') {
                    const cb = label.querySelector('.merge-diagram-checkbox');
                    if (cb) {
                        cb.checked = select;
                        // When selecting diagrams, also select their elements and relationships
                        if (select) {
                            const elementIds = JSON.parse(cb.dataset.elements || '[]');
                            const elementIdSet = new Set(elementIds);
                            
                            elementIds.forEach(id => {
                                const elementCheckbox = document.querySelector(`.merge-element-checkbox[value="${id}"]`);
                                if (elementCheckbox) elementCheckbox.checked = true;
                            });
                            
                            // Also select relationships where both source and target are in this diagram
                            document.querySelectorAll('.merge-relationship-checkbox').forEach(relCb => {
                                const sourceId = relCb.dataset.source;
                                const targetId = relCb.dataset.target;
                                if (elementIdSet.has(sourceId) && elementIdSet.has(targetId)) {
                                    relCb.checked = true;
                                }
                            });
                        }
                    }
                }
            });
        }
        updateMergeSelectionStats();
    }
    
    function mergeModel() {
        const fileInput = document.getElementById('merge-file');
        const strategy = document.getElementById('merge-strategy').value;
        const resultDiv = document.getElementById('merge-result');
        
        if (!fileInput.files || fileInput.files.length === 0) {
            alert(t('alertSelectFile'));
            return;
        }
        
        // For manual strategy, use preview data
        if (strategy === 'manual') {
            if (!mergePreviewData) {
                alert(t('alertWaitForFile'));
                return;
            }
            executeMergeManual();
            return;
        }
        
        // For skip/overwrite strategies, read file and merge
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const content = e.target.result;
                let importedData = null;
                let sourceModelName = '';
                
                // Detect format and parse
                if (content.trim().startsWith('{')) {
                    // JSON format
                    const json = JSON.parse(content);
                    sourceModelName = json.model?.name || json.name || file.name.replace(/\.[^/.]+$/, '');
                    importedData = {
                        elements: json.elements || [],
                        relationships: json.relationships || [],
                        diagrams: json.diagrams || []
                    };
                } else if (content.trim().startsWith('<')) {
                    // XML format
                    importedData = parseArchiMateXMLForMerge(content);
                    sourceModelName = importedData.modelName || file.name.replace(/\.[^/.]+$/, '');
                } else {
                    throw new Error(t('unsupportedFormat'));
                }
                
                executeMerge(importedData, sourceModelName, strategy);
                
            } catch (err) {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#f8d7da';
                resultDiv.style.border = '1px solid #f5c6cb';
                resultDiv.innerHTML = `<strong>‚ùå ${t('errorMerge')}:</strong> ${escapeHtml(err.message)}`;
            }
        };
        
        reader.readAsText(file);
    }
    
    function executeMergeManual() {
        const resultDiv = document.getElementById('merge-result');
        const selectedElementCheckboxes = document.querySelectorAll('.merge-element-checkbox:checked');
        const selectedRelCheckboxes = document.querySelectorAll('.merge-relationship-checkbox:checked');
        const selectedDiagCheckboxes = document.querySelectorAll('.merge-diagram-checkbox:checked');
        
        const selectedElementIds = new Set([...selectedElementCheckboxes].map(cb => cb.value));
        const selectedRelIds = new Set([...selectedRelCheckboxes].map(cb => cb.value));
        const selectedDiagIds = new Set([...selectedDiagCheckboxes].map(cb => cb.value));
        
        // Add source and target element IDs from selected relationships
        selectedRelCheckboxes.forEach(cb => {
            selectedElementIds.add(cb.dataset.source);
            selectedElementIds.add(cb.dataset.target);
        });
        
        // Add element IDs from explicitly selected diagrams
        selectedDiagCheckboxes.forEach(cb => {
            const elementIds = JSON.parse(cb.dataset.elements || '[]');
            elementIds.forEach(id => selectedElementIds.add(id));
        });
        
        if (selectedElementIds.size === 0 && selectedDiagIds.size === 0) {
            alert(t('alertSelectAtLeastOne'));
            return;
        }
        
        const importTag = `${t('importedFrom')} ${mergeSourceModelName}`;
        
        let stats = {
            elementsAdded: 0,
            elementsOverwritten: 0,
            relationshipsAdded: 0,
            relationshipsOverwritten: 0,
            diagramsAdded: 0,
            diagramsOverwritten: 0
        };
        
        // Import selected elements (always overwrite if exists)
        mergePreviewData.elements.forEach(importedEl => {
            if (!selectedElementIds.has(importedEl.id)) return;
            
            // Clone the element to avoid modifying source data
            const elToImport = JSON.parse(JSON.stringify(importedEl));
            
            const existingIndex = elements.findIndex(e => e.id === elToImport.id);
            elToImport.p≈ô√≠znaky = addTagToP≈ô√≠znaky(elToImport.p≈ô√≠znaky, importTag);
            
            if (existingIndex === -1) {
                elements.push(elToImport);
                stats.elementsAdded++;
            } else {
                elements[existingIndex] = elToImport;
                stats.elementsOverwritten++;
            }
        });
        
        // Import relationships:
        // - explicitly selected in relationships tab
        // - OR where both source and target are selected in elements tab
        mergePreviewData.relationships.forEach(importedRel => {
            const isExplicitlySelected = selectedRelIds.has(importedRel.id);
            const bothElementsSelected = selectedElementIds.has(importedRel.sourceId) && selectedElementIds.has(importedRel.targetId);
            
            if (!isExplicitlySelected && !bothElementsSelected) return;
            
            // Clone the relationship to avoid modifying source data
            const relToImport = JSON.parse(JSON.stringify(importedRel));
            
            const existingIndex = relationships.findIndex(r => r.id === relToImport.id);
            relToImport.p≈ô√≠znaky = addTagToP≈ô√≠znaky(relToImport.p≈ô√≠znaky, importTag);
            
            if (existingIndex === -1) {
                relationships.push(relToImport);
                stats.relationshipsAdded++;
            } else {
                relationships[existingIndex] = relToImport;
                stats.relationshipsOverwritten++;
            }
        });
        
        // Import diagrams:
        // - explicitly selected in diagrams tab (with all their elements)
        // - OR those that contain at least one selected element (filtered to selected elements only)
        mergePreviewData.diagrams.forEach(importedDiag => {
            const isExplicitlySelected = selectedDiagIds.has(importedDiag.id);
            const filteredElementIds = importedDiag.elementIds.filter(id => selectedElementIds.has(id));
            
            // Skip if not selected and no elements selected
            if (!isExplicitlySelected && filteredElementIds.length === 0) return;
            
            // Clone the diagram to avoid modifying source data
            const diagToImport = JSON.parse(JSON.stringify(importedDiag));
            
            const existingIndex = diagrams.findIndex(d => d.id === diagToImport.id);
            
            // If explicitly selected, keep all elements; otherwise filter to selected
            if (!isExplicitlySelected) {
                diagToImport.elementIds = filteredElementIds;
            }
            
            if (!diagToImport.description) {
                diagToImport.description = importTag;
            } else {
                diagToImport.description = diagToImport.description + ' | ' + importTag;
            }
            
            if (existingIndex === -1) {
                diagrams.push(diagToImport);
                stats.diagramsAdded++;
            } else {
                diagrams[existingIndex] = diagToImport;
                stats.diagramsOverwritten++;
            }
        });
        
        finalizeMerge(stats, mergeSourceModelName, t('manuallySelected'));
    }
    
    function executeMerge(importedData, sourceModelName, strategy) {
        const importTag = `${t('importedFrom')} ${sourceModelName}`;
        
        let stats = {
            elementsAdded: 0,
            elementsOverwritten: 0,
            elementsSkipped: 0,
            relationshipsAdded: 0,
            relationshipsOverwritten: 0,
            relationshipsSkipped: 0,
            diagramsAdded: 0,
            diagramsOverwritten: 0,
            diagramsSkipped: 0
        };
        
        // Merge elements
        importedData.elements.forEach(importedEl => {
            const existingIndex = elements.findIndex(e => e.id === importedEl.id);
            
            if (existingIndex === -1) {
                importedEl.p≈ô√≠znaky = addTagToP≈ô√≠znaky(importedEl.p≈ô√≠znaky, importTag);
                elements.push(importedEl);
                stats.elementsAdded++;
            } else if (strategy === 'overwrite') {
                importedEl.p≈ô√≠znaky = addTagToP≈ô√≠znaky(importedEl.p≈ô√≠znaky, importTag);
                elements[existingIndex] = importedEl;
                stats.elementsOverwritten++;
            } else {
                stats.elementsSkipped++;
            }
        });
        
        // Merge relationships
        importedData.relationships.forEach(importedRel => {
            const existingIndex = relationships.findIndex(r => r.id === importedRel.id);
            
            if (existingIndex === -1) {
                importedRel.p≈ô√≠znaky = addTagToP≈ô√≠znaky(importedRel.p≈ô√≠znaky, importTag);
                relationships.push(importedRel);
                stats.relationshipsAdded++;
            } else if (strategy === 'overwrite') {
                importedRel.p≈ô√≠znaky = addTagToP≈ô√≠znaky(importedRel.p≈ô√≠znaky, importTag);
                relationships[existingIndex] = importedRel;
                stats.relationshipsOverwritten++;
            } else {
                stats.relationshipsSkipped++;
            }
        });
        
        // Merge diagrams
        importedData.diagrams.forEach(importedDiag => {
            const existingIndex = diagrams.findIndex(d => d.id === importedDiag.id);
            
            if (!importedDiag.description) {
                importedDiag.description = importTag;
            } else {
                importedDiag.description = importedDiag.description + ' | ' + importTag;
            }
            
            if (existingIndex === -1) {
                diagrams.push(importedDiag);
                stats.diagramsAdded++;
            } else if (strategy === 'overwrite') {
                diagrams[existingIndex] = importedDiag;
                stats.diagramsOverwritten++;
            } else {
                stats.diagramsSkipped++;
            }
        });
        
        const strategyText = strategy === 'skip' ? 'ponech√°ny st√°vaj√≠c√≠' : 'p≈ôeps√°ny nov√Ωmi';
        finalizeMerge(stats, sourceModelName, strategyText);
    }
    
    function finalizeMerge(stats, sourceModelName, strategyText) {
        const resultDiv = document.getElementById('merge-result');
        const fileInput = document.getElementById('merge-file');
        
        // Update UI
        renderElementsTable();
        renderRelationshipsTable();
        renderDiagramsTable();
        populateElementSelects();
        updateStereotypeSuggestions();
        updateP≈ô√≠znakySuggestions();
        updateStereotypeFilter();
        updateP≈ô√≠znakyFilters();
        updateRelNameSuggestions();
        updateRelSourceTargetFilters();
        updateDiagramFilters();
        updateModelStats();
        saveToLocalStorage();
        
        // Show result
        resultDiv.style.display = 'block';
        resultDiv.style.background = '#d4edda';
        resultDiv.style.border = '1px solid #c3e6cb';
        
        let resultHtml = `
            <strong>‚úÖ ${t('mergeSuccess')}</strong><br>
            ${t('sourceModel')}: <em>${escapeHtml(sourceModelName)}</em><br>
            ${t('strategy')}: ${escapeHtml(strategyText)}<br><br>
            <strong>${t('elementsLabel')}:</strong> +${stats.elementsAdded} ${t('newCount')}, ${stats.elementsOverwritten} ${t('overwrittenCount')}`;
        
        if (stats.elementsSkipped !== undefined) {
            resultHtml += `, ${stats.elementsSkipped} ${t('skippedCount')}`;
        }
        
        resultHtml += `<br><strong>${t('relationshipsLabel')}:</strong> +${stats.relationshipsAdded} ${t('newCount')}, ${stats.relationshipsOverwritten} ${t('overwrittenCount')}`;
        
        if (stats.relationshipsSkipped !== undefined) {
            resultHtml += `, ${stats.relationshipsSkipped} ${t('skippedCount')}`;
        }
        
        resultHtml += `<br><strong>${t('diagramsLabel')}:</strong> +${stats.diagramsAdded} ${t('newCount')}, ${stats.diagramsOverwritten} ${t('overwrittenCount')}`;
        
        if (stats.diagramsSkipped !== undefined) {
            resultHtml += `, ${stats.diagramsSkipped} ${t('skippedCount')}`;
        }
        
        resultDiv.innerHTML = resultHtml;
        
        // Clear file input and preview
        fileInput.value = '';
        mergePreviewData = null;
        document.getElementById('merge-elements-list').innerHTML = `<p style="color: #666;">${t('selectFileFirst')}</p>`;
        document.getElementById('merge-selection-stats').innerHTML = '';
    }
    
    function addTagToP≈ô√≠znaky(existingP≈ô√≠znaky, newTag) {
        if (!existingP≈ô√≠znaky || !existingP≈ô√≠znaky.trim()) {
            return newTag;
        }
        const tags = existingP≈ô√≠znaky.split(',').map(t => t.trim());
        if (!tags.includes(newTag)) {
            tags.push(newTag);
        }
        return tags.join(', ');
    }
    
    function parseArchiMateXMLForMerge(xmlContent) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(xmlContent, 'text/xml');
        
        const parserError = doc.querySelector('parsererror');
        if (parserError) {
            throw new Error('Neplatn√Ω XML form√°t');
        }
        
        const model = doc.querySelector('model');
        if (!model) {
            throw new Error('XML neobsahuje ArchiMate model');
        }
        
        // Get model name
        const nameNode = model.querySelector(':scope > name');
        const modelName = nameNode ? nameNode.textContent : '';
        
        // Build property definition map
        const propDefMap = {};
        const propDefs = model.querySelectorAll('propertyDefinitions > propertyDefinition');
        propDefs.forEach(pd => {
            const id = pd.getAttribute('identifier');
            const nameEl = pd.querySelector('name') || pd.querySelector('n');
            if (id && nameEl) {
                propDefMap[id] = nameEl.textContent;
            }
        });
        
        // Parse elements
        const parsedElements = [];
        const elNodes = model.querySelectorAll('elements > element');
        elNodes.forEach(el => {
            const type = el.getAttribute('xsi:type') || el.getAttribute('type') || '';
            const id = el.getAttribute('identifier') || '';
            const elNameNode = el.querySelector('name');
            const name = elNameNode ? elNameNode.textContent : '';
            const docNode = el.querySelector('documentation');
            const description = docNode ? docNode.textContent : '';
            
            let stereotype = '';
            let urƒçuje = '';
            let p≈ô√≠znaky = '';
            const propNodes = el.querySelectorAll('properties > property');
            propNodes.forEach(prop => {
                const propDefRef = prop.getAttribute('propertyDefinitionRef') || '';
                const valueNode = prop.querySelector('value');
                const value = valueNode ? valueNode.textContent : '';
                const propName = propDefMap[propDefRef] || '';
                
                if (propName.toLowerCase() === 'stereotype') {
                    stereotype = value;
                } else if (propName === 'Urƒçuje' || propName.toLowerCase() === 'urƒçuje') {
                    urƒçuje = value;
                } else if (propName === 'P≈ô√≠znaky' || propName.toLowerCase() === 'p≈ô√≠znaky') {
                    p≈ô√≠znaky = value;
                }
            });
            
            // Determine layer
            let layer = 'composite';
            for (const [layerKey, layerData] of Object.entries(ARCHIMATE_LAYERS)) {
                if (layerData.elements[type]) {
                    layer = layerKey;
                    break;
                }
            }
            
            if (id && type) {
                parsedElements.push({ id, layer, type, stereotype, name, urƒçuje, p≈ô√≠znaky, description });
            }
        });
        
        // Parse relationships
        const parsedRelationships = [];
        const relNodes = model.querySelectorAll('relationships > relationship');
        relNodes.forEach(rel => {
            const type = rel.getAttribute('xsi:type') || rel.getAttribute('type') || '';
            const id = rel.getAttribute('identifier') || '';
            const sourceId = rel.getAttribute('source') || '';
            const targetId = rel.getAttribute('target') || '';
            const relNameNode = rel.querySelector('name');
            const name = relNameNode ? relNameNode.textContent : '';
            const docNode = rel.querySelector('documentation');
            const description = docNode ? docNode.textContent : '';
            
            let p≈ô√≠znaky = '';
            const propNodes = rel.querySelectorAll('properties > property');
            propNodes.forEach(prop => {
                const propDefRef = prop.getAttribute('propertyDefinitionRef') || '';
                const valueNode = prop.querySelector('value');
                const value = valueNode ? valueNode.textContent : '';
                const propName = propDefMap[propDefRef] || '';
                if (propName === 'P≈ô√≠znaky' || propName.toLowerCase() === 'p≈ô√≠znaky') {
                    p≈ô√≠znaky = value;
                }
            });
            
            if (id && sourceId && targetId && type) {
                parsedRelationships.push({ id, sourceId, targetId, type, name, description, p≈ô√≠znaky });
            }
        });
        
        // Parse diagrams
        const parsedDiagrams = [];
        const viewNodes = model.querySelectorAll('views > diagrams > view');
        viewNodes.forEach(view => {
            const id = view.getAttribute('identifier') || '';
            const viewNameNode = view.querySelector('name');
            const name = viewNameNode ? viewNameNode.textContent : '';
            const docNode = view.querySelector('documentation');
            const description = docNode ? docNode.textContent : '';
            
            const elementIds = [];
            const nodes = view.querySelectorAll('node');
            nodes.forEach(node => {
                const elRef = node.getAttribute('elementRef');
                if (elRef && !elementIds.includes(elRef)) {
                    elementIds.push(elRef);
                }
            });
            
            if (id && name) {
                parsedDiagrams.push({
                    id,
                    name,
                    description,
                    elementIds,
                    layoutType: 'layered'
                });
            }
        });
        
        return {
            modelName,
            elements: parsedElements,
            relationships: parsedRelationships,
            diagrams: parsedDiagrams
        };
    }
    
    function clearAllData() {
        if (!confirm(t('confirmClearModel'))) {
            return;
        }
        
        modelMetadata = {
            id: 'id-model-001',
            name: '',
            version: '',
            documentation: '',
            dublinCore: { creator: '', publisher: '', date: '', language: 'cs', rights: '', subject: '', description: '' },
            properties: []
        };
        elements = [];
        relationships = [];
        diagrams = [];
        adrRecords = [];
        notes = [];
        tasks = [];
        
        loadModelMetadataToForm();
        renderModelProperties();
        renderElementsTable();
        renderRelationshipsTable();
        renderDiagramsTable();
        renderAdrTable();
        renderNotesTable();
        renderTasksTable();
        populateElementSelects();
        updateModelStats();
        updateTaskAssigneeFilter();
        saveToLocalStorage();
        
    }

    // ============================================
    // Local Storage
    // ============================================
    
    function saveToLocalStorage() {
        try {
            localStorage.setItem('archimate-model', JSON.stringify(modelMetadata));
            localStorage.setItem('archimate-elements', JSON.stringify(elements));
            localStorage.setItem('archimate-relationships', JSON.stringify(relationships));
            localStorage.setItem('archimate-diagrams', JSON.stringify(diagrams));
            localStorage.setItem('archimate-adr', JSON.stringify(adrRecords));
            localStorage.setItem('archimate-notes', JSON.stringify(notes));
            localStorage.setItem('archimate-tasks', JSON.stringify(tasks));
        } catch (e) {
        }
    }
    
    function loadFromLocalStorage() {
        try {
            const savedModel = localStorage.getItem('archimate-model');
            const savedElements = localStorage.getItem('archimate-elements');
            const savedRelationships = localStorage.getItem('archimate-relationships');
            const savedDiagrams = localStorage.getItem('archimate-diagrams');
            const savedAdr = localStorage.getItem('archimate-adr');
            const savedNotes = localStorage.getItem('archimate-notes');
            const savedTasks = localStorage.getItem('archimate-tasks');
            
            if (savedModel) {
                modelMetadata = JSON.parse(savedModel);
            }
            if (savedElements) {
                elements = JSON.parse(savedElements);
            }
            if (savedRelationships) {
                relationships = JSON.parse(savedRelationships);
            }
            if (savedDiagrams) {
                diagrams = JSON.parse(savedDiagrams);
            }
            if (savedAdr) {
                adrRecords = JSON.parse(savedAdr);
            }
            if (savedNotes) {
                notes = JSON.parse(savedNotes);
            }
            if (savedTasks) {
                tasks = JSON.parse(savedTasks);
            }
            
        } catch (e) {
        }
    }

    // ============================================
    // Reference Tab
    // ============================================
    
    function renderLayersReference() {
        const container = document.getElementById('layers-reference');
        
        let html = '';
        
        for (const [layerKey, layer] of Object.entries(ARCHIMATE_LAYERS)) {
            html += `
                <div style="margin-bottom: 20px;">
                    <h4><span class="layer-badge layer-${layerKey}">${layer.name}</span></h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Typ prvku</th>
                                <th>Popis</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(layer.elements).map(([type, desc]) => `
                                <tr>
                                    <td><strong>${type}</strong></td>
                                    <td>${desc}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        container.innerHTML = html;
    }

    // ============================================
    // ============================================
    // Bulk Operations - Elements
    // ============================================
    
    let selectedElementIds = new Set();
    
    function toggleAllElements(checked) {
        const checkboxes = document.querySelectorAll('.element-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = checked;
            if (checked) {
                selectedElementIds.add(cb.value);
            } else {
                selectedElementIds.delete(cb.value);
            }
        });
        updateElementsBulkPanel();
    }
    
    function updateElementsBulkPanel() {
        const checkboxes = document.querySelectorAll('.element-checkbox:checked');
        selectedElementIds = new Set(Array.from(checkboxes).map(cb => cb.value));
        
        const panel = document.getElementById('elements-bulk-panel');
        const countEl = document.getElementById('elements-selected-count');
        
        if (selectedElementIds.size > 0) {
            panel.style.display = 'flex';
            countEl.textContent = selectedElementIds.size;
        } else {
            panel.style.display = 'none';
        }
        
        // Update select-all checkbox state
        const allCheckboxes = document.querySelectorAll('.element-checkbox');
        const selectAll = document.getElementById('elements-select-all');
        if (selectAll) {
            selectAll.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
            selectAll.indeterminate = checkboxes.length > 0 && checkboxes.length < allCheckboxes.length;
        }
    }
    
    function clearElementSelection() {
        selectedElementIds.clear();
        document.querySelectorAll('.element-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('elements-select-all').checked = false;
        document.getElementById('elements-bulk-action').value = '';
        document.getElementById('elements-bulk-fields').innerHTML = '';
        updateElementsBulkPanel();
    }
    
    function showElementsBulkFields() {
        const action = document.getElementById('elements-bulk-action').value;
        const fieldsDiv = document.getElementById('elements-bulk-fields');
        fieldsDiv.innerHTML = '';
        
        if (action === 'type') {
            // Get all unique types from selected elements' layers
            const selectedLayers = new Set();
            selectedElementIds.forEach(id => {
                const el = elements.find(e => e.id === id);
                if (el) selectedLayers.add(el.layer);
            });
            
            let html = `<label>${t('bulkSelectType')}</label><select id="bulk-element-type">`;
            html += `<option value="">--</option>`;
            
            // Add types from selected layers
            selectedLayers.forEach(layer => {
                if (ARCHIMATE_LAYERS[layer]) {
                    Object.keys(ARCHIMATE_LAYERS[layer].elements).forEach(type => {
                        html += `<option value="${type}">${type}</option>`;
                    });
                }
            });
            html += `</select>`;
            fieldsDiv.innerHTML = html;
        } else if (action === 'stereotype' || action === 'determines' || action === 'description') {
            fieldsDiv.innerHTML = `<label>${t('bulkEnterValue')}</label><input type="text" id="bulk-element-value" style="min-width: 200px;">`;
        } else if (action === 'addTags') {
            fieldsDiv.innerHTML = `<label>${t('bulkEnterTags')}</label><input type="text" id="bulk-element-tags" style="min-width: 200px;">`;
        }
    }
    
    function executeElementsBulkAction() {
        const action = document.getElementById('elements-bulk-action').value;
        if (!action || selectedElementIds.size === 0) return;
        
        if (action === 'delete') {
            const msg = t('confirmBulkDelete', selectedElementIds.size) + '\n\n' + t('bulkDeleteWarning');
            if (!confirm(msg)) return;
            
            let deleted = 0;
            selectedElementIds.forEach(id => {
                deleteElementById(id, true); // silent delete
                deleted++;
            });
            
            clearElementSelection();
            renderElementsTable();
            renderRelationshipsTable();
            updateModelStats();
            saveToLocalStorage();
            alert(t('bulkDeleted', deleted));
            return;
        }
        
        let updated = 0;
        
        if (action === 'type') {
            const newType = document.getElementById('bulk-element-type').value;
            if (!newType) return;
            
            selectedElementIds.forEach(id => {
                const el = elements.find(e => e.id === id);
                if (el) {
                    el.type = newType;
                    updated++;
                }
            });
        } else if (action === 'stereotype') {
            const value = document.getElementById('bulk-element-value').value;
            selectedElementIds.forEach(id => {
                const el = elements.find(e => e.id === id);
                if (el) {
                    el.stereotype = value;
                    updated++;
                }
            });
        } else if (action === 'determines') {
            const value = document.getElementById('bulk-element-value').value;
            selectedElementIds.forEach(id => {
                const el = elements.find(e => e.id === id);
                if (el) {
                    el.urƒçuje = value;
                    updated++;
                }
            });
        } else if (action === 'description') {
            const value = document.getElementById('bulk-element-value').value;
            selectedElementIds.forEach(id => {
                const el = elements.find(e => e.id === id);
                if (el) {
                    el.description = value;
                    updated++;
                }
            });
        } else if (action === 'addTags') {
            const newTags = document.getElementById('bulk-element-tags').value.split(',').map(t => t.trim()).filter(t => t);
            if (newTags.length === 0) return;
            
            selectedElementIds.forEach(id => {
                const el = elements.find(e => e.id === id);
                if (el) {
                    const existingTags = el.p≈ô√≠znaky ? el.p≈ô√≠znaky.split(',').map(t => t.trim()).filter(t => t) : [];
                    const mergedTags = [...new Set([...existingTags, ...newTags])];
                    el.p≈ô√≠znaky = mergedTags.join(', ');
                    updated++;
                }
            });
        }
        
        if (updated > 0) {
            clearElementSelection();
            renderElementsTable();
            updateStereotypeSuggestions();
            updateP≈ô√≠znakySuggestions();
            updateModelStats();
            saveToLocalStorage();
            alert(t('bulkUpdated', updated));
        }
    }
    
    function deleteElementById(id, silent = false) {
        const element = elements.find(e => e.id === id);
        if (!element) return false;
        
        if (!silent) {
            const relCount = relationships.filter(r => r.sourceId === id || r.targetId === id).length;
            const msg = t('confirmDeleteElement', element.name || id);
            if (!confirm(msg)) return false;
        }
        
        // Remove from elements array
        const index = elements.findIndex(e => e.id === id);
        if (index !== -1) {
            elements.splice(index, 1);
        }
        
        // Remove all relationships containing this element
        relationships = relationships.filter(r => r.sourceId !== id && r.targetId !== id);
        
        // Remove from all diagrams
        diagrams.forEach(d => {
            const idx = d.elementIds.indexOf(id);
            if (idx !== -1) {
                d.elementIds.splice(idx, 1);
            }
        });
        
        // Remove from ADR linkedElements
        adrRecords.forEach(a => {
            if (a.linkedElements) {
                const idx = a.linkedElements.indexOf(id);
                if (idx !== -1) a.linkedElements.splice(idx, 1);
            }
        });
        
        // Remove from notes linkedElements
        notes.forEach(n => {
            if (n.linkedElements) {
                const idx = n.linkedElements.indexOf(id);
                if (idx !== -1) n.linkedElements.splice(idx, 1);
            }
        });
        
        // Remove from tasks linkedElements
        tasks.forEach(t => {
            if (t.linkedElements) {
                const idx = t.linkedElements.indexOf(id);
                if (idx !== -1) t.linkedElements.splice(idx, 1);
            }
        });
        
        return true;
    }
    
    // ============================================
    // Bulk Operations - Relationships
    // ============================================
    
    let selectedRelationshipIds = new Set();
    
    function toggleAllRelationships(checked) {
        const checkboxes = document.querySelectorAll('.relationship-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = checked;
            if (checked) {
                selectedRelationshipIds.add(cb.value);
            } else {
                selectedRelationshipIds.delete(cb.value);
            }
        });
        updateRelationshipsBulkPanel();
    }
    
    function updateRelationshipsBulkPanel() {
        const checkboxes = document.querySelectorAll('.relationship-checkbox:checked');
        selectedRelationshipIds = new Set(Array.from(checkboxes).map(cb => cb.value));
        
        const panel = document.getElementById('relationships-bulk-panel');
        const countEl = document.getElementById('relationships-selected-count');
        
        if (selectedRelationshipIds.size > 0) {
            panel.style.display = 'flex';
            countEl.textContent = selectedRelationshipIds.size;
        } else {
            panel.style.display = 'none';
        }
        
        // Update select-all checkbox state
        const allCheckboxes = document.querySelectorAll('.relationship-checkbox');
        const selectAll = document.getElementById('relationships-select-all');
        if (selectAll) {
            selectAll.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
            selectAll.indeterminate = checkboxes.length > 0 && checkboxes.length < allCheckboxes.length;
        }
    }
    
    function clearRelationshipSelection() {
        selectedRelationshipIds.clear();
        document.querySelectorAll('.relationship-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('relationships-select-all').checked = false;
        document.getElementById('relationships-bulk-action').value = '';
        document.getElementById('relationships-bulk-fields').innerHTML = '';
        updateRelationshipsBulkPanel();
    }
    
    function showRelationshipsBulkFields() {
        const action = document.getElementById('relationships-bulk-action').value;
        const fieldsDiv = document.getElementById('relationships-bulk-fields');
        fieldsDiv.innerHTML = '';
        
        if (action === 'type') {
            let html = `<label>${t('bulkSelectType')}</label><select id="bulk-rel-type">`;
            html += `<option value="">--</option>`;
            Object.keys(RELATIONSHIP_TYPES).forEach(type => {
                html += `<option value="${type}">${type}</option>`;
            });
            html += `</select>`;
            fieldsDiv.innerHTML = html;
        } else if (action === 'source' || action === 'target') {
            let html = `<label>${t('bulkSelectElement')}</label><select id="bulk-rel-element">`;
            html += `<option value="">--</option>`;
            elements.forEach(e => {
                const stereotypePart = e.stereotype ? ` ¬´${e.stereotype}¬ª` : '';
                html += `<option value="${escapeHtml(e.id)}">${escapeHtml(e.name)}${escapeHtml(stereotypePart)} (${e.type})</option>`;
            });
            html += `</select>`;
            fieldsDiv.innerHTML = html;
        } else if (action === 'name' || action === 'description') {
            fieldsDiv.innerHTML = `<label>${t('bulkEnterValue')}</label><input type="text" id="bulk-rel-value" style="min-width: 200px;">`;
        } else if (action === 'addTags') {
            fieldsDiv.innerHTML = `<label>${t('bulkEnterTags')}</label><input type="text" id="bulk-rel-tags" style="min-width: 200px;">`;
        }
    }
    
    function executeRelationshipsBulkAction() {
        const action = document.getElementById('relationships-bulk-action').value;
        if (!action || selectedRelationshipIds.size === 0) return;
        
        if (action === 'delete') {
            if (!confirm(t('confirmBulkDelete', selectedRelationshipIds.size))) return;
            
            let deleted = 0;
            selectedRelationshipIds.forEach(id => {
                const index = relationships.findIndex(r => r.id === id);
                if (index !== -1) {
                    relationships.splice(index, 1);
                    deleted++;
                }
            });
            
            // Remove from ADR/notes/tasks linkedRelationships
            const idsToRemove = Array.from(selectedRelationshipIds);
            adrRecords.forEach(a => {
                if (a.linkedRelationships) {
                    a.linkedRelationships = a.linkedRelationships.filter(id => !idsToRemove.includes(id));
                }
            });
            notes.forEach(n => {
                if (n.linkedRelationships) {
                    n.linkedRelationships = n.linkedRelationships.filter(id => !idsToRemove.includes(id));
                }
            });
            tasks.forEach(t => {
                if (t.linkedRelationships) {
                    t.linkedRelationships = t.linkedRelationships.filter(id => !idsToRemove.includes(id));
                }
            });
            
            clearRelationshipSelection();
            renderRelationshipsTable();
            updateModelStats();
            saveToLocalStorage();
            alert(t('bulkDeleted', deleted));
            return;
        }
        
        let updated = 0;
        let skipped = 0;
        
        if (action === 'type') {
            const newType = document.getElementById('bulk-rel-type').value;
            if (!newType) return;
            
            selectedRelationshipIds.forEach(id => {
                const rel = relationships.find(r => r.id === id);
                if (rel) {
                    rel.type = newType;
                    updated++;
                }
            });
        } else if (action === 'source') {
            const newSourceId = document.getElementById('bulk-rel-element').value;
            if (!newSourceId) return;
            
            // Check for duplicates
            const wouldCreateDuplicates = [];
            selectedRelationshipIds.forEach(id => {
                const rel = relationships.find(r => r.id === id);
                if (rel && rel.sourceId !== newSourceId) {
                    // Check if this would create a duplicate
                    const duplicate = relationships.find(r => 
                        r.id !== id && 
                        r.sourceId === newSourceId && 
                        r.targetId === rel.targetId
                    );
                    if (duplicate) {
                        wouldCreateDuplicates.push(id);
                    }
                }
            });
            
            if (wouldCreateDuplicates.length === selectedRelationshipIds.size) {
                alert(t('noDuplicatesAllowed'));
                return;
            }
            
            if (wouldCreateDuplicates.length > 0) {
                alert(t('bulkDuplicateWarning'));
            }
            
            selectedRelationshipIds.forEach(id => {
                if (wouldCreateDuplicates.includes(id)) {
                    skipped++;
                    return;
                }
                const rel = relationships.find(r => r.id === id);
                if (rel && rel.sourceId !== newSourceId && rel.targetId !== newSourceId) {
                    rel.sourceId = newSourceId;
                    updated++;
                }
            });
        } else if (action === 'target') {
            const newTargetId = document.getElementById('bulk-rel-element').value;
            if (!newTargetId) return;
            
            // Check for duplicates
            const wouldCreateDuplicates = [];
            selectedRelationshipIds.forEach(id => {
                const rel = relationships.find(r => r.id === id);
                if (rel && rel.targetId !== newTargetId) {
                    const duplicate = relationships.find(r => 
                        r.id !== id && 
                        r.sourceId === rel.sourceId && 
                        r.targetId === newTargetId
                    );
                    if (duplicate) {
                        wouldCreateDuplicates.push(id);
                    }
                }
            });
            
            if (wouldCreateDuplicates.length === selectedRelationshipIds.size) {
                alert(t('noDuplicatesAllowed'));
                return;
            }
            
            if (wouldCreateDuplicates.length > 0) {
                alert(t('bulkDuplicateWarning'));
            }
            
            selectedRelationshipIds.forEach(id => {
                if (wouldCreateDuplicates.includes(id)) {
                    skipped++;
                    return;
                }
                const rel = relationships.find(r => r.id === id);
                if (rel && rel.targetId !== newTargetId && rel.sourceId !== newTargetId) {
                    rel.targetId = newTargetId;
                    updated++;
                }
            });
        } else if (action === 'name') {
            const value = document.getElementById('bulk-rel-value').value;
            selectedRelationshipIds.forEach(id => {
                const rel = relationships.find(r => r.id === id);
                if (rel) {
                    rel.name = value;
                    updated++;
                }
            });
        } else if (action === 'description') {
            const value = document.getElementById('bulk-rel-value').value;
            selectedRelationshipIds.forEach(id => {
                const rel = relationships.find(r => r.id === id);
                if (rel) {
                    rel.description = value;
                    updated++;
                }
            });
        } else if (action === 'addTags') {
            const newTags = document.getElementById('bulk-rel-tags').value.split(',').map(t => t.trim()).filter(t => t);
            if (newTags.length === 0) return;
            
            selectedRelationshipIds.forEach(id => {
                const rel = relationships.find(r => r.id === id);
                if (rel) {
                    const existingTags = rel.p≈ô√≠znaky ? rel.p≈ô√≠znaky.split(',').map(t => t.trim()).filter(t => t) : [];
                    const mergedTags = [...new Set([...existingTags, ...newTags])];
                    rel.p≈ô√≠znaky = mergedTags.join(', ');
                    updated++;
                }
            });
        }
        
        if (updated > 0) {
            clearRelationshipSelection();
            renderRelationshipsTable();
            updateRelNameSuggestions();
            updateP≈ô√≠znakySuggestions();
            saveToLocalStorage();
            alert(t('bulkUpdated', updated));
        }
    }

    // Utility Functions
    // ============================================
    
    // Store original options for each select that can be filtered
    const selectOriginalOptions = {};
    
    function filterSelectOptions(selectId, filterText) {
        const select = document.getElementById(selectId);
        if (!select) return;
        
        // Store original options on first call
        if (!selectOriginalOptions[selectId]) {
            selectOriginalOptions[selectId] = Array.from(select.options).map(opt => ({
                value: opt.value,
                text: opt.text,
                selected: opt.selected
            }));
        }
        
        const originalOptions = selectOriginalOptions[selectId];
        const filterLower = filterText.toLowerCase().trim();
        
        // Remember currently selected values
        const selectedValues = Array.from(select.selectedOptions).map(opt => opt.value);
        
        // Clear and repopulate
        select.innerHTML = '';
        
        originalOptions.forEach(opt => {
            // Always show empty/placeholder options, or options that match filter
            if (!opt.value || !filterLower || opt.text.toLowerCase().includes(filterLower)) {
                const option = document.createElement('option');
                option.value = opt.value;
                option.text = opt.text;
                // Preserve selection
                option.selected = selectedValues.includes(opt.value);
                select.appendChild(option);
            }
        });
    }
    
    function resetSelectFilter(selectId) {
        const filterInput = document.getElementById(selectId + '-filter');
        if (filterInput) filterInput.value = '';
        delete selectOriginalOptions[selectId];
    }
    
    function updateSelectOriginalOptions(selectId) {
        // Call this when select options are programmatically updated
        delete selectOriginalOptions[selectId];
        const filterInput = document.getElementById(selectId + '-filter');
        if (filterInput && filterInput.value) {
            filterSelectOptions(selectId, filterInput.value);
        }
    }
    
    function escapeHtml(str) {
        if (!str) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }
    
    function escapeXml(str) {
        if (!str) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&apos;');
    }
    
    function toggleColumn(tableId, columnIndex, visible) {
        const table = document.getElementById(tableId);
        if (!table) return;
        
        // Toggle class on table
        table.classList.toggle(`hide-col-${columnIndex}`, !visible);
        
        // Save preference to localStorage
        const key = `col-visibility-${tableId}`;
        let prefs = JSON.parse(localStorage.getItem(key) || '{}');
        prefs[columnIndex] = visible;
        localStorage.setItem(key, JSON.stringify(prefs));
    }
    
    function loadColumnVisibility(tableId) {
        const key = `col-visibility-${tableId}`;
        const prefs = JSON.parse(localStorage.getItem(key) || '{}');
        
        const table = document.getElementById(tableId);
        if (!table) return;
        
        // Find the container with toggles
        const container = table.parentElement;
        if (!container) return;
        
        const details = container.querySelector('.column-toggles');
        if (!details) return;
        
        const checkboxes = details.querySelectorAll('input[type="checkbox"]');
        
        Object.entries(prefs).forEach(([colIndex, visible]) => {
            const idx = parseInt(colIndex);
            if (checkboxes[idx]) {
                checkboxes[idx].checked = visible;
            }
            if (!visible) {
                table.classList.add(`hide-col-${idx}`);
            }
        });
    }

    // ============================================
    // Diagram Functions
    // ============================================
    
    function createDiagram() {
        const name = document.getElementById('new-diagram-name').value.trim();
        if (!name) {
            alert(t('alertEnterDiagramName'));
            return;
        }
        
        const description = document.getElementById('new-diagram-description').value.trim();
        
        const id = 'diagram-' + Date.now();
        const diagram = {
            id: id,
            name: name,
            description: description,
            layoutType: 'layered',
            elementIds: []
        };
        
        diagrams.push(diagram);
        document.getElementById('new-diagram-name').value = '';
        document.getElementById('new-diagram-description').value = '';
        
        renderDiagramsTable();
        updateModelStats();
        saveToLocalStorage();
        
        // Open the new diagram for editing
        openDiagramEditor(id);
    }
    
    function saveDiagramDescription() {
        if (!currentDiagramId) return;
        
        const diagram = diagrams.find(d => d.id === currentDiagramId);
        if (!diagram) return;
        
        diagram.description = document.getElementById('diagram-description').value.trim();
        saveToLocalStorage();
    }
    
    function saveDiagramName() {
        if (!currentDiagramId) return;
        
        const diagram = diagrams.find(d => d.id === currentDiagramId);
        if (!diagram) return;
        
        const newName = document.getElementById('diagram-name-edit').value.trim();
        if (newName) {
            diagram.name = newName;
            document.getElementById('diagram-editor-title').textContent = `Editace: ${newName}`;
            renderDiagramsTable();
            saveToLocalStorage();
            
            // Update main tables to reflect diagram name change
            renderElementsTable();
            renderRelationshipsTable();
        }
    }
    
    function saveDiagramLayout() {
        if (!currentDiagramId) return;
        
        const diagram = diagrams.find(d => d.id === currentDiagramId);
        if (!diagram) return;
        
        diagram.layoutType = document.getElementById('diagram-layout').value;
        renderDiagramPreview();
        saveToLocalStorage();
    }
    
    function renderDiagramsTable() {
        const tbody = document.getElementById('diagrams-tbody');
        
        if (diagrams.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="no-data">' + t('noDiagrams') + '</td></tr>';
            return;
        }
        
        tbody.innerHTML = diagrams.map(d => {
            const relCount = getDiagramRelationships(d.id).length;
            const descriptionHtml = d.description ? `<br><small style="color:#666;">${escapeHtml(d.description)}</small>` : '';
            return `
                <tr>
                    <td><a href="#" class="element-link" onclick="openDiagramEditor('${escapeHtml(d.id)}'); return false;">${escapeHtml(d.name)}</a>${descriptionHtml}</td>
                    <td>${d.elementIds.length}</td>
                    <td>${relCount}</td>
                    <td class="actions">
                        <button type="button" class="btn-secondary" onclick="openDiagramEditor('${escapeHtml(d.id)}')">${t('edit')}</button>
                        <button type="button" class="btn-danger" onclick="deleteDiagram('${escapeHtml(d.id)}')">${t('delete')}</button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    function deleteDiagram(id) {
        const diagram = diagrams.find(d => d.id === id);
        if (!diagram) return;
        
        if (!confirm(t('confirmDeleteDiagram', diagram.name))) {
            return;
        }
        
        diagrams = diagrams.filter(d => d.id !== id);
        renderDiagramsTable();
        updateModelStats();
        saveToLocalStorage();
        
        // Update main tables to reflect diagram membership changes
        renderElementsTable();
        renderRelationshipsTable();
    }
    
    function openDiagramEditor(id) {
        const diagram = diagrams.find(d => d.id === id);
        if (!diagram) return;
        
        currentDiagramId = id;
        
        document.getElementById('diagram-editor-title').textContent = `${t('editDiagram')}: ${diagram.name}`;
        document.getElementById('diagram-name-edit').value = diagram.name || '';
        document.getElementById('diagram-layout').value = diagram.layoutType || 'layered';
        document.getElementById('diagram-description').value = diagram.description || '';
        
        document.getElementById('diagrams-list').style.display = 'none';
        document.getElementById('diagram-editor').classList.add('active');
        
        // Reset subtab to settings
        switchDiagramSubtab('settings');
        
        // Render diagram content
        renderDiagramElements();
        renderDiagramRelationships();
        renderDiagramPreview();
    }
    
    function closeDiagramEditor() {
        currentDiagramId = null;
        
        document.getElementById('diagram-editor').classList.remove('active');
        document.getElementById('diagrams-list').style.display = 'block';
        
        // Clear add element form
        document.getElementById('diagram-add-layer').value = '';
        document.getElementById('diagram-add-type').innerHTML = `<option value="">${t('selectTypeShort')}</option>`;
        document.getElementById('diagram-add-element').innerHTML = `<option value="">${t('selectElementShort')}</option>`;
    }
    
    function switchDiagramSubtab(subtab) {
        // Update buttons
        document.querySelectorAll('.diagram-subtab').forEach(btn => {
            btn.classList.remove('active');
            btn.setAttribute('aria-selected', 'false');
        });
        document.getElementById('diagram-subtab-' + subtab).classList.add('active');
        document.getElementById('diagram-subtab-' + subtab).setAttribute('aria-selected', 'true');
        
        // Update content
        document.querySelectorAll('.diagram-subtab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('diagram-content-' + subtab).classList.add('active');
        
        // Refresh content
        if (subtab === 'elements') {
            renderDiagramElements();
        } else if (subtab === 'relationships') {
            renderDiagramRelationships();
        } else if (subtab === 'preview') {
            renderDiagramPreview();
        }
    }
    
    function updateDiagramAddTypes() {
        const layer = document.getElementById('diagram-add-layer').value;
        const typeSelect = document.getElementById('diagram-add-type');
        const elementSelect = document.getElementById('diagram-add-element');
        
        typeSelect.innerHTML = `<option value="">${t('selectTypeShort')}</option>`;
        elementSelect.innerHTML = `<option value="">${t('selectElementShort')}</option>`;
        
        if (layer && ARCHIMATE_LAYERS[layer]) {
            const typesWithElements = new Set(
                elements.filter(e => e.layer === layer).map(e => e.type)
            );
            
            for (const type of Object.keys(ARCHIMATE_LAYERS[layer].elements)) {
                if (typesWithElements.has(type)) {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    typeSelect.appendChild(option);
                }
            }
        }
    }
    
    function updateDiagramAddElements() {
        const layer = document.getElementById('diagram-add-layer').value;
        const type = document.getElementById('diagram-add-type').value;
        const elementSelect = document.getElementById('diagram-add-element');
        
        elementSelect.innerHTML = `<option value="">${t('selectElementShort')}</option>`;
        
        if (!currentDiagramId) return;
        const diagram = diagrams.find(d => d.id === currentDiagramId);
        if (!diagram) return;
        
        // Filter elements and exclude those already on diagram
        const filtered = elements.filter(e => 
            (!layer || e.layer === layer) && 
            (!type || e.type === type) &&
            !diagram.elementIds.includes(e.id)
        );
        
        filtered.sort((a, b) => a.name.localeCompare(b.name, 'cs'));
        
        filtered.forEach(e => {
            const option = document.createElement('option');
            option.value = e.id;
            const stereotypePart = e.stereotype ? `, ¬´${e.stereotype}¬ª` : '';
            option.textContent = `${e.name}${stereotypePart} [${e.id}]`;
            elementSelect.appendChild(option);
        });
        
        updateSelectOriginalOptions('diagram-add-element');
    }
    
    function addElementToDiagram() {
        const elementId = document.getElementById('diagram-add-element').value;
        if (!elementId) {
            alert(t('alertSelectElementToAdd'));
            return;
        }
        
        if (!currentDiagramId) return;
        const diagram = diagrams.find(d => d.id === currentDiagramId);
        if (!diagram) return;
        
        if (!diagram.elementIds.includes(elementId)) {
            diagram.elementIds.push(elementId);
            saveToLocalStorage();
        }
        
        // Reset selection
        document.getElementById('diagram-add-element').value = '';
        updateDiagramAddElements();
        
        renderDiagramElements();
        renderDiagramRelationships();
        renderDiagramsTable();
        
        // Also update main tables to reflect diagram membership
        renderElementsTable();
        renderRelationshipsTable();
    }
    
    function removeElementFromDiagram(elementId) {
        if (!currentDiagramId) return;
        const diagram = diagrams.find(d => d.id === currentDiagramId);
        if (!diagram) return;
        
        diagram.elementIds = diagram.elementIds.filter(id => id !== elementId);
        saveToLocalStorage();
        
        updateDiagramAddElements();
        renderDiagramElements();
        renderDiagramRelationships();
        renderDiagramsTable();
        
        // Also update main tables to reflect diagram membership
        renderElementsTable();
        renderRelationshipsTable();
    }
    
    function renderDiagramElements() {
        const tbody = document.getElementById('diagram-elements-tbody');
        
        if (!currentDiagramId) {
            tbody.innerHTML = '<tr><td colspan="4" class="no-data">Nen√≠ vybr√°n diagram</td></tr>';
            return;
        }
        
        const diagram = diagrams.find(d => d.id === currentDiagramId);
        if (!diagram || diagram.elementIds.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="no-data">Diagram neobsahuje ≈æ√°dn√© prvky</td></tr>';
            return;
        }
        
        // Get elements and sort by type, then name
        const diagramElements = diagram.elementIds
            .map(id => elements.find(e => e.id === id))
            .filter(e => e)
            .sort((a, b) => {
                const typeCompare = a.type.localeCompare(b.type, 'cs');
                if (typeCompare !== 0) return typeCompare;
                return a.name.localeCompare(b.name, 'cs');
            });
        
        tbody.innerHTML = diagramElements.map(e => {
            const layerInfo = ARCHIMATE_LAYERS[e.layer];
            const layerName = layerInfo ? layerInfo.name : e.layer;
            const stereotypePrefix = e.stereotype ? `<span style="color:#666;">¬´${escapeHtml(e.stereotype)}¬ª</span> ` : '';
            return `
                <tr>
                    <td><span class="layer-badge layer-${e.layer}">${escapeHtml(layerName)}</span></td>
                    <td>${escapeHtml(e.type)}</td>
                    <td>${stereotypePrefix}${escapeHtml(e.name)}</td>
                    <td class="actions">
                        <button type="button" class="btn-danger" onclick="removeElementFromDiagram('${escapeHtml(e.id)}')">Odebrat</button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    function getDiagramRelationships(diagramId) {
        const diagram = diagrams.find(d => d.id === diagramId);
        if (!diagram) return [];
        
        // Return relationships where both source and target are on the diagram
        return relationships.filter(r => 
            diagram.elementIds.includes(r.sourceId) && 
            diagram.elementIds.includes(r.targetId)
        );
    }
    
    function renderDiagramRelationships() {
        const tbody = document.getElementById('diagram-relationships-tbody');
        
        if (!currentDiagramId) {
            tbody.innerHTML = '<tr><td colspan="5" class="no-data">Nen√≠ vybr√°n diagram</td></tr>';
            return;
        }
        
        const diagramRels = getDiagramRelationships(currentDiagramId);
        
        if (diagramRels.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="no-data">Na diagramu nejsou ≈æ√°dn√© vazby</td></tr>';
            return;
        }
        
        tbody.innerHTML = diagramRels.map(r => {
            const source = elements.find(e => e.id === r.sourceId);
            const target = elements.find(e => e.id === r.targetId);
            const relInfo = RELATIONSHIP_TYPES[r.type];
            const statement = generateStatement(r);
            
            const sourceStereotype = source && source.stereotype ? `<span style="color:#666;">¬´${escapeHtml(source.stereotype)}¬ª</span> ` : '';
            const targetStereotype = target && target.stereotype ? `<span style="color:#666;">¬´${escapeHtml(target.stereotype)}¬ª</span> ` : '';
            
            return `
                <tr>
                    <td>${sourceStereotype}${source ? escapeHtml(source.name) : escapeHtml(r.sourceId)}</td>
                    <td><strong>${escapeHtml(r.type)}</strong> ${relInfo ? `(${relInfo.notation})` : ''}</td>
                    <td>${escapeHtml(r.name || '-')}</td>
                    <td>${targetStereotype}${target ? escapeHtml(target.name) : escapeHtml(r.targetId)}</td>
                    <td><em>${escapeHtml(statement)}</em></td>
                </tr>
            `;
        }).join('');
    }
    
    function renderDiagramPreview() {
        const container = document.getElementById('diagram-svg-container');
        
        if (!currentDiagramId) {
            container.innerHTML = '<p style="padding: 20px; color: #666;">Nen√≠ vybr√°n diagram.</p>';
            return;
        }
        
        const diagram = diagrams.find(d => d.id === currentDiagramId);
        if (!diagram || diagram.elementIds.length === 0) {
            container.innerHTML = '<p style="padding: 20px; color: #666;">P≈ôidejte prvky na diagram pro zobrazen√≠ n√°hledu.</p>';
            return;
        }
        
        // Get elements on diagram
        const diagramElements = diagram.elementIds
            .map(id => elements.find(e => e.id === id))
            .filter(e => e);
        
        // Get relationships on diagram
        const diagramRels = getDiagramRelationships(currentDiagramId);
        
        // Calculate positions
        const positions = calculateLayout(diagramElements, diagram.layoutType || 'layered');
        
        // Generate SVG
        const svg = generateSVG(diagramElements, diagramRels, positions);
        container.innerHTML = svg;
    }
    
    function calculateLayout(diagramElements, layoutType) {
        const positions = {};
        const nodeWidth = 140;
        const nodeHeight = 55;
        const paddingX = 30;
        const paddingY = 30;
        const gapX = 40;
        const gapY = 40;
        
        if (layoutType === 'grid') {
            // Grid layout - sort by type then name
            const sorted = [...diagramElements].sort((a, b) => {
                const typeCompare = a.type.localeCompare(b.type, 'cs');
                if (typeCompare !== 0) return typeCompare;
                return a.name.localeCompare(b.name, 'cs');
            });
            
            const cols = Math.ceil(Math.sqrt(sorted.length * 1.5)); // Wider than tall
            
            sorted.forEach((el, index) => {
                const col = index % cols;
                const row = Math.floor(index / cols);
                positions[el.id] = {
                    x: paddingX + col * (nodeWidth + gapX),
                    y: paddingY + row * (nodeHeight + gapY),
                    w: nodeWidth,
                    h: nodeHeight
                };
            });
        } else {
            // Layered layout - group by layer
            const layerGroups = {};
            diagramElements.forEach(el => {
                if (!layerGroups[el.layer]) {
                    layerGroups[el.layer] = [];
                }
                layerGroups[el.layer].push(el);
            });
            
            // Sort elements within each layer by type then name
            Object.keys(layerGroups).forEach(layer => {
                layerGroups[layer].sort((a, b) => {
                    const typeCompare = a.type.localeCompare(b.type, 'cs');
                    if (typeCompare !== 0) return typeCompare;
                    return a.name.localeCompare(b.name, 'cs');
                });
            });
            
            // Get ordered layers
            const orderedLayers = Object.keys(LAYER_Y_POSITIONS).filter(l => layerGroups[l]);
            
            orderedLayers.forEach((layer, layerIndex) => {
                const layerElements = layerGroups[layer];
                const baseY = paddingY + layerIndex * (nodeHeight + gapY + 50);
                
                layerElements.forEach((el, index) => {
                    positions[el.id] = {
                        x: paddingX + index * (nodeWidth + gapX),
                        y: baseY,
                        w: nodeWidth,
                        h: nodeHeight
                    };
                });
            });
        }
        
        return positions;
    }
    
    function generateSVG(diagramElements, diagramRels, positions) {
        // Calculate SVG dimensions
        let maxX = 200;
        let maxY = 200;
        Object.values(positions).forEach(pos => {
            maxX = Math.max(maxX, pos.x + pos.w + 30);
            maxY = Math.max(maxY, pos.y + pos.h + 30);
        });
        
        let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${maxX}" height="${maxY}" role="img" aria-label="ArchiMate diagram">`;
        
        // Add title for accessibility
        const diagram = diagrams.find(d => d.id === currentDiagramId);
        svg += `<title>${escapeXml(diagram ? diagram.name : 'Diagram')}</title>`;
        
        // Draw relationships first (behind elements)
        diagramRels.forEach(rel => {
            const sourcePos = positions[rel.sourceId];
            const targetPos = positions[rel.targetId];
            if (!sourcePos || !targetPos) return;
            
            svg += generateRelationshipLine(rel, sourcePos, targetPos);
        });
        
        // Draw elements
        diagramElements.forEach(el => {
            const pos = positions[el.id];
            if (!pos) return;
            
            svg += generateElementShape(el, pos);
        });
        
        svg += '</svg>';
        return svg;
    }
    
    function generateElementShape(el, pos) {
        const visual = ELEMENT_VISUALS[el.type] || { shape: 'rect', color: '#FFFFFF' };
        const { x, y, w, h } = pos;
        
        let shape = '';
        const strokeColor = '#333';
        const strokeWidth = 1.5;
        
        // Create accessible group with stereotype in label if present
        const labelText = el.stereotype 
            ? `¬´${el.stereotype}¬ª ${el.type}: ${el.name}`
            : `${el.type}: ${el.name}`;
        shape += `<g role="img" aria-label="${escapeXml(labelText)}">`;
        shape += `<title>${escapeXml(labelText)}</title>`;
        
        if (visual.shape === 'rounded') {
            // Rounded rectangle for behavioral elements
            shape += `<rect x="${x}" y="${y}" width="${w}" height="${h}" rx="10" ry="10" fill="${visual.color}" stroke="${strokeColor}" stroke-width="${strokeWidth}"/>`;
        } else {
            // Sharp rectangle for structural/passive elements
            shape += `<rect x="${x}" y="${y}" width="${w}" height="${h}" fill="${visual.color}" stroke="${strokeColor}" stroke-width="${strokeWidth}"/>`;
        }
        
        const textX = x + w / 2;
        
        // Add stereotype (small text at top) if present
        if (el.stereotype) {
            shape += `<text x="${textX}" y="${y + 12}" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="#666">¬´${escapeXml(el.stereotype)}¬ª</text>`;
        }
        
        // Add text (truncate if too long)
        const maxChars = Math.floor(w / 8);
        let displayName = el.name;
        if (displayName.length > maxChars) {
            displayName = displayName.substring(0, maxChars - 2) + '‚Ä¶';
        }
        
        const textY = el.stereotype ? y + h / 2 + 2 : y + h / 2;
        
        shape += `<text x="${textX}" y="${textY}" text-anchor="middle" dominant-baseline="middle" font-family="system-ui, sans-serif" font-size="12" fill="#333">${escapeXml(displayName)}</text>`;
        
        // Add type indicator (small text at bottom)
        shape += `<text x="${textX}" y="${y + h - 5}" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="#666">${escapeXml(el.type)}</text>`;
        
        shape += '</g>';
        
        return shape;
    }
    
    function generateRelationshipLine(rel, sourcePos, targetPos) {
        const relInfo = RELATIONSHIP_TYPES[rel.type];
        
        // Calculate center points
        const x1 = sourcePos.x + sourcePos.w / 2;
        const y1 = sourcePos.y + sourcePos.h / 2;
        const x2 = targetPos.x + targetPos.w / 2;
        const y2 = targetPos.y + targetPos.h / 2;
        
        // Calculate edge intersection points
        const start = getEdgePoint(sourcePos, x2, y2);
        const end = getEdgePoint(targetPos, x1, y1);
        
        let line = '';
        const strokeColor = '#666';
        const strokeWidth = 1.5;
        
        // Determine line style based on relationship type
        let dashArray = '';
        if (['Realization', 'Access', 'Influence', 'Flow'].includes(rel.type)) {
            dashArray = 'stroke-dasharray="5,3"';
        }
        
        // Create accessible group
        const source = elements.find(e => e.id === rel.sourceId);
        const target = elements.find(e => e.id === rel.targetId);
        const statement = generateStatement(rel);
        
        line += `<g role="img" aria-label="${escapeXml(statement)}">`;
        line += `<title>${escapeXml(statement)}</title>`;
        
        // Draw line
        line += `<line x1="${start.x}" y1="${start.y}" x2="${end.x}" y2="${end.y}" stroke="${strokeColor}" stroke-width="${strokeWidth}" ${dashArray}/>`;
        
        // Add arrow/marker based on type
        line += generateRelationshipMarker(rel.type, start, end);
        
        // Add relationship name if present
        if (rel.name) {
            const midX = (start.x + end.x) / 2;
            const midY = (start.y + end.y) / 2;
            line += `<text x="${midX}" y="${midY - 5}" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="#666">${escapeXml(rel.name)}</text>`;
        }
        
        line += '</g>';
        
        return line;
    }
    
    function getEdgePoint(rect, targetX, targetY) {
        const cx = rect.x + rect.w / 2;
        const cy = rect.y + rect.h / 2;
        
        const dx = targetX - cx;
        const dy = targetY - cy;
        
        if (dx === 0 && dy === 0) {
            return { x: cx, y: cy };
        }
        
        // Calculate intersection with rectangle edges
        const halfW = rect.w / 2;
        const halfH = rect.h / 2;
        
        let scale;
        if (Math.abs(dx) * halfH > Math.abs(dy) * halfW) {
            // Intersects with left or right edge
            scale = halfW / Math.abs(dx);
        } else {
            // Intersects with top or bottom edge
            scale = halfH / Math.abs(dy);
        }
        
        return {
            x: cx + dx * scale,
            y: cy + dy * scale
        };
    }
    
    function generateRelationshipMarker(type, start, end) {
        const angle = Math.atan2(end.y - start.y, end.x - start.x);
        const arrowSize = 10;
        
        // Arrow points
        const ax = end.x - arrowSize * Math.cos(angle - Math.PI / 6);
        const ay = end.y - arrowSize * Math.sin(angle - Math.PI / 6);
        const bx = end.x - arrowSize * Math.cos(angle + Math.PI / 6);
        const by = end.y - arrowSize * Math.sin(angle + Math.PI / 6);
        
        let marker = '';
        
        switch (type) {
            case 'Composition':
                // Filled diamond at source
                const dSize = 8;
                const sdx = Math.cos(angle);
                const sdy = Math.sin(angle);
                const pdx = Math.cos(angle + Math.PI / 2);
                const pdy = Math.sin(angle + Math.PI / 2);
                marker += `<polygon points="${start.x},${start.y} ${start.x + dSize * sdx + dSize / 2 * pdx},${start.y + dSize * sdy + dSize / 2 * pdy} ${start.x + 2 * dSize * sdx},${start.y + 2 * dSize * sdy} ${start.x + dSize * sdx - dSize / 2 * pdx},${start.y + dSize * sdy - dSize / 2 * pdy}" fill="#333" stroke="#333"/>`;
                break;
            case 'Aggregation':
                // Empty diamond at source
                const aSize = 8;
                const adx = Math.cos(angle);
                const ady = Math.sin(angle);
                const apdx = Math.cos(angle + Math.PI / 2);
                const apdy = Math.sin(angle + Math.PI / 2);
                marker += `<polygon points="${start.x},${start.y} ${start.x + aSize * adx + aSize / 2 * apdx},${start.y + aSize * ady + aSize / 2 * apdy} ${start.x + 2 * aSize * adx},${start.y + 2 * aSize * ady} ${start.x + aSize * adx - aSize / 2 * apdx},${start.y + aSize * ady - aSize / 2 * apdy}" fill="white" stroke="#333"/>`;
                break;
            case 'Assignment':
                // Circle at source, arrow at target
                marker += `<circle cx="${start.x + 5 * Math.cos(angle)}" cy="${start.y + 5 * Math.sin(angle)}" r="4" fill="#333"/>`;
                marker += `<polygon points="${end.x},${end.y} ${ax},${ay} ${bx},${by}" fill="#333"/>`;
                break;
            case 'Triggering':
            case 'Flow':
                // Filled arrow
                marker += `<polygon points="${end.x},${end.y} ${ax},${ay} ${bx},${by}" fill="#333"/>`;
                break;
            case 'Realization':
            case 'Serving':
            case 'Specialization':
                // Open arrow
                marker += `<polyline points="${ax},${ay} ${end.x},${end.y} ${bx},${by}" fill="none" stroke="#333" stroke-width="1.5"/>`;
                break;
            case 'Access':
            case 'Influence':
                // Simple arrow
                marker += `<polyline points="${ax},${ay} ${end.x},${end.y} ${bx},${by}" fill="none" stroke="#333" stroke-width="1.5"/>`;
                break;
            case 'Association':
                // No marker
                break;
            default:
                // Default arrow
                marker += `<polyline points="${ax},${ay} ${end.x},${end.y} ${bx},${by}" fill="none" stroke="#333" stroke-width="1.5"/>`;
        }
        
        return marker;
    }
    
    async function downloadDiagramSVG() {
        const container = document.getElementById('diagram-svg-container');
        const svg = container.querySelector('svg');
        if (!svg) {
            alert(t('alertDiagramEmpty'));
            return;
        }
        
        const diagram = diagrams.find(d => d.id === currentDiagramId);
        const filename = diagram ? diagram.name.replace(/[^a-zA-Z0-9]/g, '_') + '.svg' : 'diagram.svg';
        
        const svgData = new XMLSerializer().serializeToString(svg);
        await saveFileWithDialog(svgData, filename, 'image/svg+xml', ['.svg']);
    }

    // ============================================
    // Initialization
    // ============================================
    
    // ============================================
    // Task Functions
    // ============================================
    
    const TASK_STATUSES = {
        new: { icon: '‚ö™', colorClass: 'task-status-new' },
        in_progress: { icon: 'üîµ', colorClass: 'task-status-in_progress' },
        blocked: { icon: 'üî¥', colorClass: 'task-status-blocked' },
        review: { icon: 'üü°', colorClass: 'task-status-review' },
        done: { icon: 'üü¢', colorClass: 'task-status-done' },
        cancelled: { icon: '‚ö´', colorClass: 'task-status-cancelled' }
    };
    
    const TASK_PRIORITIES = {
        low: { icon: 'üü¢', colorClass: 'task-priority-low' },
        medium: { icon: 'üü°', colorClass: 'task-priority-medium' },
        high: { icon: 'üü†', colorClass: 'task-priority-high' },
        critical: { icon: 'üî¥', colorClass: 'task-priority-critical' }
    };
    
    let currentPreviewTaskId = null;
    
    function getTaskStatusLabel(status) {
        const labels = {
            new: 'taskStatusNew',
            in_progress: 'taskStatusInProgress',
            blocked: 'taskStatusBlocked',
            review: 'taskStatusReview',
            done: 'taskStatusDone',
            cancelled: 'taskStatusCancelled'
        };
        return t(labels[status] || status);
    }
    
    function getTaskPriorityLabel(priority) {
        const labels = {
            low: 'taskPriorityLow',
            medium: 'taskPriorityMedium',
            high: 'taskPriorityHigh',
            critical: 'taskPriorityCritical'
        };
        return t(labels[priority] || priority);
    }
    
    function getNextTaskNumber() {
        if (tasks.length === 0) return '1';
        const numbers = tasks.map(t => {
            const match = String(t.number || '').match(/(\d+)/);
            return match ? parseInt(match[1]) : 0;
        });
        return String(Math.max(...numbers) + 1);
    }
    
    function updateTaskAssigneeFilter() {
        const select = document.getElementById('task-filter-assignee');
        const currentValue = select.value;
        
        const assignees = new Set();
        tasks.forEach(t => {
            if (t.assignee && t.assignee.trim()) {
                assignees.add(t.assignee.trim());
            }
        });
        
        select.innerHTML = `<option value="">${t('taskFilterAllAssignees')}</option>`;
        [...assignees].sort().forEach(a => {
            const option = document.createElement('option');
            option.value = a;
            option.textContent = a;
            select.appendChild(option);
        });
        
        if (currentValue && assignees.has(currentValue)) {
            select.value = currentValue;
        }
    }
    
    function renderTasksTable() {
        const tbody = document.getElementById('tasks-table-body');
        const filterStatus = document.getElementById('task-filter-status').value;
        const filterPriority = document.getElementById('task-filter-priority').value;
        const filterAssignee = document.getElementById('task-filter-assignee').value;
        const searchTerm = document.getElementById('task-search').value.toLowerCase().trim();
        
        let filtered = tasks.filter(task => {
            if (filterStatus && task.status !== filterStatus) return false;
            if (filterPriority && task.priority !== filterPriority) return false;
            if (filterAssignee && task.assignee !== filterAssignee) return false;
            if (searchTerm) {
                const searchFields = [
                    task.title || '',
                    task.assignee || '',
                    task.reporter || '',
                    task.description || '',
                    task.currentState || '',
                    (task.tags || []).join(' ')
                ].join(' ').toLowerCase();
                if (!searchFields.includes(searchTerm)) return false;
            }
            return true;
        });
        
        // Sort by priority (critical first), then by number
        const priorityOrder = { critical: 0, high: 1, medium: 2, low: 3 };
        filtered.sort((a, b) => {
            // Active tasks first (not done, not cancelled)
            const aActive = !['done', 'cancelled'].includes(a.status);
            const bActive = !['done', 'cancelled'].includes(b.status);
            if (aActive !== bActive) return bActive - aActive;
            
            // Then by priority
            const pA = priorityOrder[a.priority] ?? 2;
            const pB = priorityOrder[b.priority] ?? 2;
            if (pA !== pB) return pA - pB;
            
            // Then by number
            const aNum = parseInt(String(a.number || '').replace(/\D/g, '')) || 0;
            const bNum = parseInt(String(b.number || '').replace(/\D/g, '')) || 0;
            return aNum - bNum;
        });
        
        if (filtered.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: #666;">${t('taskNoRecords')}</td></tr>`;
            return;
        }
        
        const today = new Date().toISOString().split('T')[0];
        
        tbody.innerHTML = filtered.map(task => {
            const statusInfo = TASK_STATUSES[task.status] || TASK_STATUSES.new;
            const priorityInfo = TASK_PRIORITIES[task.priority] || TASK_PRIORITIES.medium;
            const isOverdue = task.dueDate && task.dueDate < today && !['done', 'cancelled'].includes(task.status);
            const dueDateDisplay = task.dueDate ? 
                `<span style="${isOverdue ? 'color: #f44336; font-weight: bold;' : ''}">${task.dueDate}${isOverdue ? ' ‚ö†Ô∏è' : ''}</span>` : '-';
            
            return `
                <tr style="${['done', 'cancelled'].includes(task.status) ? 'opacity: 0.6;' : ''}">
                    <td><strong>${escapeHtml(String(task.number || ''))}</strong></td>
                    <td>
                        <a href="#" onclick="openTaskPreview('${task.id}'); return false;" style="color: #0066cc; text-decoration: none; font-weight: bold;">
                            ${escapeHtml(task.title || '')}
                        </a>
                    </td>
                    <td>
                        <span class="task-status-badge ${statusInfo.colorClass}">
                            ${statusInfo.icon} ${getTaskStatusLabel(task.status)}
                        </span>
                    </td>
                    <td>
                        <span class="task-priority-badge ${priorityInfo.colorClass}">
                            ${getTaskPriorityLabel(task.priority)}
                        </span>
                    </td>
                    <td>${escapeHtml(task.assignee || '-')}</td>
                    <td>${dueDateDisplay}</td>
                    <td>
                        <button type="button" class="btn-secondary btn-small" onclick="editTask('${task.id}')" title="${t('edit')}">‚úèÔ∏è</button>
                        <button type="button" class="btn-danger btn-small" onclick="deleteTask('${task.id}')" title="${t('delete')}">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    function openTaskEditor(taskId = null) {
        const modal = document.getElementById('task-editor-modal');
        const titleEl = document.getElementById('task-editor-title');
        
        // Populate linked selects
        populateTaskLinkedSelects();
        
        // Clear form
        document.getElementById('task-edit-id').value = '';
        document.getElementById('task-number').value = getNextTaskNumber();
        document.getElementById('task-status').value = 'new';
        document.getElementById('task-priority').value = 'medium';
        document.getElementById('task-title-input').value = '';
        document.getElementById('task-assignee').value = '';
        document.getElementById('task-reporter').value = modelMetadata.dublinCore?.creator || '';
        document.getElementById('task-due-date').value = '';
        document.getElementById('task-tags').value = '';
        document.getElementById('task-description').value = '';
        document.getElementById('task-current-state').value = '';
        document.getElementById('task-linked-elements').selectedIndex = -1;
        document.getElementById('task-linked-relationships').selectedIndex = -1;
        document.getElementById('task-status-history').innerHTML = '';
        document.getElementById('task-status-history-fieldset').style.display = 'none';
        
        if (taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                titleEl.textContent = `#${task.number}: ${task.title || t('edit')}`;
                loadTaskToForm(task);
            }
        } else {
            titleEl.textContent = t('tasksNew');
        }
        
        modal.style.display = 'flex';
        document.getElementById('task-title-input').focus();
    }
    
    function populateTaskLinkedSelects() {
        const elementsSelect = document.getElementById('task-linked-elements');
        const relsSelect = document.getElementById('task-linked-relationships');
        
        elementsSelect.innerHTML = elements.map(e => 
            `<option value="${escapeHtml(e.id)}">${escapeHtml(e.name || e.id)} (${e.type})</option>`
        ).join('');
        
        relsSelect.innerHTML = relationships.map(r => {
            const source = elements.find(e => e.id === r.sourceId);
            const target = elements.find(e => e.id === r.targetId);
            const sourceName = source ? source.name : r.sourceId;
            const targetName = target ? target.name : r.targetId;
            return `<option value="${escapeHtml(r.id)}">${escapeHtml(sourceName)} ‚Üí ${escapeHtml(targetName)} (${r.type})</option>`;
        }).join('');
        
        updateSelectOriginalOptions('task-linked-elements');
        updateSelectOriginalOptions('task-linked-relationships');
    }
    
    function loadTaskToForm(task) {
        document.getElementById('task-edit-id').value = task.id;
        document.getElementById('task-number').value = task.number || '';
        document.getElementById('task-status').value = task.status || 'new';
        document.getElementById('task-priority').value = task.priority || 'medium';
        document.getElementById('task-title-input').value = task.title || '';
        document.getElementById('task-assignee').value = task.assignee || '';
        document.getElementById('task-reporter').value = task.reporter || '';
        document.getElementById('task-due-date').value = task.dueDate || '';
        document.getElementById('task-tags').value = (task.tags || []).join(', ');
        document.getElementById('task-description').value = task.description || '';
        document.getElementById('task-current-state').value = task.currentState || '';
        
        if (task.linkedElements) {
            setMultiSelectValues('task-linked-elements', task.linkedElements);
        }
        if (task.linkedRelationships) {
            setMultiSelectValues('task-linked-relationships', task.linkedRelationships);
        }
        
        if (task.statusHistory && task.statusHistory.length > 0) {
            document.getElementById('task-status-history-fieldset').style.display = 'block';
            document.getElementById('task-status-history').innerHTML = task.statusHistory.map(h => `
                <div style="padding: 8px; border-bottom: 1px solid #eee; display: flex; gap: 15px; flex-wrap: wrap;">
                    <span><strong>${getTaskStatusLabel(h.status)}</strong></span>
                    <span style="color: #666;">${new Date(h.date).toLocaleString()}</span>
                    <span>${escapeHtml(h.author || '-')}</span>
                    ${h.stateDescription ? `<div style="width: 100%; color: #555; font-size: 13px; margin-top: 4px;"><em>${escapeHtml(h.stateDescription)}</em></div>` : ''}
                </div>
            `).join('');
        }
    }
    
    function closeTaskEditor() {
        document.getElementById('task-editor-modal').style.display = 'none';
    }
    
    function closeTaskEditorOnOverlay(event) {
        if (event.target === event.currentTarget) {
            closeTaskEditor();
        }
    }
    
    function handleTaskStatusChange() {
        // Can be used to show/hide fields based on status
    }
    
    function saveTask() {
        const editId = document.getElementById('task-edit-id').value;
        const number = document.getElementById('task-number').value.trim() || getNextTaskNumber();
        const status = document.getElementById('task-status').value;
        const priority = document.getElementById('task-priority').value;
        const title = document.getElementById('task-title-input').value.trim();
        
        if (!title) {
            alert(t('alertEnterName'));
            document.getElementById('task-title-input').focus();
            return;
        }
        
        const now = new Date().toISOString();
        const currentState = document.getElementById('task-current-state').value.trim();
        
        const taskData = {
            id: editId || `task-${Date.now()}`,
            number: number,
            title: title,
            status: status,
            priority: priority,
            created: editId ? undefined : now,
            updated: now,
            assignee: document.getElementById('task-assignee').value.trim(),
            reporter: document.getElementById('task-reporter').value.trim(),
            dueDate: document.getElementById('task-due-date').value,
            tags: document.getElementById('task-tags').value.split(',').map(s => s.trim()).filter(s => s),
            description: document.getElementById('task-description').value.trim(),
            currentState: currentState,
            linkedElements: getMultiSelectValues('task-linked-elements'),
            linkedRelationships: getMultiSelectValues('task-linked-relationships')
        };
        
        if (editId) {
            const index = tasks.findIndex(t => t.id === editId);
            if (index !== -1) {
                const existing = tasks[index];
                taskData.created = existing.created;
                taskData.statusHistory = existing.statusHistory || [];
                
                // Add status change to history if changed, or if currentState changed
                if (existing.status !== status || existing.currentState !== currentState) {
                    taskData.statusHistory.push({
                        status: status,
                        date: now,
                        author: taskData.assignee || taskData.reporter,
                        stateDescription: currentState
                    });
                }
                
                tasks[index] = taskData;
            }
        } else {
            taskData.created = now;
            taskData.statusHistory = [{
                status: status,
                date: now,
                author: taskData.reporter,
                stateDescription: currentState
            }];
            tasks.push(taskData);
        }
        
        renderTasksTable();
        updateTaskAssigneeFilter();
        updateP≈ô√≠znakyFilters();
        saveToLocalStorage();
        closeTaskEditor();
    }
    
    function editTask(taskId) {
        openTaskEditor(taskId);
    }
    
    function deleteTask(taskId) {
        if (!confirm(t('taskConfirmDelete'))) return;
        
        tasks = tasks.filter(t => t.id !== taskId);
        renderTasksTable();
        updateTaskAssigneeFilter();
        saveToLocalStorage();
    }
    
    // Task Preview
    function openTaskPreview(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;
        
        currentPreviewTaskId = taskId;
        
        const modal = document.getElementById('task-preview-modal');
        const titleEl = document.getElementById('task-preview-title');
        const contentEl = document.getElementById('task-preview-content');
        
        titleEl.textContent = `#${task.number}: ${task.title || ''}`;
        contentEl.innerHTML = generateTaskPreviewHtml(task);
        
        modal.style.display = 'flex';
    }
    
    function generateTaskPreviewHtml(task) {
        const statusInfo = TASK_STATUSES[task.status] || TASK_STATUSES.new;
        const priorityInfo = TASK_PRIORITIES[task.priority] || TASK_PRIORITIES.medium;
        const today = new Date().toISOString().split('T')[0];
        const isOverdue = task.dueDate && task.dueDate < today && !['done', 'cancelled'].includes(task.status);
        
        let html = '';
        
        // Status and priority badges
        html += `<div style="margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
            <span class="task-status-badge ${statusInfo.colorClass}" style="font-size: 14px; padding: 6px 12px;">
                ${statusInfo.icon} ${getTaskStatusLabel(task.status)}
            </span>
            <span class="task-priority-badge ${priorityInfo.colorClass}" style="font-size: 14px; padding: 6px 12px;">
                ${getTaskPriorityLabel(task.priority)}
            </span>
            ${isOverdue ? `<span style="background: #ffebee; color: #c62828; padding: 6px 12px; border-radius: 12px; font-size: 14px; font-weight: bold;">‚ö†Ô∏è ${t('taskOverdue')}</span>` : ''}
        </div>`;
        
        // Metadata table
        html += `<table style="width: 100%; margin-bottom: 20px; font-size: 14px;">
            <tr><td style="width: 150px; font-weight: bold; padding: 5px 10px; background: #f5f5f5;">${t('taskAssignee')}</td><td style="padding: 5px 10px;">${escapeHtml(task.assignee || '-')}</td></tr>
            <tr><td style="font-weight: bold; padding: 5px 10px; background: #f5f5f5;">${t('taskReporter')}</td><td style="padding: 5px 10px;">${escapeHtml(task.reporter || '-')}</td></tr>
            <tr><td style="font-weight: bold; padding: 5px 10px; background: #f5f5f5;">${t('taskDueDate')}</td><td style="padding: 5px 10px; ${isOverdue ? 'color: #f44336; font-weight: bold;' : ''}">${task.dueDate || '-'}${isOverdue ? ' ‚ö†Ô∏è' : ''}</td></tr>
            <tr><td style="font-weight: bold; padding: 5px 10px; background: #f5f5f5;">${t('taskCreated')}</td><td style="padding: 5px 10px;">${task.created ? new Date(task.created).toLocaleDateString() : '-'}</td></tr>
            <tr><td style="font-weight: bold; padding: 5px 10px; background: #f5f5f5;">${t('taskUpdated')}</td><td style="padding: 5px 10px;">${task.updated ? new Date(task.updated).toLocaleDateString() : '-'}</td></tr>
            ${task.tags?.length > 0 ? `<tr><td style="font-weight: bold; padding: 5px 10px; background: #f5f5f5;">${t('tags')}</td><td style="padding: 5px 10px;">${task.tags.map(tag => `<span style="display: inline-block; background: #e0e0e0; padding: 2px 8px; border-radius: 10px; margin-right: 5px; font-size: 12px;">${escapeHtml(tag)}</span>`).join('')}</td></tr>` : ''}
        </table>`;
        
        // Description
        if (task.description) {
            html += `<div style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px;">${t('taskDescription')}</h3>
                <div class="markdown-content">${renderMarkdown(task.description)}</div>
            </div>`;
        }
        
        // Current state
        if (task.currentState) {
            html += `<div style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px;">${t('taskCurrentState')}</h3>
                <div class="markdown-content" style="background: #f5f5f5; padding: 12px; border-radius: 4px;">${renderMarkdown(task.currentState)}</div>
            </div>`;
        }
        
        // Linked elements and relationships
        const hasLinked = (task.linkedElements && task.linkedElements.length > 0) || 
                         (task.linkedRelationships && task.linkedRelationships.length > 0);
        
        if (hasLinked) {
            html += `<div style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px;">${t('linkedItems')}</h3>
                <div style="padding: 10px; background: #f0f7ff; border-radius: 4px; border: 1px solid #d0e0f0;">`;
            
            if (task.linkedElements && task.linkedElements.length > 0) {
                html += `<div style="margin-bottom: 8px;"><strong>${t('elements')}:</strong> `;
                html += task.linkedElements.map(id => {
                    const el = elements.find(e => e.id === id);
                    return el ? `<a href="#" onclick="switchTab('elements'); document.getElementById('filter-search').value='${escapeHtml(el.id)}'; filterElements(); closeTaskPreview(); return false;" style="margin-right: 8px;">${escapeHtml(el.name || el.id)}</a>` : id;
                }).join('');
                html += '</div>';
            }
            
            if (task.linkedRelationships && task.linkedRelationships.length > 0) {
                html += `<div><strong>${t('relationships')}:</strong> `;
                html += task.linkedRelationships.map(id => {
                    const rel = relationships.find(r => r.id === id);
                    if (rel) {
                        const source = elements.find(e => e.id === rel.sourceId);
                        const target = elements.find(e => e.id === rel.targetId);
                        return `<span style="margin-right: 8px;">${escapeHtml(source?.name || rel.sourceId)} ‚Üí ${escapeHtml(target?.name || rel.targetId)}</span>`;
                    }
                    return id;
                }).join('');
                html += '</div>';
            }
            
            html += `</div></div>`;
        }
        
        // Status history
        if (task.statusHistory && task.statusHistory.length > 0) {
            html += `<div style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px;">${t('taskStatusHistory')}</h3>
                <table style="width: 100%; font-size: 14px; border-collapse: collapse;">
                    <tr style="background: #f5f5f5;">
                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">${t('taskStatus')}</th>
                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">${t('date')}</th>
                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">${t('taskAssignee')}</th>
                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">${t('taskCurrentState')}</th>
                    </tr>`;
            task.statusHistory.forEach(h => {
                html += `<tr>
                    <td style="padding: 8px; border-bottom: 1px solid #eee;">${getTaskStatusLabel(h.status)}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee;">${new Date(h.date).toLocaleString()}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee;">${escapeHtml(h.author || '-')}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; font-size: 12px; color: #555;">${escapeHtml(h.stateDescription || '-')}</td>
                </tr>`;
            });
            html += `</table></div>`;
        }
        
        return html;
    }
    
    function closeTaskPreview() {
        document.getElementById('task-preview-modal').style.display = 'none';
        currentPreviewTaskId = null;
    }
    
    function closeTaskPreviewOnOverlay(event) {
        if (event.target === event.currentTarget) {
            closeTaskPreview();
        }
    }
    
    function previewTaskEdit() {
        if (!currentPreviewTaskId) return;
        const taskId = currentPreviewTaskId;
        closeTaskPreview();
        editTask(taskId);
    }
    
    // Task Markdown Export
    function generateTaskMarkdown(task) {
        let md = `# √ökol #${task.number}: ${task.title}\n\n`;
        
        md += `**Stav:** ${getTaskStatusLabel(task.status)}  \n`;
        md += `**Priorita:** ${getTaskPriorityLabel(task.priority)}  \n`;
        md += `**≈òe≈°itel:** ${task.assignee || '-'}  \n`;
        md += `**Zadavatel:** ${task.reporter || '-'}  \n`;
        md += `**Term√≠n:** ${task.dueDate || '-'}  \n`;
        md += `**Vytvo≈ôeno:** ${task.created ? new Date(task.created).toLocaleDateString() : '-'}  \n`;
        md += `**Aktualizov√°no:** ${task.updated ? new Date(task.updated).toLocaleDateString() : '-'}  \n`;
        
        if (task.tags && task.tags.length > 0) {
            md += `**P≈ô√≠znaky:** ${task.tags.join(', ')}  \n`;
        }
        md += '\n';
        
        if (task.description) {
            md += `## Popis\n\n${task.description}\n\n`;
        }
        
        if (task.currentState) {
            md += `## Aktu√°ln√≠ stav\n\n${task.currentState}\n\n`;
        }
        
        // Linked items
        const hasLinked = (task.linkedElements && task.linkedElements.length > 0) || 
                         (task.linkedRelationships && task.linkedRelationships.length > 0);
        if (hasLinked) {
            md += `## Propojen√© polo≈æky\n\n`;
            if (task.linkedElements && task.linkedElements.length > 0) {
                md += `**Prvky:**\n`;
                task.linkedElements.forEach(id => {
                    const el = elements.find(e => e.id === id);
                    md += `- ${el ? el.name || el.id : id}\n`;
                });
                md += '\n';
            }
            if (task.linkedRelationships && task.linkedRelationships.length > 0) {
                md += `**Vazby:**\n`;
                task.linkedRelationships.forEach(id => {
                    const rel = relationships.find(r => r.id === id);
                    if (rel) {
                        const source = elements.find(e => e.id === rel.sourceId);
                        const target = elements.find(e => e.id === rel.targetId);
                        md += `- ${source?.name || rel.sourceId} ‚Üí ${target?.name || rel.targetId}\n`;
                    }
                });
                md += '\n';
            }
        }
        
        // Status history
        if (task.statusHistory && task.statusHistory.length > 0) {
            md += `## Historie stav≈Ø\n\n`;
            md += `| Stav | Datum | ≈òe≈°itel | Pozn√°mka |\n`;
            md += `|------|-------|---------|----------|\n`;
            task.statusHistory.forEach(h => {
                md += `| ${getTaskStatusLabel(h.status)} | ${new Date(h.date).toLocaleString()} | ${h.author || '-'} | ${h.stateDescription || '-'} |\n`;
            });
            md += '\n';
        }
        
        return md;
    }
    
    async function saveTaskAsMarkdown() {
        const editId = document.getElementById('task-edit-id').value;
        if (!editId) {
            alert('Nejprve ulo≈æte √∫kol.');
            return;
        }
        const task = tasks.find(t => t.id === editId);
        if (!task) return;
        
        const md = generateTaskMarkdown(task);
        const filename = `task-${task.number}-${(task.title || 'task').replace(/[^a-z0-9]/gi, '-').toLowerCase()}.md`;
        
        await saveFileWithDialog(md, filename, 'text/markdown', ['.md']);
    }
    
    async function saveTaskAsDocx() {
        const editId = document.getElementById('task-edit-id').value;
        if (!editId) {
            alert('Nejprve ulo≈æte √∫kol.');
            return;
        }
        const task = tasks.find(t => t.id === editId);
        if (!task) return;
        
        try {
            const blob = await generateDocxFromTask(task);
            const filename = `task-${task.number}-${(task.title || 'task').replace(/[^a-z0-9]/gi, '-').toLowerCase()}.docx`;
            await saveFileWithDialog(blob, filename, 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', ['.docx']);
        } catch (e) {
            console.error('DOCX export error:', e);
            alert('Chyba p≈ôi exportu do DOCX: ' + e.message);
        }
    }
    
    function copyTaskAsMarkdown() {
        const editId = document.getElementById('task-edit-id').value;
        if (!editId) {
            alert('Nejprve ulo≈æte √∫kol.');
            return;
        }
        const task = tasks.find(t => t.id === editId);
        if (!task) return;
        
        const md = generateTaskMarkdown(task);
        navigator.clipboard.writeText(md).then(() => {
            alert(t('contentCopied'));
        }).catch(() => {
            const textarea = document.createElement('textarea');
            textarea.value = md;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert(t('contentCopied'));
        });
    }
    
    async function previewTaskSaveMarkdown() {
        if (!currentPreviewTaskId) return;
        const task = tasks.find(t => t.id === currentPreviewTaskId);
        if (!task) return;
        
        const md = generateTaskMarkdown(task);
        const filename = `task-${task.number}-${(task.title || 'task').replace(/[^a-z0-9]/gi, '-').toLowerCase()}.md`;
        
        await saveFileWithDialog(md, filename, 'text/markdown', ['.md']);
    }
    
    async function previewTaskSaveDocx() {
        if (!currentPreviewTaskId) return;
        const task = tasks.find(t => t.id === currentPreviewTaskId);
        if (!task) return;
        
        try {
            const blob = await generateDocxFromTask(task);
            const filename = `task-${task.number}-${(task.title || 'task').replace(/[^a-z0-9]/gi, '-').toLowerCase()}.docx`;
            await saveFileWithDialog(blob, filename, 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', ['.docx']);
        } catch (e) {
            console.error('DOCX export error:', e);
            alert('Chyba p≈ôi exportu do DOCX: ' + e.message);
        }
    }
    
    function previewTaskCopyMarkdown() {
        if (!currentPreviewTaskId) return;
        const task = tasks.find(t => t.id === currentPreviewTaskId);
        if (!task) return;
        
        const md = generateTaskMarkdown(task);
        navigator.clipboard.writeText(md).then(() => {
            alert(t('contentCopied'));
        }).catch(() => {
            const textarea = document.createElement('textarea');
            textarea.value = md;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert(t('contentCopied'));
        });
    }
    
    async function exportAllTasksMarkdown() {
        if (tasks.length === 0) {
            alert(t('taskNoRecords'));
            return;
        }
        
        let md = `# Seznam √∫kol≈Ø\n\n`;
        md += `Exportov√°no: ${new Date().toLocaleString()}\n\n`;
        md += `---\n\n`;
        
        tasks.forEach(task => {
            md += generateTaskMarkdown(task);
            md += `\n---\n\n`;
        });
        
        const filename = `tasks-export-${new Date().toISOString().split('T')[0]}.md`;
        await saveFileWithDialog(md, filename, 'text/markdown', ['.md']);
    }
    
    // ============================================
    // ADR (Architecture Decision Records) Functions
    // ============================================
    
    const ADR_STATUSES = {
        draft: { icon: '‚ö™', colorClass: 'adr-status-draft' },
        proposed: { icon: 'üîµ', colorClass: 'adr-status-proposed' },
        under_discussion: { icon: 'üí¨', colorClass: 'adr-status-discussion' },
        returned: { icon: 'üîô', colorClass: 'adr-status-returned' },
        accepted: { icon: 'üü¢', colorClass: 'adr-status-accepted' },
        rejected: { icon: 'üî¥', colorClass: 'adr-status-rejected' },
        updated: { icon: 'üîÑ', colorClass: 'adr-status-updated' },
        implemented: { icon: 'üü£', colorClass: 'adr-status-implemented' },
        monitored: { icon: 'üëÅÔ∏è', colorClass: 'adr-status-monitored' },
        deprecated: { icon: 'üü†', colorClass: 'adr-status-deprecated' },
        superseded: { icon: '‚ö´', colorClass: 'adr-status-superseded' },
        closed: { icon: 'üîí', colorClass: 'adr-status-closed' }
    };
    
    const ADR_IMPL_STATUSES = {
        not_started: 'adrImplNotStarted',
        in_progress: 'adrImplInProgress',
        completed: 'adrImplCompleted'
    };
    
    function getAdrStatusLabel(status) {
        const labels = {
            draft: 'adrStatusDraft',
            proposed: 'adrStatusProposed',
            under_discussion: 'adrStatusUnderDiscussion',
            returned: 'adrStatusReturned',
            accepted: 'adrStatusAccepted',
            rejected: 'adrStatusRejected',
            updated: 'adrStatusUpdated',
            implemented: 'adrStatusImplemented',
            monitored: 'adrStatusMonitored',
            deprecated: 'adrStatusDeprecated',
            superseded: 'adrStatusSuperseded',
            closed: 'adrStatusClosed'
        };
        return t(labels[status] || status);
    }
    
    function getAdrImplStatusLabel(status) {
        return t(ADR_IMPL_STATUSES[status] || status);
    }
    
    function renderAdrTable() {
        const tbody = document.getElementById('adr-table-body');
        const filterStatus = document.getElementById('adr-filter-status').value;
        const searchTerm = document.getElementById('adr-search').value.toLowerCase().trim();
        
        let filtered = adrRecords.filter(adr => {
            if (filterStatus && adr.status !== filterStatus) return false;
            if (searchTerm) {
                const searchFields = [
                    adr.title || '',
                    adr.author || '',
                    adr.context || '',
                    adr.decision || '',
                    (adr.tags || []).join(' ')
                ].join(' ').toLowerCase();
                if (!searchFields.includes(searchTerm)) return false;
            }
            return true;
        });
        
        // Sort by number - compare numerically if both are numeric, otherwise alphabetically
        filtered.sort((a, b) => {
            const aStr = String(a.number || '');
            const bStr = String(b.number || '');
            const aNum = parseInt(aStr.replace(/\D/g, '')) || 0;
            const bNum = parseInt(bStr.replace(/\D/g, '')) || 0;
            if (aNum !== bNum) return aNum - bNum;
            return aStr.localeCompare(bStr);
        });
        
        if (filtered.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #666;">${t('adrNoRecords')}</td></tr>`;
            return;
        }
        
        tbody.innerHTML = filtered.map(adr => {
            const statusInfo = ADR_STATUSES[adr.status] || ADR_STATUSES.draft;
            const updatedDate = adr.updated ? new Date(adr.updated).toLocaleDateString() : '-';
            
            return `
                <tr>
                    <td>${adr.number || '-'}</td>
                    <td><a href="#" onclick="openAdrPreview('${adr.id}'); return false;" style="color: #0066cc; text-decoration: none; font-weight: bold;">${escapeHtml(adr.title || '')}</a></td>
                    <td><span class="adr-status-badge ${statusInfo.colorClass}">${statusInfo.icon} ${getAdrStatusLabel(adr.status)}</span></td>
                    <td>${escapeHtml(adr.author || '-')}</td>
                    <td>${updatedDate}</td>
                    <td>
                        <button type="button" class="btn-secondary btn-small" onclick="editAdr('${adr.id}')" title="${t('edit')}">‚úèÔ∏è</button>
                        <button type="button" class="btn-secondary btn-small" onclick="copyAdrMarkdownById('${adr.id}')" title="${t('adrCopyMarkdown')}">üìã</button>
                        <button type="button" class="btn-danger btn-small" onclick="deleteAdr('${adr.id}')" title="${t('delete')}">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    function openAdrEditor(adrId = null) {
        const modal = document.getElementById('adr-editor-modal');
        const titleEl = document.getElementById('adr-editor-title');
        
        // Populate linked selects
        populateAdrLinkedSelects();
        
        // Clear form
        document.getElementById('adr-edit-id').value = '';
        document.getElementById('adr-number').value = getNextAdrNumber();
        document.getElementById('adr-status').value = 'draft';
        document.getElementById('adr-title-input').value = '';
        document.getElementById('adr-author').value = modelMetadata.dublinCore?.creator || '';
        document.getElementById('adr-approver').value = '';
        document.getElementById('adr-deciders').value = '';
        document.getElementById('adr-tags').value = '';
        document.getElementById('adr-context').value = '';
        document.getElementById('adr-decision').value = '';
        document.getElementById('adr-consequences').value = '';
        document.getElementById('adr-impl-status').value = 'not_started';
        document.getElementById('adr-impl-start').value = '';
        document.getElementById('adr-impl-target').value = '';
        document.getElementById('adr-impl-notes').value = '';
        document.getElementById('adr-selected-alternative').innerHTML = '<option value="">-- Vyberte --</option>';
        document.getElementById('adr-selection-reason').value = '';
        document.getElementById('adr-linked-elements').selectedIndex = -1;
        document.getElementById('adr-linked-relationships').selectedIndex = -1;
        
        // Clear dynamic containers
        document.getElementById('adr-alternatives-container').innerHTML = '';
        document.getElementById('adr-links-container').innerHTML = '';
        document.getElementById('adr-status-history').innerHTML = '';
        document.getElementById('adr-status-history-fieldset').style.display = 'none';
        
        // Populate related ADR selects
        populateAdrSelects(adrId);
        
        if (adrId) {
            // Edit existing ADR
            const adr = adrRecords.find(a => a.id === adrId);
            if (adr) {
                titleEl.textContent = `ADR-${formatAdrNumber(adr.number)}: ${adr.title || t('edit')}`;
                loadAdrToForm(adr);
            }
        } else {
            titleEl.textContent = t('adrNew');
        }
        
        modal.style.display = 'flex';
        document.getElementById('adr-title-input').focus();
    }
    
    function populateAdrLinkedSelects() {
        const elementsSelect = document.getElementById('adr-linked-elements');
        const relsSelect = document.getElementById('adr-linked-relationships');
        
        // Populate elements
        elementsSelect.innerHTML = elements.map(e => 
            `<option value="${escapeHtml(e.id)}">${escapeHtml(e.name || e.id)} (${e.type})</option>`
        ).join('');
        
        // Populate relationships
        relsSelect.innerHTML = relationships.map(r => {
            const source = elements.find(e => e.id === r.sourceId);
            const target = elements.find(e => e.id === r.targetId);
            const sourceName = source ? source.name : r.sourceId;
            const targetName = target ? target.name : r.targetId;
            return `<option value="${escapeHtml(r.id)}">${escapeHtml(sourceName)} ‚Üí ${escapeHtml(targetName)} (${r.type})</option>`;
        }).join('');
        
        updateSelectOriginalOptions('adr-linked-elements');
        updateSelectOriginalOptions('adr-linked-relationships');
    }
    
    function closeAdrEditor() {
        document.getElementById('adr-editor-modal').style.display = 'none';
    }
    
    function closeAdrEditorOnOverlay(event) {
        if (event.target === event.currentTarget) {
            closeAdrEditor();
        }
    }
    
    function getNextAdrNumber() {
        if (adrRecords.length === 0) return '1';
        // Find max numeric value from existing numbers
        let maxNum = 0;
        adrRecords.forEach(a => {
            const num = parseInt(String(a.number).replace(/\D/g, '')) || 0;
            if (num > maxNum) maxNum = num;
        });
        return String(maxNum + 1);
    }
    
    function formatAdrNumber(number) {
        // Format ADR number - if purely numeric, pad with zeros, otherwise use as-is
        const numStr = String(number || '');
        if (/^\d+$/.test(numStr)) {
            return numStr.padStart(3, '0');
        }
        return numStr;
    }
    
    function populateAdrSelects(excludeId = null) {
        const supersedesSelect = document.getElementById('adr-supersedes');
        const supersededBySelect = document.getElementById('adr-superseded-by');
        const relatedToSelect = document.getElementById('adr-related-to');
        
        const options = adrRecords
            .filter(a => a.id !== excludeId)
            .map(a => `<option value="${a.id}">ADR-${formatAdrNumber(a.number)}: ${escapeHtml(a.title || '')}</option>`)
            .join('');
        
        supersedesSelect.innerHTML = options;
        supersededBySelect.innerHTML = options;
        relatedToSelect.innerHTML = options;
    }
    
    function loadAdrToForm(adr) {
        document.getElementById('adr-edit-id').value = adr.id;
        document.getElementById('adr-number').value = adr.number || '';
        document.getElementById('adr-status').value = adr.status || 'draft';
        document.getElementById('adr-title-input').value = adr.title || '';
        document.getElementById('adr-author').value = adr.author || '';
        document.getElementById('adr-approver').value = adr.approver || '';
        document.getElementById('adr-deciders').value = (adr.deciders || []).join(', ');
        document.getElementById('adr-tags').value = (adr.tags || []).join(', ');
        document.getElementById('adr-context').value = adr.context || '';
        document.getElementById('adr-decision').value = adr.decision || '';
        
        // Consequences (simple string)
        document.getElementById('adr-consequences').value = adr.consequences || '';
        
        // Implementation
        if (adr.implementation) {
            document.getElementById('adr-impl-status').value = adr.implementation.status || 'not_started';
            document.getElementById('adr-impl-start').value = adr.implementation.startDate || '';
            document.getElementById('adr-impl-target').value = adr.implementation.targetDate || '';
            document.getElementById('adr-impl-notes').value = adr.implementation.notes || '';
        }
        
        // Alternatives
        if (adr.alternatives) {
            adr.alternatives.forEach(alt => addAdrAlternative(alt));
        }
        
        // Update selected alternative dropdown after alternatives are loaded
        setTimeout(() => {
            updateSelectedAlternativeDropdown();
            if (adr.selectedAlternative) {
                document.getElementById('adr-selected-alternative').value = adr.selectedAlternative;
            }
            document.getElementById('adr-selection-reason').value = adr.selectionReason || '';
        }, 100);
        
        // Links
        if (adr.links) {
            adr.links.forEach(link => addAdrLink(link));
        }
        
        // Related ADR
        if (adr.relatedAdr) {
            setMultiSelectValues('adr-supersedes', adr.relatedAdr.supersedes || []);
            setMultiSelectValues('adr-superseded-by', adr.relatedAdr.supersededBy || []);
            setMultiSelectValues('adr-related-to', adr.relatedAdr.relatedTo || []);
        }
        
        // Linked elements and relationships
        if (adr.linkedElements) {
            setMultiSelectValues('adr-linked-elements', adr.linkedElements);
        }
        if (adr.linkedRelationships) {
            setMultiSelectValues('adr-linked-relationships', adr.linkedRelationships);
        }
        
        // Status history
        if (adr.statusHistory && adr.statusHistory.length > 0) {
            document.getElementById('adr-status-history-fieldset').style.display = 'block';
            document.getElementById('adr-status-history').innerHTML = adr.statusHistory.map(h => `
                <div class="adr-history-item">
                    <span><strong>${getAdrStatusLabel(h.status)}</strong></span>
                    <span>${new Date(h.date).toLocaleString()}</span>
                    <span>${escapeHtml(h.author || h.approver || '-')}</span>
                </div>
            `).join('');
        }
    }
    
    function updateSelectedAlternativeDropdown() {
        const select = document.getElementById('adr-selected-alternative');
        const alternatives = Array.from(document.querySelectorAll('.adr-alternative-card'));
        
        const currentValue = select.value;
        select.innerHTML = '<option value="">-- Vyberte --</option>';
        
        alternatives.forEach((card, index) => {
            const title = card.querySelector('.alt-title').value.trim();
            if (title) {
                const option = document.createElement('option');
                option.value = index.toString();
                option.textContent = title;
                select.appendChild(option);
            }
        });
        
        // Restore selection if still valid
        if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
            select.value = currentValue;
        }
    }
    
    function setMultiSelectValues(selectId, values) {
        const select = document.getElementById(selectId);
        Array.from(select.options).forEach(opt => {
            opt.selected = values.includes(opt.value);
        });
    }
    
    function getMultiSelectValues(selectId) {
        const select = document.getElementById(selectId);
        return Array.from(select.selectedOptions).map(opt => opt.value);
    }
    
    function addAdrAlternative(data = null) {
        const container = document.getElementById('adr-alternatives-container');
        const index = container.querySelectorAll('.adr-alternative-card').length + 1;
        const div = document.createElement('div');
        div.className = 'adr-alternative-card';
        div.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #e0e0e0;">
                <h4 style="margin: 0; color: #333; font-size: 14px;">${t('adrAlternative')} ${index}</h4>
                <button type="button" class="btn-danger btn-small" onclick="this.closest('.adr-alternative-card').remove(); updateAlternativeNumbers(); updateSelectedAlternativeDropdown();">√ó</button>
            </div>
            <div class="form-group">
                <label>${t('adrAlternativeTitle')}</label>
                <input type="text" class="alt-title" value="${escapeHtml(data?.title || '')}" style="width: 100%;" onchange="updateSelectedAlternativeDropdown()">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label>${t('adrAlternativeDesc')}</label>
                <textarea class="alt-desc" rows="3" style="width: 100%;" placeholder="${t('adrAlternativeDescPlaceholder') || ''}">${escapeHtml(data?.description || '')}</textarea>
            </div>
        `;
        container.appendChild(div);
        
        // Update dropdown after adding
        setTimeout(updateSelectedAlternativeDropdown, 50);
    }
    
    function updateAlternativeNumbers() {
        const cards = document.querySelectorAll('.adr-alternative-card');
        cards.forEach((card, index) => {
            const header = card.querySelector('h4');
            if (header) {
                header.textContent = `${t('adrAlternative')} ${index + 1}`;
            }
        });
    }
    
    function addAdrLink(data = null) {
        const container = document.getElementById('adr-links-container');
        const div = document.createElement('div');
        div.className = 'adr-link-row';
        div.innerHTML = `
            <input type="text" class="link-title" value="${escapeHtml(data?.title || '')}" placeholder="${t('adrLinkTitle')}">
            <input type="url" class="link-url" value="${escapeHtml(data?.url || '')}" placeholder="${t('adrLinkUrl')}">
            <button type="button" class="btn-danger btn-small" onclick="this.parentElement.remove()">√ó</button>
        `;
        container.appendChild(div);
    }
    
    function handleAdrStatusChange() {
        // Could be used to enforce workflow rules in the future
    }
    
    function saveAdr() {
        const editId = document.getElementById('adr-edit-id').value;
        const number = document.getElementById('adr-number').value.trim() || getNextAdrNumber();
        const status = document.getElementById('adr-status').value;
        const title = document.getElementById('adr-title-input').value.trim();
        
        if (!title) {
            alert(t('alertEnterName'));
            document.getElementById('adr-title-input').focus();
            return;
        }
        
        // Consequences - simple string now
        const consequences = document.getElementById('adr-consequences').value.trim();
        
        // Collect alternatives
        const alternatives = Array.from(document.querySelectorAll('.adr-alternative-card')).map(card => ({
            title: card.querySelector('.alt-title').value.trim(),
            description: card.querySelector('.alt-desc').value.trim()
        })).filter(a => a.title);
        
        // Selected alternative
        const selectedAlternative = document.getElementById('adr-selected-alternative').value;
        const selectionReason = document.getElementById('adr-selection-reason').value.trim();
        
        // Collect links
        const links = Array.from(document.querySelectorAll('.adr-link-row')).map(row => ({
            title: row.querySelector('.link-title').value.trim(),
            url: row.querySelector('.link-url').value.trim()
        })).filter(l => l.title || l.url);
        
        const now = new Date().toISOString();
        
        const adrData = {
            id: editId || `adr-${Date.now()}`,
            number: number,
            title: title,
            status: status,
            created: editId ? undefined : now, // Will be set below for existing
            updated: now,
            author: document.getElementById('adr-author').value.trim(),
            approver: document.getElementById('adr-approver').value.trim(),
            deciders: document.getElementById('adr-deciders').value.split(',').map(s => s.trim()).filter(s => s),
            context: document.getElementById('adr-context').value.trim(),
            decision: document.getElementById('adr-decision').value.trim(),
            consequences: consequences,
            alternatives: alternatives,
            selectedAlternative: selectedAlternative,
            selectionReason: selectionReason,
            implementation: {
                status: document.getElementById('adr-impl-status').value,
                startDate: document.getElementById('adr-impl-start').value,
                targetDate: document.getElementById('adr-impl-target').value,
                notes: document.getElementById('adr-impl-notes').value.trim()
            },
            relatedAdr: {
                supersedes: getMultiSelectValues('adr-supersedes'),
                supersededBy: getMultiSelectValues('adr-superseded-by'),
                relatedTo: getMultiSelectValues('adr-related-to')
            },
            linkedElements: getMultiSelectValues('adr-linked-elements'),
            linkedRelationships: getMultiSelectValues('adr-linked-relationships'),
            tags: document.getElementById('adr-tags').value.split(',').map(s => s.trim()).filter(s => s),
            links: links
        };
        
        if (editId) {
            // Update existing
            const index = adrRecords.findIndex(a => a.id === editId);
            if (index !== -1) {
                const existing = adrRecords[index];
                adrData.created = existing.created;
                adrData.statusHistory = existing.statusHistory || [];
                
                // Add status change to history if changed
                if (existing.status !== status) {
                    adrData.statusHistory.push({
                        status: status,
                        date: now,
                        author: adrData.author || adrData.approver
                    });
                }
                
                adrRecords[index] = adrData;
            }
        } else {
            // New ADR
            adrData.created = now;
            adrData.statusHistory = [{
                status: status,
                date: now,
                author: adrData.author
            }];
            adrRecords.push(adrData);
        }
        
        renderAdrTable();
        saveToLocalStorage();
        closeAdrEditor();
    }
    
    function editAdr(adrId) {
        openAdrEditor(adrId);
    }
    
    function deleteAdr(adrId) {
        if (!confirm(t('adrConfirmDelete'))) return;
        
        adrRecords = adrRecords.filter(a => a.id !== adrId);
        renderAdrTable();
        saveToLocalStorage();
    }
    
    function generateAdrMarkdown(adr) {
        const statusInfo = ADR_STATUSES[adr.status] || ADR_STATUSES.draft;
        const statusLabel = getAdrStatusLabel(adr.status);
        
        let md = `# ADR-${formatAdrNumber(adr.number)}: ${adr.title || 'Bez n√°zvu'}\n\n`;
        
        // Metadata table
        md += `| Atribut | Hodnota |\n`;
        md += `|---------|--------|\n`;
        md += `| **${t('adrStatus')}** | ${statusInfo.icon} ${statusLabel} |\n`;
        md += `| **${t('adrCreated')}** | ${adr.created ? new Date(adr.created).toLocaleDateString() : '-'} |\n`;
        md += `| **${t('adrUpdated')}** | ${adr.updated ? new Date(adr.updated).toLocaleDateString() : '-'} |\n`;
        md += `| **${t('adrAuthor')}** | ${adr.author || '-'} |\n`;
        if (adr.approver) {
            md += `| **${t('adrApprover')}** | ${adr.approver} |\n`;
        }
        if (adr.deciders && adr.deciders.length > 0) {
            md += `| **${t('adrDeciders')}** | ${adr.deciders.join(', ')} |\n`;
        }
        if (adr.tags && adr.tags.length > 0) {
            md += `| **${t('adrTags')}** | ${adr.tags.join(', ')} |\n`;
        }
        md += '\n';
        
        // Context
        if (adr.context) {
            md += `## ${t('adrContext')}\n\n`;
            md += `${adr.context}\n\n`;
        }
        
        // Decision
        if (adr.decision) {
            md += `## ${t('adrDecision')}\n\n`;
            md += `${adr.decision}\n\n`;
        }
        
        // Consequences (simple string now)
        if (adr.consequences) {
            md += `## ${t('adrConsequences')}\n\n`;
            md += `${adr.consequences}\n\n`;
        }
        
        // Alternatives with selected one
        if (adr.alternatives && adr.alternatives.length > 0) {
            md += `## ${t('adrAlternatives')}\n\n`;
            
            const selectedIdx = adr.selectedAlternative ? parseInt(adr.selectedAlternative) : -1;
            
            adr.alternatives.forEach((alt, idx) => {
                const isSelected = idx === selectedIdx;
                const selectedMark = isSelected ? ` ‚úÖ **${t('adrSelected')}**` : '';
                md += `### ${alt.title}${selectedMark}\n\n`;
                if (alt.description) {
                    md += `${alt.description}\n\n`;
                }
            });
            
            // Selection reason
            if (adr.selectionReason && selectedIdx >= 0) {
                md += `### ${t('adrSelectionReason')}\n\n`;
                md += `${adr.selectionReason}\n\n`;
            }
        }
        
        // Implementation
        if (adr.implementation && (adr.implementation.status !== 'not_started' || adr.implementation.notes)) {
            md += `## ${t('adrImplementation')}\n\n`;
            
            md += `| ${t('adrImplStatus')} | ${t('adrImplStartDate')} | ${t('adrImplTargetDate')} |\n`;
            md += `|--------|---------|----------|\n`;
            md += `| ${getAdrImplStatusLabel(adr.implementation.status)} | ${adr.implementation.startDate || '-'} | ${adr.implementation.targetDate || '-'} |\n\n`;
            
            if (adr.implementation.notes) {
                md += `${adr.implementation.notes}\n\n`;
            }
        }
        
        // Links
        if (adr.links && adr.links.length > 0) {
            md += `## ${t('adrLinks')}\n\n`;
            adr.links.forEach(link => {
                md += `- [${link.title || link.url}](${link.url})\n`;
            });
            md += '\n';
        }
        
        // Related ADR
        if (adr.relatedAdr) {
            const hasRelated = (adr.relatedAdr.supersedes?.length || 0) + 
                              (adr.relatedAdr.supersededBy?.length || 0) + 
                              (adr.relatedAdr.relatedTo?.length || 0) > 0;
            if (hasRelated) {
                md += `## ${t('adrRelatedAdr')}\n\n`;
                
                const getAdrRef = (id) => {
                    const related = adrRecords.find(a => a.id === id);
                    if (related) {
                        return `ADR-${formatAdrNumber(related.number)}: ${related.title}`;
                    }
                    return id;
                };
                
                if (adr.relatedAdr.supersedes?.length > 0) {
                    md += `**${t('adrSupersedes')}:** ${adr.relatedAdr.supersedes.map(getAdrRef).join(', ')}\n\n`;
                }
                if (adr.relatedAdr.supersededBy?.length > 0) {
                    md += `**${t('adrSupersededBy')}:** ${adr.relatedAdr.supersededBy.map(getAdrRef).join(', ')}\n\n`;
                }
                if (adr.relatedAdr.relatedTo?.length > 0) {
                    md += `**${t('adrRelatedTo')}:** ${adr.relatedAdr.relatedTo.map(getAdrRef).join(', ')}\n\n`;
                }
            }
        }
        
        // Status history
        if (adr.statusHistory && adr.statusHistory.length > 0) {
            md += `## ${t('adrStatusHistory')}\n\n`;
            md += `| ${t('adrStatus')} | ${t('date')} | ${t('adrAuthor')} |\n`;
            md += `|------|------|-------|\n`;
            adr.statusHistory.forEach(h => {
                md += `| ${getAdrStatusLabel(h.status)} | ${new Date(h.date).toLocaleString()} | ${h.author || h.approver || '-'} |\n`;
            });
            md += '\n';
        }
        
        md += `---\n\n`;
        md += `*${t('generatedFrom')} ArchiMate Editor - ${new Date().toLocaleDateString()}*\n`;
        
        return md;
    }
    
    function getAdrFromForm() {
        // Build ADR object from current form state
        const consequences = document.getElementById('adr-consequences').value.trim();
        
        const alternatives = Array.from(document.querySelectorAll('.adr-alternative-card')).map(card => ({
            title: card.querySelector('.alt-title').value.trim(),
            description: card.querySelector('.alt-desc').value.trim()
        })).filter(a => a.title);
        
        const links = Array.from(document.querySelectorAll('.adr-link-row')).map(row => ({
            title: row.querySelector('.link-title').value.trim(),
            url: row.querySelector('.link-url').value.trim()
        })).filter(l => l.title || l.url);
        
        const editId = document.getElementById('adr-edit-id').value;
        const existing = editId ? adrRecords.find(a => a.id === editId) : null;
        
        return {
            id: editId || `adr-${Date.now()}`,
            number: document.getElementById('adr-number').value.trim() || '1',
            title: document.getElementById('adr-title-input').value.trim(),
            status: document.getElementById('adr-status').value,
            created: existing?.created || new Date().toISOString(),
            updated: new Date().toISOString(),
            author: document.getElementById('adr-author').value.trim(),
            approver: document.getElementById('adr-approver').value.trim(),
            deciders: document.getElementById('adr-deciders').value.split(',').map(s => s.trim()).filter(s => s),
            context: document.getElementById('adr-context').value.trim(),
            decision: document.getElementById('adr-decision').value.trim(),
            consequences: consequences,
            alternatives: alternatives,
            selectedAlternative: document.getElementById('adr-selected-alternative').value,
            selectionReason: document.getElementById('adr-selection-reason').value.trim(),
            implementation: {
                status: document.getElementById('adr-impl-status').value,
                startDate: document.getElementById('adr-impl-start').value,
                targetDate: document.getElementById('adr-impl-target').value,
                notes: document.getElementById('adr-impl-notes').value.trim()
            },
            relatedAdr: {
                supersedes: getMultiSelectValues('adr-supersedes'),
                supersededBy: getMultiSelectValues('adr-superseded-by'),
                relatedTo: getMultiSelectValues('adr-related-to')
            },
            tags: document.getElementById('adr-tags').value.split(',').map(s => s.trim()).filter(s => s),
            links: links,
            statusHistory: existing?.statusHistory || []
        };
    }
    
    async function saveAdrAsMarkdown() {
        const adr = getAdrFromForm();
        const markdown = generateAdrMarkdown(adr);
        const filename = `ADR-${formatAdrNumber(adr.number)}-${(adr.title || 'untitled').replace(/[^a-zA-Z0-9√°ƒçƒè√©ƒõ√≠≈à√≥≈ô≈°≈•√∫≈Ø√Ω≈æ√Åƒåƒé√âƒö√ç≈á√ì≈ò≈†≈§√ö≈Æ√ù≈Ω ]/g, '').replace(/\s+/g, '-').toLowerCase()}.md`;
        
        await saveFileWithDialog(markdown, filename, 'text/markdown', ['.md']);
    }
    
    async function saveAdrAsDocx() {
        try {
            const adr = getAdrFromForm();
            const blob = await generateDocxFromAdr(adr);
            const filename = `ADR-${formatAdrNumber(adr.number)}-${(adr.title || 'untitled').replace(/[^a-zA-Z0-9√°ƒçƒè√©ƒõ√≠≈à√≥≈ô≈°≈•√∫≈Ø√Ω≈æ√Åƒåƒé√âƒö√ç≈á√ì≈ò≈†≈§√ö≈Æ√ù≈Ω ]/g, '').replace(/\s+/g, '-').toLowerCase()}.docx`;
            await saveFileWithDialog(blob, filename, 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', ['.docx']);
        } catch (e) {
            console.error('DOCX export error:', e);
            alert('Chyba p≈ôi exportu do DOCX: ' + e.message);
        }
    }
    
    function copyAdrAsMarkdown() {
        const adr = getAdrFromForm();
        const markdown = generateAdrMarkdown(adr);
        
        navigator.clipboard.writeText(markdown).then(() => {
            alert(t('adrMarkdownCopied'));
        }).catch(err => {
            // Fallback
            const textarea = document.createElement('textarea');
            textarea.value = markdown;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert(t('adrMarkdownCopied'));
        });
    }
    
    function copyAdrMarkdownById(adrId) {
        const adr = adrRecords.find(a => a.id === adrId);
        if (!adr) return;
        
        const markdown = generateAdrMarkdown(adr);
        
        navigator.clipboard.writeText(markdown).then(() => {
            alert(t('adrMarkdownCopied'));
        }).catch(err => {
            const textarea = document.createElement('textarea');
            textarea.value = markdown;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert(t('adrMarkdownCopied'));
        });
    }
    
    // ADR Preview Modal
    let currentPreviewAdrId = null;
    
    function openAdrPreview(adrId) {
        const adr = adrRecords.find(a => a.id === adrId);
        if (!adr) return;
        
        currentPreviewAdrId = adrId;
        
        const modal = document.getElementById('adr-preview-modal');
        const titleEl = document.getElementById('adr-preview-title');
        const contentEl = document.getElementById('adr-preview-content');
        
        titleEl.textContent = `ADR-${formatAdrNumber(adr.number)}: ${adr.title || ''}`;
        contentEl.innerHTML = generateAdrPreviewHtml(adr);
        
        modal.style.display = 'flex';
    }
    
    function closeAdrPreview() {
        document.getElementById('adr-preview-modal').style.display = 'none';
        currentPreviewAdrId = null;
    }
    
    function closeAdrPreviewOnOverlay(event) {
        if (event.target === event.currentTarget) {
            closeAdrPreview();
        }
    }
    
    function generateAdrPreviewHtml(adr) {
        const statusInfo = ADR_STATUSES[adr.status] || ADR_STATUSES.draft;
        const statusLabel = getAdrStatusLabel(adr.status);
        
        let html = '';
        
        // Status badge
        html += `<div style="margin-bottom: 20px;">
            <span class="adr-status-badge ${statusInfo.colorClass}" style="font-size: 14px; padding: 6px 12px;">
                ${statusInfo.icon} ${statusLabel}
            </span>
        </div>`;
        
        // Metadata table
        html += `<table style="width: 100%; margin-bottom: 20px; font-size: 14px;">
            <tr><td style="width: 150px; font-weight: bold; padding: 5px 10px; background: #f5f5f5;">${t('adrAuthor')}</td><td style="padding: 5px 10px;">${escapeHtml(adr.author || '-')}</td></tr>
            ${adr.approver ? `<tr><td style="font-weight: bold; padding: 5px 10px; background: #f5f5f5;">${t('adrApprover')}</td><td style="padding: 5px 10px;">${escapeHtml(adr.approver)}</td></tr>` : ''}
            ${adr.deciders?.length > 0 ? `<tr><td style="font-weight: bold; padding: 5px 10px; background: #f5f5f5;">${t('adrDeciders')}</td><td style="padding: 5px 10px;">${escapeHtml(adr.deciders.join(', '))}</td></tr>` : ''}
            <tr><td style="font-weight: bold; padding: 5px 10px; background: #f5f5f5;">${t('adrCreated')}</td><td style="padding: 5px 10px;">${adr.created ? new Date(adr.created).toLocaleDateString() : '-'}</td></tr>
            <tr><td style="font-weight: bold; padding: 5px 10px; background: #f5f5f5;">${t('adrUpdated')}</td><td style="padding: 5px 10px;">${adr.updated ? new Date(adr.updated).toLocaleDateString() : '-'}</td></tr>
            ${adr.tags?.length > 0 ? `<tr><td style="font-weight: bold; padding: 5px 10px; background: #f5f5f5;">${t('adrTags')}</td><td style="padding: 5px 10px;">${adr.tags.map(tag => `<span style="display: inline-block; background: #e0e0e0; padding: 2px 8px; border-radius: 10px; margin-right: 5px; font-size: 12px;">${escapeHtml(tag)}</span>`).join('')}</td></tr>` : ''}
        </table>`;
        
        // Context
        if (adr.context) {
            html += `<div style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px;">${t('adrContext')}</h3>
                <div class="markdown-content">${renderMarkdown(adr.context)}</div>
            </div>`;
        }
        
        // Decision
        if (adr.decision) {
            html += `<div style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px;">${t('adrDecision')}</h3>
                <div class="markdown-content">${renderMarkdown(adr.decision)}</div>
            </div>`;
        }
        
        // Consequences
        if (adr.consequences) {
            html += `<div style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px;">${t('adrConsequences')}</h3>
                <div class="markdown-content">${renderMarkdown(adr.consequences)}</div>
            </div>`;
        }
        
        // Alternatives
        if (adr.alternatives && adr.alternatives.length > 0) {
            const selectedIdx = adr.selectedAlternative ? parseInt(adr.selectedAlternative) : -1;
            
            html += `<div style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px;">${t('adrAlternatives')}</h3>`;
            
            adr.alternatives.forEach((alt, idx) => {
                const isSelected = idx === selectedIdx;
                const bgColor = isSelected ? '#e8f5e9' : '#fafafa';
                const borderColor = isSelected ? '#4CAF50' : '#ddd';
                
                html += `<div style="border: 2px solid ${borderColor}; border-radius: 4px; padding: 12px; margin-bottom: 10px; background: ${bgColor};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="font-size: 15px;">${t('adrAlternative')} ${idx + 1}: ${escapeHtml(alt.title)}</strong>
                        ${isSelected ? `<span style="background: #4CAF50; color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: bold;">‚úÖ ${t('adrSelected')}</span>` : ''}
                    </div>
                    ${alt.description ? `<div class="markdown-content" style="margin: 0; color: #555;">${renderMarkdown(alt.description)}</div>` : ''}
                </div>`;
            });
            
            // Selection reason
            if (adr.selectionReason && selectedIdx >= 0) {
                html += `<div style="background: #e8f5e9; border: 1px solid #c8e6c9; border-radius: 4px; padding: 12px; margin-top: 10px;">
                    <strong style="color: #2e7d32;">${t('adrSelectionReason')}:</strong>
                    <div class="markdown-content" style="margin-top: 8px;">${renderMarkdown(adr.selectionReason)}</div>
                </div>`;
            }
            
            html += `</div>`;
        }
        
        // Implementation
        if (adr.implementation && (adr.implementation.status !== 'not_started' || adr.implementation.notes)) {
            html += `<div style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px;">${t('adrImplementation')}</h3>
                <table style="width: 100%; margin-bottom: 10px; font-size: 14px;">
                    <tr>
                        <td style="font-weight: bold; padding: 5px 10px; background: #f5f5f5; width: 150px;">${t('adrImplStatus')}</td>
                        <td style="padding: 5px 10px;">${getAdrImplStatusLabel(adr.implementation.status)}</td>
                    </tr>
                    ${adr.implementation.startDate ? `<tr><td style="font-weight: bold; padding: 5px 10px; background: #f5f5f5;">${t('adrImplStartDate')}</td><td style="padding: 5px 10px;">${adr.implementation.startDate}</td></tr>` : ''}
                    ${adr.implementation.targetDate ? `<tr><td style="font-weight: bold; padding: 5px 10px; background: #f5f5f5;">${t('adrImplTargetDate')}</td><td style="padding: 5px 10px;">${adr.implementation.targetDate}</td></tr>` : ''}
                </table>
                ${adr.implementation.notes ? `<div class="markdown-content" style="background: #fafafa; padding: 10px; border-radius: 4px;">${renderMarkdown(adr.implementation.notes)}</div>` : ''}
            </div>`;
        }
        
        // Links
        if (adr.links && adr.links.length > 0) {
            html += `<div style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px;">${t('adrLinks')}</h3>
                <ul style="margin: 0; padding-left: 20px;">`;
            adr.links.forEach(link => {
                html += `<li><a href="${escapeHtml(link.url)}" target="_blank" rel="noopener">${escapeHtml(link.title || link.url)}</a></li>`;
            });
            html += `</ul></div>`;
        }
        
        // Linked elements and relationships
        const hasLinked = (adr.linkedElements && adr.linkedElements.length > 0) || 
                         (adr.linkedRelationships && adr.linkedRelationships.length > 0);
        
        if (hasLinked) {
            html += `<div style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px;">${t('linkedItems')}</h3>
                <div style="padding: 10px; background: #f0f7ff; border-radius: 4px; border: 1px solid #d0e0f0;">`;
            
            if (adr.linkedElements && adr.linkedElements.length > 0) {
                html += `<div style="margin-bottom: 8px;"><strong>${t('elements')}:</strong> `;
                html += adr.linkedElements.map(id => {
                    const el = elements.find(e => e.id === id);
                    return el ? `<a href="#" onclick="switchTab('elements'); document.getElementById('filter-search').value='${escapeHtml(el.id)}'; filterElements(); closeAdrPreview(); return false;" style="margin-right: 8px;">${escapeHtml(el.name || el.id)}</a>` : id;
                }).join('');
                html += '</div>';
            }
            
            if (adr.linkedRelationships && adr.linkedRelationships.length > 0) {
                html += `<div><strong>${t('relationships')}:</strong> `;
                html += adr.linkedRelationships.map(id => {
                    const rel = relationships.find(r => r.id === id);
                    if (rel) {
                        const source = elements.find(e => e.id === rel.sourceId);
                        const target = elements.find(e => e.id === rel.targetId);
                        return `<span style="margin-right: 8px;">${escapeHtml(source?.name || rel.sourceId)} ‚Üí ${escapeHtml(target?.name || rel.targetId)}</span>`;
                    }
                    return id;
                }).join('');
                html += '</div>';
            }
            
            html += `</div></div>`;
        }
        
        // Related ADR
        if (adr.relatedAdr) {
            const hasRelated = (adr.relatedAdr.supersedes?.length || 0) + 
                              (adr.relatedAdr.supersededBy?.length || 0) + 
                              (adr.relatedAdr.relatedTo?.length || 0) > 0;
            if (hasRelated) {
                const getAdrLink = (id) => {
                    const related = adrRecords.find(a => a.id === id);
                    if (related) {
                        return `<a href="#" onclick="openAdrPreview('${id}'); return false;">ADR-${formatAdrNumber(related.number)}: ${escapeHtml(related.title)}</a>`;
                    }
                    return id;
                };
                
                html += `<div style="margin-bottom: 20px;">
                    <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px;">${t('adrRelatedAdr')}</h3>`;
                
                if (adr.relatedAdr.supersedes?.length > 0) {
                    html += `<p><strong>${t('adrSupersedes')}:</strong> ${adr.relatedAdr.supersedes.map(getAdrLink).join(', ')}</p>`;
                }
                if (adr.relatedAdr.supersededBy?.length > 0) {
                    html += `<p><strong>${t('adrSupersededBy')}:</strong> ${adr.relatedAdr.supersededBy.map(getAdrLink).join(', ')}</p>`;
                }
                if (adr.relatedAdr.relatedTo?.length > 0) {
                    html += `<p><strong>${t('adrRelatedTo')}:</strong> ${adr.relatedAdr.relatedTo.map(getAdrLink).join(', ')}</p>`;
                }
                
                html += `</div>`;
            }
        }
        
        // Status history
        if (adr.statusHistory && adr.statusHistory.length > 0) {
            html += `<div style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px;">${t('adrStatusHistory')}</h3>
                <table style="width: 100%; font-size: 14px; border-collapse: collapse;">
                    <tr style="background: #f5f5f5;">
                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">${t('adrStatus')}</th>
                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">${t('date')}</th>
                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">${t('adrAuthor')}</th>
                    </tr>`;
            adr.statusHistory.forEach(h => {
                html += `<tr>
                    <td style="padding: 8px; border-bottom: 1px solid #eee;">${getAdrStatusLabel(h.status)}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee;">${new Date(h.date).toLocaleString()}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee;">${escapeHtml(h.author || h.approver || '-')}</td>
                </tr>`;
            });
            html += `</table></div>`;
        }
        
        return html;
    }
    
    async function previewAdrSaveMarkdown() {
        if (!currentPreviewAdrId) return;
        const adr = adrRecords.find(a => a.id === currentPreviewAdrId);
        if (!adr) return;
        
        const markdown = generateAdrMarkdown(adr);
        const filename = `ADR-${formatAdrNumber(adr.number)}-${(adr.title || 'untitled').replace(/[^a-zA-Z0-9√°ƒçƒè√©ƒõ√≠≈à√≥≈ô≈°≈•√∫≈Ø√Ω≈æ√Åƒåƒé√âƒö√ç≈á√ì≈ò≈†≈§√ö≈Æ√ù≈Ω ]/g, '').replace(/\s+/g, '-').toLowerCase()}.md`;
        
        await saveFileWithDialog(markdown, filename, 'text/markdown', ['.md']);
    }
    
    async function previewAdrSaveDocx() {
        if (!currentPreviewAdrId) return;
        const adr = adrRecords.find(a => a.id === currentPreviewAdrId);
        if (!adr) return;
        
        try {
            const blob = await generateDocxFromAdr(adr);
            const filename = `ADR-${formatAdrNumber(adr.number)}-${(adr.title || 'untitled').replace(/[^a-zA-Z0-9√°ƒçƒè√©ƒõ√≠≈à√≥≈ô≈°≈•√∫≈Ø√Ω≈æ√Åƒåƒé√âƒö√ç≈á√ì≈ò≈†≈§√ö≈Æ√ù≈Ω ]/g, '').replace(/\s+/g, '-').toLowerCase()}.docx`;
            await saveFileWithDialog(blob, filename, 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', ['.docx']);
        } catch (e) {
            console.error('DOCX export error:', e);
            alert('Chyba p≈ôi exportu do DOCX: ' + e.message);
        }
    }
    
    function previewAdrCopyMarkdown() {
        if (!currentPreviewAdrId) return;
        copyAdrMarkdownById(currentPreviewAdrId);
    }
    
    function previewAdrEdit() {
        if (!currentPreviewAdrId) return;
        const adrId = currentPreviewAdrId; // Save ID before closing
        closeAdrPreview();
        editAdr(adrId);
    }
    
    async function exportAllAdrMarkdown() {
        if (adrRecords.length === 0) {
            alert(t('adrNoRecords'));
            return;
        }
        
        // Generate index
        let indexMd = `# Architecture Decision Records\n\n`;
        indexMd += `| # | ${t('adrTitleLabel')} | ${t('adrStatus')} | ${t('adrAuthor')} | ${t('adrUpdated')} |\n`;
        indexMd += `|---|-------|------|-------|------|\n`;
        
        // Sort by number - compare numerically if both are numeric, otherwise alphabetically
        const sorted = [...adrRecords].sort((a, b) => {
            const aStr = String(a.number || '');
            const bStr = String(b.number || '');
            const aNum = parseInt(aStr.replace(/\D/g, '')) || 0;
            const bNum = parseInt(bStr.replace(/\D/g, '')) || 0;
            if (aNum !== bNum) return aNum - bNum;
            return aStr.localeCompare(bStr);
        });
        
        sorted.forEach(adr => {
            const statusInfo = ADR_STATUSES[adr.status] || ADR_STATUSES.draft;
            const filename = `adr-${formatAdrNumber(adr.number)}.md`;
            indexMd += `| [ADR-${formatAdrNumber(adr.number)}](${filename}) | ${adr.title || '-'} | ${statusInfo.icon} ${getAdrStatusLabel(adr.status)} | ${adr.author || '-'} | ${adr.updated ? new Date(adr.updated).toLocaleDateString() : '-'} |\n`;
        });
        
        indexMd += `\n## ${t('statistics')}\n\n`;
        
        const statusCounts = {};
        adrRecords.forEach(adr => {
            statusCounts[adr.status] = (statusCounts[adr.status] || 0) + 1;
        });
        
        indexMd += `- **${t('total')}:** ${adrRecords.length}\n`;
        Object.entries(statusCounts).forEach(([status, count]) => {
            indexMd += `- **${getAdrStatusLabel(status)}:** ${count}\n`;
        });
        
        // Generate combined document
        let combinedMd = indexMd + '\n\n---\n\n';
        sorted.forEach(adr => {
            combinedMd += generateAdrMarkdown(adr) + '\n\n---\n\n';
        });
        
        const modelName = modelMetadata.name || 'archimate-model';
        const filename = `${modelName.replace(/[^a-zA-Z0-9]/g, '-')}-adr.md`;
        
        await saveFileWithDialog(combinedMd, filename, 'text/markdown', ['.md']);
    }

    // ============================================
    // Notes Functions
    // ============================================
    
    let currentPreviewNoteId = null;
    let currentVersionIndex = null;
    
    function renderNotesTable() {
        const tbody = document.getElementById('notes-table-body');
        const searchTerm = document.getElementById('notes-search').value.toLowerCase().trim();
        
        let filtered = notes.filter(note => {
            if (searchTerm) {
                const searchFields = [
                    note.name || '',
                    note.author || '',
                    note.content || '',
                    (note.tags || []).join(' ')
                ].join(' ').toLowerCase();
                if (!searchFields.includes(searchTerm)) return false;
            }
            return true;
        });
        
        // Sort by updated date descending
        filtered.sort((a, b) => new Date(b.updated) - new Date(a.updated));
        
        if (filtered.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #666;">${t('noteNoRecords')}</td></tr>`;
            return;
        }
        
        tbody.innerHTML = filtered.map(note => {
            const updatedDate = note.updated ? new Date(note.updated).toLocaleString() : '-';
            const versionCount = note.versions ? note.versions.length : 0;
            const tagsHtml = (note.tags || []).map(tag => 
                `<span style="display: inline-block; background: #e0e0e0; padding: 1px 6px; border-radius: 8px; margin-right: 3px; font-size: 11px;">${escapeHtml(tag)}</span>`
            ).join('');
            
            return `
                <tr>
                    <td><a href="#" onclick="openNotePreview('${note.id}'); return false;" style="color: #0066cc; text-decoration: none; font-weight: bold;">${escapeHtml(note.name || '')}</a></td>
                    <td>${escapeHtml(note.author || '-')}</td>
                    <td>${tagsHtml || '-'}</td>
                    <td>${updatedDate}</td>
                    <td style="text-align: center;">${versionCount}</td>
                    <td>
                        <button type="button" class="btn-secondary btn-small" onclick="copyNoteContentById('${note.id}')" title="${t('copyContent')}">üìã</button>
                        <button type="button" class="btn-secondary btn-small" onclick="editNote('${note.id}')" title="${t('edit')}">‚úèÔ∏è</button>
                        <button type="button" class="btn-danger btn-small" onclick="deleteNote('${note.id}')" title="${t('delete')}">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    function copyNoteContentById(noteId) {
        const note = notes.find(n => n.id === noteId);
        if (!note) return;
        
        navigator.clipboard.writeText(note.content || '').then(() => {
            // Visual feedback - could show a toast
        }).catch(err => {
            const textarea = document.createElement('textarea');
            textarea.value = note.content || '';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        });
    }
    
    function openNoteEditor(noteId = null) {
        const modal = document.getElementById('note-editor-modal');
        const titleEl = document.getElementById('note-editor-title');
        
        // Populate linked selects
        populateNoteLinkedSelects();
        
        // Clear form
        document.getElementById('note-edit-id').value = '';
        document.getElementById('note-name').value = '';
        document.getElementById('note-author').value = modelMetadata.dublinCore?.creator || '';
        document.getElementById('note-tags').value = '';
        document.getElementById('note-content').value = '';
        document.getElementById('note-linked-elements').selectedIndex = -1;
        document.getElementById('note-linked-relationships').selectedIndex = -1;
        
        if (noteId) {
            const note = notes.find(n => n.id === noteId);
            if (note) {
                titleEl.textContent = note.name || t('edit');
                document.getElementById('note-edit-id').value = note.id;
                document.getElementById('note-name').value = note.name || '';
                document.getElementById('note-author').value = note.author || '';
                document.getElementById('note-tags').value = (note.tags || []).join(', ');
                document.getElementById('note-content').value = note.content || '';
                
                // Set linked elements
                if (note.linkedElements) {
                    setMultiSelectValues('note-linked-elements', note.linkedElements);
                }
                // Set linked relationships
                if (note.linkedRelationships) {
                    setMultiSelectValues('note-linked-relationships', note.linkedRelationships);
                }
            }
        } else {
            titleEl.textContent = t('notesNew');
        }
        
        modal.style.display = 'flex';
        document.getElementById('note-name').focus();
    }
    
    function populateNoteLinkedSelects() {
        const elementsSelect = document.getElementById('note-linked-elements');
        const relsSelect = document.getElementById('note-linked-relationships');
        
        // Populate elements
        elementsSelect.innerHTML = elements.map(e => 
            `<option value="${escapeHtml(e.id)}">${escapeHtml(e.name || e.id)} (${e.type})</option>`
        ).join('');
        
        // Populate relationships
        relsSelect.innerHTML = relationships.map(r => {
            const source = elements.find(e => e.id === r.sourceId);
            const target = elements.find(e => e.id === r.targetId);
            const sourceName = source ? source.name : r.sourceId;
            const targetName = target ? target.name : r.targetId;
            return `<option value="${escapeHtml(r.id)}">${escapeHtml(sourceName)} ‚Üí ${escapeHtml(targetName)} (${r.type})</option>`;
        }).join('');
        
        updateSelectOriginalOptions('note-linked-elements');
        updateSelectOriginalOptions('note-linked-relationships');
    }
    
    function closeNoteEditor() {
        document.getElementById('note-editor-modal').style.display = 'none';
    }
    
    function closeNoteEditorOnOverlay(event) {
        if (event.target === event.currentTarget) {
            closeNoteEditor();
        }
    }
    
    function saveNote() {
        const editId = document.getElementById('note-edit-id').value;
        const name = document.getElementById('note-name').value.trim();
        const author = document.getElementById('note-author').value.trim();
        const tags = document.getElementById('note-tags').value.split(',').map(s => s.trim()).filter(s => s);
        const content = document.getElementById('note-content').value;
        const linkedElements = getMultiSelectValues('note-linked-elements');
        const linkedRelationships = getMultiSelectValues('note-linked-relationships');
        
        if (!name) {
            alert(t('alertEnterName'));
            document.getElementById('note-name').focus();
            return;
        }
        
        const now = new Date().toISOString();
        
        if (editId) {
            // Update existing note
            const index = notes.findIndex(n => n.id === editId);
            if (index !== -1) {
                const existing = notes[index];
                
                // Save current version to history before updating
                if (!existing.versions) {
                    existing.versions = [];
                }
                existing.versions.push({
                    date: existing.updated || existing.created,
                    name: existing.name,
                    author: existing.author,
                    content: existing.content
                });
                
                // Update note
                existing.name = name;
                existing.author = author;
                existing.tags = tags;
                existing.content = content;
                existing.linkedElements = linkedElements;
                existing.linkedRelationships = linkedRelationships;
                existing.updated = now;
            }
        } else {
            // Create new note
            const newNote = {
                id: `note-${Date.now()}`,
                name: name,
                author: author,
                tags: tags,
                content: content,
                linkedElements: linkedElements,
                linkedRelationships: linkedRelationships,
                created: now,
                updated: now,
                versions: []
            };
            notes.push(newNote);
        }
        
        renderNotesTable();
        updateP≈ô√≠znakyFilters(); // Update tag filters since notes can have tags now
        saveToLocalStorage();
        closeNoteEditor();
    }
    
    function editNote(noteId) {
        openNoteEditor(noteId);
    }
    
    function deleteNote(noteId) {
        if (!confirm(t('noteConfirmDelete'))) return;
        
        notes = notes.filter(n => n.id !== noteId);
        renderNotesTable();
        saveToLocalStorage();
    }
    
    // Note Preview
    function openNotePreview(noteId) {
        const note = notes.find(n => n.id === noteId);
        if (!note) return;
        
        currentPreviewNoteId = noteId;
        
        const modal = document.getElementById('note-preview-modal');
        const titleEl = document.getElementById('note-preview-title');
        const metaEl = document.getElementById('note-preview-meta');
        const linkedEl = document.getElementById('note-preview-linked');
        const contentEl = document.getElementById('note-preview-content');
        
        titleEl.textContent = note.name || '';
        
        let metaHtml = `
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div><strong>${t('noteAuthor')}:</strong> ${escapeHtml(note.author || '-')}</div>
                <div><strong>${t('noteUpdated')}:</strong> ${note.updated ? new Date(note.updated).toLocaleString() : '-'}</div>
                <div><strong>${t('noteVersions')}:</strong> ${note.versions ? note.versions.length : 0}</div>
            </div>
        `;
        
        if (note.tags && note.tags.length > 0) {
            metaHtml += `<div style="margin-top: 8px;"><strong>${t('tags')}:</strong> ${note.tags.map(tag => 
                `<span style="display: inline-block; background: #e0e0e0; padding: 2px 8px; border-radius: 10px; margin-right: 5px; font-size: 12px;">${escapeHtml(tag)}</span>`
            ).join('')}</div>`;
        }
        
        metaEl.innerHTML = metaHtml;
        
        // Linked items
        const hasLinked = (note.linkedElements && note.linkedElements.length > 0) || 
                         (note.linkedRelationships && note.linkedRelationships.length > 0);
        
        if (hasLinked) {
            let linkedHtml = `<div style="padding: 10px; background: #f0f7ff; border-radius: 4px; border: 1px solid #d0e0f0;">
                <strong style="color: #336;">${t('linkedItems')}:</strong><br>`;
            
            if (note.linkedElements && note.linkedElements.length > 0) {
                linkedHtml += `<div style="margin-top: 5px;"><strong>${t('elements')}:</strong> `;
                linkedHtml += note.linkedElements.map(id => {
                    const el = elements.find(e => e.id === id);
                    return el ? `<a href="#" onclick="switchTab('elements'); document.getElementById('filter-search').value='${escapeHtml(el.id)}'; filterElements(); return false;" style="margin-right: 8px;">${escapeHtml(el.name || el.id)}</a>` : id;
                }).join('');
                linkedHtml += '</div>';
            }
            
            if (note.linkedRelationships && note.linkedRelationships.length > 0) {
                linkedHtml += `<div style="margin-top: 5px;"><strong>${t('relationships')}:</strong> `;
                linkedHtml += note.linkedRelationships.map(id => {
                    const rel = relationships.find(r => r.id === id);
                    if (rel) {
                        const source = elements.find(e => e.id === rel.sourceId);
                        const target = elements.find(e => e.id === rel.targetId);
                        return `<span style="margin-right: 8px;">${escapeHtml(source?.name || rel.sourceId)} ‚Üí ${escapeHtml(target?.name || rel.targetId)}</span>`;
                    }
                    return id;
                }).join('');
                linkedHtml += '</div>';
            }
            
            linkedHtml += '</div>';
            linkedEl.innerHTML = linkedHtml;
            linkedEl.style.display = 'block';
        } else {
            linkedEl.style.display = 'none';
        }
        
        contentEl.innerHTML = renderMarkdown(note.content || '');
        
        modal.style.display = 'flex';
    }
    
    function copyNoteContent() {
        if (!currentPreviewNoteId) return;
        const note = notes.find(n => n.id === currentPreviewNoteId);
        if (!note) return;
        
        navigator.clipboard.writeText(note.content || '').then(() => {
            alert(t('contentCopied'));
        }).catch(err => {
            // Fallback
            const textarea = document.createElement('textarea');
            textarea.value = note.content || '';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert(t('contentCopied'));
        });
    }
    
    function closeNotePreview() {
        document.getElementById('note-preview-modal').style.display = 'none';
        currentPreviewNoteId = null;
    }
    
    function closeNotePreviewOnOverlay(event) {
        if (event.target === event.currentTarget) {
            closeNotePreview();
        }
    }
    
    function previewNoteEdit() {
        if (!currentPreviewNoteId) return;
        const noteId = currentPreviewNoteId; // Save ID before closing
        closeNotePreview();
        editNote(noteId);
    }
    
    // Note Versions
    function openNoteVersions() {
        if (!currentPreviewNoteId) return;
        
        const note = notes.find(n => n.id === currentPreviewNoteId);
        if (!note) return;
        
        closeNotePreview();
        
        const modal = document.getElementById('note-versions-modal');
        const titleEl = document.getElementById('note-versions-title');
        const listEl = document.getElementById('note-versions-list');
        
        titleEl.textContent = `${t('noteVersions')}: ${note.name}`;
        
        // Build version list - current version first, then history in reverse order
        let listHtml = `
            <div class="note-version-item current active" onclick="showNoteVersion(-1)">
                <div class="note-version-date">${t('noteCurrentVersion')}</div>
                <div class="note-version-time">${note.updated ? new Date(note.updated).toLocaleString() : '-'}</div>
            </div>
        `;
        
        if (note.versions && note.versions.length > 0) {
            // Reverse to show newest first
            const reversedVersions = [...note.versions].reverse();
            reversedVersions.forEach((version, idx) => {
                const realIndex = note.versions.length - 1 - idx;
                const versionDate = new Date(version.date);
                listHtml += `
                    <div class="note-version-item" onclick="showNoteVersion(${realIndex})">
                        <div class="note-version-date">${versionDate.toLocaleDateString()}</div>
                        <div class="note-version-time">${versionDate.toLocaleTimeString()}</div>
                    </div>
                `;
            });
        }
        
        listEl.innerHTML = listHtml;
        
        // Show current version
        currentVersionIndex = -1;
        showNoteVersion(-1);
        
        modal.style.display = 'flex';
    }
    
    function showNoteVersion(versionIndex) {
        if (!currentPreviewNoteId) return;
        
        const note = notes.find(n => n.id === currentPreviewNoteId);
        if (!note) return;
        
        currentVersionIndex = versionIndex;
        
        const metaEl = document.getElementById('note-version-meta');
        const contentEl = document.getElementById('note-version-content');
        const restoreBtn = document.getElementById('note-restore-btn');
        
        // Update active state in list
        document.querySelectorAll('.note-version-item').forEach((el, idx) => {
            el.classList.remove('active');
            if ((versionIndex === -1 && idx === 0) || (versionIndex >= 0 && idx === note.versions.length - versionIndex)) {
                el.classList.add('active');
            }
        });
        
        let versionData;
        if (versionIndex === -1) {
            // Current version
            versionData = {
                date: note.updated,
                name: note.name,
                author: note.author,
                content: note.content
            };
            restoreBtn.style.display = 'none';
        } else {
            // Historical version
            versionData = note.versions[versionIndex];
            restoreBtn.style.display = 'inline-block';
        }
        
        metaEl.innerHTML = `
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div><strong>${t('noteName')}:</strong> ${escapeHtml(versionData.name || '-')}</div>
                <div><strong>${t('noteAuthor')}:</strong> ${escapeHtml(versionData.author || '-')}</div>
                <div><strong>${t('date')}:</strong> ${versionData.date ? new Date(versionData.date).toLocaleString() : '-'}</div>
            </div>
        `;
        
        contentEl.innerHTML = renderMarkdown(versionData.content || '');
    }
    
    function restoreNoteVersion() {
        if (!currentPreviewNoteId || currentVersionIndex === null || currentVersionIndex === -1) return;
        
        const note = notes.find(n => n.id === currentPreviewNoteId);
        if (!note || !note.versions || !note.versions[currentVersionIndex]) return;
        
        const version = note.versions[currentVersionIndex];
        
        // Save current as a new version before restoring
        note.versions.push({
            date: note.updated,
            name: note.name,
            author: note.author,
            content: note.content
        });
        
        // Restore selected version
        note.name = version.name;
        note.author = version.author;
        note.content = version.content;
        note.updated = new Date().toISOString();
        
        renderNotesTable();
        saveToLocalStorage();
        
        alert(t('noteVersionRestored'));
        closeNoteVersions();
    }
    
    function closeNoteVersions() {
        document.getElementById('note-versions-modal').style.display = 'none';
        currentVersionIndex = null;
    }
    
    function closeNoteVersionsOnOverlay(event) {
        if (event.target === event.currentTarget) {
            closeNoteVersions();
        }
    }
    
    // Simple Markdown renderer
    function renderMarkdown(text) {
        if (!text) return '';
        
        let html = escapeHtml(text);
        
        // Headers
        html = html.replace(/^######\s+(.*)$/gm, '<h6>$1</h6>');
        html = html.replace(/^#####\s+(.*)$/gm, '<h5>$1</h5>');
        html = html.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
        html = html.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
        html = html.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
        html = html.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
        
        // Bold and italic
        html = html.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
        html = html.replace(/___(.+?)___/g, '<strong><em>$1</em></strong>');
        html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');
        html = html.replace(/_(.+?)_/g, '<em>$1</em>');
        
        // Code blocks
        html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
        html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
        
        // Blockquotes
        html = html.replace(/^&gt;\s+(.*)$/gm, '<blockquote>$1</blockquote>');
        
        // Links
        html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
        
        // Images
        html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">');
        
        // Horizontal rule
        html = html.replace(/^---+$/gm, '<hr>');
        html = html.replace(/^\*\*\*+$/gm, '<hr>');
        
        // Process lists properly
        const lines = html.split('\n');
        const result = [];
        let inUnorderedList = false;
        let inOrderedList = false;
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            const trimmedLine = line.trim();
            
            // Check for unordered list item
            const ulMatch = trimmedLine.match(/^[\*\-]\s+(.*)$/);
            // Check for ordered list item
            const olMatch = trimmedLine.match(/^(\d+)\.\s+(.*)$/);
            
            if (ulMatch) {
                if (inOrderedList) {
                    result.push('</ol>');
                    inOrderedList = false;
                }
                if (!inUnorderedList) {
                    result.push('<ul>');
                    inUnorderedList = true;
                }
                result.push(`<li>${ulMatch[1]}</li>`);
            } else if (olMatch) {
                if (inUnorderedList) {
                    result.push('</ul>');
                    inUnorderedList = false;
                }
                if (!inOrderedList) {
                    result.push('<ol>');
                    inOrderedList = true;
                }
                result.push(`<li>${olMatch[2]}</li>`);
            } else {
                // Close any open lists
                if (inUnorderedList) {
                    result.push('</ul>');
                    inUnorderedList = false;
                }
                if (inOrderedList) {
                    result.push('</ol>');
                    inOrderedList = false;
                }
                
                // Handle other elements
                if (!trimmedLine) {
                    result.push('');
                } else if (trimmedLine.startsWith('<h') || trimmedLine.startsWith('<blockquote') || 
                    trimmedLine.startsWith('<pre') || trimmedLine.startsWith('<hr')) {
                    result.push(trimmedLine);
                } else if (trimmedLine.startsWith('</')) {
                    result.push(trimmedLine);
                } else {
                    result.push(`<p>${trimmedLine}</p>`);
                }
            }
        }
        
        // Close any remaining open lists
        if (inUnorderedList) result.push('</ul>');
        if (inOrderedList) result.push('</ol>');
        
        return result.join('\n');
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize language
        currentLanguage = detectLanguage();
        document.getElementById('language-select').value = currentLanguage;
        document.documentElement.lang = currentLanguage;
        applyTranslations();
        
        loadFromLocalStorage();
        loadModelMetadataToForm();
        renderModelProperties();
        renderElementsTable();
        renderRelationshipsTable();
        renderDiagramsTable();
        renderLayersReference();
        populateElementSelects();
        updateTypeFilter();
        updateStereotypeSuggestions();
        updateP≈ô√≠znakySuggestions();
        updateStereotypeFilter();
        updateP≈ô√≠znakyFilters();
        updateRelNameSuggestions();
        updateRelSourceTargetFilters();
        updateDiagramFilters();
        updateModelStats();
        updateGeneratorPlaceholders();
        
        // Load saved column visibility preferences
        loadColumnVisibility('elements-table');
        loadColumnVisibility('relationships-table');
        loadColumnVisibility('diagrams-table');
        
        // Render ADR table
        renderAdrTable();
        
        // Render Notes table
        renderNotesTable();
        
        // Render Tasks table
        renderTasksTable();
        updateTaskAssigneeFilter();
    });
    </script>
    <!-- Clipboard Paste Modal -->
    <div id="clipboard-paste-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 20px; border-radius: 8px; max-width: 90%; width: 500px; max-height: 80vh; display: flex; flex-direction: column;">
            <h3 style="margin: 0 0 15px 0;" data-i18n="pasteManuallyTitle">Vlo≈æit ze schr√°nky</h3>
            <p style="color: #666; font-size: 13px; margin-bottom: 10px;" data-i18n="pasteManuallyDesc">Automatick√© vlo≈æen√≠ nen√≠ na tomto za≈ô√≠zen√≠ k dispozici. Vlo≈æte obsah ruƒçnƒõ (Ctrl+V nebo dlouh√Ω stisk):</p>
            <textarea id="clipboard-paste-textarea" style="flex: 1; min-height: 200px; width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; font-family: monospace; font-size: 12px;" placeholder="Vlo≈æte sem obsah schr√°nky..."></textarea>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                <button type="button" class="btn-secondary" onclick="closeClipboardModal()" data-i18n="cancel">Zru≈°it</button>
                <button type="button" class="btn-primary" onclick="confirmClipboardPaste()" data-i18n="pasteAndLoad">Vlo≈æit a naƒç√≠st</button>
            </div>
        </div>
    </div>

</body>
</html>
