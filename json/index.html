<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Editor</title>
    <style>
        :root {
            --primary: #2c5282;
            --primary-hover: #1a365d;
            --secondary: #4a5568;
            --bg: #f7fafc;
            --border: #cbd5e0;
            --text: #1a202c;
            --text-light: #4a5568;
            --success: #38a169;
            --danger: #e53e3e;
            --warning: #d69e2e;
            --item-bg: #ffffff;
            --item-hover: #edf2f7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: var(--primary);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
        }

        .language-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .language-selector label {
            font-size: 14px;
            color: rgba(255,255,255,0.9);
        }

        .language-selector select {
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
            cursor: pointer;
        }

        .toolbar {
            background: var(--item-hover);
            padding: 15px 30px;
            border-bottom: 2px solid var(--border);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #2f855a;
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #2d3748;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c53030;
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 13px;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .content {
            padding: 30px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state h2 {
            font-size: 20px;
            margin-bottom: 8px;
        }

        .json-tree {
            list-style: none;
            padding: 0;
        }

        .json-item {
            margin: 12px 0;
            padding: 16px;
            background: var(--item-bg);
            border: 2px solid var(--border);
            border-radius: 6px;
            transition: all 0.2s;
        }

        .json-item:hover {
            background: var(--item-hover);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .json-item.collapsed .json-children {
            display: none;
        }

        .json-header {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .json-controls {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .json-content {
            flex: 1;
            min-width: 0;
        }

        .level-indicator {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 6px;
            font-weight: 500;
        }

        .json-content h1,
        .json-content h2,
        .json-content h3,
        .json-content h4,
        .json-content h5,
        .json-content h6 {
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 8px 0;
            color: var(--primary);
        }

        .type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 8px;
        }

        .type-object { background: #bee3f8; color: #2c5282; }
        .type-array { background: #c6f6d5; color: #276749; }
        .type-string { background: #feebc8; color: #7c2d12; }
        .type-number { background: #fed7d7; color: #742a2a; }
        .type-boolean { background: #e9d8fd; color: #553c9a; }
        .type-null { background: #e2e8f0; color: #4a5568; }

        .json-info {
            display: inline-block;
            padding: 4px 10px;
            background: var(--item-hover);
            border-radius: 4px;
            font-size: 13px;
            color: var(--text-light);
            margin-top: 8px;
        }

        .json-value-display {
            margin-top: 8px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 14px;
        }

        .json-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
        }

        .json-children {
            list-style: none;
            margin-top: 16px;
            margin-left: 24px;
            padding-left: 16px;
            border-left: 2px solid var(--border);
        }

        .collapse-indicator {
            font-size: 14px;
            transition: transform 0.2s;
        }

        .json-item.collapsed .collapse-indicator {
            transform: rotate(-90deg);
        }

        .edit-mode {
            background: #fffbeb;
            border-color: var(--warning);
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            font-size: 13px;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
        }

        textarea {
            min-height: 80px;
            resize: vertical;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        }

        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .dialog {
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .dialog h2 {
            margin-bottom: 20px;
            font-size: 20px;
        }

        .dialog-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .hoist-banner {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 12px 20px;
            margin-bottom: 20px;
            border-radius: 6px;
        }

        .hoist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hoist-title {
            font-weight: 600;
            color: #92400e;
        }

        .breadcrumb {
            font-size: 14px;
            color: #92400e;
            padding-top: 8px;
            border-top: 1px solid #fbbf24;
            margin-top: 8px;
        }

        .breadcrumb a {
            color: #92400e;
            text-decoration: underline;
            cursor: pointer;
        }

        .breadcrumb a:hover {
            color: #78350f;
        }

        .stats-panel {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 id="app-title">JSON Editor</h1>
            <div class="language-selector">
                <label for="languageSelect" id="language-label">Jazyk:</label>
                <select id="languageSelect" onchange="app.setLanguage(this.value)">
                    <option value="cs">ƒåe≈°tina</option>
                    <option value="en">English</option>
                </select>
            </div>
        </header>

        <div id="toolbar" class="toolbar"></div>

        <div class="content">
            <div id="emptyState" class="empty-state">
                <div class="empty-state-icon">üìÑ</div>
                <h2>≈Ω√°dn√Ω JSON nen√≠ naƒçten</h2>
                <p>Vytvo≈ôte nov√Ω dokument nebo nahrajte existuj√≠c√≠ JSON soubor</p>
            </div>

            <div id="editorArea" style="display: none;">
                <div id="statsPanel" class="stats-panel" style="display: none;"></div>
                <ul id="jsonTree" class="json-tree"></ul>
            </div>
        </div>
    </div>

    <script>
        // Translations
        const translations = {
            cs: {
                appName: 'JSON Editor',
                newFile: 'Nov√Ω JSON',
                loadFile: 'Nahr√°t soubor',
                pasteJson: 'Vlo≈æit ze schr√°nky',
                saveFile: 'Ulo≈æit soubor',
                copyJson: 'Kop√≠rovat JSON',
                copyUrl: 'Zkop√≠rovat URL',
                addItem: 'P≈ôidat polo≈æku',
                expandAll: 'Rozbalit v≈°e',
                collapseAll: 'Sbalit v≈°e',
                emptyStateTitle: '≈Ω√°dn√Ω JSON nen√≠ naƒçten',
                emptyStateDesc: 'Vytvo≈ôte nov√Ω dokument nebo nahrajte existuj√≠c√≠ JSON soubor',
                edit: 'Editovat',
                save: 'Ulo≈æit',
                cancel: 'Zru≈°it',
                isolate: 'Izolovat',
                addProperty: 'P≈ôidat property',
                addElement: 'P≈ôidat prvek',
                addChild: 'P≈ôidat pod≈ô√≠zenou',
                addSibling: 'P≈ôidat dal≈°√≠',
                delete: 'Smazat',
                duplicate: 'Duplikovat',
                moveUp: 'Nahoru',
                moveDown: 'Dol≈Ø',
                indent: 'Odsadit',
                outdent: 'P≈ôedsadit',
                key: 'Kl√≠ƒç',
                value: 'Hodnota',
                type: 'Typ',
                typeString: 'Text',
                typeNumber: 'ƒå√≠slo',
                typeBoolean: 'Boolean',
                typeNull: 'Null',
                typeObject: 'Objekt',
                typeArray: 'Pole',
                level: '√örove≈à',
                itemOf: 'Polo≈æka',
                of: 'z',
                properties: 'properties',
                items: 'polo≈æek',
                property: 'property',
                item: 'polo≈æka',
                collapsed: 'Sbaleno',
                expanded: 'Rozbaleno',
                contains: 'obsahuje',
                collapseSubitems: 'Sbalit/rozbalit pod≈ô√≠zen√©',
                hoistBanner: 'Zobrazeno:',
                showAll: 'Zobrazit v≈°e',
                confirmDelete: 'Opravdu chcete smazat tuto polo≈æku?',
                confirmNewFile: 'Opravdu chcete vytvo≈ôit nov√Ω soubor? Neulo≈æen√© zmƒõny budou ztraceny.',
                errorLoadFile: 'Nepoda≈ôilo se naƒç√≠st soubor:',
                errorLoadUrl: 'Nepoda≈ôilo se naƒç√≠st JSON z URL:',
                errorInvalidJson: 'Neplatn√Ω JSON form√°t',
                errorCopyEmpty: 'Nen√≠ co zkop√≠rovat.',
                errorSaveEmpty: 'Nen√≠ co ulo≈æit.',
                errorKeyEmpty: 'Kl√≠ƒç nesm√≠ b√Ωt pr√°zdn√Ω.',
                errorKeyExists: 'Kl√≠ƒç ji≈æ existuje.',
                language: 'Jazyk:',
                addNewProperty: 'P≈ôidat novou property',
                addNewElement: 'P≈ôidat nov√Ω prvek',
                pasteDialogTitle: 'Vlo≈æit JSON ze schr√°nky',
                pasteDialogDesc: 'Vlo≈æte JSON text do pole n√≠≈æe a kliknƒõte na Zpracovat.',
                pasteDialogPlaceholder: 'Vlo≈æte JSON text zde...',
                pasteDialogProcess: 'Zpracovat',
                stats: 'Statistiky:',
                totalObjects: 'objekt≈Ø',
                totalArrays: 'pol√≠',
                totalProperties: 'properties',
                totalValues: 'hodnot',
                maxDepth: '√∫rovn√≠ hloubky',
                keyLabel: 'Kl√≠ƒç:',
                valueLabel: 'Hodnota:',
                typeLabel: 'Typ:',
                valuePlaceholder: 'Zadejte hodnotu',
                keyPlaceholder: 'Zadejte kl√≠ƒç',
                editKeyLabel: 'N√°zev kl√≠ƒçe:',
                // Editor links
                openInOpmlEditor: 'Otev≈ô√≠t v OPML editoru',
                openInMarkdownEditor: 'Otev≈ô√≠t v Markdown editoru',
                openInJsonEditor: 'Otev≈ô√≠t v JSON editoru'
            },
            en: {
                appName: 'JSON Editor',
                newFile: 'New JSON',
                loadFile: 'Load File',
                pasteJson: 'Paste from Clipboard',
                saveFile: 'Save File',
                copyJson: 'Copy JSON',
                copyUrl: 'Copy URL',
                addItem: 'Add Item',
                expandAll: 'Expand All',
                collapseAll: 'Collapse All',
                emptyStateTitle: 'No JSON loaded',
                emptyStateDesc: 'Create a new document or load an existing JSON file',
                edit: 'Edit',
                save: 'Save',
                cancel: 'Cancel',
                isolate: 'Isolate',
                addProperty: 'Add property',
                addElement: 'Add element',
                addChild: 'Add child',
                addSibling: 'Add sibling',
                delete: 'Delete',
                duplicate: 'Duplicate',
                moveUp: 'Move up',
                moveDown: 'Move down',
                indent: 'Indent',
                outdent: 'Outdent',
                key: 'Key',
                value: 'Value',
                type: 'Type',
                typeString: 'String',
                typeNumber: 'Number',
                typeBoolean: 'Boolean',
                typeNull: 'Null',
                typeObject: 'Object',
                typeArray: 'Array',
                level: 'Level',
                itemOf: 'Item',
                of: 'of',
                properties: 'properties',
                items: 'items',
                property: 'property',
                item: 'item',
                collapsed: 'Collapsed',
                expanded: 'Expanded',
                contains: 'contains',
                collapseSubitems: 'Collapse/expand subitems',
                hoistBanner: 'Showing:',
                showAll: 'Show All',
                confirmDelete: 'Do you really want to delete this item?',
                confirmNewFile: 'Do you really want to create a new file? Unsaved changes will be lost.',
                errorLoadFile: 'Failed to load file:',
                errorLoadUrl: 'Failed to load JSON from URL:',
                errorInvalidJson: 'Invalid JSON format',
                errorCopyEmpty: 'Nothing to copy.',
                errorSaveEmpty: 'Nothing to save.',
                errorKeyEmpty: 'Key cannot be empty.',
                errorKeyExists: 'Key already exists.',
                language: 'Language:',
                addNewProperty: 'Add new property',
                addNewElement: 'Add new element',
                pasteDialogTitle: 'Paste JSON from Clipboard',
                pasteDialogDesc: 'Paste JSON text into the field below and click Process.',
                pasteDialogPlaceholder: 'Paste JSON text here...',
                pasteDialogProcess: 'Process',
                stats: 'Statistics:',
                totalObjects: 'objects',
                totalArrays: 'arrays',
                totalProperties: 'properties',
                totalValues: 'values',
                maxDepth: 'depth levels',
                keyLabel: 'Key:',
                valueLabel: 'Value:',
                typeLabel: 'Type:',
                valuePlaceholder: 'Enter value',
                keyPlaceholder: 'Enter key',
                editKeyLabel: 'Key name:',
                // Editor links
                openInOpmlEditor: 'Open in OPML Editor',
                openInMarkdownEditor: 'Open in Markdown Editor',
                openInJsonEditor: 'Open in JSON Editor'
            }
        };

        // Universal file save with File System Access API
        async function saveFileWithDialog(content, filename, mimeType, extensions) {
            if ('showSaveFilePicker' in window) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: filename,
                        types: [{
                            description: filename.split('.').pop().toUpperCase() + ' file',
                            accept: { [mimeType]: extensions }
                        }]
                    });
                    const writable = await handle.createWritable();
                    await writable.write(content);
                    await writable.close();
                    return true;
                } catch (e) {
                    if (e.name === 'AbortError') return false;
                }
            }
            const blob = new Blob([content], { type: mimeType });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
            URL.revokeObjectURL(a.href);
            return true;
        }

        // Main application
        const app = {
            data: {
                filename: null,
                root: null
            },
            idCounter: 0,
            editingId: null,
            hoistedId: null,
            currentLanguage: null,
            viewOnly: false, // View-only mode (no editing controls)

            init() {
                const browserLang = navigator.language.split('-')[0];
                const savedLang = localStorage.getItem('json-editor-language');
                let targetLang = savedLang || browserLang;
                
                if (!translations[targetLang]) {
                    targetLang = 'cs';
                }
                
                this.currentLanguage = targetLang;
            },

            setLanguage(lang) {
                if (translations[lang]) {
                    this.currentLanguage = lang;
                    localStorage.setItem('json-editor-language', lang);
                    this.updatePageTitle();
                    this.render();
                }
            },

            t(key) {
                return translations[this.currentLanguage]?.[key] || key;
            },

            updatePageTitle() {
                document.title = this.t('appName');
                
                const appTitle = document.getElementById('app-title');
                if (appTitle) {
                    appTitle.textContent = this.t('appName');
                }
                
                const langLabel = document.getElementById('language-label');
                if (langLabel) {
                    langLabel.textContent = this.t('language');
                }
                
                const langSelect = document.getElementById('languageSelect');
                if (langSelect) {
                    langSelect.value = this.currentLanguage;
                }
            },

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            renderToolbar() {
                const toolbar = document.getElementById('toolbar');
                if (!toolbar) return;
                
                // In view-only mode, show minimal toolbar
                if (this.viewOnly) {
                    toolbar.innerHTML = `
                        <div style="background: #fff3cd; color: #856404; padding: 8px 16px; border-radius: 6px; font-weight: 600;">
                            üëÅÔ∏è Re≈æim pouze pro ƒçten√≠ / Read-only mode
                        </div>
                    `;
                    return;
                }
                
                // Normal mode - show all buttons
                toolbar.innerHTML = `
                    <button class="btn-primary" onclick="app.newFile()">
                        ${this.t('newFile')}
                    </button>
                    
                    <button class="btn-secondary" onclick="document.getElementById('fileInput').click()">
                        ${this.t('loadFile')}
                    </button>
                    <input type="file" id="fileInput" accept=".json" onchange="app.loadFile(event)" style="display: none;">
                    
                    <button class="btn-secondary" onclick="app.showPasteDialog()">
                        ${this.t('pasteJson')}
                    </button>
                    
                    <button class="btn-success" onclick="app.saveFile()" accesskey="s" title="${this.t('saveFile')} (Alt+S)">
                        ${this.t('saveFile')}
                    </button>
                    
                    <button class="btn-success" onclick="app.copyToClipboard()" accesskey="c" title="${this.t('copyJson')} (Alt+C)">
                        ${this.t('copyJson')}
                    </button>
                    
                    <button class="btn-success" onclick="app.copyUrlSource()">
                        ${this.t('copyUrl')}
                    </button>
                    
                    <button class="btn-secondary" onclick="app.addRootItem()">
                        ${this.t('addItem')}
                    </button>
                    
                    <button class="btn-secondary" onclick="app.expandAll()" accesskey="e" title="${this.t('expandAll')} (Alt+E)">
                        ‚äû ${this.t('expandAll')}
                    </button>
                    
                    <button class="btn-secondary" onclick="app.collapseAll()" accesskey="w" title="${this.t('collapseAll')} (Alt+W)">
                        ‚äü ${this.t('collapseAll')}
                    </button>
                `;
            },

            newFile() {
                if (this.data.root !== null) {
                    if (!confirm(this.t('confirmNewFile'))) {
                        return;
                    }
                }
                
                this.data = {
                    filename: 'new.json',
                    root: {}
                };
                this.idCounter = 0;
                this.editingId = null;
                this.hoistedId = null;
                this.addMetadata(this.data.root);
                this.render();
            },

            loadFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        const parsed = JSON.parse(content);
                        
                        this.data.filename = file.name;
                        this.data.root = parsed;
                        this.idCounter = 0;
                        this.editingId = null;
                        this.hoistedId = null;
                        this.addMetadata(this.data.root);
                        this.render();
                    } catch (error) {
                        alert(this.t('errorLoadFile') + ' ' + error.message);
                    }
                };
                reader.readAsText(file);
                
                event.target.value = '';
            },

            showPasteDialog() {
                const overlay = document.createElement('div');
                overlay.className = 'dialog-overlay';
                overlay.innerHTML = `
                    <div class="dialog">
                        <h2>${this.t('pasteDialogTitle')}</h2>
                        <p style="margin-bottom: 15px; color: var(--text-light);">
                            ${this.t('pasteDialogDesc')}
                        </p>
                        <textarea id="pasteTextarea" 
                                  placeholder="${this.t('pasteDialogPlaceholder')}"
                                  autofocus></textarea>
                        <div class="dialog-buttons">
                            <button class="btn-secondary" onclick="this.closest('.dialog-overlay').remove()">
                                ${this.t('cancel')}
                            </button>
                            <button class="btn-success" onclick="app.processPastedJson()">
                                ${this.t('pasteDialogProcess')}
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
            },

            processPastedJson() {
                const textarea = document.getElementById('pasteTextarea');
                const text = textarea.value.trim();
                
                if (!text) {
                    alert(this.t('errorCopyEmpty'));
                    return;
                }
                
                try {
                    const parsed = JSON.parse(text);
                    
                    if (this.data.root !== null) {
                        if (!confirm(this.t('confirmNewFile'))) {
                            return;
                        }
                    }
                    
                    this.data.filename = 'pasted.json';
                    this.data.root = parsed;
                    this.idCounter = 0;
                    this.editingId = null;
                    this.hoistedId = null;
                    this.addMetadata(this.data.root);
                    this.render();
                    
                    document.querySelector('.dialog-overlay').remove();
                } catch (error) {
                    alert(this.t('errorInvalidJson') + ': ' + error.message);
                }
            },

            addMetadata(obj, parent = null, key = null) {
                if (obj === null || typeof obj !== 'object') {
                    return;
                }
                
                obj.__id = ++this.idCounter;
                obj.__parent = parent;
                obj.__key = key;
                obj.__collapsed = false;
                
                if (Array.isArray(obj)) {
                    obj.forEach((item, index) => {
                        this.addMetadata(item, obj, index);
                    });
                } else {
                    Object.keys(obj).forEach(k => {
                        if (!k.startsWith('__')) {
                            this.addMetadata(obj[k], obj, k);
                        }
                    });
                }
            },

            cleanMetadata(obj) {
                if (obj === null || typeof obj !== 'object') {
                    return obj;
                }
                
                if (Array.isArray(obj)) {
                    return obj.map(item => this.cleanMetadata(item));
                }
                
                const result = {};
                Object.keys(obj).forEach(key => {
                    if (!key.startsWith('__')) {
                        result[key] = this.cleanMetadata(obj[key]);
                    }
                });
                return result;
            },

            async saveFile() {
                if (this.data.root === null) {
                    alert(this.t('errorSaveEmpty'));
                    return;
                }
                
                const cleanData = this.cleanMetadata(this.data.root);
                const json = JSON.stringify(cleanData, null, 2);
                const filename = this.data.filename || 'data.json';
                
                await saveFileWithDialog(json, filename, 'application/json', ['.json']);
            },

            async copyToClipboard() {
                if (this.data.root === null) {
                    alert(this.t('errorCopyEmpty'));
                    return;
                }
                
                const cleanData = this.cleanMetadata(this.data.root);
                const json = JSON.stringify(cleanData, null, 2);
                
                try {
                    await navigator.clipboard.writeText(json);
                } catch (err) {
                    const textarea = document.createElement('textarea');
                    textarea.value = json;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                    } catch (e) {
                        // Silent fail
                    }
                    document.body.removeChild(textarea);
                }
            },

            async copyUrlSource() {
                if (this.data.root === null) {
                    alert(this.t('errorCopyEmpty'));
                    return;
                }
                
                try {
                    const cleanData = this.cleanMetadata(this.data.root);
                    const json = JSON.stringify(cleanData);
                    
                    const encoder = new TextEncoder();
                    const bytes = encoder.encode(json);
                    let binaryString = '';
                    for (let i = 0; i < bytes.length; i++) {
                        binaryString += String.fromCharCode(bytes[i]);
                    }
                    let jsonBase64 = btoa(binaryString);
                    jsonBase64 = jsonBase64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
                    
                    const baseUrl = window.location.origin + window.location.pathname;
                    const fullUrl = `${baseUrl}?json=${jsonBase64}`;
                    
                    await navigator.clipboard.writeText(fullUrl);
                } catch (err) {
                    // Fallback
                }
            },

            findById(obj, id) {
                if (obj === null || typeof obj !== 'object') {
                    return null;
                }
                
                if (obj.__id === id) {
                    return obj;
                }
                
                if (Array.isArray(obj)) {
                    for (const item of obj) {
                        const found = this.findById(item, id);
                        if (found) return found;
                    }
                } else {
                    for (const key in obj) {
                        if (!key.startsWith('__')) {
                            const found = this.findById(obj[key], id);
                            if (found) return found;
                        }
                    }
                }
                
                return null;
            },

            getPosition(obj, targetId, context = null) {
                // Try to get position from parent's children
                if (obj && obj.__parent) {
                    const parent = obj.__parent;
                    if (Array.isArray(parent)) {
                        for (let i = 0; i < parent.length; i++) {
                            if (parent[i] && parent[i].__id === targetId) {
                                return { index: i + 1, total: parent.length };
                            }
                        }
                    } else if (typeof parent === 'object') {
                        const keys = Object.keys(parent).filter(k => !k.startsWith('__'));
                        for (let i = 0; i < keys.length; i++) {
                            if (parent[keys[i]] && parent[keys[i]].__id === targetId) {
                                return { index: i + 1, total: keys.length };
                            }
                        }
                    }
                }
                return null;
            },

            toggleCollapse(id) {
                const item = this.findById(this.data.root, id);
                if (item && typeof item === 'object') {
                    item.__collapsed = !item.__collapsed;
                    this.render();
                }
            },

            collapseAll() {
                const setCollapsed = (obj, value) => {
                    if (obj && typeof obj === 'object') {
                        obj.__collapsed = value;
                        if (Array.isArray(obj)) {
                            obj.forEach(item => setCollapsed(item, value));
                        } else {
                            Object.keys(obj).filter(k => !k.startsWith('__')).forEach(key => {
                                setCollapsed(obj[key], value);
                            });
                        }
                    }
                };
                setCollapsed(this.data.root, true);
                this.render();
            },

            expandAll() {
                const setCollapsed = (obj, value) => {
                    if (obj && typeof obj === 'object') {
                        obj.__collapsed = value;
                        if (Array.isArray(obj)) {
                            obj.forEach(item => setCollapsed(item, value));
                        } else {
                            Object.keys(obj).filter(k => !k.startsWith('__')).forEach(key => {
                                setCollapsed(obj[key], value);
                            });
                        }
                    }
                };
                setCollapsed(this.data.root, false);
                this.render();
            },

            editItem(id) {
                this.editingId = id;
                this.render();
            },

            cancelEdit() {
                this.editingId = null;
                this.render();
            },

            saveEdit(id) {
                const item = this.findById(this.data.root, id);
                if (!item || !item.__parent) return;
                
                const parent = item.__parent;
                const key = item.__key;
                const type = document.getElementById(`editType-${id}`).value;
                
                let newValue;
                if (type === 'null') {
                    newValue = null;
                } else if (type === 'boolean') {
                    newValue = document.getElementById(`editValue-${id}`).value === 'true';
                } else if (type === 'number') {
                    newValue = parseFloat(document.getElementById(`editValue-${id}`).value) || 0;
                } else {
                    newValue = document.getElementById(`editValue-${id}`).value;
                }
                
                if (Array.isArray(parent)) {
                    parent[key] = newValue;
                } else {
                    parent[key] = newValue;
                }
                
                this.editingId = null;
                this.addMetadata(this.data.root);
                this.render();
            },

            saveComplexEdit(id) {
                const item = this.findById(this.data.root, id);
                if (!item || !item.__parent) return;
                
                const parent = item.__parent;
                const oldKey = item.__key;
                
                // Check if we can edit the key (only for objects, not arrays)
                if (!Array.isArray(parent)) {
                    const newKeyInput = document.getElementById(`editKey-${id}`);
                    if (newKeyInput) {
                        const newKey = newKeyInput.value.trim();
                        
                        if (!newKey) {
                            alert(this.t('errorKeyEmpty'));
                            return;
                        }
                        
                        if (newKey !== oldKey && parent.hasOwnProperty(newKey)) {
                            alert(this.t('errorKeyExists'));
                            return;
                        }
                        
                        // Rename the key if changed
                        if (newKey !== oldKey) {
                            // Get all keys in order
                            const keys = Object.keys(parent).filter(k => !k.startsWith('__'));
                            const newParent = {};
                            
                            // Rebuild object with new key name
                            keys.forEach(k => {
                                if (k === oldKey) {
                                    newParent[newKey] = parent[k];
                                } else {
                                    newParent[k] = parent[k];
                                }
                            });
                            
                            // Clear old keys and copy new ones
                            keys.forEach(k => delete parent[k]);
                            Object.keys(newParent).forEach(k => parent[k] = newParent[k]);
                        }
                    }
                }
                
                this.editingId = null;
                this.addMetadata(this.data.root);
                this.render();
            },

            updateEditValueInput(id) {
                const type = document.getElementById(`editType-${id}`).value;
                const valueGroup = document.getElementById(`editValueGroup-${id}`);
                
                if (type === 'null') {
                    valueGroup.style.display = 'none';
                } else if (type === 'boolean') {
                    valueGroup.innerHTML = `
                        <label>${this.t('valueLabel')}</label>
                        <select id="editValue-${id}">
                            <option value="true">true</option>
                            <option value="false">false</option>
                        </select>
                    `;
                    valueGroup.style.display = 'block';
                } else {
                    valueGroup.innerHTML = `
                        <label>${this.t('valueLabel')}</label>
                        <input type="${type === 'number' ? 'number' : 'text'}" 
                               id="editValue-${id}" 
                               placeholder="${this.t('valuePlaceholder')}">
                    `;
                    valueGroup.style.display = 'block';
                }
            },

            addRootItem() {
                if (this.data.root === null) {
                    this.newFile();
                    return;
                }
                
                if (Array.isArray(this.data.root)) {
                    this.showAddDialog(this.data.root, null, true);
                } else {
                    this.showAddDialog(this.data.root, null, false);
                }
            },

            showAddDialog(parent, afterKey, isArray) {
                const overlay = document.createElement('div');
                overlay.className = 'dialog-overlay';
                overlay.innerHTML = `
                    <div class="dialog">
                        <h2>${isArray ? this.t('addNewElement') : this.t('addNewProperty')}</h2>
                        
                        ${!isArray ? `
                            <div class="form-group">
                                <label>${this.t('keyLabel')}</label>
                                <input type="text" id="newKey" placeholder="${this.t('keyPlaceholder')}">
                            </div>
                        ` : ''}
                        
                        <div class="form-group">
                            <label>${this.t('typeLabel')}</label>
                            <select id="newType" onchange="app.updateValueInput()">
                                <option value="string">${this.t('typeString')}</option>
                                <option value="number">${this.t('typeNumber')}</option>
                                <option value="boolean">${this.t('typeBoolean')}</option>
                                <option value="null">${this.t('typeNull')}</option>
                                <option value="object">${this.t('typeObject')}</option>
                                <option value="array">${this.t('typeArray')}</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="valueGroup">
                            <label>${this.t('valueLabel')}</label>
                            <input type="text" id="newValue" placeholder="${this.t('valuePlaceholder')}">
                        </div>
                        
                        <div class="dialog-buttons">
                            <button class="btn-secondary" onclick="this.closest('.dialog-overlay').remove()">
                                ${this.t('cancel')}
                            </button>
                            <button class="btn-success" onclick="app.processAddDialog(${parent.__id}, ${afterKey !== null ? `${afterKey}` : 'null'}, ${isArray})">
                                ${this.t('addItem')}
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                
                if (!isArray) {
                    setTimeout(() => document.getElementById('newKey')?.focus(), 100);
                } else {
                    setTimeout(() => document.getElementById('newValue')?.focus(), 100);
                }
            },

            updateValueInput() {
                const type = document.getElementById('newType').value;
                const valueGroup = document.getElementById('valueGroup');
                
                if (type === 'object' || type === 'array' || type === 'null') {
                    valueGroup.style.display = 'none';
                } else if (type === 'boolean') {
                    valueGroup.innerHTML = `
                        <label>${this.t('valueLabel')}</label>
                        <select id="newValue">
                            <option value="true">true</option>
                            <option value="false">false</option>
                        </select>
                    `;
                    valueGroup.style.display = 'block';
                } else {
                    valueGroup.innerHTML = `
                        <label>${this.t('valueLabel')}</label>
                        <input type="${type === 'number' ? 'number' : 'text'}" id="newValue" placeholder="${this.t('valuePlaceholder')}">
                    `;
                    valueGroup.style.display = 'block';
                }
            },

            processAddDialog(parentId, afterKey, isArray) {
                const parent = this.findById(this.data.root, parentId);
                if (!parent) return;
                
                const type = document.getElementById('newType').value;
                
                let key = null;
                if (!isArray) {
                    key = document.getElementById('newKey')?.value.trim();
                    if (!key) {
                        alert(this.t('errorKeyEmpty'));
                        return;
                    }
                    if (parent.hasOwnProperty(key)) {
                        alert(this.t('errorKeyExists'));
                        return;
                    }
                }
                
                let value;
                if (type === 'object') {
                    value = {};
                } else if (type === 'array') {
                    value = [];
                } else if (type === 'null') {
                    value = null;
                } else if (type === 'boolean') {
                    value = document.getElementById('newValue').value === 'true';
                } else if (type === 'number') {
                    value = parseFloat(document.getElementById('newValue').value) || 0;
                } else {
                    value = document.getElementById('newValue').value;
                }
                
                if (isArray) {
                    if (afterKey !== null) {
                        parent.splice(afterKey + 1, 0, value);
                    } else {
                        parent.push(value);
                    }
                } else {
                    parent[key] = value;
                }
                
                this.addMetadata(this.data.root);
                this.render();
                document.querySelector('.dialog-overlay').remove();
            },

            deleteItem(id) {
                if (!confirm(this.t('confirmDelete'))) {
                    return;
                }
                
                const item = this.findById(this.data.root, id);
                if (!item || !item.__parent) return;
                
                const parent = item.__parent;
                const key = item.__key;
                
                if (Array.isArray(parent)) {
                    parent.splice(key, 1);
                } else {
                    delete parent[key];
                }
                
                this.addMetadata(this.data.root);
                this.render();
            },

            hoistItem(id) {
                this.hoistedId = id;
                this.render();
            },

            unhoistAll() {
                this.hoistedId = null;
                this.render();
            },

            getBreadcrumbPath(id) {
                const path = [];
                let current = this.findById(this.data.root, id);
                
                while (current && current.__parent) {
                    const isArray = Array.isArray(current.__parent);
                    const displayKey = isArray ? `[${current.__key}]` : current.__key;
                    path.unshift({
                        id: current.__id,
                        key: displayKey
                    });
                    current = current.__parent;
                }
                
                return path;
            },

            countChildren(obj) {
                if (!obj || typeof obj !== 'object') return 0;
                
                if (Array.isArray(obj)) {
                    return obj.length;
                } else {
                    return Object.keys(obj).filter(k => !k.startsWith('__')).length;
                }
            },

            calculateStats(obj) {
                let objects = 0;
                let arrays = 0;
                let properties = 0;
                let values = 0;
                let maxDepth = 0;
                
                const traverse = (item, depth = 0) => {
                    if (item === null || typeof item !== 'object') {
                        values++;
                        return;
                    }
                    
                    maxDepth = Math.max(maxDepth, depth);
                    
                    if (Array.isArray(item)) {
                        arrays++;
                        item.forEach(child => traverse(child, depth + 1));
                    } else {
                        objects++;
                        Object.keys(item).forEach(key => {
                            if (!key.startsWith('__')) {
                                properties++;
                                traverse(item[key], depth + 1);
                            }
                        });
                    }
                };
                
                traverse(obj);
                
                return { objects, arrays, properties, values, maxDepth };
            },

            renderStats() {
                if (this.data.root === null) return '';
                
                const stats = this.calculateStats(this.data.root);
                
                return `
                    ${this.t('stats')}
                    ${stats.objects} ${this.t('totalObjects')},
                    ${stats.arrays} ${this.t('totalArrays')},
                    ${stats.properties} ${this.t('totalProperties')},
                    ${stats.values} ${this.t('totalValues')},
                    ${stats.maxDepth} ${this.t('maxDepth')}
                `;
            },

            getTypeName(value) {
                if (value === null) return this.t('typeNull');
                if (Array.isArray(value)) return this.t('typeArray');
                const type = typeof value;
                if (type === 'object') return this.t('typeObject');
                if (type === 'string') return this.t('typeString');
                if (type === 'number') return this.t('typeNumber');
                if (type === 'boolean') return this.t('typeBoolean');
                return type;
            },

            getTypeClass(value) {
                if (value === null) return 'type-null';
                if (Array.isArray(value)) return 'type-array';
                const type = typeof value;
                if (type === 'object') return 'type-object';
                if (type === 'string') return 'type-string';
                if (type === 'number') return 'type-number';
                if (type === 'boolean') return 'type-boolean';
                return '';
            },

            renderValue(value, key, level = 1) {
                const isEditing = !this.viewOnly && this.editingId === value?.__id; // Never edit in view-only mode
                
                if (value === null || typeof value !== 'object') {
                    // Primitive value
                    const typeClass = this.getTypeClass(value);
                    const typeName = this.getTypeName(value);
                    const valueId = value?.__id;
                    
                    const position = valueId && value.__parent ? this.getPosition(value, valueId) : null;
                    const positionText = position ? `${this.t('itemOf')} ${position.index} ${this.t('of')} ${position.total}` : '';
                    
                    // Create heading based on level
                    const headingTag = `h${Math.min(level, 6)}`;
                    const displayKey = key !== null ? this.escapeHtml(String(key)) : this.t('value');
                    
                    if (isEditing) {
                        // Edit mode for primitive
                        const displayValue = value === null ? '' : 
                                           typeof value === 'string' ? value :
                                           String(value);
                        
                        return `
                            <li class="json-item edit-mode">
                                <div class="json-header">
                                    <div class="json-controls">
                                        <div style="width: 32px;"></div>
                                    </div>
                                    <div class="json-content">
                                        <div class="level-indicator">${this.t('level')} ${level}${positionText ? ` ¬∑ ${positionText}` : ''}</div>
                                        <${headingTag}>${displayKey}</${headingTag}>
                                        <div class="form-group">
                                            <label>${this.t('typeLabel')}</label>
                                            <select id="editType-${valueId}" onchange="app.updateEditValueInput(${valueId})">
                                                <option value="string" ${typeof value === 'string' ? 'selected' : ''}>${this.t('typeString')}</option>
                                                <option value="number" ${typeof value === 'number' ? 'selected' : ''}>${this.t('typeNumber')}</option>
                                                <option value="boolean" ${typeof value === 'boolean' ? 'selected' : ''}>${this.t('typeBoolean')}</option>
                                                <option value="null" ${value === null ? 'selected' : ''}>${this.t('typeNull')}</option>
                                            </select>
                                        </div>
                                        <div class="form-group" id="editValueGroup-${valueId}" ${value === null ? 'style="display:none;"' : ''}>
                                            <label>${this.t('valueLabel')}</label>
                                            ${typeof value === 'boolean' ? `
                                                <select id="editValue-${valueId}">
                                                    <option value="true" ${value === true ? 'selected' : ''}>true</option>
                                                    <option value="false" ${value === false ? 'selected' : ''}>false</option>
                                                </select>
                                            ` : value !== null ? `
                                                <input type="${typeof value === 'number' ? 'number' : 'text'}" 
                                                       id="editValue-${valueId}" 
                                                       value="${this.escapeHtml(displayValue)}"
                                                       placeholder="${this.t('valuePlaceholder')}">
                                            ` : ''}
                                        </div>
                                        <div class="json-actions">
                                            <button class="btn-small btn-success" onclick="app.saveEdit(${valueId})">
                                                ${this.t('save')}
                                            </button>
                                            <button class="btn-small btn-secondary" onclick="app.cancelEdit()">
                                                ${this.t('cancel')}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        `;
                    }
                    
                    // View mode for primitive
                    const displayValue = value === null ? 'null' : 
                                       typeof value === 'string' ? `"${this.escapeHtml(value)}"` :
                                       String(value);
                    
                    return `
                        <li class="json-item">
                            <div class="json-header">
                                <div class="json-controls">
                                    <div style="width: 32px;"></div>
                                </div>
                                <div class="json-content">
                                    <div class="level-indicator">${this.t('level')} ${level}${positionText ? ` ¬∑ ${positionText}` : ''}</div>
                                    <${headingTag}>${displayKey}</${headingTag}>
                                    <div class="json-value-display">
                                        <span class="type-badge ${typeClass}">${typeName}</span>
                                        ${displayValue}
                                    </div>
                                    ${!this.viewOnly ? `
                                    <div class="json-actions">
                                        <button class="btn-small btn-primary" onclick="app.editItem(${valueId})">
                                            ${this.t('edit')}
                                        </button>
                                        <button class="btn-small btn-danger" onclick="app.deleteItem(${valueId})">
                                            ${this.t('delete')}
                                        </button>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </li>
                    `;
                }
                
                // Complex type (object or array)
                const isArray = Array.isArray(value);
                const typeClass = this.getTypeClass(value);
                const typeName = this.getTypeName(value);
                const childCount = this.countChildren(value);
                const collapsed = value.__collapsed || false;
                
                const position = value.__parent ? this.getPosition(value, value.__id) : null;
                const positionText = position ? `${this.t('itemOf')} ${position.index} ${this.t('of')} ${position.total}` : '';
                
                const countLabel = isArray ? 
                    (childCount === 1 ? this.t('item') : this.t('items')) :
                    (childCount === 1 ? this.t('property') : this.t('properties'));
                
                // Create heading based on level
                const headingTag = `h${Math.min(level, 6)}`;
                const displayKey = key !== null ? this.escapeHtml(String(key)) : (isArray ? this.t('typeArray') : this.t('typeObject'));
                
                if (isEditing) {
                    // Edit mode for complex type (change key name for objects/arrays in parent)
                    const currentKey = key !== null ? String(key) : '';
                    const canEditKey = key !== null && value.__parent && !Array.isArray(value.__parent);
                    
                    return `
                        <li class="json-item edit-mode ${collapsed ? 'collapsed' : ''}">
                            <div class="json-header">
                                <div class="json-controls">
                                    ${childCount > 0 ? `
                                        <button class="btn-icon btn-secondary" 
                                                onclick="app.toggleCollapse(${value.__id})"
                                                aria-label="${collapsed ? this.t('expanded') : this.t('collapsed')} ${this.t('collapseSubitems')}">
                                            <span class="collapse-indicator">‚ñº</span>
                                        </button>
                                    ` : '<div style="width: 32px;"></div>'}
                                </div>
                                <div class="json-content">
                                    <div class="level-indicator">${this.t('level')} ${level}${positionText ? ` ¬∑ ${positionText}` : ''}</div>
                                    <${headingTag}>${displayKey}</${headingTag}>
                                    ${canEditKey ? `
                                        <div class="form-group">
                                            <label>${this.t('keyLabel')}</label>
                                            <input type="text" 
                                                   id="editKey-${value.__id}" 
                                                   value="${this.escapeHtml(currentKey)}"
                                                   placeholder="${this.t('keyPlaceholder')}">
                                        </div>
                                    ` : ''}
                                    <div>
                                        <span class="type-badge ${typeClass}">${typeName}</span>
                                        ${childCount > 0 ? `
                                            <span class="json-info">
                                                ${collapsed ? this.t('collapsed') : this.t('expanded')}, 
                                                ${this.t('contains')} ${childCount} ${countLabel}
                                            </span>
                                        ` : ''}
                                    </div>
                                    <div class="json-actions">
                                        <button class="btn-small btn-success" onclick="app.saveComplexEdit(${value.__id})">
                                            ${this.t('save')}
                                        </button>
                                        <button class="btn-small btn-secondary" onclick="app.cancelEdit()">
                                            ${this.t('cancel')}
                                        </button>
                                    </div>
                                </div>
                            </div>
                            ${childCount > 0 && !collapsed ? `
                                <ul class="json-children">
                                    ${isArray ? 
                                        value.map((item, index) => this.renderValue(item, `[${index}]`, level + 1)).join('') :
                                        Object.keys(value).filter(k => !k.startsWith('__')).map(k => this.renderValue(value[k], k, level + 1)).join('')
                                    }
                                </ul>
                            ` : ''}
                        </li>
                    `;
                }
                
                // View mode for complex type
                let childrenHtml = '';
                if (!collapsed && childCount > 0) {
                    if (isArray) {
                        childrenHtml = value.map((item, index) => 
                            this.renderValue(item, `[${index}]`, level + 1)
                        ).join('');
                    } else {
                        const keys = Object.keys(value).filter(k => !k.startsWith('__'));
                        childrenHtml = keys.map(k => 
                            this.renderValue(value[k], k, level + 1)
                        ).join('');
                    }
                }
                
                return `
                    <li class="json-item ${collapsed ? 'collapsed' : ''}">
                        <div class="json-header">
                            <div class="json-controls">
                                ${childCount > 0 ? `
                                    <button class="btn-icon btn-secondary" 
                                            onclick="app.toggleCollapse(${value.__id})"
                                            aria-label="${collapsed ? this.t('expanded') : this.t('collapsed')} ${this.t('collapseSubitems')}">
                                        <span class="collapse-indicator">‚ñº</span>
                                    </button>
                                ` : '<div style="width: 32px;"></div>'}
                            </div>
                            <div class="json-content">
                                <div class="level-indicator">${this.t('level')} ${level}${positionText ? ` ¬∑ ${positionText}` : ''}</div>
                                <${headingTag}>${displayKey}</${headingTag}>
                                <div>
                                    <span class="type-badge ${typeClass}">${typeName}</span>
                                    ${childCount > 0 ? `
                                        <span class="json-info">
                                            ${collapsed ? this.t('collapsed') : this.t('expanded')}, 
                                            ${this.t('contains')} ${childCount} ${countLabel}
                                        </span>
                                    ` : ''}
                                </div>
                                ${!this.viewOnly ? `
                                <div class="json-actions">
                                    ${key !== null && value.__parent && !Array.isArray(value.__parent) ? `
                                        <button class="btn-small btn-primary" onclick="app.editItem(${value.__id})">
                                            ${this.t('edit')}
                                        </button>
                                    ` : ''}
                                    <button class="btn-small btn-secondary" onclick="app.showAddDialog(app.findById(app.data.root, ${value.__id}), null, ${isArray})">
                                        ${isArray ? this.t('addElement') : this.t('addProperty')}
                                    </button>
                                    ${value.__id !== this.data.root.__id ? `
                                        <button class="btn-small btn-secondary" onclick="app.hoistItem(${value.__id})">
                                            ${this.t('isolate')}
                                        </button>
                                        <button class="btn-small btn-danger" onclick="app.deleteItem(${value.__id})">
                                            ${this.t('delete')}
                                        </button>
                                    ` : ''}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        ${childCount > 0 ? `
                            <ul class="json-children">
                                ${childrenHtml}
                            </ul>
                        ` : ''}
                    </li>
                `;
            },

            render() {
                this.renderToolbar();
                
                const emptyState = document.getElementById('emptyState');
                const editorArea = document.getElementById('editorArea');
                const statsPanel = document.getElementById('statsPanel');
                const jsonTree = document.getElementById('jsonTree');
                
                if (this.data.root === null) {
                    emptyState.innerHTML = `
                        <div class="empty-state-icon">üìÑ</div>
                        <h2>${this.t('emptyStateTitle')}</h2>
                        <p>${this.t('emptyStateDesc')}</p>
                    `;
                    emptyState.style.display = 'block';
                    editorArea.style.display = 'none';
                } else {
                    emptyState.style.display = 'none';
                    editorArea.style.display = 'block';
                    
                    // Show stats
                    statsPanel.innerHTML = this.renderStats();
                    statsPanel.style.display = 'block';
                    
                    // Determine what to render
                    let itemToRender = this.data.root;
                    
                    // Remove existing hoist banner
                    const existingBanner = jsonTree.parentElement.querySelector('.hoist-banner');
                    if (existingBanner) {
                        existingBanner.remove();
                    }
                    
                    if (this.hoistedId) {
                        itemToRender = this.findById(this.data.root, this.hoistedId);
                        
                        if (itemToRender) {
                            // Show hoist banner with breadcrumb
                            const breadcrumbs = this.getBreadcrumbPath(this.hoistedId);
                            let breadcrumbHtml = '';
                            
                            if (breadcrumbs.length > 0) {
                                breadcrumbHtml = breadcrumbs.map((crumb, index) => {
                                    const isLast = index === breadcrumbs.length - 1;
                                    if (isLast) {
                                        return `<strong>${this.escapeHtml(crumb.key)}</strong>`;
                                    } else {
                                        return `<a href="#" onclick="event.preventDefault(); app.hoistItem(${crumb.id});">${this.escapeHtml(crumb.key)}</a>`;
                                    }
                                }).join(' ‚Ä∫ ');
                            }
                            
                            const bannerDiv = document.createElement('div');
                            bannerDiv.className = 'hoist-banner';
                            bannerDiv.innerHTML = `
                                <div class="hoist-header">
                                    <span class="hoist-title">
                                        ${this.t('hoistBanner')} "${this.escapeHtml(breadcrumbs[breadcrumbs.length - 1]?.key || '')}"
                                    </span>
                                    <button class="btn-small btn-secondary" onclick="app.unhoistAll()">
                                        ${this.t('showAll')}
                                    </button>
                                </div>
                                ${breadcrumbHtml ? `
                                    <div class="breadcrumb">
                                        üìç ${breadcrumbHtml}
                                    </div>
                                ` : ''}
                            `;
                            
                            jsonTree.parentElement.insertBefore(bannerDiv, jsonTree);
                        } else {
                            // Invalid hoist, reset
                            this.hoistedId = null;
                            itemToRender = this.data.root;
                        }
                    }
                    
                    // Render tree
                    jsonTree.innerHTML = this.renderValue(itemToRender, null, 1);
                }
                
                this.updatePageTitle();
            }
        };

        // Initialize
        app.init();
        app.render();
        app.updatePageTitle();

        // Check for JSON in URL on page load
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const jsonBase64 = urlParams.get('json');
            const viewOnlyParam = urlParams.get('v');
            
            // Enable view-only mode if &v parameter exists
            if (viewOnlyParam !== null) {
                app.viewOnly = true;
            }
            
            if (jsonBase64) {
                try {
                    let standardBase64 = jsonBase64.replace(/-/g, '+').replace(/_/g, '/');
                    while (standardBase64.length % 4) {
                        standardBase64 += '=';
                    }
                    
                    const binaryString = atob(standardBase64);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    const json = new TextDecoder('utf-8').decode(bytes);
                    const parsed = JSON.parse(json);
                    
                    app.data.filename = 'from-url.json';
                    app.data.root = parsed;
                    app.idCounter = 0;
                    app.editingId = null;
                    app.hoistedId = null;
                    app.addMetadata(app.data.root);
                    app.render();
                } catch (error) {
                    alert(app.t('errorLoadUrl') + ' ' + error.message);
                }
            }
        })();
    </script>
</body>
</html>
