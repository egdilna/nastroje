<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#1e1e2e">
<link rel="manifest" href="manifest.json">
<title>NoteBlock</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/15.0.7/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
:root{--bg:#1b1b2f;--bg2:#162447;--bg3:#1f4068;--surface:#1b1b3a;--surface2:#252550;--border:#334466;--text:#e0e0f0;--text2:#8899bb;--accent:#4ea8de;--accent2:#56d6e6;--danger:#e05555;--success:#55c57a;--warn:#e0a030;--cm-add-bg:#1a4a1a;--cm-add-fg:#80e080;--cm-del-bg:#5a1a1a;--cm-del-fg:#f09090;--cm-hi-bg:#4a4a00;--cm-hi-fg:#f0e060;--cm-cmt-bg:#1a2a5a;--cm-cmt-fg:#90b0f0;--tag-bg:#2a2a5e}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',Tahoma,sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;height:100vh;overflow:hidden}
a{color:var(--accent);text-decoration:none}
a:hover,a:focus{text-decoration:underline;color:var(--accent2)}
a:focus,button:focus,input:focus,textarea:focus,select:focus{outline:2px solid var(--accent);outline-offset:1px}
button{font-family:inherit;font-size:.88rem;padding:5px 12px;border:1px solid var(--border);background:var(--surface2);color:var(--text);border-radius:4px;cursor:pointer;white-space:nowrap}
button:hover{background:var(--bg3);border-color:var(--accent)}
button.primary{background:var(--bg3);border-color:var(--accent);color:var(--accent)}
button.danger{border-color:var(--danger);color:var(--danger)}
button.danger:hover{background:rgba(224,85,85,.15)}
button.sm{padding:3px 8px;font-size:.82rem}
input,textarea,select{font-family:inherit;font-size:.92rem;padding:6px 10px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;width:100%}
textarea{resize:vertical;min-height:180px;line-height:1.5;tab-size:4;font-family:'Consolas','Courier New',monospace;font-size:.9rem}

header{display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap}
header h1{font-size:1rem;font-weight:600}
.spacer{flex:1}
.ak{font-size:.68rem;color:var(--text2);vertical-align:super;margin-left:1px}

#layout{display:flex;flex:1;overflow:hidden}
nav#sidebar{width:25%;min-width:160px;max-width:350px;display:flex;flex-direction:column;border-right:1px solid var(--border);background:var(--bg2);overflow:hidden;flex-shrink:0}
nav#sidebar.hidden{display:none}
#nav-tools{display:flex;gap:4px;padding:6px;border-bottom:1px solid var(--border);flex-wrap:wrap;flex-shrink:0}
#nav-scroll{flex:1;overflow-y:auto;padding:8px}

#nav-scroll ul{list-style:none;padding-left:0;margin:0}
#nav-scroll ul ul{padding-left:16px}
#nav-scroll li{margin:1px 0}
.nav-row{display:flex;align-items:center;gap:2px}
.nav-toggle{background:none;border:none;color:var(--text2);font-size:.7rem;width:18px;height:22px;padding:0;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;border-radius:3px}
.nav-toggle:hover{color:var(--accent);background:rgba(78,168,222,.1)}
.nav-toggle-placeholder{width:18px;flex-shrink:0}
.nav-link{display:block;padding:3px 6px;border-radius:3px;font-size:.86rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;min-width:0}
.nav-link:hover{background:rgba(78,168,222,.1);text-decoration:none}
.nav-link.active{background:rgba(78,168,222,.18);font-weight:600}
.nav-badge{font-size:.72rem;color:var(--text2);margin-left:3px}
.nav-task{font-size:.72rem;color:var(--warn);margin-left:2px}

#tags-area{border-top:1px solid var(--border);padding:8px;flex-shrink:0;max-height:130px;overflow-y:auto}
#tags-area h2{font-size:.8rem;color:var(--text2);margin-bottom:4px}
#tags-chips{display:flex;flex-wrap:wrap;gap:4px}
.tag-chip{background:var(--tag-bg);padding:2px 8px;border-radius:10px;font-size:.76rem;cursor:pointer;color:var(--accent);border:none}
.tag-chip:hover{background:var(--bg3)}
.tag-chip.active{background:var(--accent);color:#000}

main#content{flex:1;display:flex;flex-direction:column;overflow:hidden}
#tabbar{display:flex;gap:0;padding:0 6px;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0;overflow-x:auto;min-height:0;align-items:stretch}
#tabbar:empty{display:none}
.tab-item{display:flex;align-items:center;gap:4px;padding:5px 12px;font-size:.82rem;border:1px solid transparent;border-bottom:none;border-radius:5px 5px 0 0;cursor:pointer;background:none;color:var(--text2);white-space:nowrap;max-width:200px;position:relative;margin-bottom:-1px}
.tab-item:hover{background:rgba(78,168,222,.08);color:var(--text)}
.tab-item[aria-selected="true"]{background:var(--bg);border-color:var(--border);color:var(--accent);font-weight:600;z-index:1}
.tab-label{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tab-ctrl{display:flex;align-items:center;gap:3px;margin-left:auto;padding:0 4px;flex-shrink:0}
.tab-ctrl button{padding:2px 8px;font-size:.78rem}
#toolbar{display:flex;gap:4px;padding:6px 10px;border-bottom:1px solid var(--border);flex-wrap:wrap;align-items:center;flex-shrink:0;background:var(--bg2);min-height:38px}
#toolbar .sep{width:1px;height:22px;background:var(--border);margin:0 3px}
#view{flex:1;overflow-y:auto;padding:20px 28px}
#crumb{font-size:.82rem;color:var(--text2);margin-bottom:10px}
#crumb a{color:var(--text2)}
#crumb a:hover{color:var(--accent)}

.tbl{width:100%;border-collapse:collapse;font-size:.88rem}
.tbl th{text-align:left;padding:7px 10px;border-bottom:2px solid var(--border);color:var(--text2);font-weight:600;font-size:.8rem}
.tbl td{padding:5px 10px;border-bottom:1px solid var(--border)}
.tbl tr:hover td{background:rgba(78,168,222,.06)}

.md{line-height:1.7;max-width:880px}
.md h1{font-size:1.6rem;margin:1.2em 0 .5em;border-bottom:1px solid var(--border);padding-bottom:6px}
.md h2{font-size:1.35rem;margin:1em 0 .4em}
.md h3{font-size:1.15rem;margin:.9em 0 .35em}
.md h4{font-size:1.05rem;margin:.8em 0 .3em}
.md h5,.md h6{font-size:.95rem;margin:.7em 0 .25em}
.md p{margin:.6em 0}
.md ul,.md ol{margin:.5em 0;padding-left:1.5em}
.md ol ol{list-style-type:lower-alpha}
.md li{margin:.2em 0}
.md blockquote{border-left:3px solid var(--accent);padding:4px 12px;margin:.5em 0;color:var(--text2);background:rgba(78,168,222,.06)}
.md code{background:var(--surface2);padding:1px 5px;border-radius:3px;font-family:'Consolas',monospace;font-size:.88em}
.md pre{background:var(--surface);padding:12px;border-radius:6px;overflow-x:auto;margin:.6em 0;border:1px solid var(--border)}
.md pre code{background:none;padding:0}
.md table{border-collapse:collapse;margin:.6em 0;width:auto;min-width:40%}
.md th,.md td{border:1px solid var(--border);padding:5px 10px}
.md th{background:var(--surface2)}
.md hr{border:none;border-top:1px solid var(--border);margin:1em 0}
.md img{max-width:100%}

.md ins{background:var(--cm-add-bg);color:var(--cm-add-fg);padding:1px 3px;border-radius:2px;text-decoration:underline}
.md del{background:var(--cm-del-bg);color:var(--cm-del-fg);padding:1px 3px;border-radius:2px}
.md mark{background:var(--cm-hi-bg);color:var(--cm-hi-fg);padding:1px 3px;border-radius:2px}
.cm-cmt{background:var(--cm-cmt-bg);color:var(--cm-cmt-fg);padding:1px 4px;border-radius:2px;font-style:italic}
.wlink{color:var(--accent2);border-bottom:1px dashed var(--accent2);cursor:pointer}
.wlink:hover{color:#fff}
.wlink-broken{color:var(--danger);border-bottom:1px dashed var(--danger)}
.task-cb{cursor:pointer;width:16px;height:16px;vertical-align:middle;margin-right:5px;accent-color:var(--accent)}
.task-done{text-decoration:line-through;color:var(--text2)}

.sec-edit-btn{font-size:.7rem;padding:1px 6px;margin-left:6px;background:var(--surface2);border:1px solid var(--border);color:var(--text2);border-radius:3px;cursor:pointer;vertical-align:middle}
.sec-edit-btn:hover{border-color:var(--accent);color:var(--accent)}

.te-wrap{border:1px solid var(--border);border-radius:6px;padding:12px;margin:8px 0}
.te-hdr{display:flex;gap:6px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
.te-tbl{width:100%;border-collapse:collapse;font-size:.88rem}
.te-tbl th,.te-tbl td{border:1px solid var(--border);padding:5px 8px;text-align:left;vertical-align:top}
.te-tbl th{background:var(--surface2);font-weight:600;color:var(--text2);font-size:.82rem}
.te-tbl tr:hover{background:rgba(78,168,222,.06)}
.te-cell{display:flex;align-items:center;gap:4px;min-height:24px}
.te-cell-val{flex:1;word-break:break-word}
.te-cell-val:empty::after{content:"(pr√°zdn√©)";color:var(--text2);font-style:italic;font-size:.8rem}
.te-cell-edit{display:flex;gap:4px;align-items:center;width:100%}
.te-cell-edit input{flex:1;font-size:.86rem;padding:3px 6px;border:1px solid var(--accent);border-radius:3px;background:var(--bg);color:var(--text)}
.te-row-acts{white-space:nowrap;width:1%;text-align:center}
.te-row-acts button{font-size:.7rem;padding:1px 5px;margin:1px;background:var(--surface2);border:1px solid var(--border);color:var(--text2);border-radius:3px;cursor:pointer}
.te-row-acts button:hover{border-color:var(--accent);color:var(--accent)}
.te-btn-cell{font-size:.65rem;padding:0 4px;background:none;border:1px solid var(--border);color:var(--text2);border-radius:3px;cursor:pointer;flex-shrink:0}
.te-btn-cell:hover{border-color:var(--accent);color:var(--accent)}
.te-info{font-size:.82rem;color:var(--text2);margin:8px 0 0}

.backlinks{margin-top:24px;padding-top:12px;border-top:1px solid var(--border);font-size:.84rem}
.backlinks h3{font-size:.88rem;color:var(--text2);margin-bottom:6px}
.backlinks ul{padding-left:1.2em;list-style:disc}

.dlg-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.55);z-index:1000;display:flex;align-items:center;justify-content:center}
.dlg{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:20px;min-width:340px;max-width:90vw;max-height:85vh;overflow-y:auto}
.dlg h2{font-size:1.1rem;margin-bottom:12px}
.dlg label{display:block;margin:8px 0 3px;font-size:.85rem;color:var(--text2)}
.dlg .btn-row{display:flex;gap:6px;margin-top:14px;justify-content:flex-end}
.emoji-grid{display:flex;flex-wrap:wrap;gap:3px;margin-top:4px}
.emoji-btn{font-size:1.2rem;padding:3px 5px;border:2px solid transparent;background:none;border-radius:4px;cursor:pointer}
.emoji-btn:hover,.emoji-btn.sel{border-color:var(--accent);background:rgba(78,168,222,.12)}

.empty{text-align:center;padding:40px;color:var(--text2)}
#bookmarks-area{border-bottom:1px solid var(--border);padding:8px;flex-shrink:0;max-height:120px;overflow-y:auto;display:none}
#bookmarks-area h2{font-size:.8rem;color:var(--text2);margin-bottom:4px}
#bookmarks-area ul{list-style:none;padding:0;margin:0}
#bookmarks-area li{margin:1px 0}
.note-toc{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:10px 14px;margin:10px 0 16px;font-size:.86rem}
.note-toc h3{font-size:.8rem;color:var(--text2);margin:0 0 6px;text-transform:uppercase;letter-spacing:.4px}
.note-toc ol{margin:0;padding-left:1.4em}
.note-toc ol ol{margin:2px 0}
.note-toc li{margin:2px 0}
.note-toc a{color:var(--accent)}
.meta-table{width:100%;font-size:.84rem;border-collapse:collapse;margin:6px 0 12px}
.meta-table td{padding:3px 8px;border-bottom:1px solid var(--border)}
.meta-table td:first-child{color:var(--text2);font-weight:600;white-space:nowrap;width:1%}
.bm-star{background:none;border:none;font-size:1.1rem;cursor:pointer;padding:2px 4px;border-radius:3px;color:var(--text2)}
.bm-star:hover,.bm-star.active{color:#f0c030}
#dbg{background:#111;color:#0f0;font-size:11px;font-family:monospace;padding:4px 8px;max-height:100px;overflow:auto;border-top:1px solid #333;flex-shrink:0;display:none}

/* ===== ADVANCED EDITOR ===== */
.ae-tree{list-style:none;padding:0;margin:0}
.ae-item{margin:6px 0}
.ae-art{background:var(--surface);border:1px solid var(--border);border-radius:6px;overflow:hidden}
.ae-item.ae-coll>.ae-art .ae-kids{display:none}
.ae-hdr{display:flex;align-items:flex-start;padding:10px;gap:6px}
.ae-hdr:hover{background:rgba(78,168,222,.05)}
.ae-ctrl{display:flex;gap:3px;flex-shrink:0}
.ae-cnt{flex:1;min-width:0}
.ae-lvl{font-size:.68rem;color:var(--text2);font-weight:600;margin-bottom:2px}
.ae-hdsp h1,.ae-hdsp h2,.ae-hdsp h3,.ae-hdsp h4,.ae-hdsp h5,.ae-hdsp h6{margin:0 0 6px;padding:0;line-height:1.3}
.ae-hdsp h1{font-size:1.3rem}.ae-hdsp h2{font-size:1.15rem}.ae-hdsp h3{font-size:1.05rem}
.ae-hdsp h4{font-size:.95rem}.ae-hdsp h5{font-size:.9rem}.ae-hdsp h6{font-size:.85rem}
.ae-hdsp ins{background:var(--cm-add-bg);color:var(--cm-add-fg);text-decoration:none;padding:1px 4px;border-radius:3px}
.ae-bdsp{font-size:.84rem;line-height:1.5}
.ae-bdsp p{margin:.5em 0}.ae-bdsp ul,.ae-bdsp ol{margin:.4em 0 .4em 1.3em}
.ae-bdsp ol ol{list-style-type:lower-alpha}
.ae-bdsp code{background:var(--surface2);padding:1px 4px;border-radius:3px;font-size:.88em;font-family:'Consolas',monospace}
.ae-bdsp pre{background:var(--surface);padding:8px;border-radius:4px;overflow-x:auto;margin:.5em 0;border:1px solid var(--border)}
.ae-bdsp pre code{background:none;padding:0}
.ae-bdsp blockquote{border-left:3px solid var(--accent);padding:4px 12px;margin:.4em 0;color:var(--text2);background:rgba(78,168,222,.06)}
.ae-bdsp table{border-collapse:collapse;width:auto;min-width:40%;font-size:.84rem;margin:.5em 0}
.ae-bdsp th,.ae-bdsp td{border:1px solid var(--border);padding:4px 8px}.ae-bdsp th{background:var(--surface2)}
.ae-bdsp img{max-width:100%}
.ae-bdsp hr{border:none;border-top:1px solid var(--border);margin:.8em 0}
.ae-bdsp ins{background:var(--cm-add-bg);color:var(--cm-add-fg);padding:1px 3px;border-radius:2px;text-decoration:underline}
.ae-bdsp del{background:var(--cm-del-bg);color:var(--cm-del-fg);padding:1px 3px;border-radius:2px}
.ae-bdsp mark{background:var(--cm-hi-bg);color:var(--cm-hi-fg);padding:1px 3px;border-radius:2px}
.ae-bdsp .cm-cmt{background:var(--cm-cmt-bg);color:var(--cm-cmt-fg);padding:2px 5px;border-radius:2px;font-style:italic}
.ae-bdsp .task-done{text-decoration:line-through;opacity:.6}
.ae-bdsp .wlink{color:var(--accent)}.ae-bdsp .wlink-broken{color:var(--danger);text-decoration:underline dotted}
.ae-bg{display:inline-flex;align-items:center;gap:4px;margin-top:4px;margin-right:4px;padding:2px 7px;border-radius:4px;font-size:.72rem;font-weight:600;color:#fff}
.ae-bg.i{background:var(--accent)}.ae-bg.w{background:var(--warn)}.ae-bg.g{background:var(--success)}.ae-bg.s{background:#1890ff}
.ae-kids{margin-left:20px;padding:6px 0 6px 10px;border-left:2px solid var(--border)}
.ae-ib{width:26px;height:26px;padding:0;display:inline-flex;align-items:center;justify-content:center;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:4px;cursor:pointer;font-size:.78rem;flex-shrink:0}
.ae-ib:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
.ae-ib:disabled{opacity:.4;cursor:not-allowed;background:var(--surface2);color:var(--text2)}
.ae-ib.dng:hover{background:var(--danger);border-color:var(--danger)}
.ae-acts{display:flex;gap:3px;margin-top:6px;flex-wrap:wrap;align-items:center}
.ae-hinp{width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:.95rem;font-weight:600;font-family:inherit;margin-bottom:4px;background:var(--surface);color:var(--text)}
.ae-bta{width:100%;padding:8px;border:1px solid var(--border);border-radius:4px;font-size:.84rem;font-family:'Consolas',monospace;resize:vertical;min-height:120px;background:var(--surface);color:var(--text);tab-size:4}
.ae-editctl{margin-top:6px;padding-top:6px;border-top:1px solid var(--border);display:flex;gap:6px}
.ae-tag{color:var(--accent);font-weight:600;cursor:pointer;text-decoration:none}
.ae-tag:hover{text-decoration:underline}
.ae-ban{padding:8px 14px;margin:0 0 10px;border-radius:6px;display:flex;justify-content:space-between;align-items:center;font-size:.84rem;font-weight:600;flex-wrap:wrap;gap:6px}
.ae-srch{padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:.82rem;background:var(--surface);color:var(--text);min-width:160px;width:auto}

/* Presentation Mode */
.pres-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:#fff;display:flex;flex-direction:column;z-index:2000}
.pres-hdr{display:flex;justify-content:space-between;align-items:center;padding:12px 24px;background:#1a1a2e;color:#fff;flex-shrink:0;gap:16px}
.pres-timer{font-size:18px;font-weight:600;font-family:'Consolas','Monaco',monospace;min-width:80px;color:#ffd700}
.pres-nav{display:flex;align-items:center;gap:12px}
.pres-nav button{background:rgba(255,255,255,.1);border:none;color:#fff;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:16px;transition:background .2s}
.pres-nav button:hover:not(:disabled){background:rgba(255,255,255,.2)}
.pres-nav button:disabled{opacity:.4;cursor:not-allowed}
.pres-nav button:focus{outline:2px solid #ffd700;outline-offset:2px}
.pres-counter{font-size:14px;color:rgba(255,255,255,.8);min-width:100px;text-align:center}
.pres-close{background:rgba(255,255,255,.1);border:none;color:#fff;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px}
.pres-close:hover{background:rgba(255,0,0,.3)}
.pres-close:focus{outline:2px solid #ffd700;outline-offset:2px}
.pres-title-bar{background:#2d2d4a;padding:10px 24px;text-align:center;flex-shrink:0}
.pres-title-text{font-size:18px;font-weight:600;color:rgba(255,255,255,.9);max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.pres-main{flex:1;display:flex;align-items:center;justify-content:center;padding:60px;overflow:auto}
.pres-slide{max-width:1200px;width:100%;text-align:left}
.pres-slide.pres-title{text-align:center}
.pres-slide.pres-section{text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:400px}
.pres-slide h1{font-size:56px;font-weight:700;margin:0 0 24px;color:#1a1a2e;line-height:1.2}
.pres-slide h2{font-size:44px;font-weight:600;margin:0 0 32px;color:#1a1a2e;line-height:1.2}
.pres-slide.pres-section h2{font-size:52px;color:#4a4a6a}
.pres-slide-body{font-size:24px;line-height:1.6;color:#333;margin-bottom:32px}
.pres-slide ul{list-style:none;padding:0;margin:0}
.pres-slide li{font-size:28px;line-height:1.5;margin:16px 0;padding-left:40px;position:relative;color:#333}
.pres-slide li::before{content:"\2022";position:absolute;left:0;color:#4a90d9;font-size:32px;line-height:1.3}
.pres-slide li li{font-size:24px;margin:12px 0}
.pres-slide li li::before{content:"\25E6";font-size:24px}
.pres-sr{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
.pres-overview{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;padding:30px;overflow:auto;flex:1;background:#f0f0f0}
.pres-ov-item{background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);cursor:pointer;transition:transform .2s,box-shadow .2s;overflow:hidden;aspect-ratio:16/10;display:flex;flex-direction:column;border:none;text-align:left;padding:0;font-family:inherit}
.pres-ov-item:hover{transform:scale(1.03);box-shadow:0 4px 16px rgba(0,0,0,.15)}
.pres-ov-item:focus{outline:3px solid #4a90d9;outline-offset:2px}
.pres-ov-item.active{outline:3px solid #ffd700}
.pres-ov-cnt{flex:1;padding:16px;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;overflow:hidden}
.pres-ov-cnt h3{font-size:14px;margin:0;color:#333;line-height:1.3;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
.pres-ov-cnt.pres-title h3{font-size:16px;font-weight:700}
.pres-ov-cnt.pres-section h3{font-size:15px;color:#4a4a6a}
.pres-ov-num{background:#1a1a2e;color:#fff;padding:4px 10px;font-size:12px;font-weight:600}
@media(max-width:768px){.pres-main{padding:30px}.pres-slide h1{font-size:36px}.pres-slide h2{font-size:28px}.pres-slide li{font-size:20px;padding-left:28px}.pres-slide li::before{font-size:24px}.pres-slide-body{font-size:18px}}

/* CriticMarkup Review */
.cr-wrap{display:flex;gap:0;min-height:300px}
.cr-doc{flex:1;overflow-y:auto;padding:12px 16px;border-right:2px solid var(--border)}
.cr-rev{width:360px;min-width:280px;overflow-y:auto;padding:10px 14px;background:var(--surface)}
.cr-doc h1{font-size:1.4rem;border-bottom:2px solid var(--border);padding-bottom:.3rem;margin-top:1rem}
.cr-doc h2{font-size:1.2rem;border-bottom:1px solid var(--border);padding-bottom:.2rem;margin-top:.9rem}
.cr-doc h3{font-size:1.05rem;margin-top:.8rem}
.cr-doc p{margin:.5em 0}.cr-doc ul,.cr-doc ol{margin:.4em 0 .4em 1.3em}
.cr-doc blockquote{border-left:3px solid var(--accent);padding:4px 12px;margin:.5em 0;color:var(--text2);background:rgba(78,168,222,.06)}
.cr-doc pre{background:var(--surface);padding:8px;border-radius:4px;overflow-x:auto;margin:.5em 0;border:1px solid var(--border)}
.cr-doc code{background:var(--surface2);padding:1px 4px;border-radius:3px;font-size:.88em;font-family:'Consolas',monospace}
.cr-doc pre code{background:none;padding:0}
.cr-doc table{border-collapse:collapse;margin:.5em 0;width:100%;font-size:.9rem}
.cr-doc th,.cr-doc td{border:1px solid var(--border);padding:4px 8px}.cr-doc th{background:var(--surface2)}
.cr-ca{background:#d4edda;color:#155724;text-decoration:underline dotted;padding:.05rem .15rem;border-radius:2px}
.cr-cd{background:#f8d7da;color:#721c24;text-decoration:line-through;padding:.05rem .15rem;border-radius:2px}
.cr-csd{background:#f8d7da;color:#721c24;text-decoration:line-through;padding:.05rem .15rem;border-radius:2px}
.cr-csi{background:#d4edda;color:#155724;text-decoration:underline dotted;padding:.05rem .15rem;border-radius:2px}
.cr-cmh{background:#fff3cd;color:#856404;padding:.05rem .15rem;border-radius:2px}
.cr-cmc{background:#cce5ff;color:#004085;border:1px dashed #004085;padding:.1rem .3rem;font-size:.85em;border-radius:3px}
.cr-cab{display:inline;font-size:.78rem;margin-left:.15rem;white-space:nowrap}
.cr-cab button{font-size:.72rem;padding:.1rem .35rem;margin:0 .1rem;border:1px solid #999;background:#fff;border-radius:2px;cursor:pointer;vertical-align:middle}
.cr-cab button:hover{background:#ddd}
.cr-rev h3{font-size:.95rem;margin:0 0 .6rem;padding-bottom:.3rem;border-bottom:1px solid var(--border)}
details.cr-rs{margin-bottom:.8rem}
details.cr-rs summary{font-weight:bold;cursor:pointer;padding:.2rem 0;font-size:.88rem}
.cr-ri{border:1px solid var(--border);border-radius:4px;padding:.4rem .6rem;margin:.3rem 0;background:var(--surface)}
.cr-rit{font-weight:bold;font-size:.75rem;text-transform:uppercase;margin-bottom:.2rem}
.cr-t-a{color:#155724}.cr-t-d{color:#721c24}.cr-t-s{color:#6c3483}.cr-t-h{color:#856404}.cr-t-c{color:#004085}
.cr-rix{font-size:.85rem;margin:.15rem 0 .3rem;word-break:break-word}
.cr-ria{display:flex;gap:.25rem;flex-wrap:wrap}
.cr-ria button{font-size:.78rem;padding:.2rem .45rem;border:1px solid #999;background:#f8f8f8;border-radius:3px;cursor:pointer}
.cr-ria button:hover{background:#ddd}
.cr-rid{opacity:.5;background:var(--surface2)!important}
.cr-re{color:var(--text2);font-style:italic;padding:.4rem;font-size:.85rem}
.cr-stats{font-size:.82rem;color:var(--text2);margin-left:auto}
.cr-modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:2500;align-items:center;justify-content:center}
.cr-modal.active{display:flex}
.cr-mbox{background:var(--bg);border:2px solid var(--accent);border-radius:6px;padding:1.25rem;max-width:500px;width:90%;max-height:80vh;overflow-y:auto}
.cr-mbox h3{margin:0 0 .6rem;font-size:1rem}
.cr-mbox p{margin:.3rem 0;font-size:.9rem}
.cr-mbox textarea{width:100%;height:6rem;font-family:'Consolas',monospace;font-size:.9rem;padding:.5rem;border:1px solid var(--border);border-radius:3px;margin:.4rem 0;background:var(--surface);color:var(--text)}
.cr-mbox .cr-mbtn{margin-top:.6rem;display:flex;gap:.4rem}
.cr-mbox .cr-mbtn button{padding:.35rem .8rem;font-size:.9rem;cursor:pointer;border:1px solid var(--border);background:var(--surface);border-radius:3px;color:var(--text)}
.cr-mbox .cr-mbtn button:hover{background:var(--surface2)}
@media(max-width:768px){.cr-wrap{flex-direction:column}.cr-rev{width:100%;min-width:auto;border-top:2px solid var(--border)}.cr-doc{border-right:none}}

/* Spellcheck */
.sp-stats{display:flex;gap:10px;margin-bottom:10px;font-size:.82rem;flex-wrap:wrap;align-items:center}
.sp-badge{padding:2px 9px;border-radius:12px;font-weight:600;font-size:.78rem}
.sp-err{background:rgba(207,34,46,.1);color:#cf222e}
.sp-ok{background:rgba(34,139,34,.1);color:#228B22}
.sp-corr{background:rgba(34,139,34,.1);color:#228B22}
.sp-ign{background:rgba(107,94,79,.1);color:#6b5e4f}
.sp-dict{font-size:.78rem;margin-bottom:8px}
.sp-dict.ok{color:#228B22}.sp-dict.loading{color:var(--text2)}.sp-dict.error{color:#cf222e}
.sp-result{padding:16px 20px;background:var(--surface);border:1px solid var(--border);border-radius:6px;font-size:.95rem;line-height:1.8;min-height:50px;white-space:pre-wrap;word-break:break-word;margin-bottom:10px}
a.sp-we{color:#cf222e;background:rgba(207,34,46,.08);text-decoration:underline wavy #cf222e;text-underline-offset:3px;padding:0 1px;border-radius:2px}
a.sp-we:hover{background:rgba(207,34,46,.18)}
.sp-eblk{margin-bottom:14px;padding:12px 16px;background:var(--surface);border:1px solid var(--border);border-radius:6px;scroll-margin-top:16px}
.sp-eblk h6{font-size:.92rem;font-weight:700;margin:0 0 8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.sp-eblk h6 .sp-ew{color:#cf222e}
.sp-eblk h6 .sp-bl{font-size:.75rem;font-weight:400;color:var(--text2);text-decoration:none;margin-left:auto}
.sp-eblk h6 .sp-bl:hover{text-decoration:underline}
.sp-srow{display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-bottom:6px}
.sp-srow .sp-lbl{font-size:.72rem;text-transform:uppercase;letter-spacing:.8px;color:var(--text2);font-weight:600;margin-right:3px}
a.sp-sl{display:inline-block;padding:3px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:4px;color:var(--text);text-decoration:none;font-size:.88rem;cursor:pointer}
a.sp-sl:hover{background:var(--border)}
a.sp-sl.best{font-weight:600;border-color:#cf222e;background:rgba(207,34,46,.06)}
.sp-mrow{display:flex;gap:6px;align-items:center;margin-top:4px}
.sp-mrow .sp-lbl{font-size:.72rem;text-transform:uppercase;letter-spacing:.8px;color:var(--text2);font-weight:600;white-space:nowrap}
.sp-minp{padding:4px 8px;border:1px solid var(--border);border-radius:4px;font-size:.88rem;background:var(--surface);color:var(--text);width:180px}
.sp-minp:focus{border-color:var(--accent)}
.sp-acts{margin-top:8px;display:flex;gap:14px;font-size:.82rem}
.sp-acts a{color:var(--text2);text-decoration:none;cursor:pointer}
.sp-acts a:hover{text-decoration:underline;color:var(--text)}
.sp-errbox{padding:10px 14px;background:#fef2f2;border:1px solid #fca5a5;border-radius:6px;color:#991b1b;font-size:.85rem;margin-bottom:12px}

/* Export/Import */
.ei-list{list-style:none;padding:0;margin:0}
.ei-list .ei-list{padding-left:22px}
.ei-item{padding:2px 0}
.ei-item label{display:flex;align-items:center;gap:6px;cursor:pointer;font-size:.88rem;padding:2px 4px;border-radius:3px}
.ei-item label:hover{background:var(--surface2)}
.ei-item input[type=checkbox]{width:16px;height:16px;cursor:pointer;flex-shrink:0}
.ei-icon{flex-shrink:0}
.ei-cnt{font-size:.75rem;color:var(--text2);margin-left:4px}
.ei-summary{font-size:.85rem;color:var(--text2);margin:10px 0;padding:8px 12px;background:var(--surface);border-radius:4px;border:1px solid var(--border)}
.ei-preview{padding:12px 16px;background:var(--surface);border:1px solid var(--border);border-radius:6px;margin:10px 0;max-height:50vh;overflow-y:auto}
.ei-preview .ei-list .ei-item{padding:1px 0}
.ei-preview .ei-item span{font-size:.88rem}
.ei-conflict{margin:10px 0;padding:10px 14px;background:#fff8e1;border:1px solid #ffe082;border-radius:6px}
.ei-conflict h4{margin:0 0 6px;font-size:.88rem;color:#f57f17}
.ei-conflict ul{list-style:none;padding:0;margin:4px 0;font-size:.82rem}
.ei-conflict li{padding:2px 0}
.ei-strat{margin:10px 0;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:6px}
.ei-strat h4{margin:0 0 6px;font-size:.88rem}
.ei-strat label{display:flex;align-items:center;gap:6px;font-size:.85rem;padding:3px 0;cursor:pointer}
.ei-strat input[type=radio]{width:15px;height:15px;cursor:pointer}
.ei-target{margin:10px 0;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:6px}
.ei-target h4{margin:0 0 6px;font-size:.88rem}
.ei-target label{display:flex;align-items:center;gap:6px;font-size:.85rem;padding:3px 0;cursor:pointer}
.ei-target input[type=radio]{width:15px;height:15px;cursor:pointer}
.ei-msg{padding:10px 14px;border-radius:6px;font-size:.85rem;margin:10px 0}
.ei-msg.ok{background:rgba(34,139,34,.1);color:#228B22;border:1px solid rgba(34,139,34,.3)}
.ei-msg.err{background:#fef2f2;border:1px solid #fca5a5;color:#991b1b}

</style>
</head>
<body>

<header role="banner">
  <h1 id="block-title">NoteBlock</h1>
  <span class="spacer"></span>
  <button onclick="toggleSidebar()" accesskey="p" aria-label="Panel (Alt+P)">&#9776;<span class="ak">P</span></button>
  <button onclick="doSearch()" accesskey="f">&#128269; Hledat<span class="ak">F</span></button>
  <select id="emoji-filter" onchange="filterByEmoji(this.value)" style="width:auto;padding:3px 6px;font-size:.88rem" aria-label="Filtr podle emotikony">
    <option value="">&#128526; V≈°e</option>
  </select>
  <select id="meta-filter" onchange="filterByMeta(this.value)" style="width:auto;padding:3px 6px;font-size:.88rem" aria-label="Filtr podle metadat">
    <option value="">&#128203; Metadata</option>
  </select>
  <button onclick="showTasks()" accesskey="t">&#9745; √ökoly<span class="ak">T</span></button>
  <span class="spacer"></span>
  <button onclick="dlgNewNote()" accesskey="n">&#128221; Pozn√°mka<span class="ak">N</span></button>
  <button onclick="loadBlock()" accesskey="o">&#128194; Nahr√°t<span class="ak">O</span></button>
  <button onclick="saveBlock()" accesskey="s">&#128190; Ulo≈æit<span class="ak">S</span></button>
  <button onclick="showSettings()">&#9881; Nastaven√≠</button>
  <button onclick="eiMod.openExport()">&#128230; Export</button>
  <button onclick="eiMod.openImport()">&#128229; Import</button>
  <button onclick="toggleDebug()" class="sm">DBG</button>
</header>

<div id="layout">
<nav id="sidebar" aria-label="Navigace">
  <div id="nav-tools">
    <button class="sm" onclick="dlgNewFolder()">+ Slo≈æka</button>
    <button class="sm" onclick="dlgNewNote()">+ Pozn√°mka</button>
    <span id="nav-hoist-btn"></span>
  </div>
  <div id="bookmarks-area">
    <h2>&#11088; Obl√≠ben√©</h2>
    <ul id="bookmarks-list"></ul>
  </div>
  <div id="nav-scroll" role="navigation" aria-label="Slo≈æky a pozn√°mky">
    <h6 style="margin:0 0 6px;font-size:.72rem;text-transform:uppercase;color:var(--text2);letter-spacing:.5px">Navigace</h6>
  </div>
  <div id="tags-area" style="display:none">
    <h2>≈†t√≠tky</h2>
    <div id="tags-chips"></div>
  </div>
</nav>

<main id="content">
  <div id="toolbar" role="toolbar" aria-label="N√°stroje"></div>
  <div id="tabbar" role="tablist" aria-label="Otev≈ôen√© pozn√°mky"></div>
  <div id="view" role="tabpanel"><div class="empty">Nahrajte nebo vytvo≈ôte nov√Ω pozn√°mkov√Ω blok.</div></div>
</main>
</div>

<div id="dbg"></div>
<input type="file" id="file-in" style="display:none">
<input type="file" id="nme-in" style="display:none">

<script>
"use strict";

// ===== DEBUG =====
function dbg(msg) {
  var d = document.getElementById("dbg");
  var t = new Date().toLocaleTimeString("cs");
  d.innerHTML += t + " " + String(msg).replace(/</g, "&lt;") + "\n";
  d.scrollTop = d.scrollHeight;
}
function toggleDebug() {
  var d = document.getElementById("dbg");
  d.style.display = d.style.display === "none" ? "block" : "none";
}
window.onerror = function(m, s, l, c, e) {
  dbg("ERROR: " + m + " (≈ô√°dek " + l + ")");
};

// ===== STATE =====
var BD = null;
var CUR = { type: "none", id: null };
var STAG = null;
var SEDIT = false;
var EXPANDED = {};
var HOIST = null;
var EFILT = null;
var MFILT = null;
var PANELS = [];
var ACTIVE_PANEL = -1;
var PREVIEW_WINS = {};

var DEFAULT_EMOJIS = "üìùüìÑüìãüìåüìéüîñüìöüìñ‚úèüñäüóíüóÇüí°üîîüéØüè∑‚≠êüí¨üåçüè†üé®üîßüõ†üíªüìäüìàüß™üî¨üß©üéìüéµüé∂üç¥‚úàüöÄüí∞üì±üñ•üîëüîíüìßüìûüåüüéÆüèÜüß†‚ù§üî•";

function getEmojis() {
  if (BD && BD.emojis && BD.emojis.length > 0) return Array.from(BD.emojis);
  return Array.from(DEFAULT_EMOJIS);
}

// ===== UTILITY =====
function genId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2, 6);
}

function esc(s) {
  if (!s) return "";
  var d = document.createElement("div");
  d.appendChild(document.createTextNode(s));
  return d.innerHTML;
}

function now() {
  return new Date().toISOString();
}

function getFolder(id) {
  if (!BD) return null;
  for (var i = 0; i < BD.folders.length; i++) {
    if (BD.folders[i].id === id) return BD.folders[i];
  }
  return null;
}

function getNote(id) {
  if (!BD) return null;
  for (var i = 0; i < BD.notes.length; i++) {
    if (BD.notes[i].id === id) return BD.notes[i];
  }
  return null;
}

function childFolders(parentId) {
  if (!BD) return [];
  var r = [];
  for (var i = 0; i < BD.folders.length; i++) {
    if (BD.folders[i].parentId === parentId) r.push(BD.folders[i]);
  }
  r.sort(function(a, b) { return a.name.localeCompare(b.name, "cs"); });
  return r;
}

function notesInFolder(folderId) {
  if (!BD) return [];
  var r = [];
  for (var i = 0; i < BD.notes.length; i++) {
    if (BD.notes[i].folderId === folderId) r.push(BD.notes[i]);
  }
  r.sort(function(a, b) { return a.name.localeCompare(b.name, "cs"); });
  return r;
}

function allDescFolderIds(parentId) {
  var ids = [];
  var ch = childFolders(parentId);
  for (var i = 0; i < ch.length; i++) {
    ids.push(ch[i].id);
    ids = ids.concat(allDescFolderIds(ch[i].id));
  }
  return ids;
}

function countNotes(folderId) {
  var ids = [folderId].concat(allDescFolderIds(folderId));
  var c = 0;
  for (var j = 0; j < ids.length; j++) {
    c += notesInFolder(ids[j]).length;
  }
  return c;
}

function countPendingTasks(content) {
  if (!content) return 0;
  var m = content.match(/^- \[ \]/gm);
  return m ? m.length : 0;
}

function folderPath(folderId) {
  var path = [];
  var f = getFolder(folderId);
  while (f) {
    path.unshift(f);
    f = f.parentId ? getFolder(f.parentId) : null;
  }
  return path;
}

function noteNameExists(name, excludeId) {
  if (!BD) return false;
  var low = name.toLowerCase();
  for (var i = 0; i < BD.notes.length; i++) {
    if (BD.notes[i].id !== excludeId && BD.notes[i].name.toLowerCase() === low) return true;
  }
  return false;
}

function folderNameExists(name, parentId, excludeId) {
  if (!BD) return false;
  var low = name.toLowerCase();
  for (var i = 0; i < BD.folders.length; i++) {
    var f = BD.folders[i];
    if (f.id !== excludeId && f.parentId === parentId && f.name.toLowerCase() === low) return true;
  }
  return false;
}

function allTags() {
  if (!BD) return [];
  var set = {};
  for (var i = 0; i < BD.notes.length; i++) {
    var t = BD.notes[i].tags;
    if (t) {
      for (var j = 0; j < t.length; j++) set[t[j]] = 1;
    }
  }
  return Object.keys(set).sort(function(a, b) { return a.localeCompare(b, "cs"); });
}

function findNoteByName(name) {
  if (!BD) return null;
  var low = name.toLowerCase().trim();
  for (var i = 0; i < BD.notes.length; i++) {
    if (BD.notes[i].name.toLowerCase() === low) return BD.notes[i];
  }
  return null;
}

// ===== NAVIGATION =====
function renderNav() {
  var NAV_H6 = '<h6 style="margin:0 0 6px;font-size:.72rem;text-transform:uppercase;color:var(--text2);letter-spacing:.5px">Navigace</h6>';
  if (!BD) {
    document.getElementById("nav-scroll").innerHTML = NAV_H6 + '<div class="empty" style="padding:20px;font-size:.85rem">≈Ω√°dn√Ω blok</div>';
    document.getElementById("tags-area").style.display = "none";
    document.getElementById("nav-hoist-btn").innerHTML = "";
    return;
  }
  document.getElementById("block-title").textContent = "NoteBlock \u2013 " + BD.name;
  updateTitle();

  // Unhoist button
  if (HOIST) {
    var hf = getFolder(HOIST);
    document.getElementById("nav-hoist-btn").innerHTML = '<button class="sm" onclick="unhoist()" accesskey="a" style="border-color:var(--warn);color:var(--warn)" title="Zru≈°it hoist (Alt+A)">&#8634; ' + esc(hf ? hf.name : "") + '<span class="ak">A</span></button>';
  } else {
    document.getElementById("nav-hoist-btn").innerHTML = "";
  }

  var root = HOIST || null;
  var html = buildNavUL(root);
  document.getElementById("nav-scroll").innerHTML = NAV_H6 + html;
  renderTags();
  renderEmojiFilter();
  renderMetaFilter();
  renderBookmarks();
}

function buildNavUL(parentId) {
  var folders = childFolders(parentId);
  var notes = notesInFolder(parentId);

  // Emoji filter
  if (EFILT) {
    notes = notes.filter(function(n) { return n.icon === EFILT; });
    folders = folders.filter(function(f) { return folderHasEmojiMatch(f.id, EFILT); });
  }

  // Meta filter
  if (MFILT) {
    notes = notes.filter(function(n) { return noteHasMeta(n, MFILT.key, MFILT.value); });
    folders = folders.filter(function(f) { return folderHasMetaMatch(f.id, MFILT.key, MFILT.value); });
  }

  if (folders.length === 0 && notes.length === 0) return "";

  var h = "<ul>";
  for (var i = 0; i < folders.length; i++) {
    var f = folders[i];
    var cnt = (EFILT || MFILT) ? countFilteredNotes(f.id) : countNotes(f.id);
    var hasChildren = childFolders(f.id).length > 0 || notesInFolder(f.id).length > 0;
    var isExpanded = EXPANDED[f.id] === true;
    var isActive = (CUR.type === "folder" && CUR.id === f.id);

    h += "<li>";
    h += '<div class="nav-row">';
    if (hasChildren) {
      h += '<button class="nav-toggle" onclick="toggleFolder(\'' + f.id + '\')" aria-label="' + (isExpanded ? "Sbalit" : "Rozbalit") + '">';
      h += isExpanded ? "&#9662;" : "&#9656;";
      h += "</button>";
    } else {
      h += '<span class="nav-toggle-placeholder"></span>';
    }
    h += '<a href="#" class="nav-link' + (isActive ? " active" : "") + '" onclick="openFolder(\'' + f.id + '\');return false">';
    h += "&#128193; " + esc(f.name);
    if (cnt > 0) h += ' <span class="nav-badge">[' + cnt + "]</span>";
    h += "</a></div>";
    if (hasChildren && isExpanded) h += buildNavUL(f.id);
    h += "</li>";
  }

  for (var j = 0; j < notes.length; j++) {
    var n = notes[j];
    var tc = countPendingTasks(n.content);
    var isNoteActive = (CUR.type === "note" && CUR.id === n.id);
    h += "<li>";
    h += '<div class="nav-row">';
    h += '<span class="nav-toggle-placeholder"></span>';
    h += '<a href="#" class="nav-link' + (isNoteActive ? " active" : "") + '" onclick="openNote(\'' + n.id + '\');return false">';
    h += (n.icon || "&#128221;") + " " + esc(n.name);
    if (tc > 0) h += ' <span class="nav-task">(' + tc + ")</span>";
    h += "</a></div></li>";
  }

  h += "</ul>";
  return h;
}

function folderHasEmojiMatch(folderId, emoji) {
  var notes = notesInFolder(folderId);
  for (var i = 0; i < notes.length; i++) {
    if (notes[i].icon === emoji) return true;
  }
  var subs = childFolders(folderId);
  for (var j = 0; j < subs.length; j++) {
    if (folderHasEmojiMatch(subs[j].id, emoji)) return true;
  }
  return false;
}

function countEmojiNotes(folderId, emoji) {
  var ids = [folderId].concat(allDescFolderIds(folderId));
  var c = 0;
  for (var j = 0; j < ids.length; j++) {
    var nn = notesInFolder(ids[j]);
    for (var k = 0; k < nn.length; k++) {
      if (nn[k].icon === emoji) c++;
    }
  }
  return c;
}

function countFilteredNotes(folderId) {
  var ids = [folderId].concat(allDescFolderIds(folderId));
  var c = 0;
  for (var j = 0; j < ids.length; j++) {
    var nn = notesInFolder(ids[j]);
    for (var k = 0; k < nn.length; k++) {
      var ok = true;
      if (EFILT && nn[k].icon !== EFILT) ok = false;
      if (MFILT && !noteHasMeta(nn[k], MFILT.key, MFILT.value)) ok = false;
      if (ok) c++;
    }
  }
  return c;
}

function usedEmojis() {
  if (!BD) return [];
  var set = {};
  for (var i = 0; i < BD.notes.length; i++) {
    var ic = BD.notes[i].icon;
    if (ic) set[ic] = (set[ic] || 0) + 1;
  }
  var arr = [];
  for (var k in set) arr.push({ emoji: k, count: set[k] });
  arr.sort(function(a, b) { return b.count - a.count; });
  return arr;
}

function renderEmojiFilter() {
  var sel = document.getElementById("emoji-filter");
  if (!sel || !BD) return;
  var emojis = usedEmojis();
  var h = '<option value="">&#128526; V≈°e</option>';
  for (var i = 0; i < emojis.length; i++) {
    var s = emojis[i].emoji === EFILT ? " selected" : "";
    h += '<option value="' + esc(emojis[i].emoji) + '"' + s + ">" + emojis[i].emoji + " (" + emojis[i].count + ")</option>";
  }
  sel.innerHTML = h;
}

function usedMetaKV() {
  if (!BD) return [];
  var map = {};
  for (var i = 0; i < BD.notes.length; i++) {
    var meta = BD.notes[i].meta;
    if (!meta) continue;
    for (var j = 0; j < meta.length; j++) {
      var kv = meta[j].key + "=" + meta[j].value;
      if (!map[kv]) map[kv] = { key: meta[j].key, value: meta[j].value, count: 0 };
      map[kv].count++;
    }
  }
  var arr = [];
  for (var k in map) arr.push(map[k]);
  arr.sort(function(a, b) { return a.key.localeCompare(b.key, "cs") || a.value.localeCompare(b.value, "cs"); });
  return arr;
}

function renderMetaFilter() {
  var sel = document.getElementById("meta-filter");
  if (!sel || !BD) return;
  var kvs = usedMetaKV();
  var h = '<option value="">&#128203; Metadata</option>';
  for (var i = 0; i < kvs.length; i++) {
    var val = kvs[i].key + "=" + kvs[i].value;
    var s = (MFILT && MFILT.key === kvs[i].key && MFILT.value === kvs[i].value) ? " selected" : "";
    h += '<option value="' + esc(val) + '"' + s + ">" + esc(kvs[i].key) + ": " + esc(kvs[i].value) + " (" + kvs[i].count + ")</option>";
  }
  sel.innerHTML = h;
}

function filterByMeta(val) {
  if (!val) { MFILT = null; }
  else {
    var idx = val.indexOf("=");
    MFILT = { key: val.substring(0, idx), value: val.substring(idx + 1) };
  }
  renderNav();
}

function noteHasMeta(note, key, value) {
  if (!note.meta) return false;
  for (var i = 0; i < note.meta.length; i++) {
    if (note.meta[i].key === key && note.meta[i].value === value) return true;
  }
  return false;
}

function folderHasMetaMatch(folderId, key, value) {
  var notes = notesInFolder(folderId);
  for (var i = 0; i < notes.length; i++) {
    if (noteHasMeta(notes[i], key, value)) return true;
  }
  var subs = childFolders(folderId);
  for (var j = 0; j < subs.length; j++) {
    if (folderHasMetaMatch(subs[j].id, key, value)) return true;
  }
  return false;
}

function filterByEmoji(val) {
  EFILT = val || null;
  renderNav();
}

function renderBookmarks() {
  var area = document.getElementById("bookmarks-area");
  if (!BD || HOIST) { area.style.display = "none"; return; }
  var bm = [];
  for (var i = 0; i < BD.notes.length; i++) {
    if (BD.notes[i].bookmarked) bm.push(BD.notes[i]);
  }
  if (bm.length === 0) { area.style.display = "none"; return; }
  bm.sort(function(a, b) { return a.name.localeCompare(b.name, "cs"); });
  area.style.display = "block";
  var h = "";
  for (var j = 0; j < bm.length; j++) {
    var n = bm[j];
    var isActive = (CUR.type === "note" && CUR.id === n.id);
    h += '<li><div class="nav-row"><span class="nav-toggle-placeholder"></span>';
    h += '<a href="#" class="nav-link' + (isActive ? " active" : "") + '" onclick="openNote(\'' + n.id + '\');return false">';
    h += (n.icon || "&#128221;") + " " + esc(n.name) + "</a></div></li>";
  }
  document.getElementById("bookmarks-list").innerHTML = h;
}

function toggleBookmark(noteId) {
  var n = getNote(noteId);
  if (!n) return;
  n.bookmarked = !n.bookmarked;
  renderNav();
  renderNoteView(noteId);
  dbg((n.bookmarked ? "P≈ôid√°no do obl√≠ben√Ωch: " : "Odebr√°no z obl√≠ben√Ωch: ") + n.name);
}

function hoistFolder(folderId) {
  HOIST = folderId;
  EXPANDED[folderId] = true;
  renderNav();
  dbg("Hoist: " + (getFolder(folderId) || {}).name);
}

function unhoist() {
  HOIST = null;
  renderNav();
  dbg("Hoist zru≈°en");
}

function updateTitle() {
  if (!BD) { document.title = "NoteBlock"; return; }
  var t = "NoteBlock \u2013 " + BD.name;
  if (CUR.type === "note" && CUR.id) {
    var n = getNote(CUR.id);
    if (n) t += " | " + (n.icon || "\uD83D\uDCDD") + " " + n.name;
  } else if (CUR.type === "folder" && CUR.id) {
    var f = getFolder(CUR.id);
    if (f) t += " | \uD83D\uDCC1 " + f.name;
  }
  document.title = t;
}

function toggleFolder(folderId) {
  EXPANDED[folderId] = !EXPANDED[folderId];
  renderNav();
}

function renderTags() {
  var tags = allTags();
  var area = document.getElementById("tags-area");
  if (tags.length === 0) { area.style.display = "none"; return; }
  area.style.display = "block";
  var h = "";
  for (var i = 0; i < tags.length; i++) {
    var cls = (STAG === tags[i]) ? "tag-chip active" : "tag-chip";
    h += '<button class="' + cls + '" onclick="filterTag(\'' + esc(tags[i]).replace(/'/g, "\\'") + '\')">' + esc(tags[i]) + "</button>";
  }
  document.getElementById("tags-chips").innerHTML = h;
}

// ===== BREADCRUMB =====
function breadcrumb(folderId) {
  var path = folderPath(folderId);
  var h = '<a href="#" onclick="openRoot();return false">&#127968; ' + esc(BD.name) + "</a>";
  for (var i = 0; i < path.length; i++) {
    h += ' / <a href="#" onclick="openFolder(\'' + path[i].id + '\');return false">' + esc(path[i].name) + "</a>";
  }
  return h;
}

// ===== VIEWS =====
function openRoot() {
  if (!BD) return;
  CUR = { type: "folder", id: null };
  STAG = null; SEDIT = false;
  if (PANELS.length === 0) ACTIVE_PANEL = -1;
  renderNav(); renderTabs(); renderFolderView(null); updateTitle();
}

function openFolder(id) {
  if (!BD) return;
  CUR = { type: "folder", id: id };
  STAG = null; SEDIT = false;
  EXPANDED[id] = true;
  if (PANELS.length === 0) ACTIVE_PANEL = -1;
  renderNav(); renderTabs(); renderFolderView(id); updateTitle();
}

function openNote(id) {
  if (!BD) return;
  if (AE_ACTIVE) { advEd.saveBack(); AE_ACTIVE = false; advEd.noteId = null; advEd.sections = []; }
  if (CM_ACTIVE) { cmRev.saveBack(); CM_ACTIVE = false; cmRev.noteId = null; }
  if (SP_ACTIVE) { SP_ACTIVE = false; spChk.noteId = null; }
  if (TE_ACTIVE) { TE_ACTIVE = false; tblEd.noteId = null; }
  CUR = { type: "note", id: id };
  SEDIT = false;

  // If panels exist, update active panel's note
  if (PANELS.length > 0) {
    if (ACTIVE_PANEL < 0 || ACTIVE_PANEL >= PANELS.length) {
      // Find first null panel, or use last panel
      var found = -1;
      for (var pi = 0; pi < PANELS.length; pi++) { if (!PANELS[pi]) { found = pi; break; } }
      ACTIVE_PANEL = found >= 0 ? found : PANELS.length - 1;
    }
    PANELS[ACTIVE_PANEL] = id;
  }

  renderNav(); renderTabs(); renderNoteView(id); updateTitle();
  refreshPreview(id);
}

function newPanel() {
  // Create new panel with current note (or null)
  var noteId = (CUR.type === "note") ? CUR.id : null;
  if (PANELS.length === 0 && noteId) {
    // First panel: add current note as panel 0, then add empty panel 1
    PANELS.push(noteId);
    PANELS.push(null);
    ACTIVE_PANEL = 1;
  } else {
    PANELS.push(null);
    ACTIVE_PANEL = PANELS.length - 1;
  }
  CUR = { type: "note", id: null };
  renderTabs();
  // Show empty panel
  document.getElementById("toolbar").innerHTML = "";
  document.getElementById("view").innerHTML = '<div class="empty">Otev≈ôete pozn√°mku z navigace.</div>';
  renderNav(); updateTitle();
}

function closeCurrentPanel() {
  if (PANELS.length === 0) return;
  PANELS.splice(ACTIVE_PANEL, 1);
  if (PANELS.length === 0) {
    ACTIVE_PANEL = -1;
    CUR = { type: "folder", id: null };
    renderTabs(); openRoot();
    return;
  }
  if (ACTIVE_PANEL >= PANELS.length) ACTIVE_PANEL = PANELS.length - 1;
  var noteId = PANELS[ACTIVE_PANEL];
  if (noteId) {
    CUR = { type: "note", id: noteId };
    SEDIT = false;
    renderNav(); renderTabs(); renderNoteView(noteId); updateTitle();
  } else {
    CUR = { type: "note", id: null };
    renderTabs();
    document.getElementById("toolbar").innerHTML = "";
    document.getElementById("view").innerHTML = '<div class="empty">Otev≈ôete pozn√°mku z navigace.</div>';
    renderNav(); updateTitle();
  }
}

function switchPanel(idx) {
  if (idx < 0 || idx >= PANELS.length) return;
  ACTIVE_PANEL = idx;
  var noteId = PANELS[idx];
  if (noteId) {
    CUR = { type: "note", id: noteId };
    SEDIT = false;
    renderNav(); renderTabs(); renderNoteView(noteId); updateTitle();
  } else {
    CUR = { type: "note", id: null };
    renderTabs();
    document.getElementById("toolbar").innerHTML = "";
    document.getElementById("view").innerHTML = '<div class="empty">Otev≈ôete pozn√°mku z navigace.</div>';
    renderNav(); updateTitle();
  }
}

function renderTabs() {
  var bar = document.getElementById("tabbar");
  var h = "";
  for (var i = 0; i < PANELS.length; i++) {
    var n = PANELS[i] ? getNote(PANELS[i]) : null;
    var name = n ? ((n.icon || "\uD83D\uDCDD") + " " + esc(n.name)) : "(pr√°zdn√Ω)";
    var sel = (i === ACTIVE_PANEL) ? "true" : "false";
    h += '<button class="tab-item" role="tab" aria-selected="' + sel + '" onclick="switchPanel(' + i + ')" title="' + (n ? esc(n.name) : "Pr√°zdn√Ω panel") + ' (Alt+' + (i + 1) + ')">';
    h += '<span class="tab-label">' + name + '</span>';
    h += '</button>';
  }
  h += '<span class="tab-ctrl">';
  h += '<button onclick="newPanel()" title="Nov√Ω panel">+</button>';
  if (PANELS.length > 0) {
    h += '<button onclick="closeCurrentPanel()" title="Zav≈ô√≠t aktu√°ln√≠ panel">&times;</button>';
  }
  h += '</span>';
  bar.innerHTML = h;
}

// ===== FOLDER VIEW =====
function renderFolderView(folderId) {
  var tb = document.getElementById("toolbar");
  var vw = document.getElementById("view");
  var tbH = "";
  if (folderId) {
    tbH += '<button class="sm" onclick="dlgNewFolder(\'' + folderId + '\')">+ Podslo≈æka</button>';
    tbH += '<button class="sm" onclick="dlgNewNote(\'' + folderId + '\')">+ Pozn√°mka</button>';
    tbH += '<span class="sep"></span>';
    tbH += '<button class="sm" onclick="dlgRenameFolder(\'' + folderId + '\')">&#9998; P≈ôejmenovat</button>';
    tbH += '<button class="sm" onclick="exportFolderMD(\'' + folderId + '\')">&#128203; Export MD</button>';
    tbH += '<button class="sm" onclick="exportFolderDOCX(\'' + folderId + '\')">&#128196; Export DOCX</button>';
    tbH += '<span class="sep"></span>';
    tbH += '<button class="sm" onclick="hoistFolder(\'' + folderId + '\')" accesskey="h">&#128204; Hoist<span class="ak">H</span></button>';
    tbH += '<button class="sm danger" onclick="dlgDeleteFolder(\'' + folderId + '\')">&#128465; Smazat</button>';
  } else {
    tbH += '<button class="sm" onclick="dlgNewFolder()">+ Slo≈æka</button>';
    tbH += '<button class="sm" onclick="dlgNewNote()">+ Pozn√°mka</button>';
  }
  tb.innerHTML = tbH;

  var folders = childFolders(folderId);
  var notes = notesInFolder(folderId);
  var h = '<div id="crumb">' + breadcrumb(folderId) + "</div>";
  if (folderId) {
    var f = getFolder(folderId);
    h += "<h2>&#128193; " + esc(f.name) + "</h2>";
  } else {
    h += "<h2>&#128211; " + esc(BD.name) + "</h2>";
  }

  if (folders.length > 0) {
    h += '<h3 style="margin:16px 0 8px;font-size:.95rem;color:var(--text2)">Slo≈æky</h3>';
    h += '<table class="tbl"><thead><tr><th>N√°zev</th><th>Pozn√°mek</th></tr></thead><tbody>';
    for (var i = 0; i < folders.length; i++) {
      var ff = folders[i];
      h += '<tr><td><a href="#" onclick="openFolder(\'' + ff.id + '\');return false">&#128193; ' + esc(ff.name) + "</a></td>";
      h += "<td>" + countNotes(ff.id) + "</td></tr>";
    }
    h += "</tbody></table>";
  }
  if (notes.length > 0) {
    h += '<h3 style="margin:16px 0 8px;font-size:.95rem;color:var(--text2)">Pozn√°mky</h3>';
    h += '<table class="tbl"><thead><tr><th>N√°zev</th><th>≈†t√≠tky</th><th>Zmƒõnƒõno</th></tr></thead><tbody>';
    for (var j = 0; j < notes.length; j++) {
      var n = notes[j];
      var tags = (n.tags || []).join(", ");
      var mod = n.modified ? new Date(n.modified).toLocaleDateString("cs") : "";
      h += '<tr><td><a href="#" onclick="openNote(\'' + n.id + '\');return false">' + (n.icon || "&#128221;") + " " + esc(n.name) + "</a></td>";
      h += '<td style="font-size:.82rem;color:var(--text2)">' + esc(tags) + "</td>";
      h += '<td style="font-size:.82rem;color:var(--text2)">' + mod + "</td></tr>";
    }
    h += "</tbody></table>";
  }
  if (folders.length === 0 && notes.length === 0) {
    h += '<div class="empty">Slo≈æka je pr√°zdn√°.</div>';
  }
  vw.innerHTML = h;
}

// ===== NOTE VIEW =====
function renderNoteView(noteId) {
  var n = getNote(noteId);
  if (!n) return;

  var tb = document.getElementById("toolbar");
  var tbH = "";
  var bmCls = n.bookmarked ? "bm-star active" : "bm-star";
  tbH += '<button class="' + bmCls + '" onclick="toggleBookmark(\'' + noteId + '\')" accesskey="b" title="Obl√≠ben√© (Alt+B)">&#11088;<span class="ak">B</span></button>';
  tbH += '<button class="sm" onclick="editNote(\'' + noteId + '\')" accesskey="e">&#9998; Upravit<span class="ak">E</span></button>';
  tbH += '<button class="sm" onclick="dlgRenameNote(\'' + noteId + '\')">&#128219; P≈ôejmenovat</button>';
  tbH += '<button class="sm" onclick="dlgNoteTags(\'' + noteId + '\')">&#127991; ≈†t√≠tky</button>';
  tbH += '<button class="sm" onclick="dlgNoteMeta(\'' + noteId + '\')" accesskey="m">&#128203; Metadata<span class="ak">M</span></button>';
  tbH += '<button class="sm" onclick="dlgMoveNote(\'' + noteId + '\')">&#128194; P≈ôesunout</button>';
  tbH += '<button class="sm" onclick="duplicateNote(\'' + noteId + '\')">&#128203; Duplikovat</button>';
  tbH += '<button class="sm" onclick="deleteCompletedTasks(\'' + noteId + '\')">&#9745; Smazat hotov√©</button>';
  tbH += '<button class="sm primary" onclick="openAdvEditor(\'' + noteId + '\')">&#9881; Pokro&#269;il&#253; editor</button>';
  tbH += '<button class="sm" onclick="openCmReview(\'' + noteId + '\')">&#128221; Revize</button>';
  tbH += '<button class="sm" onclick="openSpellcheck(\'' + noteId + '\')">&#128270; Korektor</button>';
  tbH += '<span class="sep"></span>';
  tbH += '<button class="sm" onclick="exportNoteMD(\'' + noteId + '\')">&#128203; MD</button>';
  tbH += '<button class="sm" onclick="exportNoteDOCX(\'' + noteId + '\')" accesskey="x">&#128196; DOC<span class="ak">X</span></button>';
  tbH += '<button class="sm" onclick="copyNoteMD(\'' + noteId + '\')" accesskey="c">&#128206; Kop√≠rovat<span class="ak">C</span></button>';
  tbH += '<span class="sep"></span>';
  tbH += '<button class="sm" onclick="dlgSaveVersion(\'' + noteId + '\')" accesskey="w">&#128190; Verze+<span class="ak">W</span></button>';
  var vcnt = (n.versions && n.versions.length) ? n.versions.length : 0;
  tbH += '<button class="sm" onclick="showVersions(\'' + noteId + '\')" accesskey="r">&#128203; Verze (' + vcnt + ')<span class="ak">R</span></button>';
  tbH += '<button class="sm" onclick="openPreviewWindow(\'' + noteId + '\')" accesskey="i">&#128065; N√°hled<span class="ak">I</span></button>';
  tbH += '<span class="sep"></span>';
  tbH += '<label style="display:inline-flex;align-items:center;gap:4px;font-size:.82rem;cursor:pointer;color:var(--text2)">';
  tbH += '<input type="checkbox" onchange="toggleSectionEdit()" accesskey="d" ' + (SEDIT ? "checked" : "") + ' style="width:auto;accent-color:var(--accent)"> Editace sekc√≠<span class="ak">D</span></label>';
  tbH += '<span class="sep"></span>';
  tbH += '<button class="sm danger" onclick="dlgDeleteNote(\'' + noteId + '\')">&#128465; Smazat</button>';
  tb.innerHTML = tbH;

  var vw = document.getElementById("view");
  var h = '<div id="crumb">' + breadcrumb(n.folderId) + "</div>";
  h += '<h6 style="margin:0 0 4px;font-size:.72rem;text-transform:uppercase;color:var(--text2);letter-spacing:.5px">Pozn√°mka</h6>';
  h += "<h1>" + (n.icon || "&#128221;") + " " + esc(n.name) + "</h1>";

  if (n.tags && n.tags.length) {
    h += '<div style="margin:6px 0 12px">';
    for (var i = 0; i < n.tags.length; i++) {
      h += '<span style="background:var(--tag-bg);padding:2px 8px;border-radius:10px;font-size:.78rem;color:var(--accent);margin-right:4px">' + esc(n.tags[i]) + "</span>";
    }
    h += "</div>";
  }

  // Metadata
  if (n.meta && n.meta.length > 0) {
    h += '<table class="meta-table">';
    for (var mi = 0; mi < n.meta.length; mi++) {
      var mv = n.meta[mi].value;
      var mvH = /^https?:\/\/\S+$/i.test(mv) ? '<a href="' + esc(mv) + '" target="_blank" rel="noopener">' + esc(mv) + '</a>' : esc(mv);
      h += "<tr><td>" + esc(n.meta[mi].key) + "</td><td>" + mvH + "</td></tr>";
    }
    h += "</table>";
  }

  // TOC
  var toc = generateTOC(n.content || "");
  if (toc) h += toc;

  if (SEDIT) {
    h += renderSectionEdit(n);
  } else {
    h += '<div class="md">' + renderMarkdownWithIds(n.content || "", noteId) + "</div>";
  }

  var bl = findBacklinks(noteId);
  var fl = findForwardLinks(noteId);

  // Forward links: URLs, note links, includes
  if (fl.urls.length > 0 || fl.noteLinks.length > 0 || fl.includes.length > 0) {
    h += '<div class="backlinks">';
    if (fl.urls.length > 0) {
      h += "<h3>&#127760; Obsa≈æen√© odkazy (" + fl.urls.length + ")</h3><ul>";
      for (var ui = 0; ui < fl.urls.length; ui++) {
        h += '<li><a href="' + esc(fl.urls[ui]) + '" target="_blank" rel="noopener">' + esc(fl.urls[ui]) + "</a></li>";
      }
      h += "</ul>";
    }
    if (fl.noteLinks.length > 0) {
      h += "<h3>&#128279; Odkazuje na pozn√°mky (" + fl.noteLinks.length + ")</h3><ul>";
      for (var ni = 0; ni < fl.noteLinks.length; ni++) {
        var ln = fl.noteLinks[ni];
        h += '<li><a href="#" onclick="openNote(\'' + ln.id + '\');return false">' + (ln.icon || "&#128221;") + " " + esc(ln.name) + "</a></li>";
      }
      h += "</ul>";
    }
    if (fl.includes.length > 0) {
      h += "<h3>&#128206; Obsahuje vno≈ôen√© (" + fl.includes.length + ")</h3><ul>";
      for (var fi = 0; fi < fl.includes.length; fi++) {
        var ind = fl.includes[fi], inn = ind.note;
        var indent = ind.depth > 0 ? ' style="margin-left:' + (ind.depth * 16) + 'px"' : "";
        h += '<li' + indent + '><a href="#" onclick="openNote(\'' + inn.id + '\');return false">' + (inn.icon || "&#128221;") + " " + esc(inn.name) + "</a></li>";
      }
      h += "</ul>";
    }
    h += "</div>";
  }

  // Backlinks
  if (bl.links.length > 0 || bl.includes.length > 0) {
    h += '<div class="backlinks">';
    if (bl.links.length > 0) {
      h += "<h3>&#8617; Odkazuje sem</h3><ul>";
      for (var li = 0; li < bl.links.length; li++) {
        var bn = getNote(bl.links[li]);
        if (bn) h += '<li><a href="#" onclick="openNote(\'' + bn.id + '\');return false">' + (bn.icon || "&#128221;") + " " + esc(bn.name) + "</a></li>";
      }
      h += "</ul>";
    }
    if (bl.includes.length > 0) {
      h += "<h3>&#128206; Vkl√°d√° tuto pozn√°mku</h3><ul>";
      for (var ii = 0; ii < bl.includes.length; ii++) {
        var bn2 = getNote(bl.includes[ii]);
        if (bn2) h += '<li><a href="#" onclick="openNote(\'' + bn2.id + '\');return false">' + (bn2.icon || "&#128221;") + " " + esc(bn2.name) + "</a></li>";
      }
      h += "</ul>";
    }
    h += "</div>";
  }

  // CriticMarkup koment√°≈ôe
  var cmComments = extractCriticComments(n.content || "");
  if (cmComments.length > 0) {
    h += '<div class="backlinks">';
    h += "<h3>&#128172; Koment√°≈ôe (" + cmComments.length + ")</h3><ul style=\"list-style:none;padding:0\">";
    for (var ci = 0; ci < cmComments.length; ci++) {
      h += '<li style="margin:4px 0;padding:4px 0;border-bottom:1px solid var(--border)"><span class="cm-cmt">' + esc(cmComments[ci].text) + "</span>";
      if (cmComments[ci].heading) h += ' <span style="font-size:.78rem;color:var(--text2)">‚Äî ' + esc(cmComments[ci].heading) + "</span>";
      h += "</li>";
    }
    h += "</ul></div>";
  }

  vw.innerHTML = h;
  bindTaskCheckboxes(noteId);
}

function findBacklinks(noteId) {
  var n = getNote(noteId);
  if (!n) return { links: [], includes: [] };
  var name = n.name.toLowerCase();
  var links = [], includes = [];
  for (var i = 0; i < BD.notes.length; i++) {
    var other = BD.notes[i];
    if (other.id === noteId || !other.content) continue;
    var c = other.content.toLowerCase();
    if (c.indexOf("[[" + name + "]]") !== -1) links.push(other.id);
    if (c.indexOf("{{" + name + "}}") !== -1) includes.push(other.id);
  }
  return { links: links, includes: includes };
}

function extractCriticComments(content) {
  var comments = [];
  var lines = content.split("\n");
  var inCode = false;
  var curHeading = "";
  for (var i = 0; i < lines.length; i++) {
    if (lines[i].match(/^```/)) { inCode = !inCode; continue; }
    if (inCode) continue;
    var hm = lines[i].match(/^#{1,6}\s+(.+)/);
    if (hm) curHeading = hm[1];
    var re = /\{>>(.+?)<<\}/g;
    var m;
    while ((m = re.exec(lines[i])) !== null) {
      comments.push({ text: m[1], heading: curHeading });
    }
  }
  return comments;
}

function resolveIncludes(content, depth, seen) {
  if (!content) return "";
  depth = depth || 0;
  seen = seen || {};
  if (depth > 10) return "";
  return content.replace(/\{\{(.+?)\}\}/g, function(match, name) {
    var inc = findNoteByName(name.trim());
    if (!inc) return "";
    if (seen[inc.id]) return ""; // circular include protection
    seen[inc.id] = true;
    return resolveIncludes(inc.content || "", depth + 1, seen);
  });
}

function findForwardLinks(noteId) {
  var n = getNote(noteId);
  if (!n || !n.content) return { urls: [], noteLinks: [], includes: [] };
  var content = n.content;

  // External URLs
  var urls = [], urlSet = {};
  var urlRe = /https?:\/\/[^\s\)\]\}<>\"]+/g;
  var m;
  while ((m = urlRe.exec(content)) !== null) {
    var u = m[0].replace(/[.,;:!?)]+$/, ""); // trim trailing punctuation
    if (!urlSet[u]) { urlSet[u] = true; urls.push(u); }
  }

  // Internal note links [[name]]
  var noteLinks = [], nlSet = {};
  var nlRe = /\[\[(.+?)\]\]/g;
  while ((m = nlRe.exec(content)) !== null) {
    var lname = m[1].trim();
    var linked = findNoteByName(lname);
    if (linked && !nlSet[linked.id]) { nlSet[linked.id] = true; noteLinks.push(linked); }
  }

  // Includes {{name}} ‚Äî also recursive
  var includes = [], incSet = {};
  function collectIncludes(cnt, depth) {
    if (!cnt || depth > 10) return;
    var incRe = /\{\{(.+?)\}\}/g;
    var im;
    while ((im = incRe.exec(cnt)) !== null) {
      var iname = im[1].trim();
      var inc = findNoteByName(iname);
      if (inc && !incSet[inc.id]) {
        incSet[inc.id] = true;
        includes.push({ note: inc, depth: depth });
        collectIncludes(inc.content || "", depth + 1);
      }
    }
  }
  collectIncludes(content, 0);

  return { urls: urls, noteLinks: noteLinks, includes: includes };
}

// ===== TABLE EDITOR =====
function findMarkdownTables(content) {
  if (!content) return [];
  var lines = content.split("\n");
  var tables = [], i = 0;
  while (i < lines.length) {
    var line = lines[i].trim();
    if (line.charAt(0) === "|" && i + 1 < lines.length) {
      var sepLine = lines[i + 1].trim();
      if (/^\|[\s\-\|:]+\|?\s*$/.test(sepLine)) {
        var startLine = i, dataStart = i + 2, j = dataStart;
        while (j < lines.length && lines[j].trim().charAt(0) === "|") j++;
        tables.push({ startLine: startLine, endLine: j - 1, sepIdx: i + 1, dataStart: dataStart, dataEnd: j - 1 });
        i = j; continue;
      }
    }
    i++;
  }
  return tables;
}

function parseTableRow(line) {
  var t = line.trim();
  if (t.charAt(0) === "|") t = t.substring(1);
  if (t.charAt(t.length - 1) === "|") t = t.substring(0, t.length - 1);
  var cells = t.split("|");
  for (var i = 0; i < cells.length; i++) cells[i] = cells[i].trim();
  return cells;
}

function buildTableRow(cells) {
  return "| " + cells.join(" | ") + " |";
}

var TE_ACTIVE = false;
var tblEd = {
  noteId: null,
  tableIdx: null,
  origContent: null,
  header: [],
  sepLine: "",
  rows: [],
  colCount: 0,
  editingCell: null,

  open: function(noteId, tableIdx) {
    var n = getNote(noteId);
    if (!n) return;
    this.noteId = noteId;
    this.tableIdx = tableIdx;
    this.origContent = n.content;
    this.editingCell = null;

    var tables = findMarkdownTables(n.content || "");
    if (tableIdx >= tables.length) { alert("Tabulka nenalezena."); return; }
    var tbl = tables[tableIdx];
    var lines = n.content.split("\n");

    this.header = parseTableRow(lines[tbl.startLine]);
    this.sepLine = lines[tbl.sepIdx];
    this.colCount = this.header.length;
    this.rows = [];
    for (var i = tbl.dataStart; i <= tbl.dataEnd; i++) {
      var cells = parseTableRow(lines[i]);
      while (cells.length < this.colCount) cells.push("");
      this.rows.push(cells);
    }

    TE_ACTIVE = true;
    this.render();
    dbg("Editor tabulky otev≈ôen: tabulka " + (tableIdx + 1) + ", " + this.rows.length + " ≈ô√°dk≈Ø, " + this.colCount + " sloupc≈Ø");
  },

  close: function() {
    TE_ACTIVE = false;
    this.noteId = null; this.tableIdx = null; this.origContent = null;
    this.header = []; this.rows = []; this.editingCell = null;
    if (CUR.type === "note" && CUR.id) renderNoteView(CUR.id);
  },

  cancel: function() {
    if (this.origContent !== null && this.noteId) {
      var n = getNote(this.noteId);
      if (n) n.content = this.origContent;
    }
    this.close();
    dbg("Editor tabulky: zmƒõny zru≈°eny");
  },

  save: function() {
    if (!this.noteId) return;
    var n = getNote(this.noteId);
    if (!n) return;
    var tables = findMarkdownTables(this.origContent || "");
    if (this.tableIdx >= tables.length) return;
    var tbl = tables[this.tableIdx];
    var lines = this.origContent.split("\n");

    var newLines = [];
    for (var i = 0; i < lines.length; i++) {
      if (i === tbl.dataStart) {
        for (var r = 0; r < this.rows.length; r++) {
          newLines.push(buildTableRow(this.rows[r]));
        }
        i = tbl.dataEnd;
      } else {
        newLines.push(lines[i]);
      }
    }
    n.content = newLines.join("\n");
    n.modified = now();
    this.close();
    renderNav();
    dbg("Tabulka ulo≈æena: " + this.rows.length + " ≈ô√°dk≈Ø");
  },

  moveUp: function(ri) {
    if (ri < 1) return;
    var tmp = this.rows[ri];
    this.rows[ri] = this.rows[ri - 1];
    this.rows[ri - 1] = tmp;
    this.editingCell = null;
    this.render();
  },

  moveDown: function(ri) {
    if (ri >= this.rows.length - 1) return;
    var tmp = this.rows[ri];
    this.rows[ri] = this.rows[ri + 1];
    this.rows[ri + 1] = tmp;
    this.editingCell = null;
    this.render();
  },

  insertBelow: function(ri) {
    var newRow = [];
    for (var c = 0; c < this.colCount; c++) newRow.push("");
    this.rows.splice(ri + 1, 0, newRow);
    this.editingCell = null;
    this.render();
  },

  deleteRow: function(ri) {
    if (this.rows.length <= 1) return;
    this.rows.splice(ri, 1);
    this.editingCell = null;
    this.render();
  },

  editCell: function(ri, ci) {
    this.editingCell = { r: ri, c: ci };
    this.render();
    var inp = document.getElementById("te-cell-input");
    if (inp) { inp.focus(); inp.select(); }
  },

  saveCell: function() {
    if (!this.editingCell) return;
    var inp = document.getElementById("te-cell-input");
    if (inp) this.rows[this.editingCell.r][this.editingCell.c] = inp.value;
    this.editingCell = null;
    this.render();
  },

  cancelCell: function() {
    this.editingCell = null;
    this.render();
  },

  _cellKeydown: function(e) {
    if (e.key === "Enter") { e.preventDefault(); tblEd.saveCell(); }
    else if (e.key === "Escape") { e.preventDefault(); tblEd.cancelCell(); }
  },

  render: function() {
    var tb = document.getElementById("toolbar");
    var vw = document.getElementById("view");
    if (!tb || !vw) return;

    var n = getNote(this.noteId);
    var nName = n ? esc(n.name) : "";

    var tbH = '<button class="sm" onclick="tblEd.cancel()">&#11013; Zpƒõt beze zmƒõn</button>';
    tbH += '<span class="sep"></span>';
    tbH += '<button class="sm primary" onclick="tblEd.save()">&#128190; Ulo≈æit tabulku</button>';
    tb.innerHTML = tbH;

    var h = '<div class="te-wrap">';
    h += '<h6 style="margin:0 0 4px;font-size:.72rem;text-transform:uppercase;color:var(--text2);letter-spacing:.5px">Editor tabulky</h6>';
    h += '<h2 style="margin:0 0 8px;font-size:1.05rem">&#9998; ' + nName + ' ‚Äî tabulka ' + (this.tableIdx + 1) + '</h2>';

    h += '<table class="te-tbl"><thead><tr>';
    h += '<th class="te-row-acts">#</th>';
    for (var c = 0; c < this.colCount; c++) {
      h += '<th>' + esc(this.header[c] || "") + '</th>';
    }
    h += '<th class="te-row-acts">Akce</th>';
    h += '</tr></thead><tbody>';

    for (var r = 0; r < this.rows.length; r++) {
      h += '<tr>';
      h += '<td class="te-row-acts">' + (r + 1) + '</td>';
      for (var ci = 0; ci < this.colCount; ci++) {
        h += '<td>';
        if (this.editingCell && this.editingCell.r === r && this.editingCell.c === ci) {
          h += '<div class="te-cell-edit">';
          h += '<input id="te-cell-input" value="' + this._escA(this.rows[r][ci]) + '" onkeydown="tblEd._cellKeydown(event)">';
          h += '<button class="te-btn-cell" onclick="tblEd.saveCell()" title="Ulo≈æit (Enter)">&#10003;</button>';
          h += '<button class="te-btn-cell" onclick="tblEd.cancelCell()" title="Zru≈°it (Esc)">&#10007;</button>';
          h += '</div>';
        } else {
          h += '<div class="te-cell">';
          h += '<span class="te-cell-val">' + esc(this.rows[r][ci]) + '</span>';
          h += '<button class="te-btn-cell" onclick="tblEd.editCell(' + r + ',' + ci + ')" title="Upravit bu≈àku">&#9998;</button>';
          h += '</div>';
        }
        h += '</td>';
      }
      h += '<td class="te-row-acts">';
      h += '<button onclick="tblEd.moveUp(' + r + ')"' + (r === 0 ? " disabled" : "") + ' title="Nahoru">&#9650;</button>';
      h += '<button onclick="tblEd.moveDown(' + r + ')"' + (r === this.rows.length - 1 ? " disabled" : "") + ' title="Dol≈Ø">&#9660;</button>';
      h += '<button onclick="tblEd.insertBelow(' + r + ')" title="Vlo≈æit ≈ô√°dek pod">&#10133;</button>';
      h += '<button onclick="tblEd.deleteRow(' + r + ')"' + (this.rows.length <= 1 ? " disabled" : "") + ' title="Smazat ≈ô√°dek">&#128465;</button>';
      h += '</td>';
      h += '</tr>';
    }
    h += '</tbody></table>';
    h += '<p class="te-info">≈ò√°dk≈Ø: ' + this.rows.length + ' | Sloupc≈Ø: ' + this.colCount + ' | Klik na &#9998; pro editaci bu≈àky, Enter pro ulo≈æen√≠, Esc pro zru≈°en√≠</p>';
    h += '</div>';
    vw.innerHTML = h;
  },

  _escA: function(s) { return s.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
};

// ===== SECTION EDIT =====
function toggleSectionEdit() {
  SEDIT = !SEDIT;
  if (CUR.type === "note") renderNoteView(CUR.id);
}

// ===== TOC =====
function slugify(text) {
  return text.toLowerCase().replace(/[^a-z0-9√°ƒçƒè√©ƒõ√≠≈à√≥≈ô≈°≈•√∫≈Ø√Ω≈æ]+/gi, "-").replace(/(^-|-$)/g, "");
}

function generateTOC(content) {
  if (!content) return "";
  var lines = content.split("\n");
  var headings = [];
  var inCode = false;
  for (var i = 0; i < lines.length; i++) {
    if (lines[i].match(/^```/)) { inCode = !inCode; continue; }
    if (inCode) continue;
    var m = lines[i].match(/^(#{1,6})\s+(.+)/);
    if (m) headings.push({ level: m[1].length, text: m[2] });
  }
  if (headings.length < 2) return "";
  var minLevel = 6;
  for (var j = 0; j < headings.length; j++) {
    if (headings[j].level < minLevel) minLevel = headings[j].level;
  }
  var h = '<div class="note-toc"><h3>Obsah</h3>';
  var curDepth = 0;
  for (var k = 0; k < headings.length; k++) {
    var targetDepth = headings[k].level - minLevel + 1;
    while (curDepth < targetDepth) { h += "<ul>"; curDepth++; }
    while (curDepth > targetDepth) { h += "</ul>"; curDepth--; }
    var slug = slugify(headings[k].text) + "-" + k;
    h += '<li><a href="#toc-' + slug + '">' + esc(headings[k].text) + "</a></li>";
  }
  while (curDepth > 0) { h += "</ul>"; curDepth--; }
  h += "</div>";
  return h;
}

function renderMarkdownWithIds(src, noteId) {
  var html = renderMarkdown(src, noteId);
  var lines = (src || "").split("\n");
  var headings = [];
  var inCode = false;
  for (var i = 0; i < lines.length; i++) {
    if (lines[i].match(/^```/)) { inCode = !inCode; continue; }
    if (inCode) continue;
    var m = lines[i].match(/^(#{1,6})\s+(.+)/);
    if (m) headings.push({ level: m[1].length, text: m[2] });
  }
  var headingIdx = 0;
  html = html.replace(/<h([1-6])([^>]*)>/g, function(match, level, attrs) {
    var slug = headingIdx < headings.length ? slugify(headings[headingIdx].text) + "-" + headingIdx : "h-" + headingIdx;
    headingIdx++;
    return '<h' + level + attrs + ' id="toc-' + slug + '">';
  });
  return html;
}

function renderSectionEdit(note) {
  var sections = splitSections(note.content || "");
  var tables = findMarkdownTables(note.content || "");
  var h = "";
  var globalTblIdx = 0;
  for (var i = 0; i < sections.length; i++) {
    var sec = sections[i];
    h += '<div style="border:1px solid var(--border);border-radius:6px;margin:8px 0;padding:10px">';
    h += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">';
    h += '<strong style="font-size:.88rem;color:var(--text2)">' + (sec.heading ? esc(sec.heading) : "√övod") + "</strong>";
    h += '<button class="sec-edit-btn" onclick="editSection(' + i + ')" aria-label="Upravit sekci: ' + esc(sec.heading || "√övod").replace(/^#+\s*/, "") + '">&#9998; Upravit</button>';
    h += "</div>";
    var mdHtml = renderMarkdown(sec.content, note.id);
    // Inject table edit buttons
    if (tables.length > globalTblIdx) {
      var tIdx = globalTblIdx;
      mdHtml = mdHtml.replace(/<\/table>/g, function() {
        var btn = '<div style="margin:4px 0"><button class="sec-edit-btn" onclick="tblEd.open(\'' + note.id + '\',' + tIdx + ')" title="Upravit tabulku ' + (tIdx + 1) + '">&#9998; Upravit tabulku</button></div>';
        tIdx++;
        return '</table>' + btn;
      });
      globalTblIdx = tIdx;
    }
    h += '<div class="md">' + mdHtml + "</div></div>";
  }
  return h;
}

function splitSections(content) {
  var lines = content.split("\n");
  var sections = [];
  var current = { heading: "", content: "" };
  for (var i = 0; i < lines.length; i++) {
    var m = lines[i].match(/^(#{1,6})\s+(.+)/);
    if (m && i > 0) {
      sections.push(current);
      current = { heading: lines[i], content: lines[i] + "\n" };
    } else {
      current.content += lines[i] + "\n";
    }
  }
  sections.push(current);
  return sections;
}

function editSection(idx) {
  var n = getNote(CUR.id);
  if (!n) return;
  var sections = splitSections(n.content || "");
  if (idx >= sections.length) return;
  showDialog(
    "Upravit sekci",
    '<label>Obsah:</label><textarea id="dlg-sec-content" rows="12">' + esc(sections[idx].content.replace(/\n$/, "")) + "</textarea>",
    function() {
      var val = document.getElementById("dlg-sec-content").value;
      sections[idx].content = val + "\n";
      var nc = "";
      for (var i = 0; i < sections.length; i++) nc += sections[i].content;
      n.content = nc;
      n.modified = now();
      closeDialog();
      renderNoteView(CUR.id);
      renderNav();
      refreshPreview(CUR.id);
    }
  );
  // Accesskey S na tlaƒç√≠tku Ulo≈æit v dialogu sekce
  var okBtn = document.getElementById("dlg-ok");
  if (okBtn) okBtn.setAttribute("accesskey", "u");
}

// ===== EDIT NOTE (full, no formatting toolbar) =====
function editNote(noteId) {
  var n = getNote(noteId);
  if (!n) return;

  document.getElementById("toolbar").innerHTML = "";
  var vw = document.getElementById("view");
  var h = '<div id="crumb">' + breadcrumb(n.folderId) + "</div>";
  h += "<h2>&#9998; √öprava: " + esc(n.name) + "</h2>";
  h += '<textarea id="note-editor" rows="28">' + esc(n.content || "") + "</textarea>";
  h += '<div style="display:flex;gap:6px;margin-top:10px">';
  h += '<button class="primary" onclick="saveNoteEdit(\'' + noteId + '\')" accesskey="u">&#128190; Ulo≈æit<span class="ak">U</span></button>';
  h += '<button onclick="openNote(\'' + noteId + '\')">Zru≈°it (Esc)</button>';
  h += "</div>";
  vw.innerHTML = h;

  var ta = document.getElementById("note-editor");
  ta.focus();
  ta.addEventListener("keydown", function(e) {
    if (e.key === "Tab") {
      e.preventDefault();
      var s = this.selectionStart;
      var en = this.selectionEnd;
      this.value = this.value.substring(0, s) + "\t" + this.value.substring(en);
      this.selectionStart = this.selectionEnd = s + 1;
    }
  });
}

function saveNoteEdit(noteId) {
  var n = getNote(noteId);
  if (!n) return;
  var ta = document.getElementById("note-editor");
  if (!ta) return;
  n.content = ta.value;
  n.modified = now();
  openNote(noteId);
  renderNav();
  dbg("Pozn√°mka ulo≈æena: " + n.name);
}

// ===== TASK CHECKBOXES =====
function bindTaskCheckboxes(noteId) {
  var cbs = document.querySelectorAll('.task-cb[data-note="' + noteId + '"]');
  for (var ci = 0; ci < cbs.length; ci++) {
    (function(cb) {
      cb.addEventListener("change", function() {
        var n = getNote(noteId);
        if (!n) return;
        var idx = parseInt(this.dataset.idx, 10);
        var lines = n.content.split("\n");
        var taskCount = 0;
        for (var i = 0; i < lines.length; i++) {
          if (/^- \[[ x]\]/.test(lines[i])) {
            if (taskCount === idx) {
              if (cb.checked) lines[i] = lines[i].replace("- [ ]", "- [x]");
              else lines[i] = lines[i].replace("- [x]", "- [ ]");
              break;
            }
            taskCount++;
          }
        }
        n.content = lines.join("\n");
        n.modified = now();
        renderNoteView(noteId);
        renderNav();
        refreshPreview(noteId);
      });
    })(cbs[ci]);
  }
}

function deleteCompletedTasks(noteId) {
  var n = getNote(noteId);
  if (!n || !n.content) return;
  var lines = n.content.split("\n");
  var filtered = [];
  var removed = 0;
  for (var i = 0; i < lines.length; i++) {
    if (/^- \[x\] /.test(lines[i])) {
      removed++;
    } else {
      filtered.push(lines[i]);
    }
  }
  if (removed === 0) {
    alert("≈Ω√°dn√© hotov√© √∫koly k smaz√°n√≠.");
    return;
  }
  if (!confirm("Smazat " + removed + " hotov√Ω" + (removed === 1 ? " √∫kol" : removed < 5 ? "√© √∫koly" : "ch √∫kol≈Ø") + "?")) return;
  n.content = filtered.join("\n");
  n.modified = now();
  renderNoteView(noteId);
  renderNav();
  refreshPreview(noteId);
  dbg("Smaz√°no " + removed + " hotov√Ωch √∫kol≈Ø z: " + n.name);
}

// ===== MARKDOWN RENDERING =====
function renderMarkdown(src, noteId, depth, seen) {
  if (!src) return "";
  depth = depth || 0;
  seen = seen || {};
  if (depth > 10) return "<em>(p≈ô√≠li≈° hlubok√© vno≈ôen√≠)</em>";

  src = src.replace(/\{\{(.+?)\}\}/g, function(match, name) {
    var inc = findNoteByName(name.trim());
    if (!inc) return '<em style="color:var(--danger)">[Include nenalezeno: ' + esc(name) + "]</em>";
    if (seen[inc.id]) return '<em style="color:var(--danger)">[Cyklick√Ω include: ' + esc(name) + "]</em>";
    var newSeen = {}; for (var k in seen) newSeen[k] = true; newSeen[inc.id] = true;
    return renderMarkdown(inc.content || "", inc.id, depth + 1, newSeen);
  });

  var placeholders = [];
  var phCounter = 0;
  function addPH(html) {
    var key = "XYZPH" + phCounter + "ZYX";
    placeholders.push({ key: key, html: html });
    phCounter++;
    return key;
  }

  src = src.replace(/\{~~(.+?)~>(.+?)~~\}/g, function(m, o, n) {
    return addPH("<del>" + esc(o) + "</del><ins>" + esc(n) + "</ins>");
  });
  src = src.replace(/\{\+\+(.+?)\+\+\}/g, function(m, t) {
    return addPH("<ins>" + esc(t) + "</ins>");
  });
  src = src.replace(/\{--(.+?)--\}/g, function(m, t) {
    return addPH("<del>" + esc(t) + "</del>");
  });
  src = src.replace(/\{==(.+?)==\}/g, function(m, t) {
    return addPH("<mark>" + esc(t) + "</mark>");
  });
  src = src.replace(/\{>>(.+?)<<\}/g, function(m, t) {
    return addPH('<span class="cm-cmt">[koment√°≈ô: ' + esc(t) + "]</span>");
  });

  src = src.replace(/\[\[(.+?)\]\]/g, function(m, name) {
    var linked = findNoteByName(name.trim());
    if (linked) {
      return addPH('<a href="#" class="wlink" onclick="openNote(\'' + linked.id + "');return false\">" + esc(name) + "</a>");
    } else {
      return addPH('<span class="wlink-broken" title="Pozn√°mka nenalezena">' + esc(name) + "</span>");
    }
  });

  var taskIdx = 0;
  src = src.replace(/^- \[( |x)\] (.*)$/gm, function(m, check, text) {
    var checked = check === "x";
    var html = '<label style="display:flex;align-items:baseline;gap:0">' +
      '<input type="checkbox" class="task-cb" data-note="' + (noteId || "") + '" data-idx="' + taskIdx + '"' + (checked ? " checked" : "") + ">" +
      "<span" + (checked ? ' class="task-done"' : "") + ">" + esc(text) + "</span></label>";
    taskIdx++;
    return addPH(html);
  });

  var html;
  try { html = marked.parse(src); }
  catch (e) { dbg("Marked error: " + e.message); html = "<pre>" + esc(src) + "</pre>"; }

  for (var i = 0; i < placeholders.length; i++) {
    html = html.split(placeholders[i].key).join(placeholders[i].html);
  }
  // External links open in new window
  html = html.replace(/<a href="(https?:\/\/)/g, '<a target="_blank" rel="noopener" href="$1');
  return html;
}

// ===== DIALOGS =====
function showDialog(title, bodyHTML, onOk, okLabel) {
  closeDialog();
  var overlay = document.createElement("div");
  overlay.className = "dlg-overlay";
  overlay.id = "dlg-current";
  overlay.addEventListener("click", function(e) {
    if (e.target === overlay) closeDialog();
  });
  var dlg = document.createElement("div");
  dlg.className = "dlg";
  dlg.innerHTML = "<h2>" + title + "</h2>" + bodyHTML +
    '<div class="btn-row"><button onclick="closeDialog()">Zru≈°it</button>' +
    '<button class="primary" id="dlg-ok">' + (okLabel || "OK") + "</button></div>";
  overlay.appendChild(dlg);
  document.body.appendChild(overlay);
  document.getElementById("dlg-ok").addEventListener("click", onOk);
  document.addEventListener("keydown", dlgKeyHandler);
  var fi = dlg.querySelector("input,textarea,select");
  if (fi) setTimeout(function() { fi.focus(); }, 50);
}

function dlgKeyHandler(e) {
  if (e.key === "Escape") closeDialog();
  if (e.key === "Enter" && e.target.tagName !== "TEXTAREA") {
    var ok = document.getElementById("dlg-ok");
    if (ok) ok.click();
  }
}

function closeDialog() {
  var d = document.getElementById("dlg-current");
  if (d) d.remove();
  document.removeEventListener("keydown", dlgKeyHandler);
}

function folderSelectHTML(selectedId, excludeId, label) {
  label = label || "Slo≈æka";
  var h = "<label>" + label + ':</label><select id="dlg-folder">';
  h += '<option value="">(ko≈ôen)</option>';
  function addOpts(parentId, indent) {
    var ff = childFolders(parentId);
    for (var i = 0; i < ff.length; i++) {
      if (ff[i].id === excludeId) continue;
      var sel = ff[i].id === selectedId ? " selected" : "";
      h += '<option value="' + ff[i].id + '"' + sel + ">" + indent + esc(ff[i].name) + "</option>";
      addOpts(ff[i].id, indent + "\u2014 ");
    }
  }
  addOpts(null, "");
  h += "</select>";
  return h;
}

function emojiPickerHTML(selected) {
  var emojis = getEmojis();
  var h = '<label>Ikona:</label><div class="emoji-grid">';
  for (var i = 0; i < emojis.length; i++) {
    var cls = emojis[i] === selected ? "emoji-btn sel" : "emoji-btn";
    h += '<button type="button" class="' + cls + '" onclick="pickEmoji(this)" data-emoji="' + emojis[i] + '">' + emojis[i] + "</button>";
  }
  h += '</div><input type="hidden" id="dlg-icon" value="' + (selected || emojis[0] || "") + '">';
  return h;
}

function pickEmoji(btn) {
  var emoji = btn.dataset.emoji;
  var btns = btn.parentElement.querySelectorAll(".emoji-btn");
  for (var i = 0; i < btns.length; i++) btns[i].classList.remove("sel");
  btn.classList.add("sel");
  document.getElementById("dlg-icon").value = emoji;
}

// ===== NEW FOLDER =====
function dlgNewFolder(parentId) {
  if (!BD) { newBlock(); return; }
  var defParent = parentId || (CUR.type === "folder" ? CUR.id : "") || "";
  var h = '<label>N√°zev slo≈æky:</label><input id="dlg-name" placeholder="N√°zev">';
  h += folderSelectHTML(defParent, null, "Nad≈ôazen√° slo≈æka");
  showDialog("Nov√° slo≈æka", h, function() {
    var name = document.getElementById("dlg-name").value.trim();
    var parent = document.getElementById("dlg-folder").value || null;
    if (!name) return alert("Zadejte n√°zev.");
    if (folderNameExists(name, parent, null)) return alert("Slo≈æka s t√≠mto n√°zvem ji≈æ existuje.");
    BD.folders.push({ id: genId(), name: name, parentId: parent });
    closeDialog();
    if (CUR.type === "folder") openFolder(CUR.id);
    else openRoot();
    dbg("Slo≈æka vytvo≈ôena: " + name);
  });
}

// ===== NEW NOTE =====
function dlgNewNote(folderId) {
  if (!BD) { newBlock(); return; }
  var fid = folderId || (CUR.type === "folder" ? CUR.id : "") || "";
  var h = '<label>N√°zev pozn√°mky:</label><input id="dlg-name" placeholder="N√°zev">';
  h += folderSelectHTML(fid, null, "Slo≈æka");
  h += emojiPickerHTML(getEmojis()[0] || "");
  showDialog("Nov√° pozn√°mka", h, function() {
    var name = document.getElementById("dlg-name").value.trim();
    var folder = document.getElementById("dlg-folder").value || null;
    var icon = document.getElementById("dlg-icon").value;
    if (!name) return alert("Zadejte n√°zev.");
    if (noteNameExists(name, null)) return alert("Pozn√°mka s t√≠mto n√°zvem ji≈æ existuje.");
    var n = { id: genId(), name: name, folderId: folder, icon: icon, content: "", tags: [], meta: [], bookmarked: false, versions: [], created: now(), modified: now() };
    BD.notes.push(n);
    closeDialog();
    openNote(n.id);
    editNote(n.id);
    dbg("Pozn√°mka vytvo≈ôena: " + name);
  });
}

// ===== RENAME FOLDER =====
function dlgRenameFolder(folderId) {
  var f = getFolder(folderId);
  if (!f) return;
  var excludeIds = [folderId].concat(allDescFolderIds(folderId));
  var h = '<label>N√°zev:</label><input id="dlg-name" value="' + esc(f.name) + '">';
  h += '<label>Nad≈ôazen√° slo≈æka:</label><select id="dlg-folder">';
  h += '<option value="">(ko≈ôen)</option>';
  function addOpts(parentId, indent) {
    var ff = childFolders(parentId);
    for (var i = 0; i < ff.length; i++) {
      if (excludeIds.indexOf(ff[i].id) !== -1) continue;
      var sel = ff[i].id === f.parentId ? " selected" : "";
      h += '<option value="' + ff[i].id + '"' + sel + ">" + indent + esc(ff[i].name) + "</option>";
      addOpts(ff[i].id, indent + "\u2014 ");
    }
  }
  addOpts(null, "");
  h += "</select>";
  showDialog("P≈ôejmenovat slo≈æku", h, function() {
    var name = document.getElementById("dlg-name").value.trim();
    var parent = document.getElementById("dlg-folder").value || null;
    if (!name) return alert("Zadejte n√°zev.");
    if (folderNameExists(name, parent, folderId)) return alert("Slo≈æka s t√≠mto n√°zvem ji≈æ existuje.");
    f.name = name;
    f.parentId = parent;
    closeDialog();
    openFolder(folderId);
    dbg("Slo≈æka p≈ôejmenov√°na: " + name);
  });
}

// ===== DELETE FOLDER =====
function dlgDeleteFolder(folderId) {
  var f = getFolder(folderId);
  if (!f) return;
  var descIds = allDescFolderIds(folderId);
  var allIds = [folderId].concat(descIds);
  var noteCount = 0;
  for (var k = 0; k < allIds.length; k++) noteCount += notesInFolder(allIds[k]).length;
  var h = "<p>Opravdu smazat slo≈æku <strong>" + esc(f.name) + "</strong>?</p>";
  if (descIds.length > 0) h += "<p>Bude smaz√°no i <strong>" + descIds.length + " podslo≈æek</strong>.</p>";
  if (noteCount > 0) h += "<p>Bude smaz√°no <strong>" + noteCount + " pozn√°mek</strong>.</p>";
  showDialog("Smazat slo≈æku", h, function() {
    BD.notes = BD.notes.filter(function(n) { return allIds.indexOf(n.folderId) === -1; });
    BD.folders = BD.folders.filter(function(ff) { return allIds.indexOf(ff.id) === -1; });
    closeDialog();
    if (f.parentId) openFolder(f.parentId);
    else openRoot();
    dbg("Slo≈æka smaz√°na: " + f.name);
  }, "Smazat");
}

// ===== RENAME NOTE =====
function dlgRenameNote(noteId) {
  var n = getNote(noteId);
  if (!n) return;
  var h = '<label>N√°zev:</label><input id="dlg-name" value="' + esc(n.name) + '">';
  h += emojiPickerHTML(n.icon || getEmojis()[0] || "");
  showDialog("P≈ôejmenovat pozn√°mku", h, function() {
    var name = document.getElementById("dlg-name").value.trim();
    var icon = document.getElementById("dlg-icon").value;
    if (!name) return alert("Zadejte n√°zev.");
    if (noteNameExists(name, noteId)) return alert("Pozn√°mka s t√≠mto n√°zvem ji≈æ existuje.");
    n.name = name;
    n.icon = icon;
    n.modified = now();
    closeDialog();
    openNote(noteId);
    dbg("Pozn√°mka p≈ôejmenov√°na: " + name);
  });
}

// ===== PREVIEW WINDOW =====
function buildPreviewHTML(noteId) {
  var n = getNote(noteId);
  if (!n) return "";
  var css = 'body{font-family:"Segoe UI",Tahoma,sans-serif;background:#1b1b2f;color:#e0e0f0;padding:28px 36px;margin:0;line-height:1.6}';
  css += 'h1,h2,h3,h4,h5,h6{color:#56d6e6;margin:1em 0 .4em}h1{font-size:1.5rem}';
  css += 'a{color:#4ea8de}a:hover{color:#56d6e6}';
  css += 'pre{background:#162447;padding:10px;border-radius:6px;overflow-x:auto;font-size:.88rem}';
  css += 'code{background:#162447;padding:1px 5px;border-radius:3px;font-size:.88rem}pre code{background:none;padding:0}';
  css += 'blockquote{border-left:3px solid #334466;padding:4px 14px;margin:8px 0;color:#8899bb}';
  css += 'table{border-collapse:collapse;width:100%;font-size:.88rem;margin:8px 0}th,td{padding:5px 10px;border:1px solid #334466;text-align:left}th{background:#162447}';
  css += 'img{max-width:100%}ul,ol{margin:4px 0 4px 20px}';
  css += 'ol ol{list-style-type:lower-alpha}';
  css += '.meta-table{width:100%;font-size:.84rem;border-collapse:collapse;margin:8px 0 16px}';
  css += '.meta-table td{padding:3px 8px;border-bottom:1px solid #334466}.meta-table td:first-child{color:#8899bb;font-weight:600;white-space:nowrap;width:1%}';
  css += '.tag-chip{background:#2a2a5e;padding:2px 8px;border-radius:10px;font-size:.78rem;color:#4ea8de;margin-right:4px;display:inline-block}';
  css += 'ins{background:#1a4a1a;color:#80e080;text-decoration:none}del{background:#5a1a1a;color:#f09090}mark{background:#4a4a00;color:#f0e060}';
  css += '.cm-cmt{background:#1a2a5a;color:#90b0f0;font-style:italic}';
  css += '.task-done{text-decoration:line-through;opacity:.6}';
  var h = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>' + esc(n.name) + '</title><style>' + css + '</style></head><body>';
  h += '<h1>' + (n.icon || '&#128221;') + ' ' + esc(n.name) + '</h1>';
  if (n.tags && n.tags.length) {
    h += '<div style="margin:6px 0 12px">';
    for (var i = 0; i < n.tags.length; i++) h += '<span class="tag-chip">' + esc(n.tags[i]) + '</span>';
    h += '</div>';
  }
  if (n.meta && n.meta.length) {
    h += '<table class="meta-table">';
    for (var mi = 0; mi < n.meta.length; mi++) {
      var mv = n.meta[mi].value;
      var mvH = /^https?:\/\/\S+$/i.test(mv) ? '<a href="' + esc(mv) + '" target="_blank" rel="noopener">' + esc(mv) + '</a>' : esc(mv);
      h += '<tr><td>' + esc(n.meta[mi].key) + '</td><td>' + mvH + '</td></tr>';
    }
    h += '</table>';
  }
  h += '<div>' + renderMarkdown(n.content || "", noteId) + '</div>';
  h += '<script>window.addEventListener("message",function(e){if(e.data&&e.data.type==="noteblk-preview-refresh")location.reload();});<\/script>';
  h += '</body></html>';
  return h;
}

function openPreviewWindow(noteId) {
  var n = getNote(noteId);
  if (!n) return;
  // Close existing preview for this note
  if (PREVIEW_WINS[noteId] && !PREVIEW_WINS[noteId].closed) {
    PREVIEW_WINS[noteId].focus();
    return;
  }
  var win = window.open("", "preview_" + noteId, "width=800,height=600,scrollbars=yes,resizable=yes");
  if (!win) { alert("Povolte vyskakovac√≠ okna."); return; }
  PREVIEW_WINS[noteId] = win;
  var html = buildPreviewHTML(noteId);
  win.document.open();
  win.document.write(html);
  win.document.close();
  dbg("N√°hled otev≈ôen: " + n.name);
}

function refreshPreview(noteId) {
  if (!PREVIEW_WINS[noteId] || PREVIEW_WINS[noteId].closed) return;
  var win = PREVIEW_WINS[noteId];
  var html = buildPreviewHTML(noteId);
  win.document.open();
  win.document.write(html);
  win.document.close();
}

// ===== VERSIONS =====
function dlgSaveVersion(noteId) {
  var n = getNote(noteId);
  if (!n) return;
  var h = '<label>N√°zev verze:</label><input id="dlg-ver-name" placeholder="nap≈ô. P≈ôed reviz√≠, Hotovo k recenzi‚Ä¶" autofocus>';
  showDialog("Ulo≈æit verzi", h, function() {
    var name = document.getElementById("dlg-ver-name").value.trim();
    if (!name) { alert("Zadejte n√°zev verze."); return; }
    if (!n.versions) n.versions = [];
    n.versions.push({
      id: genId(),
      name: name,
      date: now(),
      content: n.content || "",
      tags: (n.tags || []).slice(),
      meta: (n.meta || []).map(function(m) { return { key: m.key, value: m.value }; })
    });
    closeDialog();
    openNote(noteId);
    dbg("Verze ulo≈æena: " + name);
  });
}

function formatBytes(str) {
  var b = new Blob([str || ""]).size;
  if (b < 1024) return b + " B";
  if (b < 1024 * 1024) return (b / 1024).toFixed(1) + " KB";
  return (b / (1024 * 1024)).toFixed(1) + " MB";
}

function showVersions(noteId) {
  var n = getNote(noteId);
  if (!n) return;
  var versions = n.versions || [];
  var vw = document.getElementById("view");
  var h = '<div id="crumb">' + breadcrumb(n.folderId) + "</div>";
  h += "<h2>&#128203; Verze: " + (n.icon || "&#128221;") + " " + esc(n.name) + " (" + versions.length + ")</h2>";
  h += '<p style="font-size:.84rem;color:var(--text2);margin:6px 0 14px">Aktu√°ln√≠ velikost: ' + formatBytes(n.content) + "</p>";
  if (versions.length === 0) {
    h += '<div class="empty">≈Ω√°dn√© ulo≈æen√© verze. Pou≈æijte tlaƒç√≠tko Verze+ (Alt+W) pro ulo≈æen√≠ aktu√°ln√≠ho stavu.</div>';
  } else {
    h += '<table class="tbl"><thead><tr><th>Datum</th><th>N√°zev</th><th>Velikost</th><th>Akce</th></tr></thead><tbody>';
    for (var i = versions.length - 1; i >= 0; i--) {
      var v = versions[i];
      h += "<tr><td style=\"white-space:nowrap\">" + esc(v.date) + "</td>";
      h += "<td>" + esc(v.name) + "</td>";
      h += "<td>" + formatBytes(v.content) + "</td>";
      h += '<td><button class="sm" onclick="openVersion(\'' + noteId + "','" + v.id + "')\" title=\"Otev≈ô√≠t\">&#128065; Otev≈ô√≠t</button> ";
      h += '<button class="sm danger" onclick="deleteVersion(\'' + noteId + "','" + v.id + '\')">&#128465;</button></td></tr>';
    }
    h += "</tbody></table>";
  }
  vw.innerHTML = h;
  document.getElementById("toolbar").innerHTML = '<button class="sm" onclick="openNote(\'' + noteId + '\')">&#8592; Zpƒõt na pozn√°mku</button>';
}

function openVersion(noteId, versionId) {
  var n = getNote(noteId);
  if (!n || !n.versions) return;
  var v = null;
  for (var i = 0; i < n.versions.length; i++) {
    if (n.versions[i].id === versionId) { v = n.versions[i]; break; }
  }
  if (!v) return;
  var vw = document.getElementById("view");
  var h = '<div id="crumb">' + breadcrumb(n.folderId) + "</div>";
  h += '<h6 style="margin:0 0 4px;font-size:.72rem;text-transform:uppercase;color:var(--text2);letter-spacing:.5px">Verze: ' + esc(v.name) + " (" + esc(v.date) + ")</h6>";
  h += "<h1>" + (n.icon || "&#128221;") + " " + esc(n.name) + "</h1>";
  h += '<div class="md">' + renderMarkdown(v.content || "", noteId) + "</div>";
  vw.innerHTML = h;

  var tbH = '<button class="sm" onclick="showVersions(\'' + noteId + '\')">&#8592; Zpƒõt na verze</button>';
  tbH += '<span class="sep"></span>';
  tbH += '<button class="sm primary" onclick="restoreVersion(\'' + noteId + "','" + versionId + "')\" title=\"P≈ôepsat aktu√°ln√≠ obsah touto verz√≠\">&#128260; Obnovit jako aktu√°ln√≠</button>";
  tbH += '<button class="sm" onclick="versionAsNewNote(\'' + noteId + "','" + versionId + "')\" title=\"Ulo≈æit tuto verzi jako novou pozn√°mku\">&#128196; Ulo≈æit jako novou pozn√°mku</button>";
  tbH += '<span class="sep"></span>';
  tbH += '<button class="sm" onclick="editVersion(\'' + noteId + "','" + versionId + '\')">&#9998; Upravit</button>';
  document.getElementById("toolbar").innerHTML = tbH;
}

function restoreVersion(noteId, versionId) {
  var n = getNote(noteId);
  if (!n || !n.versions) return;
  var v = null;
  for (var i = 0; i < n.versions.length; i++) {
    if (n.versions[i].id === versionId) { v = n.versions[i]; break; }
  }
  if (!v) return;
  showDialog("Obnovit verzi", "<p>P≈ôepsat aktu√°ln√≠ obsah pozn√°mky <strong>" + esc(n.name) + "</strong> verz√≠ <strong>" + esc(v.name) + "</strong>?</p>", function() {
    n.content = v.content;
    if (v.tags) n.tags = v.tags.slice();
    if (v.meta) n.meta = v.meta.map(function(m) { return { key: m.key, value: m.value }; });
    n.modified = now();
    closeDialog();
    openNote(noteId);
    dbg("Verze obnovena: " + v.name);
  });
}

function versionAsNewNote(noteId, versionId) {
  var n = getNote(noteId);
  if (!n || !n.versions) return;
  var v = null;
  for (var i = 0; i < n.versions.length; i++) {
    if (n.versions[i].id === versionId) { v = n.versions[i]; break; }
  }
  if (!v) return;
  var newName = n.name + " (" + v.name + ")";
  var dup = {
    id: genId(), name: newName, folderId: n.folderId, icon: n.icon,
    content: v.content, tags: (v.tags || []).slice(),
    meta: (v.meta || []).map(function(m) { return { key: m.key, value: m.value }; }),
    bookmarked: false, versions: [],
    created: now(), modified: now()
  };
  BD.notes.push(dup);
  openNote(dup.id);
  dbg("Verze ulo≈æena jako nov√° pozn√°mka: " + newName);
}

function editVersion(noteId, versionId) {
  var n = getNote(noteId);
  if (!n || !n.versions) return;
  var v = null;
  for (var i = 0; i < n.versions.length; i++) {
    if (n.versions[i].id === versionId) { v = n.versions[i]; break; }
  }
  if (!v) return;
  var vw = document.getElementById("view");
  var h = '<div id="crumb">' + breadcrumb(n.folderId) + "</div>";
  h += '<h6 style="margin:0 0 4px;font-size:.72rem;text-transform:uppercase;color:var(--text2);letter-spacing:.5px">Editace verze: ' + esc(v.name) + "</h6>";
  h += '<textarea id="ver-edit-area" style="flex:1;min-height:400px">' + esc(v.content || "") + "</textarea>";
  vw.innerHTML = h;

  var ta = document.getElementById("ver-edit-area");
  ta.addEventListener("keydown", function(e) { if (e.key === "Tab") { e.preventDefault(); var s = this.selectionStart, en = this.selectionEnd; this.value = this.value.substring(0, s) + "\t" + this.value.substring(en); this.selectionStart = this.selectionEnd = s + 1; } });

  var tbH = '<button class="sm" onclick="showVersions(\'' + noteId + '\')">&#8592; Zru≈°it</button>';
  tbH += '<span class="sep"></span>';
  tbH += '<button class="sm primary" onclick="saveVersionEdit(\'' + noteId + "','" + versionId + "','current')\" accesskey=\"u\">&#128260; Ulo≈æit jako aktu√°ln√≠<span class=\"ak\">U</span></button>";
  tbH += '<button class="sm" onclick="saveVersionEdit(\'' + noteId + "','" + versionId + "','new')\">&#128196; Ulo≈æit jako novou pozn√°mku</button>";
  document.getElementById("toolbar").innerHTML = tbH;
}

function saveVersionEdit(noteId, versionId, mode) {
  var content = document.getElementById("ver-edit-area").value;
  var n = getNote(noteId);
  if (!n) return;
  if (mode === "current") {
    n.content = content;
    n.modified = now();
    openNote(noteId);
    dbg("Verze ulo≈æena jako aktu√°ln√≠");
  } else {
    var v = null;
    for (var i = 0; i < n.versions.length; i++) {
      if (n.versions[i].id === versionId) { v = n.versions[i]; break; }
    }
    var vName = v ? v.name : "verze";
    var newName = n.name + " (" + vName + ")";
    var dup = {
      id: genId(), name: newName, folderId: n.folderId, icon: n.icon,
      content: content, tags: (n.tags || []).slice(),
      meta: (n.meta || []).map(function(m) { return { key: m.key, value: m.value }; }),
      bookmarked: false, versions: [],
      created: now(), modified: now()
    };
    BD.notes.push(dup);
    openNote(dup.id);
    dbg("Verze ulo≈æena jako nov√° pozn√°mka: " + newName);
  }
}

function deleteVersion(noteId, versionId) {
  var n = getNote(noteId);
  if (!n || !n.versions) return;
  var v = null;
  for (var i = 0; i < n.versions.length; i++) {
    if (n.versions[i].id === versionId) { v = n.versions[i]; break; }
  }
  if (!v) return;
  showDialog("Smazat verzi", "<p>Opravdu smazat verzi <strong>" + esc(v.name) + "</strong>?</p>", function() {
    n.versions = n.versions.filter(function(x) { return x.id !== versionId; });
    closeDialog();
    showVersions(noteId);
    dbg("Verze smaz√°na: " + v.name);
  }, "Smazat");
}

// ===== DELETE NOTE =====
function dlgDeleteNote(noteId) {
  var n = getNote(noteId);
  if (!n) return;
  showDialog("Smazat pozn√°mku", "<p>Opravdu smazat <strong>" + esc(n.name) + "</strong>?" + (n.versions && n.versions.length ? "<br>Bude smaz√°no i " + n.versions.length + " verz√≠." : "") + "</p>", function() {
    BD.notes = BD.notes.filter(function(x) { return x.id !== noteId; });
    // Remove from panels
    for (var pi = PANELS.length - 1; pi >= 0; pi--) {
      if (PANELS[pi] === noteId) { PANELS.splice(pi, 1); if (ACTIVE_PANEL >= PANELS.length) ACTIVE_PANEL = PANELS.length - 1; }
    }
    closeDialog();
    if (n.folderId) openFolder(n.folderId);
    else openRoot();
    dbg("Pozn√°mka smaz√°na: " + n.name);
  }, "Smazat");
}

// ===== MOVE NOTE =====
function dlgMoveNote(noteId) {
  var n = getNote(noteId);
  if (!n) return;
  var h = folderSelectHTML(n.folderId || "", null, "P≈ôesunout do");
  showDialog("P≈ôesunout pozn√°mku", h, function() {
    var folder = document.getElementById("dlg-folder").value || null;
    n.folderId = folder;
    n.modified = now();
    closeDialog();
    openNote(noteId);
    dbg("Pozn√°mka p≈ôesunuta: " + n.name);
  });
}

// ===== DUPLICATE NOTE =====
function duplicateNote(noteId) {
  var n = getNote(noteId);
  if (!n) return;
  var newName = n.name + " (kopie)";
  var i = 2;
  while (noteNameExists(newName, null)) {
    newName = n.name + " (kopie " + i + ")";
    i++;
  }
  var dup = {
    id: genId(), name: newName, folderId: n.folderId, icon: n.icon,
    content: n.content, tags: (n.tags || []).slice(),
    meta: (n.meta || []).map(function(m) { return { key: m.key, value: m.value }; }),
    bookmarked: false,
    versions: [],
    created: now(), modified: now()
  };
  BD.notes.push(dup);
  openNote(dup.id);
  dbg("Pozn√°mka duplikov√°na: " + newName);
}

// ===== NOTE TAGS =====
function dlgNoteTags(noteId) {
  var n = getNote(noteId);
  if (!n) return;
  var tags = (n.tags || []).join(", ");
  var h = '<label>≈†t√≠tky (oddƒõlen√© ƒç√°rkou):</label><input id="dlg-tags" value="' + esc(tags) + '" placeholder="projekt, d≈Øle≈æit√©, todo">';
  showDialog("≈†t√≠tky", h, function() {
    var val = document.getElementById("dlg-tags").value;
    n.tags = val.split(",").map(function(t) { return t.trim(); }).filter(function(t) { return t.length > 0; });
    n.modified = now();
    closeDialog();
    openNote(noteId);
    dbg("≈†t√≠tky aktualizov√°ny: " + n.name);
  });
}

// ===== METADATA =====
function dlgNoteMeta(noteId) {
  var n = getNote(noteId);
  if (!n) return;
  if (!n.meta) n.meta = [];
  var h = '<div id="dlg-meta-rows">';
  h += buildMetaRows(n.meta);
  h += '</div>';
  h += '<button type="button" class="sm" onclick="addMetaRow()" style="margin-top:6px">+ P≈ôidat pole</button>';
  h += '<div style="margin-top:8px;font-size:.78rem;color:var(--text2)">P≈ô√≠klady kl√≠ƒç≈Ø: stav, priorita, datum, autor, verze</div>';
  showDialog("Metadata", h, function() {
    var rows = document.querySelectorAll(".dlg-meta-row");
    var meta = [];
    for (var i = 0; i < rows.length; i++) {
      var k = rows[i].querySelector(".meta-key").value.trim();
      var v = rows[i].querySelector(".meta-val").value.trim();
      if (k) meta.push({ key: k, value: v });
    }
    n.meta = meta;
    n.modified = now();
    closeDialog();
    openNote(noteId);
    dbg("Metadata aktualizov√°na: " + n.name);
  });
}

function buildMetaRows(meta) {
  var h = "";
  for (var i = 0; i < meta.length; i++) {
    h += '<div class="dlg-meta-row" style="display:flex;gap:4px;margin:4px 0;align-items:center">';
    h += '<input class="meta-key" value="' + esc(meta[i].key) + '" placeholder="Kl√≠ƒç" style="width:35%">';
    h += '<input class="meta-val" value="' + esc(meta[i].value) + '" placeholder="Hodnota" style="flex:1">';
    h += '<button type="button" class="sm danger" onclick="this.parentElement.remove()" style="padding:3px 6px">&#10005;</button>';
    h += "</div>";
  }
  return h;
}

function addMetaRow() {
  var container = document.getElementById("dlg-meta-rows");
  if (!container) return;
  var row = document.createElement("div");
  row.className = "dlg-meta-row";
  row.style = "display:flex;gap:4px;margin:4px 0;align-items:center";
  row.innerHTML = '<input class="meta-key" placeholder="Kl√≠ƒç" style="width:35%">' +
    '<input class="meta-val" placeholder="Hodnota" style="flex:1">' +
    '<button type="button" class="sm danger" onclick="this.parentElement.remove()" style="padding:3px 6px">&#10005;</button>';
  container.appendChild(row);
  row.querySelector(".meta-key").focus();
}

// ===== TAG FILTER =====
function filterTag(tag) {
  if (STAG === tag) {
    STAG = null;
    renderNav();
    if (CUR.type === "folder") renderFolderView(CUR.id);
    else openRoot();
    return;
  }
  STAG = tag;
  CUR = { type: "tag", id: tag };
  renderNav();
  var tb = document.getElementById("toolbar");
  tb.innerHTML = '<span style="font-size:.88rem">Filtr: <strong>' + esc(tag) + '</strong></span> <button class="sm" onclick="filterTag(\'' + esc(tag).replace(/'/g, "\\'") + "')\">&#10005; Zru≈°it filtr</button>";
  var notes = [];
  for (var i = 0; i < BD.notes.length; i++) {
    if (BD.notes[i].tags && BD.notes[i].tags.indexOf(tag) !== -1) notes.push(BD.notes[i]);
  }
  notes.sort(function(a, b) { return a.name.localeCompare(b.name, "cs"); });
  var vw = document.getElementById("view");
  var h = "<h2>&#127991; ≈†t√≠tek: " + esc(tag) + "</h2>";
  if (notes.length === 0) {
    h += '<div class="empty">≈Ω√°dn√© pozn√°mky s t√≠mto ≈°t√≠tkem.</div>';
  } else {
    h += '<table class="tbl"><thead><tr><th>N√°zev</th><th>Slo≈æka</th></tr></thead><tbody>';
    for (var j = 0; j < notes.length; j++) {
      var n = notes[j];
      var fname = n.folderId ? (getFolder(n.folderId) || {}).name || "" : "(ko≈ôen)";
      h += '<tr><td><a href="#" onclick="openNote(\'' + n.id + '\');return false">' + (n.icon || "&#128221;") + " " + esc(n.name) + "</a></td>";
      h += '<td style="font-size:.82rem;color:var(--text2)">' + esc(fname) + "</td></tr>";
    }
    h += "</tbody></table>";
  }
  vw.innerHTML = h;
}

// ===== SEARCH =====
function doSearch() {
  if (!BD) return;
  showDialog("Hledat", '<label>Hledan√Ω text:</label><input id="dlg-search" placeholder="Hledej...">', function() {
    var q = document.getElementById("dlg-search").value.trim().toLowerCase();
    if (!q) return;
    closeDialog();
    var results = [];
    for (var i = 0; i < BD.notes.length; i++) {
      var n = BD.notes[i];
      var score = 0, snippet = "";
      if (n.name.toLowerCase().indexOf(q) !== -1) score += 3;
      if (n.tags) {
        for (var ti = 0; ti < n.tags.length; ti++) {
          if (n.tags[ti].toLowerCase().indexOf(q) !== -1) { score += 2; break; }
        }
      }
      if (n.content && n.content.toLowerCase().indexOf(q) !== -1) {
        score += 1;
        var idx = n.content.toLowerCase().indexOf(q);
        var start = Math.max(0, idx - 40);
        var end = Math.min(n.content.length, idx + q.length + 60);
        snippet = (start > 0 ? "..." : "") + n.content.substring(start, end) + (end < n.content.length ? "..." : "");
      }
      if (score > 0) results.push({ note: n, score: score, snippet: snippet });
    }
    results.sort(function(a, b) { return b.score - a.score; });
    CUR = { type: "search", id: q };
    ACTIVE_PANEL = -1;
    renderTabs();
    document.getElementById("toolbar").innerHTML = '<span style="font-size:.88rem">V√Ωsledky: <strong>' + esc(q) + "</strong> (" + results.length + ")</span>";
    var vw = document.getElementById("view");
    var h = "<h2>&#128269; Hled√°n√≠: " + esc(q) + "</h2>";
    if (results.length === 0) {
      h += '<div class="empty">Nic nenalezeno.</div>';
    } else {
      for (var ri = 0; ri < results.length; ri++) {
        var r = results[ri];
        h += '<div style="margin:8px 0;padding:8px 10px;border:1px solid var(--border);border-radius:6px">';
        h += '<a href="#" onclick="openNote(\'' + r.note.id + '\');return false" style="font-weight:600">' + (r.note.icon || "&#128221;") + " " + esc(r.note.name) + "</a>";
        if (r.snippet) h += '<div style="font-size:.82rem;color:var(--text2);margin-top:4px">' + esc(r.snippet) + "</div>";
        h += "</div>";
      }
    }
    vw.innerHTML = h;
  });
}

// ===== TASKS VIEW =====
function showTasks() {
  if (!BD) return;
  CUR = { type: "tasks", id: null };
  ACTIVE_PANEL = -1;
  renderNav(); renderTabs(); updateTitle();
  document.getElementById("toolbar").innerHTML = '<span style="font-size:.88rem">&#9745; Nevy≈ô√≠zen√© √∫koly</span>';
  var groups = [];
  var totalCount = 0;
  for (var i = 0; i < BD.notes.length; i++) {
    var n = BD.notes[i];
    if (!n.content) continue;
    var lines = n.content.split("\n");
    var noteTasks = [];
    var inCode = false;
    var curHeading = "";
    for (var li = 0; li < lines.length; li++) {
      if (lines[li].match(/^```/)) { inCode = !inCode; continue; }
      if (inCode) continue;
      var hm = lines[li].match(/^#{1,6}\s+(.+)/);
      if (hm) curHeading = hm[1];
      var m = lines[li].match(/^- \[ \] (.+)/);
      if (m) noteTasks.push({ text: m[1], heading: curHeading });
    }
    if (noteTasks.length > 0) {
      groups.push({ note: n, tasks: noteTasks });
      totalCount += noteTasks.length;
    }
  }
  groups.sort(function(a, b) { return a.note.name.localeCompare(b.note.name, "cs"); });
  var vw = document.getElementById("view");
  var h = "<h2>&#9745; Nevy≈ô√≠zen√© √∫koly (" + totalCount + ")</h2>";
  if (totalCount === 0) {
    h += '<div class="empty">≈Ω√°dn√© nevy≈ô√≠zen√© √∫koly!</div>';
  } else {
    for (var gi = 0; gi < groups.length; gi++) {
      var g = groups[gi];
      h += '<div style="margin:12px 0">';
      h += '<h3 style="font-size:.95rem;margin:0 0 6px"><a href="#" onclick="openNote(\'' + g.note.id + '\');return false">' + (g.note.icon || "&#128221;") + " " + esc(g.note.name) + "</a>";
      h += ' <span style="font-size:.78rem;color:var(--text2)">(' + g.tasks.length + ")</span></h3>";
      h += '<ul style="list-style:none;padding:0;margin:0 0 0 8px">';
      for (var ti = 0; ti < g.tasks.length; ti++) {
        h += '<li style="padding:3px 0;border-bottom:1px solid var(--border);font-size:.9rem">&#9744; ' + esc(g.tasks[ti].text);
        if (g.tasks[ti].heading) h += ' <span style="font-size:.78rem;color:var(--text2)">‚Äî ' + esc(g.tasks[ti].heading) + "</span>";
        h += "</li>";
      }
      h += "</ul></div>";
    }
  }
  vw.innerHTML = h;
}

// ===== EXPORT MD =====
function exportNoteMD(noteId) {
  var n = getNote(noteId);
  if (!n) return;
  var md = "# " + n.name + "\n\n" + resolveIncludes(n.content || "");
  downloadFile(sanitize(n.name) + ".md", md, "text/markdown");
  dbg("Exportov√°no MD: " + n.name);
}

function copyNoteMD(noteId) {
  var n = getNote(noteId);
  if (!n) return;
  navigator.clipboard.writeText(resolveIncludes(n.content || "")).then(function() {
    dbg("Zkop√≠rov√°no: " + n.name);
    alert("Zkop√≠rov√°no do schr√°nky.");
  });
}

function exportFolderMD(folderId) {
  var f = getFolder(folderId);
  if (!f) return;
  var md = buildFolderMD(folderId, 1);
  downloadFile(sanitize(f.name) + ".md", md, "text/markdown");
  dbg("Exportov√°na slo≈æka: " + f.name);
}

function buildFolderMD(folderId, level) {
  var f = getFolder(folderId);
  var prefix = "";
  for (var x = 0; x < Math.min(level, 6); x++) prefix += "#";
  prefix += " ";
  var md = prefix + (f ? f.name : "Root") + "\n\n";
  var notes = notesInFolder(folderId);
  for (var i = 0; i < notes.length; i++) {
    md += prefix + "# " + notes[i].name + "\n\n" + resolveIncludes(notes[i].content || "") + "\n\n";
  }
  var subs = childFolders(folderId);
  for (var j = 0; j < subs.length; j++) {
    md += buildFolderMD(subs[j].id, level + 1);
  }
  return md;
}

function exportFolderDOCX(folderId) {
  var f = getFolder(folderId);
  if (!f) return;
  dbg("Generuji DOCX slo≈æky: " + f.name);
  try {
    var result = buildFolderDocxXml(folderId, 1);
    buildDocxZip(result.xml, sanitize(f.name) + ".docx", result.numInstances);
  } catch (e) {
    dbg("Chyba DOCX: " + e.message);
    alert("Chyba p≈ôi exportu DOCX: " + e.message);
  }
}

function buildFolderDocxXml(folderId, level) {
  var f = getFolder(folderId);
  var hLevel = Math.min(level, 6);
  var xml = '<w:p><w:pPr><w:pStyle w:val="Heading' + hLevel + '"/></w:pPr><w:r><w:t>' + xmlEsc(f ? f.name : "Root") + '</w:t></w:r></w:p>';
  var allNumInstances = [];
  var runningOffset = 0;
  var notes = notesInFolder(folderId);
  for (var i = 0; i < notes.length; i++) {
    var resolved = resolveIncludes(notes[i].content || "");
    var result = mdToDocxXml(resolved, notes[i].name, runningOffset);
    xml += result.xml;
    allNumInstances = allNumInstances.concat(result.numInstances);
    runningOffset += result.numInstances.length;
  }
  var subs = childFolders(folderId);
  for (var j = 0; j < subs.length; j++) {
    var subResult = buildFolderDocxXml(subs[j].id, level + 1);
    // Re-offset sub-result numIds
    if (subResult.numInstances.length > 0 && runningOffset > 0) {
      subResult.xml = subResult.xml.replace(/w:numId="(\d+)"/g, function(m, id) {
        return 'w:numId="' + (parseInt(id, 10) + runningOffset) + '"';
      });
    }
    xml += subResult.xml;
    allNumInstances = allNumInstances.concat(subResult.numInstances);
    runningOffset += subResult.numInstances.length;
  }
  return { xml: xml, numInstances: allNumInstances };
}

// ===== EXPORT DOCX (via JSZip) =====
function exportNoteDOCX(noteId) {
  var n = getNote(noteId);
  if (!n) return;
  dbg("Generuji DOCX: " + n.name);
  try {
    var resolved = resolveIncludes(n.content || "");
    var result = mdToDocxXml(resolved, n.name);
    buildDocxZip(result.xml, sanitize(n.name) + ".docx", result.numInstances);
  } catch (e) {
    dbg("Chyba DOCX: " + e.message);
    alert("Chyba p≈ôi exportu DOCX: " + e.message);
  }
}

function xmlEsc(s) {
  return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
}

function mdToDocxXml(md, title, numIdOffset) {
  var lines = md.split("\n");
  var paras = [];
  var inCodeBlock = false;
  var inTable = false;
  var tableRows = [];

  function flushTable() {
    if (tableRows.length > 0) {
      paras.push(buildDocxTable(tableRows));
      tableRows = [];
    }
    inTable = false;
  }

  // List state tracking for proper numbering restart per list group
  var curListType = null; // 'ul' or 'ol'
  var listIndentStack = [];
  var listNumId = 0;
  var numIdCounter = numIdOffset || 0;
  var numInstances = []; // each: {abstractNumId: 0|1}

  function startListGroup(type) {
    numIdCounter++;
    listNumId = numIdCounter;
    numInstances.push({ abstractNumId: (type === "ul") ? 0 : 1 });
    curListType = type;
    listIndentStack = [];
  }

  function endListGroup() {
    curListType = null;
    listIndentStack = [];
    listNumId = 0;
  }

  function resolveIlvl(spaces) {
    if (spaces === 0) return 0;
    for (var j = 0; j < listIndentStack.length; j++) {
      if (spaces <= listIndentStack[j]) return j + 1;
    }
    listIndentStack.push(spaces);
    return listIndentStack.length;
  }

  for (var i = 0; i < lines.length; i++) {
    var line = lines[i];

    // Code block
    if (line.match(/^```/)) {
      if (inTable) flushTable();
      inCodeBlock = !inCodeBlock;
      continue;
    }
    if (inCodeBlock) {
      paras.push('<w:p><w:pPr><w:pStyle w:val="Code"/></w:pPr><w:r><w:rPr><w:rFonts w:ascii="Consolas" w:hAnsi="Consolas"/><w:sz w:val="18"/></w:rPr><w:t xml:space="preserve">' + xmlEsc(line) + "</w:t></w:r></w:p>");
      continue;
    }

    // Table
    if (line.match(/^\|(.+)\|$/)) {
      if (line.match(/^\|[\s\-:|]+\|$/)) continue; // separator
      inTable = true;
      var cells = line.split("|").slice(1, -1).map(function(c) { return c.trim(); });
      tableRows.push(cells);
      continue;
    } else if (inTable) {
      flushTable();
    }

    // Empty line - skip (MD structural separator, not needed in DOCX)
    if (line.trim() === "") {
      if (curListType) endListGroup();
      continue;
    }

    // Track list context - end group if non-list line
    var isListLine = (line.match(/^( *)[-*]\s/) && !line.match(/^- \[[ x]\]/)) || line.match(/^( *)\d+\.\s/);
    if (!isListLine && curListType) endListGroup();

    // Headings
    var hm = line.match(/^(#{1,6})\s+(.+)/);
    if (hm) {
      var hlevel = hm[1].length;
      paras.push('<w:p><w:pPr><w:pStyle w:val="Heading' + hlevel + '"/></w:pPr>' + inlineToDocx(hm[2]) + "</w:p>");
      continue;
    }

    // Blockquote
    if (line.match(/^>\s*/)) {
      var qt = line.replace(/^>\s*/, "");
      paras.push('<w:p><w:pPr><w:ind w:left="720"/><w:pBdr><w:left w:val="single" w:sz="12" w:space="4" w:color="4EA8DE"/></w:pBdr></w:pPr>' + inlineToDocx(qt) + "</w:p>");
      continue;
    }

    // Task
    var tm = line.match(/^- \[( |x)\] (.+)/);
    if (tm) {
      var check = tm[1] === "x" ? "&#9745; " : "&#9744; ";
      paras.push("<w:p>" + inlineToDocx(check + tm[2]) + "</w:p>");
      continue;
    }

    // Unordered list
    var ulm = line.match(/^( *)[-*]\s+(.*)/);
    if (ulm) {
      if (curListType !== "ul") startListGroup("ul");
      var ilvl = resolveIlvl(ulm[1].length);
      paras.push('<w:p><w:pPr><w:pStyle w:val="ListParagraph"/><w:numPr><w:ilvl w:val="' + ilvl + '"/><w:numId w:val="' + listNumId + '"/></w:numPr></w:pPr>' + inlineToDocx(ulm[2]) + "</w:p>");
      continue;
    }

    // Ordered list
    var om = line.match(/^( *)\d+\.\s+(.+)/);
    if (om) {
      if (curListType !== "ol") startListGroup("ol");
      var ilvl = resolveIlvl(om[1].length);
      paras.push('<w:p><w:pPr><w:pStyle w:val="ListParagraph"/><w:numPr><w:ilvl w:val="' + ilvl + '"/><w:numId w:val="' + listNumId + '"/></w:numPr></w:pPr>' + inlineToDocx(om[2]) + "</w:p>");
      continue;
    }

    // HR
    if (line.match(/^(-{3,}|\*{3,}|_{3,})$/)) {
      paras.push('<w:p><w:pPr><w:pBdr><w:bottom w:val="single" w:sz="6" w:space="1" w:color="auto"/></w:pBdr></w:pPr></w:p>');
      continue;
    }

    // Normal paragraph
    paras.push("<w:p>" + inlineToDocx(line) + "</w:p>");
  }

  if (inTable) flushTable();

  return { xml: paras.join("\n"), numInstances: numInstances };
}

function inlineToDocx(text) {
  var runs = [];
  // Process inline formatting
  // Order: CriticMarkup substitution, addition, deletion, highlight, comment, bold, italic, code, wiki links, includes
  var parts = [];
  var regex = /(\{~~.+?~>.+?~~\}|\{\+\+.+?\+\+\}|\{--.+?--\}|\{==.+?==\}|\{>>.+?<<\}|\*\*\*.+?\*\*\*|\*\*.+?\*\*|\*.+?\*|`.+?`|\[\[.+?\]\]|\{\{.+?\}\})/g;
  var lastIdx = 0;
  var match;
  while ((match = regex.exec(text)) !== null) {
    if (match.index > lastIdx) {
      parts.push({ type: "text", val: text.substring(lastIdx, match.index) });
    }
    var m = match[0];
    if (m.match(/^\{~~(.+?)~>(.+?)~~\}$/)) {
      var sm = m.match(/^\{~~(.+?)~>(.+?)~~\}$/);
      parts.push({ type: "del", val: sm[1] });
      parts.push({ type: "add", val: sm[2] });
    } else if (m.match(/^\{\+\+(.+?)\+\+\}$/)) {
      parts.push({ type: "add", val: m.match(/^\{\+\+(.+?)\+\+\}$/)[1] });
    } else if (m.match(/^\{--(.+?)--\}$/)) {
      parts.push({ type: "del", val: m.match(/^\{--(.+?)--\}$/)[1] });
    } else if (m.match(/^\{==(.+?)==\}$/)) {
      parts.push({ type: "highlight", val: m.match(/^\{==(.+?)==\}$/)[1] });
    } else if (m.match(/^\{>>(.+?)<<\}$/)) {
      parts.push({ type: "comment", val: m.match(/^\{>>(.+?)<<\}$/)[1] });
    } else if (m.match(/^\*\*\*(.+?)\*\*\*$/)) {
      parts.push({ type: "bolditalic", val: m.match(/^\*\*\*(.+?)\*\*\*$/)[1] });
    } else if (m.match(/^\*\*(.+?)\*\*$/)) {
      parts.push({ type: "bold", val: m.match(/^\*\*(.+?)\*\*$/)[1] });
    } else if (m.match(/^\*(.+?)\*$/)) {
      parts.push({ type: "italic", val: m.match(/^\*(.+?)\*$/)[1] });
    } else if (m.match(/^`(.+?)`$/)) {
      parts.push({ type: "code", val: m.match(/^`(.+?)`$/)[1] });
    } else if (m.match(/^\[\[(.+?)\]\]$/)) {
      parts.push({ type: "wlink", val: m.match(/^\[\[(.+?)\]\]$/)[1] });
    } else if (m.match(/^\{\{(.+?)\}\}$/)) {
      parts.push({ type: "include", val: m.match(/^\{\{(.+?)\}\}$/)[1] });
    }
    lastIdx = regex.lastIndex;
  }
  if (lastIdx < text.length) {
    parts.push({ type: "text", val: text.substring(lastIdx) });
  }

  var revId = 1;
  for (var i = 0; i < parts.length; i++) {
    var p = parts[i];
    var rpr = "";
    var wrapStart = "";
    var wrapEnd = "";
    var textTag = "w:t";
    switch (p.type) {
      case "bold": rpr = "<w:rPr><w:b/></w:rPr>"; break;
      case "italic": rpr = "<w:rPr><w:i/></w:rPr>"; break;
      case "bolditalic": rpr = "<w:rPr><w:b/><w:i/></w:rPr>"; break;
      case "code": rpr = '<w:rPr><w:rFonts w:ascii="Consolas" w:hAnsi="Consolas"/><w:sz w:val="20"/><w:shd w:val="clear" w:fill="E0E0E0"/></w:rPr>'; break;
      case "add":
        wrapStart = '<w:ins w:id="' + revId + '" w:author="Autor" w:date="' + new Date().toISOString().replace(/\.\d+/, "") + '">';
        wrapEnd = "</w:ins>";
        revId++;
        break;
      case "del":
        wrapStart = '<w:del w:id="' + revId + '" w:author="Autor" w:date="' + new Date().toISOString().replace(/\.\d+/, "") + '">';
        wrapEnd = "</w:del>";
        rpr = "<w:rPr><w:strike/></w:rPr>";
        textTag = "w:delText";
        revId++;
        break;
      case "highlight": rpr = '<w:rPr><w:highlight w:val="yellow"/></w:rPr>'; break;
      case "comment": rpr = '<w:rPr><w:color w:val="4472C4"/><w:i/></w:rPr>'; break;
      case "wlink": rpr = '<w:rPr><w:color w:val="0070C0"/><w:u w:val="dash"/></w:rPr>'; break;
      case "include": break;
    }
    var prefix = "";
    var suffix = "";
    if (p.type === "wlink") prefix = "\u2192 ";
    if (p.type === "comment") { prefix = "[koment√°≈ô: "; suffix = "]"; }

    runs.push(wrapStart + "<w:r>" + rpr + "<" + textTag + ' xml:space="preserve">' + xmlEsc(prefix + p.val + suffix) + "</" + textTag + "></w:r>" + wrapEnd);
  }
  return runs.join("");
}

function buildDocxTable(rows) {
  var xml = '<w:tbl><w:tblPr><w:tblBorders>';
  xml += '<w:top w:val="single" w:sz="4" w:space="0" w:color="auto"/>';
  xml += '<w:left w:val="single" w:sz="4" w:space="0" w:color="auto"/>';
  xml += '<w:bottom w:val="single" w:sz="4" w:space="0" w:color="auto"/>';
  xml += '<w:right w:val="single" w:sz="4" w:space="0" w:color="auto"/>';
  xml += '<w:insideH w:val="single" w:sz="4" w:space="0" w:color="auto"/>';
  xml += '<w:insideV w:val="single" w:sz="4" w:space="0" w:color="auto"/>';
  xml += '</w:tblBorders><w:tblW w:w="0" w:type="auto"/></w:tblPr>';
  for (var r = 0; r < rows.length; r++) {
    xml += "<w:tr>";
    for (var c = 0; c < rows[r].length; c++) {
      var rpr = r === 0 ? "<w:rPr><w:b/></w:rPr>" : "";
      xml += "<w:tc><w:p><w:r>" + rpr + '<w:t xml:space="preserve">' + xmlEsc(rows[r][c]) + "</w:t></w:r></w:p></w:tc>";
    }
    xml += "</w:tr>";
  }
  xml += "</w:tbl>";
  return xml;
}

function buildDocxZip(bodyXml, filename, numInstances) {
  numInstances = numInstances || [];
  var zip = new JSZip();

  zip.file("[Content_Types].xml",
    '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>' +
    '<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">' +
    '<Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>' +
    '<Default Extension="xml" ContentType="application/xml"/>' +
    '<Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>' +
    '<Override PartName="/word/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/>' +
    '<Override PartName="/word/numbering.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.numbering+xml"/>' +
    "</Types>"
  );

  zip.folder("_rels").file(".rels",
    '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>' +
    '<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">' +
    '<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>' +
    "</Relationships>"
  );

  var wordRels = '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>' +
    '<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">' +
    '<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>' +
    '<Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/numbering" Target="numbering.xml"/>' +
    "</Relationships>";

  var docXml = '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>' +
    '<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">' +
    "<w:body>" + bodyXml +
    '<w:sectPr><w:pgSz w:w="11906" w:h="16838"/><w:pgMar w:top="1440" w:right="1440" w:bottom="1440" w:left="1440" w:header="720" w:footer="720" w:gutter="0"/></w:sectPr>' +
    "</w:body></w:document>";

  var stylesXml = '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>' +
    '<w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">' +
    '<w:style w:type="paragraph" w:default="1" w:styleId="Normal"><w:name w:val="Normal"/><w:rPr><w:rFonts w:ascii="Calibri" w:hAnsi="Calibri"/><w:sz w:val="22"/></w:rPr></w:style>' +
    '<w:style w:type="paragraph" w:styleId="Heading1"><w:name w:val="heading 1"/><w:basedOn w:val="Normal"/><w:pPr><w:spacing w:before="240" w:after="120"/></w:pPr><w:rPr><w:b/><w:sz w:val="36"/><w:color w:val="2F5496"/></w:rPr></w:style>' +
    '<w:style w:type="paragraph" w:styleId="Heading2"><w:name w:val="heading 2"/><w:basedOn w:val="Normal"/><w:pPr><w:spacing w:before="200" w:after="100"/></w:pPr><w:rPr><w:b/><w:sz w:val="30"/><w:color w:val="2F5496"/></w:rPr></w:style>' +
    '<w:style w:type="paragraph" w:styleId="Heading3"><w:name w:val="heading 3"/><w:basedOn w:val="Normal"/><w:pPr><w:spacing w:before="160" w:after="80"/></w:pPr><w:rPr><w:b/><w:sz w:val="26"/><w:color w:val="2F5496"/></w:rPr></w:style>' +
    '<w:style w:type="paragraph" w:styleId="Heading4"><w:name w:val="heading 4"/><w:basedOn w:val="Normal"/><w:rPr><w:b/><w:sz w:val="24"/><w:color w:val="2F5496"/></w:rPr></w:style>' +
    '<w:style w:type="paragraph" w:styleId="Heading5"><w:name w:val="heading 5"/><w:basedOn w:val="Normal"/><w:rPr><w:b/><w:sz w:val="22"/><w:color w:val="2F5496"/></w:rPr></w:style>' +
    '<w:style w:type="paragraph" w:styleId="Heading6"><w:name w:val="heading 6"/><w:basedOn w:val="Normal"/><w:rPr><w:b/><w:i/><w:sz w:val="22"/><w:color w:val="2F5496"/></w:rPr></w:style>' +
    '<w:style w:type="paragraph" w:styleId="Code"><w:name w:val="Code"/><w:basedOn w:val="Normal"/><w:pPr><w:shd w:val="clear" w:fill="F0F0F0"/><w:spacing w:before="40" w:after="40"/></w:pPr><w:rPr><w:rFonts w:ascii="Consolas" w:hAnsi="Consolas"/><w:sz w:val="18"/></w:rPr></w:style>' +
    '<w:style w:type="paragraph" w:styleId="ListParagraph"><w:name w:val="List Paragraph"/><w:basedOn w:val="Normal"/><w:pPr><w:ind w:left="720"/></w:pPr></w:style>' +
    "</w:styles>";

  var numberingXml = '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>' +
    '<w:numbering xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">' +
    '<w:abstractNum w:abstractNumId="0">' +
    '<w:lvl w:ilvl="0"><w:start w:val="1"/><w:numFmt w:val="bullet"/><w:lvlText w:val="&#8226;"/><w:lvlJc w:val="left"/><w:pPr><w:ind w:left="720" w:hanging="360"/></w:pPr></w:lvl>' +
    '<w:lvl w:ilvl="1"><w:start w:val="1"/><w:numFmt w:val="bullet"/><w:lvlText w:val="&#8211;"/><w:lvlJc w:val="left"/><w:pPr><w:ind w:left="1440" w:hanging="360"/></w:pPr></w:lvl>' +
    '<w:lvl w:ilvl="2"><w:start w:val="1"/><w:numFmt w:val="bullet"/><w:lvlText w:val="&#8226;"/><w:lvlJc w:val="left"/><w:pPr><w:ind w:left="2160" w:hanging="360"/></w:pPr></w:lvl>' +
    '<w:lvl w:ilvl="3"><w:start w:val="1"/><w:numFmt w:val="bullet"/><w:lvlText w:val="&#8211;"/><w:lvlJc w:val="left"/><w:pPr><w:ind w:left="2880" w:hanging="360"/></w:pPr></w:lvl>' +
    '</w:abstractNum>' +
    '<w:abstractNum w:abstractNumId="1">' +
    '<w:lvl w:ilvl="0"><w:start w:val="1"/><w:numFmt w:val="decimal"/><w:lvlText w:val="%1."/><w:lvlJc w:val="left"/><w:pPr><w:ind w:left="720" w:hanging="360"/></w:pPr></w:lvl>' +
    '<w:lvl w:ilvl="1"><w:start w:val="1"/><w:numFmt w:val="lowerLetter"/><w:lvlText w:val="%2."/><w:lvlJc w:val="left"/><w:pPr><w:ind w:left="1440" w:hanging="360"/></w:pPr></w:lvl>' +
    '<w:lvl w:ilvl="2"><w:start w:val="1"/><w:numFmt w:val="lowerRoman"/><w:lvlText w:val="%3."/><w:lvlJc w:val="left"/><w:pPr><w:ind w:left="2160" w:hanging="360"/></w:pPr></w:lvl>' +
    '<w:lvl w:ilvl="3"><w:start w:val="1"/><w:numFmt w:val="decimal"/><w:lvlText w:val="%4."/><w:lvlJc w:val="left"/><w:pPr><w:ind w:left="2880" w:hanging="360"/></w:pPr></w:lvl>' +
    '</w:abstractNum>';
  for (var ni = 0; ni < numInstances.length; ni++) {
    numberingXml += '<w:num w:numId="' + (ni + 1) + '"><w:abstractNumId w:val="' + numInstances[ni].abstractNumId + '"/>';
    for (var li = 0; li < 4; li++) {
      numberingXml += '<w:lvlOverride w:ilvl="' + li + '"><w:startOverride w:val="1"/></w:lvlOverride>';
    }
    numberingXml += '</w:num>';
  }
  if (numInstances.length === 0) {
    numberingXml += '<w:num w:numId="1"><w:abstractNumId w:val="0"/></w:num>';
  }
  numberingXml += "</w:numbering>";

  var wordFolder = zip.folder("word");
  wordFolder.file("document.xml", docXml);
  wordFolder.file("styles.xml", stylesXml);
  wordFolder.file("numbering.xml", numberingXml);
  wordFolder.folder("_rels").file("document.xml.rels", wordRels);

  zip.generateAsync({ type: "blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" }).then(function(blob) {
    if (window.showSaveFilePicker) {
      window.showSaveFilePicker({
        suggestedName: filename,
        types: [{
          description: "Word dokument",
          accept: { "application/vnd.openxmlformats-officedocument.wordprocessingml.document": [".docx"] }
        }]
      }).then(function(handle) {
        return handle.createWritable().then(function(w) {
          return w.write(blob).then(function() { return w.close(); });
        });
      }).then(function() {
        dbg("DOCX ulo≈æen p≈ôes syst√©mov√Ω dialog: " + filename);
      }).catch(function(err) {
        if (err.name !== "AbortError") {
          dbg("Fallback na sta≈æen√≠: " + err.message);
          saveAs(blob, filename);
        }
      });
    } else {
      saveAs(blob, filename);
    }
  });
}

// ===== FILE OPS =====
function downloadFile(name, content, type) {
  var blob = new Blob([content], { type: type + ";charset=utf-8" });
  if (window.showSaveFilePicker) {
    var ext = name.split(".").pop();
    var mimeMap = { nmb: "application/json", md: "text/markdown", json: "application/json" };
    var descMap = { nmb: "NoteBlock soubor", md: "Markdown", json: "JSON" };
    window.showSaveFilePicker({
      suggestedName: name,
      types: [{
        description: descMap[ext] || "Soubor",
        accept: (function() { var o = {}; o[mimeMap[ext] || type] = ["." + ext]; return o; })()
      }]
    }).then(function(handle) {
      return handle.createWritable().then(function(w) {
        return w.write(blob).then(function() { return w.close(); });
      });
    }).then(function() {
      dbg("Ulo≈æeno p≈ôes syst√©mov√Ω dialog: " + name);
    }).catch(function(err) {
      if (err.name !== "AbortError") {
        dbg("Fallback na sta≈æen√≠: " + err.message);
        fallbackDownload(name, blob);
      }
    });
  } else {
    fallbackDownload(name, blob);
  }
}

function fallbackDownload(name, blob) {
  var a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
  URL.revokeObjectURL(a.href);
}

function sanitize(s) {
  return s.replace(/[\/\\:*?"<>|]/g, "_");
}

function newBlock() {
  showDialog("Nov√Ω pozn√°mkov√Ω blok", '<label>N√°zev:</label><input id="dlg-name" placeholder="M≈Øj blok">', function() {
    var name = document.getElementById("dlg-name").value.trim();
    if (!name) return alert("Zadejte n√°zev.");
    BD = { name: name, emojis: "", folders: [], notes: [] };
    closeDialog();
    openRoot();
    dbg("Nov√Ω blok: " + name);
  });
}

function loadBlock() {
  if (window.showOpenFilePicker) {
    window.showOpenFilePicker({
      types: [{
        description: "NoteBlock soubor",
        accept: { "application/json": [".nmb", ".json"] }
      }]
    }).then(function(handles) {
      return handles[0].getFile();
    }).then(function(file) {
      readBlockFile(file);
    }).catch(function(err) {
      if (err.name !== "AbortError") {
        dbg("Fallback na input: " + err.message);
        document.getElementById("file-in").click();
      }
    });
  } else {
    document.getElementById("file-in").click();
  }
}

function readBlockFile(file) {
  var reader = new FileReader();
  reader.onload = function(ev) {
    try {
      BD = JSON.parse(ev.target.result);
      if (!BD.folders) BD.folders = [];
      if (!BD.notes) BD.notes = [];
      if (BD.emojis === undefined) BD.emojis = "";
      for (var i = 0; i < BD.notes.length; i++) {
        if (!BD.notes[i].versions) BD.notes[i].versions = [];
      }
      EXPANDED = {};
      PANELS = [];
      ACTIVE_PANEL = -1;
      openRoot();
      dbg("Blok nahr√°n: " + BD.name);
    } catch (err) {
      alert("Chyba p≈ôi naƒç√≠t√°n√≠: " + err.message);
      dbg("Chyba: " + err.message);
    }
  };
  reader.readAsText(file);
}

document.getElementById("file-in").addEventListener("change", function(e) {
  var file = e.target.files[0];
  if (!file) return;
  readBlockFile(file);
  this.value = "";
});

function saveBlock() {
  if (!BD) return alert("≈Ω√°dn√Ω blok.");
  var json = JSON.stringify(BD, null, 2);
  downloadFile(sanitize(BD.name) + ".nmb", json, "application/json");
  dbg("Blok ulo≈æen: " + BD.name);
}

// ===== SETTINGS (s editaƒçn√≠m polem pro emotikony) =====
function showSettings() {
  if (!BD) return alert("Nejd≈ô√≠ve vytvo≈ôte nebo nahrajte blok.");
  var h = '<label>N√°zev bloku:</label><input id="dlg-name" value="' + esc(BD.name) + '">';
  h += '<label>Vlastn√≠ emotikony (napi≈°te nebo vlo≈æte emoji znaky, pr√°zdn√© = v√Ωchoz√≠ sada):</label>';
  h += '<input id="dlg-emojis" value="' + esc(BD.emojis || "") + '" placeholder="' + esc(DEFAULT_EMOJIS) + '">';
  h += '<div style="margin-top:6px;font-size:.78rem;color:var(--text2)">N√°hled: <span id="dlg-emoji-preview"></span></div>';
  showDialog("Nastaven√≠", h, function() {
    var name = document.getElementById("dlg-name").value.trim();
    if (!name) return;
    BD.name = name;
    BD.emojis = document.getElementById("dlg-emojis").value;
    closeDialog();
    renderNav();
    if (CUR.type === "folder") renderFolderView(CUR.id);
    dbg("Nastaven√≠ ulo≈æeno");
  });
  // Live preview
  var inp = document.getElementById("dlg-emojis");
  var prev = document.getElementById("dlg-emoji-preview");
  function updatePreview() {
    var val = inp.value || DEFAULT_EMOJIS;
    var arr = Array.from(val);
    prev.textContent = arr.join(" ") + " (" + arr.length + ")";
  }
  updatePreview();
  inp.addEventListener("input", updatePreview);
}

// ===== SIDEBAR TOGGLE =====
function toggleSidebar() {
  document.getElementById("sidebar").classList.toggle("hidden");
}

// ===== PANEL KEYBOARD SHORTCUTS =====
document.addEventListener("keydown", function(e) {
  if (!e.altKey) return;
  var num = parseInt(e.key, 10);
  if (num >= 1 && num <= 9 && PANELS.length >= num) {
    e.preventDefault();
    switchPanel(num - 1);
  }
});

// ===== INIT =====
dbg("NoteBlock inicializov√°n");

// ===== PWA =====
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js").then(function(reg) {
    dbg("Service Worker registrov√°n");
  }).catch(function(err) {
    dbg("SW chyba: " + err.message);
  });
}

if ("launchQueue" in window) {
  window.launchQueue.setConsumer(function(launchParams) {
    if (!launchParams.files || !launchParams.files.length) return;
    launchParams.files[0].getFile().then(function(file) {
      dbg("Soubor otev≈ôen p≈ôes File Handling: " + file.name);
      readBlockFile(file);
    }).catch(function(err) {
      dbg("Chyba p≈ôi otev√≠r√°n√≠ souboru: " + err.message);
    });
  });
}

// ===== ADVANCED EDITOR =====
var AE_ACTIVE = false;

function aeRenderBody(body, sid) {
  if (!body || !body.trim()) return "";
  var src = body;
  var phs = [], phc = 0;
  function addPH(html) { var k = "AEPH" + phc + "ZZ"; phs.push({k:k,h:html}); phc++; return k; }
  // CriticMarkup
  src = src.replace(/\{~~(.+?)~>(.+?)~~\}/g, function(m,o,n) { return addPH("<del>"+esc(o)+"</del><ins>"+esc(n)+"</ins>"); });
  src = src.replace(/\{\+\+(.+?)\+\+\}/g, function(m,t) { return addPH("<ins>"+esc(t)+"</ins>"); });
  src = src.replace(/\{--(.+?)--\}/g, function(m,t) { return addPH("<del>"+esc(t)+"</del>"); });
  src = src.replace(/\{==(.+?)==\}/g, function(m,t) { return addPH("<mark>"+esc(t)+"</mark>"); });
  src = src.replace(/\{>>(.+?)<<\}/g, function(m,t) { return addPH('<span class="cm-cmt">['+esc(t)+"]</span>"); });
  // Wiki links
  src = src.replace(/\[\[(.+?)\]\]/g, function(m,name) {
    var lk = findNoteByName(name.trim());
    if (lk) return addPH('<a href="#" class="wlink" onclick="advEd.closeAndOpen(\''+lk.id+'\');return false">'+esc(name)+"</a>");
    return addPH('<span class="wlink-broken">'+esc(name)+"</span>");
  });
  // Includes
  src = src.replace(/\{\{(.+?)\}\}/g, function(m,name) {
    var inc = findNoteByName(name.trim());
    if (!inc) return addPH('<em style="color:var(--danger)">[Include: '+esc(name)+"]</em>");
    return addPH('<div style="border-left:3px solid var(--accent);padding:4px 12px;margin:4px 0;opacity:.8"><small>üìé '+esc(name)+'</small></div>');
  });
  // Tasks
  var ti = 0;
  src = src.replace(/^- \[( |x)\] (.*)$/gm, function(m,chk,txt) {
    var ck = chk === "x";
    var h = '<label style="display:flex;align-items:baseline;gap:0"><input type="checkbox" onclick="advEd.toggleTask('+sid+','+ti+')" '+(ck?"checked":"")+' style="cursor:pointer"><span'+(ck?' class="task-done"':"")+">"+ esc(txt) +"</span></label>";
    ti++;
    return addPH(h);
  });
  // Tags: #word preceded by space/SOL, not inside code
  src = src.replace(/(^|[\s(])#([\u00C0-\u024F\u0100-\u017Fa-zA-Z0-9_]+)/gm, function(m,pre,tag) {
    return pre + addPH('<a href="#" class="ae-tag" onclick="event.preventDefault();advEd.filterByTag(\''+tag.toLowerCase()+'\');">#'+esc(tag)+"</a>");
  });
  var html;
  try { html = marked.parse(src); } catch(e) { html = "<pre>"+esc(src)+"</pre>"; }
  for (var i = 0; i < phs.length; i++) html = html.split(phs[i].k).join(phs[i].h);
  html = html.replace(/<a href="(https?:\/\/)/g, '<a target="_blank" rel="noopener" href="$1');
  return html;
}

function aeTagsInHeading(text, sid) {
  return text.replace(/(^|[\s(])#([\u00C0-\u024F\u0100-\u017Fa-zA-Z0-9_]+)/g, function(m,pre,tag) {
    return pre + '<a href="#" class="ae-tag" onclick="event.preventDefault();advEd.filterByTag(\''+tag.toLowerCase()+'\');">#'+esc(tag)+"</a>";
  });
}

var advEd = {
  sections: [],
  cnt: 0,
  editing: null,
  orig: null,
  hoisted: null,
  tagF: null,
  searchQ: "",
  noteId: null,

  open: function(nid) {
    var n = getNote(nid);
    if (!n) return;
    this.noteId = nid;
    this.cnt = 0;
    this.editing = null;
    this.hoisted = null;
    this.tagF = null;
    this.searchQ = "";
    this.parse(n.content || "");
    this.orig = JSON.parse(JSON.stringify(this.sections));
    AE_ACTIVE = true;
    this.render();
    dbg("Pokroƒçil√Ω editor otev≈ôen: " + n.name);
  },
  saveBack: function() {
    if (!this.noteId) return;
    var n = getNote(this.noteId);
    if (n) { n.content = this.gen(); n.modified = now(); }
  },
  close: function() {
    if (!this.noteId) return;
    this.endPresentation();
    this.saveBack();
    var nid = this.noteId;
    this.noteId = null;
    this.sections = [];
    this.orig = null;
    AE_ACTIVE = false;
    renderNoteView(nid);
    renderNav();
    dbg("Pokroƒçil√Ω editor zav≈ôen");
  },
  closeAndOpen: function(targetNoteId) {
    this.endPresentation();
    this.saveBack();
    this.noteId = null;
    this.sections = [];
    this.orig = null;
    AE_ACTIVE = false;
    openNote(targetNoteId);
  },

  // Parse markdown into section tree
  parse: function(content) {
    var lines = content.split("\n");
    var secs = [], cur = null, stack = [];
    for (var i = 0; i < lines.length; i++) {
      var hm = lines[i].match(/^(#{1,6})\s+(.+)$/);
      if (hm) {
        var s = {id:++this.cnt, lv:hm[1].length, hd:hm[2], bd:"", col:false, ccol:false, kids:[]};
        while (stack.length > 0 && stack[stack.length-1].lv >= s.lv) stack.pop();
        if (stack.length === 0) secs.push(s); else stack[stack.length-1].kids.push(s);
        stack.push(s);
        cur = s;
      } else if (cur) {
        cur.bd += (cur.bd ? "\n" : "") + lines[i];
      }
    }
    var trim = function(ss) { for (var j=0;j<ss.length;j++) { ss[j].bd=ss[j].bd.replace(/^\s+|\s+$/g,""); if (ss[j].kids.length) trim(ss[j].kids); } };
    trim(secs);
    this.sections = secs;
  },

  // Generate markdown from section tree
  gen: function() {
    var g = function(s, first) {
      var md = first ? "" : "\n";
      var hashes = ""; for (var i=0;i<s.lv;i++) hashes+="#";
      md += hashes + " " + s.hd + "\n";
      if (s.bd && s.bd.replace(/^\s+|\s+$/g,"")) md += "\n" + s.bd.replace(/^\s+|\s+$/g,"") + "\n";
      for (var i=0; i<s.kids.length; i++) md += g(s.kids[i], false);
      return md;
    };
    var md = "";
    for (var i=0; i<this.sections.length; i++) md += g(this.sections[i], i===0);
    var r = md.replace(/^\s+|\s+$/g,"");
    return r ? r + "\n" : "";
  },

  // Helpers
  find: function(ss, id) { for (var i=0;i<ss.length;i++) { if (ss[i].id===id) return ss[i]; if (ss[i].kids.length) { var f=this.find(ss[i].kids,id); if (f) return f; } } return null; },
  findWP: function(ss, id, par) { for (var i=0;i<ss.length;i++) { if (ss[i].id===id) return {s:ss[i],p:par,i:i}; if (ss[i].kids.length) { var f=this.findWP(ss[i].kids,id,ss[i]); if (f) return f; } } return null; },
  countAll: function(s) { var c=s.kids.length; for (var i=0;i<s.kids.length;i++) c+=this.countAll(s.kids[i]); return c; },
  countCW: function(s) { var t=(s.hd||"")+" "+(s.bd||""); var ch=t.length, w=t.replace(/^\s+|\s+$/g,"").split(/\s+/).filter(function(x){return x.length>0}).length; for (var i=0;i<s.kids.length;i++) { var c=this.countCW(s.kids[i]); ch+=c.ch; w+=c.w; } return {ch:ch,w:w}; },
  countTasks: function(s) { var tt=0,ct=0; if (s.bd) { var ls=s.bd.split("\n"); for (var i=0;i<ls.length;i++) { var m=ls[i].match(/^\s*-\s+\[([ xX])\]/); if (m) { tt++; if (m[1]!==" ") ct++; } } } for (var i=0;i<s.kids.length;i++) { var c=this.countTasks(s.kids[i]); tt+=c.t; ct+=c.d; } return {t:tt,d:ct}; },
  countWip: function(s) { var t=1, w=(s.hd&&s.hd.indexOf("\u270F\uFE0F")>=0)?1:0; for (var i=0;i<s.kids.length;i++) { var c=this.countWip(s.kids[i]); t+=c.t; w+=c.w; } return {t:t,w:w}; },
  isNew: function(id) { if (!this.orig) return false; return !this.find(this.orig,id); },
  hasChH: function(s) { if (!this.orig) return false; var o=this.find(this.orig,s.id); return o?o.hd!==s.hd:false; },
  hasChB: function(s) { if (!this.orig) return false; var o=this.find(this.orig,s.id); return o?o.bd!==s.bd:false; },
  countChanged: function(s) { var isN=this.isNew(s.id),chH=this.hasChH(s),chB=this.hasChB(s); var cc=0,cw=0; if (isN) { var t=(s.hd||"")+" "+(s.bd||""); cc=t.length; cw=t.replace(/^\s+|\s+$/g,"").split(/\s+/).filter(function(x){return x.length>0}).length; } else { if (chH) { cc+=(s.hd||"").length; cw+=(s.hd||"").replace(/^\s+|\s+$/g,"").split(/\s+/).filter(function(x){return x.length>0}).length; } if (chB) { cc+=(s.bd||"").length; cw+=(s.bd||"").replace(/^\s+|\s+$/g,"").split(/\s+/).filter(function(x){return x.length>0}).length; } } for (var i=0;i<s.kids.length;i++) { var c=this.countChanged(s.kids[i]); cc+=c.cc; cw+=c.cw; } return {cc:cc,cw:cw}; },
  getPos: function(ss,id,ps) { var ts=ps||ss; for (var i=0;i<ts.length;i++) { if (ts[i].id===id) return {idx:i+1,tot:ts.length}; if (ts[i].kids.length) { var f=this.getPos(ss,id,ts[i].kids); if (f) return f; } } return null; },
  canInc: function(id) { var r=this.findWP(this.sections,id,null); return r&&r.i>0; },
  canDec: function(id) { var r=this.findWP(this.sections,id,null); return r&&r.p!==null; },
  extractTags: function(t) { if (!t) return []; var rx=/(?:^|[\s(])#([\u00C0-\u024F\u0100-\u017Fa-zA-Z0-9_]+)/g, tags=[], m; while ((m=rx.exec(t))!==null) tags.push(m[1].toLowerCase()); return tags; },
  getAllTags: function() { var tc={}; var proc=function(ss) { for (var i=0;i<ss.length;i++) { var ht=advEd.extractTags(ss[i].hd), bt=advEd.extractTags(ss[i].bd); for (var j=0;j<ht.length;j++) tc[ht[j]]=(tc[ht[j]]||0)+1; for (var j=0;j<bt.length;j++) tc[bt[j]]=(tc[bt[j]]||0)+1; if (ss[i].kids.length) proc(ss[i].kids); } }; proc(this.sections); return Object.keys(tc).sort().map(function(t){return {tag:t,count:tc[t]};}); },
  secHasTag: function(s,tag) { var a=this.extractTags(s.hd).concat(this.extractTags(s.bd)); return a.indexOf(tag.toLowerCase())>=0; },
  secMatchQ: function(s,q) { if (!q) return true; var lq=q.toLowerCase(); return (s.hd&&s.hd.toLowerCase().indexOf(lq)>=0)||(s.bd&&s.bd.toLowerCase().indexOf(lq)>=0); },
  getBreadcrumb: function(ss,tid,path) { path=path||[]; for (var i=0;i<ss.length;i++) { if (ss[i].id===tid) return path.concat([ss[i]]); if (ss[i].kids.length) { var f=this.getBreadcrumb(ss[i].kids,tid,path.concat([ss[i]])); if (f) return f; } } return null; },

  // Actions
  toggleCollapse: function(id) { var s=this.find(this.sections,id); if (s) { s.col=!s.col; this.render(); } },
  toggleContent: function(id) { var s=this.find(this.sections,id); if (s) { s.ccol=!s.ccol; this.render(); } },
  collapseAll: function() { var set=function(ss,v) { for (var i=0;i<ss.length;i++) { if (ss[i].kids.length) { ss[i].col=v; set(ss[i].kids,v); } } }; set(this.sections,true); this.render(); },
  expandAll: function() { var set=function(ss,v) { for (var i=0;i<ss.length;i++) { ss[i].col=v; if (ss[i].kids.length) set(ss[i].kids,v); } }; set(this.sections,false); this.render(); },
  editSection: function(id) { this.editing=id; this.render(); setTimeout(function(){ var inp=document.querySelector("#ae-s-"+id+" .ae-hinp"); if (inp) { inp.focus(); inp.setSelectionRange(inp.value.length,inp.value.length); } },80); },
  saveSection: function(id) { this.editing=null; this.saveBack(); this.render(); },
  updateHd: function(id,v) { var s=this.find(this.sections,id); if (s) s.hd=v; },
  updateBd: function(id,v) { var s=this.find(this.sections,id); if (s) s.bd=v; },
  delSection: function(id) { if (!confirm("Smazat tuto sekci a v≈°echny podsekce?")) return; var rm=function(ss,id) { return ss.filter(function(s) { if (s.id===id) return false; if (s.kids.length) s.kids=rm(s.kids,id); return true; }); }; this.sections=rm(this.sections,id); this.render(); },
  addRoot: function() { var s={id:++this.cnt,lv:1,hd:"\u270F\uFE0F",bd:"",col:false,ccol:false,kids:[]}; this.sections.push(s); this.editing=s.id; this.render(); },
  addChild: function(pid) { var p=this.find(this.sections,pid); if (!p) return; var s={id:++this.cnt,lv:p.lv+1,hd:"\u270F\uFE0F",bd:"",col:false,ccol:false,kids:[]}; p.kids.push(s); p.col=false; this.editing=s.id; this.render(); },
  addSibling: function(id) { var r=this.findWP(this.sections,id,null); if (!r) return; var ss=r.p?r.p.kids:this.sections; var s={id:++this.cnt,lv:r.s.lv,hd:"\u270F\uFE0F",bd:"",col:false,ccol:false,kids:[]}; ss.splice(r.i+1,0,s); this.editing=s.id; this.render(); },
  moveUp: function(id) { var r=this.findWP(this.sections,id,null); if (!r||r.i<1) return; var ss=r.p?r.p.kids:this.sections; var t=ss[r.i]; ss[r.i]=ss[r.i-1]; ss[r.i-1]=t; this.render(); },
  moveDown: function(id) { var r=this.findWP(this.sections,id,null); if (!r) return; var ss=r.p?r.p.kids:this.sections; if (r.i>=ss.length-1) return; var t=ss[r.i]; ss[r.i]=ss[r.i+1]; ss[r.i+1]=t; this.render(); },
  incLevel: function(id) { var r=this.findWP(this.sections,id,null); if (!r||r.i<1) return; var ss=r.p?r.p.kids:this.sections; var s=ss[r.i]; var np=ss[r.i-1]; ss.splice(r.i,1); s.lv=np.lv+1; this._updLvl(s); np.kids.push(s); np.col=false; this.render(); },
  decLevel: function(id) { var r=this.findWP(this.sections,id,null); if (!r||!r.p) return; var gpr=this.findWP(this.sections,r.p.id,null); if (!gpr) return; var s=r.p.kids[r.i]; r.p.kids.splice(r.i,1); var tss=gpr.p?gpr.p.kids:this.sections; var pi=-1; for (var i=0;i<tss.length;i++) { if (tss[i].id===r.p.id) { pi=i; break; } } s.lv=r.p.lv; this._updLvl(s); tss.splice(pi+1,0,s); this.render(); },
  _updLvl: function(s) { for (var i=0;i<s.kids.length;i++) { s.kids[i].lv=s.lv+1; this._updLvl(s.kids[i]); } },
  hoistSection: function(id) { this.hoisted=id; this.render(); },
  unhoistAll: function() { this.hoisted=null; this.render(); },
  filterByTag: function(tag) { this.tagF=tag.toLowerCase(); this.render(); },
  clearTagF: function() { this.tagF=null; this.render(); },
  setSearch: function(q) { this.searchQ=q.replace(/^\s+|\s+$/g,""); this.render(); },
  clearSearch: function() { this.searchQ=""; this.render(); },
  removeCompleted: function(sid) { var s=this.find(this.sections,sid); if (!s||!s.bd) return; if (!confirm("Odstranit hotov√© √∫koly z t√©to sekce?")) return; var ls=s.bd.split("\n"); s.bd=ls.filter(function(l) { var m=l.match(/^\s*-\s+\[([ xX])\]/); return !m||m[1]===" "; }).join("\n"); this.render(); },
  removeTags: function(sid) { var s=this.find(this.sections,sid); if (!s) return; var rx = /#[\u00C0-\u024F\u0100-\u017Fa-zA-Z0-9_]+\s?/g; if (s.hd) s.hd=s.hd.replace(rx,"").replace(/^\s+|\s+$/g,""); if (s.bd) s.bd=s.bd.replace(rx,""); this.render(); },
  toggleTask: function(sid,ti) { var s=this.find(this.sections,sid); if (!s||!s.bd) return; var ls=s.bd.split("\n"),ci=0; for (var i=0;i<ls.length;i++) { var m=ls[i].match(/^(\s*)-\s+\[([ xX])\](.*)$/); if (m) { if (ci===ti) { ls[i]=m[1]+"- ["+(m[2]===" "?"x":" ")+"]"+m[3]; s.bd=ls.join("\n"); this.render(); return; } ci++; } } },

  // Presentation
  presState: null,
  _presKeyHandler: null,
  canPresent: function(s) { return s && s.kids && s.kids.length > 0; },
  startPresentation: function(sid) {
    var s = this.find(this.sections, sid);
    if (!s || !this.canPresent(s)) { alert("Tato sekce nem√° podsekce pro prezentaci."); return; }
    var slides = [];
    slides.push({type:"title", hd:s.hd, bd:s.bd||""});
    this._collectSlides(s.kids, slides);
    this.presState = {active:true, slides:slides, idx:0, title:s.hd, start:Date.now(), timer:null, overview:false};
    this._renderPres();
    var self = this;
    this.presState.timer = setInterval(function() {
      var el = document.getElementById("pres-timer");
      if (el && self.presState && self.presState.active) el.textContent = self._formatTime();
    }, 1000);
    this._presKeyHandler = function(e) { self._presKey(e); };
    document.addEventListener("keydown", this._presKeyHandler);
  },
  _collectSlides: function(secs, slides) {
    for (var i=0;i<secs.length;i++) {
      var s=secs[i], hk=s.kids&&s.kids.length>0, hb=s.bd&&s.bd.replace(/^\s+|\s+$/g,"");
      if (!hb && hk) {
        slides.push({type:"section", hd:s.hd});
        this._collectSlides(s.kids, slides);
      } else {
        slides.push({type:"content", hd:s.hd, bd:s.bd||"", kids:s.kids||[]});
      }
    }
  },
  _formatTime: function() {
    if (!this.presState) return "0:00";
    var el = Math.floor((Date.now()-this.presState.start)/1000);
    var h=Math.floor(el/3600), m=Math.floor((el%3600)/60), s=el%60;
    var ms = (m<10?"0":"")+m, ss = (s<10?"0":"")+s;
    return h>0 ? h+":"+ms+":"+ss : m+":"+ss;
  },
  _renderPres: function() {
    var st=this.presState; if (!st||!st.active) return;
    var slide=st.slides[st.idx], total=st.slides.length, cur=st.idx+1;
    var ex=document.getElementById("pres-container"); if (ex) ex.remove();
    var isOv=st.overview;
    var c=document.createElement("div"); c.id="pres-container";
    var h='<div class="pres-overlay" role="dialog" aria-modal="true">';
    h+='<header class="pres-hdr">';
    h+='<div class="pres-timer" id="pres-timer">'+this._formatTime()+'</div>';
    h+='<div class="pres-nav">';
    h+='<button onclick="advEd.prevSlide()"'+(cur===1||isOv?" disabled":"")+' title="P\u0159edchoz\u00ED (\u2190)">\u2190 P\u0159edchoz\u00ED</button>';
    h+='<span class="pres-counter">'+cur+" / "+total+"</span>";
    h+='<button onclick="advEd.nextSlide()"'+(cur===total||isOv?" disabled":"")+' title="Dal\u0161\u00ED (\u2192)">Dal\u0161\u00ED \u2192</button>';
    h+='<button onclick="advEd.toggleOverview()" title="P\u0159ehled (O)" style="margin-left:8px">'+(isOv?"\uD83C\uDFAC Slajdy":"\uD83D\uDCCB P\u0159ehled")+"</button>";
    h+="</div>";
    h+='<button class="pres-close" onclick="advEd.endPresentation()">\u2715 Zav\u0159\u00EDt</button>';
    h+="</header>";
    h+='<div class="pres-title-bar"><div class="pres-title-text">\uD83D\uDCFD\uFE0F '+esc(st.title||"Prezentace")+"</div></div>";
    if (isOv) {
      h+='<div class="pres-overview">';
      for (var i=0;i<st.slides.length;i++) {
        h+='<button class="pres-ov-item'+(i===st.idx?" active":"")+'" onclick="advEd.goToSlideOv('+i+')">';
        h+='<div class="pres-ov-num">'+(i+1)+"</div>";
        h+='<div class="pres-ov-cnt '+st.slides[i].type+'"><h3>'+esc(st.slides[i].hd||"")+"</h3></div>";
        h+="</button>";
      }
      h+="</div>";
    } else {
      h+='<main class="pres-main" tabindex="-1">'+this._renderSlide(slide)+"</main>";
    }
    h+='<div class="pres-sr" role="status" aria-live="polite">Kl\u00E1vesy: \u2190\u2192 navigace, O p\u0159ehled, Home/End, Esc zav\u0159\u00EDt</div>';
    h+="</div>";
    c.innerHTML=h;
    document.body.appendChild(c);
    if (isOv) { var fi=c.querySelector(".pres-ov-item"); if (fi) fi.focus(); }
    else { var mc=c.querySelector(".pres-main"); if (mc) mc.focus(); }
  },
  _renderSlide: function(slide) {
    if (slide.type==="title") {
      var bh=""; try { bh=slide.bd?marked.parse(slide.bd):""; } catch(e){}
      return '<div class="pres-slide pres-title"><h1>'+esc(slide.hd||"")+"</h1>"+(bh?'<div class="pres-slide-body">'+bh+"</div>":"")+"</div>";
    }
    if (slide.type==="section") {
      return '<div class="pres-slide pres-section"><h2>'+esc(slide.hd||"")+"</h2></div>";
    }
    var bh2=""; try { bh2=slide.bd?marked.parse(slide.bd):""; } catch(e){}
    var ch="";
    if (slide.kids&&slide.kids.length) ch="<ul>"+this._renderSlideKids(slide.kids)+"</ul>";
    return '<div class="pres-slide"><h2>'+esc(slide.hd||"")+"</h2>"+(bh2?'<div class="pres-slide-body">'+bh2+"</div>":"")+ch+"</div>";
  },
  _renderSlideKids: function(kids) {
    var h="";
    for (var i=0;i<kids.length;i++) {
      var nested="";
      if (kids[i].kids&&kids[i].kids.length) nested="<ul>"+this._renderSlideKids(kids[i].kids)+"</ul>";
      h+="<li>"+esc(kids[i].hd)+nested+"</li>";
    }
    return h;
  },
  _presKey: function(e) {
    if (!this.presState||!this.presState.active) return;
    var ov=this.presState.overview;
    switch(e.key) {
      case "ArrowRight": case " ": case "PageDown": if (!ov) { e.preventDefault(); this.nextSlide(); } break;
      case "ArrowLeft": case "PageUp": if (!ov) { e.preventDefault(); this.prevSlide(); } break;
      case "Home": e.preventDefault(); this.goToSlide(0); break;
      case "End": e.preventDefault(); this.goToSlide(this.presState.slides.length-1); break;
      case "Escape": e.preventDefault(); if (ov) this.toggleOverview(); else this.endPresentation(); break;
      case "o": case "O": e.preventDefault(); this.toggleOverview(); break;
    }
  },
  nextSlide: function() { if (this.presState&&this.presState.idx<this.presState.slides.length-1) { this.presState.idx++; this._renderPres(); } },
  prevSlide: function() { if (this.presState&&this.presState.idx>0) { this.presState.idx--; this._renderPres(); } },
  goToSlide: function(i) { if (this.presState&&i>=0&&i<this.presState.slides.length) { this.presState.idx=i; this.presState.overview=false; this._renderPres(); } },
  goToSlideOv: function(i) { if (this.presState) { this.presState.idx=i; this.presState.overview=false; this._renderPres(); } },
  toggleOverview: function() { if (this.presState) { this.presState.overview=!this.presState.overview; this._renderPres(); } },
  endPresentation: function() {
    if (!this.presState) return;
    if (this.presState.timer) clearInterval(this.presState.timer);
    this.presState.active=false;
    var c=document.getElementById("pres-container"); if (c) c.remove();
    if (this._presKeyHandler) { document.removeEventListener("keydown",this._presKeyHandler); this._presKeyHandler=null; }
    this.presState=null;
  },
  startPresFromRoot: function() {
    // If hoisted, present that section; otherwise present first section with kids, or build virtual root
    if (this.hoisted) { this.startPresentation(this.hoisted); return; }
    if (this.sections.length===0) { alert("≈Ω√°dn√© sekce k prezentaci."); return; }
    // If there's one top-level section with kids, present it
    if (this.sections.length===1 && this.sections[0].kids.length>0) { this.startPresentation(this.sections[0].id); return; }
    // Build virtual presentation from all top-level sections
    var slides=[], n=getNote(this.noteId);
    slides.push({type:"title", hd:n?n.name:"Prezentace", bd:""});
    for (var i=0;i<this.sections.length;i++) {
      var s=this.sections[i], hk=s.kids&&s.kids.length>0, hb=s.bd&&s.bd.replace(/^\s+|\s+$/g,"");
      if (!hb&&hk) { slides.push({type:"section",hd:s.hd}); this._collectSlides(s.kids,slides); }
      else { slides.push({type:"content",hd:s.hd,bd:s.bd||"",kids:s.kids||[]}); }
    }
    this.presState={active:true,slides:slides,idx:0,title:n?n.name:"Prezentace",start:Date.now(),timer:null,overview:false};
    this._renderPres();
    var self=this;
    this.presState.timer=setInterval(function(){ var el=document.getElementById("pres-timer"); if (el&&self.presState&&self.presState.active) el.textContent=self._formatTime(); },1000);
    this._presKeyHandler=function(e){ self._presKey(e); };
    document.addEventListener("keydown",this._presKeyHandler);
  },

  // DOCX export of visible sections
  exportDocx: function() {
    if (!this.sections.length) return;
    var vis = this._getVisible();
    var md = "";
    var g = function(ss) { for (var i=0;i<ss.length;i++) { var hashes=""; for (var j=0;j<Math.min(ss[i].lv,6);j++) hashes+="#"; md+=hashes+" "+ss[i].hd+"\n\n"; if (ss[i].bd&&ss[i].bd.replace(/^\s+|\s+$/g,"")) md+=ss[i].bd.replace(/^\s+|\s+$/g,"")+"\n\n"; if (ss[i].kids&&ss[i].kids.length) g(ss[i].kids); } };
    g(vis);
    var n = getNote(this.noteId);
    var resolved = resolveIncludes(md.replace(/^\s+|\s+$/g,""));
    var result = mdToDocxXml(resolved, n ? n.name : "Export");
    buildDocxZip(result.xml, (n ? sanitize(n.name) : "export") + "-filtered.docx", result.numInstances);
  },
  _getVisible: function() {
    var ss = this.sections;
    if (this.hoisted) { var h=this.find(ss,this.hoisted); if (h) ss=[h]; }
    if (this.searchQ) ss = this._filterSecs(ss,"s");
    if (this.tagF) ss = this._filterSecs(ss,"t");
    return ss;
  },
  _filterSecs: function(ss, type) {
    var self=this, flt=[];
    for (var i=0;i<ss.length;i++) {
      var ok = type==="t" ? self.secHasTag(ss[i],self.tagF) : self.secMatchQ(ss[i],self.searchQ);
      var fc = ss[i].kids.length ? self._filterSecs(ss[i].kids,type) : [];
      if (ok||fc.length) { flt.push({id:ss[i].id,hd:ss[i].hd,bd:ss[i].bd,lv:ss[i].lv,col:ss[i].col,ccol:ss[i].ccol,kids:ok?self._filterSecs(ss[i].kids,type):fc}); }
    }
    return flt;
  },

  // Render section
  rSec: function(s) {
    var hk = s.kids.length > 0;
    var ci = hk ? (s.col ? "\u25B6" : "\u25BC") : "";
    var isEd = this.editing === s.id;
    var r = this.findWP(this.sections, s.id, null);
    var cU = r && r.i > 0;
    var cD = r && r.i < (r.p ? r.p.kids : this.sections).length - 1;
    var cI = this.canInc(s.id);
    var cDe = this.canDec(s.id);
    var isN = this.isNew(s.id);
    var chH = this.hasChH(s);
    var chB = this.hasChB(s);
    var pos = this.getPos(this.sections, s.id);
    var posT = pos ? pos.idx + "/" + pos.tot : "";
    var sid = s.id;
    var h = "";

    if (isEd) {
      h += '<li class="ae-item'+(s.col?" ae-coll":"")+'"><article class="ae-art" id="ae-s-'+sid+'">';
      h += '<div class="ae-hdr"><div class="ae-ctrl">';
      if (hk) h += '<button class="ae-ib" onclick="advEd.toggleCollapse('+sid+')">'+ci+'</button>';
      else h += '<div style="width:26px"></div>';
      h += '</div><div class="ae-cnt">';
      h += '<div class="ae-lvl">\u00DArov. '+s.lv+(posT?" \u00B7 "+posT:"")+'</div>';
      h += '<input class="ae-hinp" value="'+esc(s.hd)+'" oninput="advEd.updateHd('+sid+',this.value)" placeholder="Nadpis sekce">';
      h += '<textarea class="ae-bta" oninput="advEd.updateBd('+sid+',this.value)" placeholder="Obsah sekce (Markdown)">'+esc(s.bd)+'</textarea>';
      h += '<div class="ae-editctl"><button class="sm primary" onclick="advEd.saveSection('+sid+')">\u2713 Ulo\u017Eit sekci</button></div>';
      h += '<div class="ae-acts">';
      h += '<button class="sm" onclick="advEd.addChild('+sid+')">\u2795 Pod</button>';
      h += '<button class="sm" onclick="advEd.addSibling('+sid+')">\u2795 Vedle</button>';
      if (hk) h += '<button class="sm" onclick="advEd.startPresentation('+sid+')">\uD83C\uDFAC</button>';
      h += '<button class="ae-ib" onclick="advEd.moveUp('+sid+')"'+(cU?"":" disabled")+' title="Nahoru">\u2B06</button>';
      h += '<button class="ae-ib" onclick="advEd.moveDown('+sid+')"'+(cD?"":" disabled")+' title="Dol\u016F">\u2B07</button>';
      h += '<button class="ae-ib" onclick="advEd.incLevel('+sid+')"'+(cI?"":" disabled")+' title="Odsadit \u2192">\u27A1</button>';
      h += '<button class="ae-ib" onclick="advEd.decLevel('+sid+')"'+(cDe?"":" disabled")+' title="P\u0159edsadit \u2190">\u2B05</button>';
      h += '<button class="ae-ib dng" onclick="advEd.delSection('+sid+')" title="Smazat">\uD83D\uDDD1</button>';
      h += '</div></div></div>';
      if (hk) { h+='<ul class="ae-kids ae-tree">'; for (var i=0;i<s.kids.length;i++) h+=this.rSec(s.kids[i]); h+="</ul>"; }
      h += '</article></li>';
      return h;
    }

    // View mode
    var hlv = Math.min(s.lv, 6);
    var ht = esc(s.hd) || "<em>Pr\u00E1zdn\u00E1</em>";
    ht = aeTagsInHeading(ht, sid);
    if (isN) ht = '<ins title="Nov\u00E1 sekce">'+ht+'</ins>';
    else if (chH) ht = '<ins title="Zm\u011Bn\u011Bno">'+ht+'</ins>';
    var headH = "<h"+hlv+">"+ht+"</h"+hlv+">";

    var hasBody = s.bd && s.bd.replace(/^\s+|\s+$/g,"").length > 0;
    var bodyH = "";
    if (hasBody && !s.ccol) {
      var rb = aeRenderBody(s.bd, sid);
      if (isN||chB) rb = '<ins title="'+(isN?"Nov\u00FD obsah":"Zm\u011Bn\u011Bno")+'">'+rb+'</ins>';
      bodyH = '<div class="ae-bdsp">'+rb+"</div>";
    }
    var ccI = s.ccol ? "\u25B6" : "\u25BC";

    h += '<li class="ae-item'+(s.col?" ae-coll":"")+'"><article class="ae-art" id="ae-s-'+sid+'">';
    h += '<div class="ae-hdr"><div class="ae-ctrl">';
    if (hk) h += '<button class="ae-ib" onclick="advEd.toggleCollapse('+sid+')" title="'+(s.col?"Rozbalit":"Sbalit")+' podsekce">'+ci+'</button>';
    else h += '<div style="width:26px"></div>';
    if (hasBody) h += '<button class="ae-ib" onclick="advEd.toggleContent('+sid+')" title="'+(s.ccol?"Zobrazit":"Skr\u00FDt")+' obsah"'+(s.ccol?' style="background:var(--warn)"':"")+'>'+ccI+'</button>';
    else h += '<div style="width:26px"></div>';
    h += '</div><div class="ae-cnt">';
    h += '<div class="ae-lvl">\u00DArov. '+s.lv+(posT?" \u00B7 "+posT:"")+'</div>';
    h += '<div class="ae-hdsp">'+headH+'</div>';

    // Badges
    if (hk) { var ca=this.countAll(s); h+='<span class="ae-bg i">\uD83D\uDCE6 '+(s.col?"sbaleno":"rozbaleno")+", "+ca+" pods.</span>"; }
    if (hk) { var wp=this.countWip(s); if (wp.w>0) { var cd=wp.t-wp.w; var pc=wp.t>0?Math.round(cd/wp.t*100):0; h+='<span class="ae-bg w">\u270F\uFE0F '+wp.w+" rozpr., \u2713 "+cd+" hotovo ("+pc+"%)</span>"; } }
    var ts=this.countTasks(s); if (ts.t>0) { var pc2=Math.round(ts.d/ts.t*100); h+='<span class="ae-bg g">\u2713 '+ts.d+"/"+ts.t+" \u00FAkol\u016F ("+pc2+"%)</span>"; }
    var cw=this.countCW(s); var chg=this.countChanged(s);
    h+='<span class="ae-bg s">\uD83D\uDCCA '+cw.ch+" zn., "+cw.w+" slov";
    if (chg.cc>0||chg.cw>0) h+=" | \u2795"+chg.cc+" zn., "+chg.cw+" slov";
    h+="</span>";

    h += bodyH;

    // Actions
    h += '<div class="ae-acts">';
    if (ts.d>0) h+='<button class="sm" onclick="advEd.removeCompleted('+sid+')">\uD83D\uDDD1 Hotov\u00E9 \u00FAkoly</button>';
    var htags=this.extractTags(s.hd), btags=this.extractTags(s.bd);
    if (htags.length||btags.length) h+='<button class="sm" onclick="advEd.removeTags('+sid+')">\uD83C\uDFF7 Odebrat tagy</button>';
    h += '<button class="sm" onclick="advEd.editSection('+sid+')">\u270F\uFE0F Upravit</button>';
    h += '<button class="sm" onclick="advEd.hoistSection('+sid+')">\uD83D\uDD0D Izolovat</button>';
    if (hk) h += '<button class="sm" onclick="advEd.startPresentation('+sid+')">\uD83C\uDFAC Prezentace</button>';
    h += '<button class="sm" onclick="advEd.addChild('+sid+')">\u2795 Pod</button>';
    h += '<button class="sm" onclick="advEd.addSibling('+sid+')">\u2795 Vedle</button>';
    h += '<button class="ae-ib" onclick="advEd.moveUp('+sid+')"'+(cU?"":" disabled")+' title="Nahoru">\u2B06</button>';
    h += '<button class="ae-ib" onclick="advEd.moveDown('+sid+')"'+(cD?"":" disabled")+' title="Dol\u016F">\u2B07</button>';
    h += '<button class="ae-ib" onclick="advEd.incLevel('+sid+')"'+(cI?"":" disabled")+' title="Odsadit \u2192">\u27A1</button>';
    h += '<button class="ae-ib" onclick="advEd.decLevel('+sid+')"'+(cDe?"":" disabled")+' title="P\u0159edsadit \u2190">\u2B05</button>';
    h += '<button class="ae-ib dng" onclick="advEd.delSection('+sid+')" title="Smazat">\uD83D\uDDD1</button>';
    h += "</div></div></div>";
    if (hk) { h+='<ul class="ae-kids ae-tree">'; for (var i=0;i<s.kids.length;i++) h+=this.rSec(s.kids[i]); h+="</ul>"; }
    h += "</article></li>";
    return h;
  },

  // Main render
  render: function() {
    var tb = document.getElementById("toolbar");
    var vw = document.getElementById("view");
    if (!tb||!vw) return;
    var n = getNote(this.noteId);
    var nName = n ? esc(n.name) : "";

    // Toolbar
    var tbH = '<button class="sm" onclick="advEd.close()">\u2B05 Zp\u011Bt</button>';
    tbH += '<span class="sep"></span>';
    tbH += '<button class="sm" onclick="advEd.addRoot()">\u2795 Sekce</button>';
    tbH += '<button class="sm" onclick="advEd.expandAll()">\u229E Rozbalit</button>';
    tbH += '<button class="sm" onclick="advEd.collapseAll()">\u229F Sbalit</button>';
    tbH += '<button class="sm" onclick="advEd.exportDocx()">\uD83D\uDCC4 DOCX</button>';
    tbH += '<button class="sm" onclick="advEd.startPresFromRoot()">\uD83C\uDFAC Prezentace</button>';
    tbH += '<span class="sep"></span>';
    var tags = this.getAllTags();
    if (tags.length > 0) {
      for (var i=0;i<tags.length;i++) {
        var ac = this.tagF===tags[i].tag;
        tbH += '<button class="sm'+(ac?" primary":"")+'" onclick="advEd.filterByTag(\''+esc(tags[i].tag)+'\')" style="padding:2px 6px;font-size:.78rem">#'+esc(tags[i].tag)+' <small>('+tags[i].count+')</small></button>';
      }
      if (this.tagF) tbH += '<button class="sm danger" onclick="advEd.clearTagF()" style="padding:2px 6px">\u2715</button>';
      tbH += '<span class="sep"></span>';
    }
    tbH += '<input class="ae-srch" id="ae-srch" placeholder="Hledat v sekc\u00EDch..." value="'+esc(this.searchQ)+'" onkeydown="if(event.key===\'Enter\')advEd.setSearch(this.value)">';
    tbH += '<button class="sm" onclick="advEd.setSearch(document.getElementById(\'ae-srch\').value)">\uD83D\uDD0D</button>';
    if (this.searchQ) tbH += '<button class="sm danger" onclick="advEd.clearSearch()">\u2715</button>';
    tb.innerHTML = tbH;

    // Content
    var h = '<h6 style="margin:0 0 4px;font-size:.72rem;text-transform:uppercase;color:var(--text2);letter-spacing:.5px">Pokro\u010Dil\u00FD editor</h6>';
    h += '<h2 style="margin:0 0 12px;font-size:1.1rem">\u2699 '+nName+'</h2>';

    if (this.sections.length === 0) {
      h += '<div style="padding:30px;text-align:center;color:var(--text2)">\u017D\u00E1dn\u00E9 sekce. Klikn\u011Bte <b>\u2795 Sekce</b> pro p\u0159id\u00E1n\u00ED.</div>';
      vw.innerHTML = h;
      return;
    }

    var secs = this.sections;
    if (this.hoisted) { var hs=this.find(this.sections,this.hoisted); if (hs) secs=[hs]; }
    if (this.searchQ) secs = this._filterSecs(secs,"s");
    if (this.tagF) secs = this._filterSecs(secs,"t");

    // Breadcrumb for hoist
    if (this.hoisted) {
      var bc = this.getBreadcrumb(this.sections, this.hoisted);
      if (bc) {
        h += '<div class="ae-ban" style="background:var(--warn);color:#000">\uD83D\uDD0D ';
        for (var bi=0;bi<bc.length;bi++) {
          if (bi>0) h += " \u203A ";
          if (bi<bc.length-1) h += '<a href="#" onclick="event.preventDefault();advEd.hoistSection('+bc[bi].id+')" style="color:#000;text-decoration:underline">'+esc(bc[bi].hd)+"</a>";
          else h += "<b>"+esc(bc[bi].hd)+"</b>";
        }
        h += ' <button class="sm" onclick="advEd.unhoistAll()" style="margin-left:auto">\u2715 Zru\u0161it izolaci</button></div>';
      }
    }
    if (this.searchQ) {
      h += '<div class="ae-ban" style="background:var(--success);color:#fff">\uD83D\uDD0D V\u00FDsledky: "'+esc(this.searchQ)+'" ('+secs.length+' sekc\u00ED) <button class="sm" onclick="advEd.clearSearch()" style="margin-left:auto">\u2715</button></div>';
    }
    if (this.tagF) {
      h += '<div class="ae-ban" style="background:var(--accent);color:#fff">\uD83C\uDFF7 Filtr: #'+esc(this.tagF)+' <button class="sm" onclick="advEd.clearTagF()" style="margin-left:auto">\u2715</button></div>';
    }

    h += '<ul class="ae-tree">';
    for (var i=0;i<secs.length;i++) h += this.rSec(secs[i]);
    h += "</ul>";

    vw.innerHTML = h;
  }
};

function openAdvEditor(noteId) {
  advEd.open(noteId);
}

/* ======== CriticMarkup Review Module ======== */
var CM_ACTIVE = false;
var cmRev = {
  noteId: null, src: "", chs: [], chId: 0, editing: false,

  open: function(noteId) {
    var n = getNote(noteId);
    if (!n) return;
    if (AE_ACTIVE) { advEd.saveBack(); AE_ACTIVE = false; advEd.noteId = null; advEd.sections = []; }
    if (TE_ACTIVE) { TE_ACTIVE = false; tblEd.noteId = null; }
    this.noteId = noteId;
    this.src = n.content || "";
    this.editing = false;
    CM_ACTIVE = true;
    this._render();
    dbg("Spr√°va reviz√≠ otev≈ôena: " + n.name);
  },
  saveBack: function() {
    if (!this.noteId) return;
    var n = getNote(this.noteId);
    if (n) { n.content = this.src; n.modified = now(); }
  },
  close: function() {
    if (!this.noteId) return;
    this.saveBack();
    var nid = this.noteId;
    this.noteId = null; this.src = ""; this.chs = []; this.editing = false;
    CM_ACTIVE = false;
    renderNoteView(nid); renderNav();
    dbg("Spr√°va reviz√≠ zav≈ôena");
  },

  // Helpers
  _esc: function(t) { return esc(t); },
  _trn: function(t,n) { return t.length<=n?t:t.substring(0,n)+"\u2026"; },
  _fc: function(id) { for (var i=0;i<this.chs.length;i++) { if (this.chs[i].id===id) return this.chs[i]; } return null; },
  _dc: function(c) {
    if (c.tp==="addition") return "p≈ôid√°n√≠: \u201E"+this._trn(c.tx,30)+"\u201C";
    if (c.tp==="deletion") return "smaz√°n√≠: \u201E"+this._trn(c.tx,30)+"\u201C";
    if (c.tp==="substitution") return "n√°hrada: \u201E"+this._trn(c.ot,15)+"\u201C \u2192 \u201E"+this._trn(c.nt,15)+"\u201C";
    if (c.tp==="highlight") return "zv√Ωraznƒõn√≠: \u201E"+this._trn(c.tx,30)+"\u201C";
    if (c.tp==="comment") return "koment√°≈ô: \u201E"+this._trn(c.tx,30)+"\u201C";
    return "";
  },

  // Modal
  _mShow: function(title, bodyH, btns) {
    var m=document.getElementById("cr-modal"); if (!m) return;
    document.getElementById("cr-mTitle").textContent=title;
    document.getElementById("cr-mBody").innerHTML=bodyH;
    var bd=document.getElementById("cr-mBtns"); bd.innerHTML="";
    for (var i=0;i<btns.length;i++) {
      var b=document.createElement("button"); b.type="button"; b.textContent=btns[i].label; b.onclick=btns[i].action; bd.appendChild(b);
    }
    m.classList.add("active"); if (bd.firstChild) bd.firstChild.focus();
  },
  _mHide: function() { var m=document.getElementById("cr-modal"); if (m) m.classList.remove("active"); },

  // Actions
  act: function(action, id) {
    var c = this._fc(id);
    if (!c||c.done) return;
    var self = this;
    if (action==="accept") {
      if (c.tp==="addition") this.src=this.src.replace(c.orig,c.tx);
      else if (c.tp==="deletion") this.src=this.src.replace(c.orig,"");
      else if (c.tp==="substitution") this.src=this.src.replace(c.orig,c.nt);
      c.done=true; this.saveBack(); this._rerender(); dbg("P≈ôijato: "+this._dc(c));
    } else if (action==="reject") {
      if (c.tp==="addition") this.src=this.src.replace(c.orig,"");
      else if (c.tp==="deletion") this.src=this.src.replace(c.orig,c.tx);
      else if (c.tp==="substitution") this.src=this.src.replace(c.orig,c.ot);
      c.done=true; this.saveBack(); this._rerender(); dbg("Odm√≠tnuto: "+this._dc(c));
    } else if (action==="rmhi") {
      this.src=this.src.replace(c.orig,c.tx); c.done=true; this.saveBack(); this._rerender(); dbg("Zv√Ωraznƒõn√≠ odstranƒõno");
    } else if (action==="edcom") {
      this._mShow("Upravit koment√°≈ô", '<label>Text koment√°≈ôe:</label><textarea id="cr-comTA">'+this._esc(c.tx)+'</textarea>',
        [{label:"Ulo≈æit",action:function(){
          var v=document.getElementById("cr-comTA").value; self._mHide();
          if (!v||!v.trim()) { self.act("delcom",id); return; }
          self.src=self.src.replace(c.orig,"{>>"+v+"<<}"); self.saveBack(); self._rerender(); dbg("Koment√°≈ô upraven");
        }},{label:"Zru≈°it",action:function(){ self._mHide(); }}]
      );
      setTimeout(function(){var el=document.getElementById("cr-comTA");if(el)el.focus();},100);
    } else if (action==="delcom") {
      this.src=this.src.replace(c.orig,""); c.done=true; this.saveBack(); this._rerender(); dbg("Koment√°≈ô smaz√°n");
    }
  },
  acceptAll: function() {
    var u=[],i; for (i=0;i<this.chs.length;i++) { if (!this.chs[i].done) u.push(this.chs[i]); }
    if (!u.length) return;
    var self=this;
    this._mShow("P≈ôijmout v≈°ech "+u.length+" zmƒõn?","<p>P≈ôijme v≈°echny nevy≈ôe≈°en√© revize najednou.</p>",
      [{label:"Ano, p≈ôijmout v≈°e",action:function(){ self._mHide(); self._doAccAll(); }},{label:"Zru≈°it",action:function(){ self._mHide(); }}]);
  },
  _doAccAll: function() {
    var i,c;
    for (i=0;i<this.chs.length;i++) {
      c=this.chs[i]; if (c.done) continue;
      if (c.tp==="addition") this.src=this.src.replace(c.orig,c.tx);
      else if (c.tp==="deletion") this.src=this.src.replace(c.orig,"");
      else if (c.tp==="substitution") this.src=this.src.replace(c.orig,c.nt);
      else if (c.tp==="highlight") this.src=this.src.replace(c.orig,c.tx);
      else if (c.tp==="comment") this.src=this.src.replace(c.orig,"");
      c.done=true;
    }
    this.saveBack(); this._rerender(); dbg("V≈°e p≈ôijato");
  },
  rejectAll: function() {
    var u=[],i; for (i=0;i<this.chs.length;i++) { if (!this.chs[i].done) u.push(this.chs[i]); }
    if (!u.length) return;
    var self=this;
    this._mShow("Odm√≠tnout v≈°ech "+u.length+" zmƒõn?","<p>Odm√≠tne v≈°echny nevy≈ôe≈°en√© revize najednou.</p>",
      [{label:"Ano, odm√≠tnout v≈°e",action:function(){ self._mHide(); self._doRejAll(); }},{label:"Zru≈°it",action:function(){ self._mHide(); }}]);
  },
  _doRejAll: function() {
    var i,c;
    for (i=0;i<this.chs.length;i++) {
      c=this.chs[i]; if (c.done) continue;
      if (c.tp==="addition") this.src=this.src.replace(c.orig,"");
      else if (c.tp==="deletion") this.src=this.src.replace(c.orig,c.tx);
      else if (c.tp==="substitution") this.src=this.src.replace(c.orig,c.ot);
      else if (c.tp==="highlight") this.src=this.src.replace(c.orig,c.tx);
      else if (c.tp==="comment") this.src=this.src.replace(c.orig,"");
      c.done=true;
    }
    this.saveBack(); this._rerender(); dbg("V≈°e odm√≠tnuto");
  },
  copySrc: function() {
    var self=this;
    if (navigator.clipboard&&navigator.clipboard.writeText) {
      navigator.clipboard.writeText(this.src).then(function(){dbg("Zkop√≠rov√°no");},function(){self._fbCopy();});
    } else this._fbCopy();
  },
  _fbCopy: function() {
    var ta=document.createElement("textarea"); ta.value=this.src; ta.style.position="fixed"; ta.style.left="-9999px";
    document.body.appendChild(ta); ta.select();
    try { document.execCommand("copy"); dbg("Zkop√≠rov√°no"); } catch(e) { dbg("Kop√≠rov√°n√≠ selhalo"); }
    document.body.removeChild(ta);
  },

  // Parse CriticMarkup
  _parse: function() {
    this.chs=[]; this.chId=0;
    var md=this.src, ph={}, pc=0, self=this;
    md=md.replace(/\{~~([\s\S]*?)~>([\s\S]*?)~~\}/g,function(m,o,n) {
      var p="P"+(pc++), id=self.chId++;
      self.chs.push({id:id,tp:"substitution",orig:m,ot:o,nt:n,tx:"",done:false,sec:""});
      ph[p]='<del class="cr-csd">'+esc(o)+'</del><ins class="cr-csi">'+esc(n)+'</ins><span class="cr-cab"><button type="button" onclick="cmRev.act(\'accept\','+id+')" title="P≈ôijmout">&#10003;</button><button type="button" onclick="cmRev.act(\'reject\','+id+')" title="Odm√≠tnout">&#10007;</button></span>';
      return "%%%"+p+"%%%";
    });
    md=md.replace(/\{\+\+([\s\S]*?)\+\+\}/g,function(m,t) {
      var p="P"+(pc++), id=self.chId++;
      self.chs.push({id:id,tp:"addition",orig:m,tx:t,done:false,sec:""});
      ph[p]='<ins class="cr-ca">'+esc(t)+'</ins><span class="cr-cab"><button type="button" onclick="cmRev.act(\'accept\','+id+')" title="P≈ôijmout">&#10003;</button><button type="button" onclick="cmRev.act(\'reject\','+id+')" title="Odm√≠tnout">&#10007;</button></span>';
      return "%%%"+p+"%%%";
    });
    md=md.replace(/\{--([\s\S]*?)--\}/g,function(m,t) {
      var p="P"+(pc++), id=self.chId++;
      self.chs.push({id:id,tp:"deletion",orig:m,tx:t,done:false,sec:""});
      ph[p]='<del class="cr-cd">'+esc(t)+'</del><span class="cr-cab"><button type="button" onclick="cmRev.act(\'accept\','+id+')" title="P≈ôijmout smaz√°n√≠">&#10003;</button><button type="button" onclick="cmRev.act(\'reject\','+id+')" title="Ponechat">&#10007;</button></span>';
      return "%%%"+p+"%%%";
    });
    md=md.replace(/\{==([\s\S]*?)==\}/g,function(m,t) {
      var p="P"+(pc++), id=self.chId++;
      self.chs.push({id:id,tp:"highlight",orig:m,tx:t,done:false,sec:""});
      ph[p]='<mark class="cr-cmh">'+esc(t)+'</mark><span class="cr-cab"><button type="button" onclick="cmRev.act(\'rmhi\','+id+')" title="Odstranit zv√Ωraznƒõn√≠">&#10007;</button></span>';
      return "%%%"+p+"%%%";
    });
    md=md.replace(/\{>>([\s\S]*?)<<\}/g,function(m,t) {
      var p="P"+(pc++), id=self.chId++;
      self.chs.push({id:id,tp:"comment",orig:m,tx:t,done:false,sec:""});
      ph[p]='<span class="cr-cmc" title="'+esc(t).replace(/"/g,'&quot;')+'">&#128172; '+esc(t)+'</span><span class="cr-cab"><button type="button" onclick="cmRev.act(\'edcom\','+id+')" title="Upravit">&#9998;</button><button type="button" onclick="cmRev.act(\'delcom\','+id+')" title="Smazat">&#10007;</button></span>';
      return "%%%"+p+"%%%";
    });
    // Assign sections
    var cur="(Bez nadpisu)", lines=md.split("\n"),i,hm,rx,pm;
    for (i=0;i<lines.length;i++) {
      hm=lines[i].match(/^(#{1,6})\s+(.+)/);
      if (hm) cur=hm[2].replace(/%%%P\d+%%%/g,"").replace(/\*\*|__|~~|`/g,"").trim();
      rx=/%%%P(\d+)%%%/g;
      while ((pm=rx.exec(lines[i]))!==null) { var n2=parseInt(pm[1]); if (n2<this.chs.length) this.chs[n2].sec=cur; }
    }
    for (i=0;i<this.chs.length;i++) { if (!this.chs[i].sec) this.chs[i].sec="(Bez nadpisu)"; }
    // Use marked.js for MD rendering
    var html; try { html=marked.parse(md); } catch(e) { html="<pre>"+esc(md)+"</pre>"; }
    for (var k in ph) { if (ph.hasOwnProperty(k)) html=html.split("%%%"+k+"%%%").join(ph[k]); }
    return html;
  },

  // Build review panel
  _buildRev: function() {
    var el=document.getElementById("cr-revList"); if (!el) return;
    if (this.chs.length===0) { el.innerHTML='<p class="cr-re">≈Ω√°dn√© CriticMarkup revize v dokumentu.</p>'; return; }
    var secs={},ord=[],i,s;
    for (i=0;i<this.chs.length;i++) { s=this.chs[i].sec; if (!secs[s]) { secs[s]=[]; ord.push(s); } secs[s].push(this.chs[i]); }
    var tl={addition:"P≈ôid√°n√≠",deletion:"Smaz√°n√≠",substitution:"N√°hrada",highlight:"Zv√Ωraznƒõn√≠",comment:"Koment√°≈ô"};
    var tcl={addition:"cr-t-a",deletion:"cr-t-d",substitution:"cr-t-s",highlight:"cr-t-h",comment:"cr-t-c"};
    var h="",si,sn,sc,uc,j,c;
    for (si=0;si<ord.length;si++) {
      sn=ord[si]; sc=secs[sn]; uc=0;
      for (j=0;j<sc.length;j++) { if (!sc[j].done) uc++; }
      h+='<details class="cr-rs" open><summary>'+esc(sn)+' ('+uc+'/'+sc.length+')</summary>';
      for (j=0;j<sc.length;j++) {
        c=sc[j];
        h+='<div class="cr-ri'+(c.done?' cr-rid':'')+'">';
        h+='<div class="cr-rit '+tcl[c.tp]+'">'+tl[c.tp]+'</div>';
        h+='<div class="cr-rix">';
        if (c.tp==="substitution") h+='<del>'+esc(c.ot)+'</del> &rarr; <ins>'+esc(c.nt)+'</ins>';
        else h+=esc(c.tx);
        h+='</div>';
        if (!c.done) {
          h+='<div class="cr-ria">';
          if (c.tp==="addition") h+='<button onclick="cmRev.act(\'accept\','+c.id+')">P≈ôijmout</button><button onclick="cmRev.act(\'reject\','+c.id+')">Odm√≠tnout</button>';
          else if (c.tp==="deletion") h+='<button onclick="cmRev.act(\'accept\','+c.id+')">P≈ôijmout smaz√°n√≠</button><button onclick="cmRev.act(\'reject\','+c.id+')">Ponechat text</button>';
          else if (c.tp==="substitution") h+='<button onclick="cmRev.act(\'accept\','+c.id+')">P≈ôijmout n√°hradu</button><button onclick="cmRev.act(\'reject\','+c.id+')">Ponechat p≈Øvodn√≠</button>';
          else if (c.tp==="highlight") h+='<button onclick="cmRev.act(\'rmhi\','+c.id+')">Odstranit zv√Ωraznƒõn√≠</button>';
          else if (c.tp==="comment") h+='<button onclick="cmRev.act(\'edcom\','+c.id+')">Upravit</button><button onclick="cmRev.act(\'delcom\','+c.id+')">Smazat</button>';
          h+='</div>';
        } else { h+='<div class="cr-ria"><em>Vy≈ôe≈°eno</em></div>'; }
        h+='</div>';
      }
      h+='</details>';
    }
    el.innerHTML=h;
  },

  // Stats
  _updS: function() {
    var el=document.getElementById("cr-stats"); if (!el) return;
    var u=0,i; for (i=0;i<this.chs.length;i++) { if (!this.chs[i].done) u++; }
    el.textContent=this.chs.length===0?"≈Ω√°dn√© revize":"Revize: "+u+" nevy≈ôe≈°en√Ωch / "+this.chs.length+" celkem";
  },

  // Render
  _render: function() {
    var tb=document.getElementById("toolbar"); var vw=document.getElementById("view"); if (!tb||!vw) return;
    var n=getNote(this.noteId), nName=n?esc(n.name):"";
    // Toolbar
    var tbH='<button class="sm" onclick="cmRev.close()">\u2B05 Zpƒõt</button>';
    tbH+='<span class="sep"></span>';
    tbH+='<button class="sm" onclick="cmRev.acceptAll()">\u2713 P≈ôijmout v≈°e</button>';
    tbH+='<button class="sm" onclick="cmRev.rejectAll()">\u2717 Odm√≠tnout v≈°e</button>';
    tbH+='<span class="sep"></span>';
    tbH+='<button class="sm" onclick="cmRev.copySrc()">\uD83D\uDCCB Kop√≠rovat zdroj</button>';
    tbH+='<span class="cr-stats" id="cr-stats"></span>';
    tb.innerHTML=tbH;
    // View: two-panel
    var h='<h6 style="margin:0 0 4px;font-size:.72rem;text-transform:uppercase;color:var(--text2);letter-spacing:.5px">Spr√°va reviz√≠ CriticMarkup</h6>';
    h+='<h2 style="margin:0 0 8px;font-size:1.05rem">\uD83D\uDD0D '+nName+'</h2>';
    h+='<div class="cr-wrap">';
    h+='<div class="cr-doc" id="cr-docOut"></div>';
    h+='<div class="cr-rev"><h3>P≈ôehled reviz√≠</h3><div id="cr-revList"></div></div>';
    h+='</div>';
    vw.innerHTML=h;
    document.getElementById("cr-docOut").innerHTML=this._parse();
    this._buildRev();
    this._updS();
  },
  _rerender: function() {
    var el=document.getElementById("cr-docOut"); if (!el) return;
    el.innerHTML=this._parse();
    this._buildRev();
    this._updS();
  }
};

function openCmReview(noteId) { cmRev.open(noteId); }

/* ======== Spellcheck Module ======== */
var SP_ACTIVE = false;
var spChk = {
  noteId: null,
  API: "https://lindat.mff.cuni.cz/services/korektor/api/suggestions",
  DICT_URL: "https://mrt.site44.com/cs.txt",
  SYNTAX_CHARS: /[\+\[\]\{\}\~\>\#\*\_\/\:\|\=\^]/,
  apiRes: null,
  corr: {},
  ignored: {},
  customDict: {},
  protectedWords: {},
  dictLoaded: false,

  open: function(noteId) {
    var n = getNote(noteId);
    if (!n) return;
    if (AE_ACTIVE) { advEd.saveBack(); AE_ACTIVE = false; advEd.noteId = null; advEd.sections = []; }
    if (CM_ACTIVE) { cmRev.saveBack(); CM_ACTIVE = false; cmRev.noteId = null; }
    if (TE_ACTIVE) { TE_ACTIVE = false; tblEd.noteId = null; }
    this.noteId = noteId;
    this.apiRes = null; this.corr = {}; this.ignored = {}; this.protectedWords = {};
    SP_ACTIVE = true;
    this._renderUI();
    if (!this.dictLoaded) this.loadDict();
    dbg("Korektor otev≈ôen: " + n.name);
  },
  close: function() {
    var nid = this.noteId;
    this.noteId = null; this.apiRes = null; this.corr = {}; this.ignored = {}; this.protectedWords = {};
    SP_ACTIVE = false;
    if (nid) renderNoteView(nid);
    renderNav();
    dbg("Korektor zav≈ôen");
  },
  saveToNote: function() {
    if (!this.noteId || !this.apiRes) return;
    var n = getNote(this.noteId);
    if (!n) return;
    var text = "";
    for (var i = 0; i < this.apiRes.length; i++) {
      text += this.corr[i] !== undefined ? this.corr[i] : this.apiRes[i][0];
    }
    n.content = text; n.modified = now();
    dbg("Opraven√Ω text ulo≈æen do pozn√°mky");
    this.close();
  },

  // --- Pre-scan: extract protected words from URLs, wiki links, templates ---
  extractWords: function(str) {
    var r = [];
    var parts = str.split(/[^a-zA-Z\u00C0-\u024F\u0100-\u017F0-9]+/);
    for (var i = 0; i < parts.length; i++) { var p = parts[i].trim(); if (p) r.push(p.toLowerCase()); }
    return r;
  },
  buildProtectedWords: function(text) {
    this.protectedWords = {};
    var self = this;
    var patterns = [
      /https?:\/\/[^\s\]\)}\|<>]+/g,
      /ftp:\/\/[^\s\]\)}\|<>]+/g,
      /\[\[[^\]]*\]\]/g,
      /\{\{[^\}]*\}\}/g
    ];
    for (var p = 0; p < patterns.length; p++) {
      var m;
      while ((m = patterns[p].exec(text)) !== null) {
        var words = self.extractWords(m[0]);
        for (var w = 0; w < words.length; w++) self.protectedWords[words[w]] = true;
      }
    }
    var cnt = Object.keys(this.protectedWords).length;
    if (cnt > 0) dbg("Pre-scan: " + cnt + " chr√°nƒõn√Ωch slov z URL/odkaz≈Ø");
  },
  shouldSkipToken: function(orig, suggestions) {
    var w = orig.trim();
    if (!w) return true;
    var lw = w.toLowerCase();
    // 1. Custom dictionary + ignored
    if (this.customDict[lw] || this.ignored[lw]) return true;
    // 2. Protected words from pre-scan
    if (this.protectedWords[lw]) return true;
    // 3. All-caps, 2+ chars (GEM, HTTP, API...)
    if (w.length >= 2 && w === w.toUpperCase() && /^[A-Z\u00C0-\u024F]+$/.test(w)) return true;
    // 4. Syntax chars at start or end
    if (this.SYNTAX_CHARS.test(w.charAt(0)) || this.SYNTAX_CHARS.test(w.charAt(w.length - 1))) return true;
    // 5. Case-only difference: first suggestion differs only in case
    if (suggestions && suggestions.length > 0) {
      if (suggestions[0].toLowerCase() === lw) return true;
    }
    // 6. Pure numbers
    if (/^\d+$/.test(w)) return true;
    return false;
  },
  getOpen: function() {
    if (!this.apiRes) return [];
    var r = [];
    for (var i = 0; i < this.apiRes.length; i++) {
      var item = this.apiRes[i];
      if (item.length > 1 && this.corr[i] === undefined && !this.shouldSkipToken(item[0], item.slice(1))) r.push(i);
    }
    return r;
  },

  loadDict: function() {
    var el = document.getElementById("sp-dict");
    if (el) { el.className = "sp-dict loading"; el.textContent = "\u23F3 Na\u010D\u00EDt\u00E1m slovn\u00EDk\u2026"; }
    var self = this;
    fetch(this.DICT_URL).then(function(res) {
      if (!res.ok) throw new Error("HTTP " + res.status);
      return res.text();
    }).then(function(text) {
      var words = text.split(/[\r\n]+/);
      self.customDict = {};
      for (var i = 0; i < words.length; i++) { var w = words[i].trim().toLowerCase(); if (w) self.customDict[w] = true; }
      self.dictLoaded = true;
      var cnt = Object.keys(self.customDict).length;
      if (el) { el.className = "sp-dict ok"; el.textContent = "\u2713 Slovn\u00EDk na\u010Dten \u2014 " + cnt + " slov"; }
      dbg("Slovn√≠k naƒçten: " + cnt + " slov");
    }).catch(function(err) {
      if (el) { el.className = "sp-dict error"; el.textContent = "\u2717 Slovn\u00EDk: " + err.message; }
    });
  },

  check: function() {
    if (!this.noteId) return;
    var n = getNote(this.noteId);
    if (!n) return;
    var text = n.content || "";
    if (!text.trim()) return;
    var self = this;
    var btn = document.getElementById("sp-btnChk");
    if (btn) { btn.disabled = true; btn.textContent = "\u23F3 Kontroluji\u2026"; }
    var eb = document.getElementById("sp-errbox"); if (eb) eb.style.display = "none";
    this.corr = {}; this.ignored = {};
    this.buildProtectedWords(text);
    var fd = new FormData();
    fd.append("data", text);
    fd.append("model", "czech-spellchecker-130202");
    fd.append("suggestions", "5");
    fetch(this.API, { method: "POST", body: fd }).then(function(res) {
      if (!res.ok) throw new Error("Chyba: " + res.status);
      return res.json();
    }).then(function(data) {
      self.apiRes = data.result;
      self._renderResults();
      dbg("Kontrola hotova: " + self.getOpen().length + " chyb");
    }).catch(function(err) {
      var eb2 = document.getElementById("sp-errbox");
      if (eb2) { eb2.style.display = "block"; eb2.innerHTML = "<strong>Chyba:</strong> " + esc(err.message); }
    }).finally(function() {
      if (btn) { btn.disabled = false; btn.textContent = "\uD83D\uDD0D Zkontrolovat"; }
    });
  },

  reloadDict: function() {
    var self = this;
    this.dictLoaded = false;
    this.loadDict();
    setTimeout(function() { if (self.apiRes) self._renderResults(); }, 2000);
  },

  apply: function(idx, val) {
    this.corr[idx] = val;
    this._renderResults();
    var open = this.getOpen();
    if (open.length > 0) this._scrollTo("sp-err-" + open[0]);
    else this._scrollTo("sp-result");
  },
  applyManual: function(idx) {
    var el = document.getElementById("sp-man-" + idx);
    if (!el) return;
    var v = el.value.trim();
    if (!v) return;
    this.apply(idx, v);
  },
  ignore: function(idx) {
    this.ignored[this.apiRes[idx][0].toLowerCase().trim()] = true;
    delete this.corr[idx];
    this._renderResults();
  },
  clearIgnored: function() { this.ignored = {}; this._renderResults(); },

  _scrollTo: function(id) { var el = document.getElementById(id); if (el) el.scrollIntoView({ behavior: "smooth", block: "center" }); },
  _escA: function(s) { return s.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); },

  _renderUI: function() {
    var tb = document.getElementById("toolbar"); var vw = document.getElementById("view"); if (!tb || !vw) return;
    var n = getNote(this.noteId), nName = n ? esc(n.name) : "";
    var tbH = '<button class="sm" onclick="spChk.close()">\u2B05 Zp\u011Bt</button>';
    tbH += '<span class="sep"></span>';
    tbH += '<button class="sm primary" id="sp-btnChk" onclick="spChk.check()">\uD83D\uDD0D Zkontrolovat</button>';
    tbH += '<button class="sm" onclick="spChk.reloadDict()">\uD83D\uDD04 Slovn\u00EDk</button>';
    tbH += '<span class="sep"></span>';
    tbH += '<button class="sm" id="sp-btnSave" onclick="spChk.saveToNote()" disabled>\uD83D\uDCBE Ulo\u017Eit do pozn\u00E1mky</button>';
    tb.innerHTML = tbH;
    var h = '<h6 style="margin:0 0 4px;font-size:.72rem;text-transform:uppercase;color:var(--text2);letter-spacing:.5px">Korektor \u2014 kontrola pravopisu</h6>';
    h += '<h2 style="margin:0 0 8px;font-size:1.05rem">\uD83D\uDD0D ' + nName + '</h2>';
    h += '<div id="sp-dict" class="sp-dict">' + (this.dictLoaded ? '\u2713 Slovn\u00EDk na\u010Dten' : '') + '</div>';
    h += '<div id="sp-errbox" class="sp-errbox" style="display:none"></div>';
    h += '<div id="sp-resSection" style="display:none">';
    h += '<div id="sp-stats" class="sp-stats"></div>';
    h += '<div id="sp-result" class="sp-result"></div>';
    h += '<div style="margin:8px 0;display:flex;gap:8px;flex-wrap:wrap">';
    h += '<button class="sm" id="sp-btnCopy" onclick="spChk.copyResult()">\uD83D\uDCCB Kop\u00EDrovat opraven\u00FD text</button>';
    h += '<button class="sm" id="sp-btnClrIgn" onclick="spChk.clearIgnored()" style="display:none">Zru\u0161it ignorov\u00E1n\u00ED</button>';
    h += '</div>';
    h += '<div id="sp-errors"></div>';
    h += '</div>';
    h += '<p style="color:var(--text2);font-size:.82rem;margin-top:12px">Klikn\u011Bte <b>\uD83D\uDD0D Zkontrolovat</b> pro spu\u0161t\u011Bn\u00ED kontroly pravopisu.</p>';
    vw.innerHTML = h;
  },

  _renderResults: function() {
    var sec = document.getElementById("sp-resSection"); if (sec) sec.style.display = "block";
    var saveBtn = document.getElementById("sp-btnSave");
    if (saveBtn) saveBtn.disabled = !this.apiRes || Object.keys(this.corr).length === 0;
    this._renderStats();
    this._renderText();
    this._renderErrors();
    var clrBtn = document.getElementById("sp-btnClrIgn");
    if (clrBtn) clrBtn.style.display = Object.keys(this.ignored).length > 0 ? "" : "none";
  },

  _renderStats: function() {
    var el = document.getElementById("sp-stats"); if (!el) return;
    var open = this.getOpen(), cc = Object.keys(this.corr).length, ic = Object.keys(this.ignored).length;
    var h = "";
    h += open.length > 0 ? '<span class="sp-badge sp-err">' + open.length + ' chyb</span>' : '<span class="sp-badge sp-ok">\u2713 Bez chyb</span>';
    if (cc > 0) h += '<span class="sp-badge sp-corr">' + cc + ' opraveno</span>';
    if (ic > 0) h += '<span class="sp-badge sp-ign">' + ic + ' ignorov\u00E1no</span>';
    el.innerHTML = h;
  },

  _renderText: function() {
    var el = document.getElementById("sp-result"); if (!el || !this.apiRes) return;
    var h = "";
    for (var i = 0; i < this.apiRes.length; i++) {
      var orig = this.apiRes[i][0], has = this.apiRes[i].length > 1, fixed = this.corr[i] !== undefined, skip = this.shouldSkipToken(orig, has ? this.apiRes[i].slice(1) : []);
      if (fixed) h += esc(this.corr[i]);
      else if (has && !skip) h += '<a href="#sp-err-' + i + '" class="sp-we" id="sp-w-' + i + '">' + esc(orig) + '</a>';
      else h += esc(orig);
    }
    el.innerHTML = h;
  },

  _renderErrors: function() {
    var el = document.getElementById("sp-errors"); if (!el) return;
    var open = this.getOpen();
    if (open.length === 0) { el.innerHTML = ""; return; }
    var h = "";
    for (var oi = 0; oi < open.length; oi++) {
      var idx = open[oi], item = this.apiRes[idx], orig = item[0], suggs = item.slice(1);
      h += '<div class="sp-eblk" id="sp-err-' + idx + '">';
      h += '<h6><span class="sp-ew">' + esc(orig) + '</span><a href="#sp-w-' + idx + '" class="sp-bl">\u2191 zp\u011Bt na text</a></h6>';
      h += '<div class="sp-srow"><span class="sp-lbl">N\u00E1vrhy:</span>';
      for (var si = 0; si < suggs.length; si++) {
        var cls = si === 0 ? "sp-sl best" : "sp-sl";
        h += '<a class="' + cls + '" onclick="spChk.apply(' + idx + ',\'' + this._escA(suggs[si]) + '\')">' + esc(suggs[si]) + '</a>';
      }
      h += '</div>';
      h += '<div class="sp-mrow"><span class="sp-lbl">Ru\u010Dn\u011B:</span>';
      h += '<input type="text" class="sp-minp" id="sp-man-' + idx + '" placeholder="vlastn\u00ED oprava" onkeydown="if(event.key===\'Enter\')spChk.applyManual(' + idx + ')">';
      h += '<button class="sm" style="padding:4px 12px;font-size:.82rem" onclick="spChk.applyManual(' + idx + ')">Pou\u017E\u00EDt</button>';
      h += '</div>';
      h += '<div class="sp-acts"><a onclick="spChk.ignore(' + idx + ')">\u2298 Ignorovat slovo</a></div>';
      h += '</div>';
    }
    el.innerHTML = h;
  },

  copyResult: function() {
    if (!this.apiRes) return;
    var text = "";
    for (var i = 0; i < this.apiRes.length; i++) text += this.corr[i] !== undefined ? this.corr[i] : this.apiRes[i][0];
    navigator.clipboard.writeText(text).then(function() { dbg("Zkop√≠rov√°no"); });
  }
};

function openSpellcheck(noteId) { spChk.open(noteId); }

/* ======== Export / Import Module ======== */
var EI_ACTIVE = false;
var eiMod = {
  sel: {}, // {id: true} for selected notes/folders
  mode: "", // "export" or "import"
  impData: null, // parsed import data
  impStrategy: "rename", // rename|skip|overwrite
  impTarget: null, // target folderId (null = root)

  // ========= EXPORT =========
  openExport: function() {
    if (!BD || (!BD.notes.length && !BD.folders.length)) { alert("Nen√≠ co exportovat."); return; }
    if (AE_ACTIVE) { advEd.saveBack(); advEd.close(); }
    if (CM_ACTIVE) { cmRev.saveBack(); cmRev.close(); }
    if (SP_ACTIVE) { spChk.close(); }
    if (TE_ACTIVE) { tblEd.close(); }
    this.mode = "export"; EI_ACTIVE = true;
    // Pre-select current note or folder
    this.sel = {};
    if (CUR.type === "note" && CUR.id) this.sel["n:" + CUR.id] = true;
    else if (CUR.type === "folder" && CUR.id) this._selectFolder(CUR.id, true);
    this._renderExport();
  },
  _renderExport: function() {
    var tb = document.getElementById("toolbar"); var vw = document.getElementById("view");
    var tab = document.getElementById("tabbar"); if (tab) tab.innerHTML = "";
    var tbH = '<button class="sm" onclick="eiMod.closeEI()">\u2B05 Zpƒõt</button>';
    tbH += '<span class="sep"></span>';
    tbH += '<button class="sm" onclick="eiMod.selectAll()">‚òë Vybrat v≈°e</button>';
    tbH += '<button class="sm" onclick="eiMod.selectNone()">‚òê Zru≈°it v√Ωbƒõr</button>';
    tbH += '<span class="sep"></span>';
    tbH += '<button class="sm primary" id="ei-btnExport" onclick="eiMod.doExport()">üì¶ Exportovat</button>';
    tb.innerHTML = tbH;

    var h = '<h6 style="margin:0 0 4px;font-size:.72rem;text-transform:uppercase;color:var(--text2);letter-spacing:.5px">Export pozn√°mek</h6>';
    h += '<h2 style="margin:0 0 12px;font-size:1.05rem">üì¶ Vyberte polo≈æky k exportu</h2>';
    h += '<ul class="ei-list">' + this._buildExpList(null) + '</ul>';
    h += '<div class="ei-summary" id="ei-summary"></div>';
    vw.innerHTML = h;
    this._updSummary();
  },
  _buildExpList: function(parentId) {
    var h = "";
    var folders = childFolders(parentId);
    for (var i = 0; i < folders.length; i++) {
      var f = folders[i], fk = "f:" + f.id;
      var nc = countNotes(f.id);
      h += '<li class="ei-item"><label>';
      h += '<input type="checkbox" data-key="' + fk + '"' + (this.sel[fk] ? " checked" : "") + ' onchange="eiMod.toggleFolder(\'' + f.id + '\',this.checked)">';
      h += '<span class="ei-icon">üìÅ</span> ' + esc(f.name);
      if (nc > 0) h += '<span class="ei-cnt">(' + nc + ')</span>';
      h += '</label>';
      var inner = this._buildExpList(f.id);
      if (inner) h += '<ul class="ei-list">' + inner + '</ul>';
      h += '</li>';
    }
    var notes = notesInFolder(parentId);
    for (var j = 0; j < notes.length; j++) {
      var n = notes[j], nk = "n:" + n.id;
      h += '<li class="ei-item"><label>';
      h += '<input type="checkbox" data-key="' + nk + '"' + (this.sel[nk] ? " checked" : "") + ' onchange="eiMod.toggleNote(\'' + n.id + '\',this.checked)">';
      h += '<span class="ei-icon">' + (n.icon || 'üìÑ') + '</span> ' + esc(n.name);
      h += '</label></li>';
    }
    return h;
  },
  toggleNote: function(id, checked) {
    if (checked) this.sel["n:" + id] = true; else delete this.sel["n:" + id];
    this._updSummary();
  },
  toggleFolder: function(id, checked) {
    this._selectFolder(id, checked);
    this._renderExport(); // re-render to update child checkboxes
  },
  _selectFolder: function(id, sel) {
    if (sel) this.sel["f:" + id] = true; else delete this.sel["f:" + id];
    var notes = notesInFolder(id);
    for (var i = 0; i < notes.length; i++) { if (sel) this.sel["n:" + notes[i].id] = true; else delete this.sel["n:" + notes[i].id]; }
    var subs = childFolders(id);
    for (var j = 0; j < subs.length; j++) this._selectFolder(subs[j].id, sel);
  },
  selectAll: function() {
    this.sel = {};
    for (var i = 0; i < BD.folders.length; i++) this.sel["f:" + BD.folders[i].id] = true;
    for (var j = 0; j < BD.notes.length; j++) this.sel["n:" + BD.notes[j].id] = true;
    this._renderExport();
  },
  selectNone: function() { this.sel = {}; this._renderExport(); },
  _updSummary: function() {
    var el = document.getElementById("ei-summary"); if (!el) return;
    var nc = 0, fc = 0;
    for (var k in this.sel) { if (k.charAt(0) === "n") nc++; else if (k.charAt(0) === "f") fc++; }
    el.textContent = "Vybr√°no: " + nc + " pozn√°mek, " + fc + " slo≈æek";
    var btn = document.getElementById("ei-btnExport");
    if (btn) btn.disabled = nc === 0 && fc === 0;
  },

  doExport: function() {
    var items = this._collectItems(null);
    if (!items.length) { alert("Nic nen√≠ vybr√°no."); return; }
    var data = { format: "noteblock-export", version: 1, exported: now(), items: items };
    var json = JSON.stringify(data, null, 2);
    var blob = new Blob([json], { type: "application/json" });
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    var d = new Date().toISOString().substring(0, 10);
    a.href = url; a.download = "noteblock-" + d + ".nme";
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
    dbg("Export: " + items.length + " polo≈æek");
    this.closeEI();
  },
  _collectItems: function(parentId) {
    var items = [];
    var folders = childFolders(parentId);
    for (var i = 0; i < folders.length; i++) {
      var f = folders[i], fk = "f:" + f.id;
      var children = this._collectItems(f.id);
      // Include folder if it's selected OR has selected children
      if (this.sel[fk] || children.length > 0) {
        items.push({ type: "folder", name: f.name, children: children });
      }
    }
    var notes = notesInFolder(parentId);
    for (var j = 0; j < notes.length; j++) {
      var n = notes[j], nk = "n:" + n.id;
      if (this.sel[nk]) {
        var obj = { type: "note", name: n.name, content: n.content || "" };
        if (n.tags && n.tags.length) obj.tags = n.tags.slice();
        if (n.icon) obj.icon = n.icon;
        if (n.bookmarked) obj.bookmarked = true;
        if (n.meta && n.meta.length) obj.meta = JSON.parse(JSON.stringify(n.meta));
        if (n.created) obj.created = n.created;
        if (n.modified) obj.modified = n.modified;
        items.push(obj);
      }
    }
    return items;
  },

  // ========= IMPORT =========
  openImport: function() {
    if (!BD) { alert("Nejprve nahrajte nebo vytvo≈ôte pozn√°mkov√Ω blok."); return; }
    if (AE_ACTIVE) { advEd.saveBack(); advEd.close(); }
    if (CM_ACTIVE) { cmRev.saveBack(); cmRev.close(); }
    if (SP_ACTIVE) { spChk.close(); }
    if (TE_ACTIVE) { tblEd.close(); }
    this.mode = "import"; EI_ACTIVE = true;
    this.impData = null; this.impStrategy = "rename"; this.impTarget = null;
    this._renderImportStart();
  },
  _renderImportStart: function() {
    var tb = document.getElementById("toolbar"); var vw = document.getElementById("view");
    var tab = document.getElementById("tabbar"); if (tab) tab.innerHTML = "";
    var tbH = '<button class="sm" onclick="eiMod.closeEI()">\u2B05 Zpƒõt</button>';
    tb.innerHTML = tbH;
    var h = '<h6 style="margin:0 0 4px;font-size:.72rem;text-transform:uppercase;color:var(--text2);letter-spacing:.5px">Import pozn√°mek</h6>';
    h += '<h2 style="margin:0 0 12px;font-size:1.05rem">üì• Vyberte soubor .nme</h2>';
    h += '<p style="font-size:.88rem;color:var(--text2);margin-bottom:12px">Vyberte soubor exportovan√Ω z NoteBlock (.nme).</p>';
    h += '<button class="sm primary" onclick="eiMod._pickFile()">üìÇ Vybrat soubor</button>';
    h += '<div id="ei-imp-content"></div>';
    vw.innerHTML = h;
  },
  _pickFile: function() {
    var inp = document.getElementById("nme-in");
    inp.value = "";
    var self = this;
    inp.onchange = function() {
      if (inp.files.length === 0) return;
      self._loadFile(inp.files[0]);
    };
    inp.click();
  },
  _loadFile: function(file) {
    var self = this;
    var reader = new FileReader();
    reader.onload = function(e) {
      try {
        var data = JSON.parse(e.target.result);
        if (!data.format || data.format !== "noteblock-export" || !data.items) {
          throw new Error("Neplatn√Ω form√°t souboru.");
        }
        self.impData = data;
        self._renderImportPreview();
      } catch (err) {
        var el = document.getElementById("ei-imp-content");
        if (el) el.innerHTML = '<div class="ei-msg err"><strong>Chyba:</strong> ' + esc(err.message) + '</div>';
      }
    };
    reader.readAsText(file);
  },
  _renderImportPreview: function() {
    var tb = document.getElementById("toolbar");
    var tbH = '<button class="sm" onclick="eiMod.closeEI()">\u2B05 Zpƒõt</button>';
    tbH += '<span class="sep"></span>';
    tbH += '<button class="sm primary" onclick="eiMod.doImport()">üì• Importovat</button>';
    tb.innerHTML = tbH;

    var el = document.getElementById("ei-imp-content"); if (!el) return;
    var stats = this._countItems(this.impData.items);
    var conflicts = this._findConflicts(this.impData.items, this.impTarget);

    var h = '';
    // File info
    h += '<div class="ei-summary">Soubor: ' + stats.notes + ' pozn√°mek, ' + stats.folders + ' slo≈æek';
    if (this.impData.exported) h += ' ‚Ä¢ exportov√°no ' + this.impData.exported.substring(0, 10);
    h += '</div>';

    // Preview
    h += '<div class="ei-preview"><ul class="ei-list">' + this._buildPreviewList(this.impData.items) + '</ul></div>';

    // Target folder
    h += '<div class="ei-target"><h4>üìç Importovat do:</h4>';
    h += '<label><input type="radio" name="ei-target" value="" ' + (this.impTarget === null ? 'checked' : '') + ' onchange="eiMod._setTarget(null)"> Ko≈ôen (nejvy≈°≈°√≠ √∫rove≈à)</label>';
    if (CUR.type === "folder" && CUR.id) {
      var cf = getFolder(CUR.id);
      if (cf) h += '<label><input type="radio" name="ei-target" value="' + cf.id + '" ' + (this.impTarget === cf.id ? 'checked' : '') + ' onchange="eiMod._setTarget(\'' + cf.id + '\')"> Aktu√°ln√≠ slo≈æka: ' + esc(cf.name) + '</label>';
    }
    // All folders
    h += '<label><input type="radio" name="ei-target" value="_pick" onchange="eiMod._showFolderPicker()"> Jin√° slo≈æka‚Ä¶</label>';
    h += '<select id="ei-folder-pick" style="display:none;margin:4px 0 0 22px;font-size:.85rem;padding:3px 6px" onchange="eiMod._setTarget(this.value)">';
    h += '<option value="">Ko≈ôen</option>';
    h += this._folderOptions(null, 0);
    h += '</select>';
    h += '</div>';

    // Conflicts
    if (conflicts.length > 0) {
      h += '<div class="ei-conflict"><h4>‚ö† ' + conflicts.length + ' konflikty jmen:</h4><ul>';
      for (var i = 0; i < conflicts.length; i++) {
        h += '<li>' + (conflicts[i].type === "folder" ? "üìÅ" : "üìÑ") + ' ‚Äû' + esc(conflicts[i].name) + '"' + (conflicts[i].inFolder ? ' v /' + esc(conflicts[i].inFolder) : ' v ko≈ôenu') + '</li>';
      }
      h += '</ul></div>';
      h += '<div class="ei-strat"><h4>≈òe≈°en√≠ konflikt≈Ø:</h4>';
      h += '<label><input type="radio" name="ei-strat" value="rename"' + (this.impStrategy === "rename" ? " checked" : "") + ' onchange="eiMod.impStrategy=\'rename\'"> P≈ôejmenovat (p≈ôid√° ‚Äû(import)")</label>';
      h += '<label><input type="radio" name="ei-strat" value="skip"' + (this.impStrategy === "skip" ? " checked" : "") + ' onchange="eiMod.impStrategy=\'skip\'"> P≈ôeskoƒçit existuj√≠c√≠</label>';
      h += '<label><input type="radio" name="ei-strat" value="overwrite"' + (this.impStrategy === "overwrite" ? " checked" : "") + ' onchange="eiMod.impStrategy=\'overwrite\'"> P≈ôepsat / slouƒçit</label>';
      h += '</div>';
    }
    el.innerHTML = h;
  },
  _buildPreviewList: function(items) {
    var h = "";
    for (var i = 0; i < items.length; i++) {
      var it = items[i];
      if (it.type === "folder") {
        h += '<li class="ei-item"><span class="ei-icon">üìÅ</span> <span>' + esc(it.name) + '</span>';
        if (it.children && it.children.length) h += '<ul class="ei-list">' + this._buildPreviewList(it.children) + '</ul>';
        h += '</li>';
      } else {
        h += '<li class="ei-item"><span class="ei-icon">' + (it.icon || 'üìÑ') + '</span> <span>' + esc(it.name) + '</span></li>';
      }
    }
    return h;
  },
  _countItems: function(items) {
    var n = 0, f = 0;
    for (var i = 0; i < items.length; i++) {
      if (items[i].type === "folder") { f++; if (items[i].children) { var s = this._countItems(items[i].children); n += s.notes; f += s.folders; } }
      else n++;
    }
    return { notes: n, folders: f };
  },
  _findConflicts: function(items, targetFolderId) {
    var conflicts = [];
    for (var i = 0; i < items.length; i++) {
      var it = items[i];
      var tfn = targetFolderId ? (getFolder(targetFolderId) || {}).name : null;
      if (it.type === "folder") {
        if (folderNameExists(it.name, targetFolderId, null)) {
          conflicts.push({ type: "folder", name: it.name, inFolder: tfn });
        }
        // Check children recursively within this folder context
        if (it.children) {
          var existF = this._findExistingFolder(it.name, targetFolderId);
          if (existF && it.children.length) {
            var sub = this._findConflicts(it.children, existF.id);
            conflicts = conflicts.concat(sub);
          }
        }
      } else {
        if (this._noteNameExistsInFolder(it.name, targetFolderId)) {
          conflicts.push({ type: "note", name: it.name, inFolder: tfn });
        }
      }
    }
    return conflicts;
  },
  _noteNameExistsInFolder: function(name, folderId) {
    var notes = notesInFolder(folderId);
    var low = name.toLowerCase();
    for (var i = 0; i < notes.length; i++) { if (notes[i].name.toLowerCase() === low) return true; }
    return false;
  },
  _findExistingFolder: function(name, parentId) {
    var folders = childFolders(parentId);
    var low = name.toLowerCase();
    for (var i = 0; i < folders.length; i++) { if (folders[i].name.toLowerCase() === low) return folders[i]; }
    return null;
  },
  _folderOptions: function(parentId, depth) {
    var h = "", folders = childFolders(parentId);
    for (var i = 0; i < folders.length; i++) {
      var f = folders[i], prefix = "";
      for (var d = 0; d < depth; d++) prefix += "\u00A0\u00A0";
      h += '<option value="' + f.id + '">' + prefix + 'üìÅ ' + esc(f.name) + '</option>';
      h += this._folderOptions(f.id, depth + 1);
    }
    return h;
  },
  _setTarget: function(val) {
    this.impTarget = val || null;
    if (this.impData) this._renderImportPreview();
  },
  _showFolderPicker: function() {
    var el = document.getElementById("ei-folder-pick");
    if (el) el.style.display = "block";
  },

  doImport: function() {
    if (!this.impData || !this.impData.items) return;
    var imported = this._importItems(this.impData.items, this.impTarget);
    renderNav();
    dbg("Import: " + imported.notes + " pozn√°mek, " + imported.folders + " slo≈æek");
    this.closeEI();
    alert("Import dokonƒçen: " + imported.notes + " pozn√°mek, " + imported.folders + " slo≈æek.");
  },
  _importItems: function(items, parentId) {
    var stats = { notes: 0, folders: 0 };
    for (var i = 0; i < items.length; i++) {
      var it = items[i];
      if (it.type === "folder") {
        var existF = this._findExistingFolder(it.name, parentId);
        var fid;
        if (existF) {
          if (this.impStrategy === "skip") continue;
          if (this.impStrategy === "overwrite") {
            // Merge into existing folder
            fid = existF.id;
          } else {
            // Rename
            var nm = this._uniqueFolderName(it.name, parentId);
            fid = genId();
            BD.folders.push({ id: fid, name: nm, parentId: parentId || null });
          }
        } else {
          fid = genId();
          BD.folders.push({ id: fid, name: it.name, parentId: parentId || null });
        }
        stats.folders++;
        if (it.children && it.children.length) {
          var sub = this._importItems(it.children, fid);
          stats.notes += sub.notes; stats.folders += sub.folders;
        }
      } else {
        // Note
        var existN = this._noteNameExistsInFolder(it.name, parentId);
        if (existN) {
          if (this.impStrategy === "skip") continue;
          if (this.impStrategy === "overwrite") {
            // Find and overwrite
            var notes = notesInFolder(parentId);
            var low = it.name.toLowerCase();
            for (var j = 0; j < notes.length; j++) {
              if (notes[j].name.toLowerCase() === low) {
                notes[j].content = it.content || "";
                if (it.tags) notes[j].tags = it.tags.slice();
                if (it.icon) notes[j].icon = it.icon;
                if (it.meta) notes[j].meta = JSON.parse(JSON.stringify(it.meta));
                if (it.bookmarked !== undefined) notes[j].bookmarked = it.bookmarked;
                notes[j].modified = now();
                break;
              }
            }
          } else {
            // Rename
            this._createNote(this._uniqueNoteName(it.name, parentId), it, parentId);
          }
        } else {
          this._createNote(it.name, it, parentId);
        }
        stats.notes++;
      }
    }
    return stats;
  },
  _createNote: function(name, data, folderId) {
    BD.notes.push({
      id: genId(), name: name, content: data.content || "",
      tags: data.tags ? data.tags.slice() : [],
      icon: data.icon || "",
      meta: data.meta ? JSON.parse(JSON.stringify(data.meta)) : [],
      bookmarked: data.bookmarked || false,
      folderId: folderId || null,
      created: data.created || now(),
      modified: now()
    });
  },
  _uniqueFolderName: function(name, parentId) {
    var base = name, n = 1;
    while (folderNameExists(base, parentId, null)) { n++; base = name + " (import" + (n > 2 ? " " + n : "") + ")"; }
    return base;
  },
  _uniqueNoteName: function(name, parentId) {
    var base = name + " (import)", n = 1;
    while (this._noteNameExistsInFolder(base, parentId)) { n++; base = name + " (import " + (n + 1) + ")"; }
    return base;
  },

  // ========= COMMON =========
  closeEI: function() {
    this.mode = ""; EI_ACTIVE = false;
    this.sel = {}; this.impData = null;
    if (CUR.type === "note" && CUR.id) { renderNoteView(CUR.id); }
    else if (CUR.type === "folder" && CUR.id) { renderFolderView(CUR.id); }
    else { renderFolderView(null); }
    renderNav(); renderTabs(); updateTitle();
  }
};

</script>

<!-- CM Review Modal -->
<div class="cr-modal" id="cr-modal" role="dialog" aria-modal="true">
  <div class="cr-mbox"><h3 id="cr-mTitle"></h3><div id="cr-mBody"></div><div class="cr-mbtn" id="cr-mBtns"></div></div>
</div>

</body>
</html>
