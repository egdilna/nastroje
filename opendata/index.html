<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prohlížeč otevřených dat</title>
<style>
*, *::before, *::after { box-sizing: border-box; }

body {
    font-family: system-ui, -apple-system, sans-serif;
    margin: 0;
    padding: 0;
    background: #f5f5f5;
    color: #1a1a1a;
    line-height: 1.6;
}

a { color: #0056b3; }
a:hover { color: #003d80; }
a:focus-visible, button:focus-visible, input:focus-visible, select:focus-visible {
    outline: 3px solid #0056b3;
    outline-offset: 2px;
}

.skip-link {
    position: absolute;
    top: -100px;
    left: 8px;
    background: #0056b3;
    color: #fff;
    padding: 8px 16px;
    z-index: 1000;
    border-radius: 0 0 4px 4px;
    text-decoration: none;
    font-weight: 600;
}
.skip-link:focus { top: 0; }

header {
    background: #1a1a1a;
    color: #fff;
    padding: 16px 24px;
}
header h1 { margin: 0; font-size: 1.4rem; font-weight: 600; }

main {
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px;
}

/* Forms */
fieldset {
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 16px 20px;
    margin: 0 0 24px 0;
    background: #fff;
}
legend { font-weight: 600; font-size: 1.1rem; padding: 0 8px; }
.form-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: flex-end;
    margin-top: 12px;
}
.form-field { flex: 1; min-width: 250px; }
.form-field label {
    display: block;
    font-weight: 500;
    margin-bottom: 4px;
    font-size: 0.9rem;
}
.form-field input {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid #999;
    border-radius: 4px;
    font-size: 0.95rem;
    background: #fff;
}
button {
    padding: 8px 20px;
    border: 2px solid #0056b3;
    background: #0056b3;
    color: #fff;
    border-radius: 4px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
}
button:hover { background: #003d80; border-color: #003d80; }
button.secondary { background: #fff; color: #0056b3; }
button.secondary:hover { background: #e8f0fe; }
button:disabled { opacity: 0.5; cursor: not-allowed; }

/* Status */
#status-area { padding: 12px 16px; margin-bottom: 16px; border-radius: 4px; font-weight: 500; }
#status-area:empty { display: none; }
#status-area.info { background: #e8f0fe; border: 1px solid #4a90d9; color: #1a3a5c; }
#status-area.success { background: #e6f4ea; border: 1px solid #34a853; color: #1e4620; }
#status-area.error { background: #fce8e6; border: 1px solid #ea4335; color: #5f1412; }

/* Metadata panel */
#metadata-panel {
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 16px 20px;
    margin-bottom: 20px;
}
#metadata-panel:empty { display: none; }
#metadata-panel h2 { margin: 0 0 8px 0; font-size: 1.2rem; }
#metadata-panel p { margin: 4px 0; color: #444; }
#metadata-panel .meta-stats { font-weight: 600; color: #1a1a1a; }

/* Presets */
#presets-area { margin-bottom: 8px; }
#presets-area:empty { display: none; }
.preset-link { display: inline-block; margin-right: 12px; margin-bottom: 4px; font-size: 0.9rem; }

/* Search & filter toolbar */
#toolbar { display: none; margin-bottom: 16px; }
#toolbar.visible { display: block; }

.toolbar-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: flex-end;
    margin-bottom: 12px;
}
.search-field { flex: 1; min-width: 250px; }
.search-field label {
    display: block;
    font-weight: 500;
    margin-bottom: 4px;
    font-size: 0.9rem;
}
.search-field input {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid #999;
    border-radius: 4px;
    font-size: 0.95rem;
}

/* Column filters */
#column-filters {
    display: none;
    flex-wrap: wrap;
    gap: 10px;
    padding: 12px 16px;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 4px;
    margin-bottom: 12px;
}
#column-filters.visible { display: flex; }
.col-filter { min-width: 180px; flex: 1; max-width: 300px; }
.col-filter label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 2px; }
.col-filter input, .col-filter select {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #999;
    border-radius: 4px;
    font-size: 0.9rem;
}

/* Table */
.table-wrapper {
    overflow-x: auto;
    margin-bottom: 16px;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 6px;
}
table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
thead { background: #f0f0f0; }
th {
    text-align: left;
    padding: 10px 12px;
    border-bottom: 2px solid #999;
    font-weight: 600;
    white-space: nowrap;
}
th a { color: inherit; text-decoration: none; }
th a:hover { text-decoration: underline; }
th .sort-indicator { margin-left: 4px; font-size: 0.8em; color: #666; }
td {
    padding: 8px 12px;
    border-bottom: 1px solid #e0e0e0;
    vertical-align: top;
    max-width: 400px;
}
tr:hover { background: #f8f8f8; }
tbody tr:last-child td { border-bottom: none; }
td.cell-number { text-align: right; font-variant-numeric: tabular-nums; }

/* Sub-record badge */
.sub-count {
    display: inline-block;
    background: #e8f0fe;
    color: #0056b3;
    padding: 1px 8px;
    border-radius: 10px;
    font-size: 0.85rem;
    font-weight: 500;
}

/* Pagination */
.pagination {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
}
.pagination-info { font-size: 0.9rem; color: #555; }
.pagination-controls { display: flex; gap: 4px; align-items: center; }
.pagination-controls button { padding: 6px 12px; font-size: 0.85rem; min-width: 40px; }
.page-size-select { display: flex; gap: 6px; align-items: center; font-size: 0.9rem; }
.page-size-select label { white-space: nowrap; }
.page-size-select select {
    padding: 6px 8px;
    border: 1px solid #999;
    border-radius: 4px;
    font-size: 0.9rem;
}

/* Detail view */
#detail-view {
    display: none;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 20px 24px;
    margin-bottom: 24px;
}
#detail-view.visible { display: block; }
#detail-view h2 { margin: 0 0 4px 0; font-size: 1.3rem; }
#detail-view .back-link { display: inline-block; margin-bottom: 16px; }

/* Detail fields */
dl.detail-list { margin: 0; }
dl.detail-list dt {
    font-weight: 600;
    margin-top: 16px;
    color: #444;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
}
dl.detail-list dt:first-child { margin-top: 0; }
dl.detail-list dd {
    margin: 4px 0 0 0;
    padding: 0;
    word-break: break-word;
}
dl.detail-list dd.empty { color: #999; font-style: italic; }

/* Sub-records section in detail */
.sub-records-section {
    margin-top: 24px;
    border-top: 2px solid #e0e0e0;
    padding-top: 16px;
}
.sub-records-section h3 {
    margin: 0 0 12px 0;
    font-size: 1.1rem;
}

/* Sub-record table */
.sub-table-wrapper {
    overflow-x: auto;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 16px;
}
.sub-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
.sub-table thead { background: #f7f7f7; }
.sub-table th {
    text-align: left;
    padding: 8px 10px;
    border-bottom: 1px solid #ccc;
    font-weight: 600;
    font-size: 0.85rem;
}
.sub-table td {
    padding: 6px 10px;
    border-bottom: 1px solid #eee;
    vertical-align: top;
}
.sub-table tbody tr:last-child td { border-bottom: none; }
.sub-table tbody tr:hover { background: #f8f8f8; }

/* Ustanovení (legal provisions) list */
.ustanoveni-list {
    list-style: none;
    margin: 0;
    padding: 0;
}
.ustanoveni-list li {
    padding: 2px 0;
    font-size: 0.9rem;
    color: #333;
}

/* Badge / tag for types */
.type-badge {
    display: inline-block;
    padding: 1px 8px;
    border-radius: 3px;
    font-size: 0.8rem;
    font-weight: 500;
}
.type-badge.verejny { background: #e6f4ea; color: #1e4620; }
.type-badge.neverejny { background: #fce8e6; color: #5f1412; }
.type-badge.referencni { background: #e8f0fe; color: #0056b3; }
.type-badge.vlastni { background: #f0f0f0; color: #555; }

/* Responsive */
@media (max-width: 600px) {
    main { padding: 12px; }
    .form-row { flex-direction: column; }
    .form-field { min-width: 100%; }
    th, td { padding: 6px 8px; font-size: 0.85rem; }
    .pagination { flex-direction: column; align-items: flex-start; }
}
</style>
</head>
<body>

<a href="#main-content" class="skip-link">Přeskočit na hlavní obsah</a>

<header>
    <h1>Prohlížeč otevřených dat</h1>
</header>

<main id="main-content">

    <fieldset>
        <legend>Načtení datové sady</legend>
        <div id="presets-area" role="navigation" aria-label="Ukázkové datové sady"></div>
        <div class="form-row">
            <div class="form-field">
                <label for="schema-url">URL schématu (JSON Schema)</label>
                <input type="url" id="schema-url" placeholder="https://…/schema.json">
            </div>
            <div class="form-field">
                <label for="data-url">URL datové sady (JSON)</label>
                <input type="url" id="data-url" placeholder="https://…/data.json">
            </div>
            <div>
                <button id="btn-load" type="button">Načíst</button>
            </div>
        </div>
    </fieldset>

    <div id="status-area" role="status" aria-live="polite"></div>
    <div id="metadata-panel" role="region" aria-label="Informace o datové sadě"></div>

    <!-- Detail view -->
    <div id="detail-view" role="region" aria-label="Detail záznamu">
        <a href="#" class="back-link" id="detail-back">← Zpět na seznam</a>
        <h2 id="detail-title">Detail záznamu</h2>
        <div id="detail-content"></div>
    </div>

    <!-- Toolbar -->
    <div id="toolbar" role="search" aria-label="Vyhledávání a filtry">
        <div class="toolbar-row">
            <div class="search-field">
                <label for="search-input">Fulltextové vyhledávání</label>
                <input type="search" id="search-input" placeholder="Hledaný text…">
            </div>
            <div>
                <button id="btn-toggle-filters" type="button" class="secondary" aria-expanded="false" aria-controls="column-filters">Sloupcové filtry</button>
            </div>
            <div>
                <button id="btn-reset" type="button" class="secondary">Zrušit filtry</button>
            </div>
        </div>
        <div id="column-filters" aria-label="Filtry podle sloupců"></div>
    </div>

    <!-- Table -->
    <div id="table-area" role="region" aria-label="Tabulka dat" aria-live="polite">
        <div class="table-wrapper">
            <table id="data-table">
                <thead id="table-head"></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <nav id="pagination-area" class="pagination" aria-label="Stránkování">
        <div class="pagination-info" id="pagination-info"></div>
        <div class="page-size-select">
            <label for="page-size">Záznamů na stránku:</label>
            <select id="page-size">
                <option value="10">10</option>
                <option value="25" selected>25</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="0">Vše</option>
            </select>
        </div>
        <div class="pagination-controls" id="pagination-controls"></div>
    </nav>

</main>

<script>
(function() {
    'use strict';

    // ===== State =====
    let schemaData = null;
    let rawData = null;
    let allRecords = [];
    let filteredRecords = []; // [{rec, idx}]
    let columns = [];        // all columns including sub-records
    let tableColumns = [];   // flat columns for main table
    let subRecordColumns = []; // array-of-objects columns
    let sortKey = null;
    let sortAsc = true;
    let currentPage = 1;
    let pageSize = 25;
    let columnFilters = {};

    // ===== DOM =====
    const $ = id => document.getElementById(id);
    const elSchemaUrl = $('schema-url'), elDataUrl = $('data-url'), elBtnLoad = $('btn-load');
    const elStatus = $('status-area'), elMetadata = $('metadata-panel');
    const elToolbar = $('toolbar'), elSearch = $('search-input');
    const elBtnFilters = $('btn-toggle-filters'), elColFilters = $('column-filters');
    const elBtnReset = $('btn-reset');
    const elTableHead = $('table-head'), elTableBody = $('table-body');
    const elPagInfo = $('pagination-info'), elPagControls = $('pagination-controls');
    const elPageSize = $('page-size');
    const elDetailView = $('detail-view'), elDetailBack = $('detail-back');
    const elDetailTitle = $('detail-title'), elDetailContent = $('detail-content');
    const elPresetsArea = $('presets-area');
    const elTableArea = $('table-area'), elPagArea = $('pagination-area');

    // ===== Helpers =====
    function setStatus(msg, type) { elStatus.textContent = msg; elStatus.className = type || 'info'; }
    function clearStatus() { elStatus.textContent = ''; elStatus.className = ''; }

    function humanize(key) {
        return key.replace(/([A-Z])/g, ' $1').replace(/[_-]/g, ' ').replace(/^\w/, c => c.toUpperCase()).trim();
    }

    // Language map detection & unwrapping
    const LANG_CODES = new Set(['cs','sk','en','de','fr','pl','hu','es','it','pt','nl','da','sv','fi','no','ru','uk','bg','hr','sl','ro','el','lt','lv','et','ga','mt']);

    function isLangMap(val) {
        if (typeof val !== 'object' || val === null || Array.isArray(val)) return false;
        const keys = Object.keys(val);
        return keys.length > 0 && keys.length <= 6 && keys.every(k => LANG_CODES.has(k));
    }

    function unwrapLang(val) {
        if (isLangMap(val)) return val.cs || val.sk || val.en || Object.values(val)[0] || null;
        return val;
    }

    function getValue(rec, key) {
        const parts = key.split('.');
        let v = rec;
        for (const p of parts) { if (v == null) return undefined; v = v[p]; }
        return unwrapLang(v);
    }

    function getRawValue(rec, key) {
        const parts = key.split('.');
        let v = rec;
        for (const p of parts) { if (v == null) return undefined; v = v[p]; }
        return v;
    }

    function isLangMapSchema(prop) {
        if (prop.type !== 'object' || !prop.properties) return false;
        const keys = Object.keys(prop.properties);
        return keys.length > 0 && keys.every(k => LANG_CODES.has(k));
    }

    function isSubRecordArray(prop) {
        if (prop.type !== 'array') return false;
        const items = resolveRef(prop.items || {});
        return items.type === 'object' && items.properties;
    }

    function resolveRef(prop) {
        if (!prop) return {};
        if (prop['$ref'] && schemaData) {
            const path = prop['$ref'].replace(/^#\//, '').split('/');
            let r = schemaData;
            for (const p of path) r = r?.[p];
            return r ? { ...r, ...prop, '$ref': undefined } : prop;
        }
        if (prop.anyOf || prop.oneOf) {
            const v = (prop.anyOf || prop.oneOf).find(x => x.type !== 'null') || (prop.anyOf || prop.oneOf)[0];
            return { ...v, title: prop.title || v.title, description: prop.description || v.description };
        }
        return prop;
    }

    function detectType(prop) {
        if (prop.type === 'array') return 'array';
        if (prop.type === 'object') return isLangMapSchema(prop) ? 'langMap' : 'object';
        if (prop.type === 'integer' || prop.type === 'number') return 'number';
        if (prop.type === 'boolean') return 'boolean';
        if (prop.format === 'date' || prop.format === 'date-time') return 'date';
        if (prop.format === 'uri' || prop.format === 'iri') return 'uri';
        return 'string';
    }

    function formatDate(val) {
        try {
            const d = new Date(val);
            if (isNaN(d.getTime())) return String(val);
            return String(val).length <= 10 ? d.toLocaleDateString('cs') : d.toLocaleString('cs');
        } catch(e) { return String(val); }
    }

    function shortenUrl(url) {
        try {
            const u = new URL(url);
            const p = u.pathname.length > 40 ? u.pathname.substring(0, 40) + '…' : u.pathname;
            return u.hostname + p;
        } catch(e) { return url.length > 60 ? url.substring(0, 60) + '…' : url; }
    }

    function valueToString(val) {
        if (val == null || val === '') return '';
        val = unwrapLang(val);
        if (val == null) return '';
        if (typeof val === 'object') {
            if (Array.isArray(val)) return val.map(valueToString).join(', ');
            return val.označení || val.název?.cs || val.name || val.label || val.cs ||
                Object.values(val).filter(v => typeof v === 'string').join(', ') || '';
        }
        return String(val);
    }

    // Classify coded values like "typ-údaje/VLASTNI"
    function classifyCodedValue(val) {
        if (typeof val !== 'string') return null;
        const i = val.lastIndexOf('/');
        if (i < 0 || i === 0 || i === val.length - 1) return null;
        const prefix = val.substring(0, i);
        const code = val.substring(i + 1);
        // Must look like a code (no spaces, contains uppercase or underscore)
        if (!/^[A-Z0-9_]+$/.test(code)) return null;
        const labels = {
            'VLASTNI': 'Vlastní', 'REFERENCNI': 'Referenční',
            'NESDILENY': 'Nesdílený', 'SDILENY': 'Sdílený',
            'NEMA_NOTIFIKACI': 'Nemá notifikaci', 'MA_NOTIFIKACI': 'Má notifikaci'
        };
        const badgeClasses = { 'REFERENCNI': 'referencni', 'VLASTNI': 'vlastni' };
        return { label: labels[code] || code.replace(/_/g, ' '), code, badgeClass: badgeClasses[code] || '' };
    }

    // ===== Presets =====
    const PRESETS = [
        { name: 'RPP – Údaje', schema: 'https://ofn.gov.cz/registr-pr%C3%A1v-a-povinnost%C3%AD/%C3%BAdaje/2021-01-12/%C3%BAdaje.schema.json', data: 'https://rpp-opendata.egon.gov.cz/odrpp/datovasada/udaje.json' },
        { name: 'Turistické cíle Brno', schema: 'https://ofn.gov.cz/turistické-cíle/2020-07-01/schémata/turistický-cíl.json', data: 'https://www.brno.cz/opendata/turisticke-cile.json' },
        { name: 'Sportoviště Brno', schema: 'https://ofn.gov.cz/sportoviště/2020-07-01/schémata/sportoviště.json', data: 'https://www.brno.cz/opendata/sportoviste.json' },
        { name: 'Aktuality Brno', schema: 'https://ofn.gov.cz/aktuality/2019-11-28/schémata/aktualita.json', data: 'https://www.brno.cz/opendata/aktuality.json' }
    ];

    function renderPresets() {
        elPresetsArea.innerHTML = '';
        const span = document.createElement('span');
        span.textContent = 'Příklady: ';
        span.style.cssText = 'font-size:0.9rem;font-weight:500';
        elPresetsArea.appendChild(span);
        PRESETS.forEach(p => {
            const a = document.createElement('a');
            a.href = '#'; a.className = 'preset-link'; a.textContent = p.name;
            a.addEventListener('click', e => { e.preventDefault(); elSchemaUrl.value = p.schema; elDataUrl.value = p.data; loadData(); });
            elPresetsArea.appendChild(a);
        });
    }

    // ===== URL hash =====
    function saveHash() {
        const p = new URLSearchParams();
        if (elSchemaUrl.value) p.set('schema', elSchemaUrl.value);
        if (elDataUrl.value) p.set('data', elDataUrl.value);
        history.replaceState(null, '', '#' + p.toString());
    }
    function loadHash() {
        if (!location.hash || location.hash.length < 2) return false;
        try {
            const p = new URLSearchParams(location.hash.substring(1));
            if (p.get('schema')) elSchemaUrl.value = p.get('schema');
            if (p.get('data')) elDataUrl.value = p.get('data');
            return !!(p.get('schema') && p.get('data'));
        } catch(e) { return false; }
    }

    // ===== Fetch =====
    async function fetchJSON(url, label) {
        setStatus(`Načítám ${label}…`, 'info');
        try {
            const r = await fetch(url);
            if (r.ok) return await r.json();
            throw new Error(`HTTP ${r.status}`);
        } catch(e) {
            for (const proxy of ['https://corsproxy.io/?','https://api.allorigins.win/raw?url=']) {
                try {
                    const r = await fetch(proxy + encodeURIComponent(url));
                    if (r.ok) return await r.json();
                } catch(e2) {}
            }
            throw new Error(`Nepodařilo se načíst ${label}`);
        }
    }

    // ===== Schema parsing =====
    function parseSchema(schema) {
        columns = []; tableColumns = []; subRecordColumns = [];
        let props = null, parentSchema = null;

        if (schema.properties) {
            const arrayProp = Object.entries(schema.properties).find(([k, v]) => v.type === 'array' && v.items);
            if (arrayProp) {
                const items = resolveRef(arrayProp[1].items);
                if (items.properties) { parentSchema = items; props = items.properties; }
            }
            if (!props) { parentSchema = schema; props = schema.properties; }
        } else if (schema.type === 'array' && schema.items) {
            const items = resolveRef(schema.items);
            parentSchema = items; props = items.properties;
        }
        if (!props) return false;

        for (const [key, rawProp] of Object.entries(props)) {
            const prop = resolveRef(rawProp);
            const type = detectType(prop);
            const title = prop.title || humanize(key);

            if (type === 'array' && isSubRecordArray(prop)) {
                const itemSchema = resolveRef(prop.items);
                const subCols = [];
                if (itemSchema.properties) {
                    for (const [sk, sr] of Object.entries(itemSchema.properties)) {
                        const sp = resolveRef(sr);
                        const st = detectType(sp);
                        subCols.push({ key: sk, title: sp.title || humanize(sk), type: st === 'langMap' ? 'string' : st, description: sp.description || '' });
                    }
                }
                const col = { key, title, type: 'subRecords', description: prop.description || '', subColumns: subCols, isSubRecords: true };
                columns.push(col);
                subRecordColumns.push(col);
            } else {
                const col = { key, title, type: (type === 'langMap' || type === 'object') ? 'string' : type, description: prop.description || '', enumValues: prop.enum || null, format: prop.format || null, isSubRecords: false };
                columns.push(col);
                tableColumns.push(col);
            }
        }
        return columns.length > 0;
    }

    function columnsFromData() {
        columns = []; tableColumns = []; subRecordColumns = [];
        const keys = new Set();
        allRecords.slice(0, 50).forEach(r => { if (typeof r === 'object' && r) Object.keys(r).forEach(k => keys.add(k)); });

        keys.forEach(key => {
            const sample = allRecords.find(r => r[key] != null)?.[key];
            if (Array.isArray(sample) && sample.length > 0 && typeof sample[0] === 'object' && !isLangMap(sample[0])) {
                const subKeys = new Set();
                sample.slice(0, 20).forEach(item => { if (typeof item === 'object' && item) Object.keys(item).forEach(k => subKeys.add(k)); });
                const subCols = [...subKeys].map(k => ({ key: k, title: humanize(k), type: 'string', description: '' }));
                const col = { key, title: humanize(key), type: 'subRecords', description: '', subColumns: subCols, isSubRecords: true };
                columns.push(col); subRecordColumns.push(col);
            } else {
                const uv = unwrapLang(sample);
                let type = 'string';
                if (typeof uv === 'number') type = 'number';
                else if (typeof uv === 'boolean') type = 'boolean';
                else if (typeof uv === 'string' && /^https?:\/\//.test(uv)) type = 'uri';
                const col = { key, title: humanize(key), type, description: '', isSubRecords: false };
                columns.push(col); tableColumns.push(col);
            }
        });
    }

    // ===== Data parsing =====
    function parseData(data) {
        if (Array.isArray(data)) { allRecords = data; return; }
        if (typeof data === 'object' && data) {
            const arrKeys = Object.keys(data).filter(k => Array.isArray(data[k]));
            if (arrKeys.length > 0) {
                let best = arrKeys[0];
                for (const k of arrKeys) if (data[k].length > data[best].length) best = k;
                allRecords = data[best]; return;
            }
            allRecords = [data]; return;
        }
        throw new Error('Data nemají rozpoznatelný formát');
    }

    // ===== Metadata =====
    function renderMetadata() {
        elMetadata.innerHTML = '';
        const h2 = document.createElement('h2');
        const schemaId = schemaData?.['$id'] || schemaData?.title || '';
        let displayTitle = schemaData?.title || '';
        if (!displayTitle && schemaId) {
            try { displayTitle = decodeURIComponent(schemaId.split('/').filter(Boolean).pop() || '').replace(/\.schema\.json$|\.json$/, ''); } catch(e) { displayTitle = schemaId; }
        }
        h2.textContent = displayTitle || 'Datová sada';
        elMetadata.appendChild(h2);

        if (schemaData?.description) {
            const p = document.createElement('p'); p.textContent = schemaData.description; elMetadata.appendChild(p);
        }

        const stats = document.createElement('p');
        stats.className = 'meta-stats';
        const subInfo = subRecordColumns.length > 0 ? ` · Podřízené záznamy: ${subRecordColumns.map(c => c.title).join(', ')}` : '';
        stats.textContent = `${allRecords.length} záznamů · ${tableColumns.length} sloupců${subInfo}`;
        elMetadata.appendChild(stats);

        const pLinks = document.createElement('p');
        pLinks.style.cssText = 'font-size:0.85rem;color:#666;margin-top:8px';
        const mkLink = (href, text) => { const a = document.createElement('a'); a.href = href; a.target = '_blank'; a.rel = 'noopener'; a.textContent = text; return a; };
        pLinks.appendChild(mkLink(elSchemaUrl.value, 'Schéma'));
        pLinks.appendChild(document.createTextNode(' · '));
        pLinks.appendChild(mkLink(elDataUrl.value, 'Zdrojová data (JSON)'));
        elMetadata.appendChild(pLinks);
    }

    // ===== Table head =====
    function renderTableHead() {
        elTableHead.innerHTML = '';
        const tr = document.createElement('tr');

        const thN = document.createElement('th'); thN.textContent = '#'; thN.setAttribute('scope', 'col'); tr.appendChild(thN);

        tableColumns.forEach(col => {
            const th = document.createElement('th'); th.setAttribute('scope', 'col');
            if (col.description) th.title = col.description;
            const a = document.createElement('a'); a.href = '#'; a.textContent = col.title;
            a.addEventListener('click', e => {
                e.preventDefault();
                if (sortKey === col.key) sortAsc = !sortAsc;
                else { sortKey = col.key; sortAsc = true; }
                applyFilters(); updateSortIndicators();
            });
            th.appendChild(a);
            const ind = document.createElement('span'); ind.className = 'sort-indicator'; ind.setAttribute('aria-hidden', 'true');
            th.appendChild(ind);
            tr.appendChild(th);
        });

        subRecordColumns.forEach(col => {
            const th = document.createElement('th'); th.textContent = col.title; th.setAttribute('scope', 'col'); tr.appendChild(th);
        });

        const thA = document.createElement('th'); thA.textContent = 'Akce'; thA.setAttribute('scope', 'col'); tr.appendChild(thA);
        elTableHead.appendChild(tr);
    }

    function updateSortIndicators() {
        const ths = elTableHead.querySelectorAll('th');
        tableColumns.forEach((col, i) => {
            const th = ths[i + 1]; if (!th) return;
            const ind = th.querySelector('.sort-indicator'); if (!ind) return;
            if (col.key === sortKey) { ind.textContent = sortAsc ? '▲' : '▼'; th.setAttribute('aria-sort', sortAsc ? 'ascending' : 'descending'); }
            else { ind.textContent = ''; th.removeAttribute('aria-sort'); }
        });
    }

    // ===== Column filters =====
    function renderColumnFilters() {
        elColFilters.innerHTML = '';
        tableColumns.forEach(col => {
            const div = document.createElement('div'); div.className = 'col-filter';
            const label = document.createElement('label'); label.setAttribute('for', 'cf-' + col.key); label.textContent = col.title; div.appendChild(label);

            const uniqueVals = getUniqueValues(col.key, 20);
            if (col.type === 'boolean' || (uniqueVals && uniqueVals.length > 1 && uniqueVals.length <= 20)) {
                const sel = document.createElement('select'); sel.id = 'cf-' + col.key;
                addOption(sel, '', '— vše —');
                if (col.type === 'boolean') { addOption(sel, 'true', 'Ano'); addOption(sel, 'false', 'Ne'); }
                else (uniqueVals || []).forEach(v => addOption(sel, String(v), formatDisplayValue(v)));
                sel.addEventListener('change', () => { columnFilters[col.key] = sel.value; currentPage = 1; applyFilters(); });
                div.appendChild(sel);
            } else {
                const inp = document.createElement('input'); inp.type = 'text'; inp.id = 'cf-' + col.key; inp.placeholder = 'Filtr…';
                let t;
                inp.addEventListener('input', () => { clearTimeout(t); t = setTimeout(() => { columnFilters[col.key] = inp.value; currentPage = 1; applyFilters(); }, 300); });
                div.appendChild(inp);
            }
            elColFilters.appendChild(div);
        });
    }

    function addOption(sel, val, text) { const o = document.createElement('option'); o.value = val; o.textContent = text; sel.appendChild(o); }

    function getUniqueValues(key, limit) {
        const s = new Set();
        for (const r of allRecords) {
            const v = getValue(r, key);
            if (v != null && typeof v !== 'object') s.add(v);
            if (s.size > limit) return null;
        }
        return [...s].sort((a, b) => String(a).localeCompare(String(b), 'cs'));
    }

    function formatDisplayValue(val) {
        if (typeof val === 'string') { const c = classifyCodedValue(val); if (c) return c.label; }
        return String(unwrapLang(val) ?? val);
    }

    // ===== Cell rendering =====
    function renderCell(td, rawVal, col) {
        const val = unwrapLang(rawVal);
        if (val == null || val === '') { td.textContent = '—'; td.style.color = '#999'; return; }

        if (col.type === 'uri' || (typeof val === 'string' && /^https?:\/\//.test(val))) {
            const a = document.createElement('a'); a.href = val; a.target = '_blank'; a.rel = 'noopener'; a.textContent = shortenUrl(val);
            td.appendChild(a); return;
        }
        if (col.type === 'boolean') { td.textContent = val ? 'Ano' : 'Ne'; return; }
        if (col.type === 'number') { td.textContent = String(val); td.className = 'cell-number'; return; }

        if (typeof val === 'string') {
            const coded = classifyCodedValue(val);
            if (coded) { const b = document.createElement('span'); b.className = 'type-badge ' + coded.badgeClass; b.textContent = coded.label; td.appendChild(b); return; }
        }
        if (Array.isArray(val)) { td.textContent = val.map(valueToString).join(', '); return; }
        if (typeof val === 'object') { td.textContent = valueToString(val); return; }
        if (col.type === 'date') { td.textContent = formatDate(val); return; }
        td.textContent = String(val);
    }

    // ===== Filter & Sort =====
    function applyFilters() {
        const q = elSearch.value.trim().toLowerCase();

        filteredRecords = allRecords.map((rec, idx) => ({ rec, idx })).filter(({ rec }) => {
            if (q) {
                let hay = tableColumns.map(c => valueToString(getValue(rec, c.key))).join(' ');
                subRecordColumns.forEach(c => {
                    const arr = rec[c.key];
                    if (Array.isArray(arr)) arr.forEach(item => { hay += ' ' + Object.values(item).map(valueToString).join(' '); });
                });
                if (!hay.toLowerCase().includes(q)) return false;
            }
            for (const col of tableColumns) {
                const f = columnFilters[col.key];
                if (!f) continue;
                const val = getValue(rec, col.key);
                if (col.type === 'boolean') { if (String(!!val) !== f) return false; }
                else {
                    const vs = valueToString(val).toLowerCase();
                    const raw = String(getRawValue(rec, col.key) ?? '');
                    if (!vs.includes(f.toLowerCase()) && raw !== f) return false;
                }
            }
            return true;
        });

        if (sortKey) {
            filteredRecords.sort((a, b) => {
                let va = getValue(a.rec, sortKey), vb = getValue(b.rec, sortKey);
                if (va == null && vb == null) return 0;
                if (va == null) return 1; if (vb == null) return -1;
                const col = tableColumns.find(c => c.key === sortKey);
                if (col?.type === 'number') return sortAsc ? (Number(va)||0)-(Number(vb)||0) : (Number(vb)||0)-(Number(va)||0);
                return sortAsc ? String(va).localeCompare(String(vb), 'cs') : String(vb).localeCompare(String(va), 'cs');
            });
        }

        renderTableBody(); renderPagination(); updateSortIndicators();
    }

    function renderTableBody() {
        elTableBody.innerHTML = '';
        const start = pageSize > 0 ? (currentPage - 1) * pageSize : 0;
        const end = pageSize > 0 ? start + pageSize : filteredRecords.length;
        const page = filteredRecords.slice(start, end);

        if (page.length === 0) {
            const tr = document.createElement('tr'); const td = document.createElement('td');
            td.colSpan = tableColumns.length + subRecordColumns.length + 2;
            td.textContent = allRecords.length > 0 ? 'Žádné záznamy neodpovídají filtru.' : 'Žádná data.';
            td.style.cssText = 'text-align:center;padding:24px;color:#666';
            tr.appendChild(td); elTableBody.appendChild(tr); return;
        }

        page.forEach(({ rec, idx }, i) => {
            const tr = document.createElement('tr');
            const tdN = document.createElement('td'); tdN.textContent = start + i + 1; tdN.style.cssText = 'color:#999;text-align:right'; tr.appendChild(tdN);

            tableColumns.forEach(col => { const td = document.createElement('td'); renderCell(td, getRawValue(rec, col.key), col); tr.appendChild(td); });

            subRecordColumns.forEach(col => {
                const td = document.createElement('td');
                const arr = rec[col.key];
                if (Array.isArray(arr) && arr.length > 0) {
                    const b = document.createElement('span'); b.className = 'sub-count'; b.textContent = arr.length + ' zázn.'; td.appendChild(b);
                } else { td.textContent = '—'; td.style.color = '#999'; }
                tr.appendChild(td);
            });

            const tdA = document.createElement('td');
            const link = document.createElement('a'); link.href = '#detail-' + idx; link.textContent = 'Detail';
            link.addEventListener('click', e => { e.preventDefault(); showDetail(idx); });
            tdA.appendChild(link); tr.appendChild(tdA);
            elTableBody.appendChild(tr);
        });
    }

    // ===== Pagination =====
    function renderPagination() {
        const total = filteredRecords.length;
        const totalPages = pageSize > 0 ? Math.ceil(total / pageSize) : 1;
        if (currentPage > totalPages) currentPage = totalPages || 1;
        const start = pageSize > 0 ? (currentPage - 1) * pageSize + 1 : 1;
        const end = pageSize > 0 ? Math.min(currentPage * pageSize, total) : total;

        elPagInfo.textContent = total > 0
            ? `Zobrazeno ${start}–${end} z ${total} záznamů` + (total < allRecords.length ? ` (filtrováno z ${allRecords.length})` : '')
            : `0 záznamů` + (allRecords.length > 0 ? ` (z ${allRecords.length})` : '');

        elPagControls.innerHTML = '';
        if (totalPages <= 1) return;

        pagBtn('← Předchozí', currentPage <= 1, () => { currentPage--; applyFilters(); scrollTo(); });
        pageNums(currentPage, totalPages).forEach(p => {
            if (p === '…') { const s = document.createElement('span'); s.textContent = '…'; s.style.padding = '6px 4px'; elPagControls.appendChild(s); }
            else pagBtn(p, false, () => { currentPage = p; applyFilters(); scrollTo(); }, p === currentPage);
        });
        pagBtn('Další →', currentPage >= totalPages, () => { currentPage++; applyFilters(); scrollTo(); });
    }

    function pagBtn(text, disabled, onClick, isCurrent) {
        const b = document.createElement('button'); b.textContent = text;
        b.className = isCurrent ? '' : 'secondary'; b.disabled = disabled;
        if (isCurrent) b.setAttribute('aria-current', 'page');
        if (typeof text === 'number') b.setAttribute('aria-label', `Stránka ${text}`);
        b.addEventListener('click', onClick); elPagControls.appendChild(b);
    }

    function pageNums(cur, tot) {
        if (tot <= 7) return Array.from({ length: tot }, (_, i) => i + 1);
        const p = [1];
        if (cur > 3) p.push('…');
        for (let i = Math.max(2, cur - 1); i <= Math.min(tot - 1, cur + 1); i++) p.push(i);
        if (cur < tot - 2) p.push('…');
        p.push(tot);
        return p;
    }

    function scrollTo() { elTableArea.scrollIntoView({ behavior: 'smooth' }); }

    // ===== Detail view =====
    function showDetail(index) {
        const rec = allRecords[index];
        if (!rec) return;
        elDetailContent.innerHTML = '';

        const titleVal = findTitle(rec);
        elDetailTitle.textContent = titleVal || `Záznam #${index + 1}`;

        // Main fields
        const dl = document.createElement('dl'); dl.className = 'detail-list';
        const knownKeys = new Set();

        columns.forEach(col => {
            knownKeys.add(col.key);
            if (col.isSubRecords) return;
            const rawVal = getRawValue(rec, col.key);
            const dt = document.createElement('dt'); dt.textContent = col.title;
            if (col.description) dt.title = col.description;
            dl.appendChild(dt);
            const dd = document.createElement('dd');
            renderDetailValue(dd, rawVal, col);
            dl.appendChild(dd);
        });

        // Extra fields not in schema
        Object.keys(rec).forEach(key => {
            if (knownKeys.has(key)) return;
            const rawVal = rec[key];
            // Skip sub-record arrays (handled below)
            if (Array.isArray(rawVal) && rawVal.length > 0 && typeof rawVal[0] === 'object' && !isLangMap(rawVal[0])) return;
            const dt = document.createElement('dt'); dt.textContent = humanize(key); dl.appendChild(dt);
            const dd = document.createElement('dd');
            renderDetailValueAuto(dd, rawVal);
            dl.appendChild(dd);
        });

        elDetailContent.appendChild(dl);

        // Sub-record sections (from schema)
        subRecordColumns.forEach(col => {
            renderSubRecordSection(rec[col.key], col.title, col.subColumns);
        });

        // Extra sub-record arrays not in schema
        Object.keys(rec).forEach(key => {
            if (knownKeys.has(key)) return;
            const val = rec[key];
            if (!Array.isArray(val) || val.length === 0 || typeof val[0] !== 'object' || isLangMap(val[0])) return;
            const subKeys = new Set();
            val.slice(0, 20).forEach(item => { if (typeof item === 'object' && item) Object.keys(item).forEach(k => subKeys.add(k)); });
            const subCols = [...subKeys].map(k => ({ key: k, title: humanize(k), type: 'string', description: '' }));
            renderSubRecordSection(val, humanize(key), subCols);
        });

        elDetailView.classList.add('visible');
        elToolbar.classList.remove('visible');
        elTableArea.style.display = 'none';
        elPagArea.style.display = 'none';
        elDetailView.scrollIntoView({ behavior: 'smooth' });
        elDetailTitle.focus();
    }

    function renderSubRecordSection(arr, title, subCols) {
        if (!Array.isArray(arr) || arr.length === 0) return;

        const section = document.createElement('div'); section.className = 'sub-records-section';
        const h3 = document.createElement('h3'); h3.textContent = `${title} (${arr.length})`; section.appendChild(h3);

        // If no subCols, generate from data
        if (!subCols || subCols.length === 0) {
            const keys = new Set();
            arr.slice(0, 20).forEach(item => { if (typeof item === 'object' && item) Object.keys(item).forEach(k => keys.add(k)); });
            subCols = [...keys].map(k => ({ key: k, title: humanize(k), type: 'string', description: '' }));
        }

        // Filter out 'type' if all values identical
        const typeVals = new Set(arr.map(item => item?.type).filter(Boolean));
        let visibleCols = subCols;
        if (typeVals.size <= 1) visibleCols = subCols.filter(c => c.key !== 'type');

        // Also filter 'id' if it's just a technical id
        const idVals = arr.map(item => item?.id).filter(Boolean);
        if (idVals.length > 0 && idVals.every(v => typeof v === 'string' && /^[a-záčďéěíňóřšťúůýž\/-]+\/[\d-]+$/i.test(v))) {
            // Keep id but move it later or keep for reference
        }

        const wrapper = document.createElement('div'); wrapper.className = 'sub-table-wrapper';
        const table = document.createElement('table'); table.className = 'sub-table';

        const thead = document.createElement('thead');
        const headRow = document.createElement('tr');
        const thIdx = document.createElement('th'); thIdx.textContent = '#'; thIdx.setAttribute('scope', 'col'); headRow.appendChild(thIdx);
        visibleCols.forEach(sc => {
            const th = document.createElement('th'); th.textContent = sc.title; th.setAttribute('scope', 'col');
            if (sc.description) th.title = sc.description;
            headRow.appendChild(th);
        });
        thead.appendChild(headRow); table.appendChild(thead);

        const tbody = document.createElement('tbody');
        arr.forEach((item, i) => {
            const tr = document.createElement('tr');
            const tdI = document.createElement('td'); tdI.textContent = i + 1; tdI.style.cssText = 'color:#999;text-align:right'; tr.appendChild(tdI);
            visibleCols.forEach(sc => {
                const td = document.createElement('td');
                renderSubCellValue(td, item?.[sc.key]);
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        wrapper.appendChild(table);
        section.appendChild(wrapper);
        elDetailContent.appendChild(section);
    }

    function renderDetailValue(dd, rawVal, col) {
        const val = unwrapLang(rawVal);
        if (val == null || val === '') { dd.textContent = '(prázdné)'; dd.className = 'empty'; return; }

        if (col.type === 'uri' || (typeof val === 'string' && /^https?:\/\//.test(val))) {
            const a = document.createElement('a'); a.href = val; a.target = '_blank'; a.rel = 'noopener'; a.textContent = val; dd.appendChild(a); return;
        }
        if (col.type === 'boolean') { dd.textContent = val ? 'Ano' : 'Ne'; return; }

        if (typeof val === 'string') {
            const coded = classifyCodedValue(val);
            if (coded) { const b = document.createElement('span'); b.className = 'type-badge ' + coded.badgeClass; b.textContent = coded.label; dd.appendChild(b); dd.appendChild(document.createTextNode(' (' + val + ')')); return; }
            if (val.startsWith('/eli/')) { const a = document.createElement('a'); a.href = 'https://www.e-sbirka.cz' + val; a.target = '_blank'; a.rel = 'noopener'; a.textContent = val; dd.appendChild(a); return; }
        }
        if (Array.isArray(val)) { dd.textContent = val.length === 0 ? '(prázdné)' : val.map(valueToString).join(', '); if (val.length === 0) dd.className = 'empty'; return; }
        if (typeof val === 'object') { renderObjectAsDl(dd, val); return; }
        if (col.type === 'date') { dd.textContent = formatDate(val); return; }
        dd.textContent = String(val);
    }

    function renderDetailValueAuto(dd, rawVal) {
        const val = unwrapLang(rawVal);
        if (val == null || val === '') { dd.textContent = '(prázdné)'; dd.className = 'empty'; return; }
        if (typeof val === 'string' && /^https?:\/\//.test(val)) { const a = document.createElement('a'); a.href = val; a.target = '_blank'; a.rel = 'noopener'; a.textContent = val; dd.appendChild(a); return; }
        if (typeof val === 'string') {
            const coded = classifyCodedValue(val);
            if (coded) { const b = document.createElement('span'); b.className = 'type-badge ' + coded.badgeClass; b.textContent = coded.label; dd.appendChild(b); dd.appendChild(document.createTextNode(' (' + val + ')')); return; }
            if (val.startsWith('/eli/')) { const a = document.createElement('a'); a.href = 'https://www.e-sbirka.cz' + val; a.target = '_blank'; a.rel = 'noopener'; a.textContent = val; dd.appendChild(a); return; }
            dd.textContent = val; return;
        }
        if (Array.isArray(val)) {
            if (val.length === 0) { dd.textContent = '(prázdné)'; dd.className = 'empty'; return; }
            // Array of strings
            if (typeof val[0] === 'string') {
                val.forEach((item, i) => {
                    if (i > 0) dd.appendChild(document.createElement('br'));
                    if (item.startsWith('/eli/')) { const a = document.createElement('a'); a.href = 'https://www.e-sbirka.cz' + item; a.target = '_blank'; a.rel = 'noopener'; a.textContent = item; dd.appendChild(a); }
                    else dd.appendChild(document.createTextNode(item));
                });
                return;
            }
            dd.textContent = val.map(valueToString).join(', ');
            return;
        }
        if (typeof val === 'object') { renderObjectAsDl(dd, val); return; }
        dd.textContent = String(val);
    }

    function renderObjectAsDl(container, obj) {
        const dl = document.createElement('dl'); dl.className = 'detail-list'; dl.style.marginLeft = '16px';
        for (const [k, v] of Object.entries(obj)) {
            if (v == null) continue;
            const dt = document.createElement('dt'); dt.textContent = humanize(k); dl.appendChild(dt);
            const dd = document.createElement('dd');
            const uv = unwrapLang(v);
            if (typeof uv === 'string' && /^https?:\/\//.test(uv)) { const a = document.createElement('a'); a.href = uv; a.target = '_blank'; a.rel = 'noopener'; a.textContent = uv; dd.appendChild(a); }
            else if (typeof uv === 'object' && uv !== null && !Array.isArray(uv)) renderObjectAsDl(dd, uv);
            else dd.textContent = String(uv ?? '');
            dl.appendChild(dd);
        }
        container.appendChild(dl);
    }

    function renderSubCellValue(td, rawVal) {
        const val = unwrapLang(rawVal);
        if (val == null || val === '') { td.textContent = '—'; td.style.color = '#999'; return; }

        if (typeof val === 'string') {
            if (/^https?:\/\//.test(val)) { const a = document.createElement('a'); a.href = val; a.target = '_blank'; a.rel = 'noopener'; a.textContent = shortenUrl(val); td.appendChild(a); return; }
            if (val.startsWith('/eli/')) { const a = document.createElement('a'); a.href = 'https://www.e-sbirka.cz' + val; a.target = '_blank'; a.rel = 'noopener'; a.textContent = val; td.appendChild(a); return; }
            const coded = classifyCodedValue(val);
            if (coded) { const b = document.createElement('span'); b.className = 'type-badge ' + coded.badgeClass; b.textContent = coded.label; td.appendChild(b); return; }
            td.textContent = val; return;
        }

        if (Array.isArray(val)) {
            if (val.length === 0) { td.textContent = '—'; td.style.color = '#999'; return; }
            if (typeof val[0] === 'string') {
                val.forEach((item, i) => {
                    if (i > 0) td.appendChild(document.createElement('br'));
                    if (item.startsWith('/eli/')) { const a = document.createElement('a'); a.href = 'https://www.e-sbirka.cz' + item; a.target = '_blank'; a.rel = 'noopener'; a.textContent = item; td.appendChild(a); }
                    else td.appendChild(document.createTextNode(item));
                });
                return;
            }
            if (typeof val[0] === 'object') {
                const ul = document.createElement('ul'); ul.style.cssText = 'list-style:none;margin:0;padding:0';
                val.forEach(item => { const li = document.createElement('li'); li.textContent = item.označení || valueToString(item); ul.appendChild(li); });
                td.appendChild(ul); return;
            }
            td.textContent = val.join(', '); return;
        }

        if (typeof val === 'object') { td.textContent = valueToString(val); return; }
        td.textContent = String(val);
    }

    function findTitle(rec) {
        for (const key of ['název', 'name', 'jméno', 'nazev', 'title', 'label']) {
            const v = getValue(rec, key);
            if (v && typeof v === 'string') return v;
        }
        for (const col of tableColumns) {
            if (col.type === 'string' && col.key !== 'type' && col.key !== 'id') {
                const v = getValue(rec, col.key);
                if (v && typeof v === 'string' && v.length < 150) return v;
            }
        }
        return null;
    }

    function hideDetail() {
        elDetailView.classList.remove('visible');
        elToolbar.classList.add('visible');
        elTableArea.style.display = '';
        elPagArea.style.display = '';
    }

    // ===== Main load =====
    async function loadData() {
        const schemaUrl = elSchemaUrl.value.trim(), dataUrl = elDataUrl.value.trim();
        if (!schemaUrl || !dataUrl) { setStatus('Vyplňte prosím obě URL.', 'error'); return; }

        schemaData = null; rawData = null; allRecords = []; filteredRecords = [];
        columns = []; tableColumns = []; subRecordColumns = [];
        sortKey = null; sortAsc = true; currentPage = 1; columnFilters = {};
        elSearch.value = '';
        hideDetail();
        elToolbar.classList.remove('visible');
        elTableHead.innerHTML = ''; elTableBody.innerHTML = '';
        elPagInfo.textContent = ''; elPagControls.innerHTML = '';
        elMetadata.innerHTML = '';

        elBtnLoad.disabled = true; elBtnLoad.textContent = 'Načítám…';

        try {
            schemaData = await fetchJSON(schemaUrl, 'schéma');
            rawData = await fetchJSON(dataUrl, 'data');
            const ok = parseSchema(schemaData);
            parseData(rawData);
            if (!ok || columns.length === 0) columnsFromData();
            if (allRecords.length === 0) { setStatus('Data neobsahují žádné záznamy.', 'error'); return; }

            saveHash(); clearStatus();
            renderMetadata();
            elToolbar.classList.add('visible');
            renderTableHead(); renderColumnFilters(); applyFilters();
            setStatus(`Úspěšně načteno ${allRecords.length} záznamů.`, 'success');
        } catch (e) {
            setStatus('Chyba: ' + e.message, 'error');
        } finally {
            elBtnLoad.disabled = false; elBtnLoad.textContent = 'Načíst';
        }
    }

    // ===== Events =====
    elBtnLoad.addEventListener('click', loadData);
    elSchemaUrl.addEventListener('keydown', e => { if (e.key === 'Enter') loadData(); });
    elDataUrl.addEventListener('keydown', e => { if (e.key === 'Enter') loadData(); });
    let sT; elSearch.addEventListener('input', () => { clearTimeout(sT); sT = setTimeout(() => { currentPage = 1; applyFilters(); }, 300); });
    elBtnFilters.addEventListener('click', () => { const e = elBtnFilters.getAttribute('aria-expanded') === 'true'; elBtnFilters.setAttribute('aria-expanded', !e); elColFilters.classList.toggle('visible'); });
    elBtnReset.addEventListener('click', () => { elSearch.value = ''; columnFilters = {}; sortKey = null; sortAsc = true; currentPage = 1; elColFilters.querySelectorAll('input').forEach(i => i.value = ''); elColFilters.querySelectorAll('select').forEach(s => s.selectedIndex = 0); applyFilters(); elSearch.focus(); });
    elPageSize.addEventListener('change', () => { pageSize = parseInt(elPageSize.value) || 0; currentPage = 1; renderTableBody(); renderPagination(); });
    elDetailBack.addEventListener('click', e => { e.preventDefault(); hideDetail(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape' && elDetailView.classList.contains('visible')) hideDetail(); });

    // ===== Init =====
    renderPresets(); if (loadHash()) loadData();
})();
</script>
</body>
</html>
