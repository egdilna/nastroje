<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prohl√≠≈æeƒç RPP</title>
<style>
*,*::before,*::after{box-sizing:border-box}
body{font-family:system-ui,-apple-system,sans-serif;margin:0;padding:0;background:#f5f5f5;color:#1a1a1a;line-height:1.6}
a{color:#0056b3}a:hover{color:#003d80}
a:focus-visible,button:focus-visible,input:focus-visible,select:focus-visible{outline:3px solid #0056b3;outline-offset:2px}
.skip-link{position:absolute;top:-100px;left:8px;background:#0056b3;color:#fff;padding:8px 16px;z-index:1000;border-radius:0 0 4px 4px;text-decoration:none;font-weight:600}
.skip-link:focus{top:0}
header{background:#1a1a1a;color:#fff;padding:16px 24px}
header h1{margin:0;font-size:1.4rem;font-weight:600}
header p{margin:4px 0 0;font-size:0.85rem;color:#aaa}
main{max-width:1800px;margin:0 auto;padding:16px 24px}

/* Loading */
#loading-panel{background:#fff;border:1px solid #ccc;border-radius:6px;padding:20px;margin-bottom:20px}
#loading-panel:empty{display:none}
#loading-panel h2{margin:0 0 12px;font-size:1.1rem}
.load-item{display:flex;align-items:center;gap:8px;padding:3px 0;font-size:0.9rem}
.load-icon{width:18px;text-align:center;font-size:0.85rem}
.load-ok{color:#34a853}.load-err{color:#ea4335}.load-wait{color:#999}
.load-fallback{margin-top:4px;margin-left:26px;padding:8px 12px;background:#fff8e1;border:1px solid #f9a825;border-radius:4px;font-size:0.85rem}
.load-fallback a{font-weight:600}
.load-fallback label{display:inline-block;margin-top:4px}
.load-fallback input[type=file]{margin-left:4px;font-size:0.85rem}
.load-fallback button{padding:5px 14px;font-size:0.85rem}
#loading-progress{margin-top:12px;font-weight:600;font-size:0.95rem}

/* Status */
#status-area{padding:12px 16px;margin-bottom:16px;border-radius:4px;font-weight:500}
#status-area:empty{display:none}
#status-area.info{background:#e8f0fe;border:1px solid #4a90d9;color:#1a3a5c}
#status-area.success{background:#e6f4ea;border:1px solid #34a853;color:#1e4620}
#status-area.error{background:#fce8e6;border:1px solid #ea4335;color:#5f1412}

/* Global search */
#global-search-area{margin-bottom:16px}
#global-search-area label{display:block;font-weight:600;margin-bottom:4px;font-size:0.95rem}
.search-row{display:flex;gap:8px}
.search-row input{flex:1;padding:10px 12px;border:1px solid #999;border-radius:4px;font-size:1rem}

/* Dataset tabs */
.tabs{display:flex;flex-wrap:wrap;gap:2px;margin-bottom:0;border-bottom:2px solid #ccc;background:#fff;padding:0 8px}
.tab-btn{padding:10px 16px;border:none;background:transparent;font-size:0.9rem;font-weight:500;cursor:pointer;color:#555;border-bottom:3px solid transparent;margin-bottom:-2px;white-space:nowrap}
.tab-btn:hover{color:#1a1a1a;background:#f0f0f0}
.tab-btn.active{color:#0056b3;border-bottom-color:#0056b3;font-weight:600}
.tab-btn .tab-count{font-size:0.8rem;color:#888;margin-left:4px}
.tab-btn.active .tab-count{color:#0056b3}

/* Tab content */
.tab-panel{display:none;background:#fff;border:1px solid #ccc;border-top:none;border-radius:0 0 6px 6px;padding:16px}
.tab-panel.active{display:block}

/* Filter row */
.filter-row{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;margin-bottom:12px}
.filter-field{min-width:180px;flex:1;max-width:300px}
.filter-field label{display:block;font-size:0.85rem;font-weight:500;margin-bottom:2px}
.filter-field input,.filter-field select{width:100%;padding:6px 8px;border:1px solid #999;border-radius:4px;font-size:0.9rem}

button{padding:8px 16px;border:2px solid #0056b3;background:#0056b3;color:#fff;border-radius:4px;font-size:0.9rem;font-weight:600;cursor:pointer;white-space:nowrap}
button:hover{background:#003d80;border-color:#003d80}
button.secondary{background:#fff;color:#0056b3}
button.secondary:hover{background:#e8f0fe}
button:disabled{opacity:.5;cursor:not-allowed}

/* Table */
.table-wrap{overflow-x:auto;margin-bottom:12px;border:1px solid #ddd;border-radius:4px}
table{width:100%;border-collapse:collapse;font-size:0.88rem}
thead{background:#f0f0f0}
th{text-align:left;padding:8px 10px;border-bottom:2px solid #999;font-weight:600;white-space:nowrap}
th a{color:inherit;text-decoration:none}th a:hover{text-decoration:underline}
th .si{margin-left:3px;font-size:.75em;color:#666}
td{padding:6px 10px;border-bottom:1px solid #e8e8e8;vertical-align:top;max-width:500px}
tr:hover{background:#f8f8f8}
tbody tr:last-child td{border-bottom:none}

.ref-link{cursor:pointer;text-decoration:underline;color:#0056b3}
.ref-link:hover{color:#003d80}

.sub-count{display:inline-block;background:#e8f0fe;color:#0056b3;padding:1px 8px;border-radius:10px;font-size:.82rem;font-weight:500}
.type-badge{display:inline-block;padding:1px 8px;border-radius:3px;font-size:.78rem;font-weight:500}
.type-badge.b-green{background:#e6f4ea;color:#1e4620}
.type-badge.b-red{background:#fce8e6;color:#5f1412}
.type-badge.b-blue{background:#e8f0fe;color:#0056b3}
.type-badge.b-gray{background:#f0f0f0;color:#555}

/* Pagination */
.pag{display:flex;flex-wrap:wrap;gap:6px;align-items:center;justify-content:space-between;margin-top:8px}
.pag-info{font-size:.88rem;color:#555}
.pag-controls{display:flex;gap:3px;align-items:center}
.pag-controls button{padding:5px 10px;font-size:.82rem;min-width:36px}
.pag-size{display:flex;gap:6px;align-items:center;font-size:.88rem}
.pag-size select{padding:4px 6px;border:1px solid #999;border-radius:4px;font-size:.88rem}

/* Detail */
#detail-overlay{display:none;background:#fff;border:1px solid #ccc;border-radius:6px;padding:24px 28px;margin-bottom:20px}
#detail-overlay.visible{display:block}
#detail-overlay h2{margin:0 0 4px;font-size:1.25rem}
#detail-overlay .back-link{display:inline-block;margin-bottom:12px}
.filter-bar{display:flex;flex-wrap:wrap;gap:8px;align-items:flex-end;margin-top:4px}
.filter-bar .filter-field{min-width:140px;flex:0 1 auto;max-width:220px}
.filter-bar .filter-field select{font-size:.84rem;padding:4px 6px}
.filter-bar .filter-field input[type="text"]{font-size:.84rem;padding:4px 6px;border:1px solid #999;border-radius:4px;width:100%}
dl.dl{margin:0}
dl.dl dt{font-weight:600;margin-top:14px;color:#444;font-size:.82rem;text-transform:uppercase;letter-spacing:.03em}
dl.dl dt:first-child{margin-top:0}
dl.dl dd{margin:3px 0 0;padding:0;word-break:break-word}
dl.dl dd.empty{color:#999;font-style:italic}

.sub-section{margin-top:20px;border-top:2px solid #e0e0e0;padding-top:14px}
.sub-section h3{margin:0 0 10px;font-size:1.05rem}

.related-section{margin-top:20px;border-top:1px dashed #ccc;padding-top:14px}
.related-section h3{margin:0 0 8px;font-size:1rem;color:#444}
.related-list{list-style:none;padding:0;margin:0}
.related-list li{padding:3px 0}

@media(max-width:700px){
main{padding:8px}
.tabs{overflow-x:auto;flex-wrap:nowrap}
.tab-btn{padding:8px 10px;font-size:.82rem}
th,td{padding:5px 6px;font-size:.82rem}
}

/* Column toggles */
.col-toggle{margin-bottom:8px}
.col-toggle summary{cursor:pointer;font-size:.84rem;color:#555;user-select:none;padding:4px 0}
.col-toggle summary:hover{color:#0056b3}
.col-toggle .col-checks{display:flex;flex-wrap:wrap;gap:2px 12px;padding:6px 0}
.col-toggle label{font-size:.82rem;display:flex;align-items:center;gap:4px;cursor:pointer;white-space:nowrap}
.col-toggle label input{margin:0}

/* Export */
.export-bar{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;align-items:center}
.export-bar button{font-size:.8rem;padding:4px 10px}
.export-bar .export-label{font-size:.82rem;color:#555}

/* Permalink */
.permalink{display:flex;align-items:center;gap:8px;margin-bottom:12px;font-size:.84rem}
.permalink a{color:#0056b3;word-break:break-all}
.permalink button{padding:4px 10px;font-size:.8rem;flex-shrink:0}

/* Pending detail */
.pending-detail{background:#e8f0fe;border:1px solid #90caf9;border-radius:6px;padding:12px 16px;margin-bottom:16px;font-size:.9rem;color:#1565c0}
</style>
</head>
<body>
<a href="#main-content" class="skip-link">P≈ôeskoƒçit na hlavn√≠ obsah</a>
<header>
<h1>Prohl√≠≈æeƒç RPP</h1>
<p>Registr pr√°v a povinnost√≠ ‚Äî prohl√≠≈æeƒç otev≈ôen√Ωch dat</p>
</header>
<main id="main-content">
<div id="loading-panel" role="status" aria-live="polite"></div>
<div id="status-area" role="status" aria-live="polite"></div>

<div id="global-search-area" style="display:none">
<label for="global-search">Hledat ve v≈°ech datov√Ωch sad√°ch</label>
<div class="search-row">
<input type="search" id="global-search" placeholder="Zadejte hledan√Ω text‚Ä¶">
</div>
</div>

<div id="tabs-area" style="display:none">
<div class="tabs" role="tablist" aria-label="Datov√© sady RPP" id="tab-buttons"></div>
<div id="tab-panels"></div>
</div>

<div id="pending-detail" class="pending-detail" style="display:none"></div>
<div id="detail-overlay" role="region" aria-label="Detail z√°znamu">
<a href="#" class="back-link" id="detail-back">‚Üê Zpƒõt na seznam</a>
<div id="detail-permalink" class="permalink" style="display:none"></div>
<h2 id="detail-title"></h2>
<div id="detail-body"></div>
</div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
(function(){
'use strict';

// ===== Dataset Configuration =====
const DS_CONFIG = [
    {key:'agendy', name:'Agendy', schema:'https://ofn.gov.cz/registr-pr%C3%A1v-a-povinnost%C3%AD/agendy/2024-10-03/agendy.schema.json', data:'https://rpp-opendata.egon.gov.cz/odrpp/datovasada/agendy.json',
     tableCols:['k√≥d','n√°zev','ohla≈°ovatel','platnost-od','definice-slu≈æeb','definice-√∫daj≈Ø'],
     idPrefix:'agenda/'},
    {key:'pusobnost', name:'P≈Øsobnost v agend√°ch', schema:'https://ofn.gov.cz/registr-pr%C3%A1v-a-povinnost%C3%AD/p%C5%AFsobnost-v-agend%C3%A1ch/2021-01-12/p%C5%AFsobnost-v-agend%C3%A1ch.schema.json', data:'https://rpp-opendata.egon.gov.cz/odrpp/datovasada/pusobnost_v_agendach.json',
     tableCols:['registrace','v√Ωkon-ƒçinnost√≠','slu≈æby'],
     idPrefix:'p≈Øsobnost/', manualOnly:true},
    {key:'ovm', name:'Org√°ny ve≈ôejn√© moci', schema:'https://ofn.gov.cz/registr-pr%C3%A1v-a-povinnost%C3%AD/org%C3%A1ny-ve%C5%99ejn%C3%A9-moci/2025-02-07/org%C3%A1ny-ve%C5%99ejn%C3%A9-moci-schema.json', data:'https://rpp-opendata.egon.gov.cz/odrpp/datovasada/ovm.json',
     tableCols:['identifik√°tor','n√°zev','iƒço','vnit≈ôn√≠-organizaƒçn√≠-jednotka','stav','pracovi≈°tƒõ-ovm'],
     idPrefix:'org√°n-ve≈ôejn√©-moci/'},
    {key:'isvs', name:'ISVS', schema:null, data:'https://rpp-opendata.egon.gov.cz/odrpp/datovasada/isvs.json',
     tableCols:['identifik√°tor','n√°zev','agendy','spr√°va-isvs','aktu√°ln√≠-typ-etapy','vytvo≈ôen√≠'],
     idPrefix:'isvs/'},
    {key:'sluzby', name:'Slu≈æby VS', schema:'https://ofn.gov.cz/registr-pr%C3%A1v-a-povinnost%C3%AD/slu%C5%BEby/2024-10-03/slu%C5%BEby.schema.json', data:'https://rpp-opendata.egon.gov.cz/odrpp/datovasada/sluzby.json',
     tableCols:['identifik√°tor','n√°zev','agenda','typ-slu≈æby','klienti'],
     idPrefix:'slu≈æba/'},
    {key:'udaje', name:'√ödaje', schema:'https://ofn.gov.cz/registr-pr%C3%A1v-a-povinnost%C3%AD/%C3%BAdaje/2021-01-12/%C3%BAdaje.schema.json', data:'https://rpp-opendata.egon.gov.cz/odrpp/datovasada/udaje.json',
     tableCols:['k√≥d','n√°zev','popis','agenda','√∫daje'],
     idPrefix:'objekt-subjekt/'},
    {key:'opravneni', name:'Opr√°vnƒõn√≠ k √∫daj≈Øm', schema:'https://ofn.gov.cz/registr-pr%C3%A1v-a-povinnost%C3%AD/opr%C3%A1vn%C4%9Bn%C3%AD-k-p%C5%99%C3%ADstupu-k-%C3%BAdaj%C5%AFm/2024-10-03/opr%C3%A1vn%C4%9Bn%C3%AD-k-p%C5%99%C3%ADstupu-k-%C3%BAdaj%C5%AFm.schema.json', data:'https://rpp-opendata.egon.gov.cz/odrpp/datovasada/opravneni_k_udajum.json',
     tableCols:['k√≥d','z-agendy','do-agendy','typ-opr√°vnƒõn√≠','realizov√°no-na-referenƒçn√≠m-rozhran√≠','√∫daje'],
     idPrefix:'opr√°vnƒõn√≠-k-p≈ô√≠stupu-k-√∫daj≈Øm/'},
    {key:'role', name:'Role', schema:'https://ofn.gov.cz/registr-pr%C3%A1v-a-povinnost%C3%AD/role/2021-01-12/role.schema.json', data:'https://rpp-opendata.egon.gov.cz/odrpp/datovasada/role.json',
     tableCols:['ovm','kategorie-ovm','ƒçinnost','spu√∫','kategorie-spu√∫'],
     idPrefix:'role/', large:true, timeoutMs:15000},
    {key:'spuu', name:'SPU√ö', schema:'https://ofn.gov.cz/registr-pr%C3%A1v-a-povinnost%C3%AD/soukromopr%C3%A1vn%C3%AD-u%C5%BEivatel%C3%A9-%C3%BAdaj%C5%AF/2025-02-07/soukromopr%C3%A1vn%C3%AD-u%C5%BEivatel%C3%A9-%C3%BAdaj%C5%AF-schema.json', data:'https://rpp-opendata.egon.gov.cz/odrpp/datovasada/spuu.json',
     tableCols:['identifik√°tor','n√°zev','iƒço','stav'],
     idPrefix:'soukromopr√°vn√≠-u≈æivatel-√∫daj≈Ø/'}
];

// ===== State =====
const datasets = {}; // key ‚Üí {config, records:[], schema:null, loaded:false}
const globalIndex = new Map(); // id ‚Üí {dsKey, idx, title}
const reverseIndex = new Map(); // refId ‚Üí [{dsKey, idx, title}]
const bareIndex = new Map(); // bare value (IƒåO, k√≥d) ‚Üí full ref ID
let activeTab = null;
const tabStates = {}; // key ‚Üí {page, sort, search, filters}

// ===== DOM =====
const $=id=>document.getElementById(id);
const elLoading=$('loading-panel'), elStatus=$('status-area');
const elGlobalSearch=$('global-search-area'), elGlobalInput=$('global-search');
const elTabsArea=$('tabs-area'), elTabButtons=$('tab-buttons'), elTabPanels=$('tab-panels');
const elDetail=$('detail-overlay'), elDetailBack=$('detail-back'), elDetailTitle=$('detail-title'), elDetailBody=$('detail-body');
const elDetailPermalink=$('detail-permalink'), elPendingDetail=$('pending-detail');

// ===== Helpers =====
function cs(val){
    if(val==null)return null;
    if(typeof val==='object'&&!Array.isArray(val)&&'cs' in val)return val.cs;
    return val;
}
function humanize(k){return k.replace(/([A-Z])/g,' $1').replace(/[-_]/g,' ').replace(/^\w/,c=>c.toUpperCase()).trim()}
function fmtDate(v){try{const d=new Date(v);return isNaN(d)?String(v):d.toLocaleDateString('cs')}catch(e){return String(v)}}
function shortenUrl(u){try{const x=new URL(u);return x.hostname+x.pathname.substring(0,40)}catch(e){return u.substring(0,60)}}

function codedLabel(val){
    if(typeof val!=='string')return null;
    const i=val.lastIndexOf('/');
    if(i<1||i>=val.length-1)return null;
    const code=val.substring(i+1);
    if(!/^[A-Z0-9_]+$/.test(code))return null;
    const labels={'VLASTNI':'Vlastn√≠','REFERENCNI':'Referenƒçn√≠','NESDILENY':'Nesd√≠len√Ω','SDILENY':'Sd√≠len√Ω',
        'NEMA_NOTIFIKACI':'Nem√° notifikaci','MA_NOTIFIKACI':'M√° notifikaci','KLIENT':'Klient','MOCI_UREDNI':'Z moci √∫≈ôedn√≠',
        'ON_PREMISE':'On-premise','CLOUD':'Cloud','CENTRALNI':'Centr√°ln√≠','DECENTRAL':'Decentr√°ln√≠',
        'ZO':'Z√°kladn√≠ opr√°vnƒõn√≠','RO':'Roz≈°√≠≈ôen√© opr√°vnƒõn√≠','FO':'Fyzick√° osoba','PO':'Pr√°vnick√° osoba','PFO':'Podnikaj√≠c√≠ FO',
        'ROZVOJ':'Rozvoj','PROVOZ':'Provoz','VYVOJ':'V√Ωvoj','UKONCEN':'Ukonƒçen'};
    const cls={'VLASTNI':'b-gray','REFERENCNI':'b-blue','KLIENT':'b-green','MOCI_UREDNI':'b-red','ROZVOJ':'b-green','PROVOZ':'b-blue','UKONCEN':'b-red'};
    return{label:labels[code]||code.replace(/_/g,' '),badgeClass:cls[code]||'b-gray'};
}

function valToString(val){
    if(val==null||val==='')return'';
    val=cs(val);if(val==null)return'';
    if(typeof val==='object'){
        if(Array.isArray(val))return val.map(valToString).join(', ');
        return val.oznaƒçen√≠||val.n√°zev?.cs||val.name||val.label||Object.values(val).filter(v=>typeof v==='string').join(', ')||'';
    }
    return String(val);
}

function isRefId(val){
    if(typeof val!=='string')return false;
    return/^[a-z√°ƒçƒè√©ƒõ√≠≈à√≥≈ô≈°≈•√∫≈Ø√Ω≈æ-]+\/[A-Za-z0-9./-]+$/i.test(val)&&val.includes('/');
}

function resolveRef(id){
    const direct=globalIndex.get(id);
    if(direct)return direct;
    // Try resolving via bareIndex (IƒåO, k√≥d‚Ä¶)
    const resolved=bareIndex.get(id);
    if(resolved)return globalIndex.get(resolved)||null;
    return null;
}

// ===== Fetch =====
async function fetchJSON(url,timeoutMs=20000){
    const ctrl=new AbortController();
    const timer=setTimeout(()=>ctrl.abort(),timeoutMs);
    try{
        const r=await fetch(url,{signal:ctrl.signal});
        clearTimeout(timer);
        if(r.ok)return await r.json();
        throw new Error('HTTP '+r.status);
    }catch(e){
        clearTimeout(timer);
        if(e.name==='AbortError')throw new Error('Timeout (soubor je p≈ô√≠li≈° velk√Ω nebo server neodpov√≠d√°)');
        for(const p of['https://corsproxy.io/?','https://api.allorigins.win/raw?url=']){
            const proxyTimeout=Math.min(timeoutMs,10000);
            const ctrl2=new AbortController();
            const timer2=setTimeout(()=>ctrl2.abort(),proxyTimeout);
            try{const r=await fetch(p+encodeURIComponent(url),{signal:ctrl2.signal});clearTimeout(timer2);if(r.ok)return await r.json()}catch(e2){clearTimeout(timer2);if(e2.name==='AbortError')throw new Error('Timeout p≈ôes proxy (soubor je p≈ô√≠li≈° velk√Ω)')}
        }
        throw new Error('Nepoda≈ôilo se naƒç√≠st');
    }
}

// ===== Manual file load fallback =====
function showManualFallback(cfg,el,icon){
    const fb=document.createElement('div');fb.className='load-fallback';
    const p1=document.createElement('span');
    const dl=document.createElement('a');dl.href=cfg.data;dl.textContent='1. Prav√Ω klik zde ‚Üí Ulo≈æit odkaz jako‚Ä¶';
    dl.title='Prav√Ω klik ‚Üí Ulo≈æit odkaz jako‚Ä¶';
    p1.appendChild(dl);
    p1.appendChild(document.createTextNode(', pak '));
    fb.appendChild(p1);

    const lbl=document.createElement('label');
    lbl.textContent='2. vyberte ulo≈æen√Ω soubor: ';
    const inp=document.createElement('input');inp.type='file';inp.accept='.json,.jsonld';
    lbl.appendChild(inp);
    fb.appendChild(lbl);

    const btnRow=document.createElement('div');btnRow.style.cssText='margin-top:8px;display:flex;gap:8px;align-items:center';
    const btnLoad=document.createElement('button');btnLoad.textContent='3. Naƒç√≠st a zpracovat';btnLoad.disabled=true;
    const progress=document.createElement('span');progress.style.cssText='font-size:0.85rem;color:#555';

    inp.addEventListener('change',()=>{
        btnLoad.disabled=!inp.files||!inp.files[0];
        if(inp.files&&inp.files[0])progress.textContent='('+Math.round(inp.files[0].size/1024/1024)+' MB)';
    });

    btnLoad.addEventListener('click',async()=>{
        if(!inp.files||!inp.files[0])return;
        const file=inp.files[0];
        const totalMB=(file.size/1024/1024).toFixed(0);
        btnLoad.disabled=true;
        icon.textContent='‚è≥';icon.className='load-icon load-wait';

        try{
            const records=await streamParseJSON(file,(readBytes,recCount)=>{
                const pct=Math.round(readBytes/file.size*100);
                const readMB=(readBytes/1024/1024).toFixed(0);
                progress.textContent=readMB+' / '+totalMB+' MB ('+pct+'%), '+recCount.toLocaleString('cs')+' z√°znam≈Ø';
                el.querySelector('span:last-child').textContent=cfg.name+' ‚Äî '+pct+'%';
            });
            datasets[cfg.key].records=records;
            datasets[cfg.key].loaded=true;
            icon.textContent='‚úì';icon.className='load-icon load-ok';
            el.querySelector('span:last-child').textContent=cfg.name+' ('+records.length.toLocaleString('cs')+') ‚Äî budov√°n√≠ indexu vazeb‚Ä¶';
            progress.textContent='Budov√°n√≠ indexu vazeb‚Ä¶';
            // Yield to UI before heavy index build
            await new Promise(r=>setTimeout(r,50));
            buildIndex();
            fb.remove();
            refreshAfterManualLoad(cfg.key);
        }catch(err){
            icon.textContent='‚úó';icon.className='load-icon load-err';
            el.querySelector('span:last-child').textContent=cfg.name+' ‚Äî chyba';
            progress.textContent=err.message;
            btnLoad.disabled=false;btnLoad.textContent='3. Naƒç√≠st a zpracovat';
        }
    });
    btnRow.appendChild(btnLoad);

    const btnSkip=document.createElement('button');btnSkip.textContent='P≈ôeskoƒçit';btnSkip.className='secondary';
    btnSkip.addEventListener('click',()=>{
        el.style.display='none';
        const visible=[...elLoading.querySelectorAll('.load-item')].filter(x=>x.style.display!=='none');
        if(visible.length===0)elLoading.style.display='none';
    });
    btnRow.appendChild(btnSkip);
    btnRow.appendChild(progress);
    fb.appendChild(btnRow);
    el.appendChild(fb);
}

// Streaming JSON parser ‚Äî reads file in small chunks, never loads entire file into memory.
// Tracks brace depth to find individual records, parses each one separately.
// Handles 620MB+ files that would crash FileReader.readAsText().
async function streamParseJSON(file,onProgress){
    const CHUNK=5*1024*1024; // 5 MB
    const records=[];
    let phase='header'; // header ‚Üí records ‚Üí done
    let depth=0;
    let inStr=false;
    let esc=false;
    let recBuf='';
    let recStarted=false;
    let totalRead=0;

    for(let offset=0;offset<file.size;offset+=CHUNK){
        const end=Math.min(offset+CHUNK,file.size);
        const chunk=await file.slice(offset,end).text();
        totalRead+=chunk.length;

        for(let i=0;i<chunk.length;i++){
            const ch=chunk[i];

            // Accumulate into record buffer
            if(recStarted)recBuf+=ch;

            // Inside a JSON string ‚Äî only watch for end-quote and escapes
            if(inStr){
                if(esc){esc=false;continue}
                if(ch==='\\'){esc=true;continue}
                if(ch==='"')inStr=false;
                continue;
            }
            if(ch==='"'){inStr=true;continue}

            // Outside strings ‚Äî track structure
            if(phase==='header'){
                if(ch==='['){phase='records';depth=0}
                continue;
            }
            if(phase==='done')break;

            if(ch==='{'){
                depth++;
                if(depth===1&&!recStarted){recStarted=true;recBuf='{'}
            }else if(ch==='}'){
                depth--;
                if(depth===0&&recStarted){
                    try{records.push(JSON.parse(recBuf))}catch(e){/* skip bad record */}
                    recBuf='';recStarted=false;
                }
            }else if(ch===']'&&depth===0&&!recStarted){
                phase='done';
            }
        }

        onProgress(totalRead,records.length);
        await new Promise(r=>setTimeout(r,0)); // yield to UI
    }
    return records;
}

// ===== Loading =====
async function loadAll(){
    elLoading.innerHTML='<h2>Naƒç√≠t√°n√≠ datov√Ωch sad RPP‚Ä¶</h2>';
    const items=[];
    DS_CONFIG.forEach(cfg=>{
        datasets[cfg.key]={config:cfg,records:[],schema:null,loaded:false};
        const div=document.createElement('div');div.className='load-item';div.id='load-'+cfg.key;
        div.innerHTML=`<span class="load-icon load-wait">‚è≥</span><span>${cfg.name}${cfg.manualOnly?' (ruƒçn√≠ naƒçten√≠)':cfg.large?' (velk√° sada)':''}</span>`;
        items.push(div);
        elLoading.appendChild(div);
    });
    const prog=document.createElement('div');prog.id='loading-progress';prog.textContent='0 / '+DS_CONFIG.length;
    elLoading.appendChild(prog);

    let done=0;
    const promises=DS_CONFIG.map(async cfg=>{
        const el=document.getElementById('load-'+cfg.key);
        const icon=el.querySelector('.load-icon');

        // Manual-only datasets: skip automatic fetch, show file input right away
        if(cfg.manualOnly){
            icon.textContent='üìÅ';icon.className='load-icon';
            el.querySelector('span:last-child').textContent=cfg.name+' ‚Äî vy≈æaduje ruƒçn√≠ naƒçten√≠';
            // Load schema if available
            if(cfg.schema){try{datasets[cfg.key].schema=await fetchJSON(cfg.schema)}catch(e){}}
            showManualFallback(cfg,el,icon);
            done++;prog.textContent=done+' / '+DS_CONFIG.length;
            return;
        }

        try{
            const timeout=cfg.timeoutMs||20000;
            // Load schema if exists
            if(cfg.schema){
                datasets[cfg.key].schema=await fetchJSON(cfg.schema,timeout);
            }
            // Load data
            const raw=await fetchJSON(cfg.data,timeout);
            let records=[];
            if(Array.isArray(raw))records=raw;
            else if(raw.polo≈æky)records=raw.polo≈æky;
            else{
                const ak=Object.keys(raw).find(k=>Array.isArray(raw[k]));
                if(ak)records=raw[ak];
            }
            datasets[cfg.key].records=records;
            datasets[cfg.key].loaded=true;
            icon.textContent='‚úì';icon.className='load-icon load-ok';
            el.querySelector('span:last-child').textContent=cfg.name+' ('+records.length+')';
        }catch(e){
            icon.textContent='‚úó';icon.className='load-icon load-err';
            el.querySelector('span:last-child').textContent=cfg.name+' ‚Äî '+e.message;
            showManualFallback(cfg,el,icon);
        }
        done++;
        prog.textContent=done+' / '+DS_CONFIG.length;
    });

    await Promise.all(promises);
    buildIndex();

    // Count loaded
    const loadedCount=Object.values(datasets).filter(d=>d.loaded).length;
    const totalRecords=Object.values(datasets).reduce((s,d)=>s+d.records.length,0);
    prog.textContent=`Hotovo: ${loadedCount} datov√Ωch sad, ${totalRecords.toLocaleString('cs')} z√°znam≈Ø celkem`;

    // Build UI
    setTimeout(()=>{
        // Hide loading panel only if all loaded, otherwise keep it for manual fallbacks
        const allLoaded=Object.values(datasets).every(d=>d.loaded);
        if(allLoaded)elLoading.style.display='none';
        else{
            // Collapse the successfully loaded items, keep errors visible
            elLoading.querySelectorAll('.load-item').forEach(el=>{
                if(el.querySelector('.load-ok'))el.style.display='none';
            });
        }
        elGlobalSearch.style.display='block';
        elTabsArea.style.display='block';
        buildTabs();
        // Activate first loaded tab
        const firstLoaded=DS_CONFIG.find(c=>datasets[c.key].loaded);
        if(firstLoaded)activateTab(firstLoaded.key);

        // Handle URL params
        handleUrlParams();
    },300);
}

function buildIndex(){
    globalIndex.clear();
    reverseIndex.clear();
    bareIndex.clear();

    // First pass: build globalIndex and bareIndex
    for(const[key,ds]of Object.entries(datasets)){
        if(!ds.loaded)continue;
        ds.records.forEach((rec,idx)=>{
            const id=rec.id;
            const title=cs(rec.n√°zev)||cs(rec['n√°zev-√∫daje'])||rec.k√≥d||rec.identifik√°tor||id||'';
            if(id){
                globalIndex.set(id,{dsKey:key,idx,title:String(title)});
                // Build bareIndex: map short identifiers to full ref IDs
                // OVM: IƒåO ‚Üí org√°n-ve≈ôejn√©-moci/IƒåO
                if(id.startsWith('org√°n-ve≈ôejn√©-moci/')&&rec.iƒço){
                    bareIndex.set(String(rec.iƒço),id);
                }
                // Agendy: k√≥d (A101) ‚Üí agenda/A101
                if(id.startsWith('agenda/')&&rec.k√≥d){
                    bareIndex.set(String(rec.k√≥d),id);
                }
                // ISVS: identifik√°tor ‚Üí isvs/identifik√°tor
                if(id.startsWith('isvs/')&&rec.identifik√°tor){
                    bareIndex.set(String(rec.identifik√°tor),id);
                }
            }
            // Index sub-items
            if(rec.ƒçinnosti&&Array.isArray(rec.ƒçinnosti)){
                rec.ƒçinnosti.forEach(cin=>{
                    if(cin.id)globalIndex.set(cin.id,{dsKey:key,idx,title:cs(cin['n√°zev-ƒçinnosti'])||cin['k√≥d-ƒçinnosti']||cin.id});
                });
            }
            if(rec.√∫daje&&Array.isArray(rec.√∫daje)){
                rec.√∫daje.forEach(u=>{
                    if(u.id)globalIndex.set(u.id,{dsKey:key,idx,title:cs(u['n√°zev-√∫daje'])||u['k√≥d-√∫daje']||u.id});
                });
            }
        });
    }

    // Second pass: build reverseIndex (needs bareIndex to be complete)
    for(const[key,ds]of Object.entries(datasets)){
        if(!ds.loaded)continue;
        ds.records.forEach((rec,idx)=>{
            const id=rec.id;
            const title=cs(rec.n√°zev)||cs(rec['n√°zev-√∫daje'])||rec.k√≥d||rec.identifik√°tor||id||'';
            const refs=extractRefs(rec);
            const entry={dsKey:key,idx,title:String(title)};
            for(const ref of refs){
                if(ref===id)continue;
                let list=reverseIndex.get(ref);
                if(!list){list=[];reverseIndex.set(ref,list)}
                list.push(entry);
            }
        });
    }
}

// Extract all strings that look like entity references from an object (shallow-ish scan)
function extractRefs(obj){
    const refs=new Set();
    _scanRefs(obj,refs,3);
    return refs;
}
function _scanRefs(val,refs,depth){
    if(depth<=0||val==null)return;
    if(typeof val==='string'){
        if(isRefId(val)){refs.add(val);return}
        // Check if bare value resolves to a known entity (IƒåO, k√≥d agendy‚Ä¶)
        const resolved=bareIndex.get(val);
        if(resolved)refs.add(resolved);
        return;
    }
    if(Array.isArray(val)){
        for(const item of val)_scanRefs(item,refs,depth-1);
        return;
    }
    if(typeof val==='object'){
        for(const v of Object.values(val))_scanRefs(v,refs,depth-1);
    }
}

function refreshAfterManualLoad(key){
    // Update progress
    const loadedCount=Object.values(datasets).filter(d=>d.loaded).length;
    const totalRecords=Object.values(datasets).reduce((s,d)=>s+d.records.length,0);
    const prog=document.getElementById('loading-progress');
    if(prog)prog.textContent=`Hotovo: ${loadedCount} datov√Ωch sad, ${totalRecords.toLocaleString('cs')} z√°znam≈Ø celkem`;

    // Add tab if not yet present, or refresh
    const existingBtn=document.getElementById('tab-'+key);
    if(!existingBtn){
        const cfg=datasets[key].config;
        const ds=datasets[key];
        const btn=document.createElement('button');
        btn.className='tab-btn';btn.role='tab';btn.id='tab-'+key;
        btn.setAttribute('aria-controls','panel-'+key);
        btn.innerHTML=cfg.name+`<span class="tab-count">${ds.records.length.toLocaleString('cs')}</span>`;
        btn.addEventListener('click',()=>activateTab(key));
        const panel=document.createElement('div');
        panel.className='tab-panel';panel.role='tabpanel';panel.id='panel-'+key;
        panel.setAttribute('aria-labelledby','tab-'+key);

        // Insert at correct position per DS_CONFIG order
        const cfgIdx=DS_CONFIG.findIndex(c=>c.key===key);
        let insertBefore=null;
        for(let i=cfgIdx+1;i<DS_CONFIG.length;i++){
            const nextBtn=document.getElementById('tab-'+DS_CONFIG[i].key);
            if(nextBtn){insertBefore=DS_CONFIG[i].key;break}
        }
        if(insertBefore){
            elTabButtons.insertBefore(btn,document.getElementById('tab-'+insertBefore));
            elTabPanels.insertBefore(panel,document.getElementById('panel-'+insertBefore));
        }else{
            elTabButtons.appendChild(btn);
            elTabPanels.appendChild(panel);
        }
        tabStates[key]={page:1,pageSize:25,sortKey:null,sortAsc:true,search:'',filtered:null};
    }else{
        existingBtn.innerHTML=datasets[key].config.name+`<span class="tab-count">${datasets[key].records.length.toLocaleString('cs')}</span>`;
    }
    // Don't switch away from current tab ‚Äî just refresh current if it's the loaded one
    if(activeTab===key){
        renderDatasetPanel(key);
    }
    // Check if pending URL param can now be resolved
    if(typeof handleUrlParams==='function')handleUrlParams();
    // Hide loading panel if everything is loaded now
    const allLoaded=Object.values(datasets).every(d=>d.loaded);
    if(allLoaded)elLoading.style.display='none';
}

// ===== Tabs =====
function buildTabs(){
    elTabButtons.innerHTML='';
    elTabPanels.innerHTML='';
    DS_CONFIG.forEach(cfg=>{
        const ds=datasets[cfg.key];
        if(!ds.loaded)return;
        // Tab button
        const btn=document.createElement('button');
        btn.className='tab-btn';btn.role='tab';btn.id='tab-'+cfg.key;
        btn.setAttribute('aria-controls','panel-'+cfg.key);
        btn.innerHTML=cfg.name+`<span class="tab-count">${ds.records.length.toLocaleString('cs')}</span>`;
        btn.addEventListener('click',()=>activateTab(cfg.key));
        elTabButtons.appendChild(btn);

        // Panel
        const panel=document.createElement('div');
        panel.className='tab-panel';panel.role='tabpanel';panel.id='panel-'+cfg.key;
        panel.setAttribute('aria-labelledby','tab-'+cfg.key);
        elTabPanels.appendChild(panel);

        tabStates[cfg.key]={page:1,pageSize:25,sortKey:null,sortAsc:true,search:'',filtered:null};
    });
}

function activateTab(key){
    if(activeTab===key)return;
    activeTab=key;
    document.querySelectorAll('.tab-btn').forEach(b=>{b.classList.toggle('active',b.id==='tab-'+key);b.setAttribute('aria-selected',b.id==='tab-'+key)});
    document.querySelectorAll('.tab-panel').forEach(p=>{p.classList.toggle('active',p.id==='panel-'+key)});
    hideDetail();
    renderDatasetPanel(key);
}

// ===== Dataset Panel =====
function renderDatasetPanel(key){
    const ds=datasets[key];
    const panel=document.getElementById('panel-'+key);
    if(!panel||!ds)return;
    panel.innerHTML='';

    const state=tabStates[key];
    if(!state.filters)state.filters={};

    // Determine columns
    const cols=getColumns(ds);

    // Search bar
    const filterDiv=document.createElement('div');filterDiv.className='filter-row';
    const sf=document.createElement('div');sf.className='filter-field';sf.style.minWidth='300px';sf.style.flex='2';
    const sLabel=document.createElement('label');sLabel.setAttribute('for','ds-search-'+key);sLabel.textContent='Hledat v sadƒõ '+ds.config.name;
    const sInput=document.createElement('input');sInput.type='search';sInput.id='ds-search-'+key;sInput.placeholder='Hledan√Ω text‚Ä¶';sInput.value=state.search;
    let sT;sInput.addEventListener('input',()=>{clearTimeout(sT);sT=setTimeout(()=>{state.search=sInput.value;state.page=1;state.filtered=null;renderTable(key)},300)});
    sf.appendChild(sLabel);sf.appendChild(sInput);filterDiv.appendChild(sf);
    panel.appendChild(filterDiv);

    // Detect filterable columns and build filter dropdowns
    const filterableCols=detectFilterableCols(ds,cols);
    const refFilters=detectRefFilters(ds);
    if(filterableCols.length>0||refFilters.length>0){
        const fbar=document.createElement('div');fbar.className='filter-bar';

        // Ref-type filters (Agenda, OVM) ‚Äî autocomplete text inputs
        refFilters.forEach(rf=>{
            const ff=document.createElement('div');ff.className='filter-field';ff.style.minWidth='220px';ff.style.maxWidth='320px';
            const lbl=document.createElement('label');lbl.textContent=rf.title;lbl.setAttribute('for','rflt-'+key+'-'+rf.refKey);
            const inp=document.createElement('input');inp.type='text';inp.id='rflt-'+key+'-'+rf.refKey;
            inp.placeholder='Zaƒçnƒõte ps√°t‚Ä¶';inp.setAttribute('autocomplete','off');
            const dlId='dl-'+key+'-'+rf.refKey;
            const dl=document.createElement('datalist');dl.id=dlId;
            inp.setAttribute('list',dlId);
            // Restore current value
            const curVal=state.filters['__ref:'+rf.prefix];
            if(curVal){
                const ref=globalIndex.get(curVal);
                inp.value=ref?ref.title+' ['+curVal.split('/').pop()+']':curVal;
            }
            let rT;
            inp.addEventListener('input',()=>{
                clearTimeout(rT);rT=setTimeout(()=>{
                    const q=inp.value.trim().toLowerCase();
                    // Populate datalist with matching entries
                    dl.innerHTML='';
                    if(q.length>=1){
                        let count=0;
                        for(const[id,entry]of globalIndex){
                            if(!id.startsWith(rf.prefix))continue;
                            const label=entry.title+' ['+id.split('/').pop()+']';
                            if(label.toLowerCase().includes(q)||id.toLowerCase().includes(q)){
                                const opt=document.createElement('option');opt.value=label;opt.dataset.refId=id;
                                dl.appendChild(opt);
                                if(++count>=30)break;
                            }
                        }
                    }
                    // Check if input matches a known ref
                    const match=findRefMatch(inp.value,rf.prefix);
                    if(match){
                        state.filters['__ref:'+rf.prefix]=match;
                        state.page=1;state.filtered=null;renderTable(key);
                    }else if(!q){
                        delete state.filters['__ref:'+rf.prefix];
                        state.page=1;state.filtered=null;renderTable(key);
                    }
                },250);
            });
            inp.addEventListener('change',()=>{
                const q=inp.value.trim();
                if(!q){delete state.filters['__ref:'+rf.prefix];state.page=1;state.filtered=null;renderTable(key);return}
                const match=findRefMatch(q,rf.prefix);
                if(match){state.filters['__ref:'+rf.prefix]=match;state.page=1;state.filtered=null;renderTable(key)}
            });
            ff.appendChild(lbl);ff.appendChild(inp);ff.appendChild(dl);fbar.appendChild(ff);
        });

        // Dropdown filters for low-cardinality columns
        filterableCols.forEach(fc=>{
            const ff=document.createElement('div');ff.className='filter-field';
            const lbl=document.createElement('label');lbl.textContent=fc.title;lbl.setAttribute('for','flt-'+key+'-'+fc.key);
            const sel=document.createElement('select');sel.id='flt-'+key+'-'+fc.key;
            const optAll=document.createElement('option');optAll.value='';optAll.textContent='‚Äî v≈°e ‚Äî';sel.appendChild(optAll);
            fc.values.forEach(v=>{
                const opt=document.createElement('option');opt.value=v.raw;opt.textContent=v.label+(v.count?' ('+v.count.toLocaleString('cs')+')':'');
                if(state.filters[fc.key]===v.raw)opt.selected=true;
                sel.appendChild(opt);
            });
            sel.addEventListener('change',()=>{
                if(sel.value)state.filters[fc.key]=sel.value;else delete state.filters[fc.key];
                state.page=1;state.filtered=null;renderTable(key);
            });
            ff.appendChild(lbl);ff.appendChild(sel);fbar.appendChild(ff);
        });

        const btnClear=document.createElement('button');btnClear.textContent='Zru≈°it filtry';btnClear.className='secondary';
        btnClear.style.cssText='align-self:flex-end;font-size:.82rem;padding:5px 10px';
        btnClear.addEventListener('click',()=>{
            state.filters={};state.page=1;state.filtered=null;
            fbar.querySelectorAll('select').forEach(s=>s.value='');
            fbar.querySelectorAll('input[type="text"]').forEach(i=>i.value='');
            renderTable(key);
        });
        fbar.appendChild(btnClear);
        panel.appendChild(fbar);
    }

    // Column visibility toggle
    if(!state.visibleCols)state.visibleCols=new Set(cols.map(c=>c.key));
    // Ensure any new cols get added if data changed
    cols.forEach(c=>{if(!state._allColsInit){state.visibleCols.add(c.key)}});
    state._allColsInit=true;

    const colToggle=document.createElement('details');colToggle.className='col-toggle';
    const colSum=document.createElement('summary');colSum.textContent='Zobrazen√© sloupce ('+state.visibleCols.size+'/'+cols.length+')';
    colToggle.appendChild(colSum);
    const colChecks=document.createElement('div');colChecks.className='col-checks';
    const colAllBtn=document.createElement('button');colAllBtn.textContent='V≈°e';colAllBtn.className='secondary';colAllBtn.style.cssText='font-size:.78rem;padding:2px 8px;margin-right:8px';
    colAllBtn.addEventListener('click',()=>{cols.forEach(c=>state.visibleCols.add(c.key));colChecks.querySelectorAll('input').forEach(i=>i.checked=true);colSum.textContent='Zobrazen√© sloupce ('+state.visibleCols.size+'/'+cols.length+')';renderTableHead(key,cols);renderTable(key)});
    colChecks.appendChild(colAllBtn);
    const colNoneBtn=document.createElement('button');colNoneBtn.textContent='Nic';colNoneBtn.className='secondary';colNoneBtn.style.cssText='font-size:.78rem;padding:2px 8px;margin-right:12px';
    colNoneBtn.addEventListener('click',()=>{state.visibleCols.clear();colChecks.querySelectorAll('input').forEach(i=>i.checked=false);colSum.textContent='Zobrazen√© sloupce (0/'+cols.length+')';renderTableHead(key,cols);renderTable(key)});
    colChecks.appendChild(colNoneBtn);
    cols.forEach(col=>{
        const lbl=document.createElement('label');
        const cb=document.createElement('input');cb.type='checkbox';cb.checked=state.visibleCols.has(col.key);
        cb.addEventListener('change',()=>{
            if(cb.checked)state.visibleCols.add(col.key);else state.visibleCols.delete(col.key);
            colSum.textContent='Zobrazen√© sloupce ('+state.visibleCols.size+'/'+cols.length+')';
            renderTableHead(key,cols);renderTable(key);
        });
        lbl.appendChild(cb);lbl.appendChild(document.createTextNode(' '+col.title));
        colChecks.appendChild(lbl);
    });
    colToggle.appendChild(colChecks);
    panel.appendChild(colToggle);

    // Export bar
    const ebar=document.createElement('div');ebar.className='export-bar';
    const elbl=document.createElement('span');elbl.className='export-label';elbl.textContent='Export:';ebar.appendChild(elbl);
    ['CSV','TSV','XLSX'].forEach(fmt=>{
        const btn=document.createElement('button');btn.className='secondary';btn.textContent=fmt;
        btn.addEventListener('click',()=>exportData(key,fmt.toLowerCase()));
        ebar.appendChild(btn);
    });
    panel.appendChild(ebar);

    // Table wrapper
    const tw=document.createElement('div');tw.className='table-wrap';tw.id='tw-'+key;
    const table=document.createElement('table');table.id='tbl-'+key;
    const thead=document.createElement('thead');thead.id='thead-'+key;
    const tbody=document.createElement('tbody');tbody.id='tbody-'+key;
    table.appendChild(thead);table.appendChild(tbody);tw.appendChild(table);panel.appendChild(tw);

    // Pagination
    const pag=document.createElement('div');pag.className='pag';pag.id='pag-'+key;
    panel.appendChild(pag);

    // Render
    renderTableHead(key,cols);
    renderTable(key);
}

// Detect columns suitable for dropdown filters:
// string/ref columns with ‚â§ 40 distinct values, sampled across all records (up to 2000)
function detectFilterableCols(ds,cols){
    const result=[];
    const sampleSize=Math.min(ds.records.length,2000);
    cols.forEach(col=>{
        if(col.type==='subarray'||col.type==='object')return; // skip complex types
        const counts=new Map();
        let nullCount=0;
        for(let i=0;i<sampleSize;i++){
            const raw=ds.records[i][col.key];
            let val=cs(raw);
            if(val==null||val===''){nullCount++;continue}
            if(typeof val==='boolean')val=val?'ano':'ne';
            else val=String(val);
            counts.set(val,(counts.get(val)||0)+1);
            if(counts.size>40)break; // too many distinct values
        }
        if(counts.size>=2&&counts.size<=40){
            // Scale counts if sampled
            const scale=ds.records.length/sampleSize;
            const values=[...counts.entries()]
                .sort((a,b)=>b[1]-a[1])
                .map(([v,c])=>{
                    // Try to find a human-readable label for coded values
                    let label=v;
                    if(v.includes('/')&&isRefId(v)){
                        const ref=globalIndex.get(v);
                        if(ref)label=ref.title+' ('+v.split('/').pop()+')';
                        else label=v.split('/').pop();
                    }
                    return{raw:v,label,count:sampleSize<ds.records.length?Math.round(c*scale):c};
                });
            result.push({key:col.key,title:col.title,values});
        }
    });
    return result;
}

// Detect if dataset contains agenda or OVM references anywhere (even nested in objects)
// Returns [{refKey, prefix, title}] for each ref type found
function detectRefFilters(ds){
    const REF_TYPES=[
        {prefix:'agenda/',title:'Agenda',refKey:'agenda'},
        {prefix:'org√°n-ve≈ôejn√©-moci/',title:'OVM',refKey:'ovm'}
    ];
    // Don't add ref filter for the dataset that IS that entity type
    const skipPrefix=ds.config.idPrefix||'';
    const result=[];
    const sample=ds.records.slice(0,50);
    REF_TYPES.forEach(rt=>{
        if(skipPrefix===rt.prefix)return; // skip agenda filter on Agendy dataset etc.
        const found=sample.some(rec=>{
            const refs=extractRefs(rec);
            for(const r of refs){if(r.startsWith(rt.prefix))return true}
            return false;
        });
        if(found)result.push(rt);
    });
    return result;
}

// Find a matching ref ID from user input text
function findRefMatch(text,prefix){
    const q=text.trim().toLowerCase();
    if(!q)return null;
    // Check for exact bracket notation: "Title [CODE]"
    const bm=text.match(/\[([^\]]+)\]$/);
    if(bm){
        const candidate=prefix+bm[1];
        if(globalIndex.has(candidate))return candidate;
    }
    // Check for direct ID match
    if(globalIndex.has(q))return q;
    const withPrefix=prefix+q;
    if(globalIndex.has(withPrefix))return withPrefix;
    // Check title match (first exact)
    for(const[id,entry]of globalIndex){
        if(!id.startsWith(prefix))continue;
        if(entry.title.toLowerCase()===q)return id;
    }
    return null;
}

function getColumns(ds){
    const wantedKeys=ds.config.tableCols||[];
    const cols=[];
    // Use wanted keys, detecting type from data
    const sample=ds.records.slice(0,20);
    const allKeys=new Set();
    sample.forEach(r=>{if(typeof r==='object'&&r)Object.keys(r).forEach(k=>allKeys.add(k))});

    // If wanted keys specified, use those; else auto
    const keys=wantedKeys.length>0?wantedKeys.filter(k=>allKeys.has(k)):[...allKeys].filter(k=>k!=='type');

    keys.forEach(k=>{
        const sv=sample.find(r=>r[k]!=null)?.[k];
        let type='string';
        const uv=cs(sv);
        if(typeof uv==='boolean')type='boolean';
        else if(typeof uv==='number')type='number';
        else if(Array.isArray(sv)){
            if(sv.length>0&&typeof sv[0]==='object')type='subarray';
            else type='array';
        }else if(typeof sv==='object'&&sv!==null&&!('cs' in sv))type='object';
        cols.push({key:k,title:humanize(k),type});
    });
    return cols;
}

function renderTableHead(key,cols){
    const thead=document.getElementById('thead-'+key);if(!thead)return;
    thead.innerHTML='';
    const state=tabStates[key];
    const visCols=state.visibleCols?cols.filter(c=>state.visibleCols.has(c.key)):cols;
    const tr=document.createElement('tr');
    const th0=document.createElement('th');th0.textContent='#';th0.setAttribute('scope','col');tr.appendChild(th0);

    visCols.forEach(col=>{
        const th=document.createElement('th');th.setAttribute('scope','col');
        const a=document.createElement('a');a.href='#';a.textContent=col.title;
        a.addEventListener('click',e=>{
            e.preventDefault();
            if(state.sortKey===col.key)state.sortAsc=!state.sortAsc;
            else{state.sortKey=col.key;state.sortAsc=true}
            state.filtered=null;
            renderTable(key);
        });
        th.appendChild(a);
        const si=document.createElement('span');si.className='si';si.setAttribute('aria-hidden','true');th.appendChild(si);
        tr.appendChild(th);
    });

    const thA=document.createElement('th');thA.textContent='';thA.setAttribute('scope','col');tr.appendChild(thA);
    thead.appendChild(tr);
}

function renderTable(key){
    const ds=datasets[key];const state=tabStates[key];
    const cols=getColumns(ds);
    const tbody=document.getElementById('tbody-'+key);if(!tbody)return;
    tbody.innerHTML='';

    // Get filtered records
    if(!state.filtered){
        let recs=ds.records.map((r,i)=>({rec:r,idx:i}));
        const q=state.search.trim().toLowerCase();
        if(q){
            recs=recs.filter(({rec})=>{
                let hay=Object.values(rec).map(valToString).join(' ').toLowerCase();
                // Also search sub-arrays
                for(const v of Object.values(rec)){
                    if(Array.isArray(v))v.forEach(item=>{if(typeof item==='object'&&item)hay+=' '+Object.values(item).map(valToString).join(' ').toLowerCase()});
                }
                return hay.includes(q);
            });
        }
        // Apply column filters
        if(state.filters){
            for(const[fk,fv]of Object.entries(state.filters)){
                if(!fv)continue;
                if(fk.startsWith('__ref:')){
                    // Ref-type filter: use reverseIndex for fast lookup
                    const refEntries=reverseIndex.get(fv);
                    if(!refEntries||refEntries.length===0){recs=[];continue}
                    const matchIdx=new Set(refEntries.filter(e=>e.dsKey===key).map(e=>e.idx));
                    recs=recs.filter(({idx})=>matchIdx.has(idx));
                }else{
                    // Column value filter
                    recs=recs.filter(({rec})=>{
                        let val=cs(rec[fk]);
                        if(val==null)return false;
                        if(typeof val==='boolean')val=val?'ano':'ne';
                        else val=String(val);
                        return val===fv;
                    });
                }
            }
        }
        // Also filter from global search
        const gq=elGlobalInput.value.trim().toLowerCase();
        if(gq&&gq!==q){
            recs=recs.filter(({rec})=>{
                let hay=Object.values(rec).map(valToString).join(' ').toLowerCase();
                for(const v of Object.values(rec)){
                    if(Array.isArray(v))v.forEach(item=>{if(typeof item==='object'&&item)hay+=' '+Object.values(item).map(valToString).join(' ').toLowerCase()});
                }
                return hay.includes(gq);
            });
        }
        // Sort
        if(state.sortKey){
            recs.sort((a,b)=>{
                let va=cs(a.rec[state.sortKey]),vb=cs(b.rec[state.sortKey]);
                if(va==null&&vb==null)return 0;if(va==null)return 1;if(vb==null)return -1;
                if(typeof va==='number'&&typeof vb==='number')return state.sortAsc?va-vb:vb-va;
                va=valToString(va).toLowerCase();vb=valToString(vb).toLowerCase();
                const c=va.localeCompare(vb,'cs');return state.sortAsc?c:-c;
            });
        }
        state.filtered=recs;
    }

    const recs=state.filtered;
    const visCols=state.visibleCols?cols.filter(c=>state.visibleCols.has(c.key)):cols;
    const ps=state.pageSize;
    const totalPages=ps>0?Math.ceil(recs.length/ps):1;
    if(state.page>totalPages)state.page=totalPages||1;
    const start=ps>0?(state.page-1)*ps:0;
    const end=ps>0?start+ps:recs.length;
    const page=recs.slice(start,end);

    // Sort indicators
    const ths=document.getElementById('thead-'+key)?.querySelectorAll('th')||[];
    visCols.forEach((col,i)=>{
        const th=ths[i+1];if(!th)return;
        const si=th.querySelector('.si');if(!si)return;
        if(col.key===state.sortKey){si.textContent=state.sortAsc?'‚ñ≤':'‚ñº';th.setAttribute('aria-sort',state.sortAsc?'ascending':'descending')}
        else{si.textContent='';th.removeAttribute('aria-sort')}
    });

    if(page.length===0){
        const tr=document.createElement('tr');const td=document.createElement('td');
        td.colSpan=visCols.length+2;td.textContent=recs.length===0&&ds.records.length>0?'≈Ω√°dn√© z√°znamy neodpov√≠daj√≠ filtr≈Øm ani hled√°n√≠.':'≈Ω√°dn√° data.';
        td.style.cssText='text-align:center;padding:20px;color:#666';tr.appendChild(td);tbody.appendChild(tr);
    }else{
        page.forEach(({rec,idx},i)=>{
            const tr=document.createElement('tr');
            const td0=document.createElement('td');td0.textContent=start+i+1;td0.style.cssText='color:#999;text-align:right';tr.appendChild(td0);
            visCols.forEach(col=>{
                const td=document.createElement('td');
                renderCellValue(td,rec[col.key],col,key);
                tr.appendChild(td);
            });
            const tdA=document.createElement('td');
            const link=document.createElement('a');link.href='#';link.textContent='Detail';
            link.addEventListener('click',e=>{e.preventDefault();showDetail(key,idx)});
            tdA.appendChild(link);tr.appendChild(tdA);
            tbody.appendChild(tr);
        });
    }

    renderPag(key,recs.length);
}

function renderCellValue(td,rawVal,col,dsKey){
    const val=cs(rawVal);
    if(val==null||val===''){td.textContent='‚Äî';td.style.color='#999';return}

    // Ref link
    if(typeof val==='string'&&isRefId(val)){
        const ref=resolveRef(val);
        if(ref){
            const a=document.createElement('a');a.href='#';a.className='ref-link';
            a.textContent=ref.title;a.title=val;
            a.addEventListener('click',e=>{e.preventDefault();showDetail(ref.dsKey,ref.idx)});
            td.appendChild(a);return;
        }
        const coded=codedLabel(val);
        if(coded){const b=document.createElement('span');b.className='type-badge '+coded.badgeClass;b.textContent=coded.label;td.appendChild(b);return}
        td.textContent=val;return;
    }

    // Bare identifier (IƒåO, k√≥d agendy‚Ä¶) ‚Üí resolve via bareIndex
    // Skip if it would link to the same dataset (e.g. "A8071" in Agendy table)
    if(typeof val==='string'&&bareIndex.has(val)){
        const ref=resolveRef(val);
        if(ref&&ref.dsKey!==dsKey){
            const a=document.createElement('a');a.href='#';a.className='ref-link';
            a.textContent=ref.title;a.title=bareIndex.get(val);
            a.addEventListener('click',e=>{e.preventDefault();showDetail(ref.dsKey,ref.idx)});
            td.appendChild(a);return;
        }
    }

    // Boolean
    if(typeof val==='boolean'){td.textContent=val?'Ano':'Ne';return}

    // URL
    if(typeof val==='string'&&/^https?:\/\//.test(val)){
        const a=document.createElement('a');a.href=val;a.target='_blank';a.rel='noopener';a.textContent=shortenUrl(val);td.appendChild(a);return;
    }

    // Array of refs or strings
    if(Array.isArray(val)){
        if(col.type==='subarray'){
            const b=document.createElement('span');b.className='sub-count';b.textContent=val.length+' z√°zn.';td.appendChild(b);return;
        }
        if(val.length>0&&typeof val[0]==='string'&&(isRefId(val[0])||bareIndex.has(val[0]))){
            val.slice(0,3).forEach((v,i)=>{
                if(i>0)td.appendChild(document.createTextNode(', '));
                const ref=resolveRef(v);
                if(ref&&(isRefId(v)||ref.dsKey!==dsKey)){
                    const a=document.createElement('a');a.href='#';a.className='ref-link';a.textContent=ref.title;a.title=v;
                    a.addEventListener('click',e=>{e.preventDefault();showDetail(ref.dsKey,ref.idx)});td.appendChild(a);
                }else td.appendChild(document.createTextNode(valToString(v)));
            });
            if(val.length>3)td.appendChild(document.createTextNode(` ‚Ä¶ (+${val.length-3})`));
            return;
        }
        if(val.length>0&&typeof val[0]==='object'){
            const b=document.createElement('span');b.className='sub-count';b.textContent=val.length+' pol.';td.appendChild(b);return;
        }
        td.textContent=val.map(v=>valToString(v)).join(', ');return;
    }

    // Object (not cs-map since we already unwrapped) ‚Äî render all fields, linkify refs
    if(typeof val==='object'){
        const parts=[];
        for(const[k,v]of Object.entries(val)){
            const sv=cs(v);
            if(sv==null||sv===''||k==='type')continue;
            if(typeof sv==='string'){
                const ref=resolveRef(sv);
                if(ref){parts.push({key:k,ref,refId:sv});continue}
            }
            parts.push({key:k,text:valToString(v)});
        }
        if(parts.length===0){td.textContent=valToString(rawVal);return}
        parts.forEach((p,i)=>{
            if(i>0)td.appendChild(document.createTextNode(', '));
            if(parts.length>1){
                const lbl=document.createElement('span');lbl.style.cssText='color:#666;font-size:.82rem';lbl.textContent=humanize(p.key)+': ';td.appendChild(lbl);
            }
            if(p.ref){
                const a=document.createElement('a');a.href='#';a.className='ref-link';a.textContent=p.ref.title;a.title=p.refId;
                a.addEventListener('click',e=>{e.preventDefault();showDetail(p.ref.dsKey,p.ref.idx)});td.appendChild(a);
            }else{
                td.appendChild(document.createTextNode(p.text));
            }
        });
        return;
    }

    // Coded value
    if(typeof val==='string'){
        const coded=codedLabel(val);
        if(coded){const b=document.createElement('span');b.className='type-badge '+coded.badgeClass;b.textContent=coded.label;td.appendChild(b);return}
    }

    // Date check
    if(typeof val==='string'&&/^\d{4}-\d{2}-\d{2}/.test(val)){td.textContent=fmtDate(val);return}

    td.textContent=String(val);
}

// ===== Pagination =====
function renderPag(key,total){
    const pag=document.getElementById('pag-'+key);if(!pag)return;
    pag.innerHTML='';
    const state=tabStates[key];
    const ps=state.pageSize;
    const totalPages=ps>0?Math.ceil(total/ps):1;
    const start=ps>0?(state.page-1)*ps+1:1;
    const end=ps>0?Math.min(state.page*ps,total):total;

    const info=document.createElement('div');info.className='pag-info';
    const ds=datasets[key];
    info.textContent=total>0?`${start}‚Äì${end} z ${total.toLocaleString('cs')}`+(total<ds.records.length?` (filtrov√°no z ${ds.records.length.toLocaleString('cs')})`:''):'0 z√°znam≈Ø';
    pag.appendChild(info);

    const szDiv=document.createElement('div');szDiv.className='pag-size';
    const szL=document.createElement('label');szL.setAttribute('for','psz-'+key);szL.textContent='Na str√°nku:';
    const szS=document.createElement('select');szS.id='psz-'+key;
    [10,25,50,100,0].forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v||'V≈°e';if(v===state.pageSize)o.selected=true;szS.appendChild(o)});
    szS.addEventListener('change',()=>{state.pageSize=parseInt(szS.value)||0;state.page=1;renderTable(key)});
    szDiv.appendChild(szL);szDiv.appendChild(szS);pag.appendChild(szDiv);

    if(totalPages<=1)return;
    const ctrl=document.createElement('div');ctrl.className='pag-controls';
    const mkBtn=(txt,dis,fn,cur)=>{const b=document.createElement('button');b.textContent=txt;b.className=cur?'':'secondary';b.disabled=dis;if(cur)b.setAttribute('aria-current','page');b.addEventListener('click',fn);ctrl.appendChild(b)};
    mkBtn('‚Üê',state.page<=1,()=>{state.page--;renderTable(key)});
    pageNums(state.page,totalPages).forEach(p=>{
        if(p==='‚Ä¶'){const s=document.createElement('span');s.textContent='‚Ä¶';s.style.padding='4px';ctrl.appendChild(s)}
        else mkBtn(p,false,()=>{state.page=p;renderTable(key)},p===state.page);
    });
    mkBtn('‚Üí',state.page>=totalPages,()=>{state.page++;renderTable(key)});
    pag.appendChild(ctrl);
}
function pageNums(c,t){
    if(t<=7)return Array.from({length:t},(_,i)=>i+1);
    const p=[1];if(c>3)p.push('‚Ä¶');
    for(let i=Math.max(2,c-1);i<=Math.min(t-1,c+1);i++)p.push(i);
    if(c<t-2)p.push('‚Ä¶');p.push(t);return p;
}

// ===== Export =====
function exportData(key,fmt){
    const ds=datasets[key];const state=tabStates[key];
    if(!ds||!state)return;
    const cols=getColumns(ds);
    const visCols=state.visibleCols?cols.filter(c=>state.visibleCols.has(c.key)):cols;

    // Get filtered+sorted data (all pages)
    if(!state.filtered){renderTable(key)}
    const recs=state.filtered||[];

    // Build header + rows as plain text arrays
    const header=visCols.map(c=>c.title);
    const rows=recs.map(({rec})=>visCols.map(col=>{
        const raw=rec[col.key];const val=cs(raw);
        if(val==null)return '';
        if(typeof val==='boolean')return val?'Ano':'Ne';
        if(typeof val==='string'&&isRefId(val)){const ref=resolveRef(val);return ref?ref.title+' ('+val+')':val}
        if(typeof val==='string'&&bareIndex.has(val)){const ref=resolveRef(val);return ref?ref.title+' ('+val+')':val}
        if(Array.isArray(val)){
            return val.map(v=>{
                if(typeof v==='string'&&(isRefId(v)||bareIndex.has(v))){const r=resolveRef(v);return r?r.title:v}
                return valToString(v);
            }).join('; ');
        }
        return valToString(raw);
    }));

    if(fmt==='xlsx'){
        if(typeof XLSX==='undefined'){alert('Knihovna XLSX se nenaƒçetla. Zkuste CSV nebo TSV.');return}
        const wb=XLSX.utils.book_new();
        const ws=XLSX.utils.aoa_to_sheet([header,...rows]);
        // Auto column widths
        ws['!cols']=header.map((_,i)=>{
            let max=header[i].length;
            rows.slice(0,100).forEach(r=>{if(r[i])max=Math.max(max,String(r[i]).length)});
            return{wch:Math.min(max+2,60)};
        });
        XLSX.utils.book_append_sheet(wb,ws,ds.config.name.substring(0,31));
        XLSX.writeFile(wb,'rpp-'+key+'.xlsx');
        return;
    }

    // CSV or TSV
    const sep=fmt==='tsv'?'\t':',';
    const esc=v=>{
        const s=String(v);
        if(fmt==='tsv')return s.replace(/[\t\n\r]/g,' ');
        return s.includes(',')||s.includes('"')||s.includes('\n')?'"'+s.replace(/"/g,'""')+'"':s;
    };
    const lines=[header.map(esc).join(sep),...rows.map(r=>r.map(esc).join(sep))];
    const blob=new Blob(['\uFEFF'+lines.join('\n')],{type:fmt==='tsv'?'text/tab-separated-values;charset=utf-8':'text/csv;charset=utf-8'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download='rpp-'+key+'.'+(fmt==='tsv'?'tsv':'csv');
    document.body.appendChild(a);a.click();document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
function showDetail(dsKey,idx){
    const ds=datasets[dsKey];if(!ds||!ds.records[idx])return;
    const rec=ds.records[idx];
    elDetailBody.innerHTML='';
    const title=cs(rec.n√°zev)||cs(rec['n√°zev-√∫daje'])||rec.k√≥d||rec.identifik√°tor||rec.id||'Z√°znam';
    elDetailTitle.textContent=title;

    // Permalink
    const recId=rec.id||'';
    if(recId){
        elDetailPermalink.style.display='flex';
        elDetailPermalink.innerHTML='';
        const pUrl=new URL(location.href);pUrl.search='';pUrl.searchParams.set('detail',recId);
        const plLink=document.createElement('a');plLink.href=pUrl.toString();plLink.textContent='P≈ô√≠m√Ω odkaz na tento z√°znam';
        plLink.title=pUrl.toString();
        const plBtn=document.createElement('button');plBtn.className='secondary';plBtn.textContent='Kop√≠rovat';
        plBtn.addEventListener('click',()=>{navigator.clipboard.writeText(pUrl.toString()).then(()=>{plBtn.textContent='‚úì';setTimeout(()=>plBtn.textContent='Kop√≠rovat',2000)}).catch(()=>{})});
        elDetailPermalink.appendChild(plLink);elDetailPermalink.appendChild(plBtn);
    }else{
        elDetailPermalink.style.display='none';
    }

    // Main fields
    const dl=document.createElement('dl');dl.className='dl';
    const skipKeys=new Set(['type']);
    const subArrayKeys=[];
    let fieldCount=0;

    Object.entries(rec).forEach(([key,rawVal])=>{
        if(skipKeys.has(key))return;
        if(Array.isArray(rawVal)&&rawVal.length>0&&typeof rawVal[0]==='object'&&!('cs' in rawVal[0])){
            subArrayKeys.push(key);return;
        }
        try{
            const dt=document.createElement('dt');dt.textContent=humanize(key);dl.appendChild(dt);
            const dd=document.createElement('dd');
            renderDetailVal(dd,rawVal);
            dl.appendChild(dd);
            fieldCount++;
        }catch(e){
            const dt=document.createElement('dt');dt.textContent=humanize(key);dl.appendChild(dt);
            const dd=document.createElement('dd');dd.textContent='[chyba vykreslen√≠: '+e.message+']';dd.style.color='#c62828';dl.appendChild(dd);
        }
    });
    elDetailBody.appendChild(dl);

    // Sub-record sections
    subArrayKeys.forEach(key=>{
        try{
            const arr=rec[key];
            const sec=document.createElement('div');sec.className='sub-section';
            const h3=document.createElement('h3');h3.textContent=`${humanize(key)} (${arr.length})`;sec.appendChild(h3);
            renderSubTable(sec,arr);
            elDetailBody.appendChild(sec);
        }catch(e){
            const sec=document.createElement('div');sec.className='sub-section';
            sec.innerHTML='<h3>'+humanize(key)+'</h3><p style="color:#c62828">[chyba vykreslen√≠: '+e.message+']</p>';
            elDetailBody.appendChild(sec);
        }
    });

    // Related records from other datasets (reverse lookups)
    renderRelated(dsKey,rec);

    // Raw JSON toggle
    const rawSec=document.createElement('details');rawSec.className='sub-section';rawSec.style.borderTop='2px solid #e0e0e0';
    const rawSum=document.createElement('summary');rawSum.style.cssText='cursor:pointer;font-weight:600;padding:8px 0';
    rawSum.textContent='Surov√° data (JSON) ‚Äî '+Object.keys(rec).length+' pol√≠';
    rawSec.appendChild(rawSum);
    const rawPre=document.createElement('pre');rawPre.style.cssText='max-height:500px;overflow:auto;background:#f5f5f5;padding:12px;border-radius:4px;font-size:.8rem;white-space:pre-wrap;word-break:break-all';
    rawPre.textContent=JSON.stringify(rec,null,2);
    rawSec.appendChild(rawPre);
    elDetailBody.appendChild(rawSec);

    elDetail.classList.add('visible');
    elTabsArea.style.display='none';
    elGlobalSearch.style.display='none';
    elDetail.scrollIntoView({behavior:'smooth'});
    elDetailTitle.focus();
}

function renderDetailVal(dd,rawVal){
    const val=cs(rawVal);
    if(val==null||val===''){dd.textContent='(pr√°zdn√©)';dd.className='empty';return}

    // Ref
    if(typeof val==='string'&&isRefId(val)){
        const ref=resolveRef(val);
        if(ref){
            const a=document.createElement('a');a.href='#';a.className='ref-link';a.textContent=ref.title;a.title=val;
            a.addEventListener('click',e=>{e.preventDefault();showDetail(ref.dsKey,ref.idx)});
            dd.appendChild(a);
            dd.appendChild(document.createTextNode(' ('+val+')'));return;
        }
        const coded=codedLabel(val);
        if(coded){const b=document.createElement('span');b.className='type-badge '+coded.badgeClass;b.textContent=coded.label;dd.appendChild(b);dd.appendChild(document.createTextNode(' ('+val+')'));return}
        dd.textContent=val;return;
    }

    // Bare identifier (IƒåO, k√≥d agendy‚Ä¶)
    if(typeof val==='string'&&bareIndex.has(val)){
        const ref=resolveRef(val);
        if(ref){
            const a=document.createElement('a');a.href='#';a.className='ref-link';a.textContent=ref.title;a.title=bareIndex.get(val);
            a.addEventListener('click',e=>{e.preventDefault();showDetail(ref.dsKey,ref.idx)});
            dd.appendChild(a);
            dd.appendChild(document.createTextNode(' ('+val+')'));return;
        }
    }

    // URL
    if(typeof val==='string'&&/^https?:\/\//.test(val)){const a=document.createElement('a');a.href=val;a.target='_blank';a.rel='noopener';a.textContent=val;dd.appendChild(a);return}

    // e-Sb√≠rka
    if(typeof val==='string'&&val.startsWith('/eli/')){const a=document.createElement('a');a.href='https://www.e-sbirka.cz'+val;a.target='_blank';a.rel='noopener';a.textContent=val;dd.appendChild(a);return}

    // Boolean
    if(typeof val==='boolean'){dd.textContent=val?'Ano':'Ne';return}

    // Array
    if(Array.isArray(val)){
        if(val.length===0){dd.textContent='(pr√°zdn√©)';dd.className='empty';return}
        val.forEach((item,i)=>{
            if(i>0)dd.appendChild(document.createElement('br'));
            const span=document.createElement('span');
            if(typeof item==='string'&&(isRefId(item)||bareIndex.has(item))){
                const ref=resolveRef(item);
                if(ref){const a=document.createElement('a');a.href='#';a.className='ref-link';a.textContent=ref.title;a.title=item;
                a.addEventListener('click',e=>{e.preventDefault();showDetail(ref.dsKey,ref.idx)});span.appendChild(a)}
                else span.textContent=item;
            }else if(typeof item==='string'&&item.startsWith('/eli/')){
                const a=document.createElement('a');a.href='https://www.e-sbirka.cz'+item;a.target='_blank';a.rel='noopener';a.textContent=item;span.appendChild(a);
            }else span.textContent=valToString(item);
            dd.appendChild(span);
        });
        return;
    }

    // Object
    if(typeof val==='object'){
        const inner=document.createElement('dl');inner.className='dl';inner.style.marginLeft='16px';
        Object.entries(val).forEach(([k,v])=>{
            if(v==null||k==='type')return;
            const idt=document.createElement('dt');idt.textContent=humanize(k);inner.appendChild(idt);
            const idd=document.createElement('dd');renderDetailVal(idd,v);inner.appendChild(idd);
        });
        dd.appendChild(inner);return;
    }

    // Date
    if(typeof val==='string'&&/^\d{4}-\d{2}-\d{2}/.test(val)){dd.textContent=fmtDate(val);return}

    // Coded
    if(typeof val==='string'){const coded=codedLabel(val);if(coded){const b=document.createElement('span');b.className='type-badge '+coded.badgeClass;b.textContent=coded.label;dd.appendChild(b);dd.appendChild(document.createTextNode(' ('+val+')'));return}}

    dd.textContent=String(val);
}

function renderSubTable(container,arr){
    // Determine columns from data
    const allKeys=new Set();
    arr.slice(0,30).forEach(item=>{if(typeof item==='object'&&item)Object.keys(item).forEach(k=>allKeys.add(k))});
    // Remove type if uniform
    const types=new Set(arr.map(r=>r?.type).filter(Boolean));
    const cols=[...allKeys].filter(k=>!(k==='type'&&types.size<=1));

    const wrap=document.createElement('div');wrap.className='table-wrap';
    const table=document.createElement('table');table.style.fontSize='0.85rem';
    const thead=document.createElement('thead');const hRow=document.createElement('tr');
    const th0=document.createElement('th');th0.textContent='#';th0.setAttribute('scope','col');hRow.appendChild(th0);
    cols.forEach(k=>{const th=document.createElement('th');th.textContent=humanize(k);th.setAttribute('scope','col');hRow.appendChild(th)});
    thead.appendChild(hRow);table.appendChild(thead);

    const tbody=document.createElement('tbody');
    arr.forEach((item,i)=>{
        const tr=document.createElement('tr');
        const td0=document.createElement('td');td0.textContent=i+1;td0.style.cssText='color:#999;text-align:right';tr.appendChild(td0);
        cols.forEach(k=>{
            const td=document.createElement('td');
            const raw=item?.[k];
            const val=cs(raw);
            // Smart rendering
            if(val==null||val===''){td.textContent='‚Äî';td.style.color='#999'}
            else if(typeof val==='string'&&(isRefId(val)||bareIndex.has(val))){
                const ref=resolveRef(val);
                if(ref){const a=document.createElement('a');a.href='#';a.className='ref-link';a.textContent=ref.title;a.title=val;
                a.addEventListener('click',e=>{e.preventDefault();showDetail(ref.dsKey,ref.idx)});td.appendChild(a)}
                else{const coded=codedLabel(val);if(coded){const b=document.createElement('span');b.className='type-badge '+coded.badgeClass;b.textContent=coded.label;td.appendChild(b)}else td.textContent=val}
            }else if(Array.isArray(val)){
                val.forEach((v,j)=>{
                    if(j>0)td.appendChild(document.createTextNode(', '));
                    if(typeof v==='string'&&(isRefId(v)||bareIndex.has(v))){
                        const ref=resolveRef(v);
                        if(ref){const a=document.createElement('a');a.href='#';a.className='ref-link';a.textContent=ref.title;
                        a.addEventListener('click',e=>{e.preventDefault();showDetail(ref.dsKey,ref.idx)});td.appendChild(a)}
                        else td.appendChild(document.createTextNode(v));
                    }else if(typeof v==='string'&&v.startsWith('/eli/')){
                        const a=document.createElement('a');a.href='https://www.e-sbirka.cz'+v;a.target='_blank';a.rel='noopener';a.textContent=v;td.appendChild(a);
                    }else if(typeof v==='object'&&v){td.appendChild(document.createTextNode(valToString(v)))}
                    else td.appendChild(document.createTextNode(String(v)));
                });
            }else if(typeof val==='boolean'){td.textContent=val?'Ano':'Ne'}
            else if(typeof val==='string'&&val.startsWith('/eli/')){const a=document.createElement('a');a.href='https://www.e-sbirka.cz'+val;a.target='_blank';a.rel='noopener';a.textContent=val;td.appendChild(a)}
            else if(typeof val==='object'){
                const inner=document.createElement('dl');inner.className='dl';inner.style.margin='0';
                Object.entries(val).forEach(([ik,iv])=>{if(iv!=null&&ik!=='type'){
                    const idt=document.createElement('dt');idt.textContent=humanize(ik);idt.style.cssText='font-size:0.8rem;margin-top:4px';inner.appendChild(idt);
                    const idd=document.createElement('dd');renderDetailVal(idd,iv);inner.appendChild(idd)}});
                td.appendChild(inner);
            }else{
                const coded=codedLabel(val);
                if(coded){const b=document.createElement('span');b.className='type-badge '+coded.badgeClass;b.textContent=coded.label;td.appendChild(b)}
                else if(typeof val==='string'&&/^\d{4}-\d{2}-\d{2}/.test(val))td.textContent=fmtDate(val);
                else td.textContent=String(val);
            }
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
    table.appendChild(tbody);wrap.appendChild(table);container.appendChild(wrap);
}

// ===== Related records (reverse lookup) =====
function renderRelated(dsKey,rec){
    const recId=rec.id;
    if(!recId)return;

    const entries=reverseIndex.get(recId);
    if(!entries||entries.length===0)return;

    // Group by dataset
    const groups={};
    entries.forEach(e=>{
        if(!groups[e.dsKey])groups[e.dsKey]={name:datasets[e.dsKey].config.name,matches:[]};
        groups[e.dsKey].matches.push(e);
    });

    for(const[rKey,group]of Object.entries(groups)){
        const ds=datasets[rKey];
        if(!ds)continue;
        const sec=document.createElement('div');sec.className='related-section';
        const h3=document.createElement('h3');
        h3.textContent=`Souvisej√≠c√≠: ${group.name} (${group.matches.length})`;
        sec.appendChild(h3);

        // Build a table of related records ‚Äî all of them
        const recs=group.matches.map(m=>ds.records[m.idx]).filter(Boolean);
        if(recs.length===0){sec.appendChild(document.createTextNode('≈Ω√°dn√© z√°znamy'));elDetailBody.appendChild(sec);continue}

        const cols=getRelatedCols(ds,recs);
        const visSet=new Set(cols.map(c=>c.key));

        // Column toggle
        const colToggle=document.createElement('details');colToggle.className='col-toggle';
        const colSum=document.createElement('summary');colSum.textContent='Sloupce ('+visSet.size+'/'+cols.length+')';
        colToggle.appendChild(colSum);
        const colChecks=document.createElement('div');colChecks.className='col-checks';

        const wrap=document.createElement('div');wrap.className='table-wrap';
        const table=document.createElement('table');table.style.fontSize='0.85rem';
        let relPageSize=100;
        let relShowAll=recs.length<=100;

        function rebuildRelTable(){
            const vc=cols.filter(c=>visSet.has(c.key));
            colSum.textContent='Sloupce ('+visSet.size+'/'+cols.length+')';
            table.innerHTML='';
            const thead=document.createElement('thead');const hRow=document.createElement('tr');
            const th0=document.createElement('th');th0.textContent='#';th0.setAttribute('scope','col');hRow.appendChild(th0);
            vc.forEach(col=>{const th=document.createElement('th');th.textContent=col.title;th.setAttribute('scope','col');hRow.appendChild(th)});
            const thD=document.createElement('th');thD.textContent='';hRow.appendChild(thD);
            thead.appendChild(hRow);table.appendChild(thead);
            const tbody=document.createElement('tbody');
            const showRecs=relShowAll?recs:recs.slice(0,relPageSize);
            showRecs.forEach((r,i)=>{
                const idx=group.matches[i].idx;
                const tr=document.createElement('tr');
                const td0=document.createElement('td');td0.textContent=i+1;td0.style.cssText='color:#999;text-align:right';tr.appendChild(td0);
                vc.forEach(col=>{
                    const td=document.createElement('td');
                    renderCellValue(td,r[col.key],col,rKey);
                    tr.appendChild(td);
                });
                const tdD=document.createElement('td');
                const link=document.createElement('a');link.href='#';link.textContent='Detail';
                link.addEventListener('click',e=>{e.preventDefault();showDetail(rKey,idx)});
                tdD.appendChild(link);tr.appendChild(tdD);
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            // Show-all button
            let moreBtn=sec.querySelector('.rel-show-all');
            if(!relShowAll&&recs.length>relPageSize){
                if(!moreBtn){
                    moreBtn=document.createElement('button');moreBtn.className='rel-show-all secondary';
                    moreBtn.style.cssText='margin-top:6px;font-size:.82rem';
                    moreBtn.addEventListener('click',()=>{relShowAll=true;rebuildRelTable()});
                    wrap.after(moreBtn);
                }
                moreBtn.textContent='Zobrazit v≈°e ('+recs.length.toLocaleString('cs')+' z√°znam≈Ø)';
                moreBtn.style.display='';
            }else if(moreBtn){
                moreBtn.style.display='none';
            }
        }

        cols.forEach(col=>{
            const lbl=document.createElement('label');
            const cb=document.createElement('input');cb.type='checkbox';cb.checked=true;
            cb.addEventListener('change',()=>{
                if(cb.checked)visSet.add(col.key);else visSet.delete(col.key);
                rebuildRelTable();
            });
            lbl.appendChild(cb);lbl.appendChild(document.createTextNode(' '+col.title));
            colChecks.appendChild(lbl);
        });
        colToggle.appendChild(colChecks);
        sec.appendChild(colToggle);

        rebuildRelTable();
        wrap.appendChild(table);sec.appendChild(wrap);
        elDetailBody.appendChild(sec);
    }
}

function getRelatedCols(ds,sampleRecs){
    const wanted=ds.config.tableCols||[];
    const allKeys=new Set();
    sampleRecs.slice(0,20).forEach(r=>{if(r)Object.keys(r).forEach(k=>allKeys.add(k))});
    const keys=wanted.length>0?wanted.filter(k=>allKeys.has(k)&&k!=='type'):
        [...allKeys].filter(k=>k!=='type'&&k!=='id');
    return keys.map(k=>{
        const sv=sampleRecs.find(r=>r&&r[k]!=null)?.[k];
        let type='string';
        const uv=cs(sv);
        if(typeof uv==='boolean')type='boolean';
        else if(Array.isArray(sv)){
            if(sv.length>0&&typeof sv[0]==='object')type='subarray';else type='array';
        }else if(typeof sv==='object'&&sv!==null&&!('cs' in sv))type='object';
        return{key:k,title:humanize(k),type};
    });
}

function hideDetail(){
    elDetail.classList.remove('visible');
    elDetailPermalink.style.display='none';
    elTabsArea.style.display='block';
    elGlobalSearch.style.display='block';
}

// ===== Global search =====
let gT;
elGlobalInput.addEventListener('input',()=>{
    clearTimeout(gT);
    gT=setTimeout(()=>{
        // Invalidate all filtered caches and re-render active tab
        for(const k of Object.keys(tabStates))tabStates[k].filtered=null;
        if(activeTab)renderTable(activeTab);
    },400);
});

elDetailBack.addEventListener('click',e=>{e.preventDefault();hideDetail()});
document.addEventListener('keydown',e=>{if(e.key==='Escape'&&elDetail.classList.contains('visible'))hideDetail()});

// ===== Init =====
// Show pending detail indicator if URL has ?detail= param
const urlParams=new URLSearchParams(location.search);
const pendingDetailId=urlParams.get('detail');
if(pendingDetailId){
    elPendingDetail.style.display='block';
    elPendingDetail.textContent='‚è≥ Po naƒçten√≠ dat se zobraz√≠ detail: '+pendingDetailId;
}

function handleUrlParams(){
    if(!pendingDetailId)return;
    // Try to resolve the detail ID
    const ref=globalIndex.get(pendingDetailId);
    if(ref){
        elPendingDetail.style.display='none';
        showDetail(ref.dsKey,ref.idx);
    }else{
        // Maybe it's a bare ID
        const resolved=bareIndex.get(pendingDetailId);
        if(resolved){
            const ref2=globalIndex.get(resolved);
            if(ref2){elPendingDetail.style.display='none';showDetail(ref2.dsKey,ref2.idx);return}
        }
        // Not found yet (maybe in a not-yet-loaded dataset like P≈Øsobnost)
        elPendingDetail.textContent='‚è≥ Z√°znam ‚Äû'+pendingDetailId+'" zat√≠m nenalezen ‚Äî pokud je v ruƒçnƒõ naƒç√≠tan√© sadƒõ, naƒçtƒõte ji pros√≠m.';
    }
}

loadAll();

})();
</script>
</body>
</html>
