<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prohl√≠≈æeƒç RPP</title>
<style>
*,*::before,*::after{box-sizing:border-box}
body{font-family:system-ui,-apple-system,sans-serif;margin:0;padding:0;background:#f5f5f5;color:#1a1a1a;line-height:1.6}
a{color:#0056b3}a:hover{color:#003d80}
a:focus-visible,button:focus-visible,input:focus-visible,select:focus-visible{outline:3px solid #0056b3;outline-offset:2px}
.skip-link{position:absolute;top:-100px;left:8px;background:#0056b3;color:#fff;padding:8px 16px;z-index:1000;border-radius:0 0 4px 4px;text-decoration:none;font-weight:600}
.skip-link:focus{top:0}
header{background:#1a1a1a;color:#fff;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
header h1{margin:0;font-size:1.4rem;font-weight:600}
header p{margin:4px 0 0;font-size:0.85rem;color:#aaa}
main{max-width:1800px;margin:0 auto;padding:16px 24px}

/* Loading */
#loading-panel{background:#fff;border:1px solid #ccc;border-radius:6px;padding:20px;margin-bottom:20px}
#loading-panel:empty{display:none}
#loading-panel h2{margin:0 0 12px;font-size:1.1rem}
.load-item{display:flex;align-items:center;gap:8px;padding:3px 0;font-size:0.9rem}
.load-icon{width:18px;text-align:center;font-size:0.85rem}
.load-ok{color:#34a853}.load-err{color:#ea4335}.load-wait{color:#999}
#loading-progress{margin-top:12px;font-weight:600;font-size:0.95rem}

/* Progress bars */
.load-progress-bar{width:180px;height:10px;background:#e0e0e0;border-radius:5px;overflow:hidden;display:inline-block;vertical-align:middle;margin-left:8px}
.load-progress-bar .fill{height:100%;background:#0056b3;transition:width .3s;border-radius:5px}
.load-detail{font-size:.82rem;color:#777;margin-left:26px}

/* CORS error */
.cors-help{background:#fff8e1;border:1px solid #f9a825;border-radius:6px;padding:16px;margin-top:12px;font-size:.9rem;line-height:1.7}
.cors-help code{background:#f0f0f0;padding:2px 6px;border-radius:3px;font-size:.85rem}

/* Status */
#status-area{padding:12px 16px;margin-bottom:16px;border-radius:4px;font-weight:500}
#status-area:empty{display:none}
#status-area.info{background:#e8f0fe;border:1px solid #4a90d9;color:#1a3a5c}
#status-area.success{background:#e6f4ea;border:1px solid #34a853;color:#1e4620}
#status-area.error{background:#fce8e6;border:1px solid #ea4335;color:#5f1412}

/* Global search */
#global-search-area{margin-bottom:16px}
#global-search-area label{display:block;font-weight:600;margin-bottom:4px;font-size:0.95rem}
.search-row{display:flex;gap:8px}
.search-row input{flex:1;padding:10px 12px;border:1px solid #999;border-radius:4px;font-size:1rem}

/* Dataset tabs */
.tabs{display:flex;flex-wrap:wrap;gap:2px;margin-bottom:0;border-bottom:2px solid #ccc;background:#fff;padding:0 8px}
.tab-btn{padding:10px 16px;border:none;background:transparent;font-size:0.9rem;font-weight:500;cursor:pointer;color:#555;border-bottom:3px solid transparent;margin-bottom:-2px;white-space:nowrap}
.tab-btn:hover{color:#1a1a1a;background:#f0f0f0}
.tab-btn.active{color:#0056b3;border-bottom-color:#0056b3;font-weight:600}
.tab-btn .tab-count{font-size:0.8rem;color:#888;margin-left:4px}
.tab-btn.active .tab-count{color:#0056b3}

/* Tab content */
.tab-panel{display:none;background:#fff;border:1px solid #ccc;border-top:none;border-radius:0 0 6px 6px;padding:16px}
.tab-panel.active{display:block}

/* Filter row */
.filter-row{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;margin-bottom:12px}
.filter-field{min-width:180px;flex:1;max-width:300px}
.filter-field label{display:block;font-size:0.85rem;font-weight:500;margin-bottom:2px}
.filter-field input,.filter-field select{width:100%;padding:6px 8px;border:1px solid #999;border-radius:4px;font-size:0.9rem}

button{padding:8px 16px;border:2px solid #0056b3;background:#0056b3;color:#fff;border-radius:4px;font-size:0.9rem;font-weight:600;cursor:pointer;white-space:nowrap}
button:hover{background:#003d80;border-color:#003d80}
button.secondary{background:#fff;color:#0056b3}
button.secondary:hover{background:#e8f0fe}
button:disabled{opacity:.5;cursor:not-allowed}

/* Table */
.table-wrap{overflow-x:auto;margin-bottom:12px;border:1px solid #ddd;border-radius:4px}
table{width:100%;border-collapse:collapse;font-size:0.88rem}
thead{background:#f0f0f0}
th{text-align:left;padding:8px 10px;border-bottom:2px solid #999;font-weight:600;white-space:nowrap}
th a{color:inherit;text-decoration:none}th a:hover{text-decoration:underline}
th .si{margin-left:3px;font-size:.75em;color:#666}
td{padding:6px 10px;border-bottom:1px solid #e8e8e8;vertical-align:top;max-width:500px}
tr:hover{background:#f8f8f8}
tbody tr:last-child td{border-bottom:none}

.ref-link{cursor:pointer;text-decoration:underline;color:#0056b3}
.ref-link:hover{color:#003d80}

.sub-count{display:inline-block;background:#e8f0fe;color:#0056b3;padding:1px 8px;border-radius:10px;font-size:.82rem;font-weight:500}
.type-badge{display:inline-block;padding:1px 8px;border-radius:3px;font-size:.78rem;font-weight:500}
.type-badge.b-green{background:#e6f4ea;color:#1e4620}
.type-badge.b-red{background:#fce8e6;color:#5f1412}
.type-badge.b-blue{background:#e8f0fe;color:#0056b3}
.type-badge.b-gray{background:#f0f0f0;color:#555}

/* Pagination */
.pag{display:flex;flex-wrap:wrap;gap:6px;align-items:center;justify-content:space-between;margin-top:8px}
.pag-info{font-size:.88rem;color:#555}
.pag-controls{display:flex;gap:3px;align-items:center}
.pag-controls button{padding:5px 10px;font-size:.82rem;min-width:36px}
.pag-size{display:flex;gap:6px;align-items:center;font-size:.88rem}
.pag-size select{padding:4px 6px;border:1px solid #999;border-radius:4px;font-size:.88rem}

/* Detail */
#detail-overlay{display:none;background:#fff;border:1px solid #ccc;border-radius:6px;padding:24px 28px;margin-bottom:20px}
#detail-overlay.visible{display:block}
#detail-overlay h2{margin:0 0 4px;font-size:1.25rem}
#detail-overlay .back-link{display:inline-block;margin-bottom:12px}
.filter-bar{display:flex;flex-wrap:wrap;gap:8px;align-items:flex-end;margin-top:4px}
.filter-bar .filter-field{min-width:140px;flex:0 1 auto;max-width:220px}
.filter-bar .filter-field select{font-size:.84rem;padding:4px 6px}
.filter-bar .filter-field input[type="text"]{font-size:.84rem;padding:4px 6px;border:1px solid #999;border-radius:4px;width:100%}
dl.dl{margin:0}
dl.dl dt{font-weight:600;margin-top:14px;color:#444;font-size:.82rem;text-transform:uppercase;letter-spacing:.03em}
dl.dl dt:first-child{margin-top:0}
dl.dl dd{margin:3px 0 0;padding:0;word-break:break-word}
dl.dl dd.empty{color:#999;font-style:italic}

.sub-section{margin-top:20px;border-top:2px solid #e0e0e0;padding-top:14px}
.sub-section h3{margin:0 0 10px;font-size:1.05rem}

.related-section{margin-top:20px;border-top:1px dashed #ccc;padding-top:14px}
.related-section h3{margin:0 0 8px;font-size:1rem;color:#444}
.related-list{list-style:none;padding:0;margin:0}
.related-list li{padding:3px 0}

@media(max-width:700px){
main{padding:8px}
.tabs{overflow-x:auto;flex-wrap:nowrap}
.tab-btn{padding:8px 10px;font-size:.82rem}
th,td{padding:5px 6px;font-size:.82rem}
}

/* Column toggles */
.col-toggle{margin-bottom:8px}
.col-toggle summary{cursor:pointer;font-size:.84rem;color:#555;user-select:none;padding:4px 0}
.col-toggle summary:hover{color:#0056b3}
.col-toggle .col-checks{display:flex;flex-wrap:wrap;gap:2px 12px;padding:6px 0}
.col-toggle label{font-size:.82rem;display:flex;align-items:center;gap:4px;cursor:pointer;white-space:nowrap}
.col-toggle label input{margin:0}

/* Export */
.export-bar{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;align-items:center}
.export-bar button{font-size:.8rem;padding:4px 10px}
.export-bar .export-label{font-size:.82rem;color:#555}

/* Permalink */
.permalink{display:flex;align-items:center;gap:8px;margin-bottom:12px;font-size:.84rem}
.permalink a{color:#0056b3;word-break:break-all}
.permalink button{padding:4px 10px;font-size:.8rem;flex-shrink:0}

/* Pending detail */
.pending-detail{background:#e8f0fe;border:1px solid #90caf9;border-radius:6px;padding:12px 16px;margin-bottom:16px;font-size:.9rem;color:#1565c0}

/* RDF source link */
.rdf-link{display:inline-flex;align-items:center;gap:4px;font-size:.8rem;color:#777;margin-left:12px;text-decoration:none}
.rdf-link:hover{color:#0056b3}

/* Cache status bar */
.cache-bar{display:flex;align-items:center;gap:12px;padding:10px 16px;margin-bottom:16px;background:#e6f4ea;border:1px solid #34a853;border-radius:6px;font-size:.88rem}
.cache-bar.stale{background:#fff8e1;border-color:#f9a825}
.cache-bar .cache-info{flex:1}
.cache-bar button{font-size:.82rem;padding:5px 12px}

/* Management overlay */
#mgmt-overlay{display:none;position:fixed;inset:0;z-index:2000;background:rgba(0,0,0,.45);align-items:center;justify-content:center}
#mgmt-overlay.visible{display:flex}
#mgmt-panel{background:#fff;border-radius:8px;width:90%;max-width:750px;max-height:85vh;overflow-y:auto;padding:28px;box-shadow:0 8px 32px rgba(0,0,0,.25)}
#mgmt-panel h2{margin:0 0 4px;font-size:1.2rem}
#mgmt-panel .mgmt-sub{color:#666;font-size:.85rem;margin:0 0 16px}
.mgmt-table{width:100%;border-collapse:collapse;font-size:.85rem;margin:12px 0}
.mgmt-table th{text-align:left;padding:6px 10px;background:#f0f0f0;border-bottom:2px solid #ccc;font-weight:600}
.mgmt-table td{padding:6px 10px;border-bottom:1px solid #eee}
.mgmt-table .num{text-align:right;font-variant-numeric:tabular-nums}
.mgmt-table .date{white-space:nowrap;font-size:.82rem;color:#555}
.mgmt-table .stale{color:#e65100}
.mgmt-actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:18px;padding-top:14px;border-top:2px solid #e0e0e0}
.mgmt-actions button{font-size:.88rem;padding:8px 18px}
.mgmt-close{position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5rem;cursor:pointer;color:#666;padding:4px 8px}
.mgmt-close:hover{color:#1a1a1a}
.mgmt-status{margin-top:12px;padding:10px;border-radius:4px;font-size:.85rem;display:none}
.mgmt-status.active{display:block}
.mgmt-status.info{background:#e8f0fe;color:#1565c0}
.mgmt-status.ok{background:#e6f4ea;color:#1e4620}
.mgmt-status.err{background:#fce8e6;color:#5f1412}

/* Header layout */
header .hdr-left{flex:1}
header .hdr-right{display:flex;gap:8px;align-items:center}
header .hdr-right button{font-size:.82rem;padding:6px 14px;border-color:#fff;background:transparent;color:#fff}
header .hdr-right button:hover{background:rgba(255,255,255,.15)}
</style>
</head>
<body>
<a href="#main-content" class="skip-link">P≈ôeskoƒçit na hlavn√≠ obsah</a>
<header>
<div class="hdr-left">
<h1>Prohl√≠≈æeƒç RPP</h1>
<p>Registr pr√°v a povinnost√≠</p>
</div>
<div class="hdr-right">
<button id="btn-mgmt" type="button">‚öô Spr√°va dat</button>
</div>
</header>
<main id="main-content">
<div id="cache-bar" class="cache-bar" style="display:none" role="status">
<span class="cache-info" id="cache-info"></span>
<button id="btn-quick-update" class="secondary" type="button">Aktualizovat</button>
</div>
<div id="loading-panel" role="status" aria-live="polite"></div>
<div id="status-area" role="status" aria-live="polite"></div>

<!-- Management overlay -->
<div id="mgmt-overlay" role="dialog" aria-label="Spr√°va dat" aria-modal="true">
<div id="mgmt-panel" style="position:relative">
<button class="mgmt-close" id="mgmt-close" aria-label="Zav≈ô√≠t" type="button">&times;</button>
<h2>Spr√°va dat RPP</h2>
<p class="mgmt-sub">Cache v IndexedDB prohl√≠≈æeƒçe ‚Äî data se po prvn√≠m naƒçten√≠ ukl√°daj√≠ lok√°lnƒõ</p>
<div id="mgmt-body"></div>
<div class="mgmt-actions">
<button id="mgmt-btn-update" type="button">üîÑ Aktualizovat zmƒõny</button>
<button id="mgmt-btn-reload" class="secondary" type="button">‚ôª Naƒç√≠st v≈°e znovu</button>
<button id="mgmt-btn-clear" class="secondary" type="button" style="color:#c62828;border-color:#c62828">üóë Vymazat cache</button>
</div>
<div id="mgmt-status" class="mgmt-status"></div>
</div>
</div>

<div id="global-search-area" style="display:none">
<label for="global-search">Hledat ve v≈°ech datov√Ωch sad√°ch</label>
<div class="search-row">
<input type="search" id="global-search" placeholder="Zadejte hledan√Ω text‚Ä¶">
</div>
</div>

<div id="tabs-area" style="display:none">
<div class="tabs" role="tablist" aria-label="Datov√© sady RPP" id="tab-buttons"></div>
<div id="tab-panels"></div>
</div>

<div id="pending-detail" class="pending-detail" style="display:none"></div>
<div id="detail-overlay" role="region" aria-label="Detail z√°znamu">
<a href="#" class="back-link" id="detail-back">‚Üê Zpƒõt na seznam</a>
<div id="detail-permalink" class="permalink" style="display:none"></div>
<h2 id="detail-title"></h2>
<div id="detail-body"></div>
</div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
(function(){
'use strict';

// ===== Dataset Configuration =====
const RDF_BASE = 'https://rpp-opendata.egon.gov.cz/odrpp/zdroj/';
// Dataset configuration: all loaded from JSON distributions
const BASE_JSON = 'https://rpp-opendata.egon.gov.cz/odrpp/datovasada/';
const DS_CONFIG = [
    {key:'agendy', name:'Agendy',
     jsonUrl:BASE_JSON+'agendy.json',
     tableCols:['k√≥d','n√°zev','platnost-od','definice-slu≈æeb','definice-√∫daj≈Ø'],
     idPrefix:'agenda/'},
    {key:'ovm', name:'Org√°ny ve≈ôejn√© moci',
     jsonUrl:BASE_JSON+'ovm.json',
     tableCols:['identifik√°tor','n√°zev','iƒço','osoba-v-ƒçele','vnit≈ôn√≠-organizaƒçn√≠-jednotka','nad≈ô√≠zen√Ω-ovm'],
     idPrefix:'org√°n-ve≈ôejn√©-moci/'},
    {key:'pusobnost', name:'P≈Øsobnost v agend√°ch',
     jsonUrl:BASE_JSON+'pusobnost_v_agendach.json',
     tableCols:['agenda','zdroj','ƒçinnosti','datum-registrace'],
     idPrefix:'p≈Øsobnost/', manualOnly:true},
    {key:'isvs', name:'ISVS',
     jsonUrl:BASE_JSON+'isvs.json',
     tableCols:['identifik√°tor','n√°zev','agendy','spr√°vce-isvs','typ-etapy','vytvo≈ôen√≠'],
     idPrefix:'isvs/'},
    {key:'sluzby', name:'Slu≈æby VS',
     jsonUrl:BASE_JSON+'sluzby.json',
     tableCols:['identifik√°tor','n√°zev','agenda','typ-slu≈æby'],
     idPrefix:'slu≈æba-ve≈ôejn√©-spr√°vy/'},
    {key:'udaje', name:'Objekty a subjekty √∫daj≈Ø',
     jsonUrl:BASE_JSON+'udaje.json',
     tableCols:['k√≥d','n√°zev','popis','agenda'],
     idPrefix:'objekt-subjekt/'},
    {key:'opravneni', name:'Opr√°vnƒõn√≠ k √∫daj≈Øm',
     jsonUrl:BASE_JSON+'opravneni_k_udajum.json',
     tableCols:['k√≥d','z-agendy','do-agendy','typ-opr√°vnƒõn√≠'],
     idPrefix:'opr√°vnƒõn√≠-k-p≈ô√≠stupu-k-√∫daj≈Øm/'},
    {key:'role', name:'Role (p≈Øsobnost)',
     jsonUrl:BASE_JSON+'role.json',
     tableCols:['ovm','agenda','ƒçinnost','k√≥d'],
     idPrefix:'role/', large:true},
    {key:'spuu', name:'SPU√ö',
     jsonUrl:BASE_JSON+'spuu.json',
     tableCols:['identifik√°tor','n√°zev','iƒço','stav'],
     idPrefix:'soukromopr√°vn√≠-u≈æivatel-√∫daj≈Ø/'},
    {key:'cinnosti', name:'ƒåinnosti',
     jsonUrl:BASE_JSON+'cinnosti.json',
     tableCols:['k√≥d-agendy','n√°zev-agendy','k√≥d','n√°zev','popis'],
     idPrefix:'ƒçinnost/', virtual:true},
    {key:'kategorie', name:'Kategorie OVM',
     jsonUrl:BASE_JSON+'kategorie_ovm.json',
     tableCols:['k√≥d','n√°zev','ohla≈°ovatel','agendy'],
     idPrefix:'kategorie-ovm/'},
];

// ===== State =====
const datasets = {}; // key ‚Üí {config, records:[], loaded:false}
const globalIndex = new Map(); // id ‚Üí {dsKey, idx, title}
const reverseIndex = new Map(); // refId ‚Üí [{dsKey, idx, title}]
const bareIndex = new Map(); // bare value (IƒåO, k√≥d) ‚Üí full ref ID
let activeTab = null;
const tabStates = {}; // key ‚Üí {page, sort, search, filters}

// ===== IndexedDB Cache =====
const IDB_NAME = 'rpp-prohlizec';
const IDB_VERSION = 20;
const IDB_STORE = 'datasets';
const IDB_META = 'meta';

function openDB(){
    return new Promise((resolve,reject)=>{
        const req=indexedDB.open(IDB_NAME, IDB_VERSION);
        req.onupgradeneeded=e=>{
            const db=e.target.result;
            if(!db.objectStoreNames.contains(IDB_STORE))db.createObjectStore(IDB_STORE);
            if(!db.objectStoreNames.contains(IDB_META))db.createObjectStore(IDB_META);
        };
        req.onsuccess=()=>resolve(req.result);
        req.onerror=()=>reject(req.error);
    });
}

async function idbGet(storeName, key){
    const db=await openDB();
    return new Promise((resolve,reject)=>{
        const tx=db.transaction(storeName,'readonly');
        const req=tx.objectStore(storeName).get(key);
        req.onsuccess=()=>resolve(req.result);
        req.onerror=()=>reject(req.error);
    });
}

async function idbPut(storeName, key, value){
    const db=await openDB();
    return new Promise((resolve,reject)=>{
        const tx=db.transaction(storeName,'readwrite');
        tx.objectStore(storeName).put(value, key);
        tx.oncomplete=()=>resolve();
        tx.onerror=()=>reject(tx.error);
    });
}

async function idbDelete(storeName, key){
    const db=await openDB();
    return new Promise((resolve,reject)=>{
        const tx=db.transaction(storeName,'readwrite');
        tx.objectStore(storeName).delete(key);
        tx.oncomplete=()=>resolve();
        tx.onerror=()=>reject(tx.error);
    });
}

async function idbClear(){
    const db=await openDB();
    return new Promise((resolve,reject)=>{
        const tx=db.transaction([IDB_STORE,IDB_META],'readwrite');
        tx.objectStore(IDB_STORE).clear();
        tx.objectStore(IDB_META).clear();
        tx.oncomplete=()=>resolve();
        tx.onerror=()=>reject(tx.error);
    });
}

async function getCachedDataset(key){
    try{return await idbGet(IDB_STORE, key)}catch(e){return null}
}

async function saveCachedDataset(key, records){
    try{
        await idbPut(IDB_STORE, key, {records, savedAt:Date.now(), count:records.length});
    }catch(e){console.warn('Cache save failed for '+key, e)}
}

async function getCacheMeta(){
    try{return (await idbGet(IDB_META, 'sync'))||{}}catch(e){return{}}
}

async function saveCacheMeta(meta){
    try{await idbPut(IDB_META, 'sync', meta)}catch(e){}
}

// Date property names per dataset (for incremental update detection)
const DATE_PROPS = {
    'agendy': 'https://slovn√≠k.gov.cz/agendov√Ω/104/pojem/m√°-datum-posledn√≠-zmƒõny-agendy',
    'ovm': 'https://slovn√≠k.gov.cz/legislativn√≠/sb√≠rka/111/2009/pojem/m√°-datum-zah√°jen√≠-v√Ωkonu-p≈Øsobnosti-org√°nu-ve≈ôejn√©-moci',
    'isvs': 'https://slovn√≠k.gov.cz/agendov√Ω/104/pojem/m√°-datum-posledn√≠-zmƒõny-isvs',
};

// ===== DOM =====
const $=id=>document.getElementById(id);
const elLoading=$('loading-panel'), elStatus=$('status-area');
const elGlobalSearch=$('global-search-area'), elGlobalInput=$('global-search');
const elTabsArea=$('tabs-area'), elTabButtons=$('tab-buttons'), elTabPanels=$('tab-panels');
const elDetail=$('detail-overlay'), elDetailBack=$('detail-back'), elDetailTitle=$('detail-title'), elDetailBody=$('detail-body');
const elDetailPermalink=$('detail-permalink'), elPendingDetail=$('pending-detail');

// ===== Helpers =====
function cs(val){
    if(val==null)return null;
    if(typeof val==='object'&&!Array.isArray(val)&&'cs' in val)return val.cs;
    return val;
}
function humanize(k){return k.replace(/([A-Z])/g,' $1').replace(/[-_]/g,' ').replace(/^\w/,c=>c.toUpperCase()).trim()}
function fmtDate(v){try{const d=new Date(v);return isNaN(d)?String(v):d.toLocaleDateString('cs')}catch(e){return String(v)}}
function shortenUrl(u){try{const x=new URL(u);return x.hostname+x.pathname.substring(0,40)}catch(e){return u.substring(0,60)}}

function codedLabel(val){
    if(typeof val!=='string')return null;
    const i=val.lastIndexOf('/');
    if(i<1||i>=val.length-1)return null;
    const code=val.substring(i+1);
    if(!/^[A-Z0-9_]+$/.test(code))return null;
    const labels={'VLASTNI':'Vlastn√≠','REFERENCNI':'Referenƒçn√≠','NESDILENY':'Nesd√≠len√Ω','SDILENY':'Sd√≠len√Ω',
        'NEMA_NOTIFIKACI':'Nem√° notifikaci','MA_NOTIFIKACI':'M√° notifikaci','KLIENT':'Klient','MOCI_UREDNI':'Z moci √∫≈ôedn√≠',
        'ON_PREMISE':'On-premise','CLOUD':'Cloud','CENTRALNI':'Centr√°ln√≠','DECENTRAL':'Decentr√°ln√≠',
        'ZO':'Z√°kladn√≠ opr√°vnƒõn√≠','RO':'Roz≈°√≠≈ôen√© opr√°vnƒõn√≠','FO':'Fyzick√° osoba','PO':'Pr√°vnick√° osoba','PFO':'Podnikaj√≠c√≠ FO',
        'ROZVOJ':'Rozvoj','PROVOZ':'Provoz','VYVOJ':'V√Ωvoj','UKONCEN':'Ukonƒçen'};
    const cls={'VLASTNI':'b-gray','REFERENCNI':'b-blue','KLIENT':'b-green','MOCI_UREDNI':'b-red','ROZVOJ':'b-green','PROVOZ':'b-blue','UKONCEN':'b-red'};
    return{label:labels[code]||code.replace(/_/g,' '),badgeClass:cls[code]||'b-gray'};
}

function valToString(val){
    if(val==null||val==='')return'';
    val=cs(val);if(val==null)return'';
    if(typeof val==='object'){
        if(Array.isArray(val))return val.map(valToString).join(', ');
        return val.oznaƒçen√≠||val.n√°zev||val.name||val.label||Object.values(val).filter(v=>typeof v==='string').join(', ')||'';
    }
    return String(val);
}

function isRefId(val){
    if(typeof val!=='string')return false;
    // Exclude nodeID:// blank nodes and HTTP URLs
    if(val.startsWith('nodeID://')||val.startsWith('http://')||val.startsWith('https://'))return false;
    return/^[a-z√°ƒçƒè√©ƒõ√≠≈à√≥≈ô≈°≈•√∫≈Ø√Ω≈æ-]+\/[A-Za-z0-9._/-]+$/i.test(val)&&val.includes('/');
}

function resolveRef(id){
    const direct=globalIndex.get(id);
    if(direct)return direct;
    const resolved=bareIndex.get(id);
    if(resolved)return globalIndex.get(resolved)||null;
    return null;
}

// ===== JSON Loading =====

// Streaming JSON parser ‚Äî reads file in small chunks, never loads entire file into memory.
// Tracks brace depth to find individual records, parses each one separately.
// Handles 620MB+ files that would crash JSON.parse() or FileReader.readAsText().
async function streamParseJSON(file, onProgress){
    const CHUNK=5*1024*1024; // 5 MB
    const records=[];
    let phase='header'; // header ‚Üí records ‚Üí done
    let depth=0;
    let inStr=false;
    let esc=false;
    let recBuf='';
    let recStarted=false;
    let totalRead=0;

    for(let offset=0;offset<file.size;offset+=CHUNK){
        const end=Math.min(offset+CHUNK,file.size);
        const chunk=await file.slice(offset,end).text();
        totalRead+=chunk.length;

        for(let i=0;i<chunk.length;i++){
            const ch=chunk[i];
            if(recStarted)recBuf+=ch;
            if(inStr){
                if(esc){esc=false;continue}
                if(ch==='\\'){esc=true;continue}
                if(ch==='"')inStr=false;
                continue;
            }
            if(ch==='"'){inStr=true;if(recStarted){}else continue;continue}
            if(phase==='header'){
                if(ch==='['){phase='records';depth=0}
                continue;
            }
            if(phase==='done')break;
            if(ch==='{'){
                depth++;
                if(depth===1&&!recStarted){recStarted=true;recBuf='{'}
            }else if(ch==='}'){
                depth--;
                if(depth===0&&recStarted){
                    try{records.push(JSON.parse(recBuf))}catch(e){/* skip bad record */}
                    recBuf='';recStarted=false;
                }
            }else if(ch===']'&&depth===0&&!recStarted){
                phase='done';
            }
        }
        onProgress(totalRead,records.length);
        await new Promise(r=>setTimeout(r,0)); // yield to UI
    }
    return records;
}

// Streaming fetch with progress bar ‚Äî for medium datasets loaded via HTTP
async function fetchJsonWithProgress(url, onProgress){
    const resp=await fetch(url);
    if(!resp.ok) throw new Error('HTTP '+resp.status+' '+resp.statusText);
    const contentLength=resp.headers.get('content-length');
    const totalBytes=contentLength?parseInt(contentLength):0;
    
    if(!resp.body){
        // Fallback: no streaming support
        const data=await resp.json();
        return data;
    }
    const reader=resp.body.getReader();
    const decoder=new TextDecoder();
    let receivedBytes=0;
    let chunks=[];
    
    while(true){
        const {done,value}=await reader.read();
        if(done)break;
        receivedBytes+=value.length;
        chunks.push(value);
        if(onProgress){
            const mb=(receivedBytes/1024/1024).toFixed(1);
            const pct=totalBytes>0?Math.round(receivedBytes/totalBytes*100):'?';
            onProgress(mb, pct);
        }
    }
    // Combine chunks and parse
    const fullArray=new Uint8Array(receivedBytes);
    let pos=0;
    for(const chunk of chunks){fullArray.set(chunk,pos);pos+=chunk.length}
    return JSON.parse(decoder.decode(fullArray));
}

// Manual file load fallback for large datasets
function showManualFallback(cfg, li){
    const fb=document.createElement('div');fb.className='load-fallback';
    const p1=document.createElement('span');
    const dl=document.createElement('a');dl.href=cfg.jsonUrl;dl.textContent='1. Prav√Ω klik zde ‚Üí Ulo≈æit odkaz jako‚Ä¶';
    dl.title='Prav√Ω klik ‚Üí Ulo≈æit odkaz jako‚Ä¶';
    p1.appendChild(dl);
    p1.appendChild(document.createTextNode(', pak '));
    fb.appendChild(p1);

    const lbl=document.createElement('label');
    lbl.textContent='2. vyberte ulo≈æen√Ω soubor: ';
    const inp=document.createElement('input');inp.type='file';inp.accept='.json,.jsonld';
    lbl.appendChild(inp);
    fb.appendChild(lbl);

    const btnRow=document.createElement('div');btnRow.style.cssText='margin-top:8px;display:flex;gap:8px;align-items:center';
    const btnLoad=document.createElement('button');btnLoad.textContent='3. Naƒç√≠st a zpracovat';btnLoad.disabled=true;
    const progress=document.createElement('span');progress.style.cssText='font-size:0.85rem;color:#555';

    inp.addEventListener('change',()=>{
        btnLoad.disabled=!inp.files||!inp.files[0];
        if(inp.files&&inp.files[0])progress.textContent='('+Math.round(inp.files[0].size/1024/1024)+' MB)';
    });

    btnLoad.addEventListener('click',async()=>{
        if(!inp.files||!inp.files[0])return;
        const file=inp.files[0];
        const totalMB=(file.size/1024/1024).toFixed(0);
        btnLoad.disabled=true;
        li.icon.textContent='‚è≥';li.icon.className='load-icon load-wait';

        try{
            const records=await streamParseJSON(file,(readBytes,recCount)=>{
                const pct=Math.round(readBytes/file.size*100);
                const readMB=(readBytes/1024/1024).toFixed(0);
                progress.textContent=readMB+' / '+totalMB+' MB ('+pct+'%), '+recCount.toLocaleString('cs')+' z√°znam≈Ø';
                li.text.textContent=cfg.name+' ‚Äî '+pct+'%';
            });
            // Process records
            const processed=records.map(item=>processJsonRecord(item,cfg));
            datasets[cfg.key].records=processed;
            datasets[cfg.key].loaded=true;
            li.icon.textContent='‚úì';li.icon.className='load-icon load-ok';
            li.text.textContent=cfg.name+' ('+processed.length.toLocaleString('cs')+')';
            progress.textContent='Budov√°n√≠ indexu vazeb‚Ä¶';
            await new Promise(r=>setTimeout(r,50));
            // Save to cache
            try{await saveCachedDataset(cfg.key,processed);
                const meta=await getCacheMeta()||{datasets:{}};
                meta.datasets[cfg.key]={count:processed.length,source:'json-manual',savedAt:Date.now()};
                meta.lastSync=Date.now();await saveCacheMeta(meta);
            }catch(e){}
            buildVirtualCinnosti();
            buildIndex();
            fb.remove();
            // Update load item to show success
            li.div.querySelector('.load-fallback')?.remove();
            // Hide pending-bar if no more fallbacks remain
            const pbar=$('pending-bar');
            if(pbar&&!pbar.querySelector('.load-fallback')){pbar.remove()}
            // Refresh UI
            buildTabs();
            if(activeTab)renderDatasetPanel(activeTab);
        }catch(err){
            li.icon.textContent='‚úó';li.icon.className='load-icon load-err';
            li.text.textContent=cfg.name+' ‚Äî chyba';
            progress.textContent=err.message;
            btnLoad.disabled=false;btnLoad.textContent='3. Naƒç√≠st a zpracovat';
        }
    });
    btnRow.appendChild(btnLoad);

    const btnSkip=document.createElement('button');btnSkip.textContent='P≈ôeskoƒçit';btnSkip.className='secondary';
    btnSkip.addEventListener('click',()=>{
        li.div.style.display='none';
        const pbar=$('pending-bar');
        if(pbar){
            const visibleItems=[...pbar.querySelectorAll('.load-item')].filter(x=>x.style.display!=='none');
            if(visibleItems.length===0) pbar.remove();
        }
    });
    btnRow.appendChild(btnSkip);
    btnRow.appendChild(progress);
    fb.appendChild(btnRow);
    li.div.appendChild(fb);
}

// Extract synthetic references from URI patterns (for Role, ƒåinnost etc.)
function enrichFromUri(rec){
    const id=rec.id;
    if(!id)return;
    // Role: role/{agendaCode}/{ƒçinnostCode}/{ovmIƒåO}
    const roleMatch=id.match(/^role\/([^/]+)\/([^/]+)\/([^/]+)$/);
    if(roleMatch){
        if(!rec.agenda) rec.agenda='agenda/'+roleMatch[1];
        if(!rec.ƒçinnost) rec.ƒçinnost='ƒçinnost/'+roleMatch[1]+'/'+roleMatch[2];
        if(!rec.ovm) rec.ovm='org√°n-ve≈ôejn√©-moci/'+roleMatch[3];
        if(!rec.k√≥d) rec.k√≥d=roleMatch[1]+'/'+roleMatch[2];
        return;
    }
    // ƒåinnost: ƒçinnost/{agendaCode}/{ƒçinnostCode}
    const cinMatch=id.match(/^ƒçinnost\/([^/]+)\/([^/]+)$/);
    if(cinMatch){
        if(!rec.agenda) rec.agenda='agenda/'+cinMatch[1];
        if(!rec.k√≥d) rec.k√≥d=cinMatch[2];
        return;
    }
    // Kategorie OVM: kategorie-ovm/KOxxx
    const katMatch=id.match(/^kategorie-ovm\/(KO\d+)$/);
    if(katMatch){
        rec.k√≥d=katMatch[1];
        return;
    }
    // Agenda: agenda/Axxx
    const agMatch=id.match(/^agenda\/(A\d+)$/);
    if(agMatch){
        if(!rec.k√≥d) rec.k√≥d=agMatch[1];
        return;
    }
    // P≈Øsobnost: p≈Øsobnost/{agendaCode}/{entityId}
    const pusMatch=id.match(/^p≈Øsobnost\/([^/]+)\/([^/]+)$/);
    if(pusMatch){
        rec.agenda='agenda/'+pusMatch[1];
        const entityId=pusMatch[2];
        if(entityId.startsWith('KO')){
            rec.kategorie='kategorie-ovm/'+entityId;
            rec.zdroj='kategorie-ovm/'+entityId;
        }else{
            rec.ovm='org√°n-ve≈ôejn√©-moci/'+entityId;
            rec.zdroj='org√°n-ve≈ôejn√©-moci/'+entityId;
        }
        rec.k√≥d=pusMatch[1]+'/'+entityId;
        return;
    }
}

// OVM-specific JSON record conversion (handles nested objects, seznam-kategori√≠ etc.)
function jsonItemToRecord(item){
    const rec={};
    if(!item||typeof item!=='object')return rec;
    if(item.id) rec.id=item.id;
    const simpleProps=['identifik√°tor','iƒço','vnit≈ôn√≠-organizaƒçn√≠-jednotka',
        'zah√°jen√≠','ukonƒçen√≠','pozastaven√≠-od','pozastaven√≠-do','p≈ôeru≈°en√≠-od','p≈ôeru≈°en√≠-do'];
    for(const p of simpleProps){
        if(item[p]!==undefined) rec[p]=item[p];
    }
    if(item['n√°zev']) rec['n√°zev']=item['n√°zev'];
    if(item['nad≈ô√≠zen√Ω-ovm']) rec['nad≈ô√≠zen√Ω-ovm']=item['nad≈ô√≠zen√Ω-ovm'];
    if(item['pr√°vn√≠-forma']) rec['pr√°vn√≠-forma']=item['pr√°vn√≠-forma'];
    if(item['seznam-kategori√≠']&&Array.isArray(item['seznam-kategori√≠'])){
        const katIds=[];
        for(const sk of item['seznam-kategori√≠']){
            if(sk.kategorie) katIds.push(sk.kategorie);
        }
        if(katIds.length>0) rec['kategorie-ovm']=katIds.length===1?katIds[0]:katIds;
    }
    if(item['osoba-v-ƒçele']&&Array.isArray(item['osoba-v-ƒçele'])){
        const names=item['osoba-v-ƒçele'].map(o=>o['jm√©no']).filter(Boolean);
        if(names.length===1) rec['osoba-v-ƒçele']=names[0];
        else if(names.length>1) rec['osoba-v-ƒçele']=names;
    }
    if(item['datov√©-schr√°nky']&&Array.isArray(item['datov√©-schr√°nky'])){
        rec['datov√©-schr√°nky']=item['datov√©-schr√°nky'];
    }
    if(item['ustanoven√≠-esb√≠rka']) rec['ustanoven√≠-esb√≠rka']=item['ustanoven√≠-esb√≠rka'];
    if(item['ustanoven√≠-ostatn√≠']) rec['ustanoven√≠-ostatn√≠']=item['ustanoven√≠-ostatn√≠'];
    if(item['adresa-s√≠dla']) rec['adresa-s√≠dla']=item['adresa-s√≠dla'];
    if(item['adresa-m√≠sta-pobytu']) rec['adresa-m√≠sta-pobytu']=item['adresa-m√≠sta-pobytu'];
    if(item['pracovi≈°tƒõ-ovm']&&Array.isArray(item['pracovi≈°tƒõ-ovm'])){
        rec['pracovi≈°tƒõ-ovm']=item['pracovi≈°tƒõ-ovm'];
    }
    return rec;
}

// P≈Øsobnost-specific: flatten registrace nested object
function flattenPusobnostRecord(item){
    const rec={};
    if(item.id) rec.id=item.id;
    // Flatten registrace: {agenda, ovm, spu√∫, datum} ‚Üí top-level
    if(item.registrace&&typeof item.registrace==='object'){
        if(item.registrace.agenda) rec.agenda=item.registrace.agenda;
        if(item.registrace.ovm) rec.ovm=item.registrace.ovm;
        if(item.registrace.spu√∫) rec.spu√∫=item.registrace.spu√∫;
        if(item.registrace.datum) rec['datum-registrace']=item.registrace.datum;
    }
    // ƒçinnosti ‚Äî direct array from JSON!
    if(item['ƒçinnosti']) rec['ƒçinnosti']=item['ƒçinnosti'];
    // slu≈æby
    if(item['slu≈æby']) rec['slu≈æby']=item['slu≈æby'];
    // Copy remaining scalar props
    for(const[k,v] of Object.entries(item)){
        if(k==='registrace'||k==='id'||k==='type'||k==='ƒçinnosti'||k==='slu≈æby')continue;
        if(!(k in rec)) rec[k]=v;
    }
    // Build zdroj field: OVM or kategorie
    if(rec.ovm) rec.zdroj=rec.ovm;
    else if(rec.kategorie) rec.zdroj=rec.kategorie;
    return rec;
}

// Generic JSON record processing
function processJsonRecord(item, cfg){
    if(!item||typeof item!=='object')return item;
    // Dataset-specific processing
    if(cfg.key==='ovm') return jsonItemToRecord(item);
    if(cfg.key==='pusobnost') { const rec=flattenPusobnostRecord(item); enrichFromUri(rec); return rec; }
    // Generic: keep as-is but run enrichFromUri
    const rec={...item};
    if(rec.type) delete rec.type; // Remove JSON-LD type field
    enrichFromUri(rec);
    return rec;
}

// Load a single dataset from JSON
async function loadJsonDataset(cfg, li){
    li.text.textContent=cfg.name+' ‚Äî stahov√°n√≠‚Ä¶';
    li.icon.textContent='‚è≥';li.icon.className='load-icon load-wait';
    
    try{
        const data=await fetchJsonWithProgress(cfg.jsonUrl, (mb,pct)=>{
            li.text.textContent=cfg.name+' ‚Äî sta≈æeno '+mb+' MB'+(pct!=='?'?' ('+pct+'%)':'');
        });
        
        let rawItems=[];
        if(Array.isArray(data))rawItems=data;
        else if(data.polo≈æky)rawItems=data.polo≈æky;
        else{
            const ak=Object.keys(data).find(k=>Array.isArray(data[k]));
            if(ak)rawItems=data[ak];
        }
        
        li.text.textContent=cfg.name+' ‚Äî zpracov√°n√≠ '+rawItems.length.toLocaleString('cs')+' z√°znam≈Ø‚Ä¶';
        await new Promise(r=>setTimeout(r,10)); // yield to UI
        
        const records=rawItems.map(item=>processJsonRecord(item,cfg));
        datasets[cfg.key].records=records;
        datasets[cfg.key].loaded=true;
        li.icon.textContent='‚úì';li.icon.className='load-icon load-ok';
        li.text.textContent=cfg.name+' ('+records.length.toLocaleString('cs')+')';
        
        // Save to cache
        try{
            await saveCachedDataset(cfg.key,records);
        }catch(e){}
        
        return records;
    }catch(err){
        if(cfg.optional){
            li.icon.textContent='‚Äî';li.icon.className='load-icon';
            li.text.textContent=cfg.name+' ‚Äî nedostupn√© (voliteln√° sada)';
            return [];
        }
        throw err;
    }
}

// ===== Loading =====
async function loadAll(forceReload){
    // Initialize dataset containers
    DS_CONFIG.forEach(cfg=>{
        datasets[cfg.key]={config:cfg,records:[],loaded:false};
    });

    if(!forceReload){
        // Try loading from IndexedDB cache
        const meta=await getCacheMeta();
        if(meta && meta.datasets && Object.keys(meta.datasets).length>0){
            elLoading.innerHTML='<h2>Naƒç√≠t√°n√≠ z cache‚Ä¶</h2>';
            const prog=document.createElement('div');prog.id='loading-progress';elLoading.appendChild(prog);
            let cachedCount=0;
            for(const cfg of DS_CONFIG){
                const cached=await getCachedDataset(cfg.key);
                if(cached && cached.records){
                    datasets[cfg.key].records=cached.records;
                    datasets[cfg.key].loaded=true;
                    cachedCount+=cached.records.length;
                }
            }
            if(cachedCount>0){
                prog.textContent='Budov√°n√≠ indexu‚Ä¶';
                await new Promise(r=>setTimeout(r,10));
                buildVirtualCinnosti();
            buildIndex();
                finishLoading();
                showCacheBar(meta);
                return;
            }
        }
    }

    // No cache or forced ‚Äî load from JSON
    elLoading.style.display='block';
    elLoading.innerHTML='<h2>Naƒç√≠t√°n√≠ datov√Ωch sad RPP z JSON‚Ä¶</h2>';

    const loadItems={};
    DS_CONFIG.forEach(cfg=>{
        const div=document.createElement('div');div.className='load-item';div.id='load-'+cfg.key;
        const icon=document.createElement('span');icon.className='load-icon load-wait';icon.textContent='‚è≥';
        const text=document.createElement('span');
        text.textContent=cfg.name+(cfg.large?' (velk√° sada ‚Äî ruƒçn√≠ naƒçten√≠)':'');
        div.appendChild(icon);div.appendChild(text);
        elLoading.appendChild(div);
        loadItems[cfg.key]={div,icon,text};
    });
    const prog=document.createElement('div');prog.id='loading-progress';prog.textContent='Zahajuji‚Ä¶';
    elLoading.appendChild(prog);

    let done=0;
    const meta={datasets:{},lastSync:Date.now()};

    // Load datasets in parallel (small ones) and show manual fallback for large/manual ones
    const promises=DS_CONFIG.map(async cfg=>{
        const li=loadItems[cfg.key];
        if(cfg.virtual){
            // Virtual dataset: built from other datasets, not fetched
            li.icon.textContent='‚Äî';li.icon.className='load-icon';
            li.text.textContent=cfg.name+' ‚Äî odvozeno z jin√Ωch sad';
        }else if(cfg.manualOnly){
            // Manual-only datasets: handled by pending bar after load completes
            li.icon.textContent='üìÅ';li.icon.className='load-icon';
            li.text.textContent=cfg.name+' ‚Äî ruƒçn√≠ naƒçten√≠ po dokonƒçen√≠';
        }else if(cfg.large){
            // Large datasets: try auto-fetch first, mark as pending if fails
            li.icon.textContent='‚è≥';li.icon.className='load-icon load-wait';
            li.text.textContent=cfg.name+' ‚Äî zkou≈°√≠m automatick√© sta≈æen√≠‚Ä¶';
            try{
                await loadJsonDataset(cfg,li);
                meta.datasets[cfg.key]={count:datasets[cfg.key].records.length,source:'json',savedAt:Date.now()};
            }catch(e){
                li.icon.textContent='üìÅ';li.icon.className='load-icon';
                li.text.textContent=cfg.name+' ‚Äî ruƒçn√≠ naƒçten√≠ ('+e.message+')';
            }
        }else{
            try{
                await loadJsonDataset(cfg,li);
                meta.datasets[cfg.key]={count:datasets[cfg.key].records.length,source:'json',savedAt:Date.now()};
            }catch(e){
                if(!cfg.optional){
                    li.icon.textContent='‚úó';li.icon.className='load-icon load-err';
                    li.text.textContent=cfg.name+' ‚Äî '+e.message;
                }
            }
        }
        done++;
        prog.textContent=done+' / '+DS_CONFIG.length+' sad';
    });

    await Promise.all(promises);

    // Save cache meta
    try{await saveCacheMeta(meta)}catch(e){}

    prog.textContent='Budov√°n√≠ indexu vazeb‚Ä¶';
    await new Promise(r=>setTimeout(r,50));
    buildVirtualCinnosti();
    buildIndex();
    finishLoading();
}

function finishLoading(){
    setTimeout(()=>{
        // Always hide the loading panel ‚Äî manual fallback panels move to a subtle bar
        elLoading.style.display='none';

        elGlobalSearch.style.display='block';
        elTabsArea.style.display='block';
        buildTabs();
        const firstLoaded=DS_CONFIG.find(c=>datasets[c.key].loaded&&datasets[c.key].records.length>0);
        if(firstLoaded && !activeTab)activateTab(firstLoaded.key);
        else if(activeTab){
            for(const k of Object.keys(tabStates)){tabStates[k].filtered=null;tabStates[k]._allColsInit=false;delete tabStates[k].visibleCols}
            renderDatasetPanel(activeTab);
        }
        handleUrlParams();

        // Show pending manual loads in a subtle notification bar
        const pendingCfgs=DS_CONFIG.filter(c=>!c.optional&&!datasets[c.key]?.loaded);
        if(pendingCfgs.length>0){
            showPendingBar(pendingCfgs);
        }
    },200);
}

function showPendingBar(pendingCfgs){
    let bar=$('pending-bar');
    if(!bar){
        bar=document.createElement('div');bar.id='pending-bar';
        bar.style.cssText='background:#fff8e1;border:1px solid #f9a825;border-radius:6px;padding:12px 16px;margin-bottom:16px';
        const main=document.querySelector('main');
        main.insertBefore(bar,main.firstChild);
    }
    bar.innerHTML='';
    const hdr=document.createElement('div');
    hdr.style.cssText='font-weight:600;margin-bottom:8px';
    hdr.textContent='Velk√© datov√© sady (ruƒçn√≠ naƒçten√≠)';
    bar.appendChild(hdr);
    const note=document.createElement('div');
    note.style.cssText='font-size:.85rem;color:#555;margin-bottom:8px';
    note.textContent='Tyto sady se nepoda≈ôilo naƒç√≠st automaticky. St√°hnƒõte soubor ruƒçnƒõ a nahrajte ho zde. Po naƒçten√≠ se ulo≈æ√≠ do cache prohl√≠≈æeƒçe a p≈ô√≠≈°tƒõ se naƒçtou automaticky.';
    bar.appendChild(note);
    for(const cfg of pendingCfgs){
        const row=document.createElement('div');row.className='load-item';row.style.cssText='padding:4px 0';
        const icon=document.createElement('span');icon.className='load-icon';icon.textContent='üìÅ';
        const text=document.createElement('span');text.textContent=cfg.name;
        row.appendChild(icon);row.appendChild(text);
        bar.appendChild(row);
        showManualFallback(cfg,{div:row,icon,text});
    }
}

function showCacheBar(meta){
    const bar=$('cache-bar');
    const info=$('cache-info');
    if(!bar||!info||!meta)return;
    const totalRecs=Object.values(datasets).reduce((s,d)=>s+d.records.length,0);
    const dsCount=Object.values(datasets).filter(d=>d.loaded&&d.records.length>0).length;
    const age=meta.lastSync?Date.now()-meta.lastSync:0;
    const ageText=age<60000?'p≈ôed chv√≠l√≠':age<3600000?Math.round(age/60000)+' min':age<86400000?Math.round(age/3600000)+' hod':Math.round(age/86400000)+' dn√≠';
    info.textContent=`${dsCount} sad, ${totalRecs.toLocaleString('cs')} z√°znam≈Ø ‚Äî naƒçteno z cache (${ageText})`;
    bar.className='cache-bar'+(age>86400000?' stale':'');
    bar.style.display='flex';
}

// ===== Management Panel =====
function openMgmt(){
    renderMgmt();
    $('mgmt-overlay').classList.add('visible');
}
function closeMgmt(){
    $('mgmt-overlay').classList.remove('visible');
}

async function renderMgmt(){
    const body=$('mgmt-body');
    const meta=await getCacheMeta()||{};
    const dsMeta=meta.datasets||{};
    body.innerHTML='';

    // Summary
    const totalRecs=Object.values(datasets).reduce((s,d)=>s+d.records.length,0);
    const summary=document.createElement('p');
    summary.style.cssText='font-size:.9rem;margin:0 0 12px';
    const lastSync=meta.lastSync?new Date(meta.lastSync).toLocaleString('cs'):'nikdy';
    summary.textContent=`Celkem ${totalRecs.toLocaleString('cs')} z√°znam≈Ø v pamƒõti ‚Äî posledn√≠ synchronizace: ${lastSync}`;
    body.appendChild(summary);

    // Table
    const table=document.createElement('table');table.className='mgmt-table';
    const thead=document.createElement('thead');
    thead.innerHTML='<tr><th>Datov√° sada</th><th>V cache</th><th>Ulo≈æeno</th><th>St√°≈ô√≠</th></tr>';
    table.appendChild(thead);
    const tbody=document.createElement('tbody');

    for(const cfg of DS_CONFIG){
        const tr=document.createElement('tr');
        const dm=dsMeta[cfg.key];
        const ds=datasets[cfg.key];
        const count=ds?ds.records.length:0;

        const tdName=document.createElement('td');tdName.textContent=cfg.name;
        const tdCount=document.createElement('td');tdCount.className='num';
        tdCount.textContent=count>0?count.toLocaleString('cs'):'‚Äî';
        if(!dm&&count===0)tdCount.style.color='#999';

        const tdDate=document.createElement('td');tdDate.className='date';
        if(dm&&dm.savedAt){
            tdDate.textContent=new Date(dm.savedAt).toLocaleString('cs');
        }else{
            tdDate.textContent='‚Äî';tdDate.style.color='#999';
        }

        const tdAge=document.createElement('td');tdAge.className='date';
        if(dm&&dm.savedAt){
            const age=Date.now()-dm.savedAt;
            if(age>86400000){tdAge.textContent=Math.round(age/86400000)+' dn√≠';tdAge.className='date stale'}
            else if(age>3600000)tdAge.textContent=Math.round(age/3600000)+' hod';
            else tdAge.textContent=Math.round(age/60000)+' min';
        }else{tdAge.textContent='‚Äî';tdAge.style.color='#999'}

        tr.appendChild(tdName);tr.appendChild(tdCount);tr.appendChild(tdDate);tr.appendChild(tdAge);
        tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    body.appendChild(table);

    // Estimate cache size
    try{
        if(navigator.storage&&navigator.storage.estimate){
            const est=await navigator.storage.estimate();
            const used=est.usage?(est.usage/1024/1024).toFixed(1)+' MB':'?';
            const quota=est.quota?(est.quota/1024/1024/1024).toFixed(1)+' GB':'?';
            const sizeP=document.createElement('p');sizeP.style.cssText='font-size:.82rem;color:#666;margin:8px 0 0';
            sizeP.textContent=`Vyu≈æit√≠ √∫lo≈æi≈°tƒõ: ~${used} z ${quota}`;
            body.appendChild(sizeP);
        }
    }catch(e){}

    setMgmtStatus('','');
}

function setMgmtStatus(text, cls){
    const el=$('mgmt-status');
    if(!el)return;
    el.textContent=text;
    el.className='mgmt-status'+(text?' active ':' ')+(cls||'');
}

async function incrementalUpdate(){
    setMgmtStatus('P≈ôenaƒç√≠t√°m data z JSON‚Ä¶','info');
    closeMgmt();
    // Reset state and reload everything from JSON
    for(const k of Object.keys(datasets)){datasets[k]={config:datasets[k].config,records:[],loaded:false}}
    globalIndex.clear();reverseIndex.clear();bareIndex.clear();
    for(const k of Object.keys(tabStates))delete tabStates[k];
    activeTab=null;
    await loadAll(true);
    openMgmt();
    setMgmtStatus('Data aktualizov√°na.','ok');
}

async function fullReload(){
    if(!confirm('Smazat ve≈°ker√° ulo≈æen√° data a naƒç√≠st v≈°e znovu z JSON?\nVelk√© sady (P≈Øsobnost, Role) bude nutn√© naƒç√≠st ruƒçnƒõ.'))return;
    setMgmtStatus('Ma≈æu cache‚Ä¶','info');
    try{await idbClear()}catch(e){}
    closeMgmt();
    for(const k of Object.keys(datasets)){datasets[k]={config:datasets[k].config,records:[],loaded:false}}
    globalIndex.clear();reverseIndex.clear();bareIndex.clear();
    for(const k of Object.keys(tabStates))delete tabStates[k];
    activeTab=null;
    await loadAll(true);
}

async function clearCache(){
    if(!confirm('Vymazat cache? P≈ôi p≈ô√≠≈°t√≠m otev≈ôen√≠ se data naƒçtou znovu z JSON.'))return;
    try{await idbClear()}catch(e){}
    setMgmtStatus('Cache vymaz√°na.','ok');
    renderMgmt();
}


// Build virtual ƒçinnosti dataset from inline data in agendy records
function buildVirtualCinnosti(){
    const agDs=datasets['agendy'];
    const cinDs=datasets['cinnosti'];
    if(!agDs||!agDs.loaded||!cinDs)return;
    // Don't overwrite if already loaded with real names
    if(cinDs.loaded&&cinDs.records.length>0){
        // Check if cached version has names; if not, rebuild
        const hasNames=cinDs.records.some(r=>r.n√°zev&&r.n√°zev.length>0);
        if(hasNames)return;
    }

    const records=[];
    const seen=new Set();
    for(const agRec of agDs.records){
        const agCode=agRec.k√≥d||'';
        const agName=cs(agRec.n√°zev)||'';
        const cinnosti=agRec.ƒçinnosti;
        if(!Array.isArray(cinnosti))continue;
        for(const cin of cinnosti){
            if(!cin||typeof cin!=='object')continue;
            let id=cin.id;
            if(!id)continue;
            // Strip full URI base to get short id (e.g. ƒçinnost/A1086/CR12074)
            if(id.startsWith(RDF_BASE)) id=id.substring(RDF_BASE.length);
            if(seen.has(id))continue;
            seen.add(id);
            const rec={id};
            // Extract k√≥d from URI or from field
            const m=id.match(/^ƒçinnost\/([^/]+)\/([^/]+)$/);
            if(m){
                rec['k√≥d-agendy']=m[1];
                rec['n√°zev-agendy']=agName;
                rec.k√≥d=m[2];
                rec.agenda='agenda/'+m[1];
            }else{
                rec['k√≥d-agendy']=agCode;
                rec['n√°zev-agendy']=agName;
                rec.k√≥d=cin.k√≥d||cin['m√°-k√≥d-ƒçinnosti']||'';
                let agId=agRec.id||'';
                if(agId.startsWith(RDF_BASE)) agId=agId.substring(RDF_BASE.length);
                rec.agenda=agId;
            }
            rec.n√°zev=cs(cin.n√°zev)||cs(cin['m√°-n√°zev-ƒçinnosti'])||'';
            rec.popis=cs(cin.popis)||cs(cin['m√°-popis-ƒçinnosti'])||'';
            if(cin['platnost-od']||cin['m√°-platnost-ƒçinnosti-od'])
                rec['platnost-od']=cin['platnost-od']||cin['m√°-platnost-ƒçinnosti-od'];
            if(cin['typ-v√Ωkonu-ƒçinnosti']||cin['typ-v√Ωkonu'])
                rec['typ-v√Ωkonu']=cin['typ-v√Ωkonu-ƒçinnosti']||cin['typ-v√Ωkonu'];
            records.push(rec);
        }
    }
    if(records.length>0){
        cinDs.records=records;
        cinDs.loaded=true;
        try{saveCachedDataset('cinnosti',records)}catch(e){}
    }
}

function buildIndex(){
    globalIndex.clear();
    reverseIndex.clear();
    bareIndex.clear();

    // First pass: build globalIndex and bareIndex
    for(const[key,ds]of Object.entries(datasets)){
        if(!ds.loaded)continue;
        ds.records.forEach((rec,idx)=>{
            const id=rec.id;
            const title=cs(rec.n√°zev)||cs(rec['n√°zev-√∫daje'])||rec.k√≥d||rec.identifik√°tor||id||'';
            if(id){
                globalIndex.set(id,{dsKey:key,idx,title:String(title)});
                // Build bareIndex: map short identifiers to full ref IDs
                if(id.startsWith('org√°n-ve≈ôejn√©-moci/')&&rec.iƒço){
                    bareIndex.set(String(rec.iƒço),id);
                }
                if(id.startsWith('agenda/')&&rec.k√≥d){
                    bareIndex.set(String(rec.k√≥d),id);
                }
                if(id.startsWith('isvs/')&&rec.identifik√°tor){
                    bareIndex.set(String(rec.identifik√°tor),id);
                }
                if(id.startsWith('ƒçinnost/')&&rec.k√≥d){
                    bareIndex.set(String(rec.k√≥d),id);
                }
                if(id.startsWith('kategorie-ovm/')&&rec.k√≥d){
                    bareIndex.set(String(rec.k√≥d),id);
                }
                if(id.startsWith('pracovi≈°tƒõ/')){
                    const num=id.replace('pracovi≈°tƒõ/','');
                    bareIndex.set(num,id);
                }
            }
        });
    }

    // Second pass: build reverseIndex from all record refs
    for(const[key,ds]of Object.entries(datasets)){
        if(!ds.loaded)continue;
        ds.records.forEach((rec,idx)=>{
            const id=rec.id;
            const title=cs(rec.n√°zev)||cs(rec['n√°zev-√∫daje'])||rec.k√≥d||rec.identifik√°tor||id||'';
            const refs=extractRefs(rec);
            const entry={dsKey:key,idx,title:String(title)};
            for(const ref of refs){
                if(ref===id)continue;
                let list=reverseIndex.get(ref);
                if(!list){list=[];reverseIndex.set(ref,list)}
                list.push(entry);
            }
        });
    }

    // Third pass: build synthetic cross-references from OVM role URIs
    // This ensures Agenda‚ÜîOVM‚Üîƒåinnost links work even without the full Role dataset
    const ovmDs=datasets['ovm'];
    if(ovmDs&&ovmDs.loaded){
        ovmDs.records.forEach((rec,idx)=>{
            const id=rec.id;
            const title=cs(rec.n√°zev)||rec.identifik√°tor||id||'';
            const entry={dsKey:'ovm',idx,title:String(title)};
            // Parse role URIs: role/{agendaCode}/{ƒçinnostCode}/{ovmIƒåO}
            const roleVals=Array.isArray(rec.role)?rec.role:(rec.role?[rec.role]:[]);
            const seenAgendas=new Set();
            const seenCinnosti=new Set();
            for(const rv of roleVals){
                if(typeof rv!=='string')continue;
                const m=rv.match(/^role\/([^/]+)\/([^/]+)\/([^/]+)$/);
                if(!m)continue;
                const agendaId='agenda/'+m[1];
                const cinnostId='ƒçinnost/'+m[1]+'/'+m[2];
                // Add OVM‚ÜíAgenda reverse link (Agenda sees this OVM via acting roles)
                if(!seenAgendas.has(agendaId)){
                    seenAgendas.add(agendaId);
                    let list=reverseIndex.get(agendaId);
                    if(!list){list=[];reverseIndex.set(agendaId,list)}
                    // Avoid duplicates ‚Äî check if OVM already in the list
                    if(!list.some(e=>e.dsKey==='ovm'&&e.idx===idx)) list.push(entry);
                }
                // Add OVM‚Üíƒåinnost reverse link
                if(!seenCinnosti.has(cinnostId)){
                    seenCinnosti.add(cinnostId);
                    let list=reverseIndex.get(cinnostId);
                    if(!list){list=[];reverseIndex.set(cinnostId,list)}
                    if(!list.some(e=>e.dsKey==='ovm'&&e.idx===idx)) list.push(entry);
                }
            }
        });
    }

    // Fourth pass: synthetic links from Kategorie OVM role URIs
    const katDs=datasets['kategorie'];
    if(katDs&&katDs.loaded){
        katDs.records.forEach((rec,idx)=>{
            const id=rec.id;
            const title=cs(rec.n√°zev)||rec.k√≥d||id||'';
            const entry={dsKey:'kategorie',idx,title:String(title)};
            const roleVals=Array.isArray(rec.role)?rec.role:(rec.role?[rec.role]:[]);
            const seenAgendas=new Set();
            for(const rv of roleVals){
                if(typeof rv!=='string')continue;
                const m=rv.match(/^role\/([^/]+)\/([^/]+)\/([^/]+)$/);
                if(!m)continue;
                const agendaId='agenda/'+m[1];
                if(!seenAgendas.has(agendaId)){
                    seenAgendas.add(agendaId);
                    let list=reverseIndex.get(agendaId);
                    if(!list){list=[];reverseIndex.set(agendaId,list)}
                    if(!list.some(e=>e.dsKey==='kategorie'&&e.idx===idx)) list.push(entry);
                }
            }
        });
    }
}

function extractRefs(obj){
    const refs=new Set();
    _scanRefs(obj,refs,3);
    return refs;
}
function _scanRefs(val,refs,depth){
    if(depth<=0||val==null)return;
    if(typeof val==='string'){
        if(isRefId(val)){refs.add(val);return}
        const resolved=bareIndex.get(val);
        if(resolved)refs.add(resolved);
        return;
    }
    if(Array.isArray(val)){
        for(const item of val)_scanRefs(item,refs,depth-1);
        return;
    }
    if(typeof val==='object'){
        for(const v of Object.values(val))_scanRefs(v,refs,depth-1);
    }
}

// ===== Tabs =====
function buildTabs(){
    elTabButtons.innerHTML='';
    elTabPanels.innerHTML='';
    DS_CONFIG.forEach(cfg=>{
        const ds=datasets[cfg.key];
        if(!ds.loaded||ds.records.length===0)return;
        const btn=document.createElement('button');
        btn.className='tab-btn';btn.role='tab';btn.id='tab-'+cfg.key;
        btn.setAttribute('aria-controls','panel-'+cfg.key);
        btn.innerHTML=cfg.name+`<span class="tab-count">${ds.records.length.toLocaleString('cs')}</span>`;
        btn.addEventListener('click',()=>activateTab(cfg.key));
        elTabButtons.appendChild(btn);

        const panel=document.createElement('div');
        panel.className='tab-panel';panel.role='tabpanel';panel.id='panel-'+cfg.key;
        panel.setAttribute('aria-labelledby','tab-'+cfg.key);
        elTabPanels.appendChild(panel);

        tabStates[cfg.key]={page:1,pageSize:25,sortKey:null,sortAsc:true,search:'',filtered:null};
    });
}

function activateTab(key){
    if(activeTab===key)return;
    activeTab=key;
    document.querySelectorAll('.tab-btn').forEach(b=>{b.classList.toggle('active',b.id==='tab-'+key);b.setAttribute('aria-selected',b.id==='tab-'+key)});
    document.querySelectorAll('.tab-panel').forEach(p=>{p.classList.toggle('active',p.id==='panel-'+key)});
    hideDetail();
    renderDatasetPanel(key);
}

// ===== Dataset Panel =====
function renderDatasetPanel(key){
    const ds=datasets[key];
    const panel=document.getElementById('panel-'+key);
    if(!panel||!ds)return;
    panel.innerHTML='';

    const state=tabStates[key];
    if(!state.filters)state.filters={};

    const cols=getColumns(ds);

    // Search bar
    const filterDiv=document.createElement('div');filterDiv.className='filter-row';
    const sf=document.createElement('div');sf.className='filter-field';sf.style.minWidth='300px';sf.style.flex='2';
    const sLabel=document.createElement('label');sLabel.setAttribute('for','ds-search-'+key);sLabel.textContent='Hledat v sadƒõ '+ds.config.name;
    const sInput=document.createElement('input');sInput.type='search';sInput.id='ds-search-'+key;sInput.placeholder='Hledan√Ω text‚Ä¶';sInput.value=state.search;
    let sT;sInput.addEventListener('input',()=>{clearTimeout(sT);sT=setTimeout(()=>{state.search=sInput.value;state.page=1;state.filtered=null;renderTable(key)},300)});
    sf.appendChild(sLabel);sf.appendChild(sInput);filterDiv.appendChild(sf);
    panel.appendChild(filterDiv);

    // Detect filterable columns and build filter dropdowns
    const filterableCols=detectFilterableCols(ds,cols);
    const refFilters=detectRefFilters(ds);
    if(filterableCols.length>0||refFilters.length>0){
        const fbar=document.createElement('div');fbar.className='filter-bar';

        refFilters.forEach(rf=>{
            const ff=document.createElement('div');ff.className='filter-field';ff.style.minWidth='220px';ff.style.maxWidth='320px';
            const lbl=document.createElement('label');lbl.textContent=rf.title;lbl.setAttribute('for','rflt-'+key+'-'+rf.refKey);
            const inp=document.createElement('input');inp.type='text';inp.id='rflt-'+key+'-'+rf.refKey;
            inp.placeholder='Zaƒçnƒõte ps√°t‚Ä¶';inp.setAttribute('autocomplete','off');
            const dlId='dl-'+key+'-'+rf.refKey;
            const dl=document.createElement('datalist');dl.id=dlId;
            inp.setAttribute('list',dlId);
            const curVal=state.filters['__ref:'+rf.prefix];
            if(curVal){const ref=globalIndex.get(curVal);inp.value=ref?ref.title+' ['+curVal.split('/').pop()+']':curVal}
            let rT;
            inp.addEventListener('input',()=>{
                clearTimeout(rT);rT=setTimeout(()=>{
                    const q=inp.value.trim().toLowerCase();
                    dl.innerHTML='';
                    if(q.length>=1){
                        let count=0;
                        for(const[id,entry]of globalIndex){
                            if(!id.startsWith(rf.prefix))continue;
                            const label=entry.title+' ['+id.split('/').pop()+']';
                            if(label.toLowerCase().includes(q)||id.toLowerCase().includes(q)){
                                const opt=document.createElement('option');opt.value=label;opt.dataset.refId=id;
                                dl.appendChild(opt);
                                if(++count>=30)break;
                            }
                        }
                    }
                    const match=findRefMatch(inp.value,rf.prefix);
                    if(match){state.filters['__ref:'+rf.prefix]=match;state.page=1;state.filtered=null;renderTable(key)}
                    else if(!q){delete state.filters['__ref:'+rf.prefix];state.page=1;state.filtered=null;renderTable(key)}
                },250);
            });
            inp.addEventListener('change',()=>{
                const q=inp.value.trim();
                if(!q){delete state.filters['__ref:'+rf.prefix];state.page=1;state.filtered=null;renderTable(key);return}
                const match=findRefMatch(q,rf.prefix);
                if(match){state.filters['__ref:'+rf.prefix]=match;state.page=1;state.filtered=null;renderTable(key)}
            });
            ff.appendChild(lbl);ff.appendChild(inp);ff.appendChild(dl);fbar.appendChild(ff);
        });

        filterableCols.forEach(fc=>{
            const ff=document.createElement('div');ff.className='filter-field';
            const lbl=document.createElement('label');lbl.textContent=fc.title;lbl.setAttribute('for','flt-'+key+'-'+fc.key);
            const sel=document.createElement('select');sel.id='flt-'+key+'-'+fc.key;
            const optAll=document.createElement('option');optAll.value='';optAll.textContent='‚Äî v≈°e ‚Äî';sel.appendChild(optAll);
            fc.values.forEach(v=>{
                const opt=document.createElement('option');opt.value=v.raw;opt.textContent=v.label+(v.count?' ('+v.count.toLocaleString('cs')+')':'');
                if(state.filters[fc.key]===v.raw)opt.selected=true;
                sel.appendChild(opt);
            });
            sel.addEventListener('change',()=>{
                if(sel.value)state.filters[fc.key]=sel.value;else delete state.filters[fc.key];
                state.page=1;state.filtered=null;renderTable(key);
            });
            ff.appendChild(lbl);ff.appendChild(sel);fbar.appendChild(ff);
        });

        const btnClear=document.createElement('button');btnClear.textContent='Zru≈°it filtry';btnClear.className='secondary';
        btnClear.style.cssText='align-self:flex-end;font-size:.82rem;padding:5px 10px';
        btnClear.addEventListener('click',()=>{
            state.filters={};state.page=1;state.filtered=null;
            if(state._includeKat!==undefined) state._includeKat=false;
            fbar.querySelectorAll('select').forEach(s=>s.value='');
            fbar.querySelectorAll('input[type="text"]').forEach(i=>i.value='');
            const katCb=fbar.querySelector('#pusobnost-kat-cb');if(katCb)katCb.checked=false;
            renderTable(key);
        });
        fbar.appendChild(btnClear);

        // P≈Øsobnost: checkbox "Vƒçetnƒõ kategori√≠"
        if(key==='pusobnost'){
            const katLabel=document.createElement('label');
            katLabel.style.cssText='display:flex;align-items:center;gap:4px;font-size:.85rem;white-space:nowrap;align-self:flex-end';
            const katCb=document.createElement('input');katCb.type='checkbox';katCb.id='pusobnost-kat-cb';
            katCb.checked=!!state._includeKat;
            katCb.addEventListener('change',()=>{
                state._includeKat=katCb.checked;
                state.page=1;state.filtered=null;
                renderTable(key);
            });
            katLabel.appendChild(katCb);
            katLabel.appendChild(document.createTextNode('Vƒçetnƒõ kategori√≠'));
            fbar.appendChild(katLabel);
        }

        panel.appendChild(fbar);
    }

    // Column visibility toggle
    if(!state.visibleCols)state.visibleCols=new Set(cols.map(c=>c.key));
    cols.forEach(c=>{if(!state._allColsInit){state.visibleCols.add(c.key)}});
    state._allColsInit=true;

    const colToggle=document.createElement('details');colToggle.className='col-toggle';
    const colSum=document.createElement('summary');colSum.textContent='Zobrazen√© sloupce ('+state.visibleCols.size+'/'+cols.length+')';
    colToggle.appendChild(colSum);
    const colChecks=document.createElement('div');colChecks.className='col-checks';
    const colAllBtn=document.createElement('button');colAllBtn.textContent='V≈°e';colAllBtn.className='secondary';colAllBtn.style.cssText='font-size:.78rem;padding:2px 8px;margin-right:8px';
    colAllBtn.addEventListener('click',()=>{cols.forEach(c=>state.visibleCols.add(c.key));colChecks.querySelectorAll('input').forEach(i=>i.checked=true);colSum.textContent='Zobrazen√© sloupce ('+state.visibleCols.size+'/'+cols.length+')';renderTableHead(key,cols);renderTable(key)});
    colChecks.appendChild(colAllBtn);
    const colNoneBtn=document.createElement('button');colNoneBtn.textContent='Nic';colNoneBtn.className='secondary';colNoneBtn.style.cssText='font-size:.78rem;padding:2px 8px;margin-right:12px';
    colNoneBtn.addEventListener('click',()=>{state.visibleCols.clear();colChecks.querySelectorAll('input').forEach(i=>i.checked=false);colSum.textContent='Zobrazen√© sloupce (0/'+cols.length+')';renderTableHead(key,cols);renderTable(key)});
    colChecks.appendChild(colNoneBtn);
    cols.forEach(col=>{
        const lbl=document.createElement('label');
        const cb=document.createElement('input');cb.type='checkbox';cb.checked=state.visibleCols.has(col.key);
        cb.addEventListener('change',()=>{
            if(cb.checked)state.visibleCols.add(col.key);else state.visibleCols.delete(col.key);
            colSum.textContent='Zobrazen√© sloupce ('+state.visibleCols.size+'/'+cols.length+')';
            renderTableHead(key,cols);renderTable(key);
        });
        lbl.appendChild(cb);lbl.appendChild(document.createTextNode(' '+col.title));
        colChecks.appendChild(lbl);
    });
    colToggle.appendChild(colChecks);
    panel.appendChild(colToggle);

    // Export bar
    const ebar=document.createElement('div');ebar.className='export-bar';
    const elbl=document.createElement('span');elbl.className='export-label';elbl.textContent='Export:';ebar.appendChild(elbl);
    ['CSV','TSV','XLSX'].forEach(fmt=>{
        const btn=document.createElement('button');btn.className='secondary';btn.textContent=fmt;
        btn.addEventListener('click',()=>exportData(key,fmt.toLowerCase()));
        ebar.appendChild(btn);
    });
    panel.appendChild(ebar);

    // Table wrapper
    const tw=document.createElement('div');tw.className='table-wrap';tw.id='tw-'+key;
    const table=document.createElement('table');table.id='tbl-'+key;
    const thead=document.createElement('thead');thead.id='thead-'+key;
    const tbody=document.createElement('tbody');tbody.id='tbody-'+key;
    table.appendChild(thead);table.appendChild(tbody);tw.appendChild(table);panel.appendChild(tw);

    const pag=document.createElement('div');pag.className='pag';pag.id='pag-'+key;
    panel.appendChild(pag);

    renderTableHead(key,cols);
    renderTable(key);
}

function detectFilterableCols(ds,cols){
    const result=[];
    const sampleSize=Math.min(ds.records.length,2000);
    cols.forEach(col=>{
        if(col.type==='subarray'||col.type==='object')return;
        const counts=new Map();
        for(let i=0;i<sampleSize;i++){
            const raw=ds.records[i][col.key];
            let val=cs(raw);
            if(val==null||val==='')continue;
            if(typeof val==='boolean')val=val?'ano':'ne';
            else val=String(val);
            counts.set(val,(counts.get(val)||0)+1);
            if(counts.size>40)break;
        }
        if(counts.size>=2&&counts.size<=40){
            const scale=ds.records.length/sampleSize;
            const values=[...counts.entries()]
                .sort((a,b)=>b[1]-a[1])
                .map(([v,c])=>{
                    let label=v;
                    if(v.includes('/')&&isRefId(v)){
                        const ref=globalIndex.get(v);
                        if(ref)label=ref.title+' ('+v.split('/').pop()+')';
                        else label=v.split('/').pop();
                    }
                    return{raw:v,label,count:sampleSize<ds.records.length?Math.round(c*scale):c};
                });
            result.push({key:col.key,title:col.title,values});
        }
    });
    return result;
}

function detectRefFilters(ds){
    const REF_TYPES=[
        {prefix:'agenda/',title:'Agenda',refKey:'agenda'},
        {prefix:'org√°n-ve≈ôejn√©-moci/',title:'OVM',refKey:'ovm'}
    ];
    const skipPrefix=ds.config.idPrefix||'';
    const result=[];
    const sample=ds.records.slice(0,50);
    REF_TYPES.forEach(rt=>{
        if(skipPrefix===rt.prefix)return;
        const found=sample.some(rec=>{
            const refs=extractRefs(rec);
            for(const r of refs){if(r.startsWith(rt.prefix))return true}
            return false;
        });
        if(found)result.push(rt);
    });
    return result;
}

function findRefMatch(text,prefix){
    const q=text.trim().toLowerCase();
    if(!q)return null;
    const bm=text.match(/\[([^\]]+)\]$/);
    if(bm){const candidate=prefix+bm[1];if(globalIndex.has(candidate))return candidate}
    if(globalIndex.has(q))return q;
    const withPrefix=prefix+q;
    if(globalIndex.has(withPrefix))return withPrefix;
    for(const[id,entry]of globalIndex){
        if(!id.startsWith(prefix))continue;
        if(entry.title.toLowerCase()===q)return id;
    }
    return null;
}

function getColumns(ds){
    const wantedKeys=ds.config.tableCols||[];
    const cols=[];
    const sample=ds.records.slice(0,20);
    const allKeys=new Set();
    sample.forEach(r=>{if(typeof r==='object'&&r)Object.keys(r).forEach(k=>allKeys.add(k))});

    // Include all wanted keys (even if not in first 20 records, they may appear later)
    const keys=wantedKeys.length>0?wantedKeys:[...allKeys].filter(k=>k!=='type'&&k!=='id');

    keys.forEach(k=>{
        const sv=sample.find(r=>r[k]!=null)?.[k];
        let type='string';
        const uv=cs(sv);
        if(typeof uv==='boolean')type='boolean';
        else if(typeof uv==='number')type='number';
        else if(Array.isArray(sv)){
            if(sv.length>0&&typeof sv[0]==='object')type='subarray';
            else type='array';
        }else if(typeof sv==='object'&&sv!==null&&!('cs' in sv))type='object';
        cols.push({key:k,title:humanize(k),type});
    });
    return cols;
}

function renderTableHead(key,cols){
    const thead=document.getElementById('thead-'+key);if(!thead)return;
    thead.innerHTML='';
    const state=tabStates[key];
    const visCols=state.visibleCols?cols.filter(c=>state.visibleCols.has(c.key)):cols;
    const tr=document.createElement('tr');
    const th0=document.createElement('th');th0.textContent='#';th0.setAttribute('scope','col');tr.appendChild(th0);

    visCols.forEach(col=>{
        const th=document.createElement('th');th.setAttribute('scope','col');
        const a=document.createElement('a');a.href='#';a.textContent=col.title;
        a.addEventListener('click',e=>{
            e.preventDefault();
            if(state.sortKey===col.key)state.sortAsc=!state.sortAsc;
            else{state.sortKey=col.key;state.sortAsc=true}
            state.filtered=null;
            renderTable(key);
        });
        th.appendChild(a);
        const si=document.createElement('span');si.className='si';si.setAttribute('aria-hidden','true');th.appendChild(si);
        tr.appendChild(th);
    });

    const thA=document.createElement('th');thA.textContent='';thA.setAttribute('scope','col');tr.appendChild(thA);
    thead.appendChild(tr);
}

function renderTable(key){
    const ds=datasets[key];const state=tabStates[key];
    const cols=getColumns(ds);
    const tbody=document.getElementById('tbody-'+key);if(!tbody)return;
    tbody.innerHTML='';

    if(!state.filtered){
        let recs=ds.records.map((r,i)=>({rec:r,idx:i}));

        // P≈Øsobnost: filter by kategorie checkbox
        if(key==='pusobnost'&&!state._includeKat){
            // Exclude kategorie-based records
            recs=recs.filter(({rec})=>{
                const z=rec.zdroj||rec.ovm||'';
                return !z.startsWith('kategorie-ovm/');
            });
        }
        if(key==='pusobnost'&&state._includeKat&&state.filters){
            // If filtering by specific OVM, also include its categories
            const ovmRef=state.filters['__ref:org√°n-ve≈ôejn√©-moci/'];
            if(ovmRef){
                const ovmEntry=globalIndex.get(ovmRef);
                if(ovmEntry){
                    const ovmRec=datasets['ovm']?.records?.[ovmEntry.idx];
                    if(ovmRec){
                        const rawKat=ovmRec['kategorie-ovm'];
                        const katIds=rawKat?(Array.isArray(rawKat)?rawKat:[rawKat]):[];
                        if(katIds.length>0){
                            const katSet=new Set(katIds);
                            // Include records matching OVM directly OR matching its categories
                            const ovmRevEntries=reverseIndex.get(ovmRef);
                            const ovmIdxSet=new Set((ovmRevEntries||[]).filter(e=>e.dsKey==='pusobnost').map(e=>e.idx));
                            recs=ds.records.map((r,i)=>({rec:r,idx:i})).filter(({rec,idx})=>{
                                if(ovmIdxSet.has(idx))return true;
                                const z=rec.zdroj||rec.kategorie||'';
                                return katSet.has(z);
                            });
                        }
                    }
                }
            }
        }

        const q=state.search.trim().toLowerCase();
        if(q){
            recs=recs.filter(({rec})=>{
                let hay=Object.values(rec).map(valToString).join(' ').toLowerCase();
                for(const v of Object.values(rec)){
                    if(Array.isArray(v))v.forEach(item=>{if(typeof item==='object'&&item)hay+=' '+Object.values(item).map(valToString).join(' ').toLowerCase()});
                }
                return hay.includes(q);
            });
        }
        if(state.filters){
            for(const[fk,fv]of Object.entries(state.filters)){
                if(!fv)continue;
                if(fk.startsWith('__ref:')){
                    const refEntries=reverseIndex.get(fv);
                    if(!refEntries||refEntries.length===0){recs=[];continue}
                    const matchIdx=new Set(refEntries.filter(e=>e.dsKey===key).map(e=>e.idx));
                    recs=recs.filter(({idx})=>matchIdx.has(idx));
                }else{
                    recs=recs.filter(({rec})=>{
                        let val=cs(rec[fk]);
                        if(val==null)return false;
                        if(typeof val==='boolean')val=val?'ano':'ne';
                        else val=String(val);
                        return val===fv;
                    });
                }
            }
        }
        const gq=elGlobalInput.value.trim().toLowerCase();
        if(gq&&gq!==q){
            recs=recs.filter(({rec})=>{
                let hay=Object.values(rec).map(valToString).join(' ').toLowerCase();
                for(const v of Object.values(rec)){
                    if(Array.isArray(v))v.forEach(item=>{if(typeof item==='object'&&item)hay+=' '+Object.values(item).map(valToString).join(' ').toLowerCase()});
                }
                return hay.includes(gq);
            });
        }
        if(state.sortKey){
            recs.sort((a,b)=>{
                let va=cs(a.rec[state.sortKey]),vb=cs(b.rec[state.sortKey]);
                if(va==null&&vb==null)return 0;if(va==null)return 1;if(vb==null)return -1;
                if(typeof va==='number'&&typeof vb==='number')return state.sortAsc?va-vb:vb-va;
                va=valToString(va).toLowerCase();vb=valToString(vb).toLowerCase();
                const c=va.localeCompare(vb,'cs');return state.sortAsc?c:-c;
            });
        }
        state.filtered=recs;
    }

    const recs=state.filtered;
    const visCols=state.visibleCols?cols.filter(c=>state.visibleCols.has(c.key)):cols;
    const ps=state.pageSize;
    const totalPages=ps>0?Math.ceil(recs.length/ps):1;
    if(state.page>totalPages)state.page=totalPages||1;
    const start=ps>0?(state.page-1)*ps:0;
    const end=ps>0?start+ps:recs.length;
    const page=recs.slice(start,end);

    const ths=document.getElementById('thead-'+key)?.querySelectorAll('th')||[];
    visCols.forEach((col,i)=>{
        const th=ths[i+1];if(!th)return;
        const si=th.querySelector('.si');if(!si)return;
        if(col.key===state.sortKey){si.textContent=state.sortAsc?'‚ñ≤':'‚ñº';th.setAttribute('aria-sort',state.sortAsc?'ascending':'descending')}
        else{si.textContent='';th.removeAttribute('aria-sort')}
    });

    if(page.length===0){
        const tr=document.createElement('tr');const td=document.createElement('td');
        td.colSpan=visCols.length+2;td.textContent=recs.length===0&&ds.records.length>0?'≈Ω√°dn√© z√°znamy neodpov√≠daj√≠ filtr≈Øm ani hled√°n√≠.':'≈Ω√°dn√° data.';
        td.style.cssText='text-align:center;padding:20px;color:#666';tr.appendChild(td);tbody.appendChild(tr);
    }else{
        page.forEach(({rec,idx},i)=>{
            const tr=document.createElement('tr');
            const td0=document.createElement('td');td0.textContent=start+i+1;td0.style.cssText='color:#999;text-align:right';tr.appendChild(td0);
            visCols.forEach(col=>{
                const td=document.createElement('td');
                renderCellValue(td,rec[col.key],col,key);
                tr.appendChild(td);
            });
            const tdA=document.createElement('td');
            const link=document.createElement('a');link.href='#';link.textContent='Detail';
            link.addEventListener('click',e=>{e.preventDefault();showDetail(key,idx)});
            tdA.appendChild(link);tr.appendChild(tdA);
            tbody.appendChild(tr);
        });
    }

    renderPag(key,recs.length);
}

function renderCellValue(td,rawVal,col,dsKey){
    const val=cs(rawVal);
    if(val==null||val===''){td.textContent='‚Äî';td.style.color='#999';return}

    // Never resolve bareIndex for identifier/number fields ‚Äî show raw value
    const skipBareFields=new Set(['iƒço','identifik√°tor','k√≥d','identifik√°tor-ds','k√≥d-isvs','identifik√°tor-√∫daje']);
    const skipBare=skipBareFields.has(col.key);

    if(!skipBare&&typeof val==='string'&&isRefId(val)){
        const ref=resolveRef(val);
        if(ref){
            const a=document.createElement('a');a.href='#';a.className='ref-link';
            a.textContent=ref.title;a.title=val;
            a.addEventListener('click',e=>{e.preventDefault();showDetail(ref.dsKey,ref.idx)});
            td.appendChild(a);return;
        }
        const coded=codedLabel(val);
        if(coded){const b=document.createElement('span');b.className='type-badge '+coded.badgeClass;b.textContent=coded.label;td.appendChild(b);return}
        // ELI link
        if(val.startsWith('/eli/')){const a=document.createElement('a');a.href='https://www.e-sbirka.cz'+val;a.target='_blank';a.rel='noopener';a.textContent=val;td.appendChild(a);return}
        td.textContent=val;return;
    }

    if(!skipBare&&typeof val==='string'&&bareIndex.has(val)){
        const ref=resolveRef(val);
        if(ref&&ref.dsKey!==dsKey){
            const a=document.createElement('a');a.href='#';a.className='ref-link';
            a.textContent=ref.title;a.title=bareIndex.get(val);
            a.addEventListener('click',e=>{e.preventDefault();showDetail(ref.dsKey,ref.idx)});
            td.appendChild(a);return;
        }
    }

    if(typeof val==='boolean'){td.textContent=val?'Ano':'Ne';return}

    if(typeof val==='string'&&/^https?:\/\//.test(val)){
        const a=document.createElement('a');a.href=val;a.target='_blank';a.rel='noopener';a.textContent=shortenUrl(val);td.appendChild(a);return;
    }

    if(Array.isArray(val)){
        if(col.type==='subarray'){const b=document.createElement('span');b.className='sub-count';b.textContent=val.length+' z√°zn.';td.appendChild(b);return}
        if(val.length>0&&typeof val[0]==='string'&&(isRefId(val[0])||bareIndex.has(val[0]))){
            val.slice(0,3).forEach((v,i)=>{
                if(i>0)td.appendChild(document.createTextNode(', '));
                const ref=resolveRef(v);
                if(ref&&(isRefId(v)||ref.dsKey!==dsKey)){
                    const a=document.createElement('a');a.href='#';a.className='ref-link';a.textContent=ref.title;a.title=v;
                    a.addEventListener('click',e=>{e.preventDefault();showDetail(ref.dsKey,ref.idx)});td.appendChild(a);
                }else td.appendChild(document.createTextNode(valToString(v)));
            });
            if(val.length>3)td.appendChild(document.createTextNode(` ‚Ä¶ (+${val.length-3})`));
            return;
        }
        if(val.length>0&&typeof val[0]==='object'){const b=document.createElement('span');b.className='sub-count';b.textContent=val.length+' pol.';td.appendChild(b);return}
        td.textContent=val.map(v=>valToString(v)).join(', ');return;
    }

    if(typeof val==='object'){
        const parts=[];
        for(const[k,v]of Object.entries(val)){
            const sv=cs(v);
            if(sv==null||sv===''||k==='type')continue;
            if(typeof sv==='string'){const ref=resolveRef(sv);if(ref){parts.push({key:k,ref,refId:sv});continue}}
            parts.push({key:k,text:valToString(v)});
        }
        if(parts.length===0){td.textContent=valToString(rawVal);return}
        parts.forEach((p,i)=>{
            if(i>0)td.appendChild(document.createTextNode(', '));
            if(parts.length>1){const lbl=document.createElement('span');lbl.style.cssText='color:#666;font-size:.82rem';lbl.textContent=humanize(p.key)+': ';td.appendChild(lbl)}
            if(p.ref){const a=document.createElement('a');a.href='#';a.className='ref-link';a.textContent=p.ref.title;a.title=p.refId;
            a.addEventListener('click',e=>{e.preventDefault();showDetail(p.ref.dsKey,p.ref.idx)});td.appendChild(a)}
            else td.appendChild(document.createTextNode(p.text));
        });
        return;
    }

    if(typeof val==='string'){
        const coded=codedLabel(val);
        if(coded){const b=document.createElement('span');b.className='type-badge '+coded.badgeClass;b.textContent=coded.label;td.appendChild(b);return}
        if(val.startsWith('/eli/')){const a=document.createElement('a');a.href='https://www.e-sbirka.cz'+val;a.target='_blank';a.rel='noopener';a.textContent=val;td.appendChild(a);return}
    }

    if(typeof val==='string'&&/^\d{4}-\d{2}-\d{2}/.test(val)){td.textContent=fmtDate(val);return}

    td.textContent=String(val);
}

// ===== Pagination =====
function renderPag(key,total){
    const pag=document.getElementById('pag-'+key);if(!pag)return;
    pag.innerHTML='';
    const state=tabStates[key];
    const ps=state.pageSize;
    const totalPages=ps>0?Math.ceil(total/ps):1;
    const start=ps>0?(state.page-1)*ps+1:1;
    const end=ps>0?Math.min(state.page*ps,total):total;

    const info=document.createElement('div');info.className='pag-info';
    const ds=datasets[key];
    info.textContent=total>0?`${start}‚Äì${end} z ${total.toLocaleString('cs')}`+(total<ds.records.length?` (filtrov√°no z ${ds.records.length.toLocaleString('cs')})`:''):'0 z√°znam≈Ø';
    pag.appendChild(info);

    const szDiv=document.createElement('div');szDiv.className='pag-size';
    const szL=document.createElement('label');szL.setAttribute('for','psz-'+key);szL.textContent='Na str√°nku:';
    const szS=document.createElement('select');szS.id='psz-'+key;
    [10,25,50,100,0].forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v||'V≈°e';if(v===state.pageSize)o.selected=true;szS.appendChild(o)});
    szS.addEventListener('change',()=>{state.pageSize=parseInt(szS.value)||0;state.page=1;renderTable(key)});
    szDiv.appendChild(szL);szDiv.appendChild(szS);pag.appendChild(szDiv);

    if(totalPages<=1)return;
    const ctrl=document.createElement('div');ctrl.className='pag-controls';
    const mkBtn=(txt,dis,fn,cur)=>{const b=document.createElement('button');b.textContent=txt;b.className=cur?'':'secondary';b.disabled=dis;if(cur)b.setAttribute('aria-current','page');b.addEventListener('click',fn);ctrl.appendChild(b)};
    mkBtn('‚Üê',state.page<=1,()=>{state.page--;renderTable(key)});
    pageNums(state.page,totalPages).forEach(p=>{
        if(p==='‚Ä¶'){const s=document.createElement('span');s.textContent='‚Ä¶';s.style.padding='4px';ctrl.appendChild(s)}
        else mkBtn(p,false,()=>{state.page=p;renderTable(key)},p===state.page);
    });
    mkBtn('‚Üí',state.page>=totalPages,()=>{state.page++;renderTable(key)});
    pag.appendChild(ctrl);
}
function pageNums(c,t){
    if(t<=7)return Array.from({length:t},(_,i)=>i+1);
    const p=[1];if(c>3)p.push('‚Ä¶');
    for(let i=Math.max(2,c-1);i<=Math.min(t-1,c+1);i++)p.push(i);
    if(c<t-2)p.push('‚Ä¶');p.push(t);return p;
}

// ===== Export =====
function exportData(key,fmt){
    const ds=datasets[key];const state=tabStates[key];
    if(!ds||!state)return;
    const cols=getColumns(ds);
    const visCols=state.visibleCols?cols.filter(c=>state.visibleCols.has(c.key)):cols;
    if(!state.filtered){renderTable(key)}
    const recs=state.filtered||[];

    const header=visCols.map(c=>c.title);
    const rows=recs.map(({rec})=>visCols.map(col=>{
        const raw=rec[col.key];const val=cs(raw);
        if(val==null)return '';
        if(typeof val==='boolean')return val?'Ano':'Ne';
        if(typeof val==='string'&&isRefId(val)){const ref=resolveRef(val);return ref?ref.title+' ('+val+')':val}
        if(typeof val==='string'&&bareIndex.has(val)){const ref=resolveRef(val);return ref?ref.title+' ('+val+')':val}
        if(Array.isArray(val)){
            return val.map(v=>{
                if(typeof v==='string'&&(isRefId(v)||bareIndex.has(v))){const r=resolveRef(v);return r?r.title:v}
                return valToString(v);
            }).join('; ');
        }
        return valToString(raw);
    }));

    if(fmt==='xlsx'){
        if(typeof XLSX==='undefined'){alert('Knihovna XLSX se nenaƒçetla. Zkuste CSV nebo TSV.');return}
        const wb=XLSX.utils.book_new();
        const ws=XLSX.utils.aoa_to_sheet([header,...rows]);
        ws['!cols']=header.map((_,i)=>{
            let max=header[i].length;
            rows.slice(0,100).forEach(r=>{if(r[i])max=Math.max(max,String(r[i]).length)});
            return{wch:Math.min(max+2,60)};
        });
        XLSX.utils.book_append_sheet(wb,ws,ds.config.name.substring(0,31));
        XLSX.writeFile(wb,'rpp-'+key+'.xlsx');
        return;
    }

    const sep=fmt==='tsv'?'\t':',';
    const esc=v=>{const s=String(v);if(fmt==='tsv')return s.replace(/[\t\n\r]/g,' ');return s.includes(',')||s.includes('"')||s.includes('\n')?'"'+s.replace(/"/g,'""')+'"':s};
    const lines=[header.map(esc).join(sep),...rows.map(r=>r.map(esc).join(sep))];
    const blob=new Blob(['\uFEFF'+lines.join('\n')],{type:fmt==='tsv'?'text/tab-separated-values;charset=utf-8':'text/csv;charset=utf-8'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download='rpp-'+key+'.'+(fmt==='tsv'?'tsv':'csv');
    document.body.appendChild(a);a.click();document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ===== Detail =====
// ===== Custom OVM sections: P≈Øsobnost + Pracovi≈°tƒõ =====

function computePusobnost(rec){
    const ovmId=rec.id; // org√°n-ve≈ôejn√©-moci/00262340
    const ico=rec.iƒço||rec.identifik√°tor||ovmId.replace('org√°n-ve≈ôejn√©-moci/','');
    const debugInfo={steps:[]};
    const agendaMap=new Map();
    const katVals=[];
    const katNames={};

    // === STEP 1: Get kategorie from OVM record (from JSON) ===
    const katDs=datasets['kategorie'];
    const rawKat=rec['kategorie-ovm'];
    if(rawKat){
        const katArr=Array.isArray(rawKat)?rawKat:[rawKat];
        for(const kv of katArr){
            if(typeof kv==='string'&&kv.startsWith('kategorie-ovm/')&&!katVals.includes(kv)){
                katVals.push(kv);
                const kCode=kv.replace('kategorie-ovm/','');
                let kName=kCode;
                if(katDs&&katDs.loaded){
                    const katRef=globalIndex.get(kv);
                    if(katRef){ const katRec=katDs.records[katRef.idx]; if(katRec) kName=cs(katRec.n√°zev)||kCode; }
                }
                katNames[kCode]=kName;
            }
        }
    }
    debugInfo.steps.push('1: kategorie z JSON: '+katVals.length+(katVals.length>0?' ('+katVals.map(k=>k.replace('kategorie-ovm/','')).join(', ')+')':''));

    // === STEP 2: Find roles from Role dataset ===
    const roleDs=datasets['role'];
    let directRoleCount=0, katRoleCount=0;

    function addRole(roleRec, source){
        if(!roleRec)return;
        // Extract from record or parse from URI
        const cinnostId=roleRec.ƒçinnost||roleRec['vykon√°v√°-ƒçinnost'];
        let agendaCode=null;
        let crCode=null;
        // Try parsing role URI: role/{agendaCode}/{ƒçinnostCode}/{entity}
        const rm=roleRec.id?.match(/^role\/([^/]+)\/([^/]+)\//);
        if(rm){ agendaCode=rm[1]; crCode=rm[2]; }
        // Or from ƒçinnost ref
        if(!agendaCode&&typeof cinnostId==='string'){
            const cm=cinnostId.match(/^ƒçinnost\/([^/]+)\/([^/]+)$/);
            if(cm){ agendaCode=cm[1]; crCode=cm[2]; }
        }
        // Or from agenda ref
        if(!agendaCode&&roleRec.agenda){
            const am=roleRec.agenda.match(/^agenda\/(.+)$/);
            if(am) agendaCode=am[1];
        }
        if(!agendaCode)return;

        if(!agendaMap.has(agendaCode)){
            agendaMap.set(agendaCode,{agendaId:'agenda/'+agendaCode, ƒçinnosti:new Map(), source});
        }
        const ag=agendaMap.get(agendaCode);
        if(crCode&&cinnostId){
            if(!ag.ƒçinnosti.has(crCode)){
                ag.ƒçinnosti.set(crCode,{crCode, cinnostId:typeof cinnostId==='string'?cinnostId:'ƒçinnost/'+agendaCode+'/'+crCode, sources:new Set()});
            }
            ag.ƒçinnosti.get(crCode).sources.add(source);
        }
    }

    if(roleDs&&roleDs.loaded){
        // 2a: Direct roles for this OVM (reverseIndex: ovmId ‚Üí role records)
        const directRoles=(reverseIndex.get(ovmId)||[]).filter(r=>r.dsKey==='role');
        for(const ref of directRoles){
            addRole(roleDs.records[ref.idx], 'p≈ô√≠m√°');
            directRoleCount++;
        }
        debugInfo.steps.push('2a: p≈ô√≠m√© role pro '+ovmId+': '+directRoleCount);

        // 2b: Roles via kategorie ‚Äî role records reference org√°n-ve≈ôejn√©-moci/KOxxx
        for(const katId of katVals){
            const kCode=katId.replace('kategorie-ovm/','');
            const kName=katNames[kCode]||kCode;
            // In role dataset, kategorie are referenced as org√°n-ve≈ôejn√©-moci/KOxxx
            const katOvmId='org√°n-ve≈ôejn√©-moci/'+kCode;
            const katRoles=(reverseIndex.get(katOvmId)||[]).filter(r=>r.dsKey==='role');
            let katCount=0;
            for(const ref of katRoles){
                addRole(roleDs.records[ref.idx], kName);
                katCount++;
            }
            katRoleCount+=katCount;
            debugInfo.steps.push('2b: '+kCode+' ('+kName+'): '+katCount+' rol√≠');
        }
        debugInfo.steps.push('2: celkem z Role datasetu: '+directRoleCount+' p≈ô√≠m√Ωch + '+katRoleCount+' z kategori√≠');
    }else{
        debugInfo.steps.push('2: Dataset "role" nen√≠ naƒçten!');
    }

    // === STEP 3: Fallback ‚Äî also check p≈Øsobnost dataset ===
    const pusDs=datasets['pusobnost'];
    let pusobnostCount=0;
    if(pusDs&&pusDs.loaded){
        const ovmRefs=reverseIndex.get(ovmId)||[];
        const pusobnosti=ovmRefs.filter(r=>r.dsKey==='pusobnost');
        pusobnostCount=pusobnosti.length;

        // Also scan by URI pattern if reverseIndex empty
        if(pusobnosti.length===0){
            for(let i=0;i<pusDs.records.length;i++){
                const pr=pusDs.records[i];
                if(pr.id&&pr.id.endsWith('/'+ico)){
                    pusobnosti.push({dsKey:'pusobnost', idx:i});
                }
            }
        }
        pusobnostCount=pusobnosti.length;

        let pusCinCount=0;
        for(const pRef of pusobnosti){
            const pusRec=pusDs.records[pRef.idx];
            if(!pusRec)continue;
            const pm=pusRec.id.match(/^p≈Øsobnost\/([^/]+)\/([^/]+)$/);
            if(!pm)continue;
            const agendaCode=pm[1];
            if(!agendaMap.has(agendaCode)){
                agendaMap.set(agendaCode,{agendaId:'agenda/'+agendaCode, ƒçinnosti:new Map(), source:'p≈Øsobnost'});
            }
            const ag=agendaMap.get(agendaCode);
            // Try all property names for ƒçinnosti
            let cinnosti=[];
            for(const propName of ['ƒçinnosti','vykon√°v√°-ƒçinnosti','vykon√°v√°-ƒçinnost']){
                const v=pusRec[propName];
                if(v){cinnosti=Array.isArray(v)?v:[v];break}
            }
            if(cinnosti.length===0){
                for(const[k,v] of Object.entries(pusRec)){
                    if(k==='id'||k==='type')continue;
                    const vals=Array.isArray(v)?v:[v];
                    for(const val of vals){if(typeof val==='string'&&val.startsWith('ƒçinnost/'))cinnosti.push(val)}
                }
            }
            for(const cinRef of cinnosti){
                if(typeof cinRef!=='string')continue;
                const cm=cinRef.match(/^ƒçinnost\/([^/]+)\/([^/]+)$/);
                if(!cm)continue;
                const crCode=cm[2];
                if(!ag.ƒçinnosti.has(crCode)){
                    ag.ƒçinnosti.set(crCode,{crCode, cinnostId:cinRef, sources:new Set()});
                    pusCinCount++;
                }
                ag.ƒçinnosti.get(crCode).sources.add('p≈Øsobnost');
            }
        }
        debugInfo.steps.push('3: p≈Øsobnost dataset: '+pusobnostCount+' z√°znam≈Ø, +'+pusCinCount+' nov√Ωch ƒçinnost√≠');
    }

    // === STEP 4: Enrich names from loaded datasets ===
    const cinDs=datasets['cinnosti'];
    if(cinDs&&cinDs.loaded){
        for(const[,ag]of agendaMap){
            for(const[,cin]of ag.ƒçinnosti){
                const cinRef=globalIndex.get(cin.cinnostId);
                if(cinRef){ const cinRec=cinDs.records[cinRef.idx]; if(cinRec){
                    if(cinRec.n√°zev) cin.n√°zev=cs(cinRec.n√°zev);
                    if(cinRec.popis) cin.popis=cs(cinRec.popis);
                }}
            }
        }
    }
    const agDs=datasets['agendy'];
    if(agDs&&agDs.loaded){
        for(const[,ag]of agendaMap){
            const agRef=globalIndex.get(ag.agendaId);
            if(agRef){ const agRec=agDs.records[agRef.idx]; if(agRec&&agRec.n√°zev) ag.n√°zev=cs(agRec.n√°zev); if(agRec&&agRec.k√≥d) ag.k√≥d=agRec.k√≥d; }
        }
    }

    let totalCin=0;
    for(const ag of agendaMap.values()) totalCin+=ag.ƒçinnosti.size;
    debugInfo.steps.push('V√Ωsledek: '+agendaMap.size+' agend, '+totalCin+' ƒçinnost√≠, '+katVals.length+' kategori√≠');
    return {agendaMap, katNames, katVals, pusobnostCount, debugInfo};
}

async function renderOvmCustomSections(container, rec){
    // === 1. KATEGORIE OVM (from JSON data directly on rec) ===
    const rawKat=rec['kategorie-ovm'];
    const katVals=rawKat?(Array.isArray(rawKat)?rawKat:[rawKat]):[];
    if(katVals.length>0){
        const katSec=document.createElement('div');katSec.className='related-section';
        const katH=document.createElement('h3');katH.textContent='Kategorie OVM ('+katVals.length+')';
        katSec.appendChild(katH);
        const katWrap=document.createElement('div');katWrap.className='table-wrap';
        const katTable=document.createElement('table');katTable.style.cssText='font-size:.85rem;width:100%';
        const katThead=document.createElement('thead');
        const katHrow=document.createElement('tr');
        ['K√≥d','N√°zev'].forEach(t=>{
            const th=document.createElement('th');th.textContent=t;th.setAttribute('scope','col');katHrow.appendChild(th);
        });
        katThead.appendChild(katHrow);katTable.appendChild(katThead);
        const katTbody=document.createElement('tbody');
        for(const kv of katVals){
            const kCode=kv.replace('kategorie-ovm/','');
            const tr=document.createElement('tr');
            const tdCode=document.createElement('td');tdCode.style.cssText='white-space:nowrap';
            const katRef=globalIndex.get(kv);
            if(katRef){
                const a=document.createElement('a');a.href='#';a.className='ref-link';a.textContent=kCode;
                a.addEventListener('click',e=>{e.preventDefault();showDetail(katRef.dsKey,katRef.idx)});
                tdCode.appendChild(a);
            }else tdCode.textContent=kCode;
            tr.appendChild(tdCode);
            const tdName=document.createElement('td');
            if(katRef){
                const katRec=datasets['kategorie']?.records?.[katRef.idx];
                tdName.textContent=cs(katRec?.n√°zev)||kCode;
            }else tdName.textContent=kCode;
            tr.appendChild(tdName);
            katTbody.appendChild(tr);
        }
        katTable.appendChild(katTbody);katWrap.appendChild(katTable);katSec.appendChild(katWrap);
        container.appendChild(katSec);
    }

    // === 2. P≈ÆSOBNOST (from Role + P≈Øsobnost datasets) ===
    const roleDs=datasets['role'];
    const pusDs=datasets['pusobnost'];
    const roleLoaded=roleDs&&roleDs.loaded;
    const pusLoaded=pusDs&&pusDs.loaded;
    if(!roleLoaded&&!pusLoaded){
        const loadDiv=document.createElement('div');loadDiv.className='related-section';
        loadDiv.style.cssText='background:#fff3e0;border:1px solid #ffb74d;border-radius:6px;padding:12px';
        loadDiv.innerHTML='<h3 style="color:#e65100">‚è≥ Datasety Role/P≈Øsobnost se je≈°tƒõ naƒç√≠taj√≠‚Ä¶</h3>'
            +'<p style="font-size:.82rem;color:#888">P≈Øsobnost bude zobrazena po dokonƒçen√≠ naƒç√≠t√°n√≠. Zkuste znovu za chv√≠li.</p>';
        container.appendChild(loadDiv);
        renderPracovisteSection(container, rec);
        return;
    }

    const pub=computePusobnost(rec);
    const hasRoles=pub.agendaMap.size>0;

    if(!hasRoles){
        const sec=document.createElement('div');sec.className='related-section';
        const h3=document.createElement('h3');h3.textContent='P≈Øsobnost ‚Äî ≈æ√°dn√© agendy nalezeny';h3.style.color='#999';
        sec.appendChild(h3);
        container.appendChild(sec);
    }else{
        const sec=document.createElement('div');sec.className='related-section';
        const h3=document.createElement('h3');
        let totalCin=0;
        for(const ag of pub.agendaMap.values()) totalCin+=ag.ƒçinnosti.size;
        const directCount=[...pub.agendaMap.values()].filter(a=>a.source==='p≈ô√≠m√°').length;
        const katCount=[...pub.agendaMap.values()].filter(a=>a.source!=='p≈ô√≠m√°'&&a.source!=='p≈Øsobnost').length;
        let srcNote='';
        if(directCount>0&&katCount>0) srcNote=' ('+directCount+' p≈ô√≠m√Ωch, '+katCount+' z kategori√≠)';
        else if(katCount>0) srcNote=' (z kategori√≠)';
        h3.textContent='P≈Øsobnost ‚Äî '+pub.agendaMap.size+' agend'+srcNote
            +(totalCin>0?', '+totalCin+' ƒçinnostn√≠ch rol√≠':'');
        sec.appendChild(h3);

        // === View mode toggle: grouped / flat table ===
        const viewBar=document.createElement('div');viewBar.style.cssText='display:flex;gap:8px;align-items:center;margin:6px 0 10px;flex-wrap:wrap';
        const btnGrouped=document.createElement('button');btnGrouped.textContent='Seskupen√© po agend√°ch';btnGrouped.className='secondary';btnGrouped.style.cssText='font-size:.82rem;padding:4px 12px';
        const btnFlat=document.createElement('button');btnFlat.textContent='Tabulka v≈°ech ƒçinnost√≠';btnFlat.style.cssText='font-size:.82rem;padding:4px 12px';
        const searchBox=document.createElement('input');searchBox.type='text';searchBox.placeholder='Hledat v ƒçinnostech‚Ä¶';
        searchBox.style.cssText='flex:1;min-width:200px;padding:5px 8px;border:1px solid #999;border-radius:4px;font-size:.85rem;display:none';
        viewBar.appendChild(btnGrouped);viewBar.appendChild(btnFlat);viewBar.appendChild(searchBox);
        sec.appendChild(viewBar);

        const contentDiv=document.createElement('div');
        sec.appendChild(contentDiv);

        // Prepare flat data array for table view
        const flatRows=[];
        const sortedAgendas=[...pub.agendaMap.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
        for(const[agCode,ag]of sortedAgendas){
            const agLabel=ag.k√≥d||agCode;
            const agName=cs(ag.n√°zev)||'';
            const sortedCin=[...ag.ƒçinnosti.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
            for(const[crCode,cin]of sortedCin){
                flatRows.push({agCode:agLabel,agName,agId:ag.agendaId,crCode,cinName:cs(cin.n√°zev)||'',cinPopis:cs(cin.popis)||'',cinId:cin.cinnostId,source:[...cin.sources].join(', ')});
            }
            if(sortedCin.length===0){
                flatRows.push({agCode:agLabel,agName,agId:ag.agendaId,crCode:'‚Äî',cinName:'',cinPopis:'',cinId:null,source:ag.source||''});
            }
        }

        function renderGrouped(){
            contentDiv.innerHTML='';
            searchBox.style.display='none';
            btnGrouped.className='';btnFlat.className='secondary';
            for(const[agCode,ag]of sortedAgendas){
                const agSec=document.createElement('details');agSec.className='pub-agenda';
                agSec.style.cssText='margin:4px 0;border:1px solid #e0e0e0;border-radius:4px';
                const agSum=document.createElement('summary');
                agSum.style.cssText='cursor:pointer;padding:6px 10px;background:#f5f7fa;font-weight:600;font-size:.9rem;border-radius:4px';
                const agLabel=ag.k√≥d||agCode;
                const agName=cs(ag.n√°zev)||'';
                const cinCount=ag.ƒçinnosti.size;
                const srcLabel=ag.source!=='p≈ô√≠m√°'&&ag.source!=='p≈Øsobnost'?' [kat]':'';
                agSum.textContent=agLabel+(agName?' ‚Äî '+agName:'')+(cinCount>0?' ('+cinCount+' rol√≠)':'')+srcLabel;
                const agRef=globalIndex.get(ag.agendaId);
                if(agRef){
                    agSum.style.color='#1565c0';
                    const agLink=document.createElement('a');agLink.href='#';agLink.style.cssText='float:right;font-size:.8rem;font-weight:400';
                    agLink.textContent='‚Üí detail agendy';
                    agLink.addEventListener('click',e=>{e.preventDefault();e.stopPropagation();showDetail(agRef.dsKey,agRef.idx)});
                    agSum.appendChild(agLink);
                }
                agSec.appendChild(agSum);
                if(cinCount>0){
                    const wrap=document.createElement('div');wrap.style.cssText='padding:4px 8px 8px;overflow-x:auto';
                    const table=document.createElement('table');table.style.cssText='font-size:.82rem;width:100%;border-collapse:collapse';
                    const thead=document.createElement('thead');
                    const hRow=document.createElement('tr');
                    ['K√≥d','N√°zev','Popis','Zdroj'].forEach(t=>{
                        const th=document.createElement('th');th.textContent=t;th.setAttribute('scope','col');
                        th.style.cssText='text-align:left;padding:3px 6px;border-bottom:1px solid #ddd;font-size:.82rem';
                        hRow.appendChild(th);
                    });
                    thead.appendChild(hRow);table.appendChild(thead);
                    const tbody=document.createElement('tbody');
                    const sortedCin=[...ag.ƒçinnosti.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
                    for(const[crCode,cin]of sortedCin){
                        const tr=document.createElement('tr');
                        const tdCode=document.createElement('td');tdCode.style.cssText='padding:2px 6px;white-space:nowrap';
                        const cinRef=globalIndex.get(cin.cinnostId);
                        if(cinRef){
                            const a=document.createElement('a');a.href='#';a.className='ref-link';a.textContent=crCode;
                            a.addEventListener('click',e=>{e.preventDefault();showDetail(cinRef.dsKey,cinRef.idx)});
                            tdCode.appendChild(a);
                        }else tdCode.textContent=crCode;
                        tr.appendChild(tdCode);
                        const tdName=document.createElement('td');tdName.style.cssText='padding:2px 6px';
                        tdName.textContent=cs(cin.n√°zev)||'‚Äî';tr.appendChild(tdName);
                        const tdPopis=document.createElement('td');tdPopis.style.cssText='padding:2px 6px;font-size:.78rem;color:#444;max-width:400px';
                        tdPopis.textContent=cs(cin.popis)||'';tr.appendChild(tdPopis);
                        const tdSrc=document.createElement('td');tdSrc.style.cssText='padding:2px 6px;font-size:.78rem;color:#666';
                        tdSrc.textContent=[...cin.sources].join(', ');tr.appendChild(tdSrc);
                        tbody.appendChild(tr);
                    }
                    table.appendChild(tbody);wrap.appendChild(table);agSec.appendChild(wrap);
                }else{
                    const note=document.createElement('p');
                    note.style.cssText='padding:4px 10px;font-size:.82rem;color:#888;margin:0';
                    note.textContent='ƒåinnostn√≠ role nejsou k dispozici.';
                    agSec.appendChild(note);
                }
                contentDiv.appendChild(agSec);
            }
        }

        function renderFlat(filter){
            contentDiv.innerHTML='';
            searchBox.style.display='';
            btnGrouped.className='secondary';btnFlat.className='';
            const fLow=(filter||'').toLowerCase();
            const filtered=fLow?flatRows.filter(r=>
                r.agCode.toLowerCase().includes(fLow)||
                r.agName.toLowerCase().includes(fLow)||
                r.crCode.toLowerCase().includes(fLow)||
                r.cinName.toLowerCase().includes(fLow)
            ):flatRows;
            const info=document.createElement('div');info.style.cssText='font-size:.82rem;color:#666;margin-bottom:6px';
            info.textContent=filtered.length+' z '+flatRows.length+' ƒçinnost√≠'+(fLow?' (filtrov√°no)':'');
            contentDiv.appendChild(info);
            const wrap=document.createElement('div');wrap.className='table-wrap';
            const table=document.createElement('table');table.style.cssText='font-size:.82rem;width:100%;border-collapse:collapse';
            const thead=document.createElement('thead');
            const hRow=document.createElement('tr');
            ['K√≥d agendy','N√°zev agendy','K√≥d ƒçinnosti','N√°zev','Popis','Zdroj'].forEach(t=>{
                const th=document.createElement('th');th.textContent=t;th.setAttribute('scope','col');
                th.style.cssText='text-align:left;padding:4px 6px;border-bottom:2px solid #999;font-size:.82rem';
                hRow.appendChild(th);
            });
            thead.appendChild(hRow);table.appendChild(thead);
            const tbody=document.createElement('tbody');
            for(const r of filtered){
                const tr=document.createElement('tr');
                // K√≥d agendy
                const tdAC=document.createElement('td');tdAC.style.cssText='padding:2px 6px;white-space:nowrap';
                const agRef=globalIndex.get(r.agId);
                if(agRef){const a=document.createElement('a');a.href='#';a.className='ref-link';a.textContent=r.agCode;a.addEventListener('click',e=>{e.preventDefault();showDetail(agRef.dsKey,agRef.idx)});tdAC.appendChild(a)}
                else tdAC.textContent=r.agCode;
                tr.appendChild(tdAC);
                // N√°zev agendy
                const tdAN=document.createElement('td');tdAN.style.cssText='padding:2px 6px;max-width:250px';tdAN.textContent=r.agName;tr.appendChild(tdAN);
                // K√≥d ƒçinnosti
                const tdCC=document.createElement('td');tdCC.style.cssText='padding:2px 6px;white-space:nowrap';
                if(r.cinId){const cinRef=globalIndex.get(r.cinId);
                    if(cinRef){const a=document.createElement('a');a.href='#';a.className='ref-link';a.textContent=r.crCode;a.addEventListener('click',e=>{e.preventDefault();showDetail(cinRef.dsKey,cinRef.idx)});tdCC.appendChild(a)}
                    else tdCC.textContent=r.crCode;
                }else tdCC.textContent=r.crCode;
                tr.appendChild(tdCC);
                // N√°zev ƒçinnosti
                const tdCN=document.createElement('td');tdCN.style.cssText='padding:2px 6px';tdCN.textContent=r.cinName||'‚Äî';tr.appendChild(tdCN);
                // Popis
                const tdP=document.createElement('td');tdP.style.cssText='padding:2px 6px;font-size:.78rem;color:#444;max-width:350px';tdP.textContent=r.cinPopis;tr.appendChild(tdP);
                // Zdroj
                const tdS=document.createElement('td');tdS.style.cssText='padding:2px 6px;font-size:.78rem;color:#666';tdS.textContent=r.source;tr.appendChild(tdS);
                tbody.appendChild(tr);
            }
            table.appendChild(tbody);wrap.appendChild(table);contentDiv.appendChild(wrap);
        }

        btnGrouped.addEventListener('click',()=>renderGrouped());
        btnFlat.addEventListener('click',()=>renderFlat(searchBox.value));
        let searchTimer;
        searchBox.addEventListener('input',()=>{clearTimeout(searchTimer);searchTimer=setTimeout(()=>renderFlat(searchBox.value),300)});

        // Default: grouped view
        renderGrouped();
        container.appendChild(sec);
    }

    // === 3. PRACOVI≈†Tƒö ===
    renderPracovisteSection(container, rec);
}

function renderPracovisteSection(container, rec){
    // Get pracovi≈°tƒõ IDs from OVM record
    const pracVals=Array.isArray(rec['pracovi≈°tƒõ-ovm'])?rec['pracovi≈°tƒõ-ovm']:(rec['pracovi≈°tƒõ-ovm']?[rec['pracovi≈°tƒõ-ovm']]:[]);
    if(pracVals.length===0)return;

    const pracDs=datasets['pracoviste'];
    const pracRecs=[];
    for(const pv of pracVals){
        if(typeof pv==='object'&&pv){
            // JSON-loaded: pracovi≈°tƒõ is already an object
            pracRecs.push(pv);
        }else if(typeof pv==='string'){
            // pracovi≈°tƒõ is a ref ID
            const pRef=globalIndex.get(pv);
            if(pRef&&pracDs&&pracDs.loaded){
                const pRec=pracDs.records[pRef.idx];
                if(pRec) pracRecs.push(pRec);
            }else{
                pracRecs.push({id:pv});
            }
        }
    }
    if(pracRecs.length===0)return;

    // Discover ALL property columns dynamically from actual records
    const skipKeys=new Set(['id','type']);
    const allKeys=new Map(); // key ‚Üí human label
    for(const pr of pracRecs){
        for(const k of Object.keys(pr)){
            if(skipKeys.has(k))continue;
            if(!allKeys.has(k)) allKeys.set(k, humanize(k));
        }
    }
    const propKeys=[...allKeys.keys()];

    const sec=document.createElement('div');sec.className='related-section';
    const h3=document.createElement('h3');
    h3.textContent='Pracovi≈°tƒõ ('+pracRecs.length+')';
    sec.appendChild(h3);

    const wrap=document.createElement('div');wrap.className='table-wrap';
    const table=document.createElement('table');table.style.cssText='font-size:.85rem;width:100%';
    const thead=document.createElement('thead');
    const hRow=document.createElement('tr');
    // Fixed columns: # and ID
    const th0=document.createElement('th');th0.textContent='#';th0.setAttribute('scope','col');hRow.appendChild(th0);
    const thId=document.createElement('th');thId.textContent='ID';thId.setAttribute('scope','col');hRow.appendChild(thId);
    // Dynamic columns from actual data
    for(const k of propKeys){
        const th=document.createElement('th');th.textContent=allKeys.get(k);th.setAttribute('scope','col');hRow.appendChild(th);
    }
    thead.appendChild(hRow);table.appendChild(thead);

    const tbody=document.createElement('tbody');
    pracRecs.forEach((pr,i)=>{
        const tr=document.createElement('tr');
        // #
        const td0=document.createElement('td');td0.textContent=i+1;td0.style.cssText='color:#999;text-align:right';tr.appendChild(td0);
        // ID (clickable)
        const tdId=document.createElement('td');
        const pId=pr.id||'';
        const pRef=globalIndex.get(pId);
        if(pRef){
            const a=document.createElement('a');a.href='#';a.className='ref-link';a.textContent=pId.replace('pracovi≈°tƒõ/','');
            a.addEventListener('click',e=>{e.preventDefault();showDetail(pRef.dsKey,pRef.idx)});
            tdId.appendChild(a);
        }else{
            tdId.textContent=pId.replace('pracovi≈°tƒõ/','');
        }
        tr.appendChild(tdId);
        // Dynamic property columns
        for(const k of propKeys){
            const td=document.createElement('td');
            const raw=pr[k];
            if(raw==null||raw===''){
                td.textContent='‚Äî';td.style.color='#999';
            }else if(typeof raw==='string'&&raw.startsWith('http')){
                const a=document.createElement('a');a.href=raw;a.target='_blank';a.rel='noopener';
                a.textContent=raw.replace(/^https?:\/\/[^/]+/,'‚Ä¶');a.style.fontSize='.8rem';
                td.appendChild(a);
            }else if(typeof raw==='string'&&isRefId(raw)){
                const ref=resolveRef(raw);
                if(ref){
                    const a=document.createElement('a');a.href='#';a.className='ref-link';
                    a.textContent=ref.title||raw;
                    a.addEventListener('click',e=>{e.preventDefault();showDetail(ref.dsKey,ref.idx)});
                    td.appendChild(a);
                }else td.textContent=raw;
            }else if(Array.isArray(raw)){
                td.textContent=raw.map(v=>typeof v==='string'?v:JSON.stringify(v)).join(', ');
                td.style.fontSize='.8rem';
            }else{
                const s=String(raw);
                // Try formatting as date if it looks like one
                if(/^\d{4}-\d{2}-\d{2}/.test(s)) td.textContent=fmtDate(s);
                else td.textContent=s;
            }
            tr.appendChild(td);
        }
        tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    wrap.appendChild(table);
    sec.appendChild(wrap);
    container.appendChild(sec);

    // Debug: show raw property keys found (on-page diagnostic)
    if(propKeys.length===0){
        const dbg=document.createElement('details');dbg.style.cssText='margin:6px 0;font-size:.8rem';
        const dbgSum=document.createElement('summary');dbgSum.textContent='‚ö† Pracovi≈°tƒõ z√°znamy nemaj√≠ ≈æ√°dn√© namapovan√© properties';dbgSum.style.color='#c62828';
        dbg.appendChild(dbgSum);
        const pre=document.createElement('pre');pre.style.cssText='background:#f5f5f5;padding:8px;overflow:auto;max-height:200px;font-size:.75rem';
        pre.textContent='P≈ô√≠klad z√°znamu:\n'+JSON.stringify(pracRecs[0],null,2);
        dbg.appendChild(pre);
        sec.appendChild(dbg);
    }
}

function showDetail(dsKey,idx){
    const ds=datasets[dsKey];if(!ds||!ds.records[idx])return;
    const rec=ds.records[idx];
    elDetailBody.innerHTML='';
    const title=cs(rec.n√°zev)||cs(rec['n√°zev-√∫daje'])||rec.k√≥d||rec.identifik√°tor||rec.id||'Z√°znam';
    elDetailTitle.textContent=title;

    // Permalink
    const recId=rec.id||'';
    if(recId){
        elDetailPermalink.style.display='flex';
        elDetailPermalink.innerHTML='';
        const pUrl=new URL(location.href);pUrl.search='';pUrl.searchParams.set('detail',recId);
        const plLink=document.createElement('a');plLink.href=pUrl.toString();plLink.textContent='P≈ô√≠m√Ω odkaz na tento z√°znam';
        plLink.title=pUrl.toString();
        const plBtn=document.createElement('button');plBtn.className='secondary';plBtn.textContent='Kop√≠rovat';
        plBtn.addEventListener('click',()=>{navigator.clipboard.writeText(pUrl.toString()).then(()=>{plBtn.textContent='‚úì';setTimeout(()=>plBtn.textContent='Kop√≠rovat',2000)}).catch(()=>{})});
        // RDF source link
        const rdfLink=document.createElement('a');rdfLink.className='rdf-link';rdfLink.href=RDF_BASE+recId;rdfLink.target='_blank';rdfLink.rel='noopener';rdfLink.textContent='üîó RDF';rdfLink.title='Zobrazit v LodView';
        elDetailPermalink.appendChild(plLink);elDetailPermalink.appendChild(plBtn);elDetailPermalink.appendChild(rdfLink);
    }else{
        elDetailPermalink.style.display='none';
    }

    // Main fields
    const dl=document.createElement('dl');dl.className='dl';
    const skipKeys=new Set(['type','id']);
    // For OVM, kategorie-ovm is shown in custom section below
    if(dsKey==='ovm') skipKeys.add('kategorie-ovm');
    // For ISVS, hide verze (displays incorrectly)
    if(dsKey==='isvs') skipKeys.add('verze');
    const subArrayKeys=[];

    Object.entries(rec).forEach(([key,rawVal])=>{
        if(skipKeys.has(key))return;
        if(Array.isArray(rawVal)&&rawVal.length>0&&typeof rawVal[0]==='object'&&!('cs' in rawVal[0])){
            subArrayKeys.push(key);return;
        }
        try{
            const dt=document.createElement('dt');dt.textContent=humanize(key);dl.appendChild(dt);
            const dd=document.createElement('dd');
            renderDetailVal(dd,rawVal,key);
            dl.appendChild(dd);
        }catch(e){
            const dt=document.createElement('dt');dt.textContent=humanize(key);dl.appendChild(dt);
            const dd=document.createElement('dd');dd.textContent='[chyba vykreslen√≠: '+e.message+']';dd.style.color='#c62828';dl.appendChild(dd);
        }
    });
    elDetailBody.appendChild(dl);

    subArrayKeys.forEach(key=>{
        try{
            const arr=rec[key];
            const sec=document.createElement('div');sec.className='sub-section';
            const h3=document.createElement('h3');h3.textContent=`${humanize(key)} (${arr.length})`;sec.appendChild(h3);
            renderSubTable(sec,arr);
            elDetailBody.appendChild(sec);
        }catch(e){
            const sec=document.createElement('div');sec.className='sub-section';
            sec.innerHTML='<h3>'+humanize(key)+'</h3><p style="color:#c62828">[chyba vykreslen√≠: '+e.message+']</p>';
            elDetailBody.appendChild(sec);
        }
    });

    // Custom sections for OVM detail
    if(dsKey==='ovm'){
        renderOvmCustomSections(elDetailBody, rec);
    }

    renderRelated(dsKey,rec);

    // Raw JSON toggle
    const rawSec=document.createElement('details');rawSec.className='sub-section';rawSec.style.borderTop='2px solid #e0e0e0';
    const rawSum=document.createElement('summary');rawSum.style.cssText='cursor:pointer;font-weight:600;padding:8px 0';
    rawSum.textContent='Surov√° data (JSON) ‚Äî '+Object.keys(rec).length+' pol√≠';
    rawSec.appendChild(rawSum);
    const rawPre=document.createElement('pre');rawPre.style.cssText='max-height:500px;overflow:auto;background:#f5f5f5;padding:12px;border-radius:4px;font-size:.8rem;white-space:pre-wrap;word-break:break-all';
    rawPre.textContent=JSON.stringify(rec,null,2);
    rawSec.appendChild(rawPre);
    elDetailBody.appendChild(rawSec);

    elDetail.classList.add('visible');
    elTabsArea.style.display='none';
    elGlobalSearch.style.display='none';
    elDetail.scrollIntoView({behavior:'smooth'});
    elDetailTitle.focus();
}

function renderDetailVal(dd,rawVal,fieldKey){
    const val=cs(rawVal);
    if(val==null||val===''){dd.textContent='(pr√°zdn√©)';dd.className='empty';return}

    // Never resolve bareIndex for identifier/number fields ‚Äî show raw value
    const skipBareFields=new Set(['iƒço','identifik√°tor','k√≥d','identifik√°tor-ds','k√≥d-isvs']);
    const skipBare=skipBareFields.has(fieldKey);

    if(typeof val==='string'&&isRefId(val)){
        const ref=resolveRef(val);
        if(ref){
            const a=document.createElement('a');a.href='#';a.className='ref-link';a.textContent=ref.title;a.title=val;
            a.addEventListener('click',e=>{e.preventDefault();showDetail(ref.dsKey,ref.idx)});
            dd.appendChild(a);dd.appendChild(document.createTextNode(' ('+val+')'));return;
        }
        const coded=codedLabel(val);
        if(coded){const b=document.createElement('span');b.className='type-badge '+coded.badgeClass;b.textContent=coded.label;dd.appendChild(b);dd.appendChild(document.createTextNode(' ('+val+')'));return}
        if(val.startsWith('/eli/')){const a=document.createElement('a');a.href='https://www.e-sbirka.cz'+val;a.target='_blank';a.rel='noopener';a.textContent=val;dd.appendChild(a);return}
        dd.textContent=val;return;
    }

    if(!skipBare&&typeof val==='string'&&bareIndex.has(val)){
        const ref=resolveRef(val);
        if(ref){const a=document.createElement('a');a.href='#';a.className='ref-link';a.textContent=ref.title;a.title=bareIndex.get(val);
        a.addEventListener('click',e=>{e.preventDefault();showDetail(ref.dsKey,ref.idx)});dd.appendChild(a);dd.appendChild(document.createTextNode(' ('+val+')'));return}
    }

    if(typeof val==='string'&&/^https?:\/\//.test(val)){const a=document.createElement('a');a.href=val;a.target='_blank';a.rel='noopener';a.textContent=val;dd.appendChild(a);return}
    if(typeof val==='string'&&val.startsWith('/eli/')){const a=document.createElement('a');a.href='https://www.e-sbirka.cz'+val;a.target='_blank';a.rel='noopener';a.textContent=val;dd.appendChild(a);return}

    if(typeof val==='boolean'){dd.textContent=val?'Ano':'Ne';return}

    if(Array.isArray(val)){
        if(val.length===0){dd.textContent='(pr√°zdn√©)';dd.className='empty';return}
        val.forEach((item,i)=>{
            if(i>0)dd.appendChild(document.createElement('br'));
            const span=document.createElement('span');
            if(typeof item==='string'&&(isRefId(item)||bareIndex.has(item))){
                const ref=resolveRef(item);
                if(ref){const a=document.createElement('a');a.href='#';a.className='ref-link';a.textContent=ref.title;a.title=item;
                a.addEventListener('click',e=>{e.preventDefault();showDetail(ref.dsKey,ref.idx)});span.appendChild(a)}
                else if(item.startsWith('/eli/')){const a=document.createElement('a');a.href='https://www.e-sbirka.cz'+item;a.target='_blank';a.rel='noopener';a.textContent=item;span.appendChild(a)}
                else span.textContent=item;
            }else if(typeof item==='string'&&item.startsWith('/eli/')){
                const a=document.createElement('a');a.href='https://www.e-sbirka.cz'+item;a.target='_blank';a.rel='noopener';a.textContent=item;span.appendChild(a);
            }else span.textContent=valToString(item);
            dd.appendChild(span);
        });
        return;
    }

    if(typeof val==='object'){
        const inner=document.createElement('dl');inner.className='dl';inner.style.marginLeft='16px';
        Object.entries(val).forEach(([k,v])=>{
            if(v==null||k==='type')return;
            const idt=document.createElement('dt');idt.textContent=humanize(k);inner.appendChild(idt);
            const idd=document.createElement('dd');renderDetailVal(idd,v,k);inner.appendChild(idd);
        });
        dd.appendChild(inner);return;
    }

    if(typeof val==='string'&&/^\d{4}-\d{2}-\d{2}/.test(val)){dd.textContent=fmtDate(val);return}
    if(typeof val==='string'){const coded=codedLabel(val);if(coded){const b=document.createElement('span');b.className='type-badge '+coded.badgeClass;b.textContent=coded.label;dd.appendChild(b);dd.appendChild(document.createTextNode(' ('+val+')'));return}}

    dd.textContent=String(val);
}

function renderSubTable(container,arr){
    const allKeys=new Set();
    arr.slice(0,30).forEach(item=>{if(typeof item==='object'&&item)Object.keys(item).forEach(k=>allKeys.add(k))});
    const types=new Set(arr.map(r=>r?.type).filter(Boolean));
    const cols=[...allKeys].filter(k=>!(k==='type'&&types.size<=1));

    const wrap=document.createElement('div');wrap.className='table-wrap';
    const table=document.createElement('table');table.style.fontSize='0.85rem';
    const thead=document.createElement('thead');const hRow=document.createElement('tr');
    const th0=document.createElement('th');th0.textContent='#';th0.setAttribute('scope','col');hRow.appendChild(th0);
    cols.forEach(k=>{const th=document.createElement('th');th.textContent=humanize(k);th.setAttribute('scope','col');hRow.appendChild(th)});
    thead.appendChild(hRow);table.appendChild(thead);

    const tbody=document.createElement('tbody');
    arr.forEach((item,i)=>{
        const tr=document.createElement('tr');
        const td0=document.createElement('td');td0.textContent=i+1;td0.style.cssText='color:#999;text-align:right';tr.appendChild(td0);
        cols.forEach(k=>{
            const td=document.createElement('td');
            const raw=item?.[k];
            const val=cs(raw);
            if(val==null||val===''){td.textContent='‚Äî';td.style.color='#999'}
            else if(typeof val==='string'&&(isRefId(val)||bareIndex.has(val))){
                const ref=resolveRef(val);
                if(ref){const a=document.createElement('a');a.href='#';a.className='ref-link';a.textContent=ref.title;a.title=val;
                a.addEventListener('click',e=>{e.preventDefault();showDetail(ref.dsKey,ref.idx)});td.appendChild(a)}
                else{const coded=codedLabel(val);if(coded){const b=document.createElement('span');b.className='type-badge '+coded.badgeClass;b.textContent=coded.label;td.appendChild(b)}else td.textContent=val}
            }else if(Array.isArray(val)){
                val.forEach((v,j)=>{
                    if(j>0)td.appendChild(document.createTextNode(', '));
                    if(typeof v==='string'&&(isRefId(v)||bareIndex.has(v))){
                        const ref=resolveRef(v);
                        if(ref){const a=document.createElement('a');a.href='#';a.className='ref-link';a.textContent=ref.title;
                        a.addEventListener('click',e=>{e.preventDefault();showDetail(ref.dsKey,ref.idx)});td.appendChild(a)}
                        else td.appendChild(document.createTextNode(v));
                    }else if(typeof v==='string'&&v.startsWith('/eli/')){
                        const a=document.createElement('a');a.href='https://www.e-sbirka.cz'+v;a.target='_blank';a.rel='noopener';a.textContent=v;td.appendChild(a);
                    }else if(typeof v==='object'&&v){td.appendChild(document.createTextNode(valToString(v)))}
                    else td.appendChild(document.createTextNode(String(v)));
                });
            }else if(typeof val==='boolean'){td.textContent=val?'Ano':'Ne'}
            else if(typeof val==='string'&&val.startsWith('/eli/')){const a=document.createElement('a');a.href='https://www.e-sbirka.cz'+val;a.target='_blank';a.rel='noopener';a.textContent=val;td.appendChild(a)}
            else if(typeof val==='object'){
                const inner=document.createElement('dl');inner.className='dl';inner.style.margin='0';
                Object.entries(val).forEach(([ik,iv])=>{if(iv!=null&&ik!=='type'){
                    const idt=document.createElement('dt');idt.textContent=humanize(ik);idt.style.cssText='font-size:0.8rem;margin-top:4px';inner.appendChild(idt);
                    const idd=document.createElement('dd');renderDetailVal(idd,iv,ik);inner.appendChild(idd)}});
                td.appendChild(inner);
            }else{
                const coded=codedLabel(val);
                if(coded){const b=document.createElement('span');b.className='type-badge '+coded.badgeClass;b.textContent=coded.label;td.appendChild(b)}
                else if(typeof val==='string'&&/^\d{4}-\d{2}-\d{2}/.test(val))td.textContent=fmtDate(val);
                else td.textContent=String(val);
            }
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
    table.appendChild(tbody);wrap.appendChild(table);container.appendChild(wrap);
}

// ===== Related records (reverse lookup) =====
function renderRelated(dsKey,rec){
    const recId=rec.id;
    if(!recId)return;
    const entries=reverseIndex.get(recId);
    if(!entries||entries.length===0)return;

    const groups={};
    entries.forEach(e=>{
        if(!groups[e.dsKey])groups[e.dsKey]={name:datasets[e.dsKey].config.name,matches:[]};
        groups[e.dsKey].matches.push(e);
    });

    for(const[rKey,group]of Object.entries(groups)){
        // Skip p≈Øsobnost and role in OVM detail ‚Äî already shown in custom section
        if(dsKey==='ovm'&&(rKey==='pusobnost'||rKey==='role'))continue;
        const ds=datasets[rKey];
        if(!ds)continue;
        const sec=document.createElement('div');sec.className='related-section';
        const h3=document.createElement('h3');
        h3.textContent=`Souvisej√≠c√≠: ${group.name} (${group.matches.length})`;
        sec.appendChild(h3);

        const recs=group.matches.map(m=>ds.records[m.idx]).filter(Boolean);
        if(recs.length===0){sec.appendChild(document.createTextNode('≈Ω√°dn√© z√°znamy'));elDetailBody.appendChild(sec);continue}

        const cols=getRelatedCols(ds,recs);
        const visSet=new Set(cols.map(c=>c.key));

        const colToggle=document.createElement('details');colToggle.className='col-toggle';
        const colSum=document.createElement('summary');colSum.textContent='Sloupce ('+visSet.size+'/'+cols.length+')';
        colToggle.appendChild(colSum);
        const colChecks=document.createElement('div');colChecks.className='col-checks';

        const wrap=document.createElement('div');wrap.className='table-wrap';
        const table=document.createElement('table');table.style.fontSize='0.85rem';
        let relShowAll=recs.length<=100;

        function rebuildRelTable(){
            const vc=cols.filter(c=>visSet.has(c.key));
            colSum.textContent='Sloupce ('+visSet.size+'/'+cols.length+')';
            table.innerHTML='';
            const thead=document.createElement('thead');const hRow=document.createElement('tr');
            const th0=document.createElement('th');th0.textContent='#';th0.setAttribute('scope','col');hRow.appendChild(th0);
            vc.forEach(col=>{const th=document.createElement('th');th.textContent=col.title;th.setAttribute('scope','col');hRow.appendChild(th)});
            const thD=document.createElement('th');thD.textContent='';hRow.appendChild(thD);
            thead.appendChild(hRow);table.appendChild(thead);
            const tbody=document.createElement('tbody');
            const showRecs=relShowAll?recs:recs.slice(0,100);
            showRecs.forEach((r,i)=>{
                const idx=group.matches[i].idx;
                const tr=document.createElement('tr');
                const td0=document.createElement('td');td0.textContent=i+1;td0.style.cssText='color:#999;text-align:right';tr.appendChild(td0);
                vc.forEach(col=>{const td=document.createElement('td');renderCellValue(td,r[col.key],col,rKey);tr.appendChild(td)});
                const tdD=document.createElement('td');
                const link=document.createElement('a');link.href='#';link.textContent='Detail';
                link.addEventListener('click',e=>{e.preventDefault();showDetail(rKey,idx)});
                tdD.appendChild(link);tr.appendChild(tdD);
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            let moreBtn=sec.querySelector('.rel-show-all');
            if(!relShowAll&&recs.length>100){
                if(!moreBtn){
                    moreBtn=document.createElement('button');moreBtn.className='rel-show-all secondary';
                    moreBtn.style.cssText='margin-top:6px;font-size:.82rem';
                    moreBtn.addEventListener('click',()=>{relShowAll=true;rebuildRelTable()});
                    wrap.after(moreBtn);
                }
                moreBtn.textContent='Zobrazit v≈°e ('+recs.length.toLocaleString('cs')+' z√°znam≈Ø)';
                moreBtn.style.display='';
            }else if(moreBtn){moreBtn.style.display='none'}
        }

        cols.forEach(col=>{
            const lbl=document.createElement('label');
            const cb=document.createElement('input');cb.type='checkbox';cb.checked=true;
            cb.addEventListener('change',()=>{
                if(cb.checked)visSet.add(col.key);else visSet.delete(col.key);
                rebuildRelTable();
            });
            lbl.appendChild(cb);lbl.appendChild(document.createTextNode(' '+col.title));
            colChecks.appendChild(lbl);
        });
        colToggle.appendChild(colChecks);
        sec.appendChild(colToggle);

        rebuildRelTable();
        wrap.appendChild(table);sec.appendChild(wrap);
        elDetailBody.appendChild(sec);
    }
}

function getRelatedCols(ds,sampleRecs){
    const wanted=ds.config.tableCols||[];
    const allKeys=new Set();
    sampleRecs.slice(0,20).forEach(r=>{if(r)Object.keys(r).forEach(k=>allKeys.add(k))});
    const keys=wanted.length>0?wanted.filter(k=>allKeys.has(k)&&k!=='type'):
        [...allKeys].filter(k=>k!=='type'&&k!=='id');
    return keys.map(k=>{
        const sv=sampleRecs.find(r=>r&&r[k]!=null)?.[k];
        let type='string';
        const uv=cs(sv);
        if(typeof uv==='boolean')type='boolean';
        else if(Array.isArray(sv)){if(sv.length>0&&typeof sv[0]==='object')type='subarray';else type='array'}
        else if(typeof sv==='object'&&sv!==null&&!('cs' in sv))type='object';
        return{key:k,title:humanize(k),type};
    });
}

function hideDetail(){
    elDetail.classList.remove('visible');
    elDetailPermalink.style.display='none';
    elTabsArea.style.display='block';
    elGlobalSearch.style.display='block';
}

// ===== Global search =====
let gT;
elGlobalInput.addEventListener('input',()=>{
    clearTimeout(gT);
    gT=setTimeout(()=>{
        for(const k of Object.keys(tabStates))tabStates[k].filtered=null;
        if(activeTab)renderTable(activeTab);
    },400);
});

elDetailBack.addEventListener('click',e=>{e.preventDefault();hideDetail()});
document.addEventListener('keydown',e=>{if(e.key==='Escape'&&elDetail.classList.contains('visible'))hideDetail()});

// ===== Init =====
// Management panel handlers
$('btn-mgmt').addEventListener('click',openMgmt);
$('mgmt-close').addEventListener('click',closeMgmt);
$('mgmt-overlay').addEventListener('click',e=>{if(e.target===$('mgmt-overlay'))closeMgmt()});
$('mgmt-btn-update').addEventListener('click',incrementalUpdate);
$('mgmt-btn-reload').addEventListener('click',fullReload);
$('mgmt-btn-clear').addEventListener('click',clearCache);
$('btn-quick-update').addEventListener('click',()=>{openMgmt();incrementalUpdate()});
document.addEventListener('keydown',e=>{if(e.key==='Escape'&&$('mgmt-overlay').classList.contains('visible'))closeMgmt()});

const urlParams=new URLSearchParams(location.search);
const pendingDetailId=urlParams.get('detail');
if(pendingDetailId){
    elPendingDetail.style.display='block';
    elPendingDetail.textContent='‚è≥ Po naƒçten√≠ dat se zobraz√≠ detail: '+pendingDetailId;
}

function handleUrlParams(){
    if(!pendingDetailId)return;
    const ref=globalIndex.get(pendingDetailId);
    if(ref){elPendingDetail.style.display='none';showDetail(ref.dsKey,ref.idx)}
    else{
        const resolved=bareIndex.get(pendingDetailId);
        if(resolved){const ref2=globalIndex.get(resolved);if(ref2){elPendingDetail.style.display='none';showDetail(ref2.dsKey,ref2.idx);return}}
        elPendingDetail.textContent='‚è≥ Z√°znam ‚Äû'+pendingDetailId+'" zat√≠m nenalezen ‚Äî naƒç√≠t√°n√≠ prob√≠h√°‚Ä¶';
    }
}

loadAll();

})();
</script>
</body>
</html>
